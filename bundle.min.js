!function(I){function R(e){delete installedChunks[e]}var i=window.webpackHotUpdate;window.webpackHotUpdate=function(e,t){!function(e,t){if(V[e]&&f[e]){for(var i in f[e]=!1,t)Object.prototype.hasOwnProperty.call(t,i)&&(B[i]=t[i]);0==--h&&0===c&&m()}}(e,t),i&&i(e,t)};var L,n=!0,D="4fff060bfeed4686cdda",t=1e4,k={},O=[],r=[];function s(t){var i=H[t];if(!i)return W;function n(e){return i.hot.active?(H[e]?-1===H[e].parents.indexOf(t)&&H[e].parents.push(t):(O=[t],L=e),-1===i.children.indexOf(e)&&i.children.push(e)):(console.warn("[HMR] unexpected require("+e+") from disposed module "+t),O=[]),W(e)}for(var e in W)Object.prototype.hasOwnProperty.call(W,e)&&"e"!==e&&"t"!==e&&Object.defineProperty(n,e,function(t){return{configurable:!0,enumerable:!0,get:function(){return W[t]},set:function(e){W[t]=e}}}(e));return n.e=function(e){return"ready"===o&&F("prepare"),c++,W.e(e).then(t,function(e){throw t(),e});function t(){c--,"prepare"===o&&(u[e]||p(e),0===c&&0===h&&m())}},n.t=function(e,t){return 1&t&&(e=n(e)),W.t(e,-2&t)},n}var a=[],o="idle";function F(e){o=e;for(var t=0;t<a.length;t++)a[t].call(null,e)}var l,B,N,z,h=0,c=0,u={},f={},V={};function U(e){return+e+""===e?+e:e}function d(e){if("idle"!==o)throw new Error("check() is only allowed in idle status");return n=e,F("check"),s=(s=t)||1e4,new Promise(function(t,i){if("undefined"==typeof XMLHttpRequest)return i(new Error("No browser support"));try{var n=new XMLHttpRequest,r=W.p+""+D+".hot-update.json";n.open("GET",r,!0),n.timeout=s,n.send(null)}catch(e){return i(e)}n.onreadystatechange=function(){if(4===n.readyState)if(0===n.status)i(new Error("Manifest request to "+r+" timed out."));else if(404===n.status)t();else if(200!==n.status&&304!==n.status)i(new Error("Manifest request to "+r+" failed."));else{try{var e=JSON.parse(n.responseText)}catch(e){return void i(e)}t(e)}}}).then(function(e){if(!e)return F(G()?"ready":"idle"),null;f={},u={},V=e.c,N=e.h,F("prepare");e=new Promise(function(e,t){l={resolve:e,reject:t}});B={};return p("app"),"prepare"===o&&0===c&&0===h&&m(),e});var s}function p(e){var t,i;V[e]?(f[e]=!0,h++,t=e,(i=document.createElement("script")).charset="utf-8",i.src=W.p+""+t+"."+D+".hot-update.js",document.head.appendChild(i)):u[e]=!0}function m(){F("ready");var t=l;if(l=null,t)if(n)Promise.resolve().then(function(){return _(n)}).then(function(e){t.resolve(e)},function(e){t.reject(e)});else{var e,i=[];for(e in B)Object.prototype.hasOwnProperty.call(B,e)&&i.push(U(e));t.resolve(i)}}function _(e){if("ready"!==o)throw new Error("apply() is only allowed in ready status");return function e(i){G();var t;var n;var r;var c;function s(e){for(var t=[e],i={},n=t.map(function(e){return{chain:[e],id:e}});0<n.length;){var r=n.pop(),s=r.id,a=r.chain;if((c=H[s])&&(!c.hot._selfAccepted||c.hot._selfInvalidated)){if(c.hot._selfDeclined)return{type:"self-declined",chain:a,moduleId:s};if(c.hot._main)return{type:"unaccepted",chain:a,moduleId:s};for(var o=0;o<c.parents.length;o++){var l=c.parents[o],h=H[l];if(h){if(h.hot._declinedDependencies[s])return{type:"declined",chain:a.concat([l]),moduleId:s,parentId:l};-1===t.indexOf(l)&&(h.hot._acceptedDependencies[s]?(i[l]||(i[l]=[]),u(i[l],[s])):(delete i[l],t.push(l),n.push({chain:a.concat([l]),id:l})))}}}}return{type:"accepted",moduleId:e,outdatedModules:t,outdatedDependencies:i}}function u(e,t){for(var i=0;i<t.length;i++){var n=t[i];-1===e.indexOf(n)&&e.push(n)}}var a={};var o=[];var l={};var h=function(){console.warn("[HMR] unexpected require("+d.moduleId+") to disposed module")};for(var f in B)if(Object.prototype.hasOwnProperty.call(B,f)){var d;g=U(f),d=B[f]?s(g):{type:"disposed",moduleId:f};var p=!1,m=!1,_=!1,v="";switch(d.chain&&(v="\nUpdate propagation: "+d.chain.join(" -> ")),d.type){case"self-declined":i.onDeclined&&i.onDeclined(d),i.ignoreDeclined||(p=new Error("Aborted because of self decline: "+d.moduleId+v));break;case"declined":i.onDeclined&&i.onDeclined(d),i.ignoreDeclined||(p=new Error("Aborted because of declined dependency: "+d.moduleId+" in "+d.parentId+v));break;case"unaccepted":i.onUnaccepted&&i.onUnaccepted(d),i.ignoreUnaccepted||(p=new Error("Aborted because "+g+" is not accepted"+v));break;case"accepted":i.onAccepted&&i.onAccepted(d),m=!0;break;case"disposed":i.onDisposed&&i.onDisposed(d),_=!0;break;default:throw new Error("Unexception type "+d.type)}if(p)return F("abort"),Promise.reject(p);if(m)for(var g in l[g]=B[g],u(o,d.outdatedModules),d.outdatedDependencies)Object.prototype.hasOwnProperty.call(d.outdatedDependencies,g)&&(a[g]||(a[g]=[]),u(a[g],d.outdatedDependencies[g]));_&&(u(o,[d.moduleId]),l[g]=h)}var y=[];for(n=0;n<o.length;n++)g=o[n],H[g]&&H[g].hot._selfAccepted&&l[g]!==h&&!H[g].hot._selfInvalidated&&y.push({module:g,parents:H[g].parents.slice(),errorHandler:H[g].hot._selfAccepted});F("dispose");Object.keys(V).forEach(function(e){!1===V[e]&&R(e)});var b;var x=o.slice();for(;0<x.length;)if(g=x.pop(),c=H[g]){var S={},w=c.hot._disposeHandlers;for(r=0;r<w.length;r++)(t=w[r])(S);for(k[g]=S,c.hot.active=!1,delete H[g],delete a[g],r=0;r<c.children.length;r++){var T=H[c.children[r]];T&&0<=(b=T.parents.indexOf(g))&&T.parents.splice(b,1)}}var M;var C;for(g in a)if(Object.prototype.hasOwnProperty.call(a,g)&&(c=H[g]))for(C=a[g],r=0;r<C.length;r++)M=C[r],0<=(b=c.children.indexOf(M))&&c.children.splice(b,1);F("apply");void 0!==N&&(D=N,N=void 0);B=void 0;for(g in l)Object.prototype.hasOwnProperty.call(l,g)&&(I[g]=l[g]);var A=null;for(g in a)if(Object.prototype.hasOwnProperty.call(a,g)&&(c=H[g])){C=a[g];var P=[];for(n=0;n<C.length;n++)M=C[n],(t=c.hot._acceptedDependencies[M])&&-1===P.indexOf(t)&&P.push(t);for(n=0;n<P.length;n++){t=P[n];try{t(C)}catch(e){i.onErrored&&i.onErrored({type:"accept-errored",moduleId:g,dependencyId:C[n],error:e}),i.ignoreErrored||(A=A||e)}}}for(n=0;n<y.length;n++){var E=y[n];g=E.module,O=E.parents,L=g;try{W(g)}catch(t){if("function"==typeof E.errorHandler)try{E.errorHandler(t)}catch(e){i.onErrored&&i.onErrored({type:"self-accept-error-handler-errored",moduleId:g,error:e,originalError:t}),A=(A=!i.ignoreErrored?A||e:A)||t}else i.onErrored&&i.onErrored({type:"self-accept-errored",moduleId:g,error:t}),i.ignoreErrored||(A=A||t)}}if(A)return F("fail"),Promise.reject(A);if(z)return e(i).then(function(t){return o.forEach(function(e){t.indexOf(e)<0&&t.push(e)}),t});F("idle");return new Promise(function(e){e(o)})}(e=e||{})}function G(){if(z)return B=B||{},z.forEach(v),!(z=void 0)}function v(e){Object.prototype.hasOwnProperty.call(B,e)||(B[e]=I[e])}var H={};function W(e){if(H[e])return H[e].exports;var t,n,i=H[e]={i:e,l:!1,exports:{},hot:(n={_acceptedDependencies:{},_declinedDependencies:{},_selfAccepted:!1,_selfDeclined:!1,_selfInvalidated:!1,_disposeHandlers:[],_main:L!==(t=e),active:!0,accept:function(e,t){if(void 0===e)n._selfAccepted=!0;else if("function"==typeof e)n._selfAccepted=e;else if("object"==typeof e)for(var i=0;i<e.length;i++)n._acceptedDependencies[e[i]]=t||function(){};else n._acceptedDependencies[e]=t||function(){}},decline:function(e){if(void 0===e)n._selfDeclined=!0;else if("object"==typeof e)for(var t=0;t<e.length;t++)n._declinedDependencies[e[t]]=!0;else n._declinedDependencies[e]=!0},dispose:function(e){n._disposeHandlers.push(e)},addDisposeHandler:function(e){n._disposeHandlers.push(e)},removeDisposeHandler:function(e){e=n._disposeHandlers.indexOf(e);0<=e&&n._disposeHandlers.splice(e,1)},invalidate:function(){switch(this._selfInvalidated=!0,o){case"idle":(B={})[t]=I[t],F("ready");break;case"ready":v(t);break;case"prepare":case"check":case"dispose":case"apply":(z=z||[]).push(t)}},check:d,apply:_,status:function(e){if(!e)return o;a.push(e)},addStatusHandler:function(e){a.push(e)},removeStatusHandler:function(e){e=a.indexOf(e);0<=e&&a.splice(e,1)},data:k[t]},L=void 0,n),parents:(r=O,O=[],r),children:[]};return I[e].call(i.exports,i,i.exports,s(e)),i.l=!0,i.exports}W.m=I,W.c=H,W.d=function(e,t,i){W.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},W.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},W.t=function(t,e){if(1&e&&(t=W(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(W.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)W.d(i,n,function(e){return t[e]}.bind(null,n));return i},W.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return W.d(t,"a",t),t},W.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},W.p="/",W.h=function(){return D},s("./src/main.ts")(W.s="./src/main.ts")}({"./node_modules/backo2/index.js":function(e,t){function i(e){this.ms=(e=e||{}).min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=0<e.jitter&&e.jitter<=1?e.jitter:0,this.attempts=0}(e.exports=i).prototype.duration=function(){var e,t,i=this.ms*Math.pow(this.factor,this.attempts++);return this.jitter&&(e=Math.random(),t=Math.floor(e*this.jitter*i),i=0==(1&Math.floor(10*e))?i-t:i+t),0|Math.min(i,this.max)},i.prototype.reset=function(){this.attempts=0},i.prototype.setMin=function(e){this.ms=e},i.prototype.setMax=function(e){this.max=e},i.prototype.setJitter=function(e){this.jitter=e}},"./node_modules/base64-arraybuffer/lib/base64-arraybuffer.js":function(e,t){!function(c){"use strict";t.encode=function(e){for(var t=new Uint8Array(e),i=t.length,n="",r=0;r<i;r+=3)n+=c[t[r]>>2],n+=c[(3&t[r])<<4|t[r+1]>>4],n+=c[(15&t[r+1])<<2|t[r+2]>>6],n+=c[63&t[r+2]];return i%3==2?n=n.substring(0,n.length-1)+"=":i%3==1&&(n=n.substring(0,n.length-2)+"=="),n},t.decode=function(e){var t,i,n,r,s=.75*e.length,a=e.length,o=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);for(var s=new ArrayBuffer(s),l=new Uint8Array(s),h=0;h<a;h+=4)t=c.indexOf(e[h]),i=c.indexOf(e[h+1]),n=c.indexOf(e[h+2]),r=c.indexOf(e[h+3]),l[o++]=t<<2|i>>4,l[o++]=(15&i)<<4|n>>2,l[o++]=(3&n)<<6|63&r;return s}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},"./node_modules/base64-js/index.js":function(e,t,i){"use strict";t.byteLength=function(e){var t=c(e),e=t[0],t=t[1];return 3*(e+t)/4-t},t.toByteArray=function(e){var t,i,n=c(e),r=n[0],n=n[1],s=new h(function(e,t){return 3*(e+t)/4-t}(r,n)),a=0,o=0<n?r-4:r;for(i=0;i<o;i+=4)t=l[e.charCodeAt(i)]<<18|l[e.charCodeAt(i+1)]<<12|l[e.charCodeAt(i+2)]<<6|l[e.charCodeAt(i+3)],s[a++]=t>>16&255,s[a++]=t>>8&255,s[a++]=255&t;2===n&&(t=l[e.charCodeAt(i)]<<2|l[e.charCodeAt(i+1)]>>4,s[a++]=255&t);1===n&&(t=l[e.charCodeAt(i)]<<10|l[e.charCodeAt(i+1)]<<4|l[e.charCodeAt(i+2)]>>2,s[a++]=t>>8&255,s[a++]=255&t);return s},t.fromByteArray=function(e){for(var t,i=e.length,n=i%3,r=[],s=0,a=i-n;s<a;s+=16383)r.push(function(e,t,i){for(var n,r=[],s=t;s<i;s+=3)n=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),r.push(function(e){return o[e>>18&63]+o[e>>12&63]+o[e>>6&63]+o[63&e]}(n));return r.join("")}(e,s,a<s+16383?a:s+16383));1==n?(t=e[i-1],r.push(o[t>>2]+o[t<<4&63]+"==")):2==n&&(t=(e[i-2]<<8)+e[i-1],r.push(o[t>>10]+o[t>>4&63]+o[t<<2&63]+"="));return r.join("")};for(var o=[],l=[],h="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0,s=n.length;r<s;++r)o[r]=n[r],l[n.charCodeAt(r)]=r;function c(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");e=e.indexOf("=");return[e=-1===e?t:e,e===t?0:4-e%4]}l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},"./node_modules/buffer/index.js":function(e,L,D){"use strict";!function(e){var o=D("./node_modules/base64-js/index.js"),s=D("./node_modules/ieee754/index.js"),a=D("./node_modules/isarray/index.js");function i(){return u.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function r(e,t){if(i()<t)throw new RangeError("Invalid typed array length");return u.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=u.prototype:(e=null===e?new u(t):e).length=t,e}function u(e,t,i){if(!(u.TYPED_ARRAY_SUPPORT||this instanceof u))return new u(e,t,i);if("number"!=typeof e)return n(this,e,t,i);if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}function n(e,t,i,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,i,n){if(t.byteLength,i<0||t.byteLength<i)throw new RangeError("'offset' is out of bounds");if(t.byteLength<i+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===i&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,i):new Uint8Array(t,i,n);u.TYPED_ARRAY_SUPPORT?(e=t).__proto__=u.prototype:e=c(e,t);return e}(e,t,i,n):"string"==typeof t?function(e,t,i){"string"==typeof i&&""!==i||(i="utf8");if(!u.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var n=0|d(t,i),i=(e=r(e,n)).write(t,i);i!==n&&(e=e.slice(0,i));return e}(e,t,i):function(e,t){if(u.isBuffer(t)){var i=0|f(t.length);return 0===(e=r(e,i)).length?e:(t.copy(e,0,0,i),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||function(e){return e!=e}(t.length)?r(e,0):c(e,t);if("Buffer"===t.type&&a(t.data))return c(e,t.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(l(t),e=r(e,t<0?0:0|f(t)),!u.TYPED_ARRAY_SUPPORT)for(var i=0;i<t;++i)e[i]=0;return e}function c(e,t){var i=t.length<0?0:0|f(t.length);e=r(e,i);for(var n=0;n<i;n+=1)e[n]=255&t[n];return e}function f(e){if(e>=i())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i().toString(16)+" bytes");return 0|e}function d(e,t){if(u.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;var i=(e="string"!=typeof e?""+e:e).length;if(0===i)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return E(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return I(e).length;default:if(n)return E(e).length;t=(""+t).toLowerCase(),n=!0}}function t(e,t,i){var n,r,s,a=!1;if((t=void 0===t||t<0?0:t)>this.length)return"";if((i=void 0===i||i>this.length?this.length:i)<=0)return"";if((i>>>=0)<=(t>>>=0))return"";for(e=e||"utf8";;)switch(e){case"hex":return function(e,t,i){var n=e.length;(!t||t<0)&&(t=0);(!i||i<0||n<i)&&(i=n);for(var r="",s=t;s<i;++s)r+=function(e){return e<16?"0"+e.toString(16):e.toString(16)}(e[s]);return r}(this,t,i);case"utf8":case"utf-8":return y(this,t,i);case"ascii":return function(e,t,i){var n="";i=Math.min(e.length,i);for(var r=t;r<i;++r)n+=String.fromCharCode(127&e[r]);return n}(this,t,i);case"latin1":case"binary":return function(e,t,i){var n="";i=Math.min(e.length,i);for(var r=t;r<i;++r)n+=String.fromCharCode(e[r]);return n}(this,t,i);case"base64":return n=this,s=i,0===(r=t)&&s===n.length?o.fromByteArray(n):o.fromByteArray(n.slice(r,s));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return function(e,t,i){for(var n=e.slice(t,i),r="",s=0;s<n.length;s+=2)r+=String.fromCharCode(n[s]+256*n[s+1]);return r}(this,t,i);default:if(a)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),a=!0}}function p(e,t,i){var n=e[t];e[t]=e[i],e[i]=n}function m(e,t,i,n,r){if(0===e.length)return-1;if("string"==typeof i?(n=i,i=0):2147483647<i?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,(i=(i=isNaN(i)?r?0:e.length-1:i)<0?e.length+i:i)>=e.length){if(r)return-1;i=e.length-1}else if(i<0){if(!r)return-1;i=0}if("string"==typeof t&&(t=u.from(t,n)),u.isBuffer(t))return 0===t.length?-1:_(e,t,i,n,r);if("number"==typeof t)return t&=255,u.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?(r?Uint8Array.prototype.indexOf:Uint8Array.prototype.lastIndexOf).call(e,t,i):_(e,[t],i,n,r);throw new TypeError("val must be string, number or Buffer")}function _(e,t,i,n,r){var s=1,a=e.length,o=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;a/=s=2,o/=2,i/=2}function l(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(r)for(var h=-1,c=i;c<a;c++)if(l(e,c)===l(t,-1===h?0:c-h)){if(c-(h=-1===h?c:h)+1===o)return h*s}else-1!==h&&(c-=c-h),h=-1;else for(c=i=a<i+o?a-o:i;0<=c;c--){for(var u=!0,f=0;f<o;f++)if(l(e,c+f)!==l(t,f)){u=!1;break}if(u)return c}return-1}function v(e,t,i,n){return R(function(e){for(var t=[],i=0;i<e.length;++i)t.push(255&e.charCodeAt(i));return t}(t),e,i,n)}function g(e,t,i,n){return R(function(e,t){for(var i,n,r=[],s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),i=n>>8,n=n%256,r.push(n),r.push(i);return r}(t,e.length-i),e,i,n)}function y(e,t,i){i=Math.min(e.length,i);for(var n=[],r=t;r<i;){var s,a,o,l,h=e[r],c=null,u=239<h?4:223<h?3:191<h?2:1;if(r+u<=i)switch(u){case 1:h<128&&(c=h);break;case 2:128==(192&(s=e[r+1]))&&127<(l=(31&h)<<6|63&s)&&(c=l);break;case 3:s=e[r+1],a=e[r+2],128==(192&s)&&128==(192&a)&&2047<(l=(15&h)<<12|(63&s)<<6|63&a)&&(l<55296||57343<l)&&(c=l);break;case 4:s=e[r+1],a=e[r+2],o=e[r+3],128==(192&s)&&128==(192&a)&&128==(192&o)&&65535<(l=(15&h)<<18|(63&s)<<12|(63&a)<<6|63&o)&&l<1114112&&(c=l)}null===c?(c=65533,u=1):65535<c&&(c-=65536,n.push(c>>>10&1023|55296),c=56320|1023&c),n.push(c),r+=u}return function(e){var t=e.length;if(t<=b)return String.fromCharCode.apply(String,e);var i="",n=0;for(;n<t;)i+=String.fromCharCode.apply(String,e.slice(n,n+=b));return i}(n)}L.Buffer=u,L.SlowBuffer=function(e){+e!=e&&(e=0);return u.alloc(+e)},L.INSPECT_MAX_BYTES=50,u.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),L.kMaxLength=i(),u.poolSize=8192,u._augment=function(e){return e.__proto__=u.prototype,e},u.from=function(e,t,i){return n(null,e,t,i)},u.TYPED_ARRAY_SUPPORT&&(u.prototype.__proto__=Uint8Array.prototype,u.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&u[Symbol.species]===u&&Object.defineProperty(u,Symbol.species,{value:null,configurable:!0})),u.alloc=function(e,t,i){return n=null,t=t,i=i,l(e=e),!(e<=0)&&void 0!==t?"string"==typeof i?r(n,e).fill(t,i):r(n,e).fill(t):r(n,e);var n},u.allocUnsafe=function(e){return h(null,e)},u.allocUnsafeSlow=function(e){return h(null,e)},u.isBuffer=function(e){return!(null==e||!e._isBuffer)},u.compare=function(e,t){if(!u.isBuffer(e)||!u.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var i=e.length,n=t.length,r=0,s=Math.min(i,n);r<s;++r)if(e[r]!==t[r]){i=e[r],n=t[r];break}return i<n?-1:n<i?1:0},u.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return u.alloc(0);if(void 0===t)for(r=t=0;r<e.length;++r)t+=e[r].length;for(var i=u.allocUnsafe(t),n=0,r=0;r<e.length;++r){var s=e[r];if(!u.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(i,n),n+=s.length}return i},u.byteLength=d,u.prototype._isBuffer=!0,u.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},u.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},u.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},u.prototype.toString=function(){var e=0|this.length;return 0==e?"":0===arguments.length?y(this,0,e):t.apply(this,arguments)},u.prototype.equals=function(e){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===u.compare(this,e)},u.prototype.inspect=function(){var e="",t=L.INSPECT_MAX_BYTES;return 0<this.length&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},u.prototype.compare=function(e,t,i,n,r){if(!u.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===i&&(i=e?e.length:0),void 0===n&&(n=0),void 0===r&&(r=this.length),(t=void 0===t?0:t)<0||i>e.length||n<0||r>this.length)throw new RangeError("out of range index");if(r<=n&&i<=t)return 0;if(r<=n)return-1;if(i<=t)return 1;if(this===e)return 0;for(var s=(r>>>=0)-(n>>>=0),a=(i>>>=0)-(t>>>=0),o=Math.min(s,a),l=this.slice(n,r),h=e.slice(t,i),c=0;c<o;++c)if(l[c]!==h[c]){s=l[c],a=h[c];break}return s<a?-1:a<s?1:0},u.prototype.includes=function(e,t,i){return-1!==this.indexOf(e,t,i)},u.prototype.indexOf=function(e,t,i){return m(this,e,t,i,!0)},u.prototype.lastIndexOf=function(e,t,i){return m(this,e,t,i,!1)},u.prototype.write=function(e,t,i,n){if(void 0===t)n="utf8",i=this.length,t=0;else if(void 0===i&&"string"==typeof t)n=t,i=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(i)?(i|=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var r=this.length-t;if((void 0===i||r<i)&&(i=r),0<e.length&&(i<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n=n||"utf8";for(var s,a,o,l=!1;;)switch(n){case"hex":return function(e,t,i,n){i=Number(i)||0;var r=e.length-i;if((!n||r<(n=Number(n)))&&(n=r),(r=t.length)%2!=0)throw new TypeError("Invalid hex string");r/2<n&&(n=r/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[i+s]=a}return s}(this,e,t,i);case"utf8":case"utf-8":return a=t,o=i,R(E(e,(s=this).length-a),s,a,o);case"ascii":return v(this,e,t,i);case"latin1":case"binary":return v(this,e,t,i);case"base64":return s=this,a=t,o=i,R(I(e),s,a,o);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return g(this,e,t,i);default:if(l)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),l=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var b=4096;function x(e,t,i){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(i<e+t)throw new RangeError("Trying to access beyond buffer length")}function S(e,t,i,n,r,s){if(!u.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(r<t||t<s)throw new RangeError('"value" argument is out of bounds');if(i+n>e.length)throw new RangeError("Index out of range")}function w(e,t,i,n){t<0&&(t=65535+t+1);for(var r=0,s=Math.min(e.length-i,2);r<s;++r)e[i+r]=(t&255<<8*(n?r:1-r))>>>8*(n?r:1-r)}function T(e,t,i,n){t<0&&(t=4294967295+t+1);for(var r=0,s=Math.min(e.length-i,4);r<s;++r)e[i+r]=t>>>8*(n?r:3-r)&255}function M(e,t,i,n){if(i+n>e.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function C(e,t,i,n,r){return r||M(e,0,i,4),s.write(e,t,i,n,23,4),i+4}function A(e,t,i,n,r){return r||M(e,0,i,8),s.write(e,t,i,n,52,8),i+8}u.prototype.slice=function(e,t){var i=this.length;if((e=~~e)<0?(e+=i)<0&&(e=0):i<e&&(e=i),(t=void 0===t?i:~~t)<0?(t+=i)<0&&(t=0):i<t&&(t=i),t<e&&(t=e),u.TYPED_ARRAY_SUPPORT)(r=this.subarray(e,t)).__proto__=u.prototype;else for(var n=t-e,r=new u(n,void 0),s=0;s<n;++s)r[s]=this[s+e];return r},u.prototype.readUIntLE=function(e,t,i){e|=0,t|=0,i||x(e,t,this.length);for(var n=this[e],r=1,s=0;++s<t&&(r*=256);)n+=this[e+s]*r;return n},u.prototype.readUIntBE=function(e,t,i){e|=0,t|=0,i||x(e,t,this.length);for(var n=this[e+--t],r=1;0<t&&(r*=256);)n+=this[e+--t]*r;return n},u.prototype.readUInt8=function(e,t){return t||x(e,1,this.length),this[e]},u.prototype.readUInt16LE=function(e,t){return t||x(e,2,this.length),this[e]|this[e+1]<<8},u.prototype.readUInt16BE=function(e,t){return t||x(e,2,this.length),this[e]<<8|this[e+1]},u.prototype.readUInt32LE=function(e,t){return t||x(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},u.prototype.readUInt32BE=function(e,t){return t||x(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},u.prototype.readIntLE=function(e,t,i){e|=0,t|=0,i||x(e,t,this.length);for(var n=this[e],r=1,s=0;++s<t&&(r*=256);)n+=this[e+s]*r;return(r*=128)<=n&&(n-=Math.pow(2,8*t)),n},u.prototype.readIntBE=function(e,t,i){e|=0,t|=0,i||x(e,t,this.length);for(var n=t,r=1,s=this[e+--n];0<n&&(r*=256);)s+=this[e+--n]*r;return(r*=128)<=s&&(s-=Math.pow(2,8*t)),s},u.prototype.readInt8=function(e,t){return t||x(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},u.prototype.readInt16LE=function(e,t){t||x(e,2,this.length);e=this[e]|this[e+1]<<8;return 32768&e?4294901760|e:e},u.prototype.readInt16BE=function(e,t){t||x(e,2,this.length);e=this[e+1]|this[e]<<8;return 32768&e?4294901760|e:e},u.prototype.readInt32LE=function(e,t){return t||x(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},u.prototype.readInt32BE=function(e,t){return t||x(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},u.prototype.readFloatLE=function(e,t){return t||x(e,4,this.length),s.read(this,e,!0,23,4)},u.prototype.readFloatBE=function(e,t){return t||x(e,4,this.length),s.read(this,e,!1,23,4)},u.prototype.readDoubleLE=function(e,t){return t||x(e,8,this.length),s.read(this,e,!0,52,8)},u.prototype.readDoubleBE=function(e,t){return t||x(e,8,this.length),s.read(this,e,!1,52,8)},u.prototype.writeUIntLE=function(e,t,i,n){e=+e,t|=0,i|=0,n||S(this,e,t,i,Math.pow(2,8*i)-1,0);var r=1,s=0;for(this[t]=255&e;++s<i&&(r*=256);)this[t+s]=e/r&255;return t+i},u.prototype.writeUIntBE=function(e,t,i,n){e=+e,t|=0,i|=0,n||S(this,e,t,i,Math.pow(2,8*i)-1,0);var r=i-1,s=1;for(this[t+r]=255&e;0<=--r&&(s*=256);)this[t+r]=e/s&255;return t+i},u.prototype.writeUInt8=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,1,255,0),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},u.prototype.writeUInt16LE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},u.prototype.writeUInt16BE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,2,65535,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},u.prototype.writeUInt32LE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):T(this,e,t,!0),t+4},u.prototype.writeUInt32BE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,4,4294967295,0),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):T(this,e,t,!1),t+4},u.prototype.writeIntLE=function(e,t,i,n){e=+e,t|=0,n||S(this,e,t,i,(n=Math.pow(2,8*i-1))-1,-n);var r=0,s=1,a=0;for(this[t]=255&e;++r<i&&(s*=256);)e<0&&0===a&&0!==this[t+r-1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+i},u.prototype.writeIntBE=function(e,t,i,n){e=+e,t|=0,n||S(this,e,t,i,(n=Math.pow(2,8*i-1))-1,-n);var r=i-1,s=1,a=0;for(this[t+r]=255&e;0<=--r&&(s*=256);)e<0&&0===a&&0!==this[t+r+1]&&(a=1),this[t+r]=(e/s>>0)-a&255;return t+i},u.prototype.writeInt8=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,1,127,-128),u.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&(e=e<0?255+e+1:e),t+1},u.prototype.writeInt16LE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):w(this,e,t,!0),t+2},u.prototype.writeInt16BE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,2,32767,-32768),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):w(this,e,t,!1),t+2},u.prototype.writeInt32LE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,4,2147483647,-2147483648),u.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):T(this,e,t,!0),t+4},u.prototype.writeInt32BE=function(e,t,i){return e=+e,t|=0,i||S(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),u.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):T(this,e,t,!1),t+4},u.prototype.writeFloatLE=function(e,t,i){return C(this,e,t,!0,i)},u.prototype.writeFloatBE=function(e,t,i){return C(this,e,t,!1,i)},u.prototype.writeDoubleLE=function(e,t,i){return A(this,e,t,!0,i)},u.prototype.writeDoubleBE=function(e,t,i){return A(this,e,t,!1,i)},u.prototype.copy=function(e,t,i,n){if(i=i||0,n||0===n||(n=this.length),t>=e.length&&(t=e.length),(n=0<n&&n<i?i:n)===i)return 0;if(0===e.length||0===this.length)return 0;if((t=t||0)<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length);var r,s=(n=e.length-t<n-i?e.length-t+i:n)-i;if(this===e&&i<t&&t<n)for(r=s-1;0<=r;--r)e[r+t]=this[r+i];else if(s<1e3||!u.TYPED_ARRAY_SUPPORT)for(r=0;r<s;++r)e[r+t]=this[r+i];else Uint8Array.prototype.set.call(e,this.subarray(i,i+s),t);return s},u.prototype.fill=function(e,t,i,n){if("string"==typeof e){var r;if("string"==typeof t?(n=t,t=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),1!==e.length||(r=e.charCodeAt(0))<256&&(e=r),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!u.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<i)throw new RangeError("Out of range index");if(i<=t)return this;if(t>>>=0,i=void 0===i?this.length:i>>>0,"number"==typeof(e=e||0))for(o=t;o<i;++o)this[o]=e;else for(var s=u.isBuffer(e)?e:E(new u(e,n).toString()),a=s.length,o=0;o<i-t;++o)this[o+t]=s[o%a];return this};var P=/[^+\/0-9A-Za-z-_]/g;function E(e,t){var i;t=t||1/0;for(var n=e.length,r=null,s=[],a=0;a<n;++a){if(55295<(i=e.charCodeAt(a))&&i<57344){if(!r){if(56319<i){-1<(t-=3)&&s.push(239,191,189);continue}if(a+1===n){-1<(t-=3)&&s.push(239,191,189);continue}r=i;continue}if(i<56320){-1<(t-=3)&&s.push(239,191,189),r=i;continue}i=65536+(r-55296<<10|i-56320)}else r&&-1<(t-=3)&&s.push(239,191,189);if(r=null,i<128){if(--t<0)break;s.push(i)}else if(i<2048){if((t-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((t-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function I(e){return o.toByteArray(function(e){var t;if((e=((t=e).trim?t.trim():t.replace(/^\s+|\s+$/g,"")).replace(P,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function R(e,t,i,n){for(var r=0;r<n&&!(r+i>=t.length||r>=e.length);++r)t[r+i]=e[r];return r}}.call(this,D("./node_modules/webpack/buildin/global.js"))},"./node_modules/component-emitter/index.js":function(e,t,i){function n(e){if(e)return function(e){for(var t in n.prototype)e[t]=n.prototype[t];return e}(e)}(e.exports=n).prototype.on=n.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},n.prototype.once=function(e,t){function i(){this.off(e,i),t.apply(this,arguments)}return i.fn=t,this.on(e,i),this},n.prototype.off=n.prototype.removeListener=n.prototype.removeAllListeners=n.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var i,n=this._callbacks["$"+e];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var r=0;r<n.length;r++)if((i=n[r])===t||i.fn===t){n.splice(r,1);break}return 0===n.length&&delete this._callbacks["$"+e],this},n.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),i=this._callbacks["$"+e],n=1;n<arguments.length;n++)t[n-1]=arguments[n];if(i)for(var n=0,r=(i=i.slice(0)).length;n<r;++n)i[n].apply(this,t);return this},n.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},n.prototype.hasListeners=function(e){return!!this.listeners(e).length}},"./node_modules/engine.io-client/lib/globalThis.browser.js":function(e,t){e.exports="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")()},"./node_modules/engine.io-client/lib/index.js":function(e,t,i){const n=i("./node_modules/engine.io-client/lib/socket.js");e.exports=(e,t)=>new n(e,t),e.exports.Socket=n,e.exports.protocol=n.protocol,e.exports.Transport=i("./node_modules/engine.io-client/lib/transport.js"),e.exports.transports=i("./node_modules/engine.io-client/lib/transports/index.js"),e.exports.parser=i("./node_modules/engine.io-parser/lib/index.js")},"./node_modules/engine.io-client/lib/socket.js":function(e,t,i){const n=i("./node_modules/engine.io-client/lib/transports/index.js");var r=i("./node_modules/component-emitter/index.js");const u=i("./node_modules/engine.io-client/node_modules/debug/src/browser.js")("engine.io-client:socket"),s=i("./node_modules/engine.io-parser/lib/index.js"),a=i("./node_modules/parseuri/index.js"),o=i("./node_modules/parseqs/index.js");class f extends r{constructor(e,t={}){super(),e&&"object"==typeof e&&(t=e,e=null),e?(e=a(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=a(t.host).host),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,jsonp:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{}},t),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=o.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,this.open()}createTransport(e){u('creating transport "%s"',e);const t=function(e){const t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}(this.opts.query);t.EIO=s.protocol,t.transport=e,this.id&&(t.sid=this.id);var i=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return u("options: %j",i),new n[e](i)}open(){let e;if(this.opts.rememberUpgrade&&f.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length){const t=this;return void setTimeout(function(){t.emit("error","No transports available")},0)}e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return u("error while creating transport: %s",e),this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){u("setting transport %s",e.name);const t=this;this.transport&&(u("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),(this.transport=e).on("drain",function(){t.onDrain()}).on("packet",function(e){t.onPacket(e)}).on("error",function(e){t.onError(e)}).on("close",function(){t.onClose("transport close")})}probe(i){u('probing transport "%s"',i);let n=this.createTransport(i,{probe:1}),r=!1;const s=this;function e(){var e;s.onlyBinaryUpgrades&&(e=!this.supportsBinary&&s.transport.supportsBinary,r=r||e),r||(u('probe transport "%s" opened',i),n.send([{type:"ping",data:"probe"}]),n.once("packet",function(e){if(!r)if("pong"===e.type&&"probe"===e.data)u('probe transport "%s" pong',i),s.upgrading=!0,s.emit("upgrading",n),n&&(f.priorWebsocketSuccess="websocket"===n.name,u('pausing current transport "%s"',s.transport.name),s.transport.pause(function(){r||"closed"!==s.readyState&&(u("changing transport and sending upgrade packet"),c(),s.setTransport(n),n.send([{type:"upgrade"}]),s.emit("upgrade",n),n=null,s.upgrading=!1,s.flush())}));else{u('probe transport "%s" failed',i);const t=new Error("probe error");t.transport=n.name,s.emit("upgradeError",t)}}))}function a(){r||(r=!0,c(),n.close(),n=null)}function t(e){const t=new Error("probe error: "+e);t.transport=n.name,a(),u('probe transport "%s" failed because of error: %s',i,e),s.emit("upgradeError",t)}function o(){t("transport closed")}function l(){t("socket closed")}function h(e){n&&e.name!==n.name&&(u('"%s" works - aborting "%s"',e.name,n.name),a())}function c(){n.removeListener("open",e),n.removeListener("error",t),n.removeListener("close",o),s.removeListener("close",l),s.removeListener("upgrading",h)}f.priorWebsocketSuccess=!1,n.once("open",e),n.once("error",t),n.once("close",o),this.once("close",l),this.once("upgrading",h),n.open()}onOpen(){if(u("socket open"),this.readyState="open",f.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){u("starting upgrade probes");let e=0;for(var t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(u('socket receive: type "%s", data "%s"',e.type,e.data),this.emit("packet",e),this.emit("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emit("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emit("data",e.data),this.emit("message",e.data)}else u('packet received with socket readyState "%s"',this.readyState)}onHandshake(e){this.emit("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=setTimeout(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout)}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),(this.prevBufferLen=0)===this.writeBuffer.length?this.emit("drain"):this.flush()}flush(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(u("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))}write(e,t,i){return this.sendPacket("message",e,t,i),this}send(e,t,i){return this.sendPacket("message",e,t,i),this}sendPacket(e,t,i,n){"function"==typeof t&&(n=t,t=void 0),"function"==typeof i&&(n=i,i=null),"closing"!==this.readyState&&"closed"!==this.readyState&&((i=i||{}).compress=!1!==i.compress,this.emit("packetCreate",i={type:e,data:t,options:i}),this.writeBuffer.push(i),n&&this.once("flush",n),this.flush())}close(){const e=this;function t(){e.onClose("forced close"),u("socket closing - telling transport to close"),e.transport.close()}function i(){e.removeListener("upgrade",i),e.removeListener("upgradeError",i),t()}function n(){e.once("upgrade",i),e.once("upgradeError",i)}return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",function(){(this.upgrading?n:t)()}):(this.upgrading?n:t)()),this}onError(e){u("socket error %j",e),f.priorWebsocketSuccess=!1,this.emit("error",e),this.onClose("transport error",e)}onClose(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(u('socket close with reason: "%s"',e),clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let i=0;for(var n=e.length;i<n;i++)~this.transports.indexOf(e[i])&&t.push(e[i]);return t}}f.priorWebsocketSuccess=!1,f.protocol=s.protocol,e.exports=f},"./node_modules/engine.io-client/lib/transport.js":function(e,t,i){const n=i("./node_modules/engine.io-parser/lib/index.js");i=i("./node_modules/component-emitter/index.js");class r extends i{constructor(e){super(),this.opts=e,this.query=e.query,this.readyState="",this.socket=e.socket}onError(e,t){const i=new Error(e);return i.type="TransportError",i.description=t,this.emit("error",i),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){if("open"!==this.readyState)throw new Error("Transport not open");this.write(e)}onOpen(){this.readyState="open",this.writable=!0,this.emit("open")}onData(e){e=n.decodePacket(e,this.socket.binaryType);this.onPacket(e)}onPacket(e){this.emit("packet",e)}onClose(){this.readyState="closed",this.emit("close")}}e.exports=r},"./node_modules/engine.io-client/lib/transports/index.js":function(e,t,i){const s=i("./node_modules/engine.io-client/lib/xmlhttprequest.js"),a=i("./node_modules/engine.io-client/lib/transports/polling-xhr.js"),o=i("./node_modules/engine.io-client/lib/transports/polling-jsonp.js");i=i("./node_modules/engine.io-client/lib/transports/websocket.js");t.polling=function(t){let i=!1,n=!1;var e=!1!==t.jsonp;if("undefined"!=typeof location){var r="https:"===location.protocol;let e=location.port;e=e||(r?443:80),i=t.hostname!==location.hostname||e!==t.port,n=t.secure!==r}{if(t.xdomain=i,t.xscheme=n,"open"in new s(t)&&!t.forceJSONP)return new a(t);if(!e)throw new Error("JSONP disabled");return new o(t)}},t.websocket=i},"./node_modules/engine.io-client/lib/transports/polling-jsonp.js":function(e,t,i){var n=i("./node_modules/engine.io-client/lib/transports/polling.js");const r=i("./node_modules/engine.io-client/lib/globalThis.browser.js"),h=/\n/g,c=/\\n/g;let s;function a(){}class o extends n{constructor(e){super(e),this.query=this.query||{},s=s||(r.___eio=r.___eio||[]),this.index=s.length;const t=this;s.push(function(e){t.onData(e)}),this.query.j=this.index,"function"==typeof addEventListener&&addEventListener("beforeunload",function(){t.script&&(t.script.onerror=a)},!1)}get supportsBinary(){return!1}doClose(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),super.doClose()}doPoll(){const t=this,e=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),e.async=!0,e.src=this.uri(),e.onerror=function(e){t.onError("jsonp poll error",e)};const i=document.getElementsByTagName("script")[0];i?i.parentNode.insertBefore(e,i):(document.head||document.body).appendChild(e),this.script=e,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout(function(){var e=document.createElement("iframe");document.body.appendChild(e),document.body.removeChild(e)},100)}doWrite(e,t){const i=this;let n;if(!this.form){const o=document.createElement("form"),l=document.createElement("textarea");var r=this.iframeId="eio_iframe_"+this.index;o.className="socketio",o.style.position="absolute",o.style.top="-1000px",o.style.left="-1000px",o.target=r,o.method="POST",o.setAttribute("accept-charset","utf-8"),l.name="d",o.appendChild(l),document.body.appendChild(o),this.form=o,this.area=l}function s(){a(),t()}function a(){if(i.iframe)try{i.form.removeChild(i.iframe)}catch(e){i.onError("jsonp polling iframe removal error",e)}try{var e='<iframe src="javascript:0" name="'+i.iframeId+'">';n=document.createElement(e)}catch(e){n=document.createElement("iframe"),n.name=i.iframeId,n.src="javascript:0"}n.id=i.iframeId,i.form.appendChild(n),i.iframe=n}this.form.action=this.uri(),a(),e=e.replace(c,"\\\n"),this.area.value=e.replace(h,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===i.iframe.readyState&&s()}:this.iframe.onload=s}}e.exports=o},"./node_modules/engine.io-client/lib/transports/polling-xhr.js":function(e,t,i){const r=i("./node_modules/engine.io-client/lib/xmlhttprequest.js");var n=i("./node_modules/engine.io-client/lib/transports/polling.js"),s=i("./node_modules/component-emitter/index.js");const a=i("./node_modules/engine.io-client/lib/util.js")["pick"];var o=i("./node_modules/engine.io-client/lib/globalThis.browser.js");const l=i("./node_modules/engine.io-client/node_modules/debug/src/browser.js")("engine.io-client:polling-xhr");function h(){}const c=null!=new r({xdomain:!1}).responseType;class u extends n{constructor(t){if(super(t),"undefined"!=typeof location){var i="https:"===location.protocol;let e=location.port;e=e||(i?443:80),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||e!==t.port,this.xs=t.secure!==i}t=t&&t.forceBase64;this.supportsBinary=c&&!t}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new f(this.uri(),e)}doWrite(e,t){const i=this.request({method:"POST",data:e}),n=this;i.on("success",t),i.on("error",function(e){n.onError("xhr post error",e)})}doPoll(){l("xhr poll");const e=this.request(),t=this;e.on("data",function(e){t.onData(e)}),e.on("error",function(e){t.onError("xhr poll error",e)}),this.pollXhr=e}}class f extends s{constructor(e,t){super(),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=a(this.opts,"agent","enablesXDR","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new r(e),i=this;try{l("xhr open %s: %s",this.method,this.uri),t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders)for(var n in t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0),this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(n)&&t.setRequestHeader(n,this.opts.extraHeaders[n])}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),this.hasXDR()?(t.onload=function(){i.onLoad()},t.onerror=function(){i.onError(t.responseText)}):t.onreadystatechange=function(){4===t.readyState&&(200===t.status||1223===t.status?i.onLoad():setTimeout(function(){i.onError("number"==typeof t.status?t.status:0)},0))},l("xhr data %s",this.data),t.send(this.data)}catch(e){return void setTimeout(function(){i.onError(e)},0)}"undefined"!=typeof document&&(this.index=f.requestsCount++,f.requests[this.index]=this)}onSuccess(){this.emit("success"),this.cleanup()}onData(e){this.emit("data",e),this.onSuccess()}onError(e){this.emit("error",e),this.cleanup(!0)}cleanup(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=h:this.xhr.onreadystatechange=h,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete f.requests[this.index],this.xhr=null}}onLoad(){var e=this.xhr.responseText;null!==e&&this.onData(e)}hasXDR(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR}abort(){this.cleanup()}}function d(){for(var e in f.requests)f.requests.hasOwnProperty(e)&&f.requests[e].abort()}f.requestsCount=0,f.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",d):"function"==typeof addEventListener&&(o="onpagehide"in o?"pagehide":"unload",addEventListener(o,d,!1))),e.exports=u,e.exports.Request=f},"./node_modules/engine.io-client/lib/transports/polling.js":function(e,t,i){var n=i("./node_modules/engine.io-client/lib/transport.js");const r=i("./node_modules/parseqs/index.js"),s=i("./node_modules/engine.io-parser/lib/index.js"),a=i("./node_modules/yeast/index.js"),o=i("./node_modules/engine.io-client/node_modules/debug/src/browser.js")("engine.io-client:polling");class l extends n{get name(){return"polling"}doOpen(){this.poll()}pause(e){const t=this;function i(){o("paused"),t.readyState="paused",e()}if(this.readyState="pausing",this.polling||!this.writable){let e=0;this.polling&&(o("we are currently polling - waiting to pause"),e++,this.once("pollComplete",function(){o("pre-pause polling complete"),--e||i()})),this.writable||(o("we are currently writing - waiting to pause"),e++,this.once("drain",function(){o("pre-pause writing complete"),--e||i()}))}else i()}poll(){o("polling"),this.polling=!0,this.doPoll(),this.emit("poll")}onData(e){const n=this;o("polling got data %s",e);s.decodePayload(e,this.socket.binaryType).forEach(function(e,t,i){if("opening"===n.readyState&&"open"===e.type&&n.onOpen(),"close"===e.type)return n.onClose(),!1;n.onPacket(e)}),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():o('ignoring poll - transport state "%s"',this.readyState))}doClose(){const e=this;function t(){o("writing close packet"),e.write([{type:"close"}])}"open"===this.readyState?(o("transport open - closing"),t()):(o("transport not open - deferring close"),this.once("open",t))}write(e){this.writable=!1,s.encodePayload(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emit("drain")})})}uri(){let e=this.query||{};var t=this.opts.secure?"https":"http";let i="";return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=a()),this.supportsBinary||e.sid||(e.b64=1),e=r.encode(e),this.opts.port&&("https"==t&&443!==Number(this.opts.port)||"http"==t&&80!==Number(this.opts.port))&&(i=":"+this.opts.port),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+i+this.opts.path+e}}e.exports=l},"./node_modules/engine.io-client/lib/transports/websocket-constructor.browser.js":function(e,t,i){i=i("./node_modules/engine.io-client/lib/globalThis.browser.js");e.exports={WebSocket:i.WebSocket||i.MozWebSocket,usingBrowserWebSocket:!0,defaultBinaryType:"arraybuffer"}},"./node_modules/engine.io-client/lib/transports/websocket.js":function(i,e,d){!function(s){const e=d("./node_modules/engine.io-client/lib/transport.js"),a=d("./node_modules/engine.io-parser/lib/index.js"),n=d("./node_modules/parseqs/index.js"),r=d("./node_modules/yeast/index.js"),o=d("./node_modules/engine.io-client/lib/util.js")["pick"],{WebSocket:l,usingBrowserWebSocket:h,defaultBinaryType:c}=d("./node_modules/engine.io-client/lib/transports/websocket-constructor.browser.js"),u=d("./node_modules/engine.io-client/node_modules/debug/src/browser.js")("engine.io-client:websocket"),f="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class t extends e{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(this.check()){var e=this.uri(),t=this.opts.protocols;const i=f?{}:o(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(i.headers=this.opts.extraHeaders);try{this.ws=h&&!f?t?new l(e,t):new l(e):new l(e,t,i)}catch(e){return this.emit("error",e)}this.ws.binaryType=this.socket.binaryType||c,this.addEventListeners()}}addEventListeners(){const t=this;this.ws.onopen=function(){t.onOpen()},this.ws.onclose=function(){t.onClose()},this.ws.onmessage=function(e){t.onData(e.data)},this.ws.onerror=function(e){t.onError("websocket error",e)}}write(e){const n=this;this.writable=!1;let r=e.length,t=0;for(var i=r;t<i;t++)!function(i){a.encodePacket(i,n.supportsBinary,function(e){const t={};h||(i.options&&(t.compress=i.options.compress),n.opts.perMessageDeflate&&("string"==typeof e?s.byteLength(e):e.length)<n.opts.perMessageDeflate.threshold&&(t.compress=!1));try{h?n.ws.send(e):n.ws.send(e,t)}catch(e){u("websocket closed before onclose event")}--r||(n.emit("flush"),setTimeout(function(){n.writable=!0,n.emit("drain")},0))})}(e[t])}onClose(){e.prototype.onClose.call(this)}doClose(){void 0!==this.ws&&this.ws.close()}uri(){let e=this.query||{};var t=this.opts.secure?"wss":"ws";let i="";return this.opts.port&&("wss"==t&&443!==Number(this.opts.port)||"ws"==t&&80!==Number(this.opts.port))&&(i=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=r()),this.supportsBinary||(e.b64=1),e=n.encode(e),e.length&&(e="?"+e),t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+i+this.opts.path+e}check(){return!(!l||"__initialize"in l&&this.name===t.prototype.name)}}i.exports=t}.call(this,d("./node_modules/buffer/index.js").Buffer)},"./node_modules/engine.io-client/lib/util.js":function(e,t){e.exports.pick=(i,...e)=>e.reduce((e,t)=>(i.hasOwnProperty(t)&&(e[t]=i[t]),e),{})},"./node_modules/engine.io-client/lib/xmlhttprequest.js":function(e,t,i){const n=i("./node_modules/has-cors/index.js"),r=i("./node_modules/engine.io-client/lib/globalThis.browser.js");e.exports=function(e){var t=e.xdomain,i=e.xscheme,e=e.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!t||n))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!i&&e)return new XDomainRequest}catch(e){}if(!t)try{return new r[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch(e){}}},"./node_modules/engine.io-client/node_modules/debug/src/browser.js":function(i,n,r){!function(t){n.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),this.useColors){var n="color: "+this.color;e.splice(1,0,n,"color: inherit");let t=0,i=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e&&(i=t))}),e.splice(i,0,n)}},n.save=function(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch(e){}},n.load=function(){let e;try{e=n.storage.getItem("debug")}catch(e){}!e&&void 0!==t&&"env"in t&&(e=t.env.DEBUG);return e},n.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage=function(){try{return localStorage}catch(e){}}(),n.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),i.exports=r("./node_modules/engine.io-client/node_modules/debug/src/common.js")(n);const e=i.exports["formatters"];e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}.call(this,r("./node_modules/process/browser.js"))},"./node_modules/engine.io-client/node_modules/debug/src/common.js":function(e,t,r){e.exports=function(t){function l(e){let a,t=null;function o(...r){if(o.enabled){const s=o;var e=Number(new Date),t=e-(a||e);s.diff=t,s.prev=a,s.curr=e,a=e,r[0]=l.coerce(r[0]),"string"!=typeof r[0]&&r.unshift("%O");let n=0;r[0]=r[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";n++;const i=l.formatters[t];return"function"==typeof i&&(t=r[n],e=i.call(s,t),r.splice(n,1),n--),e}),l.formatArgs.call(s,r);const i=s.log||l.log;i.apply(s,r)}}return o.namespace=e,o.useColors=l.useColors(),o.color=l.selectColor(e),o.extend=i,o.destroy=l.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null===t?l.enabled(e):t,set:e=>{t=e}}),"function"==typeof l.init&&l.init(o),o}function i(e,t){const i=l(this.namespace+(void 0===t?":":t)+e);return i.log=this.log,i}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return((l.debug=l).default=l).coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},l.disable=function(){var e=[...l.names.map(n),...l.skips.map(n).map(e=>"-"+e)].join(",");return l.enable(""),e},l.enable=function(e){l.save(e),l.names=[],l.skips=[];let t;const i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length;for(t=0;t<n;t++)i[t]&&("-"===(e=i[t].replace(/\*/g,".*?"))[0]?l.skips.push(new RegExp("^"+e.substr(1)+"$")):l.names.push(new RegExp("^"+e+"$")))},l.enabled=function(e){if("*"===e[e.length-1])return!0;let t,i;for(t=0,i=l.skips.length;t<i;t++)if(l.skips[t].test(e))return!1;for(t=0,i=l.names.length;t<i;t++)if(l.names[t].test(e))return!0;return!1},l.humanize=r("./node_modules/ms/index.js"),l.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach(e=>{l[e]=t[e]}),l.names=[],l.skips=[],l.formatters={},l.selectColor=function(t){let i=0;for(let e=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return l.colors[Math.abs(i)%l.colors.length]},l.enable(l.load()),l}},"./node_modules/engine.io-parser/lib/commons.js":function(e,t){const i=Object.create(null);i.open="0",i.close="1",i.ping="2",i.pong="3",i.message="4",i.upgrade="5",i.noop="6";const n=Object.create(null);Object.keys(i).forEach(e=>{n[i[e]]=e});e.exports={PACKET_TYPES:i,PACKET_TYPES_REVERSE:n,ERROR_PACKET:{type:"error",data:"parser error"}}},"./node_modules/engine.io-parser/lib/decodePacket.browser.js":function(e,t,i){const{PACKET_TYPES_REVERSE:n,ERROR_PACKET:r}=i("./node_modules/engine.io-parser/lib/commons.js");var s="function"==typeof ArrayBuffer;let a;s&&(a=i("./node_modules/base64-arraybuffer/lib/base64-arraybuffer.js"));const o=(e,t)=>"blob"===t&&e instanceof ArrayBuffer?new Blob([e]):e;e.exports=(e,t)=>{if("string"!=typeof e)return{type:"message",data:o(e,t)};var i=e.charAt(0);return"b"===i?{type:"message",data:((e,t)=>{if(a){const i=a.decode(e);return o(i,t)}else return{base64:true,data:e}})(e.substring(1),t)}:n[i]?1<e.length?{type:n[i],data:e.substring(1)}:{type:n[i]}:r}},"./node_modules/engine.io-parser/lib/encodePacket.browser.js":function(e,t,i){const s=i("./node_modules/engine.io-parser/lib/commons.js")["PACKET_TYPES"],a="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),o="function"==typeof ArrayBuffer;const l=(e,t)=>{const i=new FileReader;return i.onload=function(){var e=i.result.split(",")[1];t("b"+e)},i.readAsDataURL(e)};e.exports=({type:e,data:t},i,n)=>{return a&&t instanceof Blob?i?n(t):l(t,n):o&&(t instanceof ArrayBuffer||(r=t,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(r):r&&r.buffer instanceof ArrayBuffer))?i?n(t instanceof ArrayBuffer?t:t.buffer):l(new Blob([t]),n):n(s[e]+(t||""));var r}},"./node_modules/engine.io-parser/lib/index.js":function(e,t,i){const a=i("./node_modules/engine.io-parser/lib/encodePacket.browser.js"),s=i("./node_modules/engine.io-parser/lib/decodePacket.browser.js"),o=String.fromCharCode(30);e.exports={protocol:4,encodePacket:a,encodePayload:(e,i)=>{const n=e.length,r=new Array(n);let s=0;e.forEach((e,t)=>{a(e,!1,e=>{r[t]=e,++s===n&&i(r.join(o))})})},decodePacket:s,decodePayload:(e,t)=>{var i=e.split(o);const n=[];for(let e=0;e<i.length;e++){var r=s(i[e],t);if(n.push(r),"error"===r.type)break}return n}}},"./node_modules/has-cors/index.js":function(t,e){try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){t.exports=!1}},"./node_modules/ieee754/index.js":function(e,t){t.read=function(e,t,i,n,r){var s,a,o=8*r-n-1,l=(1<<o)-1,h=l>>1,c=-7,u=i?r-1:0,f=i?-1:1,i=e[t+u];for(u+=f,s=i&(1<<-c)-1,i>>=-c,c+=o;0<c;s=256*s+e[t+u],u+=f,c-=8);for(a=s&(1<<-c)-1,s>>=-c,c+=n;0<c;a=256*a+e[t+u],u+=f,c-=8);if(0===s)s=1-h;else{if(s===l)return a?NaN:1/0*(i?-1:1);a+=Math.pow(2,n),s-=h}return(i?-1:1)*a*Math.pow(2,s-n)},t.write=function(e,t,i,n,r,s){var a,o,l=8*s-r-1,h=(1<<l)-1,c=h>>1,u=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:s-1,d=n?1:-1,s=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(o=isNaN(t)?1:0,a=h):(a=Math.floor(Math.log(t)/Math.LN2),t*(n=Math.pow(2,-a))<1&&(a--,n*=2),2<=(t+=1<=a+c?u/n:u*Math.pow(2,1-c))*n&&(a++,n/=2),h<=a+c?(o=0,a=h):1<=a+c?(o=(t*n-1)*Math.pow(2,r),a+=c):(o=t*Math.pow(2,c-1)*Math.pow(2,r),a=0));8<=r;e[i+f]=255&o,f+=d,o/=256,r-=8);for(a=a<<r|o,l+=r;0<l;e[i+f]=255&a,f+=d,a/=256,l-=8);e[i+f-d]|=128*s}},"./node_modules/isarray/index.js":function(e,t){var i={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==i.call(e)}},"./node_modules/ms/index.js":function(e,t){var n=36e5,r=864e5;function s(e,t,i,n){t=1.5*i<=t;return Math.round(e/i)+" "+n+(t?"s":"")}e.exports=function(e,t){t=t||{};var i=typeof e;if("string"==i&&0<e.length)return function(e){if(!(100<(e=String(e)).length)){e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(e){var t=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*t;case"weeks":case"week":case"w":return 6048e5*t;case"days":case"day":case"d":return t*r;case"hours":case"hour":case"hrs":case"hr":case"h":return t*n;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*t;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}(e);if("number"==i&&isFinite(e))return(t.long?function(e){var t=Math.abs(e);if(r<=t)return s(e,t,r,"day");if(n<=t)return s(e,t,n,"hour");if(6e4<=t)return s(e,t,6e4,"minute");if(1e3<=t)return s(e,t,1e3,"second");return e+" ms"}:function(e){var t=Math.abs(e);if(r<=t)return Math.round(e/r)+"d";if(n<=t)return Math.round(e/n)+"h";if(6e4<=t)return Math.round(e/6e4)+"m";if(1e3<=t)return Math.round(e/1e3)+"s";return e+"ms"})(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},"./node_modules/parseqs/index.js":function(e,t){t.encode=function(e){var t,i="";for(t in e)e.hasOwnProperty(t)&&(i.length&&(i+="&"),i+=encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return i},t.decode=function(e){for(var t={},i=e.split("&"),n=0,r=i.length;n<r;n++){var s=i[n].split("=");t[decodeURIComponent(s[0])]=decodeURIComponent(s[1])}return t}},"./node_modules/parseuri/index.js":function(e,t){var l=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,h=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];e.exports=function(e){var t=e,i=e.indexOf("["),n=e.indexOf("]");-1!=i&&-1!=n&&(e=e.substring(0,i)+e.substring(i,n).replace(/:/g,";")+e.substring(n,e.length));for(var r,s=l.exec(e||""),a={},o=14;o--;)a[h[o]]=s[o]||"";return-1!=i&&-1!=n&&(a.source=t,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a.pathNames=function(e){var t=e.replace(/\/{2,9}/g,"/").split("/");"/"!=e.substr(0,1)&&0!==e.length||t.splice(0,1);"/"==e.substr(e.length-1,1)&&t.splice(t.length-1,1);return t}(a.path),a.queryKey=(t=a.query,r={},t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(e,t,i){t&&(r[t]=i)}),r),a}},"./node_modules/playcanvas/build/playcanvas.js":function(e,t,i){!function(o){"use strict";if(!Array.prototype.find)Object.defineProperty(Array.prototype,"find",{value:function e(t){if(this==null)throw TypeError('"this" is null or not defined');var i=Object(this);var n=i.length>>>0;if(typeof t!=="function")throw TypeError("predicate must be a function");var r=arguments[1];var s=0;while(s<n){var a=i[s];if(t.call(r,a,s,i))return a;s++}return undefined},configurable:true,writable:true});if(Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},!Math.sign)Math.sign=function(e){return(e>0)-(e<0)||+e};if(typeof Object.assign!="function")Object.defineProperty(Object,"assign",{value:function e(t,i){if(t==null)throw new TypeError("Cannot convert undefined or null to object");var n=Object(t);for(var r=1;r<arguments.length;r++){var s=arguments[r];if(s!=null)for(var a in s)if(Object.prototype.hasOwnProperty.call(s,a))n[a]=s[a]}return n},writable:true,configurable:true});if(function(){if(typeof navigator==="undefined"||typeof document==="undefined")return;navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var t=function e(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",true,false,null);document.dispatchEvent(t)};var i=function e(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",true,false,null);document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,false);document.addEventListener("webkitpointerlocklost",t,false);document.addEventListener("mozpointerlockchange",t,false);document.addEventListener("mozpointerlocklost",t,false);document.addEventListener("webkitpointerlockerror",i,false);document.addEventListener("mozpointerlockerror",i,false);if(Element.prototype.mozRequestPointerLock)Element.prototype.requestPointerLock=function(){this.mozRequestPointerLock()};else Element.prototype.requestPointerLock=Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;if(!Element.prototype.requestPointerLock&&navigator.pointer)Element.prototype.requestPointerLock=function(){var e=this;document.pointerLockElement=e;navigator.pointer.lock(e,t,i)};document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;if(!document.exitPointerLock)document.exitPointerLock=function(){if(navigator.pointer){document.pointerLockElement=null;navigator.pointer.unlock()}}}(),function(){if(typeof window==="undefined")return;var s=0;var e=["ms","moz","webkit","o"];for(var t=0;t<e.length&&!window.requestAnimationFrame;++t){window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(e,t){var i=(new Date).getTime();var n=Math.max(0,16-(i-s));var r=window.setTimeout(function(){e(i+n)},n);s=i+n;return r};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(e){clearTimeout(e)}}(),!String.prototype.endsWith)String.prototype.endsWith=function(e,t){if(t===undefined||t>this.length)t=this.length;return this.substring(t-e.length,t)===e};if(!String.prototype.includes)String.prototype.includes=function(e,t){if(typeof t!=="number")t=0;if(t+e.length>this.length)return false;else return this.indexOf(e,t)!==-1};if(!String.prototype.startsWith)String.prototype.startsWith=function(e,t){return this.substr(!t||t<0?0:+t,e.length)===e};(function(){var n={};function i(e){if(window.console&&window.console.error)window.console.error(e)}function t(e){if(window.console&&window.console.log)window.console.log(e)}function f(e,t){n[e]=true;if(t!==undefined)i(t)}function r(t){var i=t.getError;t.getError=function(){var e;do{e=i.apply(t);if(e!=t.NO_ERROR)n[e]=true}while(e!=t.NO_ERROR);for(var e in n)if(n[e]){delete n[e];return parseInt(e)}return t.NO_ERROR}}var s=function e(t){var i=t.gl;this.ext=t;this.isAlive=true;this.hasBeenBound=false;this.elementArrayBuffer=null;this.attribs=new Array(t.maxVertexAttribs);for(var n=0;n<this.attribs.length;n++){var r=new e.VertexAttrib(i);this.attribs[n]=r}this.maxAttrib=0};s.VertexAttrib=function e(t){this.enabled=false;this.buffer=null;this.size=4;this.type=t.FLOAT;this.normalized=false;this.stride=16;this.offset=0;this.cached="";this.recache()};s.VertexAttrib.prototype.recache=function e(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function e(s){var h=this;this.gl=s;r(s);var c=this.original={getParameter:s.getParameter,enableVertexAttribArray:s.enableVertexAttribArray,disableVertexAttribArray:s.disableVertexAttribArray,bindBuffer:s.bindBuffer,getVertexAttrib:s.getVertexAttrib,vertexAttribPointer:s.vertexAttribPointer};s.getParameter=function e(t){if(t==h.VERTEX_ARRAY_BINDING_OES)if(h.currentVertexArrayObject==h.defaultVertexArrayObject)return null;else return h.currentVertexArrayObject;return c.getParameter.apply(this,arguments)};s.enableVertexAttribArray=function e(t){var i=h.currentVertexArrayObject;i.maxAttrib=Math.max(i.maxAttrib,t);var n=i.attribs[t];n.enabled=true;return c.enableVertexAttribArray.apply(this,arguments)};s.disableVertexAttribArray=function e(t){var i=h.currentVertexArrayObject;i.maxAttrib=Math.max(i.maxAttrib,t);var n=i.attribs[t];n.enabled=false;return c.disableVertexAttribArray.apply(this,arguments)};s.bindBuffer=function e(t,i){switch(t){case s.ARRAY_BUFFER:h.currentArrayBuffer=i;break;case s.ELEMENT_ARRAY_BUFFER:h.currentVertexArrayObject.elementArrayBuffer=i;break}return c.bindBuffer.apply(this,arguments)};s.getVertexAttrib=function e(t,i){var n=h.currentVertexArrayObject;var r=n.attribs[t];switch(i){case s.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case s.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case s.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case s.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case s.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case s.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return c.getVertexAttrib.apply(this,arguments)}};s.vertexAttribPointer=function e(t,i,n,r,s,a){var o=h.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,t);var l=o.attribs[t];l.buffer=h.currentArrayBuffer;l.size=i;l.type=n;l.normalized=r;l.stride=s;l.offset=a;l.recache();return c.vertexAttribPointer.apply(this,arguments)};if(s.instrumentExtension)s.instrumentExtension(this,"OES_vertex_array_object");s.canvas.addEventListener("webglcontextrestored",function(){t("OESVertexArrayObject emulation library context restored");h.reset_()},true);this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229;a.prototype.reset_=function e(){var t=this.vertexArrayObjects!==undefined;if(t)for(var i=0;i<this.vertexArrayObjects.length;++i)this.vertexArrayObjects.isAlive=false;var n=this.gl;this.maxVertexAttribs=n.getParameter(n.MAX_VERTEX_ATTRIBS);this.defaultVertexArrayObject=new s(this);this.currentVertexArrayObject=null;this.currentArrayBuffer=null;this.vertexArrayObjects=[this.defaultVertexArrayObject];this.bindVertexArrayOES(null)};a.prototype.createVertexArrayOES=function e(){var t=new s(this);this.vertexArrayObjects.push(t);return t};a.prototype.deleteVertexArrayOES=function e(t){t.isAlive=false;this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1);if(this.currentVertexArrayObject==t)this.bindVertexArrayOES(null)};a.prototype.isVertexArrayOES=function e(t){if(t&&t instanceof s)if(t.hasBeenBound&&t.ext==this)return true;return false};a.prototype.bindVertexArrayOES=function e(t){var i=this.gl;if(t&&!t.isAlive){f(i.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject");return}var n=this.original;var r=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject;this.currentVertexArrayObject.hasBeenBound=true;var s=this.currentVertexArrayObject;if(r==s)return;if(!r||s.elementArrayBuffer!=r.elementArrayBuffer)n.bindBuffer.call(i,i.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);var a=this.currentArrayBuffer;var o=Math.max(r?r.maxAttrib:0,s.maxAttrib);for(var l=0;l<=o;l++){var h=s.attribs[l];var c=r?r.attribs[l]:null;if(!r||h.enabled!=c.enabled)if(h.enabled)n.enableVertexAttribArray.call(i,l);else n.disableVertexAttribArray.call(i,l);if(h.enabled){var u=false;if(!r||h.buffer!=c.buffer){if(a!=h.buffer){n.bindBuffer.call(i,i.ARRAY_BUFFER,h.buffer);a=h.buffer}u=true}if(u||h.cached!=c.cached)n.vertexAttribPointer.call(i,l,h.size,h.type,h.normalized,h.stride,h.offset)}}if(this.currentArrayBuffer!=a)n.bindBuffer.call(i,i.ARRAY_BUFFER,this.currentArrayBuffer)};window.setupVertexArrayObject=function(i){if(i.getSupportedExtensions){var e=i.getSupportedExtensions();if(e.indexOf("OES_vertex_array_object")!=-1)return}else if(i.getExtension){var t=i.getExtension("OES_vertex_array_object");if(t)return}if(i.getSupportedExtensions){var n=i.getSupportedExtensions;i.getSupportedExtensions=function e(){var t=n.call(this)||[];t.push("OES_vertex_array_object");return t}}var r=i.getExtension;i.getExtension=function e(t){if(t=="OES_vertex_array_object"){if(!i.__OESVertexArrayObject)i.__OESVertexArrayObject=new a(i);return i.__OESVertexArrayObject}if(r)return r.call(this,t);else return null}}})();var i=function(){var e={};var t=["Array","Object","Function","Date","RegExp","Float32Array"];for(var i=0;i<t.length;i++)e["[object "+t[i]+"]"]=t[i].toLowerCase();return e}(),r="1.38.3",s="a9cf16e58",e={},t={},n={},a={};function l(e){if(e===null)return"null";var t=typeof e;if(t==="undefined"||t==="number"||t==="string"||t==="boolean")return t;return i[Object.prototype.toString.call(e)]}function _(e,t){var i,n;for(i in t){n=t[i];if(l(n)=="object")e[i]=_({},n);else if(l(n)=="array")e[i]=_([],n);else e[i]=n}return e}function h(e){var t;return e!==t}var c=function(){var o=null;var l=null;var h=null;var c=null;return{display:function e(t){function i(){o=document.createElement("table");l=document.createElement("tr");h=document.createElement("td");c=document.createElement("td");o.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc";o.style.top="0px";o.style.left="0px";o.style.border="thin solid #cccccc";document.body.appendChild(o)}if(!o)i();o.innerHTML="";for(var n in t){var r=l.cloneNode();var s=h.cloneNode();var a=c.cloneNode();s.textContent=n;a.textContent=t[n];r.appendChild(s);r.appendChild(a);o.appendChild(r)}}}}(),u=function(){function e(){this._callbacks={};this._callbackActive={}}var t=e.prototype;t._addCallback=function e(t,i,n,r){if(r===void 0)r=false;if(!t||typeof t!=="string"||!i)return;if(!this._callbacks[t])this._callbacks[t]=[];if(this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t])this._callbackActive[t]=this._callbackActive[t].slice();this._callbacks[t].push({callback:i,scope:n||this,once:r})};t.on=function e(t,i,n){this._addCallback(t,i,n,false);return this};t.off=function e(t,i,n){if(t){if(this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t])this._callbackActive[t]=this._callbackActive[t].slice()}else for(var r in this._callbackActive){if(!this._callbacks[r])continue;if(this._callbacks[r]!==this._callbackActive[r])continue;this._callbackActive[r]=this._callbackActive[r].slice()}if(!t)this._callbacks={};else if(!i){if(this._callbacks[t])this._callbacks[t]=[]}else{var s=this._callbacks[t];if(!s)return this;var a=s.length;for(var o=0;o<a;o++){if(s[o].callback!==i)continue;if(n&&s[o].scope!==n)continue;s[o--]=s[--a]}s.length=a}return this};t.fire=function e(t,i,n,r,s,a,o,l,h){if(!t||!this._callbacks[t])return this;var c;if(!this._callbackActive[t])this._callbackActive[t]=this._callbacks[t];else{if(this._callbackActive[t]===this._callbacks[t])this._callbackActive[t]=this._callbackActive[t].slice();c=this._callbacks[t].slice()}for(var u=0;(c||this._callbackActive[t])&&u<(c||this._callbackActive[t]).length;u++){var f=(c||this._callbackActive[t])[u];f.callback.call(f.scope,i,n,r,s,a,o,l,h);if(f.once){var d=this._callbacks[t].indexOf(f);if(d!==-1){if(this._callbackActive[t]===this._callbacks[t])this._callbackActive[t]=this._callbackActive[t].slice();this._callbacks[t].splice(d,1)}}}if(!c)this._callbackActive[t]=null;return this};t.once=function e(t,i,n){this._addCallback(t,i,n,true);return this};t.hasEvent=function e(t){return this._callbacks[t]&&this._callbacks[t].length!==0||false};return e}(),f={attach:function e(t){var i=f;t._addCallback=i._addCallback;t.on=i.on;t.off=i.off;t.fire=i.fire;t.once=i.once;t.hasEvent=i.hasEvent;t._callbacks={};t._callbackActive={};return t},_addCallback:u.prototype._addCallback,on:u.prototype.on,off:u.prototype.off,fire:u.prototype.fire,once:u.prototype.once,hasEvent:u.prototype.hasEvent},d={create:function e(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,i=e=="x"?t:t&3|8;return i.toString(16)})}},p={delimiter:"/",join:function e(){var t;var i=arguments.length;var n=arguments[0];for(t=0;t<i-1;++t){var r=arguments[t];var s=arguments[t+1];if(!h(r)||!h(s))throw new Error("undefined argument to pc.path.join");if(s[0]===p.delimiter){n=s;continue}if(r&&s&&r[r.length-1]!==p.delimiter&&s[0]!==p.delimiter)n+=p.delimiter+s;else n+=s}return n},normalize:function e(t){var i=t.startsWith(p.delimiter);var n=t.endsWith(p.delimiter);var r=t.split("/");var s="";var a=[];for(var o=0;o<r.length;o++){if(r[o]==="")continue;if(r[o]===".")continue;if(r[o]===".."&&a.length>0){a=a.slice(0,a.length-2);continue}if(o>0)a.push(p.delimiter);a.push(r[o])}s=a.join("");if(!i&&s[0]===p.delimiter)s=s.slice(1);if(n&&s[s.length-1]!==p.delimiter)s+=p.delimiter;return s},split:function e(t){var i=t.split(p.delimiter);var n=i.slice(i.length-1)[0];var r=i.slice(0,i.length-1).join(p.delimiter);return[r,n]},getBasename:function e(t){return p.split(t)[1]},getDirectory:function e(t){var i=t.split(p.delimiter);return i.slice(0,i.length-1).join(p.delimiter)},getExtension:function e(t){var i=t.split("?")[0].split(".").pop();if(i!==t)return"."+i;return""},isRelativePath:function e(t){return t.charAt(0)!=="/"&&t.match(/:\/\//)===null},extractPath:function e(t){var i="";var n=t.split("/");var r=0;if(n.length>1)if(p.isRelativePath(t))if(n[0]===".")for(r=0;r<n.length-1;++r)i+=r===0?n[r]:"/"+n[r];else if(n[0]==="..")for(r=0;r<n.length-1;++r)i+=r===0?n[r]:"/"+n[r];else{i=".";for(r=0;r<n.length-1;++r)i+="/"+n[r]}else for(r=0;r<n.length-1;++r)i+=r===0?n[r]:"/"+n[r];return i}},m={desktop:false,mobile:false,ios:false,android:false,windows:false,xbox:false,gamepads:false,touch:false,workers:false,passiveEvents:false};if(typeof navigator!=="undefined"){var v=navigator.userAgent;if(/(windows|mac os|linux|cros)/i.test(v))m.desktop=true;if(/xbox/i.test(v))m.xbox=true;if(/(windows phone|iemobile|wpdesktop)/i.test(v)){m.desktop=false;m.mobile=true;m.windows=true}else if(/android/i.test(v)){m.desktop=false;m.mobile=true;m.android=true}else if(/ip([ao]d|hone)/i.test(v)){m.desktop=false;m.mobile=true;m.ios=true}if(typeof window!=="undefined")m.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&navigator.maxTouchPoints>0;m.gamepads="getGamepads"in navigator;m.workers=typeof Worker!=="undefined";try{var g=Object.defineProperty({},"passive",{get:function e(){m.passiveEvents=true;return false}});window.addEventListener("testpassive",null,g);window.removeEventListener("testpassive",null,g)}catch(e){}}var y="abcdefghijklmnopqrstuvwxyz",b="ABCDEFGHIJKLMNOPQRSTUVWXYZ",x,S=55296,w=56319,T=56320,M=57343,C=8205,A=127462,P=127487,E=127995,I=127999,R=8400,L=8447,D=65024,k=65039;function O(e,t){var i=e.length;t=t||0;if(t<0||t>=i)return null;var n=e.charCodeAt(t);var r;if(i>1&&n>=S&&n<=w){r=e.charCodeAt(t+1);if(r>=T&&r<=M)return{code:(n-S)*1024+r-T+65536,long:true}}return{code:n,long:false}}function F(e,t,i){if(!e)return false;var n=O(e);if(n){var r=n.code;return r>=t&&r<=i}return false}function B(e,t){if(t===e.length-1)return 1;if(F(e[t],S,w)){var i=e.substring(t,t+2);var n=e.substring(t+2,t+4);if(F(n,E,I)||F(i,A,P)&&F(n,A,P))return 4;if(F(n,D,k))return 3;return 2}if(F(e[t+1],D,k))return 2;return 1}var Ae={ASCII_LOWERCASE:y,ASCII_UPPERCASE:b,ASCII_LETTERS:y+b,format:function e(t){for(var i=1;i<arguments.length;i++)t=t.replace("{"+(i-1)+"}",arguments[i]);return t},toBool:function e(t,i){if(t==="true")return true;if(i){if(t==="false")return false;throw new TypeError("Not a boolean string")}return false},getCodePoint:function e(t,i){var n=O(t,i);return n&&n.code},getCodePoints:function e(t){if(typeof t!=="string")throw new TypeError("Not a string");var i=0;var n=[];var r;while(!!(r=O(t,i))){n.push(r.code);i+=r.long?2:1}return n},getSymbols:function e(t){if(typeof t!=="string")throw new TypeError("Not a string");var i=0;var n=t.length;var r=[];var s=0;var a;while(i<n){s+=B(t,i+s);a=t[i+s];if(F(a,R,L))a=t[i+s++];if(F(a,D,k))a=t[i+s++];if(a&&a.charCodeAt(0)===C){a=t[i+s++];continue}var o=t.substring(i,i+s);r.push(o);i+=s;s=0}return r},fromCodePoint:function e(){var t=[];var i;var n;var r;for(var s=0;s<arguments.length;++s){i=Number(arguments[s]);n=i-65536;r=i>65535?[(n>>10)+55296,n%1024+56320]:[i];t.push(String.fromCharCode.apply(null,r))}return t.join("")}},Pe={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function e(t,i,n){if(t>=n)return n;if(t<=i)return i;return t},intToBytes24:function e(t){var i,n,r;i=t>>16&255;n=t>>8&255;r=t&255;return[i,n,r]},intToBytes32:function e(t){var i,n,r,s;i=t>>24&255;n=t>>16&255;r=t>>8&255;s=t&255;return[i,n,r,s]},bytesToInt24:function e(t,i,n){if(t.length){n=t[2];i=t[1];t=t[0]}return t<<16|i<<8|n},bytesToInt32:function e(t,i,n,r){if(t.length){r=t[3];n=t[2];i=t[1];t=t[0]}return(t<<24|i<<16|n<<8|r)>>>32},lerp:function e(t,i,n){return t+(i-t)*Pe.clamp(n,0,1)},lerpAngle:function e(t,i,n){if(i-t>180)i-=360;if(i-t<-180)i+=360;return Pe.lerp(t,i,Pe.clamp(n,0,1))},powerOfTwo:function e(t){return t!==0&&!(t&t-1)},nextPowerOfTwo:function e(t){t--;t|=t>>1;t|=t>>2;t|=t>>4;t|=t>>8;t|=t>>16;t++;return t},random:function e(t,i){var n=i-t;return Math.random()*n+t},smoothstep:function e(t,i,n){if(n<=t)return 0;if(n>=i)return 1;n=(n-t)/(i-t);return n*n*(3-2*n)},smootherstep:function e(t,i,n){if(n<=t)return 0;if(n>=i)return 1;n=(n-t)/(i-t);return n*n*n*(n*(n*6-15)+10)},roundUp:function e(t,i){if(i===0)return t;return Math.ceil(t/i)*i},float2Half:function(){var s=new Float32Array(1);var a=new Int32Array(s.buffer);return function(e){s[0]=e;var t=a[0];var i=t>>16&32768;var n=t>>12&2047;var r=t>>23&255;if(r<103)return i;if(r>142){i|=31744;i|=(r==255?0:1)&&t&8388607;return i}if(r<113){n|=2048;i|=(n>>114-r)+(n>>113-r&1);return i}i|=r-112<<10|n>>1;i+=n&1;return i}}()},ge=function(){function t(e,t,i,n){if(e===void 0)e=0;if(t===void 0)t=0;if(i===void 0)i=0;if(n===void 0)n=1;var r=e.length;if(r===3||r===4){this.r=e[0];this.g=e[1];this.b=e[2];this.a=e[3]!==undefined?e[3]:1}else{this.r=e;this.g=t;this.b=i;this.a=n}}var e=t.prototype;e.clone=function e(){return new t(this.r,this.g,this.b,this.a)};e.copy=function e(t){this.r=t.r;this.g=t.g;this.b=t.b;this.a=t.a;return this};e.equals=function e(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a};e.set=function e(t,i,n,r){if(r===void 0)r=1;this.r=t;this.g=i;this.b=n;this.a=r;return this};e.lerp=function e(t,i,n){this.r=t.r+n*(i.r-t.r);this.g=t.g+n*(i.g-t.g);this.b=t.b+n*(i.b-t.b);this.a=t.a+n*(i.a-t.a);return this};e.fromString=function e(t){var i=parseInt(t.replace("#","0x"),16);var n;if(t.length>7)n=Pe.intToBytes32(i);else{n=Pe.intToBytes24(i);n[3]=255}this.set(n[0]/255,n[1]/255,n[2]/255,n[3]/255);return this};e.toString=function e(t){var i="#"+((1<<24)+(Math.round(this.r*255)<<16)+(Math.round(this.g*255)<<8)+Math.round(this.b*255)).toString(16).slice(1);if(t===true){var n=Math.round(this.a*255).toString(16);if(this.a<16/255)i+="0"+n;else i+=n}return i};return t}();ge.BLACK=Object.freeze(new ge(0,0,0,1)),ge.BLUE=Object.freeze(new ge(0,0,1,1)),ge.CYAN=Object.freeze(new ge(0,1,1,1)),ge.GRAY=Object.freeze(new ge(.5,.5,.5,1)),ge.GREEN=Object.freeze(new ge(0,1,0,1)),ge.MAGENTA=Object.freeze(new ge(1,0,1,1)),ge.RED=Object.freeze(new ge(1,0,0,1)),ge.WHITE=Object.freeze(new ge(1,1,1,1)),ge.YELLOW=Object.freeze(new ge(1,1,0,1));var N=function(){function e(){this._list=[];this._index={}}var t=e.prototype;t.push=function e(t,i){if(this._index[t])throw Error("Key already in index "+t);var n=this._list.push(i)-1;this._index[t]=n};t.has=function e(t){return this._index[t]!==undefined};t.get=function e(t){var i=this._index[t];if(i!==undefined)return this._list[i];return null};t.remove=function e(t){var i=this._index[t];if(i!==undefined){this._list.splice(i,1);delete this._index[t];for(t in this._index){var n=this._index[t];if(n>i)this._index[t]=n-1}return true}return false};t.list=function e(){return this._list};t.clear=function e(){this._list.length=0;for(var t in this._index)delete this._index[t]};return e}(),z=function(){function e(e){this._sortBy=e.sortBy;this.items=[];this.length=0;this.loopIndex=-1;this._sortHandler=this._doSort.bind(this)}var t=e.prototype;t._binarySearch=function e(t){var i=0;var n=this.items.length-1;var r=t[this._sortBy];var s;var a;while(i<=n){s=Math.floor((i+n)/2);a=this.items[s][this._sortBy];if(a<=r)i=s+1;else if(a>r)n=s-1}return i};t._doSort=function e(t,i){var n=this._sortBy;return t[n]-i[n]};t.insert=function e(t){var i=this._binarySearch(t);this.items.splice(i,0,t);this.length++;if(this.loopIndex>=i)this.loopIndex++};t.append=function e(t){this.items.push(t);this.length++};t.remove=function e(t){var i=this.items.indexOf(t);if(i<0)return;this.items.splice(i,1);this.length--;if(this.loopIndex>=i)this.loopIndex--};t.sort=function e(){var t=this.loopIndex>=0?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler);if(t!==null)this.loopIndex=this.items.indexOf(t)};return e}();function V(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function U(e,t,i){if(t)V(e.prototype,t);if(i)V(e,i);return e}function G(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;e.__proto__=t}function H(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function W(e,t){if(!e)return;if(typeof e==="string")return j(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return j(e,t)}function j(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function X(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=W(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;return function(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}i=e[Symbol.iterator]();return i.next.bind(i)}var q=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._index={};t._list=[];t._parent=e;return t}var t=e.prototype;t.add=function e(){var t=false;var i=this._processArguments(arguments,true);if(!i.length)return t;for(var n=0;n<i.length;n++){if(this._index[i[n]])continue;t=true;this._index[i[n]]=true;this._list.push(i[n]);this.fire("add",i[n],this._parent)}if(t)this.fire("change",this._parent);return t};t.remove=function e(){var t=false;if(!this._list.length)return t;var i=this._processArguments(arguments,true);if(!i.length)return t;for(var n=0;n<i.length;n++){if(!this._index[i[n]])continue;t=true;delete this._index[i[n]];this._list.splice(this._list.indexOf(i[n]),1);this.fire("remove",i[n],this._parent)}if(t)this.fire("change",this._parent);return t};t.clear=function e(){if(!this._list.length)return;var t=this._list.slice(0);this._list=[];this._index={};for(var i=0;i<t.length;i++)this.fire("remove",t[i],this._parent);this.fire("change",this._parent)};t.has=function e(){if(!this._list.length)return false;return this._has(this._processArguments(arguments))};t._has=function e(t){if(!this._list.length||!t.length)return false;for(var i=0;i<t.length;i++)if(t[i].length===1){if(this._index[t[i][0]])return true}else{var n=true;for(var r=0;r<t[i].length;r++){if(this._index[t[i][r]])continue;n=false;break}if(n)return true}return false};t.list=function e(){return this._list.slice(0)};t._processArguments=function e(t,i){var n=[];var r=[];if(!t||!t.length)return n;for(var s=0;s<t.length;s++)if(t[s]instanceof Array){if(!i)r=[];for(var a=0;a<t[s].length;a++){if(typeof t[s][a]!=="string")continue;if(i)n.push(t[s][a]);else r.push(t[s][a])}if(!i&&r.length)n.push(r)}else if(typeof t[s]==="string")if(i)n.push(t[s]);else n.push([t[s]]);return n};U(e,[{key:"size",get:function e(){return this._list.length}}]);return e}(u),ye=typeof window!=="undefined"&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now,Y=function(){function e(){this._isRunning=false;this._a=0;this._b=0}var t=e.prototype;t.start=function e(){this._isRunning=true;this._a=ye()};t.stop=function e(){this._isRunning=false;this._b=ye()};t.getMilliseconds=function e(){return this._b-this._a};return e}();function K(e){var t="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw new Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw new Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw new Error("Can't have 'path' and 'hostpath' option");if(e.scheme)t+=e.scheme+":";if(e.authority)t+="//"+e.authority;if(e.host)t+=e.host;if(e.path)t+=e.path;if(e.hostpath)t+=e.hostpath;if(e.query)t+="?"+e.query;if(e.fragment)t+="#"+e.fragment;return t}function Q(e){var t=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,i=e.match(t);this.scheme=i[2];this.authority=i[4];this.path=i[5];this.query=i[7];this.fragment=i[9];this.toString=function(){var e="";if(this.scheme)e+=this.scheme+":";if(this.authority)e+="//"+this.authority;e+=this.path;if(this.query)e+="?"+this.query;if(this.fragment)e+="#"+this.fragment;return e};this.getQuery=function(){var e;var n;var r={};if(this.query){e=decodeURIComponent(this.query).split("&");e.forEach(function(e,t,i){n=e.split("=");r[n[0]]=n[1]},this)}return r};this.setQuery=function(e){var t="";for(var i in e)if(e.hasOwnProperty(i)){if(t!=="")t+="&";t+=encodeURIComponent(i)+"="+encodeURIComponent(e[i])}this.query=t}}var $=function(){function m(){this.ContentType=m.ContentType;this.ResponseType=m.ResponseType;this.binaryExtensions=m.binaryExtensions}var e=m.prototype;e.get=function e(t,i,n){if(typeof i==="function"){n=i;i={}}return this.request("GET",t,i,n)};e.post=function e(t,i,n,r){if(typeof n==="function"){r=n;n={}}n.postdata=i;return this.request("POST",t,n,r)};e.put=function e(t,i,n,r){if(typeof n==="function"){r=n;n={}}n.postdata=i;return this.request("PUT",t,n,r)};e.del=function e(t,i,n){if(typeof i==="function"){n=i;i={}}return this.request("DELETE",t,i,n)};e.request=function e(t,i,n,r){var s,a,o,l,h;var c=false;if(typeof n==="function"){r=n;n={}}if(n.retry)n=Object.assign({retries:0,maxRetries:5},n);n.callback=r;if(n.async==null)n.async=true;if(n.headers==null)n.headers={};if(n.postdata!=null)if(n.postdata instanceof Document)l=n.postdata;else if(n.postdata instanceof FormData)l=n.postdata;else if(n.postdata instanceof Object){var u=n.headers["Content-Type"];if(u===undefined){n.headers["Content-Type"]=m.ContentType.FORM_URLENCODED;u=n.headers["Content-Type"]}switch(u){case m.ContentType.FORM_URLENCODED:l="";var f=true;for(var d in n.postdata)if(n.postdata.hasOwnProperty(d)){if(f)f=false;else l+="&";l+=escape(d)+"="+escape(n.postdata[d])}break;default:case m.ContentType.JSON:if(u==null)n.headers["Content-Type"]=m.ContentType.JSON;l=JSON.stringify(n.postdata);break}}else l=n.postdata;if(n.cache===false){o=ye();s=new Q(i);if(!s.query)s.query="ts="+o;else s.query=s.query+"&ts="+o;i=s.toString()}if(n.query){s=new Q(i);a=_(s.getQuery(),n.query);s.setQuery(a);i=s.toString()}h=new XMLHttpRequest;h.open(t,i,n.async);h.withCredentials=n.withCredentials!==undefined?n.withCredentials:false;h.responseType=n.responseType||this._guessResponseType(i);for(var p in n.headers)if(n.headers.hasOwnProperty(p))h.setRequestHeader(p,n.headers[p]);h.onreadystatechange=function(){this._onReadyStateChange(t,i,n,h)}.bind(this);h.onerror=function(){this._onError(t,i,n,h);c=true}.bind(this);try{h.send(l)}catch(e){if(!c)n.error(h.status,h,e)}return h};e._guessResponseType=function e(t){var i=new Q(t);var n=p.getExtension(i.path);if(m.binaryExtensions.indexOf(n)>=0)return m.ResponseType.ARRAY_BUFFER;if(n===".xml")return m.ResponseType.DOCUMENT;return m.ResponseType.TEXT};e._isBinaryContentType=function e(t){var i=[m.ContentType.MP4,m.ContentType.WAV,m.ContentType.OGG,m.ContentType.MP3,m.ContentType.BIN,m.ContentType.DDS,m.ContentType.BASIS,m.ContentType.GLB];if(i.indexOf(t)>=0)return true;return false};e._onReadyStateChange=function e(t,i,n,r){if(r.readyState===4)switch(r.status){case 0:{if(r.responseURL&&r.responseURL.startsWith("file:///"))this._onSuccess(t,i,n,r);else this._onError(t,i,n,r);break}case 200:case 201:case 206:case 304:{this._onSuccess(t,i,n,r);break}default:{this._onError(t,i,n,r);break}}};e._onSuccess=function e(t,i,n,r){var s;var a;var o;var l;a=r.getResponseHeader("Content-Type");if(a){l=a.split(";");o=l[0].trim()}try{if(o===this.ContentType.JSON||i.split("?")[0].endsWith(".json"))s=JSON.parse(r.responseText);else if(this._isBinaryContentType(o))s=r.response;else{if(o)console.warn("responseType: "+r.responseType+" being served with Content-Type: "+o);if(r.responseType===m.ResponseType.ARRAY_BUFFER)s=r.response;else if(r.responseType===m.ResponseType.BLOB||r.responseType===m.ResponseType.JSON)s=r.response;else if(r.responseType===m.ResponseType.DOCUMENT||o===this.ContentType.XML)s=r.responseXML;else s=r.responseText}n.callback(null,s)}catch(e){n.callback(e)}};e._onError=function e(t,i,n,r){if(n.retrying)return;if(n.retry&&n.retries<n.maxRetries){n.retries++;n.retrying=true;var s=Pe.clamp(Math.pow(2,n.retries)*m.retryDelay,0,n.maxRetryDelay||5e3);console.log(t+": "+i+" - Error "+r.status+". Retrying in "+s+" ms");setTimeout(function(){n.retrying=false;this.request(t,i,n,n.callback)}.bind(this),s)}else n.callback(r.status===0?"Network error":r.status,null)};return m}();$.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},$.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},$.binaryExtensions=[".model",".wav",".ogg",".mp3",".mp4",".m4a",".aac",".dds",".basis",".glb"],$.retryDelay=100;var Z=new $,J=0,ee=1,te=2,ie=3,ne=4,re=5,se=function(){function e(e,t){this._curve=e;this._left=-Infinity;this._right=Infinity;this._recip=0;this._p0=0;this._p1=0;this._m0=0;this._m1=0;this._reset(t||0)}var t=e.prototype;t.evaluate=function e(t,i){if(i||t<this._left||t>=this._right)this._reset(t);var n;var r=this._curve.type;if(r===re)n=this._p0;else{var s=this._recip===0?0:(t-this._left)*this._recip;if(r===J)n=Pe.lerp(this._p0,this._p1,s);else if(r===ee)n=Pe.lerp(this._p0,this._p1,s*s*(3-2*s));else n=this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,s)}return n};t._reset=function e(t){var i=this._curve.keys;var n=i.length;if(!n){this._left=-Infinity;this._right=Infinity;this._recip=0;this._p0=this._p1=this._m0=this._m1=0}else if(t<i[0][0]){this._left=-Infinity;this._right=i[0][0];this._recip=0;this._p0=this._p1=i[0][1];this._m0=this._m1=0}else if(t>=i[n-1][0]){this._left=i[n-1][0];this._right=Infinity;this._recip=0;this._p0=this._p1=i[n-1][1];this._m0=this._m1=0}else{var r=0;while(t>=i[r+1][0])r++;this._left=i[r][0];this._right=i[r+1][0];var s=1/(this._right-this._left);this._recip=isFinite(s)?s:0;this._p0=i[r][1];this._p1=i[r+1][1];if(this._isHermite())this._calcTangents(i,r)}};t._isHermite=function e(){return this._curve.type===te||this._curve.type===ie||this._curve.type===ne};t._calcTangents=function e(t,i){var n;var r=t[i];var s=t[i+1];var a;if(i===0)n=[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])];else n=t[i-1];if(i==t.length-2)a=[t[i+1][0]+(t[i+1][0]-t[i][0]),t[i+1][1]+(t[i+1][1]-t[i][1])];else a=t[i+2];if(this._curve.type===ne){var o=2*(s[0]-r[0])/(s[0]-n[0]);var l=2*(s[0]-r[0])/(a[0]-r[0]);this._m0=this._curve.tension*(isFinite(o)?o:0)*(s[1]-n[1]);this._m1=this._curve.tension*(isFinite(l)?l:0)*(a[1]-r[1])}else{var h=(s[0]-r[0])/(r[0]-n[0]);var c=(s[0]-r[0])/(a[0]-s[0]);var u=r[1]+(n[1]-r[1])*(isFinite(h)?h:0);var f=s[1]+(a[1]-s[1])*(isFinite(c)?c:0);var d=this._curve.type===te?.5:this._curve.tension;this._m0=d*(s[1]-u);this._m1=d*(f-r[1])}};t._evaluateHermite=function e(t,i,n,r,s){var a=s*s;var o=s+s;var l=1-s;var h=l*l;return t*((1+o)*h)+n*(s*h)+i*(a*(3-o))+r*(a*(s-1))};return e}(),ae=function(){function i(e){this.keys=[];this.type=ee;this.tension=.5;this._eval=new se(this);if(e)for(var t=0;t<e.length-1;t+=2)this.keys.push([e[t],e[t+1]]);this.sort()}var e=i.prototype;e.add=function e(t,i){var n=this.keys;var r=n.length;var s=0;for(;s<r;s++)if(n[s][0]>t)break;var a=[t,i];this.keys.splice(s,0,a);return a};e.get=function e(t){return this.keys[t]};e.sort=function e(){this.keys.sort(function(e,t){return e[0]-t[0]})};e.value=function e(t){return this._eval.evaluate(t,true)};e.closest=function e(t){var i=this.keys;var n=i.length;var r=2;var s=null;for(var a=0;a<n;a++){var o=Math.abs(t-i[a][0]);if(r>=o){r=o;s=i[a]}else break}return s};e.clone=function e(){var t=new i;t.keys=_(t.keys,this.keys);t.type=this.type;t.tension=this.tension;return t};e.quantize=function e(t){t=Math.max(t,2);var i=new Float32Array(t);var n=1/(t-1);i[0]=this._eval.evaluate(0,true);for(var r=1;r<t;r++)i[r]=this._eval.evaluate(n*r);return i};e.quantizeClamped=function e(t,i,n){var r=this.quantize(t);for(var s=0;s<r.length;++s)r[s]=Math.min(n,Math.max(i,r[s]));return r};U(i,[{key:"length",get:function e(){return this.keys.length}}]);return i}(),oe=function(){function n(){var e;this.curves=[];this._type=ee;if(arguments.length>1)for(e=0;e<arguments.length;e++)this.curves.push(new ae(arguments[e]));else if(arguments.length===0)this.curves.push(new ae);else{var t=arguments[0];if(typeof t==="number")for(e=0;e<t;e++)this.curves.push(new ae);else for(e=0;e<t.length;e++)this.curves.push(new ae(t[e]))}}var e=n.prototype;e.get=function e(t){return this.curves[t]};e.value=function e(t,i){if(i===void 0)i=[];var n=this.curves.length;i.length=n;for(var r=0;r<n;r++)i[r]=this.curves[r].value(t);return i};e.clone=function e(){var t=new n;t.curves=[];for(var i=0;i<this.curves.length;i++)t.curves.push(this.curves[i].clone());t._type=this._type;return t};e.quantize=function e(t){t=Math.max(t,2);var i=this.curves.length;var n=new Float32Array(t*i);var r=1/(t-1);for(var s=0;s<i;s++){var a=new se(this.curves[s]);for(var o=0;o<t;o++)n[o*i+s]=a.evaluate(r*o)}return n};e.quantizeClamped=function e(t,i,n){var r=this.quantize(t);for(var s=0;s<r.length;++s)r[s]=Math.min(n,Math.max(i,r[s]));return r};U(n,[{key:"length",get:function e(){return this.curves.length}},{key:"type",get:function e(){return this._type},set:function e(t){this._type=t;for(var i=0;i<this.curves.length;i++)this.curves[i].type=t}}]);return n}(),le=function(){function t(){var e;e=new Float32Array(9);e[0]=e[4]=e[8]=1;this.data=e}var e=t.prototype;e.clone=function e(){return(new t).copy(this)};e.copy=function e(t){var i=t.data;var n=this.data;n[0]=i[0];n[1]=i[1];n[2]=i[2];n[3]=i[3];n[4]=i[4];n[5]=i[5];n[6]=i[6];n[7]=i[7];n[8]=i[8];return this};e.set=function e(t){var i=this.data;i[0]=t[0];i[1]=t[1];i[2]=t[2];i[3]=t[3];i[4]=t[4];i[5]=t[5];i[6]=t[6];i[7]=t[7];i[8]=t[8];return this};e.equals=function e(t){var i=this.data;var n=t.data;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]};e.isIdentity=function e(){var t=this.data;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===1&&t[5]===0&&t[6]===0&&t[7]===0&&t[8]===1};e.setIdentity=function e(){var t=this.data;t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=1;t[5]=0;t[6]=0;t[7]=0;t[8]=1;return this};e.toString=function e(){var t="[";for(var i=0;i<9;i++){t+=this.data[i];t+=i!==8?", ":""}t+="]";return t};e.transpose=function e(){var t=this.data;var i;i=t[1];t[1]=t[3];t[3]=i;i=t[2];t[2]=t[6];t[6]=i;i=t[5];t[5]=t[7];t[7]=i;return this};e.setFromMat4=function e(t){var i=t.data;var n=this.data;n[0]=i[0];n[1]=i[1];n[2]=i[2];n[3]=i[4];n[4]=i[5];n[5]=i[6];n[6]=i[8];n[7]=i[9];n[8]=i[10];return this};return t}();le.IDENTITY=Object.freeze(new le),le.ZERO=Object.freeze((new le).set([0,0,0,0,0,0,0,0,0]));var he=function(){function t(e,t){if(e===void 0)e=0;if(t===void 0)t=0;if(e.length===2){this.x=e[0];this.y=e[1]}else{this.x=e;this.y=t}}var e=t.prototype;e.add=function e(t){this.x+=t.x;this.y+=t.y;return this};e.add2=function e(t,i){this.x=t.x+i.x;this.y=t.y+i.y;return this};e.clone=function e(){return new t(this.x,this.y)};e.copy=function e(t){this.x=t.x;this.y=t.y;return this};e.distance=function e(t){var i=this.x-t.x;var n=this.y-t.y;return Math.sqrt(i*i+n*n)};e.dot=function e(t){return this.x*t.x+this.y*t.y};e.equals=function e(t){return this.x===t.x&&this.y===t.y};e.length=function e(){return Math.sqrt(this.x*this.x+this.y*this.y)};e.lengthSq=function e(){return this.x*this.x+this.y*this.y};e.lerp=function e(t,i,n){this.x=t.x+n*(i.x-t.x);this.y=t.y+n*(i.y-t.y);return this};e.mul=function e(t){this.x*=t.x;this.y*=t.y;return this};e.mul2=function e(t,i){this.x=t.x*i.x;this.y=t.y*i.y;return this};e.normalize=function e(){var t=this.x*this.x+this.y*this.y;if(t>0){var i=1/Math.sqrt(t);this.x*=i;this.y*=i}return this};e.scale=function e(t){this.x*=t;this.y*=t;return this};e.set=function e(t,i){this.x=t;this.y=i;return this};e.sub=function e(t){this.x-=t.x;this.y-=t.y;return this};e.sub2=function e(t,i){this.x=t.x-i.x;this.y=t.y-i.y;return this};e.toString=function e(){return"["+this.x+", "+this.y+"]"};return t}();he.ZERO=Object.freeze(new he(0,0)),he.ONE=Object.freeze(new he(1,1)),he.UP=Object.freeze(new he(0,1)),he.DOWN=Object.freeze(new he(0,-1)),he.RIGHT=Object.freeze(new he(1,0)),he.LEFT=Object.freeze(new he(-1,0));var ce=function(){function t(e,t,i){if(e===void 0)e=0;if(t===void 0)t=0;if(i===void 0)i=0;if(e.length===3){this.x=e[0];this.y=e[1];this.z=e[2]}else{this.x=e;this.y=t;this.z=i}}var e=t.prototype;e.add=function e(t){this.x+=t.x;this.y+=t.y;this.z+=t.z;return this};e.add2=function e(t,i){this.x=t.x+i.x;this.y=t.y+i.y;this.z=t.z+i.z;return this};e.clone=function e(){return new t(this.x,this.y,this.z)};e.copy=function e(t){this.x=t.x;this.y=t.y;this.z=t.z;return this};e.cross=function e(t,i){var n=t.x;var r=t.y;var s=t.z;var a=i.x;var o=i.y;var l=i.z;this.x=r*l-o*s;this.y=s*a-l*n;this.z=n*o-a*r;return this};e.distance=function e(t){var i=this.x-t.x;var n=this.y-t.y;var r=this.z-t.z;return Math.sqrt(i*i+n*n+r*r)};e.dot=function e(t){return this.x*t.x+this.y*t.y+this.z*t.z};e.equals=function e(t){return this.x===t.x&&this.y===t.y&&this.z===t.z};e.length=function e(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};e.lengthSq=function e(){return this.x*this.x+this.y*this.y+this.z*this.z};e.lerp=function e(t,i,n){this.x=t.x+n*(i.x-t.x);this.y=t.y+n*(i.y-t.y);this.z=t.z+n*(i.z-t.z);return this};e.mul=function e(t){this.x*=t.x;this.y*=t.y;this.z*=t.z;return this};e.mul2=function e(t,i){this.x=t.x*i.x;this.y=t.y*i.y;this.z=t.z*i.z;return this};e.normalize=function e(){var t=this.x*this.x+this.y*this.y+this.z*this.z;if(t>0){var i=1/Math.sqrt(t);this.x*=i;this.y*=i;this.z*=i}return this};e.project=function e(t){var i=this.x*t.x+this.y*t.y+this.z*t.z;var n=t.x*t.x+t.y*t.y+t.z*t.z;var r=i/n;this.x=t.x*r;this.y=t.y*r;this.z=t.z*r;return this};e.scale=function e(t){this.x*=t;this.y*=t;this.z*=t;return this};e.set=function e(t,i,n){this.x=t;this.y=i;this.z=n;return this};e.sub=function e(t){this.x-=t.x;this.y-=t.y;this.z-=t.z;return this};e.sub2=function e(t,i){this.x=t.x-i.x;this.y=t.y-i.y;this.z=t.z-i.z;return this};e.toString=function e(){return"["+this.x+", "+this.y+", "+this.z+"]"};return t}();ce.ZERO=Object.freeze(new ce(0,0,0)),ce.ONE=Object.freeze(new ce(1,1,1)),ce.UP=Object.freeze(new ce(0,1,0)),ce.DOWN=Object.freeze(new ce(0,-1,0)),ce.RIGHT=Object.freeze(new ce(1,0,0)),ce.LEFT=Object.freeze(new ce(-1,0,0)),ce.FORWARD=Object.freeze(new ce(0,0,-1)),ce.BACK=Object.freeze(new ce(0,0,1));var ue=function(){function t(e,t,i,n){if(e===void 0)e=0;if(t===void 0)t=0;if(i===void 0)i=0;if(n===void 0)n=0;if(e.length===4){this.x=e[0];this.y=e[1];this.z=e[2];this.w=e[3]}else{this.x=e;this.y=t;this.z=i;this.w=n}}var e=t.prototype;e.add=function e(t){this.x+=t.x;this.y+=t.y;this.z+=t.z;this.w+=t.w;return this};e.add2=function e(t,i){this.x=t.x+i.x;this.y=t.y+i.y;this.z=t.z+i.z;this.w=t.w+i.w;return this};e.clone=function e(){return new t(this.x,this.y,this.z,this.w)};e.copy=function e(t){this.x=t.x;this.y=t.y;this.z=t.z;this.w=t.w;return this};e.dot=function e(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w};e.equals=function e(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w};e.length=function e(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};e.lengthSq=function e(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};e.lerp=function e(t,i,n){this.x=t.x+n*(i.x-t.x);this.y=t.y+n*(i.y-t.y);this.z=t.z+n*(i.z-t.z);this.w=t.w+n*(i.w-t.w);return this};e.mul=function e(t){this.x*=t.x;this.y*=t.y;this.z*=t.z;this.w*=t.w;return this};e.mul2=function e(t,i){this.x=t.x*i.x;this.y=t.y*i.y;this.z=t.z*i.z;this.w=t.w*i.w;return this};e.normalize=function e(){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;if(t>0){var i=1/Math.sqrt(t);this.x*=i;this.y*=i;this.z*=i;this.w*=i}return this};e.scale=function e(t){this.x*=t;this.y*=t;this.z*=t;this.w*=t;return this};e.set=function e(t,i,n,r){this.x=t;this.y=i;this.z=n;this.w=r;return this};e.sub=function e(t){this.x-=t.x;this.y-=t.y;this.z-=t.z;this.w-=t.w;return this};e.sub2=function e(t,i){this.x=t.x-i.x;this.y=t.y-i.y;this.z=t.z-i.z;this.w=t.w-i.w;return this};e.toString=function e(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"};return t}();ue.ZERO=Object.freeze(new ue(0,0,0,0)),ue.ONE=Object.freeze(new ue(1,1,1,1));var fe=new he,de=new ce,pe=new ce,me=new ce,_e=new ce,ve=function(){function a(){var e=new Float32Array(16);e[0]=e[5]=e[10]=e[15]=1;this.data=e}a._getPerspectiveHalfSize=function e(t,i,n,r,s){if(s){t.x=r*Math.tan(i*Math.PI/360);t.y=t.x/n}else{t.y=r*Math.tan(i*Math.PI/360);t.x=t.y*n}};var e=a.prototype;e.add2=function e(t,i){var n=t.data,r=i.data,s=this.data;s[0]=n[0]+r[0];s[1]=n[1]+r[1];s[2]=n[2]+r[2];s[3]=n[3]+r[3];s[4]=n[4]+r[4];s[5]=n[5]+r[5];s[6]=n[6]+r[6];s[7]=n[7]+r[7];s[8]=n[8]+r[8];s[9]=n[9]+r[9];s[10]=n[10]+r[10];s[11]=n[11]+r[11];s[12]=n[12]+r[12];s[13]=n[13]+r[13];s[14]=n[14]+r[14];s[15]=n[15]+r[15];return this};e.add=function e(t){return this.add2(this,t)};e.clone=function e(){return(new a).copy(this)};e.copy=function e(t){var i=t.data,n=this.data;n[0]=i[0];n[1]=i[1];n[2]=i[2];n[3]=i[3];n[4]=i[4];n[5]=i[5];n[6]=i[6];n[7]=i[7];n[8]=i[8];n[9]=i[9];n[10]=i[10];n[11]=i[11];n[12]=i[12];n[13]=i[13];n[14]=i[14];n[15]=i[15];return this};e.equals=function e(t){var i=this.data,n=t.data;return i[0]===n[0]&&i[1]===n[1]&&i[2]===n[2]&&i[3]===n[3]&&i[4]===n[4]&&i[5]===n[5]&&i[6]===n[6]&&i[7]===n[7]&&i[8]===n[8]&&i[9]===n[9]&&i[10]===n[10]&&i[11]===n[11]&&i[12]===n[12]&&i[13]===n[13]&&i[14]===n[14]&&i[15]===n[15]};e.isIdentity=function e(){var t=this.data;return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1};e.mul2=function e(t,i){var n,r,s,a,o,l,h,c,u,f,d,p,m,_,v,g,y,b,x,S,w=t.data,T=i.data,M=this.data;n=w[0];r=w[1];s=w[2];a=w[3];o=w[4];l=w[5];h=w[6];c=w[7];u=w[8];f=w[9];d=w[10];p=w[11];m=w[12];_=w[13];v=w[14];g=w[15];y=T[0];b=T[1];x=T[2];S=T[3];M[0]=n*y+o*b+u*x+m*S;M[1]=r*y+l*b+f*x+_*S;M[2]=s*y+h*b+d*x+v*S;M[3]=a*y+c*b+p*x+g*S;y=T[4];b=T[5];x=T[6];S=T[7];M[4]=n*y+o*b+u*x+m*S;M[5]=r*y+l*b+f*x+_*S;M[6]=s*y+h*b+d*x+v*S;M[7]=a*y+c*b+p*x+g*S;y=T[8];b=T[9];x=T[10];S=T[11];M[8]=n*y+o*b+u*x+m*S;M[9]=r*y+l*b+f*x+_*S;M[10]=s*y+h*b+d*x+v*S;M[11]=a*y+c*b+p*x+g*S;y=T[12];b=T[13];x=T[14];S=T[15];M[12]=n*y+o*b+u*x+m*S;M[13]=r*y+l*b+f*x+_*S;M[14]=s*y+h*b+d*x+v*S;M[15]=a*y+c*b+p*x+g*S;return this};e.mulAffine2=function e(t,i){var n,r,s,a,o,l,h,c,u,f,d,p,m,_,v,g=t.data,y=i.data,b=this.data;n=g[0];r=g[1];s=g[2];a=g[4];o=g[5];l=g[6];h=g[8];c=g[9];u=g[10];f=g[12];d=g[13];p=g[14];m=y[0];_=y[1];v=y[2];b[0]=n*m+a*_+h*v;b[1]=r*m+o*_+c*v;b[2]=s*m+l*_+u*v;b[3]=0;m=y[4];_=y[5];v=y[6];b[4]=n*m+a*_+h*v;b[5]=r*m+o*_+c*v;b[6]=s*m+l*_+u*v;b[7]=0;m=y[8];_=y[9];v=y[10];b[8]=n*m+a*_+h*v;b[9]=r*m+o*_+c*v;b[10]=s*m+l*_+u*v;b[11]=0;m=y[12];_=y[13];v=y[14];b[12]=n*m+a*_+h*v+f;b[13]=r*m+o*_+c*v+d;b[14]=s*m+l*_+u*v+p;b[15]=1;return this};e.mul=function e(t){return this.mul2(this,t)};e.transformPoint=function e(t,i){if(i===void 0)i=new ce;var n,r,s,a;a=this.data;n=t.x;r=t.y;s=t.z;i.x=n*a[0]+r*a[4]+s*a[8]+a[12];i.y=n*a[1]+r*a[5]+s*a[9]+a[13];i.z=n*a[2]+r*a[6]+s*a[10]+a[14];return i};e.transformVector=function e(t,i){if(i===void 0)i=new ce;var n,r,s,a;a=this.data;n=t.x;r=t.y;s=t.z;i.x=n*a[0]+r*a[4]+s*a[8];i.y=n*a[1]+r*a[5]+s*a[9];i.z=n*a[2]+r*a[6]+s*a[10];return i};e.transformVec4=function e(t,i){if(i===void 0)i=new ue;var n,r,s,a,o;o=this.data;n=t.x;r=t.y;s=t.z;a=t.w;i.x=n*o[0]+r*o[4]+s*o[8]+a*o[12];i.y=n*o[1]+r*o[5]+s*o[9]+a*o[13];i.z=n*o[2]+r*o[6]+s*o[10]+a*o[14];i.w=n*o[3]+r*o[7]+s*o[11]+a*o[15];return i};e.setLookAt=function e(t,i,n){me.sub2(t,i).normalize();pe.copy(n).normalize();de.cross(pe,me).normalize();pe.cross(me,de);var r=this.data;r[0]=de.x;r[1]=de.y;r[2]=de.z;r[3]=0;r[4]=pe.x;r[5]=pe.y;r[6]=pe.z;r[7]=0;r[8]=me.x;r[9]=me.y;r[10]=me.z;r[11]=0;r[12]=t.x;r[13]=t.y;r[14]=t.z;r[15]=1;return this};e.setFrustum=function e(t,i,n,r,s,a){var o,l,h,c,u;o=2*s;l=i-t;h=r-n;c=a-s;u=this.data;u[0]=o/l;u[1]=0;u[2]=0;u[3]=0;u[4]=0;u[5]=o/h;u[6]=0;u[7]=0;u[8]=(i+t)/l;u[9]=(r+n)/h;u[10]=(-a-s)/c;u[11]=-1;u[12]=0;u[13]=0;u[14]=-o*a/c;u[15]=0;return this};e.setPerspective=function e(t,i,n,r,s){a._getPerspectiveHalfSize(fe,t,i,n,s);return this.setFrustum(-fe.x,fe.x,-fe.y,fe.y,n,r)};e.setOrtho=function e(t,i,n,r,s,a){var o=this.data;o[0]=2/(i-t);o[1]=0;o[2]=0;o[3]=0;o[4]=0;o[5]=2/(r-n);o[6]=0;o[7]=0;o[8]=0;o[9]=0;o[10]=-2/(a-s);o[11]=0;o[12]=-(i+t)/(i-t);o[13]=-(r+n)/(r-n);o[14]=-(a+s)/(a-s);o[15]=1;return this};e.setFromAxisAngle=function e(t,i){var n,r,s,a,o,l,h,c,u;i*=Pe.DEG_TO_RAD;n=t.x;r=t.y;s=t.z;a=Math.cos(i);o=Math.sin(i);l=1-a;h=l*n;c=l*r;u=this.data;u[0]=h*n+a;u[1]=h*r+o*s;u[2]=h*s-o*r;u[3]=0;u[4]=h*r-o*s;u[5]=c*r+a;u[6]=c*s+o*n;u[7]=0;u[8]=h*s+o*r;u[9]=c*s-n*o;u[10]=l*s*s+a;u[11]=0;u[12]=0;u[13]=0;u[14]=0;u[15]=1;return this};e.setTranslate=function e(t,i,n){var r=this.data;r[0]=1;r[1]=0;r[2]=0;r[3]=0;r[4]=0;r[5]=1;r[6]=0;r[7]=0;r[8]=0;r[9]=0;r[10]=1;r[11]=0;r[12]=t;r[13]=i;r[14]=n;r[15]=1;return this};e.setScale=function e(t,i,n){var r=this.data;r[0]=t;r[1]=0;r[2]=0;r[3]=0;r[4]=0;r[5]=i;r[6]=0;r[7]=0;r[8]=0;r[9]=0;r[10]=n;r[11]=0;r[12]=0;r[13]=0;r[14]=0;r[15]=1;return this};e.invert=function e(){var t,i,n,r,s,a,o,l,h,c,u,f,d,p,m,_,v,g,y,b,x,S,w,T,M,C,A,P,E,I,R;R=this.data;t=R[0];i=R[1];n=R[2];r=R[3];s=R[4];a=R[5];o=R[6];l=R[7];h=R[8];c=R[9];u=R[10];f=R[11];d=R[12];p=R[13];m=R[14];_=R[15];v=t*a-i*s;g=t*o-n*s;y=t*l-r*s;b=i*o-n*a;x=i*l-r*a;S=n*l-r*o;w=h*p-c*d;T=h*m-u*d;M=h*_-f*d;C=c*m-u*p;A=c*_-f*p;P=u*_-f*m;E=v*P-g*A+y*C+b*M-x*T+S*w;if(E===0)this.setIdentity();else{I=1/E;R[0]=(a*P-o*A+l*C)*I;R[1]=(-i*P+n*A-r*C)*I;R[2]=(p*S-m*x+_*b)*I;R[3]=(-c*S+u*x-f*b)*I;R[4]=(-s*P+o*M-l*T)*I;R[5]=(t*P-n*M+r*T)*I;R[6]=(-d*S+m*y-_*g)*I;R[7]=(h*S-u*y+f*g)*I;R[8]=(s*A-a*M+l*w)*I;R[9]=(-t*A+i*M-r*w)*I;R[10]=(d*x-p*y+_*v)*I;R[11]=(-h*x+c*y-f*v)*I;R[12]=(-s*C+a*T-o*w)*I;R[13]=(t*C-i*T+n*w)*I;R[14]=(-d*b+p*g-m*v)*I;R[15]=(h*b-c*g+u*v)*I}return this};e.set=function e(t){var i=this.data;i[0]=t[0];i[1]=t[1];i[2]=t[2];i[3]=t[3];i[4]=t[4];i[5]=t[5];i[6]=t[6];i[7]=t[7];i[8]=t[8];i[9]=t[9];i[10]=t[10];i[11]=t[11];i[12]=t[12];i[13]=t[13];i[14]=t[14];i[15]=t[15];return this};e.setIdentity=function e(){var t=this.data;t[0]=1;t[1]=0;t[2]=0;t[3]=0;t[4]=0;t[5]=1;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=0;t[13]=0;t[14]=0;t[15]=1;return this};e.setTRS=function e(t,i,n){var r,s,a,o,l,h,c,u,f,d,p,m,_,v,g,y,b,x,S,w;r=i.x;s=i.y;a=i.z;o=i.w;l=n.x;h=n.y;c=n.z;u=r+r;f=s+s;d=a+a;p=r*u;m=r*f;_=r*d;v=s*f;g=s*d;y=a*d;b=o*u;x=o*f;S=o*d;w=this.data;w[0]=(1-(v+y))*l;w[1]=(m+S)*l;w[2]=(_-x)*l;w[3]=0;w[4]=(m-S)*h;w[5]=(1-(p+y))*h;w[6]=(g+b)*h;w[7]=0;w[8]=(_+x)*c;w[9]=(g-b)*c;w[10]=(1-(p+v))*c;w[11]=0;w[12]=t.x;w[13]=t.y;w[14]=t.z;w[15]=1;return this};e.transpose=function e(){var t,i=this.data;t=i[1];i[1]=i[4];i[4]=t;t=i[2];i[2]=i[8];i[8]=t;t=i[3];i[3]=i[12];i[12]=t;t=i[6];i[6]=i[9];i[9]=t;t=i[7];i[7]=i[13];i[13]=t;t=i[11];i[11]=i[14];i[14]=t;return this};e.invertTo3x3=function e(t){var i,n,r,s,a,o,l,h,c,u,f,d,p;u=this.data;f=t.data;var m=u[0];var _=u[1];var v=u[2];var g=u[4];var y=u[5];var b=u[6];var x=u[8];var S=u[9];var w=u[10];i=w*y-b*S;n=-w*_+v*S;r=b*_-v*y;s=-w*g+b*x;a=w*m-v*x;o=-b*m+v*g;l=S*g-y*x;h=-S*m+_*x;c=y*m-_*g;d=m*i+_*s+v*l;if(d===0)return this;p=1/d;f[0]=p*i;f[1]=p*n;f[2]=p*r;f[3]=p*s;f[4]=p*a;f[5]=p*o;f[6]=p*l;f[7]=p*h;f[8]=p*c;return this};e.getTranslation=function e(t){if(t===void 0)t=new ce;return t.set(this.data[12],this.data[13],this.data[14])};e.getX=function e(t){if(t===void 0)t=new ce;return t.set(this.data[0],this.data[1],this.data[2])};e.getY=function e(t){if(t===void 0)t=new ce;return t.set(this.data[4],this.data[5],this.data[6])};e.getZ=function e(t){if(t===void 0)t=new ce;return t.set(this.data[8],this.data[9],this.data[10])};e.getScale=function e(t){if(t===void 0)t=new ce;this.getX(de);this.getY(pe);this.getZ(me);t.set(de.length(),pe.length(),me.length());return t};e.setFromEulerAngles=function e(t,i,n){var r,s,a,o,l,h,c;t*=Pe.DEG_TO_RAD;i*=Pe.DEG_TO_RAD;n*=Pe.DEG_TO_RAD;r=Math.sin(-t);s=Math.cos(-t);a=Math.sin(-i);o=Math.cos(-i);l=Math.sin(-n);h=Math.cos(-n);c=this.data;c[0]=o*h;c[1]=-o*l;c[2]=a;c[3]=0;c[4]=s*l+h*r*a;c[5]=s*h-r*a*l;c[6]=-o*r;c[7]=0;c[8]=r*l-s*h*a;c[9]=h*r+s*a*l;c[10]=s*o;c[11]=0;c[12]=0;c[13]=0;c[14]=0;c[15]=1;return this};e.getEulerAngles=function e(t){if(t===void 0)t=new ce;var i,n,r,s,a,o,l,h;this.getScale(_e);s=_e.x;a=_e.y;o=_e.z;l=this.data;n=Math.asin(-l[2]/s);h=Math.PI*.5;if(n<h)if(n>-h){i=Math.atan2(l[6]/a,l[10]/o);r=Math.atan2(l[1]/s,l[0]/s)}else{r=0;i=-Math.atan2(l[4]/a,l[5]/a)}else{r=0;i=Math.atan2(l[4]/a,l[5]/a)}return t.set(i,n,r).scale(Pe.RAD_TO_DEG)};e.toString=function e(){var t,i;i="[";for(t=0;t<16;t+=1){i+=this.data[t];i+=t!==15?", ":""}i+="]";return i};return a}();ve.IDENTITY=Object.freeze(new ve),ve.ZERO=Object.freeze((new ve).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]));var be=function(){function t(e,t,i,n){if(e===void 0)e=0;if(t===void 0)t=0;if(i===void 0)i=0;if(n===void 0)n=1;if(e.length===4){this.x=e[0];this.y=e[1];this.z=e[2];this.w=e[3]}else{this.x=e;this.y=t;this.z=i;this.w=n}}var e=t.prototype;e.clone=function e(){return new t(this.x,this.y,this.z,this.w)};e.conjugate=function e(){this.x*=-1;this.y*=-1;this.z*=-1;return this};e.copy=function e(t){this.x=t.x;this.y=t.y;this.z=t.z;this.w=t.w;return this};e.equals=function e(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w};e.getAxisAngle=function e(t){var i=Math.acos(this.w)*2;var n=Math.sin(i/2);if(n!==0){t.x=this.x/n;t.y=this.y/n;t.z=this.z/n;if(t.x<0||t.y<0||t.z<0){t.x*=-1;t.y*=-1;t.z*=-1;i*=-1}}else{t.x=1;t.y=0;t.z=0}return i*Pe.RAD_TO_DEG};e.getEulerAngles=function e(t){if(t===void 0)t=new ce;var i,n,r,s,a,o,l,h;s=this.x;a=this.y;o=this.z;l=this.w;h=2*(l*a-s*o);if(h<=-.99999){i=2*Math.atan2(s,l);n=-Math.PI/2;r=0}else if(h>=.99999){i=2*Math.atan2(s,l);n=Math.PI/2;r=0}else{i=Math.atan2(2*(l*s+a*o),1-2*(s*s+a*a));n=Math.asin(h);r=Math.atan2(2*(l*o+s*a),1-2*(a*a+o*o))}return t.set(i,n,r).scale(Pe.RAD_TO_DEG)};e.invert=function e(){return this.conjugate().normalize()};e.length=function e(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};e.lengthSq=function e(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w};e.mul=function e(t){var i,n,r,s,a,o,l,h;i=this.x;n=this.y;r=this.z;s=this.w;a=t.x;o=t.y;l=t.z;h=t.w;this.x=s*a+i*h+n*l-r*o;this.y=s*o+n*h+r*a-i*l;this.z=s*l+r*h+i*o-n*a;this.w=s*h-i*a-n*o-r*l;return this};e.mul2=function e(t,i){var n,r,s,a,o,l,h,c;n=t.x;r=t.y;s=t.z;a=t.w;o=i.x;l=i.y;h=i.z;c=i.w;this.x=a*o+n*c+r*h-s*l;this.y=a*l+r*c+s*o-n*h;this.z=a*h+s*c+n*l-r*o;this.w=a*c-n*o-r*l-s*h;return this};e.normalize=function e(){var t=this.length();if(t===0){this.x=this.y=this.z=0;this.w=1}else{t=1/t;this.x*=t;this.y*=t;this.z*=t;this.w*=t}return this};e.set=function e(t,i,n,r){this.x=t;this.y=i;this.z=n;this.w=r;return this};e.setFromAxisAngle=function e(t,i){var n,r;i*=.5*Pe.DEG_TO_RAD;n=Math.sin(i);r=Math.cos(i);this.x=n*t.x;this.y=n*t.y;this.z=n*t.z;this.w=r;return this};e.setFromEulerAngles=function e(t,i,n){var r,s,a,o,l,h,c;c=.5*Pe.DEG_TO_RAD;t*=c;i*=c;n*=c;r=Math.sin(t);s=Math.cos(t);a=Math.sin(i);o=Math.cos(i);l=Math.sin(n);h=Math.cos(n);this.x=r*o*h-s*a*l;this.y=s*a*h+r*o*l;this.z=s*o*l-r*a*h;this.w=s*o*h+r*a*l;return this};e.setFromMat4=function e(t){var i,n,r,s,a,o,l,h,c,u,f,d,p,m,_;t=t.data;i=t[0];n=t[1];r=t[2];s=t[4];a=t[5];o=t[6];l=t[8];h=t[9];c=t[10];p=i*i+n*n+r*r;if(p===0)return this;p=1/Math.sqrt(p);m=s*s+a*a+o*o;if(m===0)return this;m=1/Math.sqrt(m);_=l*l+h*h+c*c;if(_===0)return this;_=1/Math.sqrt(_);i*=p;n*=p;r*=p;s*=m;a*=m;o*=m;l*=_;h*=_;c*=_;u=i+a+c;if(u>=0){f=Math.sqrt(u+1);this.w=f*.5;f=.5/f;this.x=(o-h)*f;this.y=(l-r)*f;this.z=(n-s)*f}else if(i>a)if(i>c){d=i-(a+c)+1;d=Math.sqrt(d);this.x=d*.5;d=.5/d;this.w=(o-h)*d;this.y=(n+s)*d;this.z=(r+l)*d}else{d=c-(i+a)+1;d=Math.sqrt(d);this.z=d*.5;d=.5/d;this.w=(n-s)*d;this.x=(l+r)*d;this.y=(h+o)*d}else if(a>c){d=a-(c+i)+1;d=Math.sqrt(d);this.y=d*.5;d=.5/d;this.w=(l-r)*d;this.z=(o+h)*d;this.x=(s+n)*d}else{d=c-(i+a)+1;d=Math.sqrt(d);this.z=d*.5;d=.5/d;this.w=(n-s)*d;this.x=(l+r)*d;this.y=(h+o)*d}return this};e.slerp=function e(t,i,n){var r,s,a,o,l,h,c,u;r=t.x;s=t.y;a=t.z;o=t.w;l=i.x;h=i.y;c=i.z;u=i.w;var f=o*u+r*l+s*h+a*c;if(f<0){u=-u;l=-l;h=-h;c=-c;f=-f}if(Math.abs(f)>=1){this.w=o;this.x=r;this.y=s;this.z=a;return this}var d=Math.acos(f);var p=Math.sqrt(1-f*f);if(Math.abs(p)<.001){this.w=o*.5+u*.5;this.x=r*.5+l*.5;this.y=s*.5+h*.5;this.z=a*.5+c*.5;return this}var m=Math.sin((1-n)*d)/p;var _=Math.sin(n*d)/p;this.w=o*m+u*_;this.x=r*m+l*_;this.y=s*m+h*_;this.z=a*m+c*_;return this};e.transformVector=function e(t,i){if(i===void 0)i=new ce;var n=t.x,r=t.y,s=t.z;var a=this.x,o=this.y,l=this.z,h=this.w;var c=h*n+o*s-l*r;var u=h*r+l*n-a*s;var f=h*s+a*r-o*n;var d=-a*n-o*r-l*s;i.x=c*h+d*-a+u*-l-f*-o;i.y=u*h+d*-o+f*-a-c*-l;i.z=f*h+d*-l+c*-o-u*-a;return i};e.toString=function e(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"};return t}();be.IDENTITY=Object.freeze(new be(0,0,0,1)),be.ZERO=Object.freeze(new be(0,0,0,0));var xe=new ce,Se=new ce,we=new ce,Te=new ce,Me=new ce,Ce=function(){function t(e,t){if(e===void 0)e=new ce;if(t===void 0)t=new ce(.5,.5,.5);this.center=e;this.halfExtents=t;this._min=new ce;this._max=new ce}var e=t.prototype;e.add=function e(t){var i=this.center;var n=i.x;var r=i.y;var s=i.z;var a=this.halfExtents;var o=a.x;var l=a.y;var h=a.z;var c=n-o;var u=n+o;var f=r-l;var d=r+l;var p=s-h;var m=s+h;var _=t.center;var v=_.x;var g=_.y;var y=_.z;var b=t.halfExtents;var x=b.x;var S=b.y;var w=b.z;var T=v-x;var M=v+x;var C=g-S;var A=g+S;var P=y-w;var E=y+w;if(T<c)c=T;if(M>u)u=M;if(C<f)f=C;if(A>d)d=A;if(P<p)p=P;if(E>m)m=E;i.x=(c+u)*.5;i.y=(f+d)*.5;i.z=(p+m)*.5;a.x=(u-c)*.5;a.y=(d-f)*.5;a.z=(m-p)*.5};e.copy=function e(t){this.center.copy(t.center);this.halfExtents.copy(t.halfExtents)};e.clone=function e(){return new t(this.center.clone(),this.halfExtents.clone())};e.intersects=function e(t){var i=this.getMax();var n=this.getMin();var r=t.getMax();var s=t.getMin();return n.x<=r.x&&i.x>=s.x&&n.y<=r.y&&i.y>=s.y&&n.z<=r.z&&i.z>=s.z};e._intersectsRay=function e(t,i){var n=xe.copy(this.getMin()).sub(t.origin);var r=Se.copy(this.getMax()).sub(t.origin);var s=t.direction;if(s.x===0){n.x=n.x<0?-Number.MAX_VALUE:Number.MAX_VALUE;r.x=r.x<0?-Number.MAX_VALUE:Number.MAX_VALUE}else{n.x/=s.x;r.x/=s.x}if(s.y===0){n.y=n.y<0?-Number.MAX_VALUE:Number.MAX_VALUE;r.y=r.y<0?-Number.MAX_VALUE:Number.MAX_VALUE}else{n.y/=s.y;r.y/=s.y}if(s.z===0){n.z=n.z<0?-Number.MAX_VALUE:Number.MAX_VALUE;r.z=r.z<0?-Number.MAX_VALUE:Number.MAX_VALUE}else{n.z/=s.z;r.z/=s.z}var a=we.set(Math.min(n.x,r.x),Math.min(n.y,r.y),Math.min(n.z,r.z));var o=Te.set(Math.max(n.x,r.x),Math.max(n.y,r.y),Math.max(n.z,r.z));var l=Math.min(Math.min(o.x,o.y),o.z);var h=Math.max(Math.max(a.x,a.y),a.z);var c=l>=h&&h>=0;if(c)i.copy(t.direction).scale(h).add(t.origin);return c};e._fastIntersectsRay=function e(t){var i=xe;var n=Se;var r=we;var s=Te;var a=Me;var o=t.direction;i.sub2(t.origin,this.center);s.set(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z));r.mul2(i,o);if(s.x>this.halfExtents.x&&r.x>=0)return false;if(s.y>this.halfExtents.y&&r.y>=0)return false;if(s.z>this.halfExtents.z&&r.z>=0)return false;a.set(Math.abs(o.x),Math.abs(o.y),Math.abs(o.z));n.cross(o,i);n.set(Math.abs(n.x),Math.abs(n.y),Math.abs(n.z));if(n.x>this.halfExtents.y*a.z+this.halfExtents.z*a.y)return false;if(n.y>this.halfExtents.x*a.z+this.halfExtents.z*a.x)return false;if(n.z>this.halfExtents.x*a.y+this.halfExtents.y*a.x)return false;return true};e.intersectsRay=function e(t,i){if(i)return this._intersectsRay(t,i);return this._fastIntersectsRay(t)};e.setMinMax=function e(t,i){this.center.add2(i,t).scale(.5);this.halfExtents.sub2(i,t).scale(.5)};e.getMin=function e(){return this._min.copy(this.center).sub(this.halfExtents)};e.getMax=function e(){return this._max.copy(this.center).add(this.halfExtents)};e.containsPoint=function e(t){var i=this.getMin();var n=this.getMax();if(t.x<i.x||t.x>n.x||t.y<i.y||t.y>n.y||t.z<i.z||t.z>n.z)return false;return true};e.setFromTransformedAabb=function e(t,i){var n=t.center;var r=t.halfExtents;var s=i.data;var a=s[0];var o=s[4];var l=s[8];var h=s[1];var c=s[5];var u=s[9];var f=s[2];var d=s[6];var p=s[10];this.center.set(s[12]+a*n.x+o*n.y+l*n.z,s[13]+h*n.x+c*n.y+u*n.z,s[14]+f*n.x+d*n.y+p*n.z);this.halfExtents.set(Math.abs(a)*r.x+Math.abs(o)*r.y+Math.abs(l)*r.z,Math.abs(h)*r.x+Math.abs(c)*r.y+Math.abs(u)*r.z,Math.abs(f)*r.x+Math.abs(d)*r.y+Math.abs(p)*r.z)};e.compute=function e(t,i){i=i===undefined?t.length/3:i;if(i>0){var n=xe.set(t[0],t[1],t[2]);var r=Se.set(t[0],t[1],t[2]);for(var s=1;s<i;s++){var a=t[s*3+0];var o=t[s*3+1];var l=t[s*3+2];if(a<n.x)n.x=a;if(o<n.y)n.y=o;if(l<n.z)n.z=l;if(a>r.x)r.x=a;if(o>r.y)r.y=o;if(l>r.z)r.z=l}this.setMinMax(n,r)}};e.intersectsBoundingSphere=function e(t){var i=this._distanceToBoundingSphereSq(t);if(i<=t.radius*t.radius)return true;return false};e._distanceToBoundingSphereSq=function e(t){var i=this.getMin();var n=this.getMax();var r=0;var s=["x","y","z"];for(var a=0;a<3;++a){var o=0;var l=t.center[s[a]];var h=i[s[a]];var c=n[s[a]];var u=0;if(l<h){u=h-l;o+=u*u}if(l>c){u=l-c;o+=u*u}r+=o}return r};e._expand=function e(t,i){xe.add2(this.getMin(),t);Se.add2(this.getMax(),i);this.setMinMax(xe,Se)};return t}(),Ee=new ce,Ie=new ce,Re=new ce,Le=new ce,De=function(){function e(e,t){if(e===void 0)e=new ce;if(t===void 0)t=.5;this.center=e;this.radius=t}var t=e.prototype;t.containsPoint=function e(t){var i=Ee.sub2(t,this.center).lengthSq();var n=this.radius;return i<n*n};t.compute=function e(t){var i;var n=t.length/3;var r=Ee;var s=Ie;var a=Re;for(i=0;i<n;i++){r.set(t[i*3],t[i*3+1],t[i*3+2]);a.addSelf(r);if(i%100===0){a.scale(1/n);s.add(a);a.set(0,0,0)}}a.scale(1/n);s.add(a);this.center.copy(s);var o=0;var l=Le;for(i=0;i<n;i++){r.set(t[i*3],t[i*3+1],t[i*3+2]);l.sub2(r,this.center);o=Math.max(l.lengthSq(),o)}this.radius=Math.sqrt(o)};t.intersectsRay=function e(t,i){var n=Ee.copy(t.origin).sub(this.center);var r=n.dot(Ie.copy(t.direction).normalize());var s=n.dot(n)-this.radius*this.radius;if(s>0&&r>0)return null;var a=r*r-s;if(a<0)return false;var o=Math.abs(-r-Math.sqrt(a));if(i)i.copy(t.direction).scale(o).add(t.origin);return true};t.intersectsBoundingSphere=function e(t){Ee.sub2(t.center,this.center);var i=t.radius+this.radius;if(Ee.lengthSq()<=i*i)return true;return false};return e}(),ke=function(){function e(){this.planes=[];for(var e=0;e<6;e++)this.planes[e]=[]}var t=e.prototype;t.setFromMat4=function e(t){var i=t.data;var n;var r=this.planes;n=r[0];n[0]=i[3]-i[0];n[1]=i[7]-i[4];n[2]=i[11]-i[8];n[3]=i[15]-i[12];var s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s;n=r[1];n[0]=i[3]+i[0];n[1]=i[7]+i[4];n[2]=i[11]+i[8];n[3]=i[15]+i[12];s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s;n=r[2];n[0]=i[3]+i[1];n[1]=i[7]+i[5];n[2]=i[11]+i[9];n[3]=i[15]+i[13];s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s;n=r[3];n[0]=i[3]-i[1];n[1]=i[7]-i[5];n[2]=i[11]-i[9];n[3]=i[15]-i[13];s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s;n=r[4];n[0]=i[3]-i[2];n[1]=i[7]-i[6];n[2]=i[11]-i[10];n[3]=i[15]-i[14];s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s;n=r[5];n[0]=i[3]+i[2];n[1]=i[7]+i[6];n[2]=i[11]+i[10];n[3]=i[15]+i[14];s=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);n[0]/=s;n[1]/=s;n[2]/=s;n[3]/=s};t.containsPoint=function e(t){var i,n;for(i=0;i<6;i++){n=this.planes[i];if(n[0]*t.x+n[1]*t.y+n[2]*t.z+n[3]<=0)return false}return true};t.containsSphere=function e(t){var i=0;var n;var r;var s=t.radius;var a=t.center;var o=a.x;var l=a.y;var h=a.z;var c=this.planes;var u;for(r=0;r<6;r++){u=c[r];n=u[0]*o+u[1]*l+u[2]*h+u[3];if(n<=-s)return 0;if(n>s)i++}return i===6?2:1};return e}(),Oe=function(){function e(e,t){if(e===void 0)e=new ce;if(t===void 0)t=new ce(0,0,-1);this.origin=e;this.direction=t}var t=e.prototype;t.set=function e(t,i){this.origin.copy(t);this.direction.copy(i);return this};return e}(),Fe=new Oe,Be=new ce,Ne=new De,ze=new ve,Ve=function(){function e(e,t){if(e===void 0)e=new ve;if(t===void 0)t=new ce(.5,.5,.5);this.halfExtents=t;this._modelTransform=e.clone().invert();this._worldTransform=e.clone();this._aabb=new Ce(new ce,this.halfExtents)}var t=e.prototype;t.intersectsRay=function e(t,i){this._modelTransform.transformPoint(t.origin,Fe.origin);this._modelTransform.transformVector(t.direction,Fe.direction);if(i){var n=this._aabb._intersectsRay(Fe,i);ze.copy(this._modelTransform).invert().transformPoint(i,i);return n}return this._aabb._fastIntersectsRay(Fe)};t.containsPoint=function e(t){this._modelTransform.transformPoint(t,Be);return this._aabb.containsPoint(Be)};t.intersectsBoundingSphere=function e(t){this._modelTransform.transformPoint(t.center,Ne.center);Ne.radius=t.radius;if(this._aabb.intersectsBoundingSphere(Ne))return true;return false};U(e,[{key:"worldTransform",get:function e(){return this._worldTransform},set:function e(t){this._worldTransform.copy(t);this._modelTransform.copy(t).invert()}}]);return e}(),Ue=new ce,Ge=function(){function e(e,t){if(e===void 0)e=new ce;if(t===void 0)t=new ce(0,0,1);this.normal=t;this.point=e}var t=e.prototype;t.intersectsLine=function e(t,i,n){var r=-this.normal.dot(this.point);var s=this.normal.dot(t)+r;var a=this.normal.dot(i)+r;var o=s/(s-a);var l=o>=0&&o<=1;if(l&&n)n.lerp(t,i,o);return l};t.intersectsRay=function e(t,i){var n=Ue.sub2(this.point,t.origin);var r=this.normal.dot(n)/this.normal.dot(t.direction);var s=r>=0;if(s&&i)i.copy(t.direction).scale(r).add(t.origin);return s};return e}(),He=0,We=1,je=2,Xe=0,qe=1,Ye=2,Ke=3,Qe=4,$e=5,Ze=6,Je=7,et=8,tt=9,it=10,nt=0,rt=1,st=2,at=3,ot=4,lt=0,ht=1,ct=2,ut=3,ft=1,dt=2,pt=4,mt=0,_t=1,vt=2,gt=3,yt=4,bt=5,xt=0,St=1,wt=2,Tt=3,Mt=0,Ct=1,At=2,Pt=3,Et=4,It=5,Rt=0,Lt=1,Dt=2,kt=3,Ot=4,Ft=5,Bt=6,Nt=7,zt=0,Vt=1,Ut=2,Gt=0,Ht=1,Wt=2,jt=3,Xt=4,qt=5,Yt=6,Kt=7,Qt=8,$t=9,Zt=10,Jt=11,ei=12,ti=13,ii=14,ni=15,ri=16,si=17,ai=18,oi=19,li=20,hi=21,ci=22,ui=23,fi=24,di=25,pi=26,mi=27,_i=28,vi=29,gi=30,yi=0,bi=1,xi=2,Si=3,wi=4,Ti=5,Mi=6,Ci="POSITION",Ai="NORMAL",Pi="TANGENT",Ei="BLENDWEIGHT",Ii="BLENDINDICES",Ri="COLOR",Li="TEXCOORD",Di="TEXCOORD0",ki="TEXCOORD1",Oi="TEXCOORD2",Fi="TEXCOORD3",Bi="TEXCOORD4",Ni="TEXCOORD5",zi="TEXCOORD6",Vi="TEXCOORD7",Ui="ATTR",Gi="ATTR0",Hi="ATTR1",Wi="ATTR2",ji="ATTR3",Xi="ATTR4",qi="ATTR5",Yi="ATTR6",Ki="ATTR7",Qi="ATTR8",$i="ATTR9",Zi="ATTR10",Ji="ATTR11",en="ATTR12",tn="ATTR13",nn="ATTR14",rn="ATTR15",sn=1,an=0,on=1,ln=2,hn=3,cn=4,un=5,fn=6,dn=7,pn=1,mn=2,_n="default",vn="rgbm",gn="rgbe",yn="swizzleGGGR",bn=0,xn=1,Sn=2,wn=3,Tn=0,Mn=1,Cn=2,An=3,Pn=4,En=5,In=6,Rn=0,Ln=1,Dn=2,kn=3,On=4,Fn=5,Bn=6,Nn=7,zn=8,Vn=9,Un=10,Gn=11,Hn=12,Wn=13,jn=14,Xn=15,qn=16,Yn=17,Kn=18,Qn=19,$n=20,Zn=21,Jn=22,er=23,tr=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],ir=[1,1,2,2,4,4,4],nr={Int8Array:Tn,Uint8Array:Mn,Int16Array:Cn,Uint16Array:An,Int32Array:Pn,Uint32Array:En,Float32Array:In},rr=[Uint8Array,Uint16Array,Uint32Array],sr=[1,2,4],ar={};ar[Ci]=0,ar[Ai]=1,ar[Ei]=2,ar[Ii]=3,ar[Ri]=4,ar[Di]=5,ar[ki]=6,ar[Oi]=7,ar[Fi]=8,ar[Bi]=9,ar[Ni]=10,ar[zi]=11,ar[Vi]=12,ar[Pi]=13,ar[Gi]=0,ar[Hi]=1,ar[Wi]=2,ar[ji]=3,ar[Xi]=4,ar[qi]=5,ar[Yi]=6,ar[Ki]=7,ar[Qi]=8,ar[$i]=9,ar[Zi]=10,ar[Ji]=11,ar[en]=12,ar[tn]=13,ar[nn]=14,ar[rn]=15;var or=0,lr=function(){function e(e,t,i,n,r){if(n===void 0)n=lt;this.device=e;this.format=t;this.numVertices=i;this.usage=n;this.id=or++;this._vao=null;this.numBytes=t.verticesByteSize?t.verticesByteSize:t.size*i;e._vram.vb+=this.numBytes;if(r)this.setData(r);else this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)}var t=e.prototype;t.destroy=function e(){var t=this.device;var i=t.buffers.indexOf(this);if(i!==-1)t.buffers.splice(i,1);if(this.bufferId){var n=t.gl;t.boundVao=null;n.bindVertexArray(null);n.deleteBuffer(this.bufferId);t._vram.vb-=this.storage.byteLength;this.bufferId=null}};t.loseContext=function e(){this.bufferId=undefined;this._vao=null};t.getFormat=function e(){return this.format};t.getUsage=function e(){return this.usage};t.getNumVertices=function e(){return this.numVertices};t.lock=function e(){return this.storage};t.unlock=function e(){var t=this.device.gl;if(!this.bufferId)this.bufferId=t.createBuffer();var i;switch(this.usage){case lt:i=t.STATIC_DRAW;break;case ht:i=t.DYNAMIC_DRAW;break;case ct:i=t.STREAM_DRAW;break;case ut:if(this.device.webgl2)i=t.DYNAMIC_COPY;else i=t.STATIC_DRAW;break}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId);t.bufferData(t.ARRAY_BUFFER,this.storage,i)};t.setData=function e(t){if(t.byteLength!==this.numBytes){console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength);return false}this.storage=t;this.unlock();return true};return e}();function hr(e){var t=0;for(var i=0,n=e.length;i<n;i++){t=(t<<5)-t+e.charCodeAt(i);t|=0}return t}var cr=function(){function n(e,t,i){var n,r,s;this.elements=[];this.hasUv0=false;this.hasUv1=false;this.hasColor=false;this.hasTangents=false;this.verticesByteSize=0;this.vertexCount=i;this.interleaved=i===undefined;this.size=t.reduce(function(e,t){return e+Math.ceil(t.components*ir[t.type]/4)*4},0);var a=0,o;for(n=0,r=t.length;n<r;n++){var l=t[n];o=l.components*ir[l.type];if(i)a=Pe.roundUp(a,o);s={name:l.semantic,offset:i?a:l.hasOwnProperty("offset")?l.offset:a,stride:i?o:l.hasOwnProperty("stride")?l.stride:this.size,dataType:l.type,numComponents:l.components,normalize:l.normalize===undefined?false:l.normalize,size:o};this.elements.push(s);if(i)a+=o*i;else a+=Math.ceil(o/4)*4;if(l.semantic===Di)this.hasUv0=true;else if(l.semantic===ki)this.hasUv1=true;else if(l.semantic===Ri)this.hasColor=true;else if(l.semantic===Pi)this.hasTangents=true}if(i)this.verticesByteSize=a;this.update()}n.init=function e(t){var i=[{semantic:Oi,components:4,type:In},{semantic:Fi,components:4,type:In},{semantic:Bi,components:4,type:In},{semantic:Ni,components:4,type:In}];n._defaultInstancingFormat=new n(t,i)};var e=n.prototype;e.update=function e(){this._evaluateHash()};e._evaluateHash=function e(){var t,i=[];var n,r=[];var s,a=this.elements.length,o;for(s=0;s<a;s++){o=this.elements[s];t=o.name;t+=o.dataType;t+=o.numComponents;t+=o.normalize;i.push(t);n=t;n+=o.offset;n+=o.stride;n+=o.size;r.push(n)}i.sort();this.batchingHash=hr(i.join());this.renderingingHash=hr(r.join())};U(n,null,[{key:"defaultInstancingFormat",get:function e(){return n._defaultInstancingFormat}}]);return n}();function ur(e){this.array[this.index]=e}function fr(e,t){this.array[this.index]=e;this.array[this.index+1]=t}function dr(e,t,i){this.array[this.index]=e;this.array[this.index+1]=t;this.array[this.index+2]=i}function pr(e,t,i,n){this.array[this.index]=e;this.array[this.index+1]=t;this.array[this.index+2]=i;this.array[this.index+3]=n}function mr(e,t,i){this.array[e]=t[i]}function _r(e,t,i){this.array[e]=t[i];this.array[e+1]=t[i+1]}function vr(e,t,i){this.array[e]=t[i];this.array[e+1]=t[i+1];this.array[e+2]=t[i+2]}function gr(e,t,i){this.array[e]=t[i];this.array[e+1]=t[i+1];this.array[e+2]=t[i+2];this.array[e+3]=t[i+3]}function yr(e,t,i){t[i]=this.array[e]}function br(e,t,i){t[i]=this.array[e];t[i+1]=this.array[e+1]}function xr(e,t,i){t[i]=this.array[e];t[i+1]=this.array[e+1];t[i+2]=this.array[e+2]}function Sr(e,t,i){t[i]=this.array[e];t[i+1]=this.array[e+1];t[i+2]=this.array[e+2];t[i+3]=this.array[e+3]}cr._defaultInstancingFormat=null;var wr=function(){function e(e,t,i){this.index=0;this.numComponents=t.numComponents;if(i.interleaved)this.array=new tr[t.dataType](e,t.offset);else this.array=new tr[t.dataType](e,t.offset,i.vertexCount*t.numComponents);this.stride=t.stride/this.array.constructor.BYTES_PER_ELEMENT;switch(t.numComponents){case 1:this.set=ur;this.getToArray=yr;this.setFromArray=mr;break;case 2:this.set=fr;this.getToArray=br;this.setFromArray=_r;break;case 3:this.set=dr;this.getToArray=xr;this.setFromArray=vr;break;case 4:this.set=pr;this.getToArray=Sr;this.setFromArray=gr;break}}var t=e.prototype;t.get=function e(t){return this.array[this.index+t]};t.set=function e(t,i,n,r){};t.getToArray=function e(t,i,n){};t.setFromArray=function e(t,i,n){};return e}(),Tr=function(){function e(e){this.vertexBuffer=e;this.vertexFormatSize=e.getFormat().size;this.buffer=this.vertexBuffer.lock();this.accessors=[];this.element={};var t=this.vertexBuffer.getFormat();for(var i=0;i<t.elements.length;i++){var n=t.elements[i];this.accessors[i]=new wr(this.buffer,n,t);this.element[n.name]=this.accessors[i]}}var t=e.prototype;t.next=function e(t){if(t===void 0)t=1;var i=0;var n=this.accessors;var r=this.accessors.length;while(i<r){var s=n[i++];s.index+=t*s.stride}};t.end=function e(){this.vertexBuffer.unlock()};t.writeData=function e(t,i,n){var r=this.element[t];if(r){if(n>this.vertexBuffer.numVertices)n=this.vertexBuffer.numVertices;var s,a=r.numComponents;if(this.vertexBuffer.getFormat().interleaved){var o=0;for(s=0;s<n;s++){r.setFromArray(o,i,s*a);o+=r.stride}}else if(i.length>n*a){var l=n*a;if(ArrayBuffer.isView(i)){i=i.subarray(0,l);r.array.set(i)}else for(s=0;s<l;s++)r.array[s]=i[s]}else r.array.set(i)}};t.readData=function e(t,i){var n=this.element[t];var r=0;if(n){r=this.vertexBuffer.numVertices;var s,a=n.numComponents;if(this.vertexBuffer.getFormat().interleaved){if(Array.isArray(i))i.length=0;n.index=0;var o=0;for(s=0;s<r;s++){n.getToArray(o,i,s*a);o+=n.stride}}else if(ArrayBuffer.isView(i))i.set(n.array);else{i.length=0;var l=r*a;for(s=0;s<l;s++)i[s]=n.array[s]}}return r};return e}(),Mr=null,Cr={type:Ti,base:0,count:4,indexed:false};function Ar(e,t,i,n,r,s){if(s===void 0)s=false;if(Mr===null){var a=new cr(e,[{semantic:Ci,components:2,type:In}]);Mr=new lr(e,a,4);var o=new Tr(Mr);o.element[Ci].set(-1,-1);o.next();o.element[Ci].set(1,-1);o.next();o.element[Ci].set(-1,1);o.next();o.element[Ci].set(1,1);o.end()}var l=e.renderTarget;e.setRenderTarget(t);e.updateBegin();var h,c,u,f;var d,p,m,_;if(!n){u=t?t.width:e.width;f=t?t.height:e.height;h=0;c=0}else{h=n.x;c=n.y;u=n.z;f=n.w}if(!r){d=h;p=c;m=u;_=f}else{d=r.x;p=r.y;m=r.z;_=r.w}var v=e.vx;var g=e.vy;var y=e.vw;var b=e.vh;e.setViewport(h,c,u,f);var x=e.sx;var S=e.sy;var w=e.sw;var T=e.sh;e.setScissor(d,p,m,_);var M=e.getDepthTest();var C=e.getDepthWrite();var A=e.getCullMode();var P=e.writeRed;var E=e.writeGreen;var I=e.writeBlue;var R=e.writeAlpha;e.setDepthTest(false);e.setDepthWrite(false);e.setCullMode(xt);e.setColorWrite(true,true,true,true);if(!s)e.setBlending(false);e.setVertexBuffer(Mr,0);e.setShader(i);e.draw(Cr);e.setDepthTest(M);e.setDepthWrite(C);e.setCullMode(A);e.setColorWrite(P,E,I,R);e.updateEnd();e.setRenderTarget(l);e.updateBegin();e.setViewport(v,g,y,b);e.setScissor(x,S,w,T)}function Pr(){if(Mr){Mr.destroy();Mr=null}}function Er(e,t,i,n,r,s,a){if(a===void 0)a=false;n=n||e.getCopyShader();e.constantTexSource.setValue(t);Ar(e,i,n,r,s,a)}var Ir=function(){function e(e,t){this.device=e;this.definition=t;this.init();this.device.createShader(this)}var t=e.prototype;t.init=function e(){this.attributes=[];this.uniforms=[];this.samplers=[];this.ready=false;this.failed=false};t.destroy=function e(){this.device.destroyShader(this)};t.loseContext=function e(){this.init()};return e}(),Rr,Lr,Dr,kr,Or,Fr,Br,Nr,zr,Vr,Ur,Gr,Hr,Wr,jr,Xr,qr,Yr,Kr,Qr,$r,Zr,Jr,es,ts,is,ns,rs,ss,as,os,ls,hs,cs,us,fs,ds,ps,ms,_s,vs,gs,ys,bs,xs,Ss,ws,Ts,Ms,Cs,As,Ps,Es,Is,Rs,Ls,Ds,ks,Os,Fs,Bs,Ns,zs,Vs,Us,Gs,Hs,Ws,js,Xs,qs,Ys,Ks,Qs,$s,Zs,Js,ea,ta,ia,na,ra,sa,aa,oa,la,ha,ca,ua,fa,da,pa,ma,_a,va,ga,ya,ba,xa,Sa,wa,Ta,Ma,Ca,Aa,Pa,Ea,Ia,Ra,La,Da,ka,Oa,Fa,Ba,Na,za,Va,Ua,Ga,Ha,Wa,ja,Xa,qa,Ya,Ka,Qa,$a,Za,Ja,eo,to,io,no,ro,so,ao,oo,lo,ho,co,uo,fo,po,mo,_o,vo,go,yo,bo,xo,So,wo,To,Mo,Co,Ao,Po,Eo,Io,Ro,Lo,Do,ko,Oo,Fo,Bo,No,zo,Vo,Uo,Go,Ho,Wo,jo,Xo,qo,Yo,Ko,Qo,$o,Zo,Jo,el,tl,il,nl,rl,sl,al,ol,ll,hl,cl,ul={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(cubeMapRotate(dNormalW), 1.0 - 1.0 / 4.0);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = cubeMapRotate(dNormalW);\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tnrdir = cubeMapRotate(nrdir);\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn cubeMapRotate(dir);\n}\n",cubeMapRotatePS:"#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvec3 cubeMapRotate(vec3 refDir) {\n#ifdef CUBEMAP_ROTATION\n\treturn refDir * cubeMapRotationMatrix;\n#else\n\treturn refDir;\n#endif\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffWindow(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat invRadius = 1.0 / lightRadius;\n\treturn square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n}\nfloat getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\treturn vec3(0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 calcSeam(vec3 vec) {\n\tvec3 avec = abs(vec);\n\tfloat M = max(avec.x, max(avec.y, avec.z));\n\treturn vec3(avec.x != M ? 1.0 : 0.0,\n\t\t\t\tavec.y != M ? 1.0 : 0.0,\n\t\t\t\tavec.z != M ? 1.0 : 0.0);\n}\nvec3 applySeam(vec3 vec, vec3 seam, float scale) {\n\treturn vec * (seam * -scale + vec3(1.0));\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec3 dir = texture2D(texture_dirLightMap, $UV).xyz;\n\tif (dot(dir, vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t} else {\n\t\tdLightDirNormW = normalize(dir * 2.0 - vec3(1.0));\n\t\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\t\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\t\tfloat nlight = (flight / max(vlight, 0.01)) * 0.5;\n\t\tdDiffuseLight += color * nlight * 2.0;\n\t}\n\tdSpecularLight += color * getLightSpecular();\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",ltc:"\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nstruct Coords {\n\tvec3 coord0;\n\tvec3 coord1;\n\tvec3 coord2;\n\tvec3 coord3;\n};\nfloat LTC_EvaluateRect( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in Coords rectCoords) {\n\tvec3 v1 = rectCoords.coord1 - rectCoords.coord0;\n\tvec3 v2 = rectCoords.coord3 - rectCoords.coord0;\n\tvec3 lightNormal = cross( v1, v2 );\n\tfloat factor = sign(-dot( lightNormal, P - rectCoords.coord0 ));\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 =  factor * cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords.coord0 - P );\n\tcoords[ 1 ] = mat * ( rectCoords.coord1 - P );\n\tcoords[ 2 ] = mat * ( rectCoords.coord2 - P );\n\tcoords[ 3 ] = mat * ( rectCoords.coord3 - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn result;\n}\nCoords dLTCCoords;\nCoords getLTCLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tcoords.coord0 = lightPos + halfWidth - halfHeight;\n\tcoords.coord1 = lightPos - halfWidth - halfHeight;\n\tcoords.coord2 = lightPos - halfWidth + halfHeight;\n\tcoords.coord3 = lightPos + halfWidth + halfHeight;\n\treturn coords;\n}\nfloat dSphereRadius;\nCoords getSphereLightCoords(vec3 lightPos, vec3 halfWidth, vec3 halfHeight){\n\tCoords coords;\n\tfloat radius = max(length(halfWidth), length(halfWidth));\n\tdSphereRadius = radius;\n\tvec3 f = normalize(lightPos-view_position);\n\tvec3 w = normalize(cross(f, halfHeight));\n\tvec3 h = normalize(cross(f, w));\n\tcoords.coord0 = lightPos + w * radius - h * radius;\n\tcoords.coord1 = lightPos - w * radius - h * radius;\n\tcoords.coord2 = lightPos - w * radius + h * radius;\n\tcoords.coord3 = lightPos + w * radius + h * radius;\n\treturn coords;\n}\nvec2 dLTCUV;\n#ifdef CLEARCOAT\nvec2 ccLTCUV;\n#endif\nvec2 getLTCLightUV(float tGlossiness, vec3 tNormalW)\n{\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\treturn LTC_Uv( tNormalW, dViewDirW, roughness );\n}\nvec3 dLTCSpecFres;\n#ifdef CLEARCOAT\nvec3 ccLTCSpecFres;\n#endif\nvec3 getLTCLightSpecFres(vec2 uv, vec3 tSpecularity)\n{\n\tvec4 t2 = texture2D( areaLightsLutTex2, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt2 *= vec4(0.693103,1,1,1);\n\tt2 += vec4(0.306897,0,0,0);\n\t#endif\n\treturn tSpecularity * t2.x + ( vec3( 1.0 ) - tSpecularity) * t2.y;\n}\nvoid calcLTCLightValues()\n{\n\tdLTCUV = getLTCLightUV(dGlossiness, dNormalW);\n\tdLTCSpecFres = getLTCLightSpecFres(dLTCUV, dSpecularityNoFres);\n#ifdef CLEARCOAT\n\tccLTCUV = getLTCLightUV(ccGlossiness, ccNormalW);\n\tccLTCSpecFres = getLTCLightSpecFres(ccLTCUV, ccSpecularityNoFres);\n#endif\n}\nvoid calcRectLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getLTCLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvoid calcDiskLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tcalcRectLightValues(lightPos, halfWidth, halfHeight);\n}\nvoid calcSphereLightValues(vec3 lightPos, vec3 halfWidth, vec3 halfHeight)\n{\n\tdLTCCoords = getSphereLightCoords(lightPos, halfWidth, halfHeight);\n\tcalcLTCLightValues();\n}\nvec3 SolveCubic(vec4 Coefficient)\n{\n\tfloat pi = 3.14159;\n\tCoefficient.xyz /= Coefficient.w;\n\tCoefficient.yz /= 3.0;\n\tfloat A = Coefficient.w;\n\tfloat B = Coefficient.z;\n\tfloat C = Coefficient.y;\n\tfloat D = Coefficient.x;\n\tvec3 Delta = vec3(\n\t\t-Coefficient.z * Coefficient.z + Coefficient.y,\n\t\t-Coefficient.y * Coefficient.z + Coefficient.x,\n\t\tdot(vec2(Coefficient.z, -Coefficient.y), Coefficient.xy)\n\t);\n\tfloat Discriminant = dot(vec2(4.0 * Delta.x, -Delta.y), Delta.zy);\n\tvec3 RootsA, RootsD;\n\tvec2 xlc, xsc;\n\t{\n\t\tfloat A_a = 1.0;\n\t\tfloat C_a = Delta.x;\n\t\tfloat D_a = -2.0 * B * Delta.x + Delta.y;\n\t\tfloat Theta = atan(sqrt(Discriminant), -D_a) / 3.0;\n\t\tfloat x_1a = 2.0 * sqrt(-C_a) * cos(Theta);\n\t\tfloat x_3a = 2.0 * sqrt(-C_a) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xl;\n\t\tif ((x_1a + x_3a) > 2.0 * B)\n\t\t\txl = x_1a;\n\t\telse\n\t\t\txl = x_3a;\n\t\txlc = vec2(xl - B, A);\n\t}\n\t{\n\t\tfloat A_d = D;\n\t\tfloat C_d = Delta.z;\n\t\tfloat D_d = -D * Delta.y + 2.0 * C * Delta.z;\n\t\tfloat Theta = atan(D * sqrt(Discriminant), -D_d) / 3.0;\n\t\tfloat x_1d = 2.0 * sqrt(-C_d) * cos(Theta);\n\t\tfloat x_3d = 2.0 * sqrt(-C_d) * cos(Theta + (2.0 / 3.0) * pi);\n\t\tfloat xs;\n\t\tif (x_1d + x_3d < 2.0 * C)\n\t\t\txs = x_1d;\n\t\telse\n\t\t\txs = x_3d;\n\t\txsc = vec2(-D, xs + C);\n\t}\n\tfloat E =  xlc.y * xsc.y;\n\tfloat F = -xlc.x * xsc.y - xlc.y * xsc.x;\n\tfloat G =  xlc.x * xsc.x;\n\tvec2 xmc = vec2(C * F - B * G, -B * F + C * E);\n\tvec3 Root = vec3(xsc.x / xsc.y, xmc.x / xmc.y, xlc.x / xlc.y);\n\tif (Root.x < Root.y && Root.x < Root.z)\n\t\tRoot.xyz = Root.yxz;\n\telse if (Root.z < Root.x && Root.z < Root.y)\n\t\tRoot.xyz = Root.xzy;\n\treturn Root;\n}\nfloat LTC_EvaluateDisk(vec3 N, vec3 V, vec3 P, mat3 Minv, Coords points)\n{\n\tvec3 T1, T2;\n\tT1 = normalize(V - N * dot(V, N));\n\tT2 = cross(N, T1);\n\tmat3 R = transposeMat3( mat3( T1, T2, N ) );\n\tvec3 L_[ 3 ];\n\tL_[ 0 ] = R * ( points.coord0 - P );\n\tL_[ 1 ] = R * ( points.coord1 - P );\n\tL_[ 2 ] = R * ( points.coord2 - P );\n\tvec3 Lo_i = vec3(0);\n\tvec3 C  = 0.5 * (L_[0] + L_[2]);\n\tvec3 V1 = 0.5 * (L_[1] - L_[2]);\n\tvec3 V2 = 0.5 * (L_[1] - L_[0]);\n\tC  = Minv * C;\n\tV1 = Minv * V1;\n\tV2 = Minv * V2;\n\tfloat a, b;\n\tfloat d11 = dot(V1, V1);\n\tfloat d22 = dot(V2, V2);\n\tfloat d12 = dot(V1, V2);\n\tif (abs(d12) / sqrt(d11 * d22) > 0.0001)\n\t{\n\t\tfloat tr = d11 + d22;\n\t\tfloat det = -d12 * d12 + d11 * d22;\n\t\tdet = sqrt(det);\n\t\tfloat u = 0.5 * sqrt(tr - 2.0 * det);\n\t\tfloat v = 0.5 * sqrt(tr + 2.0 * det);\n\t\tfloat e_max = (u + v) * (u + v);\n\t\tfloat e_min = (u - v) * (u - v);\n\t\tvec3 V1_, V2_;\n\t\tif (d11 > d22)\n\t\t{\n\t\t\tV1_ = d12 * V1 + (e_max - d11) * V2;\n\t\t\tV2_ = d12 * V1 + (e_min - d11) * V2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tV1_ = d12*V2 + (e_max - d22)*V1;\n\t\t\tV2_ = d12*V2 + (e_min - d22)*V1;\n\t\t}\n\t\ta = 1.0 / e_max;\n\t\tb = 1.0 / e_min;\n\t\tV1 = normalize(V1_);\n\t\tV2 = normalize(V2_);\n\t}\n\telse\n\t{\n\t\ta = 1.0 / dot(V1, V1);\n\t\tb = 1.0 / dot(V2, V2);\n\t\tV1 *= sqrt(a);\n\t\tV2 *= sqrt(b);\n\t}\n\tvec3 V3 = cross(V1, V2);\n\tif (dot(C, V3) < 0.0)\n\t\tV3 *= -1.0;\n\tfloat L  = dot(V3, C);\n\tfloat x0 = dot(V1, C) / L;\n\tfloat y0 = dot(V2, C) / L;\n\tfloat E1 = inversesqrt(a);\n\tfloat E2 = inversesqrt(b);\n\ta *= L * L;\n\tb *= L * L;\n\tfloat c0 = a * b;\n\tfloat c1 = a * b * (1.0 + x0 * x0 + y0 * y0) - a - b;\n\tfloat c2 = 1.0 - a * (1.0 + x0 * x0) - b * (1.0 + y0 * y0);\n\tfloat c3 = 1.0;\n\tvec3 roots = SolveCubic(vec4(c0, c1, c2, c3));\n\tfloat e1 = roots.x;\n\tfloat e2 = roots.y;\n\tfloat e3 = roots.z;\n\tvec3 avgDir = vec3(a * x0 / (a - e2), b * y0 / (b - e2), 1.0);\n\tmat3 rotate = mat3(V1, V2, V3);\n\tavgDir = rotate * avgDir;\n\tavgDir = normalize(avgDir);\n\tfloat L1 = sqrt(-e2 / e3);\n\tfloat L2 = sqrt(-e2 / e1);\n\tfloat formFactor = L1 * L2 * inversesqrt((1.0 + L1 * L1) * (1.0 + L2 * L2));\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tvec2 uv = vec2(avgDir.z * 0.5 + 0.5, formFactor);\n\tuv = uv*LUT_SCALE + LUT_BIAS;\n\tfloat scale = texture2D( areaLightsLutTex2, uv ).w;\n\treturn formFactor*scale;\n}\nfloat getRectLightDiffuse() {\n\treturn LTC_EvaluateRect( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getDiskLightDiffuse() {\n\treturn LTC_EvaluateDisk( dNormalW, dViewDirW, vPositionW, mat3( 1.0 ), dLTCCoords );\n}\nfloat getSphereLightDiffuse() {\n\tfloat falloff = dSphereRadius / (dot(dLightDirW, dLightDirW) + dSphereRadius);\n\treturn getLightDiffuse()*falloff;\n}\nmat3 getLTCLightInvMat(vec2 uv)\n{\n\tvec4 t1 = texture2D( areaLightsLutTex1, uv );\n\t#ifdef AREA_R8_G8_B8_A8_LUTS\n\tt1 *= vec4(1.001, 0.3239, 0.60437568, 1.0);\n\tt1 += vec4(0.0, -0.2976, -0.01381, 0.0);\n\t#endif\n\treturn mat3(\n\t\tvec3( t1.x, 0, t1.y ),\n\t\tvec3(\t0, 1,\t0 ),\n\t\tvec3( t1.z, 0, t1.w )\n\t);\n}\nfloat calcRectLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateRect( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getRectLightSpecular() {\n\treturn calcRectLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getRectLightSpecularCC() {\n\treturn calcRectLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat calcDiskLightSpecular(vec3 tNormalW, vec2 uv) {\n\tmat3 mInv = getLTCLightInvMat(uv);\n\treturn LTC_EvaluateDisk( tNormalW, dViewDirW, vPositionW, mInv, dLTCCoords );\n}\nfloat getDiskLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getDiskLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\nfloat getSphereLightSpecular() {\n\treturn calcDiskLightSpecular(dNormalW, dLTCUV);\n}\n#ifdef CLEARCOAT\nfloat getSphereLightSpecularCC() {\n\treturn calcDiskLightSpecular(ccNormalW, ccLTCUV);\n}\n#endif\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n#ifndef RIGHT_HANDED_CUBEMAP\n\tlookupVec.x *= -1.0;\n#endif\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 refl = cubeMapProject(tReflDirW);\n#ifndef RIGHT_HANDED_CUBEMAP\n\trefl.x *= -1.0;\n#endif\n\tvec3 seam = calcSeam(refl);\n\tvec4 c0 = textureCube(texture_prefilteredCubeMap128, applySeam(refl, seam, 1.0 / 128.0));\n\tvec4 c1 = textureCube(texture_prefilteredCubeMap64, applySeam(refl, seam, 2.0 / 128.0));\n\tvec4 c2 = textureCube(texture_prefilteredCubeMap32, applySeam(refl, seam, 4.0 / 128.0));\n\tvec4 c3 = textureCube(texture_prefilteredCubeMap16, applySeam(refl, seam, 8.0 / 128.0));\n\tvec4 c4 = textureCube(texture_prefilteredCubeMap8, applySeam(refl, seam, 16.0 / 128.0));\n\tvec4 c5 = textureCube(texture_prefilteredCubeMap4, applySeam(refl, seam, 32.0 / 128.0));\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec4 cubes0;\n\tvec4 cubes1;\n\tif (bias < 1.0) {\n\t\tcubes0 = c0;\n\t\tcubes1 = c1;\n\t} else if (bias < 2.0) {\n\t\tcubes0 = c1;\n\t\tcubes1 = c2;\n\t} else if (bias < 3.0) {\n\t\tcubes0 = c2;\n\t\tcubes1 = c3;\n\t} else if (bias < 4.0) {\n\t\tcubes0 = c3;\n\t\tcubes1 = c4;\n\t} else {\n\t\tcubes0 = c4;\n\t\tcubes1 = c5;\n\t}\n\tvec4 cubeFinal = mix(cubes0, cubes1, fract(bias));\n\treturn processEnvironment($DECODE(cubeFinal).rgb);\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n#ifndef RIGHT_HANDED_CUBEMAP\n\tfixedReflDir.x *= -1.0;\n#endif\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform vec4 params;\nfloat targetFace() { return params.x; }\nfloat specularPower() { return params.y; }\nfloat sourceCubeSeamScale() { return params.z; }\nfloat targetCubeSeamScale() { return params.w; }\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec3 modifySeams(vec3 dir, float amount) {\n\tif (amount != 1.0) {\n\t\tvec3 adir = abs(dir);\n\t\tfloat M = max(max(adir.x, adir.y), adir.z);\n\t\tif (adir.x == M) {\n\t\t\tdir.y *= amount;\n\t\t\tdir.z *= amount;\n\t\t}\n\t\telse if (adir.y == M) {\n\t\t\tdir.x *= amount;\n\t\t\tdir.z *= amount;\n\t\t} else {\n\t\t\tdir.x *= amount;\n\t\t\tdir.y *= amount;\n\t\t}\n\t}\n\treturn dir;\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x) * -1.0, asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(-uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(-uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\treturn texture2D(sourceTex, sph / vec2(PI * 2.0, PI) + 0.5);\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, modifySeams(dir, sourceCubeSeamScale()));\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vUv0 * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = targetFace();\n\tvec3 vec;\n\tif (face == 0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face == 1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face == 2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face == 3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face == 4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(modifySeams(vec, 1.0 / targetCubeSeamScale()));\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nmat3 matrixFromVectorSlow(vec3 n) {\n\tvec3 a = normalize(cross(n, vec3(0, 1, 0)));\n\tvec3 b = cross(n, a);\n\treturn mat3(a, b, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float num = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u=0.0; u<num; ++u) {\n\t\t\tfor (float v=0.0; v<num; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / num - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / num - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (num * num));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVectorSlow(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, specularPower());\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = PROCESS_FUNC();\n}\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n\tvec3 lightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(lightDirW);\n\tdLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z += shadowParams.z;\n\tdShadowCoord.xyz /= vMainShadowUv.w;\n\tdShadowCoord.z = min(dShadowCoord.z, 1.0);\n\treturn $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n#ifdef CUBEMAP_ROTATION\nuniform mat3 cubeMapRotationMatrix;\n#endif\nvoid main(void) {\n#ifdef CUBEMAP_ROTATION\n\tvec3 dir=vViewDir * cubeMapRotationMatrix;\n#else\n\tvec3 dir=vViewDir;\n#endif\n#ifndef RIGHT_HANDED_CUBEMAP\n\tdir.x *= -1.0;\n#endif\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(dir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"},fl=0,dl=1,pl=2,ml=3,_l=4,vl=5,gl=6,yl=7,bl=8,xl=9,Sl=10,wl="none",Tl="linear",Ml="exp",Cl="exp2",Al=0,Pl=2,El=0,Il=1,Rl=2,Ll=15,Dl=0,kl=1,Ol=2,Fl=3,Bl=4,Nl=0,zl=1,Vl=zl,Ul=2,Gl=0,Hl=1,Wl=2,jl=3,Xl=0,ql=1,Yl=0,Kl=0,Ql=1,$l=2,Zl=3,Jl=4,eh=0,th=1,ih=0,nh=1,rh=2,sh=3,ah=0,oh=1,lh=0,hh=1,ch=0,uh=1,fh=2,dh=0,ph=1,mh=0,_h=1,vh=2,gh=0,yh=1,bh=0,xh=1,Sh="mul",wh="add",Th="screen",Mh="overlay",Ch="min",Ah="max",Ph=0,Eh=1,Ih=2,Rh=3,Lh=0,Dh=1,kh=2,Oh=3,Fh=4,Bh=0,Nh=1,zh=2,Vh=1,Uh=2,Gh=4,Hh=8,Wh=16,jh=32,Xh=64,qh=128,Yh=256,Kh=512,Qh=1024,$h=2048,Zh=4096,Jh=0,ec=1,tc=2,ic=0,nc=1,rc=2,sc=0,ac=1,oc=1,lc=2,hc=4,cc=0,uc=1,fc=2,dc=3,mc=18,_c=0,vc=1,gc=2,yc=0,bc=1,xc=0,Sc=1,wc=2,Tc=0,Mc=1,Cc=2,Ac=3,Pc=4,Ec=5,Ic=1,Rc=2,Lc=4,Dc=8,kc=0,Oc=1,Fc=0,Bc=1;function Nc(e,t){if(!t)t=ul;if(e===Eh||e===Ih)return t.gamma2_2PS?t.gamma2_2PS:ul.gamma2_2PS;else if(e===Rh)return"#define HDR\n"+(t.gamma2_2PS?t.gamma2_2PS:ul.gamma2_2PS);return t.gamma1_0PS?t.gamma1_0PS:ul.gamma1_0PS}function zc(e,t){if(!t)t=ul;if(e===Dh)return t.tonemappingFilmicPS?t.tonemappingFilmicPS:ul.tonemappingFilmicPS;else if(e===Lh)return t.tonemappingLinearPS?t.tonemappingLinearPS:ul.tonemappingLinearPS;else if(e===kh)return t.tonemappingHejlPS?t.tonemappingHejlPS:ul.tonemappingHejlPS;else if(e===Oh)return t.tonemappingAcesPS?t.tonemappingAcesPS:ul.tonemappingAcesPS;else if(e===Fh)return t.tonemappingAces2PS?t.tonemappingAces2PS:ul.tonemappingAces2PS;return t.tonemapingNonePS?t.tonemapingNonePS:ul.tonemappingNonePS}function Vc(e,t){if(!t)t=ul;if(e==="linear")return t.fogLinearPS?t.fogLinearPS:ul.fogLinearPS;else if(e==="exp")return t.fogExpPS?t.fogExpPS:ul.fogExpPS;else if(e==="exp2")return t.fogExp2PS?t.fogExp2PS:ul.fogExp2PS;return t.fogNonePS?t.fogNonePS:ul.fogNonePS}function Uc(e,t){if(!t)t=ul;if(e.supportsBoneTextures)return t.skinTexVS;return"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+t.skinConstVS}function Gc(e){var t="precision "+e.precision+" float;\n";if(e.webgl2)t+="#ifdef GL2\nprecision "+e.precision+" sampler2DShadow;\n#endif\n";return t}function Hc(e){return e.webgl2?"#version 300 es\n":""}function Wc(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function jc(){return"void main(void)\n{\n"}function Xc(){return"}\n"}var qc={vertex_position:Ci,vertex_normal:Ai,vertex_tangent:Pi,vertex_texCoord0:Di,vertex_texCoord1:ki,vertex_texCoord2:Oi,vertex_texCoord3:Fi,vertex_texCoord4:Bi,vertex_texCoord5:Ni,vertex_texCoord6:zi,vertex_texCoord7:Vi,vertex_color:Ri,vertex_boneIndices:Ii,vertex_boneWeights:Ei};function Yc(e){var t={};var i=0;var n=e.indexOf("attribute");while(n>=0){if(n>0&&e[n-1]==="/")break;var r=e.indexOf(";",n);var s=e.lastIndexOf(" ",r);var a=e.substr(s+1,r-(s+1));var o=qc[a];if(o!==undefined)t[a]=o;else{t[a]="ATTR"+i;i++}n=e.indexOf("attribute",n+1)}return t}function Kc(e,t,i,n){var r=ul[t];var s=Gc(e)+"\n"+ul[i];var a=Yc(r);if(e.webgl2){r=Hc(e)+ul.gles3VS+r;s=Hc(e)+ul.gles3PS+s}return new Ir(e,{attributes:a,vshader:r,fshader:s,useTransformFeedback:n})}function Qc(e,t,i,n,r,s){var a=e.programLib._cache;var o=a[n];if(o!==undefined)return o;i=Gc(e)+"\n"+(i||Wc());var l=Yc(t);if(e.webgl2){t=Hc(e)+ul.gles3VS+t;i=Hc(e)+ul.gles3PS+i}a[n]=new Ir(e,{attributes:l,vshader:t,fshader:(s?s:"")+i,useTransformFeedback:r});return a[n]}ul.collectAttribs=Yc,ul.createShader=Kc,ul.createShaderFromCode=Qc;var $c,Zc,Jc,eu=function e(t,i,n){return"\n#ifdef MAPFLOAT\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},tu=function e(t,i,n){return"\n#ifdef MAPCOLOR\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},iu=function e(t,i,n){return"\n#ifdef MAPTEXTURE\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},nu=function e(t,i,n){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n"+"#ifdef MAPTEXTURECOLOR\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},ru=function e(t,i,n){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n"+"#ifdef MAPTEXTUREFLOAT\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},su=function e(t,i,n){return"\n#ifdef MAPVERTEX\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},au=function e(t,i,n){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n"+"#ifdef MAPVERTEXCOLOR\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},ou=function e(t,i,n){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n"+"#ifdef MAPVERTEXFLOAT\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"},lu,hu,cu,uu,fu,du,pu,mu=[],_u={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:iu},aoVertPS:{n:"aoPS",f:su},diffuseConstPS:{n:"diffusePS",f:tu},diffuseTexPS:{n:"diffusePS",f:iu},diffuseTexConstPS:{n:"diffusePS",f:nu},diffuseVertPS:{n:"diffusePS",f:su},diffuseVertConstPS:{n:"diffusePS",f:au},emissiveConstPS:{n:"emissivePS",f:tu},emissiveTexPS:{n:"emissivePS",f:iu},emissiveTexConstPS:{n:"emissivePS",f:nu},emissiveTexConstFloatPS:{n:"emissivePS",f:ru},emissiveVertPS:{n:"emissivePS",f:su},emissiveVertConstPS:{n:"emissivePS",f:au},emissiveVertConstFloatPS:{n:"emissivePS",f:ou},glossConstPS:{n:"glossPS",f:eu},glossTexPS:{n:"glossPS",f:iu},glossTexConstPS:{n:"glossPS",f:ru},glossVertPS:{n:"glossPS",f:su},glossVertConstPS:{n:"glossPS",f:ou},metalnessConstPS:{n:"metalnessPS",f:eu},metalnessTexPS:{n:"metalnessPS",f:iu},metalnessTexConstPS:{n:"metalnessPS",f:ru},metalnessVertPS:{n:"metalnessPS",f:su},metalnessVertConstPS:{n:"metalnessPS",f:ou},opacityConstPS:{n:"opacityPS",f:eu},opacityTexPS:{n:"opacityPS",f:iu},opacityTexConstPS:{n:"opacityPS",f:ru},opacityVertPS:{n:"opacityPS",f:su},opacityVertConstPS:{n:"opacityPS",f:ou},specularConstPS:{n:"specularPS",f:tu},specularTexPS:{n:"specularPS",f:iu},specularTexConstPS:{n:"specularPS",f:nu},specularVertPS:{n:"specularPS",f:su},specularVertConstPS:{n:"specularPS",f:au},transformBatchSkinnedVS:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef DYNAMICBATCH\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef INSTANCING\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef PIXELSNAP\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef SCREENSPACE\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function e(t,i,n){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n"+"#ifdef SCREENSPACEBATCH\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef SKIN\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function e(t,i,n){return"\n#ifdef UV1LAYOUT\n"+t+"\n#else\n"+ul[i]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function e(t){var i=function e(t){var i=[];for(var n in t)if(t.hasOwnProperty(n)&&n!=="chunks"&&n!=="lights")i.push(n);return i.sort()};var n;if(t===this.optionsContextMin){if(!this.propsMin)this.propsMin=i(t);n=this.propsMin}else if(t===this.optionsContext){if(!this.props)this.props=i(t);n=this.props}else n=i(t);var r="standard";var s;for(s=0;s<n.length;s++)if(t[n[s]])r+=n[s]+t[n[s]];if(t.chunks){var a=[];for(var o in t.chunks)if(t.chunks.hasOwnProperty(o))a.push(o+t.chunks[o]);a.sort();r+=a}if(t.lights)for(s=0;s<t.lights.length;s++)r+=t.lights[s].key;return hr(r)},_correctChannel:function e(t,i){if(mu[t]>0){if(mu[t]<i.length)return i.substring(0,mu[t]);else if(mu[t]>i.length){var n=i;var r=n.charAt(n.length-1);var s=mu[t]-n.length;for(var a=0;a<s;a++)n+=r;return n}return i}},_setMapTransform:function e(t,i,n,r){t[0]+="uniform vec4 texture_"+i+"MapTransform;\n";var s=n+r*100;if(!t[3][s]){t[1]+="varying vec2 vUV"+r+"_"+n+";\n";t[2]+="\t vUV"+r+"_"+n+" = uv"+r+" * texture_"+i+"MapTransform.xy + texture_"+i+"MapTransform.zw;\n";t[3][s]=true}return t},_getUvSourceExpression:function e(t,i,n){var r=n[t];var s=n[i];var a;var o=n.pass===cc||n.pass===uc;if(o&&n.nineSlicedMode===vc)a="nineSlicedUv";else if(o&&n.nineSlicedMode===gc)a="nineSlicedUv, -1000.0";else{if(r===0)a="vUv"+s;else a="vUV"+s+"_"+r;if(n.heightMap&&t!=="heightMapTransform")a+=" + dUvOffset"}return a},_addMapDef:function e(t,i){var n="\n#undef "+t+"\n";if(i)n+=" #define "+t+"\n";return n},_addMapDefs:function e(t,i,n,r){var s="";s+=this._addMapDef("MAPFLOAT",t);s+=this._addMapDef("MAPCOLOR",i);s+=this._addMapDef("MAPVERTEX",n);s+=this._addMapDef("MAPTEXTURE",r);return s},_addMap:function e(t,i,n,r,s){var a=t+"Map";var o=a+"Uv";var l=a+"Transform";var h=a+"Channel";var c=t+"VertexColorChannel";var u=t+"Tint";var f=t+"VertexColor";var d=t+"Mode";var p=n[u];var m=n[f];var _=n[a];var v=n[d];var g=r[i];if(_){var y=this._getUvSourceExpression(l,o,n);g=g.replace(/\$UV/g,y).replace(/\$CH/g,n[h]);if(s!==undefined){var b=s===0?"texture2DSRGB":s===1?"texture2DRGBM":"texture2D";g=g.replace(/\$texture2DSAMPLE/g,b)}}if(m)g=g.replace(/\$VC/g,n[c]);if(v)g=g.replace(/\$DETAILMODE/g,v);var x=p===1;var S=p===3;g=this._addMapDefs(x,S,m,_)+g;return g.replace(/\$/g,"")},_nonPointShadowMapProjection:function e(t,i,n){if(!i._normalOffsetBias||i._isVsm){if(i._type===Ul){if(i._isPcf&&(t.webgl2||t.extStandardDerivatives))return"\t\t\t getShadowCoordPerspZbuffer"+n;return"\t\t\t getShadowCoordPersp"+n}return"\t\t\t getShadowCoordOrtho"+n}if(i._type===Ul){if(i._isPcf&&(t.webgl2||t.extStandardDerivatives))return"\t\t\t getShadowCoordPerspZbufferNormalOffset"+n;return"\t\t\t getShadowCoordPerspNormalOffset"+n}return"\t\t\t getShadowCoordOrthoNormalOffset"+n},_addVaryingIfNeeded:function e(t,i,n){return t.indexOf(n)>=0?"varying "+i+" "+n+";\n":""},_getLightSourceShapeString:function e(t){switch(t){case Hl:return"Rect";case Wl:return"Disk";case jl:return"Sphere";default:return""}},_vsAddTransformCode:function e(t,i,n,r){t+=n.transformVS;return t},_vsAddBaseCode:function e(t,i,n,r){t+=n.baseVS;if(r.nineSlicedMode===vc||r.nineSlicedMode===gc)t+=n.baseNineSlicedVS;return t},_fsAddBaseCode:function e(t,i,n,r){t+=n.basePS;if(r.nineSlicedMode===vc)t+=n.baseNineSlicedPS;else if(r.nineSlicedMode===gc)t+=n.baseNineSlicedTiledPS;return t},_fsAddStartCode:function e(t,i,n,r){t+=n.startPS;if(r.nineSlicedMode===vc)t+=n.startNineSlicedPS;else if(r.nineSlicedMode===gc)t+=n.startNineSlicedTiledPS;return t},createShaderDefinition:function e(t,i){var n,r;var s=i.lights.length>0;if(i.dirLightMap){s=true;i.useSpecular=true}if(i.shadingModel===bh){i.fresnelModel=0;i.specularAntialias=false;i.prefilteredCubemap=false;i.dpAtlas=false;i.ambientSH=false}else i.fresnelModel=i.fresnelModel===0?Pl:i.fresnelModel;var a=(i.cubeMap||i.prefilteredCubemap&&i.useSpecular)&&!i.sphereMap&&!i.dpAtlas;var o=i.sphereMap||a||i.dpAtlas;var l=i.useTexCubeLod;if(i.cubeMap)i.sphereMap=null;if(i.dpAtlas)i.prefilteredCubemap=null;if(!i.useSpecular)i.specularMap=i.glossMap=null;var h=s||o||i.ambientSH||i.prefilteredCubemap||i.heightMap||i.enableGGXSpecular;var c=i.pass>=dc&&i.pass<=17;this.options=i;var u="";var f="";var d="";var p=ul;var m;var _;var v;var g={vertex_position:Ci};if(i.chunks){var y={};var b;for(r in p)if(p.hasOwnProperty(r))if(!i.chunks[r])y[r]=p[r];else{v=i.chunks[r];if(v.indexOf("vertex_normal")>=0)g.vertex_normal=Ai;if(v.indexOf("vertex_tangent")>=0)g.vertex_tangent=Pi;if(v.indexOf("vertex_texCoord0")>=0)g.vertex_texCoord0=Di;if(v.indexOf("vertex_texCoord1")>=0)g.vertex_texCoord1=ki;if(v.indexOf("vertex_color")>=0)g.vertex_color=Ri;if(v.indexOf("vertex_boneWeights")>=0)g.vertex_boneWeights=Ei;if(v.indexOf("vertex_boneIndices")>=0)g.vertex_boneIndices=Ii;y[r]=v}for(r in i.chunks){b=this._oldChunkToNew[r];if(b)y[b.n]=b.f(i.chunks[r],b.n,r)}p=y}u=this._vsAddBaseCode(u,t,p,i);var x=-1;if(!i.noShadow&&!i.twoSidedLighting){for(n=0;n<i.lights.length;n++){m=i.lights[n]._type;if(i.lights[n].castShadows)if(m===Nl){u+="uniform mat4 light"+n+"_shadowMatrixVS;\n";u+="uniform vec3 light"+n+"_shadowParamsVS;\n";u+="uniform vec3 light"+n+(m===Nl?"_directionVS":"_positionVS")+";\n";x=n;break}}if(x>=0)u+=p.shadowCoordVS}f+="\t vPositionW\t\t= getWorldPosition();\n";if(i.pass===fc){u+="varying float vDepth;\n";u+="#ifndef VIEWMATRIX\n";u+="#define VIEWMATRIX\n";u+="uniform mat4 matrix_view;\n";u+="#endif\n";u+="#ifndef CAMERAPLANES\n";u+="#define CAMERAPLANES\n";u+="uniform vec4 camera_params;\n\n";u+="#endif\n";f+="\t\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"}if(i.useInstancing){g.instance_line1=Oi;g.instance_line2=Fi;g.instance_line3=Bi;g.instance_line4=Ni;u+=p.instancingVS}if(h){g.vertex_normal=Ai;f+="\t vNormalW\t\t= dNormalW = getNormal();\n";if(i.sphereMap&&t.fragmentUniformsCount<=16){u+=p.viewNormalVS;f+="\t vNormalV\t\t= getViewNormal();\n"}if((i.heightMap||i.normalMap||i.enableGGXSpecular)&&i.hasTangents){g.vertex_tangent=Pi;u+=p.tangentBinormalVS;f+="\t vTangentW\t = getTangent();\n";f+="\t vBinormalW\t= getBinormal();\n"}else if(i.enableGGXSpecular){u+=p.tangentBinormalVS;f+="\t vObjectSpaceUpW\t= getObjectSpaceUp();\n"}if(x>=0){m=i.lights[x]._type;if(m===Nl)f+="\t dLightDirNormW = light"+x+"_directionVS;\n";else f+="\t getLightDirPoint(light"+x+"_positionVS);\n";_="(light"+x+"_shadowMatrixVS, light"+x+"_shadowParamsVS);\n";f+=this._nonPointShadowMapProjection(t,i.lights[x],_)}}var S=[];var w=[];var T=2;var M,C,A,P;for(r in mu){C=r+"Map";if(i[r+"VertexColor"]){M=r+"VertexColorChannel";i[M]=this._correctChannel(r,i[M])}if(i[C]){M=C+"Channel";A=C+"Transform";P=C+"Uv";i[P]=Math.min(i[P],T-1);i[M]=this._correctChannel(r,i[M]);var E=i[P];S[E]=true;w[E]=w[E]||i[C]&&!i[A]}}if(i.forceUv1){S[1]=true;w[1]=w[1]!==undefined?w[1]:true}for(n=0;n<T;n++){if(S[n]){g["vertex_texCoord"+n]="TEXCOORD"+n;u+=p["uv"+n+"VS"];f+="\t vec2 uv"+n+" = getUv"+n+"();\n"}if(w[n])f+="\t vUv"+n+" = uv"+n+";\n"}var I=[u,d,f,[]];for(r in mu){C=r+"Map";if(i[C]){A=C+"Transform";if(i[A]){P=C+"Uv";this._setMapTransform(I,r,i[A],i[P])}}}u=I[0];d=I[1];f=I[2];if(i.vertexColors){g.vertex_color=Ri;f+="\t vVertexColor = vertex_color;\n"}if(i.useMorphPosition||i.useMorphNormal)if(i.useMorphTextureBased){u+="#define MORPHING_TEXTURE_BASED\n";if(i.useMorphPosition)u+="#define MORPHING_TEXTURE_BASED_POSITION\n";if(i.useMorphNormal)u+="#define MORPHING_TEXTURE_BASED_NORMAL\n";g.morph_vertex_id=rn;u+="attribute float morph_vertex_id;\n"}else{u+="#define MORPHING\n";if(i.useMorphPosition){g.morph_pos0=Qi;g.morph_pos1=$i;g.morph_pos2=Zi;g.morph_pos3=Ji;u+="#define MORPHING_POS03\n";u+="attribute vec3 morph_pos0;\n";u+="attribute vec3 morph_pos1;\n";u+="attribute vec3 morph_pos2;\n";u+="attribute vec3 morph_pos3;\n"}else if(i.useMorphNormal){g.morph_nrm0=Qi;g.morph_nrm1=$i;g.morph_nrm2=Zi;g.morph_nrm3=Ji;u+="#define MORPHING_NRM03\n";u+="attribute vec3 morph_nrm0;\n";u+="attribute vec3 morph_nrm1;\n";u+="attribute vec3 morph_nrm2;\n";u+="attribute vec3 morph_nrm3;\n"}if(!i.useMorphNormal){g.morph_pos4=en;g.morph_pos5=tn;g.morph_pos6=nn;g.morph_pos7=rn;u+="#define MORPHING_POS47\n";u+="attribute vec3 morph_pos4;\n";u+="attribute vec3 morph_pos5;\n";u+="attribute vec3 morph_pos6;\n";u+="attribute vec3 morph_pos7;\n"}else{g.morph_nrm4=en;g.morph_nrm5=tn;g.morph_nrm6=nn;g.morph_nrm7=rn;u+="#define MORPHING_NRM47\n";u+="attribute vec3 morph_nrm4;\n";u+="attribute vec3 morph_nrm5;\n";u+="attribute vec3 morph_nrm6;\n";u+="attribute vec3 morph_nrm7;\n"}}if(i.skin){g.vertex_boneWeights=Ei;g.vertex_boneIndices=Ii;u+=Uc(t,p);u+="#define SKIN\n"}else if(i.useInstancing)u+="#define INSTANCING\n";if(i.screenSpace)u+="#define SCREENSPACE\n";if(i.pixelSnap)u+="#define PIXELSNAP\n";u=this._vsAddTransformCode(u,t,p,i);if(h)u+=p.normalVS;u+="\n";u+=p.startVS;u+=f;u+="}";var R=u;var L=d;d="";d+=this._addVaryingIfNeeded(u,"vec4","vMainShadowUv");d+=this._addVaryingIfNeeded(u,"vec4","vVertexColor");d+=this._addVaryingIfNeeded(u,"vec3","vPositionW");d+=this._addVaryingIfNeeded(u,"vec3","vNormalV");d+=this._addVaryingIfNeeded(u,"vec3","vNormalW");d+=this._addVaryingIfNeeded(u,"vec3","vTangentW");d+=this._addVaryingIfNeeded(u,"vec3","vBinormalW");d+=this._addVaryingIfNeeded(u,"vec3","vObjectSpaceUpW");d+=this._addVaryingIfNeeded(u,"vec2","vUv0");d+=this._addVaryingIfNeeded(u,"vec2","vUv1");d+=L;R=d+R;var D="";if(t.webgl2){D=Hc(t);if(p.extensionVS)D+=p.extensionVS+"\n";R=D+p.gles3VS+R}else{if(p.extensionVS)D=p.extensionVS+"\n";R=D+R}if(i.forceFragmentPrecision&&i.forceFragmentPrecision!="highp"&&i.forceFragmentPrecision!=="mediump"&&i.forceFragmentPrecision!=="lowp")i.forceFragmentPrecision=null;if(i.forceFragmentPrecision){if(i.forceFragmentPrecision==="highp"&&t.maxPrecision!=="highp")i.forceFragmentPrecision="mediump";if(i.forceFragmentPrecision==="mediump"&&t.maxPrecision==="lowp")i.forceFragmentPrecision="lowp"}var k;u="";if(t.webgl2)u+=Hc(t);if(t.extStandardDerivatives&&!t.webgl2)u+="#extension GL_OES_standard_derivatives : enable\n\n";if(p.extensionPS)u+=p.extensionPS+"\n";if(t.webgl2)u+=p.gles3PS;u+=i.forceFragmentPrecision?"precision "+i.forceFragmentPrecision+" float;\n\n":Gc(t);if(i.pass===mc){u+="uniform vec4 uColor;\n";u+=d;if(i.alphaTest){u+="float dAlpha;\n";u+=this._addMap("opacity","opacityPS",i,p);u+=p.alphaTestPS}u+=jc();if(i.alphaTest){u+="\t getOpacity();\n";u+="\t alphaTest(dAlpha);\n"}u+="\t\tgl_FragColor = uColor;\n";u+=Xc();return{attributes:g,vshader:R,fshader:u}}else if(i.pass===fc){u+="varying float vDepth;\n";u+=d;u+=p.packDepthPS;if(i.alphaTest){u+="float dAlpha;\n";u+=this._addMap("opacity","opacityPS",i,p);u+=p.alphaTestPS}u+=jc();if(i.alphaTest){u+="\t getOpacity();\n";u+="\t alphaTest(dAlpha);\n"}u+="\t\tgl_FragColor = packFloat(vDepth);\n";u+=Xc();return{attributes:g,vshader:R,fshader:u}}else if(c){var O=i.pass-dc;var F=5;m=Math.floor(O/F);var B=O-m*F;if(t.extStandardDerivatives&&!t.webgl2)u+="uniform vec2 polygonOffset;\n";if(B===Zl)if(t.textureFloatHighPrecision)u+="#define VSM_EXPONENT 15.0\n\n";else u+="#define VSM_EXPONENT 5.54\n\n";else if(B===$l)u+="#define VSM_EXPONENT 5.54\n\n";if(m!==Nl){u+="uniform vec3 view_position;\n";u+="uniform float light_radius;\n"}u+=d;if(i.alphaTest){u+="float dAlpha;\n";u+=this._addMap("opacity","opacityPS",i,p);u+=p.alphaTestPS}if(B===Yl&&(!t.webgl2||m===zl))u+=p.packDepthPS;else if(B===Ql){u+="vec2 encodeFloatRG( float v ) {\n";u+="\t\tvec2 enc = vec2(1.0, 255.0) * v;\n";u+="\t\tenc = fract(enc);\n";u+="\t\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n";u+="\t\treturn enc;\n";u+="}\n\n"}u+=jc();if(i.alphaTest){u+="\t getOpacity();\n";u+="\t alphaTest(dAlpha);\n"}var N=B===Ql||B===$l||B===Zl;if(m===zl||N&&m!==Nl)u+="\t float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n";else u+="\t float depth = gl_FragCoord.z;\n";if(B===Yl&&(!t.webgl2||m===zl))if(t.extStandardDerivatives&&!t.webgl2){u+="\t float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n";u+="\t depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n";u+="\t gl_FragColor = packFloat(depth);\n"}else u+="\t gl_FragColor = packFloat(depth);\n";else if(B===Yl||B===Jl)u+="\t gl_FragColor = vec4(1.0);\n";else if(B===Ql)u+="\t gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n";else u+=p.storeEVSMPS;u+=Xc();return{attributes:g,vshader:R,fshader:u}}if(i.customFragmentShader){k=u+i.customFragmentShader;return{attributes:g,vshader:R,fshader:k,tag:sn}}u+=d;u=this._fsAddBaseCode(u,t,p,i);if(i.detailModes)u+=p.detailModesPS;var z=u;u="";if(i.clearCoat>0)u+="#define CLEARCOAT\n";if(i.opacityFadesSpecular===false)u+="uniform float material_alphaFade;\n";var V=0;var U=[];var G=false;var H=false;var W;var j=i.lights.some(function(e){return e._shape&&e._shape!==Gl});if(t._areaLightLutFormat===Kt)u+="#define AREA_R8_G8_B8_A8_LUTS\n";if(j){u+="#define AREA_LIGHTS\n";u+="uniform sampler2D areaLightsLutTex1;\n";u+="uniform sampler2D areaLightsLutTex2;\n"}var X=Gl;for(n=0;n<i.lights.length;n++){W=i.lights[n];m=W._type;if(j&&W._shape)X=W._shape;else X=Gl;u+="uniform vec3 light"+n+"_color;\n";if(m===Nl)u+="uniform vec3 light"+n+"_direction;\n";else{u+="uniform vec3 light"+n+"_position;\n";u+="uniform float light"+n+"_radius;\n";if(m===Ul){u+="uniform vec3 light"+n+"_direction;\n";u+="uniform float light"+n+"_innerConeAngle;\n";u+="uniform float light"+n+"_outerConeAngle;\n"}}if(X!==Gl){if(m===Nl)u+="uniform vec3 light"+n+"_position;\n";u+="uniform vec3 light"+n+"_halfWidth;\n";u+="uniform vec3 light"+n+"_halfHeight;\n"}if(W.castShadows&&!i.noShadow){u+="uniform mat4 light"+n+"_shadowMatrix;\n";if(m!==Nl)u+="uniform vec4 light"+n+"_shadowParams;\n";else u+="uniform vec3 light"+n+"_shadowParams;\n";if(m===zl)u+="uniform samplerCube light"+n+"_shadowMap;\n";else if(W._isPcf&&t.webgl2)u+="uniform sampler2DShadow light"+n+"_shadowMap;\n";else u+="uniform sampler2D light"+n+"_shadowMap;\n";V++;U[W._shadowType]=true;if(W._isVsm)G=true;if(W._isPcf&&(t.webgl2||t.extStandardDerivatives)&&m===Ul)H=true}if(W._cookie)if(W._cookie._cubemap){if(m===zl){u+="uniform samplerCube light"+n+"_cookie;\n";u+="uniform float light"+n+"_cookieIntensity;\n";if(!W.castShadows||i.noShadow)u+="uniform mat4 light"+n+"_shadowMatrix;\n"}}else if(m===Ul){u+="uniform sampler2D light"+n+"_cookie;\n";u+="uniform float light"+n+"_cookieIntensity;\n";if(!W.castShadows||i.noShadow)u+="uniform mat4 light"+n+"_shadowMatrix;\n";if(W._cookieTransform){u+="uniform vec4 light"+n+"_cookieMatrix;\n";u+="uniform vec2 light"+n+"_cookieOffset;\n"}}}u+="\n";var q;if(!i.hasTangents&&t.extStandardDerivatives)q=p.TBNderivativePS;else if(i.fastTbn)q=p.TBNfastPS;else q=p.TBNPS;if(h)if(i.normalMap||i.clearCoatNormalMap){u+=i.packedNormal?p.normalXYPS:p.normalXYZPS;if(!i.hasTangents){var Y=this._getUvSourceExpression("normalMapTransform","normalMapUv",i);q=q.replace(/\$UV/g,Y)}u+=q}else if(i.enableGGXSpecular&&!i.heightMap){u+=p.normalVertexPS;u+=p.TBNObjectSpacePS}if(h)if(i.normalMap){if(i.normalDetail)u+=this._addMap("normalDetail","normalDetailMapPS",i,p);var K=this._getUvSourceExpression("normalMapTransform","normalMapUv",i);if(i.normalizeNormalMap)u+=p.normalMapPS.replace(/\$UV/g,K);else u+=p.normalMapFastPS.replace(/\$UV/g,K)}else if(!(i.enableGGXSpecular&&!i.heightMap))u+=p.normalVertexPS;u+=Nc(i.gamma,p);u+=zc(i.toneMap,p);u+=Vc(i.fog,p);if(i.useRgbm)u+=p.rgbmPS;if(a||i.prefilteredCubemap)u+=i.fixSeams?p.fixCubemapSeamsStretchPS:p.fixCubemapSeamsNonePS;if(i.useCubeMapRotation)u+="#define CUBEMAP_ROTATION\n";if(i.useRightHandedCubeMap)u+="#define RIGHT_HANDED_CUBEMAP\n";if(h){u+=p.cubeMapRotatePS;u+=i.cubeMapProjection>0?p.cubeMapProjectBoxPS:p.cubeMapProjectNonePS;u+=i.skyboxIntensity?p.envMultiplyPS:p.envConstPS}if(i.diffuseDetail)u+=this._addMap("diffuseDetail","diffuseDetailMapPS",i,p);u+=this._addMap("diffuse","diffusePS",i,p);if(i.blendType!==ml||i.alphaTest||i.alphaToCoverage)u+=this._addMap("opacity","opacityPS",i,p);u+=this._addMap("emissive","emissivePS",i,p,i.emissiveFormat);if(s&&i.useSpecular||o){if(i.specularAntialias&&i.normalMap)if(i.normalizeNormalMap&&h)u+=p.specularAaToksvigPS;else u+=p.specularAaToksvigFastPS;else u+=p.specularAaNonePS;var Q=i.useMetalness?"metalness":"specular";u+=this._addMap(Q,Q+"PS",i,p);u+=this._addMap("gloss","glossPS",i,p);if(i.fresnelModel===Pl)u+=p.fresnelSchlickPS}if(i.clearCoat>0){u+=this._addMap("clearCoat","clearCoatPS",i,p);u+=this._addMap("clearCoatGloss","clearCoatGlossPS",i,p);u+=this._addMap("clearCoatNormal","clearCoatNormalPS",i,p)}if(i.heightMap){if(!i.normalMap){var $=this._getUvSourceExpression("heightMapTransform","heightMapUv",i);if(!i.hasTangents)q=q.replace(/\$UV/g,$);u+=q}u+=this._addMap("height","parallaxPS",i,p)}var Z=i.aoMap||i.aoVertexColor;if(Z){u+=this._addMap("ao","aoPS",i,p);if(i.occludeSpecular)if(i.occludeSpecular===Nh)u+=i.occludeSpecularFloat?p.aoSpecOccSimplePS:p.aoSpecOccConstSimplePS;else u+=i.occludeSpecularFloat?p.aoSpecOccPS:p.aoSpecOccConstPS}var J=i.rgbmReflection?"decodeRGBM":i.hdrReflection?"":"gammaCorrectInput";if(i.sphereMap){var ee=t.fragmentUniformsCount>16?p.reflectionSpherePS:p.reflectionSphereLowPS;ee=ee.replace(/\$texture2DSAMPLE/g,i.rgbmReflection?"texture2DRGBM":i.hdrReflection?"texture2D":"texture2DSRGB");u+=ee}else if(a)if(i.prefilteredCubemap)if(l)u+=p.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,J);else u+=p.reflectionPrefilteredCubePS.replace(/\$DECODE/g,J);else u+=p.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,i.rgbmReflection?"textureCubeRGBM":i.hdrReflection?"textureCube":"textureCubeSRGB");else if(i.dpAtlas)u+=p.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,i.rgbmReflection?"texture2DRGBM":i.hdrReflection?"texture2D":"texture2DSRGB");if(a||i.sphereMap||i.dpAtlas){if(i.clearCoat>0)u+=p.reflectionCCPS;if(i.refraction)u+=p.refractionPS}if(V>0){if(U[Yl])u+=p.shadowStandardPS;if(U[Jl])u+=p.shadowStandardGL2PS;if(G){u+=p.shadowVSM_commonPS;if(U[Ql])u+=p.shadowVSM8PS;if(U[$l])u+=t.extTextureHalfFloatLinear?p.shadowEVSMPS.replace(/\$/g,"16"):p.shadowEVSMnPS.replace(/\$/g,"16");if(U[Zl])u+=t.extTextureFloatLinear?p.shadowEVSMPS.replace(/\$/g,"32"):p.shadowEVSMnPS.replace(/\$/g,"32")}if(!(t.webgl2||t.extStandardDerivatives))u+=p.biasConstPS;u+=p.shadowCoordPS+p.shadowCommonPS;if(H)u+=p.shadowCoordPerspZbufferPS;if(x>=0){if(U[Yl])u+=p.shadowStandardVSPS;if(U[Jl])u+=p.shadowStandardGL2VSPS;if(G){if(U[Ql])u+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8");if(U[$l])u+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16");if(U[Zl])u+=p.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")}}}if(i.enableGGXSpecular)u+="uniform float material_anisotropy;\n";if(s){u+=p.lightDiffuseLambertPS;if(j)u+=p.ltc}var te=false;if(i.useSpecular){if(s)u+=i.shadingModel===bh?p.lightSpecularPhongPS:i.enableGGXSpecular?p.lightSpecularAnisoGGXPS:p.lightSpecularBlinnPS;if(i.sphereMap||a||i.dpAtlas||i.fresnelModel>0)if(i.fresnelModel>0)if(i.conserveEnergy&&!j)u+=p.combineDiffuseSpecularPS;else u+=p.combineDiffuseSpecularNoConservePS;else u+=p.combineDiffuseSpecularOldPS;else if(i.diffuseMap)u+=p.combineDiffuseSpecularNoReflPS;else{u+=p.combineDiffuseSpecularNoReflSeparateAmbientPS;te=true}}else u+=p.combineDiffusePS;if(i.clearCoat>0)u+=p.combineClearCoatPS;var ie=true;if(i.lightMap||i.lightVertexColor){var ne=i.dirLightMap?"lightmapDirPS":"lightmapSinglePS";u+=this._addMap("light",ne,i,p,i.lightMapFormat);ie=i.lightMapWithoutAmbient}if(ie){var re=i.rgbmAmbient?"decodeRGBM":i.hdrAmbient?"":"gammaCorrectInput";if(i.ambientSH)u+=p.ambientSHPS;else if(i.prefilteredCubemap)if(l)u+=p.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,re);else u+=p.ambientPrefilteredCubePS.replace(/\$DECODE/g,re);else u+=p.ambientConstantPS}if(i.ambientTint&&!te)u+="uniform vec3 material_ambient;\n";if(i.alphaTest)u+=p.alphaTestPS;if(i.msdf)u+=p.msdfPS;if(h){u+=p.viewDirPS;if(i.useSpecular)u+=i.enableGGXSpecular?p.reflDirAnisoPS:p.reflDirPS}var se=false;var ae=false;var oe=false;var le=false;var he=false;var ce;if(i.twoSidedLighting)u+="uniform float twoSidedLightingNegScaleFactor;\n";u=this._fsAddStartCode(u,t,p,i);if(h){if(!i.hasTangents&&t.extStandardDerivatives&&!i.fastTbn)if(i.twoSidedLighting)u+="\t dVertexNormalW = normalize(gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor);\n";else u+="\t dVertexNormalW = normalize(vNormalW);\n";else if(i.twoSidedLighting)u+="\t dVertexNormalW = gl_FrontFacing ? vNormalW * twoSidedLightingNegScaleFactor : -vNormalW * twoSidedLightingNegScaleFactor;\n";else u+="\t dVertexNormalW = vNormalW;\n";if((i.heightMap||i.normalMap)&&i.hasTangents)if(i.twoSidedLighting){u+="\t dTangentW = gl_FrontFacing ? vTangentW * twoSidedLightingNegScaleFactor : -vTangentW * twoSidedLightingNegScaleFactor;\n";u+="\t dBinormalW = gl_FrontFacing ? vBinormalW * twoSidedLightingNegScaleFactor : -vBinormalW * twoSidedLightingNegScaleFactor;\n"}else{u+="\t dTangentW = vTangentW;\n";u+="\t dBinormalW = vBinormalW;\n"}}var ue=false;if(i.blendType===ml&&!i.alphaTest&&!i.alphaToCoverage)u+="\t dAlpha = 1.0;\n";else if(i.heightMap&&i.opacityMap)ue=true;else{u+="\t getOpacity();\n";if(i.alphaTest)u+="\t alphaTest(dAlpha);\n"}var fe=false;if(h){u+="\t getViewDir();\n";if(i.heightMap||i.normalMap||i.clearCoatNormalMap||i.enableGGXSpecular)u+="\t getTBN();\n";if(i.heightMap)u+="\t getParallax();\n";if(ue){u+="\t getOpacity();\n";if(i.alphaTest)u+="\t alphaTest(dAlpha);\n"}u+="\t getNormal();\n";if(i.useSpecular){if(i.enableGGXSpecular){u+="\t getGlossiness();\n";fe=true}u+="\t getReflDir();\n"}}u+="\t getAlbedo();\n";if(i.clearCoat>0){u+="\t getClearCoat();\n";u+="\t getClearCoatGlossiness();\n";u+="\t getClearCoatNormal();\n"}if(s&&i.useSpecular||o){u+="\t getSpecularity();\n";if(!fe)u+="\t getGlossiness();\n";if(j){u+="\t #ifdef AREA_LIGHTS\n";u+="\t dSpecularityNoFres = dSpecularity;\n";u+="\t #ifdef CLEARCOAT\n";u+="\t ccSpecularityNoFres = ccSpecularity;\n";u+="\t #endif\n";u+="\t #endif\n"}if(i.fresnelModel>0)u+="\t getFresnel();\n"}if(ie)u+="\t addAmbient();\n";if(i.ambientTint&&!te)u+="\t dDiffuseLight *= material_ambient;\n";if(Z&&!i.occludeDirect)u+="\t\tapplyAO();\n";if(i.lightMap||i.lightVertexColor)u+="\t addLightMap();\n";if(s||o){if(a||i.sphereMap||i.dpAtlas){if(i.clearCoat>0)u+="\t addReflectionCC();\n";u+="\t addReflection();\n"}if(j){u+="\t ccReflection.rgb *= ccSpecularity;\n";u+="\t dReflection.rgb *= dSpecularity;\n";u+="\t dSpecularLight *= dSpecularity;\n";u+="\t float roughness = max((1.0 - dGlossiness) * (1.0 - dGlossiness), 0.001);\n"}var de="";for(n=0;n<i.lights.length;n++){W=i.lights[n];m=W._type;ce=false;if(j&&W._shape){X=W._shape;de=this._getLightSourceShapeString(X)}else{X=Gl;de=""}if(X!==Gl)u+="\t calc"+de+"LightValues(light"+n+"_position, light"+n+"_halfWidth, light"+n+"_halfHeight);\n";if(m===Nl){u+="\t dLightDirNormW = light"+n+"_direction;\n";u+="\t dAtten = 1.0;\n"}else{if(W._cookie)if(m===Ul&&!W._cookie._cubemap){he=true;ce=true}else if(m===zl&&W._cookie._cubemap){he=true;ce=true}u+="\t getLightDirPoint(light"+n+"_position);\n";se=true;if(ce)if(m===Ul)u+="\t dAtten3 = getCookie2D"+(W._cookieFalloff?"":"Clip")+(W._cookieTransform?"Xform":"")+"(light"+n+"_cookie, light"+n+"_shadowMatrix, light"+n+"_cookieIntensity"+(W._cookieTransform?", light"+n+"_cookieMatrix, light"+n+"_cookieOffset":"")+")."+W._cookieChannel+";\n";else u+="\t dAtten3 = getCookieCube(light"+n+"_cookie, light"+n+"_shadowMatrix, light"+n+"_cookieIntensity)."+W._cookieChannel+";\n";if(X===Gl)if(W._falloffMode===Xl){u+="\t dAtten = getFalloffLinear(light"+n+"_radius);\n";ae=true}else{u+="\t dAtten = getFalloffInvSquared(light"+n+"_radius);\n";oe=true}else{u+="\t dAtten = getFalloffWindow(light"+n+"_radius);\n";oe=true}u+="\t if (dAtten > 0.00001) {\n";if(m===Ul)if(!(ce&&!W._cookieFalloff)){u+="\t\t\t dAtten *= getSpotEffect(light"+n+"_direction, light"+n+"_innerConeAngle, light"+n+"_outerConeAngle);\n";le=true}}if(X!==Gl)if(m===Nl)u+="\t\t\t dAttenD = getLightDiffuse();\n";else u+="\t\t\t dAttenD = get"+de+"LightDiffuse() * 16.0;\n";else u+="\t\t\t dAtten *= getLightDiffuse();\n";if(W.castShadows&&!i.noShadow){var pe=null;var me;if(W._shadowType===Ql){pe="VSM8";me="0.0"}else if(W._shadowType===$l){pe="VSM16";me="5.54"}else if(W._shadowType===Zl){pe="VSM32";if(t.textureFloatHighPrecision)me="15.0";else me="5.54"}else if(W._shadowType===Jl)pe="PCF5x5";else pe="PCF3x3";if(pe!==null)if(m===zl){_="(light"+n+"_shadowMap, light"+n+"_shadowParams);\n";if(W._normalOffsetBias)u+="\t\t\t normalOffsetPointShadow(light"+n+"_shadowParams);\n";u+="\t\t\t dAtten *= getShadowPoint"+pe+_}else{if(x===n)pe+="VS";else{_="(light"+n+"_shadowMatrix, light"+n+"_shadowParams);\n";u+=this._nonPointShadowMapProjection(t,i.lights[n],_)}if(m===Ul)pe="Spot"+pe;u+="\t\t\t dAtten *= getShadow"+pe+"(light"+n+"_shadowMap, light"+n+"_shadowParams"+(W._isVsm?", "+me:"")+");\n"}}if(X!==Gl)if(i.conserveEnergy&&i.useSpecular)u+="\t\t\t dDiffuseLight += mix((dAttenD * dAtten) * light"+n+"_color"+(ce?" * dAtten3":"")+", vec3(0), dLTCSpecFres);\n";else u+="\t\t\t dDiffuseLight += (dAttenD * dAtten) * light"+n+"_color"+(ce?" * dAtten3":"")+";\n";else if(j&&i.conserveEnergy&&i.useSpecular)u+="\t\t\t dDiffuseLight += mix(dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+", vec3(0), dSpecularity);\n";else u+="\t\t\t dDiffuseLight += dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n";if(X!==Gl){if(i.clearCoat>0)u+="\t\t\t ccSpecularLight += ccLTCSpecFres * get"+de+"LightSpecularCC() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n";if(i.useSpecular)u+="\t\t\t dSpecularLight += dLTCSpecFres * get"+de+"LightSpecular() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n"}else if(j){if(i.clearCoat>0)u+="\t\t\t ccSpecularLight += ccSpecularity * getLightSpecularCC() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n";if(i.useSpecular)u+="\t\t\t dSpecularLight += dSpecularity * getLightSpecular() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n"}else{if(i.clearCoat>0)u+="\t\t\t ccSpecularLight += getLightSpecularCC() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n";if(i.useSpecular)u+="\t\t\t dSpecularLight += getLightSpecular() * dAtten * light"+n+"_color"+(ce?" * dAtten3":"")+";\n"}if(m!==Nl)u+="\t }\n";u+="\n"}if(j){if(i.clearCoat>0)u+="\t ccSpecularity = vec3(1);\n";if(i.useSpecular)u+="\t dSpecularity = vec3(1);\n"}if((a||i.sphereMap||i.dpAtlas)&&i.refraction)u+="\t addRefraction();\n"}u+="\n";if(Z){if(i.occludeDirect)u+="\t\tapplyAO();\n";if(i.occludeSpecular)u+="\t\toccludeSpecular();\n"}if(i.opacityFadesSpecular===false){if(i.blendType===pl||i.blendType===_l){u+="float specLum = dot((dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n";u+="#ifdef CLEARCOAT\n specLum += dot(ccSpecularLight * ccSpecularity + ccReflection.rgb * ccReflection.a * ccSpecularity, vec3( 0.2126, 0.7152, 0.0722 ));\n#endif\n";u+="dAlpha = clamp(dAlpha + gammaCorrectInput(specLum), 0.0, 1.0);\n"}u+="dAlpha *= material_alphaFade;\n"}u+=p.endPS;if(i.blendType===pl||i.blendType===gl||i.alphaToCoverage)u+=p.outputAlphaPS;else if(i.blendType===_l)u+=p.outputAlphaPremulPS;else u+=p.outputAlphaOpaquePS;if(i.msdf)u+="\t gl_FragColor = applyMsdf(gl_FragColor);\n";u+="\n";u+=Xc();if(se)u=p.lightDirPointPS+u;if(ae)u=p.falloffLinearPS+u;if(oe)u=p.falloffInvSquaredPS+u;if(le)u=p.spotPS+u;if(he)u=p.cookiePS+u;var _e="";if(u.includes("dReflection"))_e+="vec4 dReflection;\n";if(u.includes("dTBN"))_e+="mat3 dTBN;\n";if(u.includes("dAlbedo"))_e+="vec3 dAlbedo;\n";if(u.includes("dEmission"))_e+="vec3 dEmission;\n";if(u.includes("dNormalW"))_e+="vec3 dNormalW;\n";if(u.includes("dVertexNormalW"))_e+="vec3 dVertexNormalW;\n";if(u.includes("dTangentW"))_e+="vec3 dTangentW;\n";if(u.includes("dBinormalW"))_e+="vec3 dBinormalW;\n";if(u.includes("dViewDirW"))_e+="vec3 dViewDirW;\n";if(u.includes("dReflDirW"))_e+="vec3 dReflDirW;\n";if(u.includes("dDiffuseLight"))_e+="vec3 dDiffuseLight;\n";if(u.includes("dSpecularLight"))_e+="vec3 dSpecularLight;\n";if(u.includes("dLightDirNormW"))_e+="vec3 dLightDirNormW;\n";if(u.includes("dLightDirW"))_e+="vec3 dLightDirW;\n";if(u.includes("dLightPosW"))_e+="vec3 dLightPosW;\n";if(u.includes("dShadowCoord"))_e+="vec3 dShadowCoord;\n";if(u.includes("dNormalMap"))_e+="vec3 dNormalMap;\n";if(u.includes("dSpecularity"))_e+="vec3 dSpecularity;\n";if(u.includes("dSpecularityNoFres"))_e+="vec3 dSpecularityNoFres;\n";if(u.includes("dUvOffset"))_e+="vec2 dUvOffset;\n";if(u.includes("dGlossiness"))_e+="float dGlossiness;\n";if(u.includes("dAlpha"))_e+="float dAlpha;\n";if(u.includes("dAtten"))_e+="float dAtten;\n";if(u.includes("dAttenD"))_e+="float dAttenD;\n";if(u.includes("dAtten3"))_e+="vec3 dAtten3;\n";if(u.includes("dAo"))_e+="float dAo;\n";if(u.includes("dMsdf"))_e+="vec4 dMsdf;\n";if(u.includes("ccReflection"))_e+="vec4 ccReflection;\n";if(u.includes("ccNormalW"))_e+="vec3 ccNormalW;\n";if(u.includes("ccReflDirW"))_e+="vec3 ccReflDirW;\n";if(u.includes("ccSpecularLight"))_e+="vec3 ccSpecularLight;\n";if(u.includes("ccSpecularity"))_e+="float ccSpecularity;\n";if(u.includes("ccSpecularityNoFres"))_e+="float ccSpecularityNoFres;\n";if(u.includes("ccGlossiness"))_e+="float ccGlossiness;\n";u=z+_e+u;k=u;return{attributes:g,vshader:R,fshader:k,tag:sn}}},vu={begin:jc,dummyFragmentCode:Wc,end:Xc,fogCode:Vc,gammaCode:Nc,precisionCode:Gc,skinCode:Uc,tonemapCode:zc,versionCode:Hc,basic:{generateKey:function e(t){var i="basic";if(t.fog)i+="_fog";if(t.alphaTest)i+="_atst";if(t.vertexColors)i+="_vcol";if(t.diffuseMap)i+="_diff";i+="_"+t.pass;return i},createShaderDefinition:function e(t,i){var n={vertex_position:Ci};if(i.skin){n.vertex_boneWeights=Ei;n.vertex_boneIndices=Ii}if(i.vertexColors)n.vertex_color=Ri;if(i.diffuseMap)n.vertex_texCoord0=Di;var r="";r+=ul.transformDeclVS;if(i.skin){r+=Uc(t);r+=ul.transformSkinnedVS}else r+=ul.transformVS;if(i.vertexColors){r+="attribute vec4 vertex_color;\n";r+="varying vec4 vColor;\n"}if(i.diffuseMap){r+="attribute vec2 vertex_texCoord0;\n";r+="varying vec2 vUv0;\n"}if(i.pass===fc){r+="varying float vDepth;\n";r+="#ifndef VIEWMATRIX\n";r+="#define VIEWMATRIX\n";r+="uniform mat4 matrix_view;\n";r+="#endif\n";r+="#ifndef CAMERAPLANES\n";r+="#define CAMERAPLANES\n";r+="uniform vec4 camera_params;\n\n";r+="#endif\n"}r+=jc();r+="\t gl_Position = getPosition();\n";if(i.pass===fc)r+="\t\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n";if(i.vertexColors)r+="\t\tvColor = vertex_color;\n";if(i.diffuseMap)r+="\t\tvUv0 = vertex_texCoord0;\n";r+=Xc();var s=r;r=Gc(t);if(i.vertexColors)r+="varying vec4 vColor;\n";else r+="uniform vec4 uColor;\n";if(i.diffuseMap){r+="varying vec2 vUv0;\n";r+="uniform sampler2D texture_diffuseMap;\n"}if(i.fog)r+=Vc(i.fog);if(i.alphatest)r+=ul.alphaTestPS;if(i.pass===fc){r+="varying float vDepth;\n";r+=ul.packDepthPS}r+=jc();if(i.vertexColors)r+="\t\tgl_FragColor = vColor;\n";else r+="\t\tgl_FragColor = uColor;\n";if(i.diffuseMap)r+="\t\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n";if(i.alphatest)r+="\t alphaTest(gl_FragColor.a);\n";if(i.pass!==mc)if(i.pass===fc)r+="\t\tgl_FragColor = packFloat(vDepth);\n";else if(i.fog)r+="\t glFragColor.rgb = addFog(gl_FragColor.rgb);\n";r+=Xc();var a=r;return{attributes:n,vshader:s,fshader:a}}},particle:{generateKey:function e(t){var i="particle";for(var n in t)if(t.hasOwnProperty(n))i+=t[n];return i},_animTex:function e(t){var i="";i+=t.animTexLoop?ul.particleAnimFrameLoopVS:ul.particleAnimFrameClampVS;i+=ul.particleAnimTexVS;return i},createShaderDefinition:function e(t,i){var n="";var r=Gc(t)+"\n";r+="#define PARTICLE\n";if(t.webgl2){n+="#define GL2\n";r+="#define GL2\n"}n+="#define VERTEXSHADER\n";if(i.mesh)n+="#define USE_MESH\n";if(i.localSpace)n+="#define LOCAL_SPACE\n";if(i.screenSpace)n+="#define SCREEN_SPACE\n";if(i.animTex)n+="\nuniform vec2 animTexTilesParams;\n";if(i.animTex)n+="\nuniform vec4 animTexParams;\n";if(i.animTex)n+="\nuniform vec2 animTexIndexParams;\n";if(i.normal==2)n+="\nvarying mat3 ParticleMat;\n";if(i.normal==1)n+="\nvarying vec3 Normal;\n";if(i.soft)n+="\nvarying float vDepth;\n";var s=i.customFace?ul.particle_customFaceVS:ul.particle_billboardVS;if(!i.useCpu){n+=ul.particle_initVS;n+=i.pack8?ul.particleInputRgba8PS:ul.particleInputFloatPS;if(i.soft>0)n+=ul.screenDepthPS;n+=ul.particleVS;if(i.localSpace)n+=ul.particle_localShiftVS;if(i.animTex)n+=this._animTex(i);if(i.wrap)n+=ul.particle_wrapVS;if(i.alignToMotion)n+=ul.particle_pointAlongVS;n+=i.mesh?ul.particle_meshVS:s;if(i.normal==1)n+=ul.particle_normalVS;if(i.normal==2)n+=ul.particle_TBNVS;if(i.stretch>0)n+=ul.particle_stretchVS;n+=ul.particle_endVS;if(i.soft>0)n+=ul.particle_softVS}else{if(i.soft>0)n+=ul.screenDepthPS;n+=ul.particle_cpuVS;if(i.localSpace)n+=ul.particle_localShiftVS;if(i.animTex)n+=this._animTex(i);if(i.alignToMotion)n+=ul.particle_pointAlongVS;n+=i.mesh?ul.particle_meshVS:s;if(i.normal==1)n+=ul.particle_normalVS;if(i.normal==2)n+=ul.particle_TBNVS;if(i.stretch>0)n+=ul.particle_stretchVS;n+=ul.particle_cpu_endVS;if(i.soft>0)n+=ul.particle_softVS}n+="}\n";if(i.normal>0){if(i.normal==1)r+="\nvarying vec3 Normal;\n";else if(i.normal==2)r+="\nvarying mat3 ParticleMat;\n";r+="\nuniform vec3 lightCube[6];\n"}if(i.soft)r+="\nvarying float vDepth;\n";if(i.normal===0&&i.fog==="none")i.srgb=false;r+=Nc(i.gamma);r+=zc(i.toneMap);if(i.fog==="linear")r+=ul.fogLinearPS;else if(i.fog==="exp")r+=ul.fogExpPS;else if(i.fog==="exp2")r+=ul.fogExp2PS;else r+=ul.fogNonePS;if(i.normal==2)r+="\nuniform sampler2D normalMap;\n";if(i.soft>0)r+=ul.screenDepthPS;r+=ul.particlePS;if(i.soft>0)r+=ul.particle_softPS;if(i.normal==1)r+="\nvec3 normal = Normal;\n";if(i.normal==2)r+=ul.particle_normalMapPS;if(i.normal>0)r+=i.halflambert?ul.particle_halflambertPS:ul.particle_lambertPS;if(i.normal>0)r+=ul.particle_lightingPS;if(i.blend==pl)r+=ul.particle_blendNormalPS;else if(i.blend==dl)r+=ul.particle_blendAddPS;else if(i.blend==vl)r+=ul.particle_blendMultiplyPS;r+=ul.particle_endPS;var a=Yc(n);return{attributes:a,vshader:n,fshader:r}}},skybox:{generateKey:function e(t){var i="skybox"+t.rgbm+" "+t.hdr+" "+t.fixSeams+""+t.toneMapping+""+t.gamma+""+t.useIntensity+""+t.useCubeMapRotation+""+t.useRightHandedCubeMap+""+t.mip;return i},createShaderDefinition:function e(t,i){var n=[128,64,32,16,8,4,2];var r;r=Gc(t);r+=i.useCubeMapRotation?"#define CUBEMAP_ROTATION\n":"";r+=i.useRightHandedCubeMap?"#define RIGHT_HANDED_CUBEMAP\n":"";r+=i.mip?ul.fixCubemapSeamsStretchPS:ul.fixCubemapSeamsNonePS;r+=i.useIntensity?ul.envMultiplyPS:ul.envConstPS;r+=Nc(i.gamma);r+=zc(i.toneMapping);r+=ul.rgbmPS;r+=ul.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,i.rgbm?"textureCubeRGBM":i.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/n[i.mip]+"");return{attributes:{aPosition:Ci},vshader:ul.skyboxVS,fshader:r}}},standard:_u},gu=null,yu=null,bu=function(){function i(e,t){this.device=e;this.name=null;this._width=4;this._height=4;this._depth=1;this._format=Kt;this.type=_n;this._cubemap=false;this._volume=false;this.fixCubemapSeams=false;this._flipY=true;this._premultiplyAlpha=false;this._isRenderTarget=false;this._mipmaps=true;this._minFilter=It;this._magFilter=Ct;this._anisotropy=1;this._addressU=He;this._addressV=He;this._addressW=He;this._compareOnRead=false;this._compareFunc=Lt;if(t!==undefined){if(t.name!==undefined)this.name=t.name;this._width=t.width!==undefined?t.width:this._width;this._height=t.height!==undefined?t.height:this._height;this._format=t.format!==undefined?t.format:this._format;if(t.hasOwnProperty("type"))this.type=t.type;else if(t.hasOwnProperty("rgbm"))this.type=t.rgbm?vn:_n;else if(t.hasOwnProperty("swizzleGGGR"))this.type=t.swizzleGGGR?yn:_n;if(t.mipmaps!==undefined)this._mipmaps=t.mipmaps;else this._mipmaps=t.autoMipmap!==undefined?t.autoMipmap:this._mipmaps;this._levels=t.levels;this._cubemap=t.cubemap!==undefined?t.cubemap:this._cubemap;this.fixCubemapSeams=t.fixCubemapSeams!==undefined?t.fixCubemapSeams:this.fixCubemapSeams;this._minFilter=t.minFilter!==undefined?t.minFilter:this._minFilter;this._magFilter=t.magFilter!==undefined?t.magFilter:this._magFilter;this._anisotropy=t.anisotropy!==undefined?t.anisotropy:this._anisotropy;this._addressU=t.addressU!==undefined?t.addressU:this._addressU;this._addressV=t.addressV!==undefined?t.addressV:this._addressV;this._compareOnRead=t.compareOnRead!==undefined?t.compareOnRead:this._compareOnRead;this._compareFunc=t._compareFunc!==undefined?t._compareFunc:this._compareFunc;this._flipY=t.flipY!==undefined?t.flipY:this._flipY;this._premultiplyAlpha=t.premultiplyAlpha!==undefined?t.premultiplyAlpha:this._premultiplyAlpha;if(e.webgl2){this._depth=t.depth!==undefined?t.depth:this._depth;this._volume=t.volume!==undefined?t.volume:this._volume;this._addressW=t.addressW!==undefined?t.addressW:this._addressW}}this._compressed=this._format===Qt||this._format===$t||this._format===Zt||this._format>=hi;this._invalid=false;this._lockedLevel=-1;if(!this._levels)this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null];this.dirtyAll();this._gpuSize=0}i.calcGpuSize=function e(t,i,n,r,s,a){if(!gu){gu=[];gu[Gt]=1;gu[Ht]=1;gu[Wt]=2;gu[jt]=2;gu[Xt]=2;gu[qt]=2;gu[Yt]=4;gu[Kt]=4;gu[Jt]=8;gu[ei]=8;gu[ti]=16;gu[ii]=16;gu[ni]=4;gu[ri]=4;gu[si]=4;gu[ai]=4;gu[oi]=4;gu[li]=4}if(!yu){yu=[];yu[hi]=8;yu[ci]=8;yu[fi]=8;yu[di]=8;yu[pi]=8;yu[mi]=8;yu[Qt]=8;yu[vi]=8;yu[ui]=16;yu[$t]=16;yu[Zt]=16;yu[_i]=16;yu[gi]=16}var o=gu.hasOwnProperty(r)?gu[r]:0;var l=yu.hasOwnProperty(r)?yu[r]:0;var h=0;while(1){if(o>0)h+=t*i*n*o;else{var c=Math.floor((t+3)/4);var u=Math.floor((i+3)/4);var f=Math.floor((n+3)/4);if(r===fi||r===di)c=Math.floor(c/2,1);h+=c*u*f*l}if(!s||t===1&&i===1&&n===1)break;t=Math.max(Math.floor(t/2),1);i=Math.max(Math.floor(i/2),1);n=Math.max(Math.floor(n/2),1)}return h*(a?6:1)};var e=i.prototype;e.destroy=function e(){if(this.device)this.device.destroyTexture(this);this.device=null;this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]};e.dirtyAll=function e(){this._levelsUpdated=this._cubemap?[[true,true,true,true,true,true]]:[true];this._needsUpload=true;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=false;this._parameterFlags=255};e.lock=function e(t){if(t===void 0)t={};if(t.level===undefined)t.level=0;if(t.face===undefined)t.face=0;if(t.mode===undefined)t.mode=mn;this._lockedLevel=t.level;if(this._levels[t.level]===null)switch(this._format){case Gt:case Ht:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case Wt:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case jt:case Xt:case qt:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case Yt:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case Kt:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case Qt:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case $t:case Zt:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case Jt:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case ti:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case ei:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case ii:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4);break}return this._levels[t.level]};e.setSource=function e(t,i){if(i===void 0)i=0;var n;var r=false;var s,a;if(this._cubemap){if(t[0]){s=t[0].width||0;a=t[0].height||0;for(n=0;n<6;n++){var o=t[n];if(!o||o.width!==s||o.height!==a||!this.device._isBrowserInterface(o)){r=true;break}}}else r=true;if(!r)for(n=0;n<6;n++)if(this._levels[i][n]!==t[n])this._levelsUpdated[i][n]=true}else{if(!this.device._isBrowserInterface(t))r=true;if(!r){if(t!==this._levels[i])this._levelsUpdated[i]=true;s=t.width;a=t.height}}if(r){this._width=4;this._height=4;if(this._cubemap)for(n=0;n<6;n++){this._levels[i][n]=null;this._levelsUpdated[i][n]=true}else{this._levels[i]=null;this._levelsUpdated[i]=true}}else{if(i===0){this._width=s;this._height=a}this._levels[i]=t}if(this._invalid!==r||!r){this._invalid=r;this.upload()}};e.getSource=function e(t){if(t===void 0)t=0;return this._levels[t]};e.unlock=function e(){this.upload();this._lockedLevel=-1};e.upload=function e(){this._needsUpload=true;this._needsMipmapsUpload=this._mipmaps};e.getDds=function e(){var t=128;var i=0;var n;var r;while(this._levels[i]){var s;if(!this.cubemap){s=this._levels[i].length;if(!s)return;t+=s}else for(r=0;r<6;r++){if(!this._levels[i][r])return;s=this._levels[i][r].length;if(!s)return;t+=s}t+=this._levels[i].length;i++}var a=new ArrayBuffer(t);var o=new Uint32Array(a,0,128/4);var l=542327876;var h=124;var c=1|2|4|4096|524288;var u=131072;var f=32;var d=1|64;var p=4096;var m=4194304;var _=8;var v=512|1024|2048|4096|8192|16384|32768;var g=c;if(this._levels.length>1)g|=u;var y=p;if(this._levels.length>1)y|=m;if(this._levels.length>1||this.cubemap)y|=_;var b=this.cubemap?v:0;o[0]=l;o[1]=h;o[2]=g;o[3]=this.height;o[4]=this.width;o[5]=this.width*this.height*4;o[6]=0;o[7]=this._levels.length;for(i=0;i<11;i++)o[8+i]=0;o[19]=f;o[20]=d;o[21]=0;o[22]=32;o[23]=16711680;o[24]=65280;o[25]=255;o[26]=4278190080;o[27]=y;o[28]=b;o[29]=0;o[30]=0;o[31]=0;var x=128;var S,w;if(!this.cubemap)for(i=0;i<this._levels.length;i++){S=this._levels[i];w=new Uint8Array(a,x,S.length);for(n=0;n<S.length;n++)w[n]=S[n];x+=S.length}else for(r=0;r<6;r++)for(i=0;i<this._levels.length;i++){S=this._levels[i][r];w=new Uint8Array(a,x,S.length);for(n=0;n<S.length;n++)w[n]=S[n];x+=S.length}return a};U(i,[{key:"minFilter",get:function e(){return this._minFilter},set:function e(t){if(this._minFilter!==t){this._minFilter=t;this._parameterFlags|=1}}},{key:"magFilter",get:function e(){return this._magFilter},set:function e(t){if(this._magFilter!==t){this._magFilter=t;this._parameterFlags|=2}}},{key:"addressU",get:function e(){return this._addressU},set:function e(t){if(this._addressU!==t){this._addressU=t;this._parameterFlags|=4}}},{key:"addressV",get:function e(){return this._addressV},set:function e(t){if(this._addressV!==t){this._addressV=t;this._parameterFlags|=8}}},{key:"addressW",get:function e(){return this._addressW},set:function e(t){if(!this.device.webgl2)return;if(!this._volume)return;if(t!==this._addressW){this._addressW=t;this._parameterFlags|=16}}},{key:"compareOnRead",get:function e(){return this._compareOnRead},set:function e(t){if(this._compareOnRead!==t){this._compareOnRead=t;this._parameterFlags|=32}}},{key:"compareFunc",get:function e(){return this._compareFunc},set:function e(t){if(this._compareFunc!==t){this._compareFunc=t;this._parameterFlags|=64}}},{key:"anisotropy",get:function e(){return this._anisotropy},set:function e(t){if(this._anisotropy!==t){this._anisotropy=t;this._parameterFlags|=128}}},{key:"autoMipmap",get:function e(){return this._mipmaps},set:function e(t){this._mipmaps=t}},{key:"mipmaps",get:function e(){return this._mipmaps},set:function e(t){if(this._mipmaps!==t){this._mipmaps=t;this._minFilterDirty=true;if(t)this._needsMipmapsUpload=true}}},{key:"width",get:function e(){return this._width}},{key:"height",get:function e(){return this._height}},{key:"depth",get:function e(){return this._depth}},{key:"format",get:function e(){return this._format}},{key:"cubemap",get:function e(){return this._cubemap}},{key:"gpuSize",get:function e(){var t=this.pot&&this._mipmaps&&!(this._compressed&&this._levels.length===1);return i.calcGpuSize(this._width,this._height,this._depth,this._format,t,this._cubemap)}},{key:"volume",get:function e(){return this._volume}},{key:"flipY",get:function e(){return this._flipY},set:function e(t){if(this._flipY!==t){this._flipY=t;this._needsUpload=true}}},{key:"premultiplyAlpha",get:function e(){return this._premultiplyAlpha},set:function e(t){if(this._premultiplyAlpha!==t){this._premultiplyAlpha=t;this._needsUpload=true}}},{key:"pot",get:function e(){return Pe.powerOfTwo(this._width)&&Pe.powerOfTwo(this._height)}}]);return i}(),xu=2;function Su(e,t,i,n){var r=t.fixCubemapSeams?ul.fixCubemapSeamsStretchPS:ul.fixCubemapSeamsNonePS;var s=Qc(e,ul.fullscreenQuadVS,r+ul.genParaboloidPS,"genParaboloid");var a=e.scope.resolve("source");var o=e.scope.resolve("params");var l=new ue;var h=t.width;var c=t.format;h=Math.max(h,8)*xu;var u=new bu(e,{type:t.type,format:c,width:h*2,height:h,mipmaps:false});u.name="paraboloid";var f=new BM(e,u,{depth:false});l.x=i;l.y=n?-1:1;a.setValue(t);o.setValue(l.data);Ar(e,f,s);return u}function wu(e,t){e.x=Pe.clamp(t-2,0,1)*.5;var i=t-e.x*6;var n=1-e.x;e.y=Math.min(i*.5,.75)*n+e.x;e.z=(1-Pe.clamp(i,0,1)*.5)*n;e.w=e.z*.5;return 1/e.z}function Tu(e,t,i){var n;var r=new ue;var s=new ue;var a=t[0].width*2*xu;var o=Qc(e,ul.fullscreenQuadVS,ul.dpAtlasQuadPS,"dpAtlasQuad");var l=e.scope.resolve("source");var h=e.scope.resolve("params");var c=new bu(e,{type:t[0].type,format:t[0].format,width:a,height:a,mipmaps:false});c.name="paraboloid";var u=new BM(e,c,{depth:false});var f=2;var d=a;var p=(d+f)/d-1;var m;for(var _=0;_<6;_++){n=Su(e,t[_],_,i);l.setValue(n);m=wu(r,_);s.x=m*p;s.y=s.x*2;s.x+=1;s.y+=1;h.setValue(s.data);r.x*=a;r.y*=a;r.z*=a;r.w*=a;Ar(e,u,o,r)}return c}var Mu=0,Cu=function(){function s(){this.name="Untitled";this.id=Mu++;this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.alphaToCoverage=false;this.blend=false;this.blendSrc=qe;this.blendDst=Xe;this.blendEquation=nt;this.separateAlphaBlend=false;this.blendSrcAlpha=qe;this.blendDstAlpha=Xe;this.blendAlphaEquation=nt;this.cull=St;this.depthTest=true;this.depthWrite=true;this.stencilFront=null;this.stencilBack=null;this.depthBias=0;this.slopeDepthBias=0;this.redWrite=true;this.greenWrite=true;this.blueWrite=true;this.alphaWrite=true;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=false;this.dirty=true}var e=s.prototype;e._cloneInternal=function e(t){t.name=this.name;t.shader=this.shader;t.alphaTest=this.alphaTest;t.alphaToCoverage=this.alphaToCoverage;t.blend=this.blend;t.blendSrc=this.blendSrc;t.blendDst=this.blendDst;t.blendEquation=this.blendEquation;t.separateAlphaBlend=this.separateAlphaBlend;t.blendSrcAlpha=this.blendSrcAlpha;t.blendDstAlpha=this.blendDstAlpha;t.blendAlphaEquation=this.blendAlphaEquation;t.cull=this.cull;t.depthTest=this.depthTest;t.depthWrite=this.depthWrite;t.depthBias=this.depthBias;t.slopeDepthBias=this.slopeDepthBias;if(this.stencilFront)t.stencilFront=this.stencilFront.clone();if(this.stencilBack)if(this.stencilFront===this.stencilBack)t.stencilBack=t.stencilFront;else t.stencilBack=this.stencilBack.clone();t.redWrite=this.redWrite;t.greenWrite=this.greenWrite;t.blueWrite=this.blueWrite;t.alphaWrite=this.alphaWrite};e.clone=function e(){var e=new s;this._cloneInternal(e);return e};e._updateMeshInstanceKeys=function e(){var t,i=this.meshInstances;for(t=0;t<i.length;t++)i[t].updateKey()};e.updateUniforms=function e(){};e.updateShader=function e(t,i,n){};e.update=function e(){this.dirty=true;if(this._shader)this._shader.failed=false};e.clearParameters=function e(){this.parameters={}};e.getParameters=function e(){return this.parameters};e.clearVariants=function e(){var t;this.variants={};var i;for(var n=0;n<this.meshInstances.length;n++){t=this.meshInstances[n];for(i=0;i<t._shader.length;i++)t._shader[i]=null}};e.getParameter=function e(t){return this.parameters[t]};e.setParameter=function e(t,i){if(i===undefined&&typeof t==="object"){var n=t;if(n.length){for(var r=0;r<n.length;r++)this.setParameter(n[r]);return}t=n.name;i=n.value}var s=this.parameters[t];if(s)s.data=i;else this.parameters[t]={scopeId:null,data:i}};e.deleteParameter=function e(t){if(this.parameters[t])delete this.parameters[t]};e.setParameters=function e(t,i){var n,r=this.parameters;if(i===undefined)i=r;for(var s in i){n=r[s];if(n){if(!n.scopeId)n.scopeId=t.scope.resolve(s);n.scopeId.setValue(n.data)}}};e.destroy=function e(){this.variants={};this.shader=null;var t,i;for(var n=0;n<this.meshInstances.length;n++){t=this.meshInstances[n];for(i=0;i<t._shader.length;i++)t._shader[i]=null;t._material=null;var r=s.defaultMaterial;if(this!==r)t.material=r}};U(s,[{key:"shader",get:function e(){return this._shader},set:function e(t){this._shader=t}},{key:"blendType",get:function e(){if(!this.blend&&this.blendSrc===qe&&this.blendDst===Xe&&this.blendEquation===nt)return ml;else if(this.blend&&this.blendSrc===Ze&&this.blendDst===et&&this.blendEquation===nt)return pl;else if(this.blend&&this.blendSrc===qe&&this.blendDst===qe&&this.blendEquation===nt)return dl;else if(this.blend&&this.blendSrc===Ze&&this.blendDst===qe&&this.blendEquation===nt)return gl;else if(this.blend&&this.blendSrc===Qe&&this.blendDst===Ye&&this.blendEquation===nt)return yl;else if(this.blend&&this.blendSrc===$e&&this.blendDst===qe&&this.blendEquation===nt)return bl;else if(this.blend&&this.blendSrc===qe&&this.blendDst===qe&&this.blendEquation===at)return xl;else if(this.blend&&this.blendSrc===qe&&this.blendDst===qe&&this.blendEquation===ot)return Sl;else if(this.blend&&this.blendSrc===Qe&&this.blendDst===Xe&&this.blendEquation===nt)return vl;else if(this.blend&&this.blendSrc===qe&&this.blendDst===et&&this.blendEquation===nt)return _l;return pl},set:function e(t){var i=this.blend;switch(t){case ml:this.blend=false;this.blendSrc=qe;this.blendDst=Xe;this.blendEquation=nt;break;case pl:this.blend=true;this.blendSrc=Ze;this.blendDst=et;this.blendEquation=nt;break;case _l:this.blend=true;this.blendSrc=qe;this.blendDst=et;this.blendEquation=nt;break;case dl:this.blend=true;this.blendSrc=qe;this.blendDst=qe;this.blendEquation=nt;break;case gl:this.blend=true;this.blendSrc=Ze;this.blendDst=qe;this.blendEquation=nt;break;case yl:this.blend=true;this.blendSrc=Qe;this.blendDst=Ye;this.blendEquation=nt;break;case bl:this.blend=true;this.blendSrc=$e;this.blendDst=qe;this.blendEquation=nt;break;case vl:this.blend=true;this.blendSrc=Qe;this.blendDst=Xe;this.blendEquation=nt;break;case xl:this.blend=true;this.blendSrc=qe;this.blendDst=qe;this.blendEquation=at;break;case Sl:this.blend=true;this.blendSrc=qe;this.blendDst=qe;this.blendEquation=ot;break}if(i!==this.blend)if(this._scene)this._scene.layers._dirtyBlend=true;else this._dirtyBlend=true;this._updateMeshInstanceKeys()}}]);return s}();function Au(){this._mapXForms=null}Cu.defaultMaterial=null,Au.prototype.updateMinRef=function(e,t,i,n,r,s,a,o,l){this._updateSharedOptions(e,n,r,a);this._updateMinOptions(e,n);this._updateUVOptions(e,n,r,true)},Au.prototype.updateRef=function(e,t,i,n,r,s,a,o,l){this._updateSharedOptions(e,n,r,a);e.useTexCubeLod=t.useTexCubeLod;this._updateEnvOptions(e,n,i,l);this._updateMaterialOptions(e,n);if(a===uc){if(e.gamma)e.gamma=Rh;e.toneMap=Lh}e.hasTangents=r&&n.normalMap&&(r&Kh)!==0;this._updateLightOptions(e,n,r,o,s);this._updateUVOptions(e,n,r,false);e.clearCoat=n.clearCoat;e.clearCoatGlossiness=n.clearCoatGlossiness},Au.prototype._updateSharedOptions=function(e,t,i,n){e.pass=n;e.alphaTest=t.alphaTest>0;e.forceFragmentPrecision=t.forceFragmentPrecision||"";e.chunks=t.chunks||"";e.blendType=t.blendType;e.forceUv1=t.forceUv1;e.screenSpace=i&&(i&Yh)!==0;e.skin=i&&(i&Uh)!==0;e.useInstancing=i&&(i&jh)!==0;e.useMorphPosition=i&&(i&Qh)!==0;e.useMorphNormal=i&&(i&$h)!==0;e.useMorphTextureBased=i&&(i&Zh)!==0;e.nineSlicedMode=t.nineSlicedMode||0},Au.prototype._updateUVOptions=function(e,t,i,n){var r=false;var s=false;var a=false;if(i){r=(i&Gh)!==0;s=(i&Hh)!==0;a=(i&Wh)!==0}e.vertexColors=false;this._mapXForms=[];for(var o in mu)this._updateTexOptions(e,t,o,r,s,a,n);this._mapXForms=null},Au.prototype._updateMinOptions=function(e,t){e.opacityTint=t.opacity!==1&&t.blendType!==ml;e.lights=[]},Au.prototype._updateMaterialOptions=function(e,t){var i=(t.diffuse.r!==1||t.diffuse.g!==1||t.diffuse.b!==1)&&(t.diffuseTint||!t.diffuseMap&&!t.diffuseVertexColor)?3:0;var n=false;var r=(t.useMetalness?true:!!t.specularMap)||!!t.sphereMap||!!t.cubeMap||!!t.dpAtlas;r=r||(t.useMetalness?true:!(t.specular.r===0&&t.specular.g===0&&t.specular.b===0));r=r||t.enableGGXSpecular;r=r||t.clearCoat>0;if(r)if((t.specularTint||!t.specularMap&&!t.specularVertexColor)&&!t.useMetalness)n=t.specular.r!==1||t.specular.g!==1||t.specular.b!==1;var s=t.emissiveMap?0:3;if(!s){s=(t.emissive.r!==1||t.emissive.g!==1||t.emissive.b!==1||t.emissiveIntensity!==1)&&t.emissiveTint;s=s?3:t.emissiveIntensity!==1?1:0}var a=t.normalMap?t.normalMap.format===Zt||t.normalMap.type===yn:false;e.opacityTint=t.opacity!==1&&t.blendType!==ml?1:0;e.blendMapsWithColors=true;e.ambientTint=t.ambientTint;e.diffuseTint=i;e.specularTint=n?3:0;e.metalnessTint=t.useMetalness&&t.metalness<1?1:0;e.glossTint=1;e.emissiveTint=s;e.alphaToCoverage=t.alphaToCoverage;e.normalizeNormalMap=t.normalizeNormalMap;e.sphereMap=!!t.sphereMap;e.cubeMap=!!t.cubeMap;e.dpAtlas=!!t.dpAtlas;e.ambientSH=!!t.ambientSH;e.useSpecular=r;e.emissiveFormat=t.emissiveMap?t.emissiveMap.type===vn?1:t.emissiveMap.format===ii?2:0:null;e.lightMapFormat=t.lightMap?t.lightMap.type===vn?1:t.lightMap.format===ii?2:0:null;e.specularAntialias=t.specularAntialias&&!!t.normalMap&&!!t.normalMap.mipmaps&&!a;e.conserveEnergy=t.conserveEnergy;e.opacityFadesSpecular=t.opacityFadesSpecular;e.alphaFade=t.alphaFade;e.occludeSpecular=t.occludeSpecular;e.occludeSpecularFloat=t.occludeSpecularIntensity!==1;e.occludeDirect=t.occludeDirect;e.shadingModel=t.shadingModel;e.fresnelModel=t.fresnelModel;e.packedNormal=a;e.fastTbn=t.fastTbn;e.cubeMapProjection=t.cubeMapProjection;e.customFragmentShader=t.customFragmentShader;e.refraction=!!t.refraction;e.useMetalness=t.useMetalness;e.enableGGXSpecular=t.enableGGXSpecular;e.msdf=!!t.msdfMap;e.twoSidedLighting=t.twoSidedLighting;e.pixelSnap=t.pixelSnap;e.aoMapUv=t.aoUvSet;e.diffuseDetail=!!t.diffuseMap;e.normalDetail=!!t.normalMap;e.diffuseDetailMode=t.diffuseDetailMode;e.detailModes=!!e.diffuseDetail;e.clearCoatTint=t.clearCoat!==1?1:0;e.clearCoatGlossTint=t.clearCoatGlossiness!==1?1:0},Au.prototype._updateEnvOptions=function(e,t,i,n){var r=n&&n.type===vn||t.cubeMap&&t.cubeMap.type===vn||t.dpAtlas&&t.dpAtlas.type===vn;var s=n&&(n.type===vn||n.format===ii)||t.cubeMap&&(t.cubeMap.type===vn||t.cubeMap.format===ii)||t.dpAtlas&&(t.dpAtlas.type===vn||t.dpAtlas.format===ii);var a=n&&!t.cubeMap&&!t.sphereMap&&!t.dpAtlas&&n.type===vn||t.cubeMap&&t.cubeMap.type===vn||t.sphereMap&&t.sphereMap.type===vn||t.dpAtlas&&t.dpAtlas.type===vn;var o=(n&&!t.cubeMap&&!t.sphereMap&&!t.dpAtlas?n.type===vn||n.format===ii:false)||t.cubeMap&&(t.cubeMap.type===vn||t.cubeMap.format===ii)||t.sphereMap&&(t.sphereMap.type===vn||t.sphereMap.format===ii)||t.dpAtlas&&(t.dpAtlas.type===vn||t.dpAtlas.format===ii);var l;if(t.useSkybox&&i._skyboxPrefiltered)l=i._skyboxPrefiltered[0];e.fog=t.useFog?i.fog:"none";e.gamma=t.useGammaTonemap?i.gammaCorrection:Ph;e.toneMap=t.useGammaTonemap?i.toneMapping:-1;e.rgbmAmbient=r;e.hdrAmbient=s;e.rgbmReflection=a;e.hdrReflection=o;e.useRgbm=a||r||t.emissiveMap&&t.emissiveMap.type===vn||t.lightMap&&t.lightMap.type===vn;e.fixSeams=n?n.fixCubemapSeams:t.cubeMap?t.cubeMap.fixCubemapSeams:false;e.prefilteredCubemap=!!n;e.skyboxIntensity=n&&l&&n===l&&i.skyboxIntensity!==1;e.useCubeMapRotation=t.useSkybox&&i&&i.skyboxRotation&&!i.skyboxRotation.equals(be.IDENTITY);e.useRightHandedCubeMap=t.cubeMap?t.cubeMap._isRenderTarget:t.useSkybox&&i&&i._skyboxIsRenderTarget},Au.prototype._updateLightOptions=function(e,t,i,n,r){e.lightMap=false;e.lightMapChannel="";e.lightMapUv=0;e.lightMapTransform=0;e.lightMapWithoutAmbient=false;e.dirLightMap=false;if(i){e.noShadow=(i&Vh)!==0;if((i&Xh)!==0){e.lightMapFormat=1;e.lightMap=true;e.lightMapChannel="rgb";e.lightMapUv=1;e.lightMapTransform=0;e.lightMapWithoutAmbient=!t.lightMap;e.useRgbm=true;if((i&qh)!==0)e.dirLightMap=true}}if(t.useLighting){var s=[];var a=i?i>>16:1;if(n){this._collectLights(Nl,n[Nl],s,a);this._collectLights(zl,n[zl],s,a,r);this._collectLights(Ul,n[Ul],s,a,r)}e.lights=s}else e.lights=[];if(e.lights.length===0)e.noShadow=true},Au.prototype._updateTexOptions=function(e,t,i,n,r,s,a){var o=i+"Map";var l=i+"VertexColor";var h=i+"VertexColorChannel";var c=o+"Channel";var u=o+"Transform";var f=o+"Uv";if(i!=="light"){e[o]=false;e[c]="";e[u]=0;e[f]=0}e[l]=false;e[h]="";var d=i==="opacity";if(d&&t.blendType===ml&&t.alphaTest===0&&!t.alphaToCoverage)return e;if(!a||d){if(i!=="height"&&t[l])if(s){e[l]=t[l];e[h]=t[h];e.vertexColors=true}if(t[o]){var p=true;if(t[f]===0&&!n)p=false;if(t[f]===1&&!r)p=false;if(p){e[o]=!!t[o];e[u]=this._getMapTransformID(t[u],t[f]);e[c]=t[c];e[f]=t[f]}}}},Au.prototype._collectLights=function(e,t,i,n,r){var s;var a;for(a=0;a<t.length;a++){s=t[a];if(s.enabled)if(s.mask&n){if(e!==Nl)if(s.isStatic)continue;i.push(s)}}if(r)for(a=0;a<r.length;a++){s=r[a];if(s._type===e)i.push(s)}},Au.prototype._getMapTransformID=function(e,t){if(!e)return 0;if(!this._mapXForms[t])this._mapXForms[t]=[];var i,n;for(i=0;i<this._mapXForms[t].length;i++){n=true;if(this._mapXForms[t][i][0]!=e.x){n=false;break}if(this._mapXForms[t][i][1]!=e.y){n=false;break}if(this._mapXForms[t][i][2]!=e.z){n=false;break}if(this._mapXForms[t][i][3]!=e.w){n=false;break}if(n)return i+1}var r=this._mapXForms[t].length;this._mapXForms[t][r]=[];this._mapXForms[t][r][0]=e.x;this._mapXForms[t][r][1]=e.y;this._mapXForms[t][r][2]=e.z;this._mapXForms[t][r][3]=e.w;return r+1};var Pu=function(){function e(){this._refCount=0}var t=e.prototype;t.incRefCount=function e(){this._refCount++};t.decRefCount=function e(){this._refCount--};t.getRefCount=function e(){return this._refCount};return e}(),Eu=function(){function e(e,t,i,n,r){if(n===void 0)n=lt;this.device=e;this.format=t;this.numIndices=i;this.usage=n;var s=this.device.gl;var a;if(t===zt){a=1;this.glFormat=s.UNSIGNED_BYTE}else if(t===Vt){a=2;this.glFormat=s.UNSIGNED_SHORT}else if(t===Ut){a=4;this.glFormat=s.UNSIGNED_INT}this.bytesPerIndex=a;this.numBytes=this.numIndices*a;if(r)this.setData(r);else this.storage=new ArrayBuffer(this.numBytes);e._vram.ib+=this.numBytes;this.device.buffers.push(this)}var t=e.prototype;t.destroy=function e(){var t=this.device;var i=t.buffers.indexOf(this);if(i!==-1)t.buffers.splice(i,1);if(this.bufferId){var n=this.device.gl;n.deleteBuffer(this.bufferId);this.device._vram.ib-=this.storage.byteLength;this.bufferId=null;if(this.device.indexBuffer===this)this.device.indexBuffer=null}};t.loseContext=function e(){this.bufferId=undefined};t.getFormat=function e(){return this.format};t.getNumIndices=function e(){return this.numIndices};t.lock=function e(){return this.storage};t.unlock=function e(){var t=this.device.gl;if(!this.bufferId)this.bufferId=t.createBuffer();var i;switch(this.usage){case lt:i=t.STATIC_DRAW;break;case ht:i=t.DYNAMIC_DRAW;break;case ct:i=t.STREAM_DRAW;break;case ut:if(this.device.webgl2)i=t.DYNAMIC_COPY;else i=t.STATIC_DRAW;break}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId);t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,i)};t.setData=function e(t){if(t.byteLength!==this.numBytes)return false;this.storage=t;this.unlock();return true};t._lockTypedArray=function e(){var t=this.lock();var i=this.format===Ut?new Uint32Array(t):this.format===Vt?new Uint16Array(t):new Uint8Array(t);return i};t.writeData=function e(t,i){var n=this._lockTypedArray();if(t.length>i)if(ArrayBuffer.isView(t)){t=t.subarray(0,i);n.set(t)}else{var r;for(r=0;r<i;r++)n[r]=t[r]}else n.set(t);this.unlock()};t.readData=function e(t){var i=this._lockTypedArray();var n=this.numIndices;if(ArrayBuffer.isView(t))t.set(i);else{t.length=0;var r;for(r=0;r<n;r++)t[r]=i[r]}return n};return e}(),Iu=0,Ru=function(){function e(){this.initDefaults()}var t=e.prototype;t.initDefaults=function e(){this.recreate=false;this.verticesUsage=lt;this.indicesUsage=lt;this.maxVertices=0;this.maxIndices=0;this.vertexCount=0;this.indexCount=0;this.vertexStreamsUpdated=false;this.indexStreamUpdated=false;this.vertexStreamDictionary={};this.indices=null};t._validateVertexCount=function e(t,i){};t._changeVertexCount=function e(t,i){if(!this.vertexCount)this.vertexCount=t;else this._validateVertexCount(t,i)};return e}();Ru.DEFAULT_COMPONENTS_POSITION=3,Ru.DEFAULT_COMPONENTS_NORMAL=3,Ru.DEFAULT_COMPONENTS_UV=2,Ru.DEFAULT_COMPONENTS_COLORS=4;var Lu=function e(t,i,n,r){this.data=t;this.componentCount=i;this.dataType=n;this.dataTypeNormalize=r},Du=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t.id=Iu++;t.device=e||rM.getApplication().graphicsDevice;t.vertexBuffer=null;t.indexBuffer=[null];t.primitive=[{type:0,base:0,count:0}];t.skin=null;t.morph=null;t._geometryData=null;t._aabb=new Ce;t.boneAabb=null;return t}var t=e.prototype;t.destroy=function e(){if(this.vertexBuffer){this.vertexBuffer.destroy();this.vertexBuffer=null}var t,i;for(t=0;t<this.indexBuffer.length;t++){i=this.indexBuffer[t];if(i)i.destroy()}this.indexBuffer.length=0;this._geometryData=null};t._initBoneAabbs=function e(t){this.boneAabb=[];this.boneUsed=[];var i=this.vertexBuffer.numVertices;var n,r,s,a;var o,l,h;var c,u;var f=[];var d=[];var p=this.boneUsed;var m=this.skin.boneNames.length;var _;var v,g;var y,b,x;var S,w,T;var M,C,A;var P;for(n=0;n<m;n++){f[n]=new ce(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);d[n]=new ce(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}var E=new Tr(this.vertexBuffer);var I=E.element[Ci];var R=E.element[Ei];var L=E.element[Ii];for(r=0;r<i;r++){for(s=0;s<4;s++){v=R.array[R.index+s];if(v>0){g=L.array[L.index+s];p[g]=true;o=I.array[I.index];l=I.array[I.index+1];h=I.array[I.index+2];c=d[g];u=f[g];if(u.x>o)u.x=o;if(u.y>l)u.y=l;if(u.z>h)u.z=h;if(c.x<o)c.x=o;if(c.y<l)c.y=l;if(c.z<h)c.z=h;if(t){y=S=o;b=w=l;x=T=h;for(a=0;a<t.length;a++){P=t[a];M=P.deltaPositions[r*3];C=P.deltaPositions[r*3+1];A=P.deltaPositions[r*3+2];if(M<0)y+=M;else S+=M;if(C<0)b+=C;else w+=C;if(A<0)x+=A;else T+=A}if(u.x>y)u.x=y;if(u.y>b)u.y=b;if(u.z>x)u.z=x;if(c.x<S)c.x=S;if(c.y<w)c.y=w;if(c.z<T)c.z=T}}}E.next()}for(n=0;n<m;n++){_=new Ce;_.setMinMax(f[n],d[n]);this.boneAabb.push(_)}};t._initGeometryData=function e(){if(!this._geometryData){this._geometryData=new Ru;if(this.vertexBuffer){this._geometryData.vertexCount=this.vertexBuffer.numVertices;this._geometryData.maxVertices=this.vertexBuffer.numVertices}if(this.indexBuffer.length>0&&this.indexBuffer[0]){this._geometryData.indexCount=this.indexBuffer[0].numIndices;this._geometryData.maxIndices=this.indexBuffer[0].numIndices}}};t.clear=function e(t,i,n,r){if(n===void 0)n=0;if(r===void 0)r=0;this._initGeometryData();this._geometryData.initDefaults();this._geometryData.recreate=true;this._geometryData.maxVertices=n;this._geometryData.maxIndices=r;this._geometryData.verticesUsage=t?lt:ht;this._geometryData.indicesUsage=i?lt:ht};t.setVertexStream=function e(t,i,n,r,s,a){if(s===void 0)s=In;if(a===void 0)a=false;this._initGeometryData();var o=r||i.length/n;this._geometryData._changeVertexCount(o,t);this._geometryData.vertexStreamsUpdated=true;this._geometryData.vertexStreamDictionary[t]=new Lu(i,n,s,a)};t.getVertexStream=function e(t,i){var n=0;var r=false;if(this._geometryData){var s=this._geometryData.vertexStreamDictionary[t];if(s){r=true;n=this._geometryData.vertexCount;if(ArrayBuffer.isView(i))i.set(s.data);else{i.length=0;i.push(s.data)}}}if(!r)if(this.vertexBuffer){var a=new Tr(this.vertexBuffer);n=a.readData(t,i)}return n};t.setPositions=function e(t,i,n){if(i===void 0)i=Ru.DEFAULT_COMPONENTS_POSITION;this.setVertexStream(Ci,t,i,n,In,false)};t.setNormals=function e(t,i,n){if(i===void 0)i=Ru.DEFAULT_COMPONENTS_NORMAL;this.setVertexStream(Ai,t,i,n,In,false)};t.setUvs=function e(t,i,n,r){if(n===void 0)n=Ru.DEFAULT_COMPONENTS_UV;this.setVertexStream(Li+t,i,n,r,In,false)};t.setColors=function e(t,i,n){if(i===void 0)i=Ru.DEFAULT_COMPONENTS_COLORS;this.setVertexStream(Ri,t,i,n,In,false)};t.setColors32=function e(t,i){this.setVertexStream(Ri,t,Ru.DEFAULT_COMPONENTS_COLORS,i,Mn,true)};t.setIndices=function e(t,i){this._initGeometryData();this._geometryData.indexStreamUpdated=true;this._geometryData.indices=t;this._geometryData.indexCount=i||t.length};t.getPositions=function e(t){return this.getVertexStream(Ci,t)};t.getNormals=function e(t){return this.getVertexStream(Ai,t)};t.getUvs=function e(t,i){return this.getVertexStream(Li+t,i)};t.getColors=function e(t){return this.getVertexStream(Ri,t)};t.getIndices=function e(t){var i=0;if(this._geometryData&&this._geometryData.indices){var n=this._geometryData.indices;i=this._geometryData.indexCount;if(ArrayBuffer.isView(t))t.set(n);else{t.length=0;t.push(n)}}else if(this.indexBuffer.length>0&&this.indexBuffer[0]){var r=this.indexBuffer[0];i=r.readData(t)}return i};t.update=function e(t,i){if(t===void 0)t=wi;if(i===void 0)i=true;if(this._geometryData){if(i){var n=this._geometryData.vertexStreamDictionary[Ci];if(n)if(n.componentCount==3)this._aabb.compute(n.data,this._geometryData.vertexCount)}var r=this._geometryData.recreate;if(this._geometryData.vertexCount>this._geometryData.maxVertices){r=true;this._geometryData.maxVertices=this._geometryData.vertexCount}if(r)if(this.vertexBuffer){this.vertexBuffer.destroy();this.vertexBuffer=null}var s=this._geometryData.recreate;if(this._geometryData.indexCount>this._geometryData.maxIndices){s=true;this._geometryData.maxIndices=this._geometryData.indexCount}if(s)if(this.indexBuffer.length>0&&this.indexBuffer[0]){this.indexBuffer[0].destroy();this.indexBuffer[0]=null}if(this._geometryData.vertexStreamsUpdated)this._updateVertexBuffer();if(this._geometryData.indexStreamUpdated)this._updateIndexBuffer();this.primitive[0].type=t;if(this.indexBuffer.length>0&&this.indexBuffer[0]){if(this._geometryData.indexStreamUpdated){this.primitive[0].count=this._geometryData.indexCount;this.primitive[0].indexed=true}}else if(this._geometryData.vertexStreamsUpdated){this.primitive[0].count=this._geometryData.vertexCount;this.primitive[0].indexed=false}this._geometryData.vertexCount=0;this._geometryData.indexCount=0;this._geometryData.vertexStreamsUpdated=false;this._geometryData.indexStreamUpdated=false;this._geometryData.recreate=false}};t._buildVertexFormat=function e(t){var i=[];for(var n in this._geometryData.vertexStreamDictionary){var r=this._geometryData.vertexStreamDictionary[n];i.push({semantic:n,components:r.componentCount,type:r.dataType,normalize:r.dataTypeNormalize})}return new cr(this.device,i,t)};t._updateVertexBuffer=function e(){if(!this.vertexBuffer){var t=this._geometryData.maxVertices;var i=this._buildVertexFormat(t);this.vertexBuffer=new lr(this.device,i,t,this._geometryData.verticesUsage)}var n=new Tr(this.vertexBuffer);var r=this._geometryData.vertexCount;for(var s in this._geometryData.vertexStreamDictionary){var a=this._geometryData.vertexStreamDictionary[s];n.writeData(s,a.data,r);delete this._geometryData.vertexStreamDictionary[s]}n.end()};t._updateIndexBuffer=function e(){if(this.indexBuffer.length<=0||!this.indexBuffer[0]){var t=this._geometryData.maxVertices>65535?Ut:Vt;this.indexBuffer[0]=new Eu(this.device,t,this._geometryData.maxIndices,this._geometryData.indicesUsage)}var i=this._geometryData.indices;if(i){var n=this.indexBuffer[0];n.writeData(i,this._geometryData.indexCount);this._geometryData.indices=null}};t.generateWireframe=function e(){var t=function e(t){switch(t.format){case zt:return new Uint8Array(t.storage);case Vt:return new Uint16Array(t.storage);case Ut:return new Uint32Array(t.storage);default:return null}};var i=[];var n;if(this.indexBuffer.length>0&&this.indexBuffer[0]){var r=[[0,1],[1,2],[2,0]];var s=this.primitive[mh].base;var a=this.primitive[mh].count;var o=this.indexBuffer[mh];var l=t(o);var h={};for(var c=s;c<s+a;c+=3)for(var u=0;u<3;u++){var f=l[c+r[u][0]];var d=l[c+r[u][1]];var p=f>d?d<<16|f:f<<16|d;if(h[p]===undefined){h[p]=0;i.push(f,d)}}n=o.format}else{for(var m=0;m<this.vertexBuffer.numVertices;m+=3)i.push(m,m+1,m+1,m+2,m+2,m);n=i.length>65535?Ut:Vt}var _=new Eu(this.vertexBuffer.device,n,i.length);var v=t(_);v.set(i);_.unlock();this.primitive[_h]={type:bi,base:0,count:i.length,indexed:true};this.indexBuffer[_h]=_};U(e,[{key:"aabb",get:function e(){return this._aabb},set:function e(t){this._aabb=t}}]);return e}(Pu),ku=new Ce,Ou=new Ce,Fu=new De,Bu=function e(t){this.count=t;this.vertexBuffer=null},Nu=function(){function e(e,t,i){this._key=[];this._key[sc]=Vu(e,t,true,0);this.command=i}U(e,[{key:"key",get:function e(){return this._key[sc]},set:function e(t){this._key[sc]=t}}]);return e}(),zu=function(){function e(e,t,i){this._key=[0,0];this._shader=[null,null,null];this.isStatic=false;this._staticLightList=null;this._staticSource=null;this.node=e;this._mesh=t;t.incRefCount();this.material=i;this._shaderDefs=oc<<16;this._shaderDefs|=t.vertexBuffer.format.hasUv0?Gh:0;this._shaderDefs|=t.vertexBuffer.format.hasUv1?Hh:0;this._shaderDefs|=t.vertexBuffer.format.hasColor?Wh:0;this._shaderDefs|=t.vertexBuffer.format.hasTangents?Kh:0;this._lightHash=0;this.visible=true;this.layer=Ll;this.renderStyle=mh;this.castShadow=false;this._receiveShadow=true;this._screenSpace=false;this._noDepthDrawGl1=false;this.cull=true;this.pick=true;this._updateAabb=true;this._updateAabbFunc=null;this._calculateSortDistance=null;this.updateKey();this._skinInstance=null;this._morphInstance=null;this.instancingData=null;this.aabb=new Ce;this._aabbVer=-1;this.drawOrder=0;this.visibleThisFrame=0;this.isVisibleFunc=null;this.parameters={};this.stencilFront=null;this.stencilBack=null;this.flipFaces=false}var t=e.prototype;t.destroy=function e(){var t=this.mesh;if(t){this.mesh=null;if(t.getRefCount()<1)t.destroy()}if(this._skinInstance){this._skinInstance.destroy();this._skinInstance=null}if(this.morphInstance){this.morphInstance.destroy();this.morphInstance=null}this.material=null};t.syncAabb=function e(){};t._isVisible=function e(t){if(this.visible){if(this.isVisibleFunc)return this.isVisibleFunc(t);var i=this.aabb.center;if(this._aabb._radiusVer!==this._aabbVer){this._aabb._radius=this._aabb.halfExtents.length();this._aabb._radiusVer=this._aabbVer}Fu.radius=this._aabb._radius;Fu.center=i;return t.frustum.containsSphere(Fu)}return false};t.updateKey=function e(){var t=this.material;this._key[sc]=Vu(this.layer,t.alphaToCoverage||t.alphaTest?pl:t.blendType,false,t.id)};t.setInstancing=function e(t){if(t){this.instancingData=new Bu(t.numVertices);this.instancingData.vertexBuffer=t;t.instancing=true;this.cull=false}else{this.instancingData=null;this.cull=true}};t.clearParameters=function e(){this.parameters={}};t.getParameters=function e(){return this.parameters};t.getParameter=function e(t){return this.parameters[t]};t.setParameter=function e(t,i,n){if(n===void 0)n=-524285;if(i===undefined&&typeof t==="object"){var r=t;if(r.length){for(var s=0;s<r.length;s++)this.setParameter(r[s]);return}t=r.name;i=r.value}var a=this.parameters[t];if(a){a.data=i;a.passFlags=n}else this.parameters[t]={scopeId:null,data:i,passFlags:n}};t.deleteParameter=function e(t){if(this.parameters[t])delete this.parameters[t]};t.setParameters=function e(t,i){var n,r=this.parameters;for(var s in r){n=r[s];if(n.passFlags&i){if(!n.scopeId)n.scopeId=t.scope.resolve(s);n.scopeId.setValue(n.data)}}};t.setLightmapped=function e(t){if(t)this.mask=(this.mask|lc)&~(oc|hc);else{this.deleteParameter("texture_lightMap");this.deleteParameter("texture_dirLightMap");this._shaderDefs&=~Xh;this.mask=(this.mask|oc)&~(lc|hc)}};t.setOverrideAabb=function e(t){this._updateAabb=!t;if(t)this.aabb.copy(t);this._setupSkinUpdate()};t._setupSkinUpdate=function e(){if(this._skinInstance)this._skinInstance._updateBeforeCull=this._updateAabb};U(e,[{key:"mesh",get:function e(){return this._mesh},set:function e(t){if(t===this._mesh)return;if(this._mesh)this._mesh.decRefCount();this._mesh=t;if(t)t.incRefCount()}},{key:"aabb",get:function e(){var t;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){if(!this.mesh.boneAabb){var i=this._morphInstance?this._morphInstance.morph._targets:null;this.mesh._initBoneAabbs(i)}var n=this.mesh.boneUsed;var r=this.node.getWorldTransform();var s=true;for(t=0;t<this.mesh.boneAabb.length;t++)if(n[t]){Ou.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]);if(s){s=false;ku.center.copy(Ou.center);ku.halfExtents.copy(Ou.halfExtents)}else ku.add(Ou)}this._aabb.setFromTransformedAabb(ku,r)}else if(this.node._aabbVer!==this._aabbVer){if(this.mesh){ku.center.copy(this.mesh.aabb.center);ku.halfExtents.copy(this.mesh.aabb.halfExtents)}else{ku.center.set(0,0,0);ku.halfExtents.set(0,0,0)}if(this.mesh&&this.mesh.morph)ku._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax());this._aabb.setFromTransformedAabb(ku,this.node.getWorldTransform());this._aabbVer=this.node._aabbVer}return this._aabb},set:function e(t){this._aabb=t}},{key:"material",get:function e(){return this._material},set:function e(t){var i;for(i=0;i<this._shader.length;i++)this._shader[i]=null;if(this._material){var n=this._material.meshInstances;i=n.indexOf(this);if(i!==-1)n.splice(i,1)}var r=this._material;this._material=t;if(this._material){this._material.meshInstances.push(this);this.updateKey();var s=r&&r.blendType!==ml;var a=this._material.blendType!==ml;if(s!==a){var o=this._material._scene;if(!o&&r&&r._scene)o=r._scene;if(o)o.layers._dirtyBlend=true;else this._material._dirtyBlend=true}}}},{key:"layer",get:function e(){return this._layer},set:function e(t){this._layer=t;this.updateKey()}},{key:"calculateSortDistance",get:function e(){return this._calculateSortDistance},set:function e(t){this._calculateSortDistance=t}},{key:"receiveShadow",get:function e(){return this._receiveShadow},set:function e(t){this._receiveShadow=t;this._shaderDefs=t?this._shaderDefs&~Vh:this._shaderDefs|Vh;this._shader[cc]=null;this._shader[uc]=null}},{key:"skinInstance",get:function e(){return this._skinInstance},set:function e(t){this._skinInstance=t;this._shaderDefs=t?this._shaderDefs|Uh:this._shaderDefs&~Uh;for(var i=0;i<this._shader.length;i++)this._shader[i]=null;this._setupSkinUpdate()}},{key:"morphInstance",get:function e(){return this._morphInstance},set:function e(t){this._morphInstance=t;if(this._morphInstance)this._morphInstance.meshInstance=this;this._shaderDefs=t&&t.morph.useTextureMorph?this._shaderDefs|Zh:this._shaderDefs&~Zh;this._shaderDefs=t&&t.morph.morphPositions?this._shaderDefs|Qh:this._shaderDefs&~Qh;this._shaderDefs=t&&t.morph.morphNormals?this._shaderDefs|$h:this._shaderDefs&~$h;for(var i=0;i<this._shader.length;i++)this._shader[i]=null}},{key:"screenSpace",get:function e(){return this._screenSpace},set:function e(t){this._screenSpace=t;this._shaderDefs=t?this._shaderDefs|Yh:this._shaderDefs&~Yh;this._shader[cc]=null}},{key:"key",get:function e(){return this._key[sc]},set:function e(t){this._key[sc]=t}},{key:"mask",get:function e(){return this._shaderDefs>>16},set:function e(t){var i=this._shaderDefs&65535;this._shaderDefs=i|t<<16;this._shader[cc]=null;this._shader[uc]=null}},{key:"instancingCount",get:function e(){return this.instancingData?this.instancingData.count:0},set:function e(t){if(this.instancingData)this.instancingData.count=t}}]);return e}();function Vu(e,t,i,n){return(e&15)<<27|(t===ml?1:0)<<26|(i?1:0)<<25|(n&33554431)<<0}var Uu=function(n){G(w,n);function w(e,t){var i;i=n.call(this)||this;i.device=t||rM.getApplication().graphicsDevice;i._targets=e;if(i.device.supportsMorphTargetTexturesCore){if(i.device.extTextureHalfFloat&&i.device.textureHalfFloatRenderable)i._renderTextureFormat=w.FORMAT_HALF_FLOAT;else if(i.device.extTextureFloat&&i.device.textureFloatRenderable)i._renderTextureFormat=w.FORMAT_FLOAT;if(i.device.extTextureHalfFloat&&i.device.textureHalfFloatUpdatable)i._textureFormat=w.FORMAT_HALF_FLOAT;else if(i.device.extTextureFloat)i._textureFormat=w.FORMAT_FLOAT;if(i._renderTextureFormat!==undefined&&i._textureFormat!==undefined)i._useTextureMorph=true}i._init();i._updateMorphFlags();i._calculateAabb();return i}var e=w.prototype;e._init=function e(){if(this._useTextureMorph)this._useTextureMorph=this._initTextureBased();var t;if(!this._useTextureMorph)for(t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(t=0;t<this._targets.length;t++)this._targets[t]._postInit()};e._initTextureBased=function e(){var t,i,n;var r=[],s=[];for(i=0;i<this._targets.length;i++){t=this._targets[i];if(t.options.deltaPositions){r.push(t.options.deltaPositions);s.push({target:t,name:"texturePositions"})}if(t.options.deltaNormals){r.push(t.options.deltaNormals);s.push({target:t,name:"textureNormals"})}}var a=[],o=[];var l,h;var c=1;var u=r[0].length;for(n=0;n<u;n+=3){l=false;for(i=0;i<r.length;i++){h=r[i];if(h[n]!==0||h[n+1]!==0||h[n+2]!==0){l=true;break}}if(l){a.push(c);o.push(n/3);c++}else a.push(0)}var f=Math.min(this.device.maxTextureSize,4096);var d=Math.ceil(Math.sqrt(c));d=Math.min(d,f);var p=Math.ceil(c/d);if(p>f)return false;this.morphTextureWidth=d;this.morphTextureHeight=p;var m=false;var _=3;var v=Pe.float2Half;if(this._textureFormat===w.FORMAT_HALF_FLOAT){m=true;_=4}var g=this.morphTextureWidth*this.morphTextureHeight*_;var y=m?new Uint16Array(g):new Float32Array(g);for(i=0;i<r.length;i++){h=r[i];for(n=0;n<o.length;n++){var b=o[n];if(m){y[n*_+_]=v(h[b*3]);y[n*_+_+1]=v(h[b*3+1]);y[n*_+_+2]=v(h[b*3+2])}else{y[n*_+_]=h[b*3];y[n*_+_+1]=h[b*3+1];y[n*_+_+2]=h[b*3+2]}}t=s[i].target;var x=this._textureFormat===w.FORMAT_FLOAT?ti:ei;t._setTexture(s[i].name,this._createTexture("MorphTarget",x,y))}var S=[{semantic:rn,components:1,type:In}];this.vertexBufferIds=new lr(this.device,new cr(this.device,S),a.length,lt,new Float32Array(a));return true};e.destroy=function e(){if(this.vertexBufferIds){this.vertexBufferIds.destroy();this.vertexBufferIds=null}for(var t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0};e.getTarget=function e(t){return this._targets[t]};e._updateMorphFlags=function e(){this._morphPositions=false;this._morphNormals=false;var t;for(var i=0;i<this._targets.length;i++){t=this._targets[i];if(t.morphPositions)this._morphPositions=true;if(t.morphNormals)this._morphNormals=true}};e._calculateAabb=function e(){this.aabb=new Ce(new ce(0,0,0),new ce(0,0,0));var t;for(var i=0;i<this._targets.length;i++){t=this._targets[i];this.aabb._expand(t.aabb.getMin(),t.aabb.getMax())}};e._createTexture=function e(t,i,n){var r=new bu(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:i,cubemap:false,mipmaps:false,minFilter:Mt,magFilter:Mt,addressU:We,addressV:We});r.name=t;if(n){var s=r.lock();s.set(n);r.unlock()}return r};U(w,[{key:"morphPositions",get:function e(){return this._morphPositions}},{key:"morphNormals",get:function e(){return this._morphNormals}},{key:"maxActiveTargets",get:function e(){if(this._useTextureMorph)return this._targets.length;return this._morphPositions&&this._morphNormals?4:8}},{key:"useTextureMorph",get:function e(){return this._useTextureMorph}}]);return w}(Pu);Uu.FORMAT_FLOAT=0,Uu.FORMAT_HALF_FLOAT=1;var Gu="attribute vec2 vertex_position;\n"+"varying vec2 uv0;\n"+"void main(void) {\n"+"\t\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n"+"\t\tuv0 = vertex_position.xy * 0.5 + 0.5;\n"+"}\n",Hu=function(){function t(n){this.morph=n;n.incRefCount();this.device=n.device;this.meshInstance=null;this._weights=[];for(var e=0;e<n._targets.length;e++)this.setWeight(e,n._targets[e].defaultWeight);this._activeTargets=[];if(n.useTextureMorph){this.shaderCache={};this.maxSubmitCount=this.device.maxTextures;this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);var t=function(e,t){var i=n._renderTextureFormat===Uu.FORMAT_FLOAT?ii:ei;this[t]=n._createTexture(e,i);return new BM({colorBuffer:this[t],depth:false})}.bind(this);if(n.morphPositions)this.rtPositions=t("MorphRTPos","texturePositions");if(n.morphNormals)this.rtNormals=t("MorphRTNrm","textureNormals");this._textureParams=new Float32Array([n.morphTextureWidth,n.morphTextureHeight,1/n.morphTextureWidth,1/n.morphTextureHeight]);for(var i=0;i<this.maxSubmitCount;i++)this["morphBlendTex"+i]=this.device.scope.resolve("morphBlendTex"+i);this.morphFactor=this.device.scope.resolve("morphFactor[0]");this.zeroTextures=false}else{this.maxSubmitCount=8;this._shaderMorphWeights=new Float32Array(this.maxSubmitCount);this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4);this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,4*4,4);this._activeVertexBuffers=new Array(this.maxSubmitCount)}}var e=t.prototype;e.destroy=function e(){this.meshInstance=null;this.shader=null;var t=this.morph;if(t){this.morph=null;t.decRefCount();if(t.getRefCount()<1)t.destroy()}if(this.rtPositions){this.rtPositions.destroy();this.rtPositions=null}if(this.texturePositions){this.texturePositions.destroy();this.texturePositions=null}if(this.rtNormals){this.rtNormals.destroy();this.rtNormals=null}if(this.textureNormals){this.textureNormals.destroy();this.textureNormals=null}};e.clone=function e(){var e=new t(this.morph);return e};e.getWeight=function e(t){return this._weights[t]};e.setWeight=function e(t,i){this._weights[t]=i;this._dirty=true};e._getFragmentShader=function e(t){var i,n="";if(t>0)n+="varying vec2 uv0;\n"+"uniform highp float morphFactor["+t+"];\n";for(i=0;i<t;i++)n+="uniform highp sampler2D morphBlendTex"+i+";\n";n+="void main (void) {\n"+"\t\thighp vec4 color = vec4(0, 0, 0, 1);\n";for(i=0;i<t;i++)n+="\t\tcolor.xyz += morphFactor["+i+"] * texture2D(morphBlendTex"+i+", uv0).xyz;\n";n+="\t\tgl_FragColor = color;\n"+"}\n";return n};e._getShader=function e(t){var i=this.shaderCache[t];if(!i){var n=this._getFragmentShader(t);i=Qc(this.device,Gu,n,"textureMorph"+t);this.shaderCache[t]=i}return i};e._updateTextureRenderTarget=function e(n,t){var r=this.device;var i=function(e,t){this.morphFactor.setValue(this._shaderMorphWeights);r.setBlending(t);if(t){r.setBlendFunction(qe,qe);r.setBlendEquation(nt)}var i=this._getShader(e);Ar(r,n,i,undefined,undefined,t)}.bind(this);var s=0;var a=false;var o=this._activeTargets.length;for(var l=0;l<o;l++){var h=this._activeTargets[l];var c=h.target[t];if(c){this["morphBlendTex"+s].setValue(c);this._shaderMorphWeights[s]=h.weight;s++;if(s>=this.maxSubmitCount){i(s,a);s=0;a=true}}}if(s>0||o===0&&!this.zeroTextures)i(s,a)};e._updateTextureMorph=function e(){var t=this.device;if(this._activeTargets.length>0||!this.zeroTextures){this._updateTextureRenderTarget(this.rtPositions,"texturePositions");this._updateTextureRenderTarget(this.rtNormals,"textureNormals");this.zeroTextures=this._activeTargets.length===0}};e._updateVertexMorph=function e(){var t,i=this.maxSubmitCount;for(t=0;t<i;t++){this._shaderMorphWeights[t]=0;this._activeVertexBuffers[t]=null}var n=0;var r=this.morph.morphPositions?4:0;var s;for(t=0;t<this._activeTargets.length;t++){s=this._activeTargets[t].target;if(s._vertexBufferPositions){this._activeVertexBuffers[n]=s._vertexBufferPositions;this._shaderMorphWeights[n]=this._activeTargets[t].weight;n++}if(s._vertexBufferNormals){this._activeVertexBuffers[r]=s._vertexBufferNormals;this._shaderMorphWeights[r]=this._activeTargets[t].weight;r++}}};e.update=function e(){this._dirty=false;var t=this.morph._targets;var i=0,n;var r,s,a=1e-5;for(r=0;r<t.length;r++){s=Math.abs(this.getWeight(r));if(s>a){if(this._activeTargets.length<=i)this._activeTargets[i]={};n=this._activeTargets[i++];n.absWeight=s;n.weight=this.getWeight(r);n.target=t[r]}}this._activeTargets.length=i;var o=this.morph.maxActiveTargets;if(this._activeTargets.length>o){this._activeTargets.sort(function(e,t){return e.absWeight<t.absWeight?1:t.absWeight<e.absWeight?-1:0});this._activeTargets.length=o}if(this.morph.useTextureMorph)this._updateTextureMorph();else this._updateVertexMorph()};return t}(),Wu=new ve,ju=function(){function e(e){this._dirty=true;this._skinUpdateIndex=-1;this._updateBeforeCull=true;if(e)this.initSkin(e)}var t=e.prototype;t.init=function e(t,i){if(t.supportsBoneTextures){var n=i*3;var r=Math.ceil(Math.sqrt(n));r=Pe.roundUp(r,3);var s=Math.ceil(n/r);this.boneTexture=new bu(t,{width:r,height:s,format:ii,mipmaps:false,minFilter:Mt,magFilter:Mt});this.boneTexture.name="skin";this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(i*12)};t.destroy=function e(){if(this.boneTexture){this.boneTexture.destroy();this.boneTexture=null}};t.initSkin=function e(t){this.skin=t;this.bones=[];var i=t.inverseBindPose.length;this.init(t.device,i);this.matrices=[];for(var n=0;n<i;n++)this.matrices[n]=new ve};t.uploadBones=function e(t){if(t.supportsBoneTextures){this.boneTexture.lock();this.boneTexture.unlock()}};t._updateMatrices=function e(t,i){if(this._skinUpdateIndex!==i){this._skinUpdateIndex=i;Wu.copy(t.getWorldTransform()).invert();for(var n=this.bones.length-1;n>=0;n--){this.matrices[n].mulAffine2(Wu,this.bones[n].getWorldTransform());this.matrices[n].mulAffine2(this.matrices[n],this.skin.inverseBindPose[n])}}};t.updateMatrices=function e(t,i){if(this._updateBeforeCull)this._updateMatrices(t,i)};t.updateMatrixPalette=function e(t,i){this._updateMatrices(t,i);var n;var r=this.matrixPalette;var s;var a=this.bones.length;for(var o=0;o<a;o++){n=this.matrices[o].data;s=o*12;r[s]=n[0];r[s+1]=n[4];r[s+2]=n[8];r[s+3]=n[12];r[s+4]=n[1];r[s+5]=n[5];r[s+6]=n[9];r[s+7]=n[13];r[s+8]=n[2];r[s+9]=n[6];r[s+10]=n[10];r[s+11]=n[14]}this.uploadBones(this.skin.device)};return e}(),Xu=function(){function S(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0;this._immutable=false}var e=S.prototype;e.getGraph=function e(){return this.graph};e.setGraph=function e(t){this.graph=t};e.getCameras=function e(){return this.cameras};e.setCameras=function e(t){this.cameras=t};e.getLights=function e(){return this.lights};e.setLights=function e(t){this.lights=t};e.getMaterials=function e(){var t;var i=[];for(t=0;t<this.meshInstances.length;t++){var n=this.meshInstances[t];if(i.indexOf(n.material)===-1)i.push(n.material)}return i};e.clone=function e(){var t,i;var r=[];var s=[];var n=function e(t){var i=t.clone();r.push(t);s.push(i);for(var n=0;n<t._children.length;n++)i.addChild(e(t._children[n]));return i};var a=n(this.graph);var o=[];var l=[];var h=[];for(t=0;t<this.skinInstances.length;t++){var c=this.skinInstances[t].skin;var u=new ju(c);var f=[];for(i=0;i<c.boneNames.length;i++){var d=c.boneNames[i];var p=a.findByName(d);f.push(p)}u.bones=f;l.push(u)}for(t=0;t<this.morphInstances.length;t++){var m=this.morphInstances[t].morph;var _=new Hu(m);h.push(_)}for(t=0;t<this.meshInstances.length;t++){var v=this.meshInstances[t];var g=r.indexOf(v.node);var y=new zu(s[g],v.mesh,v.material);if(v.skinInstance){var b=this.skinInstances.indexOf(v.skinInstance);y.skinInstance=l[b]}if(v.morphInstance){var x=this.morphInstances.indexOf(v.morphInstance);y.morphInstance=h[x]}o.push(y)}var e=new S;e.graph=a;e.meshInstances=o;e.skinInstances=l;e.morphInstances=h;e.getGraph().syncHierarchy();return e};e.destroy=function e(){var t=this.meshInstances;for(var i=0;i<t.length;i++)t[i].destroy();this.meshInstances.length=0};e.generateWireframe=function e(){var t;var i;var n=[];for(t=0;t<this.meshInstances.length;t++){i=this.meshInstances[t].mesh;if(n.indexOf(i)===-1)n.push(i)}for(t=0;t<n.length;++t){i=n[t];if(!i.primitive[_h])i.generateWireframe()}};return S}(),qu=function e(t,i,n){this.origMeshInstances=t;this._aabb=new Ce;this.meshInstance=null;this.model=null;this.dynamic=i;this.batchGroupId=n},Yu=function e(t,i,n,r,s){if(s===void 0)s=[Dl];this.dynamic=n;this.maxAabbSize=r;this.id=t;this.name=i;this.layers=s;this._ui=false;this._sprite=false;this._obj={model:[],element:[],sprite:[],render:[]}};Yu.MODEL="model",Yu.ELEMENT="element",Yu.SPRITE="sprite",Yu.RENDER="render";var Ku=function(s){G(e,s);function e(e,t,i){var n;n=s.call(this)||this;var r=t.length;n.init(e,r);n.device=e;n.rootNode=i;n.bones=t;return n}var t=e.prototype;t.updateMatrices=function e(t,i){};t.updateMatrixPalette=function e(t,i){var n;var r=this.matrixPalette;var s;var a=this.bones.length;for(var o=0;o<a;o++){n=this.bones[o].getWorldTransform().data;s=o*12;r[s]=n[0];r[s+1]=n[4];r[s+2]=n[8];r[s+3]=n[12];r[s+4]=n[1];r[s+5]=n[5];r[s+6]=n[9];r[s+7]=n[13];r[s+8]=n[2];r[s+9]=n[6];r[s+10]=n[10];r[s+11]=n[14]}this.uploadBones(this.device)};return e}(ju);function Qu(e,t){if(e&&!t)return false;if(!e&&t)return false;e=e.data;t=t.data;if(e===t)return true;if(e instanceof Float32Array&&t instanceof Float32Array){if(e.length!==t.length)return false;for(var i=0;i<e.length;i++)if(e[i]!==t[i])return false;return true}return false}function $u(e,t){var i;for(i in e)if(e.hasOwnProperty(i)&&!Qu(e[i],t[i]))return false;for(i in t)if(t.hasOwnProperty(i)&&!Qu(t[i],e[i]))return false;return true}function Zu(e,t){var i;for(i=0;i<e.length;i++)if(t.indexOf(e[i])<0)return false;for(i=0;i<t.length;i++)if(e.indexOf(t[i])<0)return false;return true}var Ju=new ce,ef=new ce,tf=new ce;function nf(e){var t=e.node.worldTransform;t.getX(Ju);t.getY(ef);t.getZ(tf);Ju.cross(Ju,ef);return Ju.dot(tf)>=0?1:-1}var rf=function(){function e(e,t,i){this.device=e;this.rootNode=t;this.scene=i;this._init=false;this._batchGroups={};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]}var t=e.prototype;t.destroyManager=function e(){this.device=null;this.rootNode=null;this.scene=null;this._batchGroups={};this._batchList=[];this._dirtyGroups=[]};t.addGroup=function e(t,i,n,r,s){if(r===undefined){r=this._batchGroupCounter;this._batchGroupCounter++}if(this._batchGroups[r])return;var a;this._batchGroups[r]=a=new Yu(r,t,i,n,s);return a};t.removeGroup=function e(t){if(!this._batchGroups[t])return;var i=[];for(var n=0;n<this._batchList.length;n++){if(this._batchList[n].batchGroupId!==t){i.push(this._batchList[n]);continue}this.destroy(this._batchList[n])}this._batchList=i;this._removeModelsFromBatchGroup(this.rootNode,t);delete this._batchGroups[t]};t.markGroupDirty=function e(t){if(this._dirtyGroups.indexOf(t)<0)this._dirtyGroups.push(t)};t.getGroupByName=function e(t){var i=this._batchGroups;for(var n in i){if(!i.hasOwnProperty(n))continue;if(i[n].name===t)return i[n]}return null};t.getBatches=function e(t){var i=[];var n=this._batchList.length;for(var r=0;r<n;r++){var s=this._batchList[r];if(s.batchGroupId===t)i.push(s)}return i};t._removeModelsFromBatchGroup=function e(t,i){if(!t.enabled)return;if(t.model&&t.model.batchGroupId===i)t.model.batchGroupId=-1;if(t.render&&t.render.batchGroupId===i)t.render.batchGroupId=-1;if(t.element&&t.element.batchGroupId===i)t.element.batchGroupId=-1;if(t.sprite&&t.sprite.batchGroupId===i)t.sprite.batchGroupId=-1;for(var n=0;n<t._children.length;n++)this._removeModelsFromBatchGroup(t._children[n],i)};t.insert=function e(t,i,n){var r=this._batchGroups[i];if(r)if(r._obj[t].indexOf(n)<0){r._obj[t].push(n);this.markGroupDirty(i)}};t.remove=function e(t,i,n){var r=this._batchGroups[i];if(r){var s=r._obj[t].indexOf(n);if(s>=0){r._obj[t].splice(s,1);this.markGroupDirty(i)}}};t._extractRender=function e(t,i,n,r){if(t.render){if(t.render.isStatic){var s,a=this.scene.drawCalls;var o=t.render.meshInstances;for(s=0;s<a.length;s++){if(!a[s]._staticSource)continue;if(o.indexOf(a[s]._staticSource)<0)continue;i.push(a[s])}for(s=0;s<o.length;s++)if(a.indexOf(o[s])>=0)i.push(o[s])}else i=r[t.render.batchGroupId]=i.concat(t.render.meshInstances);t.render.removeFromLayers()}return i};t._extractModel=function e(t,i,n,r){if(t.model&&t.model.model){var s;if(t.model.isStatic){var a=this.scene.drawCalls;var o=t.model.meshInstances;for(s=0;s<a.length;s++){if(!a[s]._staticSource)continue;if(o.indexOf(a[s]._staticSource)<0)continue;i.push(a[s])}for(s=0;s<o.length;s++)if(a.indexOf(o[s])>=0)i.push(o[s])}else i=r[t.model.batchGroupId]=i.concat(t.model.meshInstances);t.model.removeModelFromLayers()}return i};t._extractElement=function e(t,i,n){if(!t.element)return;var r=false;if(t.element._text&&t.element._text._model.meshInstances.length>0){i.push(t.element._text._model.meshInstances[0]);t.element.removeModelFromLayers(t.element._text._model);r=true}else if(t.element._image){i.push(t.element._image._renderable.meshInstance);t.element.removeModelFromLayers(t.element._image._renderable.model);if(t.element._image._renderable.unmaskMeshInstance){i.push(t.element._image._renderable.unmaskMeshInstance);if(!t.element._image._renderable.unmaskMeshInstance.stencilFront||!t.element._image._renderable.unmaskMeshInstance.stencilBack){t.element._dirtifyMask();t.element._onPrerender()}}r=true}if(r)n._ui=true};t._collectAndRemoveMeshInstances=function e(t,i){var n,r,s,a;for(var o=0;o<i.length;o++){a=i[o];r=this._batchGroups[a];if(!r)continue;s=t[a];if(!s)s=t[a]=[];for(var l=0;l<r._obj.model.length;l++)s=this._extractModel(r._obj.model[l],s,r,t);for(var h=0;h<r._obj.render.length;h++)s=this._extractRender(r._obj.render[h],s,r,t);for(var c=0;c<r._obj.element.length;c++)this._extractElement(r._obj.element[c],s,r);for(var u=0;u<r._obj.sprite.length;u++){n=r._obj.sprite[u];if(n.sprite&&n.sprite._meshInstance&&(r.dynamic||n.sprite.sprite._renderMode===_c)){s.push(n.sprite._meshInstance);n.sprite.removeModelFromLayers();r._sprite=true;n.sprite._batchGroup=r}}}};t.generate=function e(t){var i,n;var r={};if(!t)t=Object.keys(this._batchGroups);var s=[];for(i=0;i<this._batchList.length;i++){if(t.indexOf(this._batchList[i].batchGroupId)<0){s.push(this._batchList[i]);continue}this.destroy(this._batchList[i])}this._batchList=s;this._collectAndRemoveMeshInstances(r,t);if(t===this._dirtyGroups)this._dirtyGroups.length=0;else{var a=[];for(i=0;i<this._dirtyGroups.length;i++)if(t.indexOf(this._dirtyGroups[i])<0)a.push(this._dirtyGroups[i]);this._dirtyGroups=a}var o,l,h,c;for(var u in r){if(!r.hasOwnProperty(u))continue;o=r[u];h=this._batchGroups[u];if(!h)continue;l=this.prepare(o,h.dynamic,h.maxAabbSize,h._ui||h._sprite);for(i=0;i<l.length;i++){c=this.create(l[i],h.dynamic,parseInt(u,10));if(!c)continue;for(n=0;n<h.layers.length;n++){var f=this.scene.layers.getLayerById(h.layers[n]);if(f)f.addMeshInstances(c.model.meshInstances)}}}};t.prepare=function e(t,i,n,r){if(n===void 0)n=Number.POSITIVE_INFINITY;if(t.length===0)return[];var s=n*.5;var a=this.device.supportsBoneTextures?1024:this.device.boneLimit;var o=this.device.extUintElement?4294967295:65535;var l,h,c,u,f,d,p,m,_,v,g,y;var b=new Ce;var x=new Ce;var S=null;var w,T;var M=[];var C,A=0;if(r)t.sort(function(e,t){return e.drawOrder-t.drawOrder});var P=t;var E;var I=r?function(e){if(S)S.add(e.aabb);else S=e.aabb.clone();E.push(e)}:function(e){E.push(e)};while(P.length>0){M[A]=[P[0]];E=[];l=P[0].material;h=P[0].layer;d=P[0]._shaderDefs;u=P[0].parameters;p=P[0].stencilFront;f=P[0]._staticLightList;c=P[0].mesh.vertexBuffer.getNumVertices();v=P[0].drawOrder;b.copy(P[0].aabb);_=nf(P[0]);y=P[0].mesh.vertexBuffer.format.batchingHash;g=P[0].mesh.primitive[0].indexed;S=null;for(C=1;C<P.length;C++){w=P[C];if(i&&M[A].length>=a){E=E.concat(P.slice(C));break}if(l!==w.material||h!==w.layer||y!==w.mesh.vertexBuffer.format.batchingHash||g!==w.mesh.primitive[0].indexed||d!==w._shaderDefs||c+w.mesh.vertexBuffer.getNumVertices()>o){I(w);continue}x.copy(b);x.add(w.aabb);if(x.halfExtents.x>s||x.halfExtents.y>s||x.halfExtents.z>s){I(w);continue}if(p)if(!(T=w.stencilFront)||p.func!=T.func||p.zpass!=T.zpass){I(w);continue}if(_!=nf(w)){I(w);continue}if(!$u(u,w.parameters)){I(w);continue}m=w._staticLightList;if(f&&m){if(!Zu(f,m)){I(w);continue}}else if(f||m){I(w);continue}if(r&&S&&S.intersects(w.aabb)&&w.drawOrder!==v){I(w);continue}b.add(w.aabb);c+=w.mesh.vertexBuffer.getNumVertices();M[A].push(w)}A++;P=E}return M};t.create=function e(t,i,n){if(!this._init){var r="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n";this.transformVS=r+"#define DYNAMICBATCH\n"+ul.transformVS;this.skinTexVS=ul.skinBatchTexVS;this.skinConstVS=ul.skinBatchConstVS;this.vertexFormats={};this._init=true}var s,a;var o=null,l;var h;var c=null;var u,f,d;var p=0;var m=0;var _=null;for(s=0;s<t.length;s++)if(t[s].visible){u=t[s].mesh;d=u.vertexBuffer.numVertices;p+=d;m+=u.primitive[0].indexed?u.primitive[0].count:u.primitive[0].type==Mi&&u.primitive[0].count===4?6:0;if(!o){c=t[s].material;o={};f=u.vertexBuffer.format.elements;for(a=0;a<f.length;a++){h=f[a].name;o[h]={numComponents:f[a].numComponents,dataType:f[a].dataType,normalize:f[a].normalize,count:0}}if(i)o[Ii]={numComponents:1,dataType:In,normalize:false,count:0}}}if(o){_=new qu(t,i,n);this._batchList.push(_);var v,g,y;var b=0;var x=0;var S,w=new ce;var T=p<=65535?Uint16Array:Uint32Array;var M=new T(m);for(h in o){l=o[h];l.typeArrayType=tr[l.dataType];l.elementByteSize=ir[l.dataType];l.buffer=new l.typeArrayType(p*l.numComponents)}for(s=0;s<t.length;s++){if(!t[s].visible)continue;u=t[s].mesh;d=u.vertexBuffer.numVertices;if(!i)S=t[s].node.getWorldTransform();for(h in o)if(h!==Ii){l=o[h];var C=new l.typeArrayType(l.buffer.buffer,l.elementByteSize*l.count);var A=u.getVertexStream(h,C)*l.numComponents;l.count+=A;if(!i&&l.numComponents>=3)if(h==Ci||h==Ai||h==Pi){S.transformFunction=h==Ci?ve.prototype.transformPoint:ve.prototype.transformVector;for(a=0;a<A;a+=l.numComponents){w.set(C[a],C[a+1],C[a+2]);S.transformFunction(w,w);C[a]=w.x;C[a+1]=w.y;C[a+2]=w.z}}}if(i){l=o[Ii];for(a=0;a<d;a++)l.buffer[l.count++]=s}if(u.primitive[0].indexed){v=u.primitive[0].base;g=u.primitive[0].count;var P=u.indexBuffer[0].getFormat();y=new rr[P](u.indexBuffer[0].storage)}else if(u.primitive[0].type==Mi&&u.primitive[0].count===4){v=0;g=6;y=[0,1,3,2,3,1]}else{g=0;continue}for(a=0;a<g;a++)M[a+x]=y[v+a]+b;x+=g;b+=d}u=new Du(this.device);for(h in o){l=o[h];u.setVertexStream(h,l.buffer,l.numComponents,undefined,l.dataType,l.normalize)}if(M.length>0)u.setIndices(M);u.update(wi,false);if(i){c=c.clone();c.chunks.transformVS=this.transformVS;c.chunks.skinTexVS=this.skinTexVS;c.chunks.skinConstVS=this.skinConstVS;c.update()}var E=new zu(this.rootNode,u,c);E.castShadow=_.origMeshInstances[0].castShadow;E.parameters=_.origMeshInstances[0].parameters;E.isStatic=_.origMeshInstances[0].isStatic;E.layer=_.origMeshInstances[0].layer;E._staticLightList=_.origMeshInstances[0]._staticLightList;E._shaderDefs=_.origMeshInstances[0]._shaderDefs;E.cull=_.origMeshInstances[0].cull;var I=this._batchGroups[n];if(I&&I._ui)E.cull=false;if(i){var R=[];for(s=0;s<_.origMeshInstances.length;s++)R.push(_.origMeshInstances[s].node);E.skinInstance=new Ku(this.device,R,this.rootNode)}E._updateAabb=false;E.drawOrder=_.origMeshInstances[0].drawOrder;E.stencilFront=_.origMeshInstances[0].stencilFront;E.stencilBack=_.origMeshInstances[0].stencilBack;E.flipFaces=nf(_.origMeshInstances[0])<0;_.meshInstance=E;this.update(_);var L=new Xu;L.meshInstances=[_.meshInstance];L.castShadows=_.origMeshInstances[0].castShadows;_.model=L}return _};t.update=function e(t){t._aabb.copy(t.origMeshInstances[0].aabb);for(var i=1;i<t.origMeshInstances.length;i++)t._aabb.add(t.origMeshInstances[i].aabb);t.meshInstance.aabb=t._aabb;t._aabb._radiusVer=-1;t.meshInstance._aabbVer=0};t.updateAll=function e(){if(this._dirtyGroups.length>0)this.generate(this._dirtyGroups);for(var t=0;t<this._batchList.length;t++){if(!this._batchList[t].dynamic)continue;this.update(this._batchList[t])}};t.clone=function e(t,i){var n=new qu(i,t.dynamic,t.batchGroupId);this._batchList.push(n);var r=[];for(var s=0;s<i.length;s++)r.push(i[s].node);n.meshInstance=new zu(t.meshInstance.node,t.meshInstance.mesh,t.meshInstance.material);n.meshInstance._updateAabb=false;n.meshInstance.parameters=i[0].parameters;n.meshInstance.isStatic=i[0].isStatic;n.meshInstance.cull=i[0].cull;n.meshInstance.layer=i[0].layer;n.meshInstance._staticLightList=i[0]._staticLightList;if(t.dynamic)n.meshInstance.skinInstance=new Ku(this.device,r,this.rootNode);n.meshInstance.castShadow=t.meshInstance.castShadow;n.meshInstance._shader=t.meshInstance._shader;var a=new Xu;a.meshInstances=[n.meshInstance];a.castShadows=t.origMeshInstances[0].castShadows;n.model=a;return n};t.destroy=function e(t){if(!t.model)return;var i=this._batchGroups[t.batchGroupId].layers;for(var n=0;n<i.length;n++){var r=this.scene.layers.getLayerById(i[n]);if(r)r.removeMeshInstances(t.model.meshInstances)}t.model.destroy()};return e}(),sf=new ce,af=new ce,of=new ce,lf=new ve,hf=function(){function e(){this._aspectRatio=16/9;this._aspectRatioMode=kc;this._calculateProjection=null;this._calculateTransform=null;this._clearColor=new ge(.75,.75,.75,1);this._clearColorBuffer=true;this._clearDepth=1;this._clearDepthBuffer=true;this._clearStencil=0;this._clearStencilBuffer=true;this._cullingMask=4294967295;this._cullFaces=true;this._farClip=1e3;this._flipFaces=false;this._fov=45;this._frustumCulling=true;this._horizontalFov=false;this._layers=[Dl,kl,Ol,Bl,Fl];this._nearClip=.1;this._node=null;this._orthoHeight=10;this._projection=dh;this._rect=new ue(0,0,1,1);this._renderTarget=null;this._scissorRect=new ue(0,0,1,1);this._vrDisplay=null;this._projMat=new ve;this._projMatDirty=true;this._projMatSkybox=new ve;this._viewMat=new ve;this._viewMatDirty=true;this._viewProjMat=new ve;this._viewProjMatDirty=true;this.frustum=new ke}var t=e.prototype;t.clone=function e(){return(new this.constructor).copy(this)};t.copy=function e(t){this.aspectRatio=t.aspectRatio;this.aspectRatioMode=t.aspectRatioMode;this.calculateProjection=t.calculateProjection;this.calculateTransform=t.calculateTransform;this.clearColor=t.clearColor;this.clearColorBuffer=t.clearColorBuffer;this.clearDepth=t.clearDepth;this.clearDepthBuffer=t.clearDepthBuffer;this.clearStencil=t.clearStencil;this.clearStencilBuffer=t.clearStencilBuffer;this.cullFaces=t.cullFaces;this.cullingMask=t.cullingMask;this.farClip=t.farClip;this.flipFaces=t.flipFaces;this.fov=t.fov;this.frustumCulling=t.frustumCulling;this.horizontalFov=t.horizontalFov;this.layers=t.layers;this.nearClip=t.nearClip;this.orthoHeight=t.orthoHeight;this.projection=t.projection;this.rect=t.rect;this.renderTarget=t.renderTarget;this.scissorRect=t.scissorRect;this.vrDisplay=t.vrDisplay};t._updateViewProjMat=function e(){if(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty){var t=this.projectionMatrix;var i=this.viewMatrix;this._viewProjMat.mul2(t,i);this._viewProjMatDirty=false}};t.worldToScreen=function e(t,i,n,r){if(r===void 0)r=new ce;this._updateViewProjMat();this._viewProjMat.transformPoint(t,r);var s=this._viewProjMat.data;var a=t.x*s[3]+t.y*s[7]+t.z*s[11]+1*s[15];r.x=(r.x/a+1)*.5*i;r.y=(1-r.y/a)*.5*n;return r};t.screenToWorld=function e(t,i,n,r,s,a){if(a===void 0)a=new ce;var o=this._farClip-this._nearClip;sf.set(t/r,(s-i)/s,n/o);sf.scale(2);sf.sub(ce.ONE);if(this._projection===dh){ve._getPerspectiveHalfSize(af,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov);af.x*=sf.x;af.y*=sf.y;var l=this._node.getWorldTransform();af.z=-this._nearClip;l.transformPoint(af,of);var h=this._node.getPosition();a.sub2(of,h);a.normalize();a.scale(n);a.add(h)}else{this._updateViewProjMat();lf.copy(this._viewProjMat).invert();lf.transformPoint(sf,a)}return a};t._evaluateProjectionMatrix=function e(){if(this._projMatDirty){if(this._projection===dh){this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov);this._projMatSkybox.copy(this._projMat)}else{var t=this._orthoHeight;var i=t*this._aspectRatio;this._projMat.setOrtho(-i,i,-t,t,this._nearClip,this._farClip);this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=false}};t.getProjectionMatrixSkybox=function e(){this._evaluateProjectionMatrix();return this._projMatSkybox};U(e,[{key:"aspectRatio",get:function e(){return this._aspectRatio},set:function e(t){if(this._aspectRatio!==t){this._aspectRatio=t;this._projMatDirty=true}}},{key:"aspectRatioMode",get:function e(){return this._aspectRatioMode},set:function e(t){if(this._aspectRatioMode!==t){this._aspectRatioMode=t;this._projMatDirty=true}}},{key:"calculateProjection",get:function e(){return this._calculateProjection},set:function e(t){this._calculateProjection=t;this._projMatDirty=true}},{key:"calculateTransform",get:function e(){return this._calculateTransform},set:function e(t){this._calculateTransform=t}},{key:"clearColor",get:function e(){return this._clearColor},set:function e(t){this._clearColor.copy(t)}},{key:"clearColorBuffer",get:function e(){return this._clearColorBuffer},set:function e(t){this._clearColorBuffer=t}},{key:"clearDepth",get:function e(){return this._clearDepth},set:function e(t){this._clearDepth=t}},{key:"clearDepthBuffer",get:function e(){return this._clearDepthBuffer},set:function e(t){this._clearDepthBuffer=t}},{key:"clearStencil",get:function e(){return this._clearStencil},set:function e(t){this._clearStencil=t}},{key:"clearStencilBuffer",get:function e(){return this._clearStencilBuffer},set:function e(t){this._clearStencilBuffer=t}},{key:"cullingMask",get:function e(){return this._cullingMask},set:function e(t){this._cullingMask=t}},{key:"cullFaces",get:function e(){return this._cullFaces},set:function e(t){this._cullFaces=t}},{key:"farClip",get:function e(){return this._farClip},set:function e(t){if(this._farClip!==t){this._farClip=t;this._projMatDirty=true}}},{key:"flipFaces",get:function e(){return this._flipFaces},set:function e(t){this._flipFaces=t}},{key:"fov",get:function e(){return this._fov},set:function e(t){if(this._fov!==t){this._fov=t;this._projMatDirty=true}}},{key:"frustumCulling",get:function e(){return this._frustumCulling},set:function e(t){this._frustumCulling=t}},{key:"horizontalFov",get:function e(){return this._horizontalFov},set:function e(t){if(this._horizontalFov!==t){this._horizontalFov=t;this._projMatDirty=true}}},{key:"layers",get:function e(){return this._layers},set:function e(t){this._layers=t.slice(0)}},{key:"nearClip",get:function e(){return this._nearClip},set:function e(t){if(this._nearClip!==t){this._nearClip=t;this._projMatDirty=true}}},{key:"node",get:function e(){return this._node},set:function e(t){this._node=t}},{key:"orthoHeight",get:function e(){return this._orthoHeight},set:function e(t){if(this._orthoHeight!==t){this._orthoHeight=t;this._projMatDirty=true}}},{key:"projection",get:function e(){return this._projection},set:function e(t){if(this._projection!==t){this._projection=t;this._projMatDirty=true}}},{key:"projectionMatrix",get:function e(){this._evaluateProjectionMatrix();return this._projMat}},{key:"rect",get:function e(){return this._rect},set:function e(t){this._rect.copy(t)}},{key:"renderTarget",get:function e(){return this._renderTarget},set:function e(t){this._renderTarget=t}},{key:"scissorRect",get:function e(){return this._scissorRect},set:function e(t){this._scissorRect.copy(t)}},{key:"viewMatrix",get:function e(){if(this._viewMatDirty){var t=this._node.getWorldTransform();this._viewMat.copy(t).invert();this._viewMatDirty=false}return this._viewMat}},{key:"vrDisplay",get:function e(){return this._vrDisplay},set:function e(t){this._vrDisplay=t;if(t)t._camera=this}}]);return e}(),cf=new ve,uf=new ce,ff=new be,df=new be,pf=new ce,mf=new ce,_f=new ve,vf=new be,gf=new ce,yf=new ve,bf=new be,xf=new be,Sf=new ve,wf=new ce,Tf=new ce,Mf=function(i){G(t,i);function t(e){var t;t=i.call(this)||this;t.name=typeof e==="string"?e:"Untitled";t.tags=new q(H(t));t._labels={};t.localPosition=new ce(0,0,0);t.localRotation=new be(0,0,0,1);t.localScale=new ce(1,1,1);t.localEulerAngles=new ce(0,0,0);t.position=new ce(0,0,0);t.rotation=new be(0,0,0,1);t.eulerAngles=new ce(0,0,0);t._scale=null;t.localTransform=new ve;t._dirtyLocal=false;t._aabbVer=0;t._frozen=false;t.worldTransform=new ve;t._dirtyWorld=false;t.normalMatrix=new le;t._dirtyNormal=true;t._right=null;t._up=null;t._forward=null;t._parent=null;t._children=[];t._graphDepth=0;t._enabled=true;t._enabledInHierarchy=false;t.scaleCompensation=false;return t}var e=t.prototype;e._notifyHierarchyStateChanged=function e(t,i){t._onHierarchyStateChanged(i);var n=t._children;for(var r=0,s=n.length;r<s;r++)if(n[r]._enabled)this._notifyHierarchyStateChanged(n[r],i)};e._onHierarchyStateChanged=function e(t){this._enabledInHierarchy=t;if(t&&!this._frozen)this._unfreezeParentToRoot()};e._cloneInternal=function e(t){t.name=this.name;var i=this.tags._list;for(var n=0;n<i.length;n++)t.tags.add(i[n]);t._labels=Object.assign({},this._labels);t.localPosition.copy(this.localPosition);t.localRotation.copy(this.localRotation);t.localScale.copy(this.localScale);t.localEulerAngles.copy(this.localEulerAngles);t.position.copy(this.position);t.rotation.copy(this.rotation);t.eulerAngles.copy(this.eulerAngles);t.localTransform.copy(this.localTransform);t._dirtyLocal=this._dirtyLocal;t.worldTransform.copy(this.worldTransform);t._dirtyWorld=this._dirtyWorld;t._dirtyNormal=this._dirtyNormal;t._aabbVer=this._aabbVer+1;t._enabled=this._enabled;t.scaleCompensation=this.scaleCompensation;t._enabledInHierarchy=false};e.clone=function e(){var e=new t;this._cloneInternal(e);return e};e.find=function e(t,i){var n,r=[];var s=this._children.length;var a,o;if(t instanceof Function){var l=t;n=l(this);if(n)r.push(this);for(a=0;a<s;a++){o=this._children[a].find(l);if(o.length)r=r.concat(o)}}else{var h;if(this[t]){if(this[t]instanceof Function)h=this[t]();else h=this[t];if(h===i)r.push(this)}for(a=0;a<s;++a){o=this._children[a].find(t,i);if(o.length)r=r.concat(o)}}return r};e.findOne=function e(t,i){var n;var r=this._children.length;var s=null;if(t instanceof Function){var a=t;s=a(this);if(s)return this;for(n=0;n<r;n++){s=this._children[n].findOne(a);if(s)return s}}else{var o;if(this[t]){if(this[t]instanceof Function)o=this[t]();else o=this[t];if(o===i)return this}for(n=0;n<r;n++){s=this._children[n].findOne(t,i);if(s!==null)return s}}return null};e.findByTag=function e(){var t=this.tags._processArguments(arguments);return this._findByTag(t)};e._findByTag=function e(t){var i=[];var n,r=this._children.length;var s;for(n=0;n<r;n++){if(this._children[n].tags._has(t))i.push(this._children[n]);s=this._children[n]._findByTag(t);if(s.length)i=i.concat(s)}return i};e.findByName=function e(t){if(this.name===t)return this;for(var i=0;i<this._children.length;i++){var n=this._children[i].findByName(t);if(n!==null)return n}return null};e.findByPath=function e(t){var i=t.split("/");var n=this;var r=null;for(var s=0,a=i.length;s<a&&n;s++){var o=i[s];r=null;var l=n._children;for(var h=0,c=l.length;h<c;h++)if(l[h].name==o){r=l[h];break}n=r}return r};e.forEach=function e(t,i){t.call(i,this);var n=this._children;for(var r=0;r<n.length;r++)n[r].forEach(t,i)};e.isDescendantOf=function e(t){var i=this._parent;while(i){if(i===t)return true;i=i._parent}return false};e.isAncestorOf=function e(t){return t.isDescendantOf(this)};e.getEulerAngles=function e(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles};e.getLocalEulerAngles=function e(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles};e.getLocalPosition=function e(){return this.localPosition};e.getLocalRotation=function e(){return this.localRotation};e.getLocalScale=function e(){return this.localScale};e.getLocalTransform=function e(){if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);this._dirtyLocal=false}return this.localTransform};e.getPosition=function e(){this.getWorldTransform().getTranslation(this.position);return this.position};e.getRotation=function e(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation};e.getScale=function e(){if(!this._scale)this._scale=new ce;return this.getWorldTransform().getScale(this._scale)};e.getWorldTransform=function e(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;if(this._parent)this._parent.getWorldTransform();this._sync();return this.worldTransform};e.reparent=function e(t,i){var n=this._parent;if(n)n.removeChild(this);if(t)if(i>=0)t.insertChild(this,i);else t.addChild(this)};e.setLocalEulerAngles=function e(t,i,n){if(t instanceof ce)this.localRotation.setFromEulerAngles(t.x,t.y,t.z);else this.localRotation.setFromEulerAngles(t,i,n);if(!this._dirtyLocal)this._dirtifyLocal()};e.setLocalPosition=function e(t,i,n){if(t instanceof ce)this.localPosition.copy(t);else this.localPosition.set(t,i,n);if(!this._dirtyLocal)this._dirtifyLocal()};e.setLocalRotation=function e(t,i,n,r){if(t instanceof be)this.localRotation.copy(t);else this.localRotation.set(t,i,n,r);if(!this._dirtyLocal)this._dirtifyLocal()};e.setLocalScale=function e(t,i,n){if(t instanceof ce)this.localScale.copy(t);else this.localScale.set(t,i,n);if(!this._dirtyLocal)this._dirtifyLocal()};e._dirtifyLocal=function e(){if(!this._dirtyLocal){this._dirtyLocal=true;if(!this._dirtyWorld)this._dirtifyWorld()}};e._unfreezeParentToRoot=function e(){var t=this._parent;while(t){t._frozen=false;t=t._parent}};e._dirtifyWorld=function e(){if(!this._dirtyWorld)this._unfreezeParentToRoot();this._dirtifyWorldInternal()};e._dirtifyWorldInternal=function e(){if(!this._dirtyWorld){this._frozen=false;this._dirtyWorld=true;for(var t=0;t<this._children.length;t++)if(!this._children[t]._dirtyWorld)this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=true;this._aabbVer++};e.setPosition=function e(t,i,n){if(t instanceof ce)gf.copy(t);else gf.set(t,i,n);if(this._parent===null)this.localPosition.copy(gf);else{yf.copy(this._parent.getWorldTransform()).invert();yf.transformPoint(gf,this.localPosition)}if(!this._dirtyLocal)this._dirtifyLocal()};e.setRotation=function e(t,i,n,r){if(t instanceof be)bf.copy(t);else bf.set(t,i,n,r);if(this._parent===null)this.localRotation.copy(bf);else{var s=this._parent.getRotation();xf.copy(s).invert();this.localRotation.copy(xf).mul(bf)}if(!this._dirtyLocal)this._dirtifyLocal()};e.setEulerAngles=function e(t,i,n){if(t instanceof ce)this.localRotation.setFromEulerAngles(t.x,t.y,t.z);else this.localRotation.setFromEulerAngles(t,i,n);if(this._parent!==null){var r=this._parent.getRotation();xf.copy(r).invert();this.localRotation.mul2(xf,this.localRotation)}if(!this._dirtyLocal)this._dirtifyLocal()};e.addChild=function e(t){if(t._parent!==null)throw new Error("GraphNode is already parented");this._children.push(t);this._onInsertChild(t)};e.addChildAndSaveTransform=function e(t){var i=t.getPosition();var n=t.getRotation();var r=t._parent;if(r)r.removeChild(t);t.setPosition(_f.copy(this.worldTransform).invert().transformPoint(i));t.setRotation(vf.copy(this.getRotation()).invert().mul(n));this._children.push(t);this._onInsertChild(t)};e.insertChild=function e(t,i){if(t._parent!==null)throw new Error("GraphNode is already parented");this._children.splice(i,0,t);this._onInsertChild(t)};e._onInsertChild=function e(t){t._parent=this;var i=t._enabled&&this.enabled;if(t._enabledInHierarchy!==i){t._enabledInHierarchy=i;t._notifyHierarchyStateChanged(t,i)}t._updateGraphDepth();t._dirtifyWorld();if(this._frozen)t._unfreezeParentToRoot();if(t.fire)t.fire("insert",this);if(this.fire)this.fire("childinsert",t)};e._updateGraphDepth=function e(){if(this._parent)this._graphDepth=this._parent._graphDepth+1;else this._graphDepth=0;for(var t=0,i=this._children.length;t<i;t++)this._children[t]._updateGraphDepth()};e.removeChild=function e(t){var i;var n=this._children.length;for(i=0;i<n;++i)if(this._children[i]===t){this._children.splice(i,1);t._parent=null;if(t.fire)t.fire("remove",this);if(this.fire)this.fire("childremove",t);return}};e._sync=function e(){if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);this._dirtyLocal=false}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var t;var i=this._parent;var n=this.localScale;var r=i;if(r){while(r&&r.scaleCompensation)r=r._parent;if(r){r=r._parent;if(r){t=r.worldTransform.getScale();pf.mul2(t,this.localScale);n=pf}}}df.setFromMat4(i.worldTransform);ff.mul2(df,this.localRotation);var s=i.worldTransform;if(i.scaleCompensation){mf.mul2(t,i.getLocalScale());cf.setTRS(i.worldTransform.getTranslation(uf),df,mf);s=cf}s.transformPoint(this.localPosition,uf);this.worldTransform.setTRS(uf,ff,n)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=false}};e.syncHierarchy=function e(){if(!this._enabled)return;if(this._frozen)return;this._frozen=true;if(this._dirtyLocal||this._dirtyWorld)this._sync();var t=this._children;for(var i=0,n=t.length;i<n;i++)t[i].syncHierarchy()};e.lookAt=function e(t,i,n,r,s,a){if(r===void 0)r=0;if(s===void 0)s=1;if(a===void 0)a=0;if(t instanceof ce){wf.copy(t);if(i instanceof ce)Tf.copy(i);else Tf.copy(ce.UP)}else if(n===undefined)return;else{wf.set(t,i,n);Tf.set(r,s,a)}Sf.setLookAt(this.getPosition(),wf,Tf);bf.setFromMat4(Sf);this.setRotation(bf)};e.translate=function e(t,i,n){if(t instanceof ce)gf.copy(t);else gf.set(t,i,n);gf.add(this.getPosition());this.setPosition(gf)};e.translateLocal=function e(t,i,n){if(t instanceof ce)gf.copy(t);else gf.set(t,i,n);this.localRotation.transformVector(gf,gf);this.localPosition.add(gf);if(!this._dirtyLocal)this._dirtifyLocal()};e.rotate=function e(t,i,n){if(t instanceof ce)bf.setFromEulerAngles(t.x,t.y,t.z);else bf.setFromEulerAngles(t,i,n);if(this._parent===null)this.localRotation.mul2(bf,this.localRotation);else{var r=this.getRotation();var s=this._parent.getRotation();xf.copy(s).invert();bf.mul2(xf,bf);this.localRotation.mul2(bf,r)}if(!this._dirtyLocal)this._dirtifyLocal()};e.rotateLocal=function e(t,i,n){if(t instanceof ce)bf.setFromEulerAngles(t.x,t.y,t.z);else bf.setFromEulerAngles(t,i,n);this.localRotation.mul(bf);if(!this._dirtyLocal)this._dirtifyLocal()};U(t,[{key:"right",get:function e(){if(!this._right)this._right=new ce;return this.getWorldTransform().getX(this._right).normalize()}},{key:"up",get:function e(){if(!this._up)this._up=new ce;return this.getWorldTransform().getY(this._up).normalize()}},{key:"forward",get:function e(){if(!this._forward)this._forward=new ce;return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}},{key:"enabled",get:function e(){return this._enabled&&this._enabledInHierarchy},set:function e(t){if(this._enabled!==t){this._enabled=t;if(!this._parent||this._parent.enabled)this._notifyHierarchyStateChanged(this,t)}}},{key:"parent",get:function e(){return this._parent}},{key:"path",get:function e(){var t=this._parent;if(t){var i=this.name;while(t&&t._parent){i=t.name+"/"+i;t=t._parent}return i}return""}},{key:"root",get:function e(){var t=this._parent;if(!t)return this;while(t._parent)t=t._parent;return t}},{key:"children",get:function e(){return this._children}},{key:"graphDepth",get:function e(){return this._graphDepth}}]);return t}(u),Cf,Af,Pf,Ef;function If(e,t){return e.drawOrder-t.drawOrder}function Rf(e,t){Cf=e._key[sc];Af=t._key[sc];if(Cf===Af&&e.mesh&&t.mesh)return t.mesh.id-e.mesh.id;return Af-Cf}function Lf(e,t){return t.zdist-e.zdist}function Df(e,t){return e.zdist-t.zdist}var kf=[null,If,Rf,Lf,Df];function Of(e,t){return e.priority-t.priority}function Ff(e,t){return t.key-e.key}for(var Bf=0,Nf=function e(){this.list=[];this.length=0;this.done=false},zf=function(){function e(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=[]}var t=e.prototype;t.clearVisibleLists=function e(t){if(this.visibleOpaque[t]){this.visibleOpaque[t].length=0;this.visibleOpaque[t].list.length=0}if(this.visibleTransparent[t]){this.visibleTransparent[t].length=0;this.visibleTransparent[t].list.length=0}};return e}(),Vf=function(){function e(e){if(e===void 0)e={};if(e.id!==undefined){this.id=e.id;Bf=Math.max(this.id+1,Bf)}else this.id=Bf++;this.name=e.name;this._enabled=e.enabled===undefined?true:e.enabled;this._refCounter=this._enabled?1:0;this.opaqueSortMode=e.opaqueSortMode===undefined?Cc:e.opaqueSortMode;this.transparentSortMode=e.transparentSortMode===undefined?Ac:e.transparentSortMode;this.renderTarget=e.renderTarget;this.shaderPass=e.shaderPass===undefined?cc:e.shaderPass;this.passThrough=e.passThrough===undefined?false:e.passThrough;this.overrideClear=e.overrideClear===undefined?false:e.overrideClear;this._clearColor=new ge(0,0,0,1);if(e.clearColor)this._clearColor.copy(e.clearColor);this._clearColorBuffer=e.clearColorBuffer===undefined?false:e.clearColorBuffer;this._clearDepthBuffer=e.clearDepthBuffer===undefined?false:e.clearDepthBuffer;this._clearStencilBuffer=e.clearStencilBuffer===undefined?false:e.clearStencilBuffer;this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?ft:0)|(this._clearDepthBuffer?dt:0)|(this._clearStencilBuffer?pt:0)};this.onPreCull=e.onPreCull;this.onPreRender=e.onPreRender;this.onPreRenderOpaque=e.onPreRenderOpaque;this.onPreRenderTransparent=e.onPreRenderTransparent;this.onPostCull=e.onPostCull;this.onPostRender=e.onPostRender;this.onPostRenderOpaque=e.onPostRenderOpaque;this.onPostRenderTransparent=e.onPostRenderTransparent;this.onDrawCall=e.onDrawCall;this.onEnable=e.onEnable;this.onDisable=e.onDisable;if(this._enabled&&this.onEnable)this.onEnable();this.layerReference=e.layerReference;this.instances=e.layerReference?e.layerReference.instances:new zf;this.cullingMask=e.cullingMask?e.cullingMask:4294967295;this.opaqueMeshInstances=this.instances.opaqueMeshInstances;this.transparentMeshInstances=this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this.customSortCallback=null;this.customCalculateSortValues=null;this._lightComponents=[];this._lights=[];this._splitLights=[[],[],[]];this.cameras=[];this._dirty=false;this._dirtyLights=false;this._dirtyCameras=false;this._cameraHash=0;this._lightHash=0;this._staticLightHash=0;this._needsStaticPrepare=true;this._staticPrepareDone=false;this._shaderVersion=-1;this._version=0;this._lightCube=null}var t=e.prototype;t._updateClearFlags=function e(){var t=0;if(this._clearColorBuffer)t|=ft;if(this._clearDepthBuffer)t|=dt;if(this._clearStencilBuffer)t|=pt;this._clearOptions.flags=t};t.incrementCounter=function e(){if(this._refCounter===0){this._enabled=true;if(this.onEnable)this.onEnable()}this._refCounter++};t.decrementCounter=function e(){if(this._refCounter===1){this._enabled=false;if(this.onDisable)this.onDisable()}else if(this._refCounter===0)return;this._refCounter--};t.addMeshInstances=function e(t,i){var n=this._shaderVersion;var r,s,a;var o=this.shadowCasters;for(var l=0;l<t.length;l++){r=t[l];a=r.material;if(a.blendType===ml)s=this.opaqueMeshInstances;else s=this.transparentMeshInstances;if(this.opaqueMeshInstances.indexOf(r)<0&&this.transparentMeshInstances.indexOf(r)<0)s.push(r);if(!i&&r.castShadow&&o.indexOf(r)<0)o.push(r);if(!this.passThrough&&n>=0&&a._shaderVersion!==n){if(a.updateShader!==Cu.prototype.updateShader){a.clearVariants();a.shader=null}a._shaderVersion=n}}if(!this.passThrough)this._dirty=true};t.removeMeshInstanceFromArray=function e(t,i){var n;var r=-1;var s=0;var a=i.length;for(var o=0;o<a;o++){n=i[o];if(n===t){r=o;s=1;break}if(n._staticSource===t){if(r<0)r=o;s++}else if(r>=0)break}if(r>=0)i.splice(r,s)};t.removeMeshInstances=function e(t,i){var n,r;var s=this.opaqueMeshInstances;var a=this.transparentMeshInstances;var o=this.shadowCasters;for(var l=0;l<t.length;l++){r=t[l];this.removeMeshInstanceFromArray(r,s);this.removeMeshInstanceFromArray(r,a);if(!i){n=o.indexOf(r);if(n>=0)o.splice(n,1)}}this._dirty=true};t.clearMeshInstances=function e(t){if(this.opaqueMeshInstances.length===0&&this.transparentMeshInstances.length===0)if(t||this.shadowCasters.length===0)return;this.opaqueMeshInstances.length=0;this.transparentMeshInstances.length=0;if(!t)this.shadowCasters.length=0;if(!this.passThrough)this._dirty=true};t.addLight=function e(t){if(this._lightComponents.indexOf(t)>=0)return;this._lightComponents.push(t);this._lights.push(t.light);this._dirtyLights=true;this._generateLightHash()};t.removeLight=function e(t){var i=this._lightComponents.indexOf(t);if(i<0)return;this._lightComponents.splice(i,1);i=this._lights.indexOf(t.light);this._lights.splice(i,1);this._dirtyLights=true;this._generateLightHash()};t.clearLights=function e(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=true};t.addShadowCasters=function e(t){var i;var n=this.shadowCasters;for(var r=0;r<t.length;r++){i=t[r];if(!i.castShadow)continue;if(n.indexOf(i)<0)n.push(i)}this._dirtyLights=true};t.removeShadowCasters=function e(t){var i;var n=this.shadowCasters;for(var r=0;r<t.length;r++){i=n.indexOf(t[r]);if(i>=0)n.splice(i,1)}this._dirtyLights=true};t._generateLightHash=function e(){if(this._lights.length>0){this._lights.sort(Ff);var t="";var i="";for(var n=0;n<this._lights.length;n++)if(this._lights[n].isStatic)i+=this._lights[n].key;else t+=this._lights[n].key;if(t.length===0)this._lightHash=0;else this._lightHash=hr(t);if(i.length===0)this._staticLightHash=0;else this._staticLightHash=hr(i)}else{this._lightHash=0;this._staticLightHash=0}};t._generateCameraHash=function e(){if(this.cameras.length>1){this.cameras.sort(Of);var t="";for(var i=0;i<this.cameras.length;i++)t+=this.cameras[i].entity.getGuid();this._cameraHash=hr(t)}else this._cameraHash=0;this._dirtyCameras=true};t.addCamera=function e(t){if(this.cameras.indexOf(t)>=0)return;this.cameras.push(t);this._generateCameraHash()};t.removeCamera=function e(t){var i=this.cameras.indexOf(t);if(i<0)return;this.cameras.splice(i,1);this._generateCameraHash();this.instances.clearVisibleLists(i)};t.clearCameras=function e(){this.cameras.length=0;this._cameraHash=0;this._dirtyCameras=true};t._sortCameras=function e(){this._generateCameraHash()};t._calculateSortDistances=function e(t,i,n,r){var s,a,o;var l,h,c;for(s=0;s<i;s++){a=t[s];if(a.command)continue;if(a.layer<=Rl)continue;if(a.calculateSortDistance){a.zdist=a.calculateSortDistance(a,n,r);continue}o=a.aabb.center;l=o.x-n.x;h=o.y-n.y;c=o.z-n.z;a.zdist=l*r.x+h*r.y+c*r.z}};t._sortVisible=function e(t,i,n){var r=this.instances;var s=t?this.transparentSortMode:this.opaqueSortMode;if(s===Tc)return;var a=t?r.visibleTransparent[n]:r.visibleOpaque[n];if(s===Ec){Pf=i.getPosition();Ef=i.forward;if(this.customCalculateSortValues)this.customCalculateSortValues(a.list,a.length,Pf,Ef);if(a.list.length!==a.length)a.list.length=a.length;if(this.customSortCallback)a.list.sort(this.customSortCallback)}else{if(s===Ac||s===Pc){Pf=i.getPosition();Ef=i.forward;this._calculateSortDistances(a.list,a.length,Pf,Ef)}if(a.list.length!==a.length)a.list.length=a.length;a.list.sort(kf[s])}};U(e,[{key:"renderTarget",get:function e(){return this._renderTarget},set:function e(t){this._renderTarget=t;this._dirtyCameras=true}},{key:"enabled",get:function e(){return this._enabled},set:function e(t){if(t!==this._enabled){this._enabled=t;if(t){this.incrementCounter();if(this.onEnable)this.onEnable()}else{this.decrementCounter();if(this.onDisable)this.onDisable()}}}},{key:"clearColor",get:function e(){return this._clearColor},set:function e(t){this._clearColor.copy(t)}},{key:"clearColorBuffer",get:function e(){return this._clearColorBuffer},set:function e(t){this._clearColorBuffer=t;this._updateClearFlags()}},{key:"clearDepthBuffer",get:function e(){return this._clearDepthBuffer},set:function e(t){this._clearDepthBuffer=t;this._updateClearFlags()}},{key:"clearStencilBuffer",get:function e(){return this._clearStencilBuffer},set:function e(t){this._clearStencilBuffer=t;this._updateClearFlags()}}]);return e}(),Uf=(new ve).mul2((new ve).setTranslate(.5,.5,.5),(new ve).setScale(.5,.5,.5)),Gf={r:1,g:2,b:3,a:4},Hf=[(new be).setFromEulerAngles(0,90,180),(new be).setFromEulerAngles(0,-90,180),(new be).setFromEulerAngles(90,0,0),(new be).setFromEulerAngles(-90,0,0),(new be).setFromEulerAngles(0,180,180),(new be).setFromEulerAngles(0,0,180)],Wf=5,jf=[{},{},{},{},{}],Xf=.01,qf=new Float32Array(2),Yf={x:1,y:1,z:0,w:0},Kf=new ve,Qf=new ve,$f=new ve,Zf=new ve,Jf=new ve,ed=new le,td=new ve,id,nd=new ve,rd=new ve,sd=new ve,ad=new ve,od=new ce,ld=new ce,hd,cd,ud=new le,fd=new le,dd=new ve,pd=new ve,md=new ce,_d=new ce,vd=new ce,gd=new ce,yd={center:null,radius:0},bd=new Ce,xd=[0,0,0,0],Sd,wd,Td,Md,Cd={},Ad=25,Pd,Ed,Id=null,Rd=0,Ld=new Set,Dd=[],kd=0;kd<8;kd++)Dd.push(new ce);function Od(e,t,i){var n=e._nearClip;var r=e._fov*Math.PI/180;var s=e._aspectRatio;var a=e._projection;var o,l;if(a===dh)l=Math.tan(r/2)*n;else l=e._orthoHeight;o=l*s;i[0].x=o;i[0].y=-l;i[0].z=-n;i[1].x=o;i[1].y=l;i[1].z=-n;i[2].x=-o;i[2].y=l;i[2].z=-n;i[3].x=-o;i[3].y=-l;i[3].z=-n;if(a===dh){l=Math.tan(r/2)*t;o=l*s}i[4].x=o;i[4].y=-l;i[4].z=-t;i[5].x=o;i[5].y=l;i[5].z=-t;i[6].x=-o;i[6].y=l;i[6].z=-t;i[7].x=-o;i[7].y=-l;i[7].z=-t;return i}var Fd=[new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce];function Bd(e,t,i,n,r,s,a){Fd[0].x=Fd[1].x=Fd[2].x=Fd[3].x=t.x;Fd[1].y=Fd[3].y=Fd[7].y=Fd[5].y=t.y;Fd[2].z=Fd[3].z=Fd[6].z=Fd[7].z=t.z;Fd[4].x=Fd[5].x=Fd[6].x=Fd[7].x=i.x;Fd[0].y=Fd[2].y=Fd[4].y=Fd[6].y=i.y;Fd[0].z=Fd[1].z=Fd[4].z=Fd[5].z=i.z;var o=9999999999;var l=-9999999999;var h;for(var c=0;c<8;++c){e.transformPoint(Fd[c],Fd[c]);h=Fd[c].z;if(h<o)o=h;if(h>l)l=h}return{min:o,max:l}}function Nd(e,t){if(t===Zl)return ii;else if(t===$l)return ei;else if(t===Jl)return ri;else if(t===Yl&&e.webgl2)return ri;return Kt}function zd(e,t){if(t===Yl&&!e.webgl2)return Mt;else if(t===Zl)return e.extTextureFloatLinear?Ct:Mt;else if(t===$l)return e.extTextureHalfFloatLinear?Ct:Mt;return Ct}function Vd(e,t,i,n){var r=Nd(e,n);var s=zd(e,n);var a=new bu(e,{format:r,width:t,height:i,mipmaps:false,minFilter:s,magFilter:s,addressU:We,addressV:We});a.name="shadowmap";if(n===Jl||n===Yl&&e.webgl2){a.compareOnRead=true;a.compareFunc=Lt;return new BM({depthBuffer:a})}return new BM({colorBuffer:a,depth:true})}function Ud(e,t){var i=new bu(e,{format:Kt,width:t,height:t,cubemap:true,mipmaps:false,minFilter:Mt,magFilter:Mt,addressU:We,addressV:We});i.name="shadowcube";var n=[];var r;for(var s=0;s<6;s++){r=new BM({colorBuffer:i,face:s,depth:true});n.push(r)}return n}function Gd(e,t){return Math.exp(-(e*e)/(2*t*t))}function Hd(e){if(e>Ad)e=Ad;var t=(e-1)/(2*3);var i,n,r,s;s=(e-1)*.5;n=new Array(e);r=0;for(i=0;i<e;++i){n[i]=Gd(i-s,t);r+=n[i]}for(i=0;i<e;++i)n[i]/=r;return n}function Wd(e,t,i){var n=t===Jl||t===Yl&&e.webgl2;if(i===zl)n=false;var r=new hf;if(t>=Ql&&t<=Zl)r.clearColor=new ge(0,0,0,0);else r.clearColor=new ge(1,1,1,1);r.clearColorBuffer=!n;r.clearDepthBuffer=true;r.clearStencilBuffer=false;r.node=new Mf;return r}function jd(e,t,i,n){if(n===void 0)n=0;var r=n*1e4+t;var s=jf[i][r];if(!s){s=Vd(e,t,t,i?i:Yl);jf[i][r]=s}return s}function Xd(e,t){var i;if(t._type===zl){if(t._shadowType>Yl)t._shadowType=Yl;if(t._cacheShadowMap){i=Cd[t._shadowResolution];if(!i){i=Ud(e,t._shadowResolution);Cd[t._shadowResolution]=i}}else i=Ud(e,t._shadowResolution);t._shadowCamera.renderTarget=i[0];t._shadowCubeMap=i}else{if(t._cacheShadowMap)i=jd(e,t._shadowResolution,t._shadowType);else i=Vd(e,t._shadowResolution,t._shadowResolution,t._shadowType);t._shadowCamera.renderTarget=i}t._isCachedShadowMap=t._cacheShadowMap}function qd(e){var t=e.material;var i=e.skinInstance?10:0;var n=0;if(t.opacityMap){var r=t.opacityMapChannel;if(r)n=Gf[r]}return i+n}var Yd=function(){function e(e){this.device=e;var t=this.device;this._shadowDrawCalls=0;this._forwardDrawCalls=0;this._skinDrawCalls=0;this._camerasRendered=0;this._materialSwitches=0;this._shadowMapUpdates=0;this._shadowMapTime=0;this._depthMapTime=0;this._forwardTime=0;this._cullTime=0;this._sortTime=0;this._skinTime=0;this._morphTime=0;this._instancingTime=0;this._layerCompositionUpdateTime=0;var i=t.getProgramLibrary();this.library=i;var n=t.scope;this.projId=n.resolve("matrix_projection");this.projSkyboxId=n.resolve("matrix_projectionSkybox");this.viewId=n.resolve("matrix_view");this.viewId3=n.resolve("matrix_view3");this.viewInvId=n.resolve("matrix_viewInverse");this.viewProjId=n.resolve("matrix_viewProjection");this.viewPos=new Float32Array(3);this.viewPosId=n.resolve("view_position");this.nearClipId=n.resolve("camera_near");this.farClipId=n.resolve("camera_far");this.cameraParamsId=n.resolve("camera_params");this.shadowMapLightRadiusId=n.resolve("light_radius");this.fogColorId=n.resolve("fog_color");this.fogStartId=n.resolve("fog_start");this.fogEndId=n.resolve("fog_end");this.fogDensityId=n.resolve("fog_density");this.modelMatrixId=n.resolve("matrix_model");this.normalMatrixId=n.resolve("matrix_normal");this.poseMatrixId=n.resolve("matrix_pose[0]");this.boneTextureId=n.resolve("texture_poseMap");this.boneTextureSizeId=n.resolve("texture_poseMapSize");this.morphWeightsA=n.resolve("morph_weights_a");this.morphWeightsB=n.resolve("morph_weights_b");this.morphPositionTex=n.resolve("morphPositionTex");this.morphNormalTex=n.resolve("morphNormalTex");this.morphTexParams=n.resolve("morph_tex_params");this.alphaTestId=n.resolve("alpha_ref");this.opacityMapId=n.resolve("texture_opacityMap");this.ambientId=n.resolve("light_globalAmbient");this.exposureId=n.resolve("exposure");this.skyboxIntensityId=n.resolve("skyboxIntensity");this.lightColorId=[];this.lightDir=[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=[];this.lightDirVs=[];this.lightDirVsId=[];this.lightRadiusId=[];this.lightPos=[];this.lightPosId=[];this.lightWidth=[];this.lightWidthId=[];this.lightHeight=[];this.lightHeightId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=n.resolve("uDepthMap");this.screenSizeId=n.resolve("uScreenSize");this._screenSize=new Float32Array(4);this.sourceId=n.resolve("source");this.pixelOffsetId=n.resolve("pixelOffset");this.weightId=n.resolve("weight[0]");this.blurVsmShaderCode=[ul.blurVSMPS,"#define GAUSS\n"+ul.blurVSMPS];var r="#define PACKED\n";this.blurPackedVsmShaderCode=[r+this.blurVsmShaderCode[0],r+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.twoSidedLightingNegScaleFactorId=n.resolve("twoSidedLightingNegScaleFactor");this.polygonOffsetId=n.resolve("polygonOffset");this.polygonOffset=new Float32Array(2);this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3);this.cameraParams=new Float32Array(4)}var t=e.prototype;t.sortCompare=function e(t,i){if(t.layer===i.layer)if(t.drawOrder&&i.drawOrder)return t.drawOrder-i.drawOrder;else if(t.zdist&&i.zdist)return i.zdist-t.zdist;else if(t.zdist2&&i.zdist2)return t.zdist2-i.zdist2;return i._key[sc]-t._key[sc]};t.sortCompareMesh=function e(t,i){if(t.layer===i.layer)if(t.drawOrder&&i.drawOrder)return t.drawOrder-i.drawOrder;else if(t.zdist&&i.zdist)return i.zdist-t.zdist;Pd=t._key[sc];Ed=i._key[sc];if(Pd===Ed&&t.mesh&&i.mesh)return i.mesh.id-t.mesh.id;return Ed-Pd};t.depthSortCompare=function e(t,i){Pd=t._key[ac];Ed=i._key[ac];if(Pd===Ed&&t.mesh&&i.mesh)return i.mesh.id-t.mesh.id;return Ed-Pd};t.lightCompare=function e(t,i){return t.key-i.key};t.getShadowCamera=function e(t,i){var n=i._shadowCamera;var r;if(n===null){n=i._shadowCamera=Wd(t,i._shadowType,i._type);Xd(t,i)}else{r=n.renderTarget;if(r.width!==i._shadowResolution||r.height!==i._shadowResolution)Xd(t,i)}return n};t.updateCameraFrustum=function e(t){if(t.vrDisplay&&t.vrDisplay.presenting){id=t.vrDisplay.combinedProj;var i=t._node.parent;if(i)Jf.copy(i.getWorldTransform()).mul(t.vrDisplay.combinedViewInv).invert();else Jf.copy(t.vrDisplay.combinedView);Zf.copy(Jf).invert();this.viewInvId.setValue(Zf.data);td.mul2(id,Jf);t.frustum.setFromMat4(td)}else if(t.xr&&t.xr.views.length){var n=t.xr.views[0];td.mul2(n.projMat,n.viewOffMat);t.frustum.setFromMat4(td);return}id=t.projectionMatrix;if(t.calculateProjection)t.calculateProjection(id,xc);if(t.calculateTransform)t.calculateTransform(Zf,xc);else{var r=t._node.getPosition();var s=t._node.getRotation();Zf.setTRS(r,s,ce.ONE);this.viewInvId.setValue(Zf.data)}Jf.copy(Zf).invert();td.mul2(id,Jf);t.frustum.setFromMat4(td)};t.setCamera=function e(t,i,n,r){var s=t.vrDisplay;var a,o;if(s&&s.presenting){hd=s.leftProj;cd=s.rightProj;id=s.combinedProj;if(t.calculateProjection){t.calculateProjection(hd,Sc);t.calculateProjection(cd,wc);t.calculateProjection(id,xc)}if(t.calculateTransform){t.calculateTransform(nd,Sc);t.calculateTransform(rd,wc);t.calculateTransform(Zf,xc);sd.copy(nd).invert();ad.copy(rd).invert();Jf.copy(Zf).invert()}else{a=t._node.parent;if(a){o=a.getWorldTransform();nd.mul2(o,s.leftViewInv);rd.mul2(o,s.rightViewInv);sd.copy(nd).invert();ad.copy(rd).invert();Jf.copy(a.getWorldTransform()).mul(s.combinedViewInv).invert()}else{nd.copy(s.leftViewInv);rd.copy(s.rightViewInv);sd.copy(s.leftView);ad.copy(s.rightView);Jf.copy(s.combinedView)}}ud.setFromMat4(sd);fd.setFromMat4(ad);dd.mul2(hd,sd);pd.mul2(cd,ad);od.x=nd.data[12];od.y=nd.data[13];od.z=nd.data[14];ld.x=rd.data[12];ld.y=rd.data[13];ld.z=rd.data[14];td.mul2(id,Jf);t.frustum.setFromMat4(td)}else if(t.xr&&t.xr.session){a=t._node.parent;if(a)o=a.getWorldTransform();var l=t.xr.views;for(var h=0;h<l.length;h++){var c=l[h];if(a){c.viewInvOffMat.mul2(o,c.viewInvMat);c.viewOffMat.copy(c.viewInvOffMat).invert()}else{c.viewInvOffMat.copy(c.viewInvMat);c.viewOffMat.copy(c.viewMat)}c.viewMat3.setFromMat4(c.viewOffMat);c.projViewOffMat.mul2(c.projMat,c.viewOffMat);c.position[0]=c.viewInvOffMat.data[12];c.position[1]=c.viewInvOffMat.data[13];c.position[2]=c.viewInvOffMat.data[14];t.frustum.setFromMat4(c.projViewOffMat)}}else{id=t.projectionMatrix;if(t.calculateProjection)t.calculateProjection(id,xc);this.projId.setValue(id.data);this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data);if(t.calculateTransform)t.calculateTransform(Zf,xc);else{var u=t._node.getPosition();var f=t._node.getRotation();Zf.setTRS(u,f,ce.ONE)}this.viewInvId.setValue(Zf.data);Jf.copy(Zf).invert();this.viewId.setValue(Jf.data);ed.setFromMat4(Jf);this.viewId3.setValue(ed.data);td.mul2(id,Jf);this.viewProjId.setValue(td.data);var d=t._node.getPosition();this.viewPos[0]=d.x;this.viewPos[1]=d.y;this.viewPos[2]=d.z;this.viewPosId.setValue(this.viewPos);t.frustum.setFromMat4(td)}this.nearClipId.setValue(t._nearClip);this.farClipId.setValue(t._farClip);var p=t._nearClip;var m=t._farClip;this.cameraParams[0]=1/m;this.cameraParams[1]=m;this.cameraParams[2]=(1-m/p)*.5;this.cameraParams[3]=(1+m/p)*.5;this.cameraParamsId.setValue(this.cameraParams);this.clearView(t,i,n,false);var _=this.device;var v=i?i.width:_.width;var g=i?i.height:_.height;var y=t.scissorRect;var b=Math.floor(y.x*v);var x=Math.floor(y.y*g);var S=Math.floor(y.z*v);var w=Math.floor(y.w*g);_.setScissor(b,x,S,w);if(r)_.setScissor(1,1,v-2,g-2)};t.clearView=function e(t,i,n,r,s){var a=this.device;a.setRenderTarget(i);a.updateBegin();if(r){a.setColorWrite(true,true,true,true);a.setDepthWrite(true)}var o=t.rect;var l=i?i.width:a.width;var h=i?i.height:a.height;var c=Math.floor(o.x*l);var u=Math.floor(o.y*h);var f=Math.floor(o.z*l);var d=Math.floor(o.w*h);a.setViewport(c,u,f,d);a.setScissor(c,u,f,d);if(n){if(!s)s=t._clearOptions;a.clear(s?s:{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?ft:0)|(t._clearDepthBuffer?dt:0)|(t._clearStencilBuffer?pt:0),stencil:t._clearStencil})}};t.dispatchGlobalLights=function e(t){var i;this.mainLight=-1;this.ambientColor[0]=t.ambientLight.r;this.ambientColor[1]=t.ambientLight.g;this.ambientColor[2]=t.ambientLight.b;if(t.gammaCorrection)for(i=0;i<3;i++)this.ambientColor[i]=Math.pow(this.ambientColor[i],2.2);this.ambientId.setValue(this.ambientColor);this.exposureId.setValue(t.exposure);if(t.skyboxModel)this.skyboxIntensityId.setValue(t.skyboxIntensity)};t._resolveLight=function e(t,i){var n="light"+i;this.lightColorId[i]=t.resolve(n+"_color");this.lightDir[i]=new Float32Array(3);this.lightDirId[i]=t.resolve(n+"_direction");this.lightShadowMapId[i]=t.resolve(n+"_shadowMap");this.lightShadowMatrixId[i]=t.resolve(n+"_shadowMatrix");this.lightShadowParamsId[i]=t.resolve(n+"_shadowParams");this.lightShadowMatrixVsId[i]=t.resolve(n+"_shadowMatrixVS");this.lightShadowParamsVsId[i]=t.resolve(n+"_shadowParamsVS");this.lightDirVs[i]=new Float32Array(3);this.lightDirVsId[i]=t.resolve(n+"_directionVS");this.lightRadiusId[i]=t.resolve(n+"_radius");this.lightPos[i]=new Float32Array(3);this.lightPosId[i]=t.resolve(n+"_position");this.lightWidth[i]=new Float32Array(3);this.lightWidthId[i]=t.resolve(n+"_halfWidth");this.lightHeight[i]=new Float32Array(3);this.lightHeightId[i]=t.resolve(n+"_halfHeight");this.lightInAngleId[i]=t.resolve(n+"_innerConeAngle");this.lightOutAngleId[i]=t.resolve(n+"_outerConeAngle");this.lightPosVsId[i]=t.resolve(n+"_positionVS");this.lightCookieId[i]=t.resolve(n+"_cookie");this.lightCookieIntId[i]=t.resolve(n+"_cookieIntensity");this.lightCookieMatrixId[i]=t.resolve(n+"_cookieMatrix");this.lightCookieOffsetId[i]=t.resolve(n+"_cookieOffset")};t.setLTCDirectionallLight=function e(t,i,n,r,s){this.lightPos[i][0]=r.x-n.x*s;this.lightPos[i][1]=r.y-n.y*s;this.lightPos[i][2]=r.z-n.z*s;this.lightPosId[i].setValue(this.lightPos[i]);var a=t.transformVector(new ce(-.5,0,0));this.lightWidth[i][0]=a.x*s;this.lightWidth[i][1]=a.y*s;this.lightWidth[i][2]=a.z*s;this.lightWidthId[i].setValue(this.lightWidth[i]);var o=t.transformVector(new ce(0,0,.5));this.lightHeight[i][0]=o.x*s;this.lightHeight[i][1]=o.y*s;this.lightHeight[i][2]=o.z*s;this.lightHeightId[i].setValue(this.lightHeight[i])};t.dispatchDirectLights=function e(t,i,n,r){var s=t.length;var a;var o,l;var h=0;this.mainLight=-1;var c=this.device.scope;for(a=0;a<s;a++){if(!(t[a].mask&n))continue;o=t[a];l=o._node.getWorldTransform();if(!this.lightColorId[h])this._resolveLight(c,h);this.lightColorId[h].setValue(i.gammaCorrection?o._linearFinalColor:o._finalColor);l.getY(o._direction).scale(-1);o._direction.normalize();this.lightDir[h][0]=o._direction.x;this.lightDir[h][1]=o._direction.y;this.lightDir[h][2]=o._direction.z;this.lightDirId[h].setValue(this.lightDir[h]);if(o.shape!==Gl)this.setLTCDirectionallLight(l,h,o._direction,r._node.getPosition(),r.farClip);if(o.castShadows){var u=o._isPcf&&this.device.webgl2?o._shadowCamera.renderTarget.depthBuffer:o._shadowCamera.renderTarget.colorBuffer;var f;if(o._isVsm)f=-1e-5*20;else{f=o.shadowBias/o._shadowCamera._farClip*100;if(!this.device.webgl2&&this.device.extStandardDerivatives)f*=-100}var d=o._isVsm?o.vsmBias/(o._shadowCamera._farClip/7):o._normalOffsetBias;this.lightShadowMapId[h].setValue(u);this.lightShadowMatrixId[h].setValue(o._shadowMatrix.data);var p=o._rendererParams;if(p.length!==3)p.length=3;p[0]=o._shadowResolution;p[1]=d;p[2]=f;this.lightShadowParamsId[h].setValue(p);if(this.mainLight<0){this.lightShadowMatrixVsId[h].setValue(o._shadowMatrix.data);this.lightShadowParamsVsId[h].setValue(p);o._direction.normalize();this.lightDirVs[h][0]=o._direction.x;this.lightDirVs[h][1]=o._direction.y;this.lightDirVs[h][2]=o._direction.z;this.lightDirVsId[h].setValue(this.lightDirVs[h]);this.mainLight=a}}h++}return h};t.setLTCPositionalLight=function e(t,i){var n=t.transformVector(new ce(-.5,0,0));this.lightWidth[i][0]=n.x;this.lightWidth[i][1]=n.y;this.lightWidth[i][2]=n.z;this.lightWidthId[i].setValue(this.lightWidth[i]);var r=t.transformVector(new ce(0,0,.5));this.lightHeight[i][0]=r.x;this.lightHeight[i][1]=r.y;this.lightHeight[i][2]=r.z;this.lightHeightId[i].setValue(this.lightHeight[i])};t.dispatchOmniLight=function e(t,i,n,r){var s=n._node.getWorldTransform();if(!this.lightColorId[r])this._resolveLight(i,r);this.lightRadiusId[r].setValue(n.attenuationEnd);this.lightColorId[r].setValue(t.gammaCorrection?n._linearFinalColor:n._finalColor);s.getTranslation(n._position);this.lightPos[r][0]=n._position.x;this.lightPos[r][1]=n._position.y;this.lightPos[r][2]=n._position.z;this.lightPosId[r].setValue(this.lightPos[r]);if(n.shape!==Gl)this.setLTCPositionalLight(s,r);if(n.castShadows){var a=n._shadowCamera.renderTarget.colorBuffer;this.lightShadowMapId[r].setValue(a);var o=n._rendererParams;if(o.length!==4)o.length=4;o[0]=n._shadowResolution;o[1]=n._normalOffsetBias;o[2]=n.shadowBias;o[3]=1/n.attenuationEnd;this.lightShadowParamsId[r].setValue(o)}if(n._cookie){this.lightCookieId[r].setValue(n._cookie);this.lightShadowMatrixId[r].setValue(s.data);this.lightCookieIntId[r].setValue(n.cookieIntensity)}};t.dispatchSpotLight=function e(t,i,n,r){var s=n._node.getWorldTransform();if(!this.lightColorId[r])this._resolveLight(i,r);this.lightInAngleId[r].setValue(n._innerConeAngleCos);this.lightOutAngleId[r].setValue(n._outerConeAngleCos);this.lightRadiusId[r].setValue(n.attenuationEnd);this.lightColorId[r].setValue(t.gammaCorrection?n._linearFinalColor:n._finalColor);s.getTranslation(n._position);this.lightPos[r][0]=n._position.x;this.lightPos[r][1]=n._position.y;this.lightPos[r][2]=n._position.z;this.lightPosId[r].setValue(this.lightPos[r]);if(n.shape!==Gl)this.setLTCPositionalLight(s,r);s.getY(n._direction).scale(-1);n._direction.normalize();this.lightDir[r][0]=n._direction.x;this.lightDir[r][1]=n._direction.y;this.lightDir[r][2]=n._direction.z;this.lightDirId[r].setValue(this.lightDir[r]);if(n.castShadows){var a;if(n._isVsm)a=-1e-5*20;else{a=n.shadowBias*20;if(!this.device.webgl2&&this.device.extStandardDerivatives)a*=-100}var o=n._isVsm?n.vsmBias/(n.attenuationEnd/7):n._normalOffsetBias;var l=n._isPcf&&this.device.webgl2?n._shadowCamera.renderTarget.depthBuffer:n._shadowCamera.renderTarget.colorBuffer;this.lightShadowMapId[r].setValue(l);this.lightShadowMatrixId[r].setValue(n._shadowMatrix.data);var h=n._rendererParams;if(h.length!==4)h.length=4;h[0]=n._shadowResolution;h[1]=o;h[2]=a;h[3]=1/n.attenuationEnd;this.lightShadowParamsId[r].setValue(h)}if(n._cookie){this.lightCookieId[r].setValue(n._cookie);if(!n.castShadows){var c=this.getShadowCamera(this.device,n);var u=c._node;u.setPosition(n._node.getPosition());u.setRotation(n._node.getRotation());u.rotateLocal(-90,0,0);c.projection=dh;c.aspectRatio=1;c.fov=n._outerConeAngle*2;Kf.setTRS(u.getPosition(),u.getRotation(),ce.ONE).invert();Qf.mul2(c.projectionMatrix,Kf);n._shadowMatrix.mul2(Uf,Qf)}this.lightShadowMatrixId[r].setValue(n._shadowMatrix.data);this.lightCookieIntId[r].setValue(n.cookieIntensity);if(n._cookieTransform){n._cookieTransformUniform[0]=n._cookieTransform.x;n._cookieTransformUniform[1]=n._cookieTransform.y;n._cookieTransformUniform[2]=n._cookieTransform.z;n._cookieTransformUniform[3]=n._cookieTransform.w;this.lightCookieMatrixId[r].setValue(n._cookieTransformUniform);n._cookieOffsetUniform[0]=n._cookieOffset.x;n._cookieOffsetUniform[1]=n._cookieOffset.y;this.lightCookieOffsetId[r].setValue(n._cookieOffsetUniform)}}};t.dispatchLocalLights=function e(t,i,n,r,s){var a;var o,l;var h=t[zl];var c=t[Ul];var u=r;var f=h.length;var d=c.length;var p=u;var m=this.device.scope;for(a=0;a<f;a++){o=h[a];if(!(o.mask&n))continue;if(o.isStatic)continue;this.dispatchOmniLight(i,m,o,p);p++}var _=0;if(s){o=s[_];while(o&&o._type===zl){this.dispatchOmniLight(i,m,o,p);p++;_++;o=s[_]}}for(a=0;a<d;a++){l=c[a];if(!(l.mask&n))continue;if(l.isStatic)continue;this.dispatchSpotLight(i,m,l,p);p++}if(s){l=s[_];while(l&&l._type===Ul){this.dispatchSpotLight(i,m,l,p);p++;_++;l=s[_]}}};t.cull=function e(t,i,n){var r=0;var s,a,o;var l=i.length;var h=t.cullingMask||4294967295;if(!t.frustumCulling){for(s=0;s<l;s++){a=i[s];if(!a.visible&&!a.command)continue;if(a.mask&&(a.mask&h)===0)continue;n[r]=a;r++;a.visibleThisFrame=true}return r}for(s=0;s<l;s++){a=i[s];if(!a.command){if(!a.visible)continue;o=true;if(a.mask&&(a.mask&h)===0)continue;if(a.cull)o=a._isVisible(t);if(o){n[r]=a;r++;a.visibleThisFrame=true}}else{n[r]=a;r++;a.visibleThisFrame=true}}return r};t.cullLights=function e(t,i){var n,r;for(n=0;n<i.length;n++){r=i[n];if(r.castShadows&&r.enabled&&r.shadowUpdateMode!==ic)if(r._type!==Nl){r.getBoundingSphere(yd);if(t.frustum.containsSphere(yd))r.visibleThisFrame=true}}};t.updateCpuSkinMatrices=function e(t){Rd++;var i=t.length;if(i===0)return;var n,r;for(n=0;n<i;n++){r=t[n].skinInstance;if(r){r.updateMatrices(t[n].node,Rd);r._dirty=true}}};t.updateGpuSkinMatrices=function e(t){var i,n;var r=t.length;for(i=0;i<r;i++){if(!t[i].visibleThisFrame)continue;n=t[i].skinInstance;if(n)if(n._dirty){n.updateMatrixPalette(t[i].node,Rd);n._dirty=false}}};t.updateMorphing=function e(t){var i,n;var r=t.length;for(i=0;i<r;i++){n=t[i].morphInstance;if(n&&n._dirty&&t[i].visibleThisFrame)n.update()}};t.setBaseConstants=function e(t,i){t.setCullMode(i.cull);if(i.opacityMap){this.opacityMapId.setValue(i.opacityMap);this.alphaTestId.setValue(i.alphaTest)}};t.setSkinning=function e(t,i,n){if(i.skinInstance){this._skinDrawCalls++;if(t.supportsBoneTextures){Sd=i.skinInstance.boneTexture;this.boneTextureId.setValue(Sd);xd[0]=Sd.width;xd[1]=Sd.height;xd[2]=1/Sd.width;xd[3]=1/Sd.height;this.boneTextureSizeId.setValue(xd)}else this.poseMatrixId.setValue(i.skinInstance.matrixPalette)}};t.drawInstance=function e(t,i,n,r,s){wd=i.instancingData;if(wd){if(wd.count>0){this._instancedDrawCalls++;t.setVertexBuffer(wd.vertexBuffer);t.draw(n.primitive[r],wd.count);if(wd.vertexBuffer===Id){this._removedByInstancing+=wd.count;i.instancingData=null;return wd.count-1}}}else{Td=i.node.worldTransform;this.modelMatrixId.setValue(Td.data);if(s){Md=i.node.normalMatrix;if(i.node._dirtyNormal){Td.invertTo3x3(Md);Md.transpose();i.node._dirtyNormal=false}this.normalMatrixId.setValue(Md.data)}t.draw(n.primitive[r])}return 0};t.drawInstance2=function e(t,i,n,r){wd=i.instancingData;if(wd){if(wd.count>0){this._instancedDrawCalls++;t.draw(n.primitive[r],wd.count,true);if(wd.vertexBuffer===Id){this._removedByInstancing+=wd.count;i.instancingData=null;return wd.count-1}}}else t.draw(n.primitive[r],undefined,true);return 0};t.renderShadows=function e(t,i){var n=this.device;n.grabPassAvailable=false;var r,s,a,o,l,h,c,u,f,d,p;var m;var _,v,g;var y;var b;var x,S;var w=1<<dc;for(r=0;r<t.length;r++){a=t[r];l=a._type;if(!a.castShadows||!a.enabled)continue;if(!a._shadowCamera)this.getShadowCamera(n,a);if(a.shadowUpdateMode!==ic&&a.visibleThisFrame){var T;h=this.getShadowCamera(n,a);c=h._node;u=0;f=1;if(l===Nl){if(a._visibleLength[i]<0)continue;b=a._visibleCameraSettings[i];c.setPosition(b.x,b.y,b.z);h.orthoHeight=b.orthoHeight;h.farClip=b.farClip;u=i}else if(l===Ul){T=c.getPosition();this.viewPos[0]=T.x;this.viewPos[1]=T.y;this.viewPos[2]=T.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(a.attenuationEnd)}else if(l===zl){T=c.getPosition();this.viewPos[0]=T.x;this.viewPos[1]=T.y;this.viewPos[2]=T.z;this.viewPosId.setValue(this.viewPos);this.shadowMapLightRadiusId.setValue(a.attenuationEnd);f=6}if(l!==zl){Kf.setTRS(c.getPosition(),c.getRotation(),ce.ONE).invert();Qf.mul2(h.projectionMatrix,Kf);a._shadowMatrix.mul2(Uf,Qf)}if(n.webgl2)if(l===zl)n.setDepthBias(false);else{n.setDepthBias(true);n.setDepthBiasValues(a.shadowBias*-1e3,a.shadowBias*-1e3)}else if(n.extStandardDerivatives)if(l===zl){this.polygonOffset[0]=0;this.polygonOffset[1]=0;this.polygonOffsetId.setValue(this.polygonOffset)}else{this.polygonOffset[0]=a.shadowBias*-1e3;this.polygonOffset[1]=a.shadowBias*-1e3;this.polygonOffsetId.setValue(this.polygonOffset)}if(a.shadowUpdateMode===nc)a.shadowUpdateMode=ic;this._shadowMapUpdates+=f;n.setBlending(false);n.setDepthWrite(true);n.setDepthTest(true);if(a._isPcf&&n.webgl2&&l!==zl)n.setColorWrite(false,false,false,false);else n.setColorWrite(true,true,true,true);if(u)f=u+1;else u=0;while(u<f){if(l===zl){c.setRotation(Hf[u]);h.renderTarget=a._shadowCubeMap[u]}this.setCamera(h,h.renderTarget,true,l!==zl);x=a._visibleList[u];S=a._visibleLength[u];d=a._shadowType;p=d+l*Wf;for(s=0,m=S;s<m;s++){_=x[s];v=_.mesh;g=_.material;this.setBaseConstants(n,g);this.setSkinning(n,_,g);if(g.dirty){g.updateUniforms();g.dirty=false}if(g.chunks){this.setCullMode(true,false,_);g.setParameters(n);_.setParameters(n,w)}o=_._shader[dc+p];if(!o){this.updateShader(_,_._shaderDefs,null,dc+p);o=_._shader[dc+p];_._key[ac]=qd(_)}n.setShader(o);y=_.renderStyle;this.setVertexBuffers(n,v);this.setMorphing(n,_.morphInstance);n.setIndexBuffer(v.indexBuffer[y]);s+=this.drawInstance(n,_,v,y);this._shadowDrawCalls++}u++;if(l===Nl)a._visibleLength[i]=-1}if(a._isVsm){var M=a._vsmBlurSize;if(M>1){var C=h.renderTarget;var A=jd(n,a._shadowResolution,a._shadowType,1);var P=a._shadowType===Ql;var E=a.vsmBlurMode;var I=(P?this.blurPackedVsmShader:this.blurVsmShader)[E][M];if(!I){this.blurVsmWeights[M]=Hd(M);var R=ul.fullscreenQuadVS;var L="#define SAMPLES "+M+"\n";if(P)L+=this.blurPackedVsmShaderCode[E];else L+=this.blurVsmShaderCode[E];var D="blurVsm"+E+""+M+""+P;I=Qc(this.device,R,L,D);if(P)this.blurPackedVsmShader[E][M]=I;else this.blurVsmShader[E][M]=I}Yf.z=a._shadowResolution-2;Yf.w=Yf.z;this.sourceId.setValue(C.colorBuffer);qf[0]=1/a._shadowResolution;qf[1]=0;this.pixelOffsetId.setValue(qf);if(E===th)this.weightId.setValue(this.blurVsmWeights[M]);Ar(n,A,I,null,Yf);this.sourceId.setValue(A.colorBuffer);qf[1]=qf[0];qf[0]=0;this.pixelOffsetId.setValue(qf);Ar(n,C,I,null,Yf)}}}}if(n.webgl2)n.setDepthBias(false);else if(n.extStandardDerivatives){this.polygonOffset[0]=0;this.polygonOffset[1]=0;this.polygonOffsetId.setValue(this.polygonOffset)}n.grabPassAvailable=true};t.updateShader=function e(t,i,n,r,s){t.material._scene=this.scene;if(t.material._dirtyBlend)this.scene.layers._dirtyBlend=true;t.material.updateShader(this.device,this.scene,i,n,r,s);t._shader[r]=t.material.shader};t.setCullMode=function e(t,i,n){var r=n.material;var s=xt;if(t){var a=1;if(r.cull>xt&&r.cull<Tt){if(n.flipFaces)a*=-1;if(i)a*=-1;var o=n.node.worldTransform;o.getX(md);o.getY(_d);o.getZ(vd);md.cross(md,_d);if(md.dot(vd)<0)a*=-1}if(a<0)s=r.cull===wt?St:wt;else s=r.cull}this.device.setCullMode(s);if(s===xt&&r.cull===xt){var l=n.node.worldTransform;l.getX(md);l.getY(_d);l.getZ(vd);md.cross(md,_d);if(md.dot(vd)<0)this.twoSidedLightingNegScaleFactorId.setValue(-1);else this.twoSidedLightingNegScaleFactorId.setValue(1)}};t.setVertexBuffers=function e(t,i){t.setVertexBuffer(i.vertexBuffer)};t.setMorphing=function e(t,i){if(i)if(i.morph.useTextureMorph){t.setVertexBuffer(i.morph.vertexBufferIds);this.morphPositionTex.setValue(i.texturePositions);this.morphNormalTex.setValue(i.textureNormals);this.morphTexParams.setValue(i._textureParams)}else{var n,r;for(var s=0;s<i._activeVertexBuffers.length;s++){n=i._activeVertexBuffers[s];if(n){r=Ui+(s+8);n.format.elements[0].name=r;n.format.elements[0].scopeId=t.scope.resolve(r);n.format.update();t.setVertexBuffer(n)}}this.morphWeightsA.setValue(i._shaderMorphWeightsA);this.morphWeightsB.setValue(i._shaderMorphWeightsB)}};t.renderForward=function e(t,i,n,r,s,a,o,l){var h=this.device;var c=this.scene;var u=t.vrDisplay;var f=l?l._lightHash:0;var d=1<<s;var p,m,_,v,g,y,b,x,S;var w=null,T,M,C;var A,P;var E=h.width*.5;for(p=0;p<n;p++){m=i[p];if(a&&m.mask&&!(a&m.mask))continue;if(m.command)m.command();else{_=m.mesh;v=m.material;g=m._shaderDefs;b=m.mask;this.setSkinning(h,m,v);if(v&&v===w&&g!==T)w=null;if(m.isStatic||C)w=null;if(v!==w){this._materialSwitches++;if(v.dirty){v.updateUniforms();v.dirty=false}if(!m._shader[s]||m._shaderDefs!==g||m._lightHash!==f){if(!m.isStatic){y=s+"_"+g+"_"+f;m._shader[s]=v.variants[y];if(!m._shader[s]){this.updateShader(m,g,null,s,r);v.variants[y]=m._shader[s]}}else this.updateShader(m,g,m._staticLightList,s,r);m._shaderDefs=g;m._lightHash=f}if(!m._shader[s].failed&&!h.setShader(m._shader[s]))m._shader[s].failed=true;v.setParameters(h);if(!w||b!==M){S=this.dispatchDirectLights(r[Nl],c,b,t);this.dispatchLocalLights(r,c,b,S,m._staticLightList)}this.alphaTestId.setValue(v.alphaTest);h.setBlending(v.blend);if(v.blend)if(v.separateAlphaBlend){h.setBlendFunctionSeparate(v.blendSrc,v.blendDst,v.blendSrcAlpha,v.blendDstAlpha);h.setBlendEquationSeparate(v.blendEquation,v.blendAlphaEquation)}else{h.setBlendFunction(v.blendSrc,v.blendDst);h.setBlendEquation(v.blendEquation)}h.setColorWrite(v.redWrite,v.greenWrite,v.blueWrite,v.alphaWrite);h.setDepthWrite(v.depthWrite);if(v.depthWrite&&!v.depthTest){h.setDepthFunc(Nt);h.setDepthTest(true)}else{h.setDepthFunc(kt);h.setDepthTest(v.depthTest)}h.setAlphaToCoverage(v.alphaToCoverage);if(v.depthBias||v.slopeDepthBias){h.setDepthBias(true);h.setDepthBiasValues(v.depthBias,v.slopeDepthBias)}else h.setDepthBias(false)}this.setCullMode(t._cullFaces,t._flipFaces,m);A=m.stencilFront||v.stencilFront;P=m.stencilBack||v.stencilBack;if(A||P){h.setStencilTest(true);if(A===P){h.setStencilFunc(A.func,A.ref,A.readMask);h.setStencilOperation(A.fail,A.zfail,A.zpass,A.writeMask)}else{if(A){h.setStencilFuncFront(A.func,A.ref,A.readMask);h.setStencilOperationFront(A.fail,A.zfail,A.zpass,A.writeMask)}else{h.setStencilFuncFront(Nt,0,255);h.setStencilOperationFront(an,an,an,255)}if(P){h.setStencilFuncBack(P.func,P.ref,P.readMask);h.setStencilOperationBack(P.fail,P.zfail,P.zpass,P.writeMask)}else{h.setStencilFuncBack(Nt,0,255);h.setStencilOperationBack(an,an,an,255)}}}else h.setStencilTest(false);m.setParameters(h,d);this.setVertexBuffers(h,_);this.setMorphing(h,m.morphInstance);x=m.renderStyle;h.setIndexBuffer(_.indexBuffer[x]);if(o)o(m,p);if(u&&u.presenting){h.setViewport(0,0,E,h.height);this.projId.setValue(hd.data);this.projSkyboxId.setValue(hd.data);this.viewInvId.setValue(nd.data);this.viewId.setValue(sd.data);this.viewId3.setValue(ud.data);this.viewProjId.setValue(dd.data);this.viewPos[0]=od.x;this.viewPos[1]=od.y;this.viewPos[2]=od.z;this.viewPosId.setValue(this.viewPos);p+=this.drawInstance(h,m,_,x,true);this._forwardDrawCalls++;h.setViewport(E,0,E,h.height);this.projId.setValue(cd.data);this.projSkyboxId.setValue(cd.data);this.viewInvId.setValue(rd.data);this.viewId.setValue(ad.data);this.viewId3.setValue(fd.data);this.viewProjId.setValue(pd.data);this.viewPos[0]=ld.x;this.viewPos[1]=ld.y;this.viewPos[2]=ld.z;this.viewPosId.setValue(this.viewPos);p+=this.drawInstance2(h,m,_,x);this._forwardDrawCalls++}else if(t.xr&&t.xr.session&&t.xr.views.length){var I=t.xr.views;for(var R=0;R<I.length;R++){var L=I[R];h.setViewport(L.viewport.x,L.viewport.y,L.viewport.z,L.viewport.w);this.projId.setValue(L.projMat.data);this.projSkyboxId.setValue(L.projMat.data);this.viewId.setValue(L.viewOffMat.data);this.viewInvId.setValue(L.viewInvOffMat.data);this.viewId3.setValue(L.viewMat3.data);this.viewProjId.setValue(L.projViewOffMat.data);this.viewPosId.setValue(L.position);if(R===0)p+=this.drawInstance(h,m,_,x,true);else p+=this.drawInstance2(h,m,_,x);this._forwardDrawCalls++}}else{p+=this.drawInstance(h,m,_,x,true);this._forwardDrawCalls++}if(p<n-1&&i[p+1].material===v)v.setParameters(h,m.parameters);w=v;T=g;M=b;C=m.isStatic}}h.updateEnd()};t.setupInstancing=function e(t){if(t.enableAutoInstancing)if(!Id)Id=new lr(t,cr.defaultInstancingFormat,t.autoInstancingMaxObjects,ht)};t.revertStaticMeshes=function e(t){var i;var n=t;var r=n.length;var s;var a=[];var o;for(i=0;i<r;i++){s=n[i];if(s._staticSource){if(s._staticSource!==o){a.push(s._staticSource);o=s._staticSource}}else a.push(s)}t.length=a.length;for(i=0;i<a.length;i++)t[i]=a[i]};t.prepareStaticMeshes=function e(t,i){var n,r,s,a,o,l;var h=this.device;var c=this.scene;var u=t;var f=u.length;var d,p;var m=[];var _;var v,g,y,b,x,S,w;var T,M,C;var A,P,E,I,R,L;var D,k;var O=new ce;var F=new ce;var B=new Ce;var N=new ve;var z=[];var V;var U,G;var H,W,j;var X;var q=[];var Y;var K=[];var Q=[];var $;var Z;for(n=0;n<f;n++){d=u[n];if(!d.isStatic)m.push(d);else{Y=d.aabb;Q.length=0;for(X=zl;X<=Ul;X++)for(r=0;r<i.length;r++){p=i[r];if(p._type!==X)continue;if(p.enabled)if(p.mask&d.mask)if(p.isStatic){if(!q[r]){q[r]=new Ce;p._node.getWorldTransform();p.getBoundingSphere(yd);q[r].center.copy(yd.center);q[r].halfExtents.x=yd.radius;q[r].halfExtents.y=yd.radius;q[r].halfExtents.z=yd.radius}if(!q[r].intersects(Y))continue;Q.push(r)}}if(Q.length===0){m.push(d);continue}_=d.mesh;G=_.vertexBuffer;U=_.indexBuffer[d.renderStyle];v=U.bytesPerIndex===2?new Uint16Array(U.lock()):new Uint32Array(U.lock());y=_.primitive[d.renderStyle].count/3;w=_.primitive[d.renderStyle].base;b=G.format.elements;x=G.format.size/4;g=new Float32Array(G.storage);for(s=0;s<b.length;s++)if(b[s].name===Ci)S=b[s].offset/4;z.length=y;for(s=0;s<y;s++)z[s]=0;V=false;K.length=y*6;for(s=0;s<y;s++){A=Number.MAX_VALUE;P=Number.MAX_VALUE;E=Number.MAX_VALUE;I=-Number.MAX_VALUE;R=-Number.MAX_VALUE;L=-Number.MAX_VALUE;for(a=0;a<3;a++){l=v[s*3+a+w];l=l*x+S;T=g[l];M=g[l+1];C=g[l+2];if(T<A)A=T;if(M<P)P=M;if(C<E)E=C;if(T>I)I=T;if(M>R)R=M;if(C>L)L=C}l=s*6;K[l]=A;K[l+1]=P;K[l+2]=E;K[l+3]=I;K[l+4]=R;K[l+5]=L}for(o=0;o<Q.length;o++){r=Q[o];p=i[r];N.copy(d.node.worldTransform).invert();B.setFromTransformedAabb(q[r],N);D=B.getMin();k=B.getMax();$=1<<o;for(s=0;s<y;s++){l=s*6;if(K[l]<=k.x&&K[l+3]>=D.x&&K[l+1]<=k.y&&K[l+4]>=D.y&&K[l+2]<=k.z&&K[l+5]>=D.z){z[s]|=$;V=true}}}if(V){H={};for(s=0;s<y;s++){r=s*3+w;W=z[s];if(!H[W])H[W]=[];j=H[W];j.push(v[r]);j.push(v[r+1]);j.push(v[r+2])}for(W in H){j=H[W];var J=new Eu(h,U.format,j.length,U.usage);var ee=J.bytesPerIndex===2?new Uint16Array(J.lock()):new Uint32Array(J.lock());ee.set(j);J.unlock();A=Number.MAX_VALUE;P=Number.MAX_VALUE;E=Number.MAX_VALUE;I=-Number.MAX_VALUE;R=-Number.MAX_VALUE;L=-Number.MAX_VALUE;for(s=0;s<j.length;s++){l=j[s];T=g[l*x+S];M=g[l*x+S+1];C=g[l*x+S+2];if(T<A)A=T;if(M<P)P=M;if(C<E)E=C;if(T>I)I=T;if(M>R)R=M;if(C>L)L=C}O.set(A,P,E);F.set(I,R,L);var te=new Ce;te.setMinMax(O,F);var ie=new Du(h);ie.vertexBuffer=G;ie.indexBuffer[0]=J;ie.primitive[0].type=wi;ie.primitive[0].base=0;ie.primitive[0].count=j.length;ie.primitive[0].indexed=true;ie.aabb=te;var ne=new zu(d.node,ie,d.material);ne.isStatic=d.isStatic;ne.visible=d.visible;ne.layer=d.layer;ne.castShadow=d.castShadow;ne._receiveShadow=d._receiveShadow;ne.cull=d.cull;ne.pick=d.pick;ne.mask=d.mask;ne.parameters=d.parameters;ne._shaderDefs=d._shaderDefs;ne._staticSource=d;if(d._staticLightList)ne._staticLightList=d._staticLightList;else ne._staticLightList=[];for(s=0;s<Q.length;s++){$=1<<s;if(W&$){Z=i[Q[s]];if(ne._staticLightList.indexOf(Z)<0)ne._staticLightList.push(Z)}}ne._staticLightList.sort(this.lightCompare);m.push(ne)}}else m.push(d)}}t.length=m.length;for(n=0;n<m.length;n++)t[n]=m[n]};t.updateShaders=function e(t){var i,n=t.length;for(var r=0;r<n;r++){i=t[r].material;if(i)if(!Ld.has(i)){Ld.add(i);if(i.updateShader!==Cu.prototype.updateShader){i.clearVariants();i.shader=null}}}Ld.clear()};t.updateLitShaders=function e(t){var i,n=t.length;for(var r=0;r<n;r++){i=t[r].material;if(i)if(!Ld.has(i)){Ld.add(i);if(i.updateShader!==Cu.prototype.updateShader)if(i.useLighting&&(!i.emitter||i.emitter.lighting)){i.clearVariants();i.shader=null}}}Ld.clear()};t.beginFrame=function e(t){var i=this.scene;var n=t._meshInstances;var r=t._lights;if(i.updateShaders){this.updateShaders(n);i.updateShaders=false;i.updateLitShaders=false;i._shaderVersion++}else if(i.updateLitShaders){this.updateLitShaders(n);i.updateLitShaders=false;i._shaderVersion++}this.updateCpuSkinMatrices(n);var s;var a=n.length;for(s=0;s<a;s++)n[s].visibleThisFrame=false;a=r.length;for(s=0;s<a;s++)r[s].visibleThisFrame=r[s]._type===Nl};t.beginLayers=function e(t){var i=this.scene;var n=t.layerList.length;var r;var s,a;var o=this.scene._shaderVersion;for(s=0;s<n;s++)t.layerList[s]._postRenderCounter=0;var l;for(s=0;s<n;s++){r=t.layerList[s];r._shaderVersion=o;r._preRenderCalledForCameras=0;r._postRenderCalledForCameras=0;l=t.subLayerList[s];if(l)r._postRenderCounter|=2;else r._postRenderCounter|=1;r._postRenderCounterMax=r._postRenderCounter;for(a=0;a<r.cameras.length;a++){if(!r.instances.visibleOpaque[a])r.instances.visibleOpaque[a]=new Nf;if(!r.instances.visibleTransparent[a])r.instances.visibleTransparent[a]=new Nf;r.instances.visibleOpaque[a].done=false;r.instances.visibleTransparent[a].done=false}if(r.cameras.length<r.instances.visibleOpaque.length)r.instances.visibleOpaque.splice(r.cameras.length,1);if(r.cameras.length<r.instances.visibleTransparent.length)r.instances.visibleTransparent.splice(r.cameras.length,1);if(r._needsStaticPrepare&&r._staticLightHash){if(r._staticPrepareDone){this.revertStaticMeshes(r.opaqueMeshInstances);this.revertStaticMeshes(r.transparentMeshInstances)}this.prepareStaticMeshes(r.opaqueMeshInstances,r._lights);this.prepareStaticMeshes(r.transparentMeshInstances,r._lights);t._dirty=true;i.updateShaders=true;r._needsStaticPrepare=false;r._staticPrepareDone=true}}};t.cullLocalShadowmap=function e(t,i){var n,r,s,a,o,l,h,c,u,f,d;var p;r=t._type;if(r===Nl)return;t.visibleThisFrame=true;s=this.getShadowCamera(this.device,t);s.projection=dh;s.nearClip=t.attenuationEnd/1e3;s.farClip=t.attenuationEnd;s.aspectRatio=1;if(r===Ul){s.fov=t._outerConeAngle*2;o=1}else{s.fov=90;o=6}a=s._node;p=t._node;a.setPosition(p.getPosition());if(r===Ul){a.setRotation(p.getRotation());a.rotateLocal(-90,0,0)}for(l=0;l<o;l++){if(r===zl){a.setRotation(Hf[l]);s.renderTarget=t._shadowCubeMap[l]}this.updateCameraFrustum(s);u=t._visibleList[l];if(!u)u=t._visibleList[l]=[];t._visibleLength[l]=0;f=0;for(n=0,h=i.length;n<h;n++){c=i[n];d=true;if(c.cull)d=c._isVisible(s);if(d){u[f]=c;f++;c.visibleThisFrame=true}}t._visibleLength[l]=f;if(u.length!==f)u.length=f;u.sort(this.depthSortCompare)}};t.cullDirectionalShadowmap=function e(t,i,n,r){var s,a,o,l,h,c,u;var f,d,p;var m,_,v,g,y,b,x,S;var w,T;var M;var C;var A;var P=this.device;t.visibleThisFrame=true;a=this.getShadowCamera(P,t);o=a._node;l=t._node;o.setPosition(l.getPosition());o.setRotation(l.getRotation());o.rotateLocal(-90,0,0);Od(n,t.shadowDistance||n._farClip,Dd);h=gd.sub2(Dd[0],Dd[6]).length();h=Math.max(h,gd.sub2(Dd[4],Dd[6]).length());Kf.copy(o.getWorldTransform()).invert();$f.copy(Kf).mul(n._node.getWorldTransform());for(s=0;s<8;s++)$f.transformPoint(Dd[s],Dd[s]);m=_=v=1e6;g=y=b=-1e6;for(s=0;s<8;s++){p=Dd[s];if(p.x<m)m=p.x;if(p.x>g)g=p.x;if(p.y<_)_=p.y;if(p.y>y)y=p.y;if(p.z<v)v=p.z;if(p.z>b)b=p.z}f=h/t._shadowResolution;d=(h-(g-m))*.5;m=Math.floor((m-d)/f)*f;d=(h-(y-_))*.5;_=Math.floor((_-d)/f)*f;g=m+h;y=_+h;x=(g+m)*.5;S=(y+_)*.5;o.translateLocal(x,S,1e5);a.projection=ph;a.nearClip=0;a.farClip=2e5;a.aspectRatio=1;a.orthoHeight=h*.5;this.updateCameraFrustum(a);C=true;u=t._visibleList[r];if(!u)u=t._visibleList[r]=[];c=t._visibleLength[r]=0;for(s=0,T=i.length;s<T;s++){M=i[s];w=true;if(M.cull)w=M._isVisible(a);if(w){u[c]=M;c++;M.visibleThisFrame=true;A=M.aabb;if(C){bd.copy(A);C=false}else bd.add(A)}}t._visibleLength[r]=c;if(u.length!==c)u.length=c;u.sort(this.depthSortCompare);var E=Bd(Kf,bd.getMin(),bd.getMax());b=E.max;if(E.min>v)v=E.min;o.setPosition(l.getPosition());o.translateLocal(x,S,b+Xf);a.farClip=b-v;var I=t._visibleCameraSettings[r];if(!I)I=t._visibleCameraSettings[r]={};var R=o.getPosition();I.x=R.x;I.y=R.y;I.z=R.z;I.orthoHeight=a.orthoHeight;I.farClip=a.farClip};t.gpuUpdate=function e(t){this.updateGpuSkinMatrices(t);this.updateMorphing(t)};t.setSceneConstants=function e(){var t;var i=this.device;var n=this.scene;this.dispatchGlobalLights(n);if(n.fog!==wl){this.fogColor[0]=n.fogColor.r;this.fogColor[1]=n.fogColor.g;this.fogColor[2]=n.fogColor.b;if(n.gammaCorrection)for(t=0;t<3;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor);if(n.fog===Tl){this.fogStartId.setValue(n.fogStart);this.fogEndId.setValue(n.fogEnd)}else this.fogDensityId.setValue(n.fogDensity)}this._screenSize[0]=i.width;this._screenSize[1]=i.height;this._screenSize[2]=1/i.width;this._screenSize[3]=1/i.height;this.screenSizeId.setValue(this._screenSize)};t.updateLightStats=function e(t,i){};t.renderComposition=function e(t){var i=this.device;var n;var r=t._renderedRt;var s=t._renderedByCam;var a=t._renderedLayer;var o,l=t._renderActions;var h,c,u,f,d,p,m,_,v,g,y;if(this.scene.updateSkybox){this.scene._updateSkybox(i);this.scene.updateSkybox=false}this.beginLayers(t);var b=t._update();if(b&Rc)this.scene.updateLitShaders=true;this.updateLightStats(t,b);this.beginFrame(t);this.setSceneConstants();var x=0;var S;var w,T,M;for(h=0;h<l.length;h++){o=l[h];u=o.layerIndex;c=t.layerList[u];if(!c.enabled||!t.subLayerEnabled[u])continue;f=t.subLayerList[u];S=o.cameraIndex;n=c.cameras[S];if(!n)continue;n.frameBegin(o.renderTarget);v=false;g=false;for(_=0;_<x;_++)if(s[_]===n){v=true;if(a[_]===c){g=true;break}}if(!v){this.updateCameraFrustum(n.camera);this._camerasRendered++}if(!g)this.cullLights(n.camera,c._lights);if(!v||!g){s[x]=n;a[x]=c;x++}w=c.instances;M=f?w.visibleTransparent[S]:w.visibleOpaque[S];if(!M.done){if(c.onPreCull)c.onPreCull(p);T=f?c.transparentMeshInstances:c.opaqueMeshInstances;M.length=this.cull(n.camera,T,M.list);M.done=true;if(c.onPostCull)c.onPostCull(S)}n.frameEnd()}var C,A;for(h=0;h<t._lights.length;h++){C=t._lights[h];if(!C.visibleThisFrame)continue;if(C._type===Nl)continue;if(!C.castShadows||!C.enabled||C.shadowUpdateMode===ic)continue;A=t._lightShadowCasters[h];this.cullLocalShadowmap(C,A)}var P=-1;for(h=0;h<t._lights.length;h++){C=t._lights[h];if(C._type!==Nl)continue;P++;if(!C.castShadows||!C.enabled||C.shadowUpdateMode===ic)continue;A=t._lightShadowCasters[h];d=t._globalLightCameras[P];for(p=0;p<d.length;p++)this.cullDirectionalShadowmap(C,A,d[p].camera,t._globalLightCameraIds[P][p])}this.gpuUpdate(t._meshInstances);this.renderShadows(t._splitLights[Ul]);this.renderShadows(t._splitLights[zl]);x=0;for(h=0;h<l.length;h++){o=l[h];u=o.layerIndex;c=t.layerList[u];if(!c.enabled||!t.subLayerEnabled[u])continue;f=t.subLayerList[u];S=o.cameraIndex;n=c.cameras[S];if(n)n.frameBegin(o.renderTarget);if(!f&&c.onPreRenderOpaque)c.onPreRenderOpaque(S);else if(f&&c.onPreRenderTransparent)c.onPreRenderTransparent(S);if(!(c._preRenderCalledForCameras&1<<S)){if(c.onPreRender)c.onPreRender(S);c._preRenderCalledForCameras|=1<<S;if(c.overrideClear)this.clearView(n.camera,o.renderTarget,true,true,c._clearOptions)}if(n){m=o.renderTarget;y=false;for(_=0;_<x;_++)if(r[_]===m&&s[_]===n){y=true;break}if(!y){if(!c.overrideClear)this.clearView(n.camera,o.renderTarget,true,true);r[x]=m;s[x]=n;x++}this.renderShadows(c._splitLights[Nl],S);c._sortVisible(f,n.camera.node,S);w=c.instances;M=f?w.visibleTransparent[S]:w.visibleOpaque[S];this.scene._activeCamera=n.camera;this.setCamera(n.camera,o.renderTarget);this.renderForward(n.camera,M.list,M.length,c._splitLights,c.shaderPass,c.cullingMask,c.onDrawCall,c);i.setColorWrite(true,true,true,true);i.setStencilTest(false);i.setAlphaToCoverage(false);i.setDepthBias(false);n.frameEnd()}if(!f&&c.onPostRenderOpaque)c.onPostRenderOpaque(S);else if(f&&c.onPostRenderTransparent)c.onPostRenderTransparent(S);if(c.onPostRender&&!(c._postRenderCalledForCameras&1<<S)){c._postRenderCounter&=~(f?2:1);if(c._postRenderCounter===0){c.onPostRender(S);c._postRenderCalledForCameras|=1<<S;c._postRenderCounter=c._postRenderCounterMax}}}};return e}(),Kd=function(t){G(i,t);function i(){var e;e=t.call(this)||this;e.color=new ge(1,1,1,1);e.colorUniform=new Float32Array(4);e.colorMap=null;e.vertexColors=false;return e}var e=i.prototype;e.clone=function e(){var e=new i;Cu.prototype._cloneInternal.call(this,e);e.color.copy(this.color);e.colorMap=this.colorMap;e.vertexColors=this.vertexColors;return e};e.updateUniforms=function e(){this.clearParameters();this.colorUniform[0]=this.color.r;this.colorUniform[1]=this.color.g;this.colorUniform[2]=this.color.b;this.colorUniform[3]=this.color.a;this.setParameter("uColor",this.colorUniform);if(this.colorMap)this.setParameter("texture_diffuseMap",this.colorMap)};e.updateShader=function e(t,i,n,r,s,a){var o={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:s};var l=t.getProgramLibrary();this.shader=l.getProgram("basic",o)};return i}(Cu),Qd=new Mf,$d=function(){function e(e){this.lineVertexFormat=new cr(e,[{semantic:Ci,components:3,type:In},{semantic:Ri,components:4,type:Mn,normalize:true}]);this.lineBatches=[];this.layers=[];this.layerToBatch={};this.quadMesh=null;this.cubeLocalPos=null;this.cubeWorldPos=null}var t=e.prototype;t.addLayer=function e(t){if(this.layers.indexOf(t)<0)this.layers.push(t)};t.getLayerIdx=function e(t){return this.layerToBatch[t.id]};t.addLayerIdx=function e(t,i){this.layerToBatch[i.id]=t};return e}(),Zd=function(){function e(){this.numLinesAllocated=128;this.vb=null;this.vbRam=null;this.mesh=null;this.linesUsed=0;this.material=null;this.meshInstance=null;this.layer=null}var t=e.prototype;t.init=function e(t,i,n,r){if(!this.mesh){this.mesh=new Du(t);this.mesh.primitive[0].type=bi;this.mesh.primitive[0].base=0;this.mesh.primitive[0].indexed=false;this.material=new Kd;this.material.vertexColors=true;this.material.blend=true;this.material.blendType=pl;this.material.update()}this.layer=n;while(this.linesUsed+r>this.numLinesAllocated){if(this.vb){this.vb.destroy();this.vb=null}this.numLinesAllocated*=2}this.vertexFormat=i;if(!this.vb){this.vb=new lr(t,i,this.numLinesAllocated*2,ht);this.mesh.vertexBuffer=this.vb;this.vbRam=new DataView(this.vb.lock());if(!this.meshInstance){Qd.worldTransform=ve.IDENTITY;Qd._dirtyWorld=Qd._dirtyNormal=false;this.meshInstance=new zu(Qd,this.mesh,this.material);this.meshInstance.cull=false}}};t.addLines=function e(t,i){var n=!!i.length;var r=this.linesUsed*2*this.vertexFormat.size;var s;for(var a=0;a<t.length;a++){this.vbRam.setFloat32(r,t[a].x,true);r+=4;this.vbRam.setFloat32(r,t[a].y,true);r+=4;this.vbRam.setFloat32(r,t[a].z,true);r+=4;s=n?i[a]:i;this.vbRam.setUint8(r,s.r*255);r+=1;this.vbRam.setUint8(r,s.g*255);r+=1;this.vbRam.setUint8(r,s.b*255);r+=1;this.vbRam.setUint8(r,s.a*255);r+=1}this.linesUsed+=t.length/2};t.finalize=function e(t){if(this.linesUsed>0){this.vb.setData(this.vbRam.buffer);this.mesh.primitive[0].count=this.linesUsed*2;t[0]=this.meshInstance;this.layer.addMeshInstances(t,true);this.linesUsed=0}};return e}(),Jd=function e(){this.layerIndex=0;this.cameraIndex=0;this.renderTarget=null},ep=function(t){G(e,t);function e(){var e;e=t.call(this)||this;e.layerList=[];e.subLayerList=[];e.subLayerEnabled=[];e._opaqueOrder={};e._transparentOrder={};e._dirty=false;e._dirtyBlend=false;e._dirtyLights=false;e._dirtyCameras=false;e._meshInstances=[];e._meshInstancesSet=new Set;e._lights=[];e._lightsMap=new Map;e._lightShadowCasters=[];e._lightShadowCastersSets=[];e._splitLights=[[],[],[]];e._globalLightCameras=[];e.cameras=[];e._globalLightCameraIds=[];e._renderedRt=[];e._renderedByCam=[];e._renderedLayer=[];e._renderActions=[];return e}var i=e.prototype;i._splitLightsArray=function e(t){var i;var n=t._lights;t._splitLights[Nl].length=0;t._splitLights[zl].length=0;t._splitLights[Ul].length=0;for(var r=0;r<n.length;r++){i=n[r];if(i.enabled)t._splitLights[i._type].push(i)}};i._update=function e(){var t,i,n,r;var s;var a=this.layerList.length;var o=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(t=0;t<a;t++){s=this.layerList[t];if(s._dirty)this._dirty=true;if(s._dirtyLights)this._dirtyLights=true;if(s._dirtyCameras)this._dirtyCameras=true}function l(e,t,i){var n,r,s=false;var a=i.length;for(var o=0;o<a;o++){n=i[o];if(!t.has(n)){t.add(n);e.push(n);r=n.material;if(r&&r._dirtyBlend){s=true;r._dirtyBlend=false}}}return s}if(this._dirty){o|=Ic;this._meshInstances.length=0;this._meshInstancesSet.clear();for(t=0;t<a;t++){s=this.layerList[t];if(!s.passThrough){this._dirtyBlend=l(this._meshInstances,this._meshInstancesSet,s.opaqueMeshInstances)||this._dirtyBlend;this._dirtyBlend=l(this._meshInstances,this._meshInstancesSet,s.transparentMeshInstances)||this._dirtyBlend}s._dirty=false;s._version++}this._dirty=false}function h(e,t,i){var n,r;for(var s=0;s<t.length;){n=t[s].material;r=n&&n.blendType!==ml;if(r===i){e.push(t[s]);t[s]=t[t.length-1];t.length--}else s++}}if(this._dirtyBlend){o|=Dc;for(t=0;t<a;t++){s=this.layerList[t];if(!s.passThrough){h(s.opaqueMeshInstances,s.transparentMeshInstances,false);h(s.transparentMeshInstances,s.opaqueMeshInstances,true)}}this._dirtyBlend=false}var c,u;if(this._dirtyLights){o|=Rc;this._lights.length=0;this._lightsMap.clear();for(t=0;t<a;t++){s=this.layerList[t];u=s._lights;for(i=0;i<u.length;i++){c=u[i];if(!this._lightsMap.has(c)){this._lightsMap.set(c,this._lights.length);this._lights.push(c)}}}var f=this._lights.length;this._lightShadowCasters.length=f;this._lightShadowCastersSets.length=f;for(t=0;t<f;t++){if(this._lightShadowCasters[t])this._lightShadowCasters[t].length=0;else this._lightShadowCasters[t]=[];if(this._lightShadowCastersSets[t])this._lightShadowCastersSets[t].clear();else this._lightShadowCastersSets[t]=new Set}this._splitLightsArray(this);this._dirtyLights=false;for(t=0;t<a;t++){s=this.layerList[t];this._splitLightsArray(s);s._dirtyLights=false}}var d,p;var m,_;var v;if(o){for(t=0;t<this._lightShadowCasters.length;t++){this._lightShadowCasters[t].length=0;this._lightShadowCastersSets[t].clear()}for(t=0;t<a;t++){s=this.layerList[t];u=s._lights;for(i=0;i<u.length;i++){v=this._lightsMap.get(u[i]);d=this._lightShadowCasters[v];p=this._lightShadowCastersSets[v];m=s.shadowCasters;for(n=0;n<m.length;n++){_=m[n];if(!p.has(_)){p.add(_);d.push(_)}}}}}if(o&Rc||this._dirtyCameras){this._globalLightCameras.length=0;var g=this._splitLights[Nl];for(r=0;r<g.length;r++){c=g[r];this._globalLightCameras[r]=[];for(t=0;t<a;t++){s=this.layerList[t];if(s._splitLights[Nl].indexOf(c)>=0)for(n=0;n<s.cameras.length;n++)if(this._globalLightCameras[r].indexOf(s.cameras[n])<0)this._globalLightCameras[r].push(s.cameras[n])}}}var y=0;var b=this._renderActions;function x(e,t,i){var n=b[y];if(!n)n=b[y]=new Jd;n.layerIndex=t;n.cameraIndex=i;var r=e.cameras[i];var s=r?r.renderTarget:undefined;n.renderTarget=s?s:e.renderTarget;y++}var S,w,T;if(this._dirtyCameras){this._dirtyCameras=false;o|=Lc;this.cameras.length=0;for(t=0;t<a;t++){s=this.layerList[t];s._dirtyCameras=false;for(i=0;i<s.cameras.length;i++){S=s.cameras[i];w=this.cameras.indexOf(S);if(w<0)this.cameras.push(S)}}var M,C;var A=0;for(t=0;t<a;t++){if(A){A--;continue}s=this.layerList[t];if(s.cameras.length===0&&!s.isPostEffect)continue;M=s._cameraHash;if(M===0)x(s,t,0);else{C=1;for(i=t+1;i<a;i++)if(M!==this.layerList[i]._cameraHash){C=i-t-1;break}else if(i===a-1)C=i-t;if(C===1)for(T=0;T<s.cameras.length;T++)x(s,t,T);else{for(T=0;T<s.cameras.length;T++)for(i=0;i<=C;i++)x(s,t+i,T);A=C}}}this._renderActions.length=y}var P;if(o&Rc||o&Lc){this._globalLightCameraIds.length=0;for(r=0;r<this._globalLightCameras.length;r++){P=[];for(t=0;t<this._globalLightCameras[r].length;t++){w=this.cameras.indexOf(this._globalLightCameras[r][t]);if(w<0)continue;P.push(w)}this._globalLightCameraIds.push(P)}}return o};i._isLayerAdded=function e(t){if(this.layerList.indexOf(t)>=0)return true;return false};i._isSublayerAdded=function e(t,i){for(var n=0;n<this.layerList.length;n++)if(this.layerList[n]===t&&this.subLayerList[n]===i)return true;return false};i.push=function e(t){if(this._isLayerAdded(t))return;this.layerList.push(t);this.layerList.push(t);this._opaqueOrder[t.id]=this.subLayerList.push(false)-1;this._transparentOrder[t.id]=this.subLayerList.push(true)-1;this.subLayerEnabled.push(true);this.subLayerEnabled.push(true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.insert=function e(t,i){if(this._isLayerAdded(t))return;this.layerList.splice(i,0,t,t);this.subLayerList.splice(i,0,false,true);var n=this.layerList.length;this._updateOpaqueOrder(i,n-1);this._updateTransparentOrder(i,n-1);this.subLayerEnabled.splice(i,0,true,true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.remove=function e(t){var i=this.layerList.indexOf(t);delete this._opaqueOrder[i];delete this._transparentOrder[i];while(i>=0){this.layerList.splice(i,1);this.subLayerList.splice(i,1);this.subLayerEnabled.splice(i,1);i=this.layerList.indexOf(t);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("remove",t)}var n=this.layerList.length;this._updateOpaqueOrder(0,n-1);this._updateTransparentOrder(0,n-1)};i.pushOpaque=function e(t){if(this._isSublayerAdded(t,false))return;this.layerList.push(t);this._opaqueOrder[t.id]=this.subLayerList.push(false)-1;this.subLayerEnabled.push(true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.insertOpaque=function e(t,i){if(this._isSublayerAdded(t,false))return;this.layerList.splice(i,0,t);this.subLayerList.splice(i,0,false);var n=this.subLayerList.length;this._updateOpaqueOrder(i,n-1);this.subLayerEnabled.splice(i,0,true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.removeOpaque=function e(t){for(var i=0,n=this.layerList.length;i<n;i++)if(this.layerList[i]===t&&!this.subLayerList[i]){this.layerList.splice(i,1);this.subLayerList.splice(i,1);n--;this._updateOpaqueOrder(i,n-1);this.subLayerEnabled.splice(i,1);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;if(this.layerList.indexOf(t)<0)this.fire("remove",t);return}};i.pushTransparent=function e(t){if(this._isSublayerAdded(t,true))return;this.layerList.push(t);this._transparentOrder[t.id]=this.subLayerList.push(true)-1;this.subLayerEnabled.push(true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.insertTransparent=function e(t,i){if(this._isSublayerAdded(t,true))return;this.layerList.splice(i,0,t);this.subLayerList.splice(i,0,true);var n=this.subLayerList.length;this._updateTransparentOrder(i,n-1);this.subLayerEnabled.splice(i,0,true);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;this.fire("add",t)};i.removeTransparent=function e(t){for(var i=0,n=this.layerList.length;i<n;i++)if(this.layerList[i]===t&&this.subLayerList[i]){this.layerList.splice(i,1);this.subLayerList.splice(i,1);n--;this._updateTransparentOrder(i,n-1);this.subLayerEnabled.splice(i,1);this._dirty=true;this._dirtyLights=true;this._dirtyCameras=true;if(this.layerList.indexOf(t)<0)this.fire("remove",t);return}};i._getSublayerIndex=function e(t,i){var n=this.layerList.indexOf(t);if(n<0)return-1;if(this.subLayerList[n]!==i){n=this.layerList.indexOf(t,n+1);if(n<0)return-1;if(this.subLayerList[n]!==i)return-1}return n};i.getOpaqueIndex=function e(t){return this._getSublayerIndex(t,false)};i.getTransparentIndex=function e(t){return this._getSublayerIndex(t,true)};i.getLayerById=function e(t){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i].id===t)return this.layerList[i];return null};i.getLayerByName=function e(t){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i].name===t)return this.layerList[i];return null};i._updateOpaqueOrder=function e(t,i){for(var n=t;n<=i;n++)if(this.subLayerList[n]===false)this._opaqueOrder[this.layerList[n].id]=n};i._updateTransparentOrder=function e(t,i){for(var n=t;n<=i;n++)if(this.subLayerList[n]===true)this._transparentOrder[this.layerList[n].id]=n};i._sortLayersDescending=function e(t,i,n){var r=0;var s=0;var a=0;var o=-1;var l=-1;for(r=0,s=t.length;r<s;r++){a=t[r];if(n.hasOwnProperty(a))o=Math.max(o,n[a])}for(r=0,s=i.length;r<s;r++){a=i[r];if(n.hasOwnProperty(a))l=Math.max(l,n[a])}if(o===-1&&l!==-1)return 1;else if(l===-1&&o!==-1)return-1;return l-o};i.sortTransparentLayers=function e(t,i){return this._sortLayersDescending(t,i,this._transparentOrder)};i.sortOpaqueLayers=function e(t,i){return this._sortLayersDescending(t,i,this._opaqueOrder)};return e}(u),tp=2048,ip=2,np=4,rp=[],sp=[],ap,op=new ce,lp=new Ce,hp=new Ce,cp={},up=0,fp=1,dp=["texture_lightMap","texture_dirLightMap"],pp=[];function mp(e,t,i,n){if(!e.enabled)return;var r,s;if(e.model&&e.model.model&&e.model.enabled){if(n)n.push(e);if(e.model.lightmapped)if(t)s=e.model.model.meshInstances}if(e.render&&e.render.enabled){if(n)n.push(e);if(e.render.lightmapped)if(t)s=e.render.meshInstances}if(s){var a=true;for(r=0;r<s.length;r++)if(!s[r].mesh.vertexBuffer.format.hasUv1){a=false;break}if(a){var o;var l;var h=[];for(r=0;r<s.length;r++){l=false;for(o=0;o<s.length;o++)if(r!==o)if(s[r].mesh===s[o].mesh)l=true;if(l){t.push(e);i.push([s[r]])}else h.push(s[r])}if(h.length>0){t.push(e);i.push(h)}}}for(r=0;r<e._children.length;r++)mp(e._children[r],t,i,n)}var _p=function(){function e(e,t,i,n,r){this.device=e;this.root=t;this.scene=i;this.renderer=n;this.assets=r}var t=e.prototype;t.destroy=function e(){this.device=null;this.root=null;this.scene=null;this.renderer=null;this.assets=null};t.calculateLightmapSize=function e(t){var i,n;var r=this.scene.lightmapSizeMultiplier||16;var s=op;var a,o;if(t.model){o=t.model.lightmapSizeMultiplier;if(t.model.asset){i=this.assets.get(t.model.asset).data;if(i.area)a=i.area}else if(t.model._area){i=t.model;if(i._area)a=i._area}}else if(t.render){o=t.render.lightmapSizeMultiplier;if(t.render.type!=="asset")if(t.render._area){i=t.render;if(i._area)a=i._area}}var l={x:1,y:1,z:1,uv:1};if(a){l.x=a.x;l.y=a.y;l.z=a.z;l.uv=a.uv}var h=o||1;l.x*=h;l.y*=h;l.z*=h;s.copy(t.localScale);n=t._parent;while(n){s.mul(n.localScale);n=n._parent}s.x=Math.abs(s.x);s.y=Math.abs(s.y);s.z=Math.abs(s.z);var c=l.x*s.y*s.z+l.y*s.x*s.z+l.z*s.x*s.y;c/=l.uv;c=Math.sqrt(c);return Math.min(Pe.nextPowerOfTwo(c*r),this.scene.lightmapMaxResolution||tp)};t.bake=function e(t,i){var n,r;var s=this.device;var a=this.scene;var o=1;if(i===undefined)i=bc;if(i===bc)o=2;var l;var h=[];var c=[];if(!t){for(n=0;n<rp.length;n++)for(r=0;r<rp[n].length;r++)rp[n][r].destroy();rp=[];sp=[];t=[];mp(this.root,t,c,h)}else{var u;for(n=sp.length-1;n>=0;n--)for(r=0;r<t.length;r++)if(sp[n]===t[r]){for(u=0;u<rp[n].length;u++)rp[n][u].destroy();rp.splice(n,1);sp.splice(n,1)}var f=[];for(n=0;n<t.length;n++)mp(t[n],f,c);t=f;mp(this.root,null,null,h)}if(t.length===0){s.fire("lightmapper:end",{timestamp:ye(),target:this});return}var d=false;if(a._needsStaticPrepare){a._needsStaticPrepare=false;d=true}var p=[[],[]];var m={};var _;var v;var g=new bu(this.device,{width:4,height:4,format:Kt,type:vn});g.name="lightmap";for(n=0;n<t.length;n++){_=this.calculateLightmapSize(t[n]);for(l=0;l<o;l++){v=new bu(s,{width:_,height:_,format:Kt,mipmaps:false,type:l===up?vn:_n,minFilter:Mt,magFilter:Mt});v.name="lightmap";p[l].push(v)}if(!m[_]){var y=new bu(s,{width:_,height:_,format:Kt,mipmaps:false,type:vn,minFilter:Mt,magFilter:Mt});y.name="lightmap";var b=new BM(s,y,{depth:false});m[_]=b}}var x=a.layers;x._update();var S=[];var w=[];var T=[];var M=[];var C=x._lights;var A;for(n=0;n<C.length;n++){if(C[n].enabled){A=C[n].mask;if((A&np)!==0){w.push(A);T.push(C[n].shadowUpdateMode);C[n].mask=4294967295;C[n].shadowUpdateMode=C[n]._type===Nl?rc:nc;S.push(C[n]);C[n].isStatic=false}}M.push(C[n].enabled);C[n].enabled=false}var P="#define UV1LAYOUT\n"+ul.transformVS;var E=ul.bakeLmEndPS;var I=ul.dilatePS;var R=Qc(s,ul.fullscreenQuadVS,I,"lmDilate");var L=s.scope.resolve("source");var D=s.scope.resolve("pixelOffset");var k=s.scope.resolve("bakeDir");var O=new Float32Array(2);var F=x._meshInstances;for(n=0;n<F.length;n++)if(F[n].node)F[n].node.getWorldTransform();var B=a.fog;var N=a.ambientLight.r;var z=a.ambientLight.g;var V=a.ambientLight.b;a.fog=wl;a.ambientLight.set(0,0,0);if(!ap){ap=new hf;ap.clearColor=new ge(0,0,0,0);ap.clearColorBuffer=true;ap.clearDepthBuffer=false;ap.clearStencilBuffer=false;ap.frustumCulling=false;ap.node=new Mf}var U;var G,H,W;var j=function e(t){return t.render?t.render:t.model};var X=function e(t){return t.render?t.render.meshInstances:t.model.model.meshInstances};var q=[];q.length=sp.length;var Y;for(U=0;U<h.length;U++){H=X(h[U]);Y=[];for(n=0;n<H.length;n++){Y.push(H[n]._shaderDefs);H[n]._shaderDefs&=~(Xh|qh)}for(n=0;n<sp.length;n++)if(sp[n]===h[U]){q[n]=Y;break}}var K=[];var Q=[];var $;var Z;for(U=0;U<h.length;U++){Z=j(h[U]);K[U]=Z.castShadows;Z.castShadows=Z.castShadowsLightmap;if(Z.castShadowsLightmap){$=X(h[U]);for(n=0;n<$.length;n++){$[n].visibleThisFrame=true;Q.push($[n])}}}this.renderer.updateCpuSkinMatrices(Q);this.renderer.gpuUpdate(Q);var J=[];var ee=[];var te=[[],[]];var ie,ne,re;var se,ae;var oe=[];oe.length=t.length;var le;for(l=0;l<o;l++)if(!pp[l]){le=new pM;le.chunks.transformVS=P;if(l===up){le.chunks.endPS=E;le.ambient=new ge(0,0,0);le.ambientTint=true;le.lightMap=g}else{le.chunks.basePS=ul.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n";le.chunks.endPS=ul.bakeDirLmEndPS}le.chunks.outputAlphaPS="\n";le.chunks.outputAlphaOpaquePS="\n";le.chunks.outputAlphaPremulPS="\n";le.cull=xt;le.forceUv1=true;le.update();le.updateShader(s,a);le.name="lmMaterial"+l;pp[l]=le}for(U=0;U<t.length;U++){H=c[U];oe[U]=0;if(H.length>0){lp.copy(H[0].aabb);for(n=0;n<H.length;n++){H[n].node.getWorldTransform();lp.add(H[n].aabb)}}var he=new Ce;he.copy(lp);ee.push(he);for(n=0;n<H.length;n++){W=H[n];W._shaderDefs&=~(Xh|qh);W.mask=np;W.deleteParameter("texture_lightMap");W.deleteParameter("texture_dirLightMap");W.setParameter("texture_lightMap",W.material.lightMap?W.material.lightMap:g);W.setParameter("texture_dirLightMap",g)}for(l=0;l<o;l++){G=p[l][U];ie=new BM(s,G,{depth:false});te[l].push(ie)}}for(r=0;r<S.length;r++)S[r].enabled=false;var ce=[[],[],[]];var ue=false;var fe;for(n=0;n<S.length;n++){S[n].enabled=true;fe=false;S[n]._cacheShadowMap=true;if(S[n]._type!==Nl){S[n]._node.getWorldTransform();S[n].getBoundingSphere(cp);hp.center=cp.center;hp.halfExtents.x=cp.radius;hp.halfExtents.y=cp.radius;hp.halfExtents.z=cp.radius}if(S[n]._type===Ul){se=S[n];ae=this.renderer.getShadowCamera(s,se);ae._node.setPosition(se._node.getPosition());ae._node.setRotation(se._node.getRotation());ae._node.rotateLocal(-90,0,0);ae.projection=dh;ae.nearClip=se.attenuationEnd/1e3;ae.farClip=se.attenuationEnd;ae.aspectRatio=1;ae.fov=se._outerConeAngle*2;this.renderer.updateCameraFrustum(ae)}if(c.length>0)this.renderer.updateShaders(c[0]);for(U=0;U<t.length;U++){H=c[U];lp=ee[U];if(S[n]._type===Nl){op.copy(lp.center);op.y+=lp.halfExtents.y;ap.node.setPosition(op);ap.node.setEulerAngles(-90,0,0);var de=Math.max(lp.halfExtents.x,lp.halfExtents.z);ap.projection=ph;ap.nearClip=0;ap.farClip=lp.halfExtents.y*2;ap.aspectRatio=1;ap.orthoHeight=de}else if(!hp.intersects(lp))continue;if(S[n]._type===Ul){var pe=false;for(r=0;r<H.length;r++)if(H[r]._isVisible(ae)){pe=true;break}if(!pe)continue}if(S[n]._type===Nl){ce[Nl][0]=S[n];ce[zl].length=0;ce[Ul].length=0;if(!fe&&S[n].castShadows){this.renderer.cullDirectionalShadowmap(S[n],Q,ap,0);this.renderer.renderShadows(ce[Nl],0);fe=true}}else{ce[Nl].length=0;if(S[n]._type===zl){ce[zl][0]=S[n];ce[Ul].length=0;if(!fe&&S[n].castShadows){this.renderer.cullLocalShadowmap(S[n],Q);this.renderer.renderShadows(ce[zl]);fe=true}}else{ce[zl].length=0;ce[Ul][0]=S[n];if(!fe&&S[n].castShadows){this.renderer.cullLocalShadowmap(S[n],Q);this.renderer.renderShadows(ce[Ul]);fe=true}}}for(r=0;r<H.length;r++)J[r]=H[r].material;for(l=0;l<o;l++){G=p[l][U];ie=te[l][U];ne=m[G.width];re=ne.colorBuffer;if(l===0)ue=a.updateShaders;else if(ue)a.updateShaders=true;for(r=0;r<H.length;r++)H[r].material=pp[l];if(o>1)this.renderer.updateShaders(H);this.renderer.setCamera(ap,ne,true);if(l===fp)k.setValue(S[n].bakeDir?1:0);this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(ap,H,H.length,ce,uc);p[l][U]=re;te[l][U]=ne;m[G.width]=ie;for(r=0;r<H.length;r++){W=H[r];W.setParameter(dp[l],re);W._shaderDefs|=Xh}}oe[U]++;for(r=0;r<H.length;r++)H[r].material=J[r]}S[n].enabled=false;S[n]._cacheShadowMap=false;if(S[n]._isCachedShadowMap)S[n]._destroyShadowMap()}var me;for(U=0;U<t.length;U++){H=c[U];me=[];for(l=0;l<o;l++){G=p[l][U];ie=te[l][U];ne=m[G.width];re=ne.colorBuffer;var _e=4;O[0]=1/G.width;O[1]=1/G.height;D.setValue(O);for(n=0;n<_e;n++){L.setValue(G);Ar(s,ne,R);L.setValue(re);Ar(s,ie,R)}for(n=0;n<H.length;n++){W=H[n];W.mask=ip;H[n].setParameter(dp[l],G);if(l===fp)H[n]._shaderDefs|=qh}me[l]=G;if(l===o-1)ie.destroy()}rp.push(me);sp.push(t[U])}for(var ve in m)if(m.hasOwnProperty(ve)){m[ve].colorBuffer.destroy();m[ve].destroy()}for(n=0;n<rp.length;n++)for(r=0;r<rp[n].length;r++){v=rp[n][r];v.minFilter=Ct;v.magFilter=Ct}for(U=0;U<h.length;U++)j(h[U]).castShadows=K[U];for(n=0;n<q.length;n++)if(q[n]){H=X(sp[n]);for(r=0;r<H.length;r++)H[r]._shaderDefs|=q[n][r]&(Xh|qh)}for(n=0;n<S.length;n++){S[n].mask=w[n];S[n].shadowUpdateMode=T[n]}for(n=0;n<C.length;n++)C[n].enabled=M[n];a.fog=B;a.ambientLight.set(N,z,V);if(d)a._needsStaticPrepare=true};return e}(),vp,gp=1,yp=4,bp=new ve,xp=new ve,Sp=new ce,wp=new ce,Tp=new ce,Mp=new ce,Cp=new ce,Ap=new ce,Pp=new ce,Ep=new ce,Ip=new ce,Rp=new ce,Lp=new ce,Dp=new ce,kp=new ce;function Op(e){return e-Math.floor(e)}function Fp(e){return Math.max(Math.min(e,1),0)}function Bp(e,t){return e-t*Math.floor(e/t)}function Np(e){var t=Op(e);var i=Op(255*e);var n=Op(65025*e);var r=Op(160581375*e);t-=i/255;i-=n/255;n-=r/255;r-=r/255;return[t,i,n,r]}function zp(e){var t=Op(e);var i=Op(255*e);t-=i/255;i-=i/255;return[t,i]}var Vp=function(){function e(e){this._emitter=e}var t=e.prototype;t.calcSpawnPosition=function e(t,i,n,r,s){var a=this._emitter;var o=Math.random();var l=Math.random();var h=Math.random();var c=Math.random();if(a.useCpu){t[s*yp+0+a.numParticlesPot*2*yp]=o;t[s*yp+1+a.numParticlesPot*2*yp]=l;t[s*yp+2+a.numParticlesPot*2*yp]=h}wp.x=o-.5;wp.y=l-.5;wp.z=h-.5;if(a.emitterShape===lh){var u=Math.max(Math.abs(wp.x),Math.max(Math.abs(wp.y),Math.abs(wp.z)));var f=u+(.5-u)*n[0];var d=u+(.5-u)*n[1];var p=u+(.5-u)*n[2];wp.x=f*(u==Math.abs(wp.x)?Math.sign(wp.x):2*wp.x);wp.y=d*(u==Math.abs(wp.y)?Math.sign(wp.y):2*wp.y);wp.z=p*(u==Math.abs(wp.z)?Math.sign(wp.z):2*wp.z);if(!a.localSpace)Sp.copy(r).add(i.transformPoint(wp));else Sp.copy(i.transformPoint(wp))}else{wp.normalize();var m=a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius;var _=c*(1-m)+m;if(!a.localSpace)Sp.copy(r).add(wp.scale(_*a.emitterRadius));else Sp.copy(wp.scale(_*a.emitterRadius))}var v,g;v=Pe.lerp(a.rate,a.rate2,o);g=-v*s;if(a.pack8){var y=(Sp.x-a.worldBounds.center.x)/a.worldBoundsSize.x+.5;var b=(Sp.y-a.worldBounds.center.y)/a.worldBoundsSize.y+.5;var x=(Sp.z-a.worldBounds.center.z)/a.worldBoundsSize.z+.5;var S=Pe.lerp(a.startAngle*Pe.DEG_TO_RAD,a.startAngle2*Pe.DEG_TO_RAD,o);S=S%(Math.PI*2)/(Math.PI*2);var w=zp(y);t[s*yp]=w[0];t[s*yp+1]=w[1];var T=zp(b);t[s*yp+2]=T[0];t[s*yp+3]=T[1];var M=zp(x);t[s*yp+0+a.numParticlesPot*yp]=M[0];t[s*yp+1+a.numParticlesPot*yp]=M[1];var C=zp(S);t[s*yp+2+a.numParticlesPot*yp]=C[0];t[s*yp+3+a.numParticlesPot*yp]=C[1];var A=1;t[s*yp+3+a.numParticlesPot*yp*2]=A;var P=Math.max(a.lifetime,(a.numParticles-1)*Math.max(a.rate,a.rate2));var E=a.lifetime+1;g=(g+P)/(P+E);var I=Np(g);t[s*yp+0+a.numParticlesPot*yp*3]=I[0];t[s*yp+1+a.numParticlesPot*yp*3]=I[1];t[s*yp+2+a.numParticlesPot*yp*3]=I[2];t[s*yp+3+a.numParticlesPot*yp*3]=I[3]}else{t[s*yp]=Sp.x;t[s*yp+1]=Sp.y;t[s*yp+2]=Sp.z;t[s*yp+3]=Pe.lerp(a.startAngle*Pe.DEG_TO_RAD,a.startAngle2*Pe.DEG_TO_RAD,o);t[s*yp+3+a.numParticlesPot*yp]=g}};t.update=function e(t,i,n,r,s,a,o,l){var h,c,u,f,d;var p=this._emitter;if(p.meshInstance.node){var m=p.meshInstance.node.worldTransform;for(d=0;d<12;d++)bp.data[d]=m.data[d];xp.copy(bp);xp.invert();vp=p.meshInstance.node.localScale;gp=Math.max(Math.max(vp.x,vp.y),vp.z)}a=p.meshInstance.node===null||p.localSpace?ce.ZERO:p.meshInstance.node.getPosition();var _=p.camera?p.camera._node.getPosition():ce.ZERO;var v=!p.useMesh?15:17;var g,y;var b,x,S,w,T,M,C;var A=p.precision-1;for(f=0;f<p.numParticles;f++){var P=Math.floor(p.vbCPU[f*p.numParticleVerts*(p.useMesh?6:4)+3]);var E=n[P*yp+0+p.numParticlesPot*2*yp];Tp.x=E;Tp.y=n[P*yp+1+p.numParticlesPot*2*yp];Tp.z=n[P*yp+2+p.numParticlesPot*2*yp];var I=p.rate+(p.rate2-p.rate)*E;var R=p.lifetime;var L=n[P*yp+3+p.numParticlesPot*yp]+o;var D=Fp(L/R);var k=0;var O=0;var F=0;var B=L-o<=0||L>=R;if(B)this.calcSpawnPosition(n,r,s,a,P);var N=L>0&&L<R;if(N){u=D*A;g=Math.floor(u);y=Math.ceil(u);u%=1;h=p.qRotSpeed[g];c=p.qRotSpeed[y];b=h+(c-h)*u;h=p.qRotSpeed2[g];c=p.qRotSpeed2[y];x=h+(c-h)*u;h=p.qScale[g];c=p.qScale[y];k=h+(c-h)*u;h=p.qScale2[g];c=p.qScale2[y];S=h+(c-h)*u;h=p.qAlpha[g];c=p.qAlpha[y];w=h+(c-h)*u;h=p.qAlpha2[g];c=p.qAlpha2[y];T=h+(c-h)*u;h=p.qRadialSpeed[g];c=p.qRadialSpeed[y];M=h+(c-h)*u;h=p.qRadialSpeed2[g];c=p.qRadialSpeed2[y];C=h+(c-h)*u;M+=(C-M)*(E*100%1);Mp.x=n[P*yp];Mp.y=n[P*yp+1];Mp.z=n[P*yp+2];if(!p.localSpace)Ip.copy(Mp).sub(a);else Ip.copy(Mp);Ip.normalize().scale(M);g*=3;y*=3;h=p.qLocalVelocity[g];c=p.qLocalVelocity[y];Ap.x=h+(c-h)*u;h=p.qLocalVelocity[g+1];c=p.qLocalVelocity[y+1];Ap.y=h+(c-h)*u;h=p.qLocalVelocity[g+2];c=p.qLocalVelocity[y+2];Ap.z=h+(c-h)*u;h=p.qLocalVelocity2[g];c=p.qLocalVelocity2[y];Ep.x=h+(c-h)*u;h=p.qLocalVelocity2[g+1];c=p.qLocalVelocity2[y+1];Ep.y=h+(c-h)*u;h=p.qLocalVelocity2[g+2];c=p.qLocalVelocity2[y+2];Ep.z=h+(c-h)*u;h=p.qVelocity[g];c=p.qVelocity[y];Cp.x=h+(c-h)*u;h=p.qVelocity[g+1];c=p.qVelocity[y+1];Cp.y=h+(c-h)*u;h=p.qVelocity[g+2];c=p.qVelocity[y+2];Cp.z=h+(c-h)*u;h=p.qVelocity2[g];c=p.qVelocity2[y];Pp.x=h+(c-h)*u;h=p.qVelocity2[g+1];c=p.qVelocity2[y+1];Pp.y=h+(c-h)*u;h=p.qVelocity2[g+2];c=p.qVelocity2[y+2];Pp.z=h+(c-h)*u;Ap.x+=(Ep.x-Ap.x)*Tp.x;Ap.y+=(Ep.y-Ap.y)*Tp.y;Ap.z+=(Ep.z-Ap.z)*Tp.z;if(p.initialVelocity>0)if(p.emitterShape===hh){wp.copy(Tp).scale(2).sub(ce.ONE).normalize();Ap.add(wp.scale(p.initialVelocity))}else Ap.add(ce.FORWARD.scale(p.initialVelocity));Cp.x+=(Pp.x-Cp.x)*Tp.x;Cp.y+=(Pp.y-Cp.y)*Tp.y;Cp.z+=(Pp.z-Cp.z)*Tp.z;b+=(x-b)*Tp.y;k=(k+(S-k)*(E*1e4%1))*gp;O=(T-w)*(E*1e3%1);if(p.meshInstance.node)if(!p.localSpace)bp.transformPoint(Ap,Ap);else{Ap.x/=vp.x;Ap.y/=vp.y;Ap.z/=vp.z}if(!p.localSpace){Ap.add(Cp.mul(vp));Ap.add(Ip.mul(vp))}else{xp.transformPoint(Cp,Cp);Ap.add(Cp).add(Ip)}Dp.copy(Ap);Rp.copy(Mp).add(Ap.scale(o));Lp.copy(Rp);n[P*yp]=Lp.x;n[P*yp+1]=Lp.y;n[P*yp+2]=Lp.z;n[P*yp+3]+=b*o;if(p.wrap&&p.wrapBounds){if(!p.localSpace)Lp.sub(a);Lp.x=Bp(Lp.x,p.wrapBounds.x)-p.wrapBounds.x*.5;Lp.y=Bp(Lp.y,p.wrapBounds.y)-p.wrapBounds.y*.5;Lp.z=Bp(Lp.z,p.wrapBounds.z)-p.wrapBounds.z*.5;if(!p.localSpace)Lp.add(a)}if(p.sort>0)if(p.sort===1){kp.copy(Lp).sub(_);p.particleDistance[P]=-(kp.x*kp.x+kp.y*kp.y+kp.z*kp.z)}else if(p.sort===2)p.particleDistance[P]=L;else if(p.sort===3)p.particleDistance[P]=-L}if(l){if(L<0)n[P*yp+3+p.numParticlesPot*2*yp]=-1}else{if(L>=R){L-=Math.max(R,(p.numParticles-1)*I);n[P*yp+3+p.numParticlesPot*2*yp]=p.loop?1:-1}if(L<0&&p.loop)n[P*yp+3+p.numParticlesPot*2*yp]=1}if(n[P*yp+3+p.numParticlesPot*2*yp]<0)N=false;n[P*yp+3+p.numParticlesPot*yp]=L;for(var z=0;z<p.numParticleVerts;z++){var V=(f*p.numParticleVerts+z)*(p.useMesh?6:4);var U=p.vbCPU[V];var G=p.vbCPU[V+1];var H=p.vbCPU[V+2];if(!N)U=G=H=0;var W=f*p.numParticleVerts*v+z*v;t[W]=Lp.x;t[W+1]=Lp.y;t[W+2]=Lp.z;t[W+3]=D;t[W+4]=p.alignToMotion?F:n[P*yp+3];t[W+5]=k;t[W+6]=O;t[W+7]=Dp.x;t[W+8]=U;t[W+9]=G;t[W+10]=H;t[W+11]=Dp.y;t[W+12]=P;t[W+13]=Dp.z;t[W+14]=p.vbCPU[V+3];if(p.useMesh){t[W+15]=p.vbCPU[V+4];t[W+16]=p.vbCPU[V+5]}}}if(p.sort>ih&&p.camera){var j=p.useMesh?6:4;var X=p.particleDistance;for(f=0;f<p.numParticles;f++){i[f][0]=f;i[f][1]=X[Math.floor(p.vbCPU[f*p.numParticleVerts*j+3])]}p.vbOld.set(p.vbCPU);i.sort(function(e,t){return e[1]-t[1]});for(f=0;f<p.numParticles;f++){var q=i[f][0]*p.numParticleVerts*j;var Y=f*p.numParticleVerts*j;for(d=0;d<p.numParticleVerts*j;d++)p.vbCPU[Y+d]=p.vbOld[q+d]}}};return e}(),Up=new le,Gp=new le,Hp=new le,Wp=function(){function e(e,t){this.randomize=function(){this.frameRandomUniform[0]=Math.random();this.frameRandomUniform[1]=Math.random();this.frameRandomUniform[2]=Math.random()};this._emitter=e;this.frameRandomUniform=new Float32Array(3);this.emitterPosUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);this.worldBoundsMulUniform=new Float32Array(3);this.worldBoundsAddUniform=new Float32Array(3);this.inBoundsSizeUniform=new Float32Array(3);this.inBoundsCenterUniform=new Float32Array(3);this.constantParticleTexIN=t.scope.resolve("particleTexIN");this.constantParticleTexOUT=t.scope.resolve("particleTexOUT");this.constantEmitterPos=t.scope.resolve("emitterPos");this.constantEmitterScale=t.scope.resolve("emitterScale");this.constantSpawnBounds=t.scope.resolve("spawnBounds");this.constantSpawnPosInnerRatio=t.scope.resolve("spawnPosInnerRatio");this.constantSpawnBoundsSphere=t.scope.resolve("spawnBoundsSphere");this.constantSpawnBoundsSphereInnerRatio=t.scope.resolve("spawnBoundsSphereInnerRatio");this.constantInitialVelocity=t.scope.resolve("initialVelocity");this.constantFrameRandom=t.scope.resolve("frameRandom");this.constantDelta=t.scope.resolve("delta");this.constantRate=t.scope.resolve("rate");this.constantRateDiv=t.scope.resolve("rateDiv");this.constantLifetime=t.scope.resolve("lifetime");this.constantGraphSampleSize=t.scope.resolve("graphSampleSize");this.constantGraphNumSamples=t.scope.resolve("graphNumSamples");this.constantInternalTex0=t.scope.resolve("internalTex0");this.constantInternalTex1=t.scope.resolve("internalTex1");this.constantInternalTex2=t.scope.resolve("internalTex2");this.constantInternalTex3=t.scope.resolve("internalTex3");this.constantEmitterMatrix=t.scope.resolve("emitterMatrix");this.constantEmitterMatrixInv=t.scope.resolve("emitterMatrixInv");this.constantNumParticles=t.scope.resolve("numParticles");this.constantNumParticlesPot=t.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=t.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=t.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=t.scope.resolve("rotSpeedDivMult");this.constantSeed=t.scope.resolve("seed");this.constantStartAngle=t.scope.resolve("startAngle");this.constantStartAngle2=t.scope.resolve("startAngle2");this.constantOutBoundsMul=t.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=t.scope.resolve("outBoundsAdd");this.constantInBoundsSize=t.scope.resolve("inBoundsSize");this.constantInBoundsCenter=t.scope.resolve("inBoundsCenter");this.constantMaxVel=t.scope.resolve("maxVel");this.constantFaceTangent=t.scope.resolve("faceTangent");this.constantFaceBinorm=t.scope.resolve("faceBinorm")}var t=e.prototype;t._setInputBounds=function e(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x;this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y;this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z;this.constantInBoundsSize.setValue(this.inBoundsSizeUniform);this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x;this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y;this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z;this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)};t.update=function e(t,i,n,r,s){var a=this._emitter;t.setBlending(false);t.setColorWrite(true,true,true,true);t.setCullMode(xt);t.setDepthTest(false);t.setDepthWrite(false);this.randomize();this.constantGraphSampleSize.setValue(1/a.precision);this.constantGraphNumSamples.setValue(a.precision);this.constantNumParticles.setValue(a.numParticles);this.constantNumParticlesPot.setValue(a.numParticlesPot);this.constantInternalTex0.setValue(a.internalTex0);this.constantInternalTex1.setValue(a.internalTex1);this.constantInternalTex2.setValue(a.internalTex2);this.constantInternalTex3.setValue(a.internalTex3);var o=a.meshInstance.node;var l=o===null?ce.ONE:o.localScale;if(a.pack8){this.worldBoundsMulUniform[0]=a.worldBoundsMul.x;this.worldBoundsMulUniform[1]=a.worldBoundsMul.y;this.worldBoundsMulUniform[2]=a.worldBoundsMul.z;this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform);this.worldBoundsAddUniform[0]=a.worldBoundsAdd.x;this.worldBoundsAddUniform[1]=a.worldBoundsAdd.y;this.worldBoundsAddUniform[2]=a.worldBoundsAdd.z;this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform);this._setInputBounds();var h=a.maxVel*Math.max(Math.max(l.x,l.y),l.z);h=Math.max(h,1);this.constantMaxVel.setValue(h)}var c=o===null||a.localSpace?ce.ZERO:o.getPosition();var u=o===null?ve.IDENTITY:o.getWorldTransform();if(a.emitterShape===lh){Up.setFromMat4(i);this.constantSpawnBounds.setValue(Up.data);this.constantSpawnPosInnerRatio.setValue(n)}else{this.constantSpawnBoundsSphere.setValue(a.emitterRadius);this.constantSpawnBoundsSphereInnerRatio.setValue(a.emitterRadius===0?0:a.emitterRadiusInner/a.emitterRadius)}this.constantInitialVelocity.setValue(a.initialVelocity);Gp.setFromMat4(u);u.invertTo3x3(Hp);this.emitterPosUniform[0]=c.x;this.emitterPosUniform[1]=c.y;this.emitterPosUniform[2]=c.z;this.constantEmitterPos.setValue(this.emitterPosUniform);this.constantFrameRandom.setValue(this.frameRandomUniform);this.constantDelta.setValue(r);this.constantRate.setValue(a.rate);this.constantRateDiv.setValue(a.rate2-a.rate);this.constantStartAngle.setValue(a.startAngle*Pe.DEG_TO_RAD);this.constantStartAngle2.setValue(a.startAngle2*Pe.DEG_TO_RAD);this.constantSeed.setValue(a.seed);this.constantLifetime.setValue(a.lifetime);this.emitterScaleUniform[0]=l.x;this.emitterScaleUniform[1]=l.y;this.emitterScaleUniform[2]=l.z;this.constantEmitterScale.setValue(this.emitterScaleUniform);this.constantEmitterMatrix.setValue(Gp.data);this.constantEmitterMatrixInv.setValue(Hp.data);this.constantLocalVelocityDivMult.setValue(a.localVelocityUMax);this.constantVelocityDivMult.setValue(a.velocityUMax);this.constantRotSpeedDivMult.setValue(a.rotSpeedUMax[0]);var f=a.swapTex?a.particleTexOUT:a.particleTexIN;f=a.beenReset?a.particleTexStart:f;var d=a.swapTex?a.particleTexIN:a.particleTexOUT;this.constantParticleTexIN.setValue(f);Ar(t,a.swapTex?a.rtParticleTexIN:a.rtParticleTexOUT,!s?a.loop?a.shaderParticleUpdateRespawn:a.shaderParticleUpdateNoRespawn:a.shaderParticleUpdateOnStop);a.material.setParameter("particleTexOUT",f);a.material.setParameter("particleTexIN",d);a.beenReset=false;a.swapTex=!a.swapTex;t.setDepthTest(true);t.setDepthWrite(true);a.prevWorldBoundsSize.copy(a.worldBoundsSize);a.prevWorldBoundsCenter.copy(a.worldBounds.center);if(a.pack8)this._setInputBounds()};return e}(),jp=[[-1,-1],[1,-1],[1,1],[-1,1]],Xp=function e(t,i,n,r,s,a,o){if(s===void 0)s=ii;var l=Mt;if(o&&s===Kt)l=Ct;var h=new bu(t,{width:i,height:n,format:s,cubemap:false,mipmaps:false,minFilter:l,magFilter:l,addressU:We,addressV:We});h.name="PSTexture";var c=h.lock();if(s===Kt){var u=new Uint8Array(r.length);for(var f=0;f<r.length;f++)u[f]=r[f]*a*255;r=u}c.set(r);h.unlock();return h};function qp(e){return Math.max(Math.min(e,1),0)}var Yp=new ae([0,0,1,0]),Kp=new ae([0,1,1,1]),Qp=new oe([0,0,1,0],[0,0,1,0],[0,0,1,0]),$p=new oe([0,1,1,1],[0,1,1,1],[0,1,1,1]),Zp=2,Jp=4,em=new Float32Array(3),tm=new ve,im=new ce,nm=new ce,rm=new ce,sm,am;function om(e,t){if(am[e]!==undefined&&am[e]!==null)sm[e]=am[e];else sm[e]=t}function lm(e,t,i){var n=e*255<<16|t*255<<8|i*255;return n/(1<<24)}function hm(e,t){var i=e.length/3;var n=new Array(i*4);for(var r=0;r<i;r++){n[r*4]=e[r*3];n[r*4+1]=e[r*3+1];n[r*4+2]=e[r*3+2];n[r*4+3]=lm(t[r*3],t[r*3+1],t[r*3+2])}return n}function cm(e,t){var i=new Array(t.length*4);for(var n=0;n<t.length;n++){i[n*4]=e[n*3];i[n*4+1]=e[n*3+1];i[n*4+2]=e[n*3+2];i[n*4+3]=t[n]}return i}function um(e,t,i,n,r){var s=new Array(e.length*4);for(var a=0;a<e.length;a++){s[a*4]=e[a];s[a*4+1]=t[a];s[a*4+2]=0;s[a*4+3]=lm(i[a],n[a],r[a])}return s}function fm(e,t){var i=new Array(e.length*4);for(var n=0;n<e.length;n++){i[n*4]=e[n];i[n*4+1]=t[n];i[n*4+2]=0;i[n*4+3]=0}return i}function dm(e){var t=Math.max(e.rate,e.rate2)*e.numParticles+e.lifetime;return Date.now()+t*1e3}function pm(e,t){var i=new Float32Array(e.length);for(var n=0;n<e.length;n++)i[n]=e[n]-t[n];return i}function mm(e,t){var i,n;var r=t.length;var s=e.length/r;for(i=0;i<s;i++)for(n=0;n<r;n++){var a=Math.abs(e[i*r+n]);t[n]=Math.max(t[n],a)}}function _m(e,t){var i=t.length;var n,r;var s=e.length/i;for(n=0;n<s;n++)for(r=0;r<i;r++){e[n*i+r]/=t[r]===0?1:t[r];e[n*i+r]*=.5;e[n*i+r]+=.5}}function vm(e,t,i){var n=pm(t,e);mm(n,i);_m(n,i);return n}var gm=function(){function d(e,t){this.graphicsDevice=e;var i=e;var n=32;this.precision=n;this._addTimeTime=0;if(!d.DEFAULT_PARAM_TEXTURE){var r=16;var s=r*.5+.5;var a=new Float32Array(r*r*4);var o,l,h,c,u,f;for(l=0;l<r;l++)for(o=0;o<r;o++){h=o+1-s;c=l+1-s;f=qp(1-qp(Math.sqrt(h*h+c*c)/r)-.5);u=l*r+o;a[u*4]=1;a[u*4+1]=1;a[u*4+2]=1;a[u*4+3]=f}d.DEFAULT_PARAM_TEXTURE=Xp(i,r,r,a,Kt,1,true);d.DEFAULT_PARAM_TEXTURE.minFilter=Ct;d.DEFAULT_PARAM_TEXTURE.magFilter=Ct}sm=this;am=t;om("numParticles",1);if(this.numParticles>e.maxTextureSize){console.warn("WARNING: can't create more than "+e.maxTextureSize+" particles on this device.");this.numParticles=e.maxTextureSize}om("rate",1);om("rate2",this.rate);om("lifetime",50);om("emitterExtents",new ce(0,0,0));om("emitterExtentsInner",new ce(0,0,0));om("emitterRadius",0);om("emitterRadiusInner",0);om("emitterShape",lh);om("initialVelocity",1);om("wrap",false);om("localSpace",false);om("screenSpace",false);om("wrapBounds",null);om("colorMap",d.DEFAULT_PARAM_TEXTURE);om("normalMap",null);om("loop",true);om("preWarm",false);om("sort",ih);om("mode",ah);om("scene",null);om("lighting",false);om("halfLambert",false);om("intensity",1);om("stretch",0);om("alignToMotion",false);om("depthSoftening",0);om("mesh",null);om("particleNormal",new ce(0,1,0));om("orientation",ch);om("depthWrite",false);om("noFog",false);om("blendType",pl);om("node",null);om("startAngle",0);om("startAngle2",this.startAngle);om("animTilesX",1);om("animTilesY",1);om("animStartFrame",0);om("animNumFrames",1);om("animNumAnimations",1);om("animIndex",0);om("randomizeAnimIndex",false);om("animSpeed",1);om("animLoop",true);this._gpuUpdater=new Wp(this,i);this._cpuUpdater=new Vp(this);this.constantLightCube=i.scope.resolve("lightCube[0]");this.emitterPosUniform=new Float32Array(3);this.wrapBoundsUniform=new Float32Array(3);this.emitterScaleUniform=new Float32Array([1,1,1]);om("colorGraph",$p);om("colorGraph2",this.colorGraph);om("scaleGraph",Kp);om("scaleGraph2",this.scaleGraph);om("alphaGraph",Kp);om("alphaGraph2",this.alphaGraph);om("localVelocityGraph",Qp);om("localVelocityGraph2",this.localVelocityGraph);om("velocityGraph",Qp);om("velocityGraph2",this.velocityGraph);om("rotationSpeedGraph",Yp);om("rotationSpeedGraph2",this.rotationSpeedGraph);om("radialSpeedGraph",Yp);om("radialSpeedGraph2",this.radialSpeedGraph);this.lightCube=new Float32Array(6*3);this.lightCubeDir=new Array(6);this.lightCubeDir[0]=new ce(-1,0,0);this.lightCubeDir[1]=new ce(1,0,0);this.lightCubeDir[2]=new ce(0,-1,0);this.lightCubeDir[3]=new ce(0,1,0);this.lightCubeDir[4]=new ce(0,0,-1);this.lightCubeDir[5]=new ce(0,0,1);this.animTilesParams=new Float32Array(2);this.animParams=new Float32Array(4);this.animIndexParams=new Float32Array(2);this.internalTex0=null;this.internalTex1=null;this.internalTex2=null;this.colorParam=null;this.vbToSort=null;this.vbOld=null;this.particleDistance=null;this.camera=null;this.swapTex=false;this.useMesh=true;this.useCpu=false;this.pack8=true;this.localBounds=new Ce;this.worldBoundsNoTrail=new Ce;this.worldBoundsTrail=[new Ce,new Ce];this.worldBounds=new Ce;this.worldBoundsSize=new ce;this.prevWorldBoundsSize=new ce;this.prevWorldBoundsCenter=new ce;this.prevEmitterExtents=this.emitterExtents;this.prevEmitterRadius=this.emitterRadius;this.worldBoundsMul=new ce;this.worldBoundsAdd=new ce;this.timeToSwitchBounds=0;this.shaderParticleUpdateRespawn=null;this.shaderParticleUpdateNoRespawn=null;this.shaderParticleUpdateOnStop=null;this.numParticleVerts=0;this.numParticleIndices=0;this.material=null;this.meshInstance=null;this.drawOrder=0;this.seed=Math.random();this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTime=0;this.simTimeTotal=0;this.beenReset=false;this._layer=null;this.rebuild()}var e=d.prototype;e.onChangeCamera=function e(){this.regenShader();this.resetMaterial()};e.calculateBoundsMad=function e(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5};e.calculateWorldBounds=function e(){if(!this.node)return;this.prevWorldBoundsSize.copy(this.worldBoundsSize);this.prevWorldBoundsCenter.copy(this.worldBounds.center);if(!this.useCpu){var t=false;if(this.emitterShape===lh)t=!this.emitterExtents.equals(this.prevEmitterExtents);else t=!(this.emitterRadius===this.prevEmitterRadius);if(t)this.calculateLocalBounds()}var i=this.node.getWorldTransform();if(this.localSpace)this.worldBoundsNoTrail.copy(this.localBounds);else this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,i);this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var n=this.simTimeTotal;if(n>=this.timeToSwitchBounds){this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]);this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail);this.timeToSwitchBounds=n+this.lifetime}this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);if(this.localSpace){this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,i);this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,i)}else{this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance.mesh.aabb.copy(this.worldBounds)}this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;if(this.pack8)this.calculateBoundsMad()};e.resetWorldBounds=function e(){if(!this.node)return;this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?ve.IDENTITY:this.node.getWorldTransform());this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail);this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail);this.worldBounds.copy(this.worldBoundsTrail[0]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.prevWorldBoundsSize.copy(this.worldBoundsSize);this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.simTimeTotal=0;this.timeToSwitchBounds=0};e.calculateLocalBounds=function e(){var t=Number.MAX_VALUE;var i=Number.MAX_VALUE;var n=Number.MAX_VALUE;var r=-Number.MAX_VALUE;var s=-Number.MAX_VALUE;var a=-Number.MAX_VALUE;var o=0;var l=0;var h=this.lifetime/this.precision;var c=[this.qVelocity,this.qVelocity2];var u=[this.qLocalVelocity,this.qLocalVelocity2];var f=[0,0];var d=[0,0];var p=[0,0];var m=[0,0];var _=[0,0];var v,g;var y;var b,x,S;for(v=0;v<this.precision+1;v++){y=Math.min(v,this.precision-1);for(g=0;g<2;g++){b=u[g][y*3+0]*h+f[g];x=u[g][y*3+1]*h+d[g];S=u[g][y*3+2]*h+p[g];t=Math.min(b,t);i=Math.min(x,i);n=Math.min(S,n);r=Math.max(b,r);s=Math.max(x,s);a=Math.max(S,a);f[g]=b;d[g]=x;p[g]=S}for(g=0;g<2;g++)_[g]+=h*Math.sqrt(c[g][y*3+0]*c[g][y*3+0]+c[g][y*3+1]*c[g][y*3+1]+c[g][y*3+2]*c[g][y*3+2]);m[0]+=this.qRadialSpeed[y]*h;m[1]+=this.qRadialSpeed2[y]*h;o=Math.max(o,Math.max(Math.abs(m[0]),Math.abs(m[1])));l=Math.max(l,this.qScale[y])}if(this.emitterShape===lh){b=this.emitterExtents.x*.5;x=this.emitterExtents.y*.5;S=this.emitterExtents.z*.5}else{b=this.emitterRadius;x=this.emitterRadius;S=this.emitterRadius}var w=Math.max(_[0],_[1]);nm.x=t-l-b-o-w;nm.y=i-l-x-o-w;nm.z=n-l-S-o-w;rm.x=r+l+b+o+w;rm.y=s+l+x+o+w;rm.z=a+l+S+o+w;this.localBounds.setMinMax(nm,rm)};e.rebuild=function e(){var t;var i=this.graphicsDevice;if(this.colorMap===null)this.colorMap=d.DEFAULT_PARAM_TEXTURE;this.spawnBounds=this.emitterShape===lh?this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||this.sort>ih||i.maxVertexTextures<=1||i.fragmentUniformsCount<64||i.forceCpuParticles||!i.extTextureFloat;this._destroyResources();this.pack8=(this.pack8||!i.textureFloatRenderable)&&!this.useCpu;Zp=this.useCpu||this.pack8?4:2;this.useMesh=false;if(this.mesh){var n=this.numParticles*this.mesh.vertexBuffer.numVertices;if(n>65535)console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles.");else this.useMesh=true}this.numParticlesPot=Pe.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.resetWorldBounds();if(this.node){this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?ve.IDENTITY:this.node.getWorldTransform());this.worldBoundsTrail[0].copy(this.worldBounds);this.worldBoundsTrail[1].copy(this.worldBounds);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.prevWorldBoundsSize.copy(this.worldBoundsSize);this.prevWorldBoundsCenter.copy(this.worldBounds.center);if(this.pack8)this.calculateBoundsMad()}this.vbToSort=new Array(this.numParticles);for(var r=0;r<this.numParticles;r++)this.vbToSort[r]=[0,0];this.particleDistance=new Float32Array(this.numParticles);this._gpuUpdater.randomize();this.particleTex=new Float32Array(this.numParticlesPot*Zp*Jp);var s=this.node===null||this.localSpace?ce.ZERO:this.node.getPosition();if(this.emitterShape===lh){if(this.node===null||this.localSpace)tm.setTRS(ce.ZERO,be.IDENTITY,this.spawnBounds);else tm.setTRS(ce.ZERO,this.node.getRotation(),im.copy(this.spawnBounds).mul(this.node.localScale));em[0]=this.emitterExtents.x!=0?this.emitterExtentsInner.x/this.emitterExtents.x:0;em[1]=this.emitterExtents.y!=0?this.emitterExtentsInner.y/this.emitterExtents.y:0;em[2]=this.emitterExtents.z!=0?this.emitterExtentsInner.z/this.emitterExtents.z:0}for(t=0;t<this.numParticles;t++){this._cpuUpdater.calcSpawnPosition(this.particleTex,tm,em,s,t);if(this.useCpu)this.particleTex[t*Jp+3+this.numParticlesPot*2*Jp]=1}this.particleTexStart=new Float32Array(this.numParticlesPot*Zp*Jp);for(t=0;t<this.particleTexStart.length;t++)this.particleTexStart[t]=this.particleTex[t];if(!this.useCpu){if(this.pack8){this.particleTexIN=Xp(i,this.numParticlesPot,Zp,this.particleTex,Kt,1,false);this.particleTexOUT=Xp(i,this.numParticlesPot,Zp,this.particleTex,Kt,1,false);this.particleTexStart=Xp(i,this.numParticlesPot,Zp,this.particleTexStart,Kt,1,false)}else{this.particleTexIN=Xp(i,this.numParticlesPot,Zp,this.particleTex);this.particleTexOUT=Xp(i,this.numParticlesPot,Zp,this.particleTex);this.particleTexStart=Xp(i,this.numParticlesPot,Zp,this.particleTexStart)}this.rtParticleTexIN=new BM(i,this.particleTexIN,{depth:false});this.rtParticleTexOUT=new BM(i,this.particleTexOUT,{depth:false});this.swapTex=false}var a=(this.localSpace?"#define LOCAL_SPACE\n":"")+ul.particleUpdaterInitPS+(this.pack8?ul.particleInputRgba8PS+ul.particleOutputRgba8PS:ul.particleInputFloatPS+ul.particleOutputFloatPS)+(this.emitterShape===lh?ul.particleUpdaterAABBPS:ul.particleUpdaterSpherePS)+ul.particleUpdaterStartPS;var o=a+ul.particleUpdaterRespawnPS+ul.particleUpdaterEndPS;var l=a+ul.particleUpdaterNoRespawnPS+ul.particleUpdaterEndPS;var h=a+ul.particleUpdaterOnStopPS+ul.particleUpdaterEndPS;var c=this.emitterShape+""+this.pack8+""+this.localSpace;this.shaderParticleUpdateRespawn=Qc(i,ul.fullscreenQuadVS,o,"fsQuad0"+c);this.shaderParticleUpdateNoRespawn=Qc(i,ul.fullscreenQuadVS,l,"fsQuad1"+c);this.shaderParticleUpdateOnStop=Qc(i,ul.fullscreenQuadVS,h,"fsQuad2"+c);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);var u=new Du(i);u.vertexBuffer=this.vertexBuffer;u.indexBuffer[0]=this.indexBuffer;u.primitive[0].type=wi;u.primitive[0].base=0;u.primitive[0].count=this.numParticles*this.numParticleIndices;u.primitive[0].indexed=true;this.material=new Cu;this.material.name=this.node.name;this.material.cull=xt;this.material.alphaWrite=false;this.material.blend=true;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();var f=this.meshInstance?this.meshInstance.visible:true;this.meshInstance=new zu(this.node,u,this.material);this.meshInstance.pick=false;this.meshInstance.updateKey();this.meshInstance.cull=true;this.meshInstance._noDepthDrawGl1=true;if(this.localSpace)this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform());else this.meshInstance.aabb.copy(this.worldBounds);this.meshInstance._updateAabb=false;this.meshInstance.visible=f;this._initializeTextures();this.resetTime();this.addTime(0,false);if(this.preWarm)this.prewarm(this.lifetime)};e._isAnimated=function e(){return this.animNumFrames>=1&&(this.animTilesX>1||this.animTilesY>1)&&(this.colorMap&&this.colorMap!==d.DEFAULT_PARAM_TEXTURE||this.normalMap)};e.rebuildGraphs=function e(){var t=this.precision;var i=this.graphicsDevice;var n;this.qLocalVelocity=this.localVelocityGraph.quantize(t);this.qVelocity=this.velocityGraph.quantize(t);this.qColor=this.colorGraph.quantizeClamped(t,0,1);this.qRotSpeed=this.rotationSpeedGraph.quantize(t);this.qScale=this.scaleGraph.quantize(t);this.qAlpha=this.alphaGraph.quantize(t);this.qRadialSpeed=this.radialSpeedGraph.quantize(t);this.qLocalVelocity2=this.localVelocityGraph2.quantize(t);this.qVelocity2=this.velocityGraph2.quantize(t);this.qColor2=this.colorGraph2.quantizeClamped(t,0,1);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(t);this.qScale2=this.scaleGraph2.quantize(t);this.qAlpha2=this.alphaGraph2.quantize(t);this.qRadialSpeed2=this.radialSpeedGraph2.quantize(t);for(n=0;n<t;n++){this.qRotSpeed[n]*=Pe.DEG_TO_RAD;this.qRotSpeed2[n]*=Pe.DEG_TO_RAD}this.localVelocityUMax=new Float32Array(3);this.velocityUMax=new Float32Array(3);this.colorUMax=new Float32Array(3);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.radialSpeedUMax=[0];this.qLocalVelocityDiv=vm(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax);this.qVelocityDiv=vm(this.qVelocity,this.qVelocity2,this.velocityUMax);this.qColorDiv=vm(this.qColor,this.qColor2,this.colorUMax);this.qRotSpeedDiv=vm(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=vm(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=vm(this.qAlpha,this.qAlpha2,this.alphaUMax);this.qRadialSpeedDiv=vm(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax);if(this.pack8){var r=[0,0,0];mm(this.qVelocity,r);var s=[0,0,0];mm(this.qVelocity2,s);var a=[0,0,0];mm(this.qLocalVelocity,a);var o=[0,0,0];mm(this.qLocalVelocity2,o);var l=[0];mm(this.qRadialSpeed,l);var h=[0];mm(this.qRadialSpeed2,h);var c=Math.max(r[0],s[0]);c=Math.max(c,r[1]);c=Math.max(c,s[1]);c=Math.max(c,r[2]);c=Math.max(c,s[2]);var u=Math.max(a[0],o[0]);u=Math.max(u,a[1]);u=Math.max(u,o[1]);u=Math.max(u,a[2]);u=Math.max(u,o[2]);var f=Math.max(l[0],h[0]);this.maxVel=c+u+f}if(!this.useCpu){this.internalTex0=Xp(i,t,1,hm(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=Xp(i,t,1,hm(this.qVelocity,this.qVelocityDiv));this.internalTex2=Xp(i,t,1,um(this.qRotSpeed,this.qScale,this.qScaleDiv,this.qRotSpeedDiv,this.qAlphaDiv));this.internalTex3=Xp(i,t,1,fm(this.qRadialSpeed,this.qRadialSpeedDiv))}this.colorParam=Xp(i,t,1,cm(this.qColor,this.qAlpha),Kt,1,true)};e._initializeTextures=function e(){if(this.colorMap){this.material.setParameter("colorMap",this.colorMap);if(this.lighting&&this.normalMap)this.material.setParameter("normalMap",this.normalMap)}};e.regenShader=function e(){var i=this.graphicsDevice.getProgramLibrary();var t=this.normalMap!==null;this.normalOption=0;if(this.lighting)this.normalOption=t?2:1;this.material.updateShader=function(){if(this.emitter.scene)if(this.emitter.camera!=this.emitter.scene._activeCamera){this.emitter.camera=this.emitter.scene._activeCamera;this.emitter.onChangeCamera()}var e=this.emitter.inTools;var t=i.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:e?false:this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:this.emitter.orientation!=ch});this.shader=t};this.material.updateShader()};e.resetMaterial=function e(){var t=this.material;t.setParameter("stretch",this.stretch);if(this._isAnimated()){t.setParameter("animTexTilesParams",this.animTilesParams);t.setParameter("animTexParams",this.animParams);t.setParameter("animTexIndexParams",this.animIndexParams)}t.setParameter("colorMult",this.intensity);if(!this.useCpu){t.setParameter("internalTex0",this.internalTex0);t.setParameter("internalTex1",this.internalTex1);t.setParameter("internalTex2",this.internalTex2);t.setParameter("internalTex3",this.internalTex3)}t.setParameter("colorParam",this.colorParam);t.setParameter("numParticles",this.numParticles);t.setParameter("numParticlesPot",this.numParticlesPot);t.setParameter("lifetime",this.lifetime);t.setParameter("rate",this.rate);t.setParameter("rateDiv",this.rate2-this.rate);t.setParameter("seed",this.seed);t.setParameter("scaleDivMult",this.scaleUMax[0]);t.setParameter("alphaDivMult",this.alphaUMax[0]);t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]);t.setParameter("graphNumSamples",this.precision);t.setParameter("graphSampleSize",1/this.precision);t.setParameter("emitterScale",new Float32Array([1,1,1]));if(this.pack8){this._gpuUpdater._setInputBounds();t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform);t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform);t.setParameter("maxVel",this.maxVel)}if(this.wrap&&this.wrapBounds){this.wrapBoundsUniform[0]=this.wrapBounds.x;this.wrapBoundsUniform[1]=this.wrapBounds.y;this.wrapBoundsUniform[2]=this.wrapBounds.z;t.setParameter("wrapBounds",this.wrapBoundsUniform)}if(this.colorMap)t.setParameter("colorMap",this.colorMap);if(this.lighting)if(this.normalMap)t.setParameter("normalMap",this.normalMap);if(this.depthSoftening>0)t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100));if(this.stretch>0)t.cull=xt;this._compParticleFaceParams()};e._compParticleFaceParams=function e(){var t,i;if(this.orientation==ch){t=new Float32Array([1,0,0]);i=new Float32Array([0,0,1])}else{var n;if(this.orientation==uh)n=this.particleNormal.normalize();else{var r=this.node===null?ve.IDENTITY:this.node.getWorldTransform();n=r.transformVector(this.particleNormal).normalize()}var s=new ce(1,0,0);if(Math.abs(s.dot(n))==1)s.set(0,0,1);var a=(new ce).cross(n,s).normalize();s.cross(a,n).normalize();t=new Float32Array([s.x,s.y,s.z]);i=new Float32Array([a.x,a.y,a.z])}this.material.setParameter("faceTangent",t);this.material.setParameter("faceBinorm",i)};e._allocate=function e(t){var i=t*this.numParticleVerts;var n=t*this.numParticleIndices;var r,s;var a;if(this.vertexBuffer===undefined||this.vertexBuffer.getNumVertices()!==i){if(!this.useCpu){r=[{semantic:Gi,components:4,type:In}];if(this.useMesh)r.push({semantic:Hi,components:2,type:In});s=new cr(this.graphicsDevice,r);this.vertexBuffer=new lr(this.graphicsDevice,s,i,ht);this.indexBuffer=new Eu(this.graphicsDevice,Vt,n)}else{r=[{semantic:Gi,components:4,type:In},{semantic:Hi,components:4,type:In},{semantic:Wi,components:4,type:In},{semantic:ji,components:1,type:In},{semantic:Xi,components:this.useMesh?4:2,type:In}];s=new cr(this.graphicsDevice,r);this.vertexBuffer=new lr(this.graphicsDevice,s,i,ht);this.indexBuffer=new Eu(this.graphicsDevice,Vt,n)}var o=new Float32Array(this.vertexBuffer.lock());var l,h,c;if(this.useMesh){l=new Float32Array(this.mesh.vertexBuffer.lock());h=l.length/this.mesh.vertexBuffer.numVertices;for(var u=0;u<this.mesh.vertexBuffer.format.elements.length;u++)if(this.mesh.vertexBuffer.format.elements[u].name===Di){c=this.mesh.vertexBuffer.format.elements[u].offset/4;break}}var f;for(a=0;a<i;a++){f=Math.floor(a/this.numParticleVerts);if(!this.useMesh){var d=a%4;o[a*4]=jp[d][0];o[a*4+1]=jp[d][1];o[a*4+2]=0;o[a*4+3]=f}else{var p=a%this.numParticleVerts;o[a*6]=l[p*h];o[a*6+1]=l[p*h+1];o[a*6+2]=l[p*h+2];o[a*6+3]=f;o[a*6+4]=l[p*h+c+0];o[a*6+5]=l[p*h+c+1]}}if(this.useCpu){this.vbCPU=new Float32Array(o);this.vbOld=new Float32Array(this.vbCPU.length)}this.vertexBuffer.unlock();if(this.useMesh)this.mesh.vertexBuffer.unlock();var m=0;var _=new Uint16Array(this.indexBuffer.lock());if(this.useMesh)l=new Uint16Array(this.mesh.indexBuffer[0].lock());for(a=0;a<t;a++)if(!this.useMesh){var v=a*4;_[m++]=v;_[m++]=v+1;_[m++]=v+2;_[m++]=v;_[m++]=v+2;_[m++]=v+3}else for(var g=0;g<this.numParticleIndices;g++)_[a*this.numParticleIndices+g]=l[g]+a*this.numParticleVerts;this.indexBuffer.unlock();if(this.useMesh)this.mesh.indexBuffer[0].unlock()}};e.reset=function e(){this.beenReset=true;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds();this.resetTime();var i=this.loop;this.loop=true;this.addTime(0,false);this.loop=i;if(this.preWarm)this.prewarm(this.lifetime)};e.prewarm=function e(t){var i=t/this.lifetime;var n=Math.min(Math.floor(i*this.precision),this.precision);var r=t/n;for(var s=0;s<n;s++)this.addTime(r,false)};e.resetTime=function e(){this.endTime=dm(this)};e.finishFrame=function e(){if(this.useCpu)this.vertexBuffer.unlock()};e.addTime=function e(t,i){var n=this.graphicsDevice;this.simTimeTotal+=t;this.calculateWorldBounds();if(this._isAnimated()){var r=this.animTilesParams;r[0]=1/this.animTilesX;r[1]=1/this.animTilesY;var s=this.animParams;s[0]=this.animStartFrame;s[1]=this.animNumFrames*this.animSpeed;s[2]=this.animNumFrames-1;s[3]=this.animNumAnimations-1;var a=this.animIndexParams;a[0]=this.animIndex;a[1]=this.randomizeAnimIndex}if(this.scene)if(this.camera!=this.scene._activeCamera){this.camera=this.scene._activeCamera;this.onChangeCamera()}if(this.emitterShape===lh){em[0]=this.emitterExtents.x!=0?this.emitterExtentsInner.x/this.emitterExtents.x:0;em[1]=this.emitterExtents.y!=0?this.emitterExtentsInner.y/this.emitterExtents.y:0;em[2]=this.emitterExtents.z!=0?this.emitterExtentsInner.z/this.emitterExtents.z:0;if(this.meshInstance.node===null)tm.setTRS(ce.ZERO,be.IDENTITY,this.emitterExtents);else tm.setTRS(ce.ZERO,this.meshInstance.node.getRotation(),im.copy(this.emitterExtents).mul(this.meshInstance.node.localScale))}var o;var l=this.meshInstance.node===null?ce.ONE:this.meshInstance.node.localScale;this.emitterScaleUniform[0]=l.x;this.emitterScaleUniform[1]=l.y;this.emitterScaleUniform[2]=l.z;this.material.setParameter("emitterScale",this.emitterScaleUniform);if(this.localSpace&&this.meshInstance.node){o=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=o.x;this.emitterPosUniform[1]=o.y;this.emitterPosUniform[2]=o.z;this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams();if(!this.useCpu)this._gpuUpdater.update(n,tm,em,t,i);else{var h=new Float32Array(this.vertexBuffer.lock());this._cpuUpdater.update(h,this.vbToSort,this.particleTex,tm,em,o,t,i)}if(!this.loop)if(Date.now()>this.endTime){if(this.onFinished)this.onFinished();this.meshInstance.visible=false}if(this.meshInstance)this.meshInstance.drawOrder=this.drawOrder};e._destroyResources=function e(){if(this.particleTexIN){this.particleTexIN.destroy();this.particleTexIN=null}if(this.particleTexOUT){this.particleTexOUT.destroy();this.particleTexOUT=null}if(this.particleTexStart&&this.particleTexStart.destroy){this.particleTexStart.destroy();this.particleTexStart=null}if(this.rtParticleTexIN){this.rtParticleTexIN.destroy();this.rtParticleTexIN=null}if(this.rtParticleTexOUT){this.rtParticleTexOUT.destroy();this.rtParticleTexOUT=null}if(this.internalTex0){this.internalTex0.destroy();this.internalTex0=null}if(this.internalTex1){this.internalTex1.destroy();this.internalTex1=null}if(this.internalTex2){this.internalTex2.destroy();this.internalTex2=null}if(this.internalTex3){this.internalTex3.destroy();this.internalTex3=null}if(this.colorParam){this.colorParam.destroy();this.colorParam=null}if(this.vertexBuffer){this.vertexBuffer.destroy();this.vertexBuffer=undefined}if(this.indexBuffer){this.indexBuffer.destroy();this.indexBuffer=undefined}if(this.material){this.material.destroy();this.material=null}};e.destroy=function e(){this.camera=null;this._destroyResources()};return d}(),ym=4/64,bm=1-ym*2,xm=[];function Sm(e,t){var i=t.length/3;var n=e.length/3;var r,s,a;var o;var l=new ce;var h=new ce;var c=new ce;var u=new ce;var f=new ce;var d=new ce;var p=[];for(o=0;o<e.length;o++)p[o]=0;for(o=0;o<i;o++){r=t[o*3];s=t[o*3+1];a=t[o*3+2];l.set(e[r*3],e[r*3+1],e[r*3+2]);h.set(e[s*3],e[s*3+1],e[s*3+2]);c.set(e[a*3],e[a*3+1],e[a*3+2]);u.sub2(h,l);f.sub2(c,l);d.cross(u,f).normalize();p[r*3]+=d.x;p[r*3+1]+=d.y;p[r*3+2]+=d.z;p[s*3]+=d.x;p[s*3+1]+=d.y;p[s*3+2]+=d.z;p[a*3]+=d.x;p[a*3+1]+=d.y;p[a*3+2]+=d.z}for(o=0;o<n;o++){var m=p[o*3];var _=p[o*3+1];var v=p[o*3+2];var g=1/Math.sqrt(m*m+_*_+v*v);p[o*3]*=g;p[o*3+1]*=g;p[o*3+2]*=g}return p}function wm(e,t,i,n){var r=n.length/3;var s=e.length/3;var a,o,l;var h,c,u,f,d,p,m,_,v,g,y;var b=new ce;var x=new ce;var S=new ce;var w=new ce;var T=new ce;var M=new he;var C=new he;var A=new he;var P;var E=new Float32Array(s*3);var I=new Float32Array(s*3);var R=[];var L=0;for(P=0;P<r;P++){a=n[P*3];o=n[P*3+1];l=n[P*3+2];S.set(e[a*3],e[a*3+1],e[a*3+2]);w.set(e[o*3],e[o*3+1],e[o*3+2]);T.set(e[l*3],e[l*3+1],e[l*3+2]);M.set(i[a*2],i[a*2+1]);C.set(i[o*2],i[o*2+1]);A.set(i[l*2],i[l*2+1]);h=w.x-S.x;c=T.x-S.x;u=w.y-S.y;f=T.y-S.y;d=w.z-S.z;p=T.z-S.z;m=C.x-M.x;_=A.x-M.x;v=C.y-M.y;g=A.y-M.y;L=m*g-_*v;if(L==0){b.set(0,1,0);x.set(1,0,0)}else{y=1/L;b.set((g*h-v*c)*y,(g*u-v*f)*y,(g*d-v*p)*y);x.set((m*c-_*h)*y,(m*f-_*u)*y,(m*p-_*d)*y)}E[a*3+0]+=b.x;E[a*3+1]+=b.y;E[a*3+2]+=b.z;E[o*3+0]+=b.x;E[o*3+1]+=b.y;E[o*3+2]+=b.z;E[l*3+0]+=b.x;E[l*3+1]+=b.y;E[l*3+2]+=b.z;I[a*3+0]+=x.x;I[a*3+1]+=x.y;I[a*3+2]+=x.z;I[o*3+0]+=x.x;I[o*3+1]+=x.y;I[o*3+2]+=x.z;I[l*3+0]+=x.x;I[l*3+1]+=x.y;I[l*3+2]+=x.z}v=new ce;g=new ce;var D=new ce;var k=new ce;for(P=0;P<s;P++){D.set(t[P*3],t[P*3+1],t[P*3+2]);v.set(E[P*3],E[P*3+1],E[P*3+2]);g.set(I[P*3],I[P*3+1],I[P*3+2]);var O=D.dot(v);k.copy(D).scale(O);k.sub2(v,k).normalize();R[P*4]=k.x;R[P*4+1]=k.y;R[P*4+2]=k.z;k.cross(D,v);R[P*4+3]=k.dot(g)<0?-1:1}return R}function Tm(e,t,i){var n=i&&i.normals!==undefined?i.normals:null;var r=i&&i.tangents!==undefined?i.tangents:null;var s=i&&i.colors!==undefined?i.colors:null;var a=i&&i.uvs!==undefined?i.uvs:null;var o=i&&i.uvs1!==undefined?i.uvs1:null;var l=i&&i.indices!==undefined?i.indices:null;var h=i&&i.blendIndices!==undefined?i.blendIndices:null;var c=i&&i.blendWeights!==undefined?i.blendWeights:null;var u=[{semantic:Ci,components:3,type:In}];if(n!==null)u.push({semantic:Ai,components:3,type:In});if(r!==null)u.push({semantic:Pi,components:4,type:In});if(s!==null)u.push({semantic:Ri,components:4,type:Mn,normalize:true});if(a!==null)u.push({semantic:Di,components:2,type:In});if(o!==null)u.push({semantic:ki,components:2,type:In});if(h!==null)u.push({semantic:Ii,components:2,type:Mn});if(c!==null)u.push({semantic:Ei,components:2,type:In});var f=new cr(e,u);var d=t.length/3;var p=new lr(e,f,d);var m=new Tr(p);for(var _=0;_<d;_++){m.element[Ci].set(t[_*3],t[_*3+1],t[_*3+2]);if(n!==null)m.element[Ai].set(n[_*3],n[_*3+1],n[_*3+2]);if(r!==null)m.element[Pi].set(r[_*4],r[_*4+1],r[_*4+2],r[_*4+3]);if(s!==null)m.element[Ri].set(s[_*4],s[_*4+1],s[_*4+2],s[_*4+3]);if(a!==null)m.element[Di].set(a[_*2],a[_*2+1]);if(o!==null)m.element[ki].set(o[_*2],o[_*2+1]);if(h!==null)m.element[Ii].set(h[_*2],h[_*2+1]);if(c!==null)m.element[Ei].set(c[_*2],c[_*2+1]);m.next()}m.end();var v=null;var g=l!==null;if(g){v=new Eu(e,Vt,l.length);var y=new Uint16Array(v.lock());y.set(l);v.unlock()}var b=new Ce;b.compute(t);var x=new Du(e);x.vertexBuffer=p;x.indexBuffer[0]=v;x.primitive[0].type=wi;x.primitive[0].base=0;x.primitive[0].count=g?l.length:d;x.primitive[0].indexed=g;x.aabb=b;return x}function Mm(e,t){var i=t&&t.tubeRadius!==undefined?t.tubeRadius:.2;var n=t&&t.ringRadius!==undefined?t.ringRadius:.3;var r=t&&t.segments!==undefined?t.segments:30;var s=t&&t.sides!==undefined?t.sides:20;var a=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var o,l;var h,c,u,f,d,p,m,_;var v=[];var g=[];var y=[];var b=[];for(o=0;o<=s;o++)for(l=0;l<=r;l++){h=Math.cos(2*Math.PI*l/r)*(n+i*Math.cos(2*Math.PI*o/s));c=Math.sin(2*Math.PI*o/s)*i;u=Math.sin(2*Math.PI*l/r)*(n+i*Math.cos(2*Math.PI*o/s));f=Math.cos(2*Math.PI*l/r)*Math.cos(2*Math.PI*o/s);d=Math.sin(2*Math.PI*o/s);p=Math.sin(2*Math.PI*l/r)*Math.cos(2*Math.PI*o/s);m=o/s;_=1-l/r;v.push(h,c,u);g.push(f,d,p);y.push(m,_);if(o<s&&l<r){var x,S,w,T;x=o*(r+1)+l;S=(o+1)*(r+1)+l;w=o*(r+1)+(l+1);T=(o+1)*(r+1)+(l+1);b.push(x,S,w);b.push(S,T,w)}}var M={normals:g,uvs:y,indices:b};if(a)M.tangents=a(v,g,y,b);return Tm(e,v,M)}function Cm(e,t,i,n,r,s){var a,o;var l,h,c,u,f;var d=new ce;var p=new ce;var m=new ce;var _,v,g;var y=[];var b=[];var x=[];var S=[];var w=[];var T,M,C;var A,P,E;var I,R,L,D;var k;if(i>0)for(a=0;a<=n;a++)for(o=0;o<=r;o++){T=o/r*2*Math.PI-Math.PI;C=Math.sin(T);M=Math.cos(T);v=new ce(C*e,-i/2,M*e);_=new ce(C*t,i/2,M*t);d.lerp(v,_,a/n);p.sub2(_,v).normalize();g=new ce(M,0,-C);m.cross(g,p).normalize();y.push(d.x,d.y,d.z);b.push(m.x,m.y,m.z);u=o/r;f=a/n;x.push(u,f);var O=f;f=u;u=O;u/=3;u=u*bm+ym;f=f*bm+ym;S.push(u,f);if(a<n&&o<r){I=a*(r+1)+o;R=a*(r+1)+(o+1);L=(a+1)*(r+1)+o;D=(a+1)*(r+1)+(o+1);w.push(I,R,L);w.push(R,D,L)}}if(s){var F,B;var N=Math.floor(r/2);var z=r;var V=i/2;for(F=0;F<=N;F++){T=F*Math.PI*.5/N;C=Math.sin(T);M=Math.cos(T);for(B=0;B<=z;B++){A=B*2*Math.PI/z-Math.PI/2;P=Math.sin(A);E=Math.cos(A);l=E*C;h=M;c=P*C;u=1-B/z;f=1-F/N;y.push(l*t,h*t+V,c*t);b.push(l,h,c);x.push(u,f);u/=3;f/=3;u=u*bm+ym;f=f*bm+ym;u+=1/3;S.push(u,f)}}k=(n+1)*(r+1);for(F=0;F<N;++F)for(B=0;B<z;++B){I=F*(z+1)+B;R=I+z+1;w.push(k+I+1,k+R,k+I);w.push(k+I+1,k+R+1,k+R)}for(F=0;F<=N;F++){T=Math.PI*.5+F*Math.PI*.5/N;C=Math.sin(T);M=Math.cos(T);for(B=0;B<=z;B++){A=B*2*Math.PI/z-Math.PI/2;P=Math.sin(A);E=Math.cos(A);l=E*C;h=M;c=P*C;u=1-B/z;f=1-F/N;y.push(l*t,h*t-V,c*t);b.push(l,h,c);x.push(u,f);u/=3;f/=3;u=u*bm+ym;f=f*bm+ym;u+=2/3;S.push(u,f)}}k=(n+1)*(r+1)+(z+1)*(N+1);for(F=0;F<N;++F)for(B=0;B<z;++B){I=F*(z+1)+B;R=I+z+1;w.push(k+I+1,k+R,k+I);w.push(k+I+1,k+R+1,k+R)}}else{k=(n+1)*(r+1);if(e>0)for(a=0;a<r;a++){T=a/r*2*Math.PI;l=Math.sin(T);h=-i/2;c=Math.cos(T);u=1-(l+1)/2;f=(c+1)/2;y.push(l*e,h,c*e);b.push(0,-1,0);x.push(u,f);u/=3;f/=3;u=u*bm+ym;f=f*bm+ym;u+=1/3;S.push(u,f);if(a>1)w.push(k,k+a,k+a-1)}k+=r;if(t>0)for(a=0;a<r;a++){T=a/r*2*Math.PI;l=Math.sin(T);h=i/2;c=Math.cos(T);u=1-(l+1)/2;f=(c+1)/2;y.push(l*t,h,c*t);b.push(0,1,0);x.push(u,f);u/=3;f/=3;u=u*bm+ym;f=f*bm+ym;u+=2/3;S.push(u,f);if(a>1)w.push(k,k+a-1,k+a)}}return{positions:y,normals:b,uvs:x,uvs1:S,indices:w}}function Am(e,t){var i=t&&(t.radius||t.baseRadius);i=i!==undefined?i:.5;var n=t&&t.height!==undefined?t.height:1;var r=t&&t.heightSegments!==undefined?t.heightSegments:5;var s=t&&t.capSegments!==undefined?t.capSegments:20;var a=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var o=Cm(i,i,n,r,s,false);if(a)o.tangents=a(o.positions,o.normals,o.uvs,o.indices);return Tm(e,o.positions,o)}function Pm(e,t){var i=t&&t.radius!==undefined?t.radius:.3;var n=t&&t.height!==undefined?t.height:1;var r=t&&t.heightSegments!==undefined?t.heightSegments:1;var s=t&&t.sides!==undefined?t.sides:20;var a=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var o=Cm(i,i,n-2*i,r,s,true);if(a)o.tangents=a(o.positions,o.normals,o.uvs,o.indices);return Tm(e,o.positions,o)}function Em(e,t){var i=t&&t.baseRadius!==undefined?t.baseRadius:.5;var n=t&&t.peakRadius!==undefined?t.peakRadius:0;var r=t&&t.height!==undefined?t.height:1;var s=t&&t.heightSegments!==undefined?t.heightSegments:5;var a=t&&t.capSegments!==undefined?t.capSegments:18;var o=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var l=Cm(i,n,r,s,a,false);if(o)l.tangents=o(l.positions,l.normals,l.uvs,l.indices);return Tm(e,l.positions,l)}function Im(e,t){var i=t&&t.radius!==undefined?t.radius:.5;var n=t&&t.latitudeBands!==undefined?t.latitudeBands:16;var r=t&&t.longitudeBands!==undefined?t.longitudeBands:16;var s=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var a,o;var l,h,c,u,f,d;var p,m;var _,v,g,y,b;var x=[];var S=[];var w=[];var T=[];for(o=0;o<=n;o++){l=o*Math.PI/n;h=Math.sin(l);c=Math.cos(l);for(a=0;a<=r;a++){u=a*2*Math.PI/r-Math.PI/2;f=Math.sin(u);d=Math.cos(u);_=d*h;v=c;g=f*h;y=1-a/r;b=1-o/n;x.push(_*i,v*i,g*i);S.push(_,v,g);w.push(y,b)}}for(o=0;o<n;++o)for(a=0;a<r;++a){p=o*(r+1)+a;m=p+r+1;T.push(p+1,m,p);T.push(p+1,m+1,m)}var M={normals:S,uvs:w,uvs1:w,indices:T};if(s)M.tangents=s(x,S,w,T);return Tm(e,x,M)}function Rm(e,t){var i=t&&t.halfExtents!==undefined?t.halfExtents:new he(.5,.5);var n=t&&t.widthSegments!==undefined?t.widthSegments:5;var r=t&&t.lengthSegments!==undefined?t.lengthSegments:5;var s=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var a,o;var l,h,c,u,f;var d=[];var p=[];var m=[];var _=[];var v=0;for(a=0;a<=n;a++)for(o=0;o<=r;o++){l=-i.x+2*i.x*a/n;h=0;c=-(-i.y+2*i.y*o/r);u=a/n;f=o/r;d.push(l,h,c);p.push(0,1,0);m.push(u,f);if(a<n&&o<r){_.push(v+r+1,v+1,v);_.push(v+r+1,v+r+2,v+1)}v++}var g={normals:p,uvs:m,uvs1:m,indices:_};if(s)g.tangents=s(d,p,m,_);return Tm(e,d,g)}function Lm(e,t){var i=t&&t.halfExtents!==undefined?t.halfExtents:new ce(.5,.5,.5);var n=t&&t.widthSegments!==undefined?t.widthSegments:1;var r=t&&t.lengthSegments!==undefined?t.lengthSegments:1;var s=t&&t.heightSegments!==undefined?t.heightSegments:1;var a=t&&t.calculateTangents!==undefined?t.calculateTangents:false;var f=[new ce(-i.x,-i.y,i.z),new ce(i.x,-i.y,i.z),new ce(i.x,i.y,i.z),new ce(-i.x,i.y,i.z),new ce(i.x,-i.y,-i.z),new ce(-i.x,-i.y,-i.z),new ce(-i.x,i.y,-i.z),new ce(i.x,i.y,-i.z)];var d=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]];var p=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]];var o={FRONT:0,BACK:1,TOP:2,BOTTOM:3,RIGHT:4,LEFT:5};var m=[];var _=[];var v=[];var g=[];var y=[];var b=0;var l=function e(t,i,n){var r,s;var a,o;for(a=0;a<=i;a++)for(o=0;o<=n;o++){var l=new ce;var h=new ce;var c=new ce;var u=new ce;l.lerp(f[d[t][0]],f[d[t][1]],a/i);h.lerp(f[d[t][0]],f[d[t][2]],o/n);c.sub2(h,f[d[t][0]]);u.add2(l,c);r=a/i;s=o/n;m.push(u.x,u.y,u.z);_.push(p[t][0],p[t][1],p[t][2]);v.push(r,s);r/=3;s/=3;r=r*bm+ym;s=s*bm+ym;r+=t%3/3;s+=Math.floor(t/3)/3;g.push(r,s);if(a<i&&o<n){y.push(b+n+1,b+1,b);y.push(b+n+1,b+n+2,b+1)}b++}};l(o.FRONT,n,s);l(o.BACK,n,s);l(o.TOP,n,r);l(o.BOTTOM,n,r);l(o.RIGHT,r,s);l(o.LEFT,r,s);var h={normals:_,uvs:v,uvs1:g,indices:y};if(a)h.tangents=a(m,_,v,y);return Tm(e,m,h)}function Dm(e,t){var i=null;for(var n=0;n<xm.length;n++)if(xm[n].type===t&&xm[n].device===e)i=xm[n].primData;if(!i){var r,s;switch(t){case"box":r=Lm(e,{halfExtents:new ce(.5,.5,.5)});s={x:2,y:2,z:2,uv:2/3};break;case"capsule":r=Pm(e,{radius:.5,height:2});s={x:Math.PI*2,y:Math.PI,z:Math.PI*2,uv:1/3+1/3/3*2};break;case"cone":r=Em(e,{baseRadius:.5,peakRadius:0,height:1});s={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":r=Am(e,{radius:.5,height:1});s={x:Math.PI,y:.79*2,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":r=Rm(e,{halfExtents:new he(.5,.5),widthSegments:1,lengthSegments:1});s={x:0,y:1,z:0,uv:1};break;case"sphere":r=Im(e,{radius:.5});s={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw new Error("Invalid primitive type: "+t)}i={mesh:r,area:s};xm.push({type:t,device:e,primData:i})}return i}var km=function(t){G(e,t);function e(){var e;e=t.call(this)||this;e.destroy=function(){this.skybox=null};e.root=null;e._gravity=new ce(0,-9.8,0);e._layers=null;e._fog=wl;e.fogColor=new ge(0,0,0);e.fogStart=1;e.fogEnd=1e3;e.fogDensity=0;e.ambientLight=new ge(0,0,0);e._gammaCorrection=Ph;e._toneMapping=0;e.exposure=1;e._skyboxPrefiltered=[null,null,null,null,null,null];e._firstUpdateSkybox=true;e._skyboxCubeMap=null;e.skyboxModel=null;e._skyboxIntensity=1;e._skyboxMip=0;e._skyboxRotation=new be;e._skyboxRotationMat3=null;e._skyboxRotationMat4=null;e._skyboxIsRenderTarget=false;e.lightmapSizeMultiplier=1;e.lightmapMaxResolution=2048;e.lightmapMode=bc;e._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0};e.updateShaders=true;e.updateSkybox=true;e._shaderVersion=0;e._statsUpdated=false;e._models=[];e.defaultMaterial=new pM;e.defaultMaterial.name="Default Material";e.defaultMaterial.shadingModel=xh;return e}var i=e.prototype;i.destroy=function e(){this.root=null;this.defaultMaterial.destroy();this.defaultMaterial=null;this.off()};i.applySettings=function e(t){this._gravity.set(t.physics.gravity[0],t.physics.gravity[1],t.physics.gravity[2]);this.ambientLight.set(t.render.global_ambient[0],t.render.global_ambient[1],t.render.global_ambient[2]);this._fog=t.render.fog;this.fogColor.set(t.render.fog_color[0],t.render.fog_color[1],t.render.fog_color[2]);this.fogStart=t.render.fog_start;this.fogEnd=t.render.fog_end;this.fogDensity=t.render.fog_density;this._gammaCorrection=t.render.gamma_correction;this._toneMapping=t.render.tonemapping;this.lightmapSizeMultiplier=t.render.lightmapSizeMultiplier;this.lightmapMaxResolution=t.render.lightmapMaxResolution;this.lightmapMode=t.render.lightmapMode;this.exposure=t.render.exposure;this._skyboxIntensity=t.render.skyboxIntensity===undefined?1:t.render.skyboxIntensity;this._skyboxMip=t.render.skyboxMip===undefined?0:t.render.skyboxMip;if(t.render.skyboxRotation!==undefined)this._skyboxRotation.setFromEulerAngles(t.render.skyboxRotation[0],t.render.skyboxRotation[1],t.render.skyboxRotation[2]);this._resetSkyboxModel();this.updateShaders=true};i._updateSkybox=function e(o){if(!this.skyboxModel){var t=[0,1,3,4,5,6];var l=this._skyboxMip?this._skyboxPrefiltered[t[this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(!l)return;if(l._isRenderTarget)this._skyboxIsRenderTarget=true;else this._skyboxIsRenderTarget=false;var i=new Cu;var h=this;i.updateShader=function(e,t,i,n,r){var s=o.getProgramLibrary();var a=s.getProgram("skybox",{rgbm:l.type===vn,hdr:l.type===vn||l.format===ii,useIntensity:h.skyboxIntensity!==1,useCubeMapRotation:!h.skyboxRotation.equals(be.IDENTITY),useRightHandedCubeMap:h._skyboxIsRenderTarget,mip:l.fixCubemapSeams?h.skyboxMip:0,fixSeams:l.fixCubemapSeams,gamma:r===uc?h.gammaCorrection?Rh:Ph:h.gammaCorrection,toneMapping:r===uc?Lh:h.toneMapping});this.shader=a};i.updateShader();i.setParameter("texture_cubeMap",l);if(!this.skyboxRotation.equals(be.IDENTITY)){if(!this._skyboxRotationMat4)this._skyboxRotationMat4=new ve;if(!this._skyboxRotationMat3)this._skyboxRotationMat3=new le;this._skyboxRotationMat4.setTRS(pc.Vec3.ZERO,this._skyboxRotation,pc.Vec3.ONE);this._skyboxRotationMat4.invertTo3x3(this._skyboxRotationMat3);i.setParameter("cubeMapRotationMatrix",this._skyboxRotationMat3.data)}i.cull=wt;i.depthWrite=false;var n=this.layers.getLayerById(Ol);if(n){var r=new Mf;var s=Lm(o);var a=new zu(r,s,i);a.cull=false;a._noDepthDrawGl1=true;var c=new Xu;c.graph=r;c.meshInstances=[a];this.skyboxModel=c;n.addMeshInstances(c.meshInstances);this.skyLayer=n;if(this._firstUpdateSkybox){n.enabled=true;this._firstUpdateSkybox=false}this.fire("set:skybox",l)}}};i._resetSkyboxModel=function e(){if(this.skyboxModel){this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances);this.skyboxModel.destroy()}this.skyboxModel=null;this.updateSkybox=true};i.setSkybox=function e(t){var i;if(!t)t=[null,null,null,null,null,null,null];var n=false;if(this._skyboxCubeMap!==t[0])n=true;if(!n)for(i=0;i<6&&!n;i++)if(this._skyboxPrefiltered[i]!==t[i+1])n=true;if(!n)return;for(i=0;i<6;i++)this._skyboxPrefiltered[i]=t[i+1];this.skybox=t[0]};i.addModel=function e(t){if(this.containsModel(t))return;var i=this.layers.getLayerById(Dl);if(!i)return;i.addMeshInstances(t.meshInstances);this._models.push(t)};i.addShadowCaster=function e(t){var i=this.layers.getLayerById(Dl);if(!i)return;i.addShadowCasters(t.meshInstances)};i.removeModel=function e(t){var i=this._models.indexOf(t);if(i!==-1){var n=this.layers.getLayerById(Dl);if(!n)return;n.removeMeshInstances(t.meshInstances);this._models.splice(i,1)}};i.removeShadowCasters=function e(t){var i=this.layers.getLayerById(Dl);if(!i)return;i.removeShadowCasters(t.meshInstances)};i.containsModel=function e(t){return this._models.indexOf(t)>=0};i.getModels=function e(t){return this._models};U(e,[{key:"fog",get:function e(){return this._fog},set:function e(t){if(t!==this._fog){this._fog=t;this.updateShaders=true}}},{key:"gammaCorrection",get:function e(){return this._gammaCorrection},set:function e(t){if(t!==this._gammaCorrection){this._gammaCorrection=t;this.updateShaders=true}}},{key:"toneMapping",get:function e(){return this._toneMapping},set:function e(t){if(t!==this._toneMapping){this._toneMapping=t;this.updateShaders=true}}},{key:"skybox",get:function e(){return this._skyboxCubeMap},set:function e(t){this._skyboxCubeMap=t;this._resetSkyboxModel();this.updateShaders=true}},{key:"skyboxIntensity",get:function e(){return this._skyboxIntensity},set:function e(t){this._skyboxIntensity=t;this._resetSkyboxModel();this.updateShaders=true}},{key:"skyboxRotation",get:function e(){return this._skyboxRotation},set:function e(t){if(!this._skyboxRotation.equals(t)){this._skyboxRotation.copy(t);this._resetSkyboxModel();this.updateShaders=true}}},{key:"skyboxMip",get:function e(){return this._skyboxMip},set:function e(t){this._skyboxMip=t;this._resetSkyboxModel();this.updateShaders=true}},{key:"skyboxPrefiltered128",get:function e(){return this._skyboxPrefiltered[0]},set:function e(t){if(this._skyboxPrefiltered[0]===t)return;this._skyboxPrefiltered[0]=t;this.updateShaders=true}},{key:"skyboxPrefiltered64",get:function e(){return this._skyboxPrefiltered[1]},set:function e(t){if(this._skyboxPrefiltered[1]===t)return;this._skyboxPrefiltered[1]=t;this.updateShaders=true}},{key:"skyboxPrefiltered32",get:function e(){return this._skyboxPrefiltered[2]},set:function e(t){if(this._skyboxPrefiltered[2]===t)return;this._skyboxPrefiltered[2]=t;this.updateShaders=true}},{key:"skyboxPrefiltered16",get:function e(){return this._skyboxPrefiltered[3]},set:function e(t){if(this._skyboxPrefiltered[3]===t)return;this._skyboxPrefiltered[3]=t;this.updateShaders=true}},{key:"skyboxPrefiltered8",get:function e(){return this._skyboxPrefiltered[4]},set:function e(t){if(this._skyboxPrefiltered[4]===t)return;this._skyboxPrefiltered[4]=t;this.updateShaders=true}},{key:"skyboxPrefiltered4",get:function e(){return this._skyboxPrefiltered[5]},set:function e(t){if(this._skyboxPrefiltered[5]===t)return;this._skyboxPrefiltered[5]=t;this.updateShaders=true}},{key:"drawCalls",get:function e(){var t=this.layers._meshInstances;if(!t.length){this.layers._update();t=this.layers._meshInstances}return t},set:function e(t){}},{key:"layers",get:function e(){return this._layers},set:function e(t){var i=this._layers;this._layers=t;this.fire("set:layers",i,t)}},{key:"defaultMaterial",get:function e(){return Cu.defaultMaterial},set:function e(t){Cu.defaultMaterial=t}}]);return e}(u);function Om(){return typeof Audio!=="undefined"}function Fm(){return!!(typeof AudioContext!=="undefined"||typeof webkitAudioContext!=="undefined")}var Bm=function(){function e(e,t,i){if(i===void 0)i={};this.volume=i.volume===undefined?1:i.volume;this.loop=i.loop===undefined?false:i.loop;this.pitch=i.pitch===undefined?1:i.pitch;this.sound=t;this.paused=false;this.suspended=false;this.manager=e;this.source=null;if(Fm()){this.startTime=0;this.startOffset=0;var n=e.context;this.gain=n.createGain()}else if(Om())if(t.audio){this.source=t.audio.cloneNode(false);this.source.pause()}}var t=e.prototype;t.getVolume=function e(){return this.volume};t.getLoop=function e(){return this.loop};t.setLoop=function e(t){this.loop=t;if(this.source)this.source.loop=t};t.getPitch=function e(){return this.pitch};t.onManagerVolumeChange=function e(){this.setVolume(this.getVolume())};t.onManagerSuspend=function e(){if(this.isPlaying()&&!this.suspended){this.suspended=true;this.pause()}};t.onManagerResume=function e(){if(this.suspended){this.suspended=false;this.unpause()}};return e}();if(Fm())Object.assign(Bm.prototype,{play:function e(){if(this.source)throw new Error("Call stop() before calling play()");this._createSource();if(!this.source)return;this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function e(){if(this.source){this.paused=true;this.startOffset+=this.manager.context.currentTime-this.startTime;this.source.stop(0);this.source=null}},unpause:function e(){if(this.source||!this.paused){console.warn("Call pause() before unpausing.");return}this._createSource();if(!this.source)return;this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.paused=false},stop:function e(){if(this.source){this.source.stop(0);this.source=null}this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function e(t){t=Pe.clamp(t,0,1);this.volume=t;if(this.gain)this.gain.gain.value=t*this.manager.volume},setPitch:function e(t){this.pitch=t;if(this.source)this.source.playbackRate.value=t},isPlaying:function e(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function e(){return this.source?this.source.buffer.duration:0},_createSource:function e(){var t=this.manager.context;if(this.sound.buffer){this.source=t.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.gain);this.gain.connect(t.destination);if(!this.loop)this.source.onended=this.pause.bind(this)}}});else if(Om())Object.assign(Bm.prototype,{play:function e(){if(this.source){this.paused=false;this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.source.play()}this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function e(){if(this.source){this.paused=true;this.source.pause()}},unpause:function e(){if(this.source){this.paused=false;this.source.play()}},stop:function e(){if(this.source)this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function e(t){t=Pe.clamp(t,0,1);this.volume=t;if(this.source)this.source.volume=t*this.manager.volume},setPitch:function e(t){this.pitch=t;if(this.source)this.source.playbackRate=t},getDuration:function e(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function e(){return!this.source.paused}});var Nm="linear",zm="inverse",Vm="exponential",Um=1e4,Gm=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this,e,t,i)||this;n.position=new ce;n.velocity=new ce;if(Fm())n.panner=e.context.createPanner();else{n.maxDistance=Um;n.minDistance=1;n.rollOffFactor=1;n.distanceModel=zm}return n}var t=e.prototype;t.getPosition=function e(){return this.position};t.getVelocity=function e(){return this.velocity};return e}(Bm);if(Fm())Object.assign(Gm.prototype,{setPosition:function e(t){this.position.copy(t);this.panner.setPosition(t.x,t.y,t.z)},setVelocity:function e(t){this.velocity.copy(t);this.panner.setVelocity(t.x,t.y,t.z)},getMaxDistance:function e(){return this.panner.maxDistance},setMaxDistance:function e(t){this.panner.maxDistance=t},getMinDistance:function e(){return this.panner.refDistance},setMinDistance:function e(t){this.panner.refDistance=t},getRollOffFactor:function e(){return this.panner.rolloffFactor},setRollOffFactor:function e(t){this.panner.rolloffFactor=t},getDistanceModel:function e(){return this.pannel.distanceModel},setDistanceModel:function e(t){this.panner.distanceModel=t},_createSource:function e(){var t=this.manager.context;this.source=t.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(t.destination);if(!this.loop)this.source.onended=this.pause.bind(this)}});else{var Hm=new ce;var Wm=function e(t,i,n,r,s,a){Hm=Hm.sub2(t,i);var o=Hm.length();if(o<n)return 1;else if(o>r)return 0;var l=0;if(a===Nm)l=1-s*(o-n)/(r-n);else if(a===zm)l=n/(n+s*(o-n));else if(a===Vm)l=Math.pow(o/n,-s);return Pe.clamp(l,0,1)};Object.assign(Gm.prototype,{setPosition:function e(t){this.position.copy(t);if(this.source){var i=this.manager.listener;var n=i.getPosition();var r=Wm(n,this.position,this.minDistance,this.maxDistance,this.rollOffFactor,this.distanceModel);var s=this.getVolume();this.source.volume=s*r}},setVelocity:function e(t){this.velocity.copy(t)},getMaxDistance:function e(){return this.maxDistance},setMaxDistance:function e(t){this.maxDistance=t},getMinDistance:function e(){return this.minDistance},setMinDistance:function e(t){this.minDistance=t},getRollOffFactor:function e(){return this.rollOffFactor},setRollOffFactor:function e(t){this.rollOffFactor=t},getDistanceModel:function e(){return this.distanceModel},setDistanceModel:function e(t){this.distanceModel=t}})}var jm=function(){function e(e){this.position=new ce;this.velocity=new ce;this.orientation=new ve;if(Fm())this.listener=e.context.listener}var t=e.prototype;t.getPosition=function e(){return this.position};t.setPosition=function e(t){this.position.copy(t);if(this.listener)this.listener.setPosition(t.x,t.y,t.z)};t.getVelocity=function e(){return this.velocity};t.setVelocity=function e(t){this.velocity.copy(t);if(this.listener)this.listener.setPosition(t.x,t.y,t.z)};t.setOrientation=function e(t){this.orientation.copy(t);if(this.listener)this.listener.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])};t.getOrientation=function e(){return this.orientation};return e}(),Xm=function(r){G(e,r);function e(e){var t;t=r.call(this)||this;if(Fm()||e.forceWebAudioApi){if(typeof AudioContext!=="undefined")t.context=new AudioContext;else if(typeof webkitAudioContext!=="undefined")t.context=new webkitAudioContext;if(t.context){var n=t.context;t.resumeContext=function(){this.context.resume();window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext)}.bind(H(t));window.addEventListener("mousedown",t.resumeContext);window.addEventListener("touchend",t.resumeContext);if(m.ios){var i=function e(){var t=n.createBuffer(1,1,44100);var i=n.createBufferSource();i.buffer=t;i.connect(n.destination);i.start(0);i.disconnect();window.removeEventListener("touchend",e)};window.addEventListener("touchend",i)}}}else console.warn("No support for 3D audio found");if(!Om())console.warn("No support for 2D audio found");t.listener=new jm(H(t));t._volume=1;t.suspended=false;return t}var t=e.prototype;t.suspend=function e(){this.suspended=true;this.fire("suspend")};t.resume=function e(){this.suspended=false;this.fire("resume")};t.destroy=function e(){window.removeEventListener("mousedown",this.resumeContext);window.removeEventListener("touchend",this.resumeContext);this.fire("destroy");if(this.context&&this.context.close){this.context.close();this.context=null}};t.playSound=function e(t,i){i=i||{};var n=null;if(Bm){n=new Bm(this,t,i);n.play()}return n};t.playSound3d=function e(t,i,n){n=n||{};var r=null;if(Gm){r=new Gm(this,t,n);r.setPosition(i);if(n.volume)r.setVolume(n.volume);if(n.loop)r.setLoop(n.loop);if(n.maxDistance)r.setMaxDistance(n.maxDistance);if(n.minDistance)r.setMinDistance(n.minDistance);if(n.rollOffFactor)r.setRollOffFactor(n.rollOffFactor);if(n.distanceModel)r.setDistanceModel(n.distanceModel);r.play()}return r};U(e,[{key:"volume",get:function e(){return this._volume},set:function e(t){t=Pe.clamp(t,0,1);this._volume=t;this.fire("volumechange",t)}}]);return e}(u),qm=function e(t,i,n,r){this.time=t;this.position=i;this.rotation=n;this.scale=r},Ym=function e(){this._name="";this._keys=[]},Km=function(){function e(){this.name="";this.duration=0;this._nodes=[];this._nodeDict={}}var t=e.prototype;t.getNode=function e(t){return this._nodeDict[t]};t.addNode=function e(t){this._nodes.push(t);this._nodeDict[t._name]=t};U(e,[{key:"nodes",get:function e(){return this._nodes}}]);return e}(),Qm=function(){function e(e){if(arguments.length===2)e=arguments[1];this.options=e;this.name=e.name;this.defaultWeight=e.defaultWeight||0;this.aabb=e.aabb;if(!this.aabb){this.aabb=new Ce;if(e.deltaPositions)this.aabb.compute(e.deltaPositions)}this.deltaPositions=e.deltaPositions}var t=e.prototype;t._postInit=function e(){this.options=null};t._initVertexBuffers=function e(t){var i=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,i.deltaPositions,i.deltaPositionsType);this._vertexBufferNormals=this._createVertexBuffer(t,i.deltaNormals,i.deltaNormalsType);if(this._vertexBufferPositions)this.deltaPositions=this._vertexBufferPositions.lock()};t._createVertexBuffer=function e(t,i,n){if(n===void 0)n=In;if(i){var r=[{semantic:Gi,components:3,type:n}];return new lr(t,new cr(t,r),i.length/3,lt,i)}return null};t._setTexture=function e(t,i){this[t]=i};t.destroy=function e(){if(this._vertexBufferPositions){this._vertexBufferPositions.destroy();this._vertexBufferPositions=null}if(this._vertexBufferNormals){this._vertexBufferNormals.destroy();this._vertexBufferNormals=null}if(this.texturePositions){this.texturePositions.destroy();this.texturePositions=null}if(this.textureNormals){this.textureNormals.destroy();this.textureNormals=null}};U(e,[{key:"morphPositions",get:function e(){return!!this._vertexBufferPositions||!!this.texturePositions}},{key:"morphNormals",get:function e(){return!!this._vertexBufferNormals||!!this.textureNormals}}]);return e}(),$m=function e(t,i,n){this.device=t;this.inverseBindPose=i;this.boneNames=n},Zm=function(){function e(e,t,i,n){this._paths=e;this._input=t;this._output=i;this._interpolation=n}U(e,[{key:"paths",get:function e(){return this._paths}},{key:"input",get:function e(){return this._input}},{key:"output",get:function e(){return this._output}},{key:"interpolation",get:function e(){return this._interpolation}}]);return e}(),Jm=function(){function e(e,t){this._components=e;this._data=t}U(e,[{key:"components",get:function e(){return this._components}},{key:"data",get:function e(){return this._data}}]);return e}(),e_=function(){function e(e,t,i,n,r){this._name=e;this._duration=t;this._inputs=i;this._outputs=n;this._curves=r}var t=e.prototype;t.eval=function e(t,i){i._time=t;var n=this._inputs;var r=this._outputs;var s=this._curves;var a=i._cache;var o=i._results;var l;for(l=0;l<n.length;++l)a[l].update(t,n[l]._data);for(l=0;l<s.length;++l){var h=s[l];var c=r[h._output];var u=o[l];a[h._input].eval(u,h._interpolation,c)}};U(e,[{key:"name",get:function e(){return this._name}},{key:"duration",get:function e(){return this._duration}},{key:"inputs",get:function e(){return this._inputs}},{key:"outputs",get:function e(){return this._outputs}},{key:"curves",get:function e(){return this._curves}}]);return e}(),t_=function(){function n(){}n.joinPath=function e(t,i){i=i||".";var n=function e(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+i,"g"),"\\"+i)};return t.map(n).join(i)};n.splitPath=function e(t,i){i=i||".";var n=[];var r="";var s=0;while(s<t.length){var a=t[s++];if(a==="\\"&&s<t.length){a=t[s++];if(a==="\\"||a===i)r+=a;else r+="\\"+a}else if(a===i){n.push(r);r=""}else r+=a}if(r.length>0)n.push(r);return n};n.encode=function e(t){return n.joinPath([n.joinPath(Array.isArray(t.entityPath)?t.entityPath:[t.entityPath]),t.component,n.joinPath(Array.isArray(t.propertyPath)?t.propertyPath:[t.propertyPath])],"/")};n.decode=function e(t){var i=n.splitPath(t,"/");return{entityPath:n.splitPath(i[0]),component:i[1],propertyPath:n.splitPath(i[2])}};var e=n.prototype;e.resolve=function e(t){return null};e.unresolve=function e(t){};e.update=function e(t){};return n}(),i_=0,n_=1,r_=2,s_="en-US",a_={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"},o_={};function l_(e,t){for(var i=0,n=e.length;i<n;i++)o_[e[i]]=t}function h_(e){var t=e.indexOf("-");if(t!==-1)return e.substring(0,t);return e}function c_(e,t){var i=e.indexOf("-");if(i!==-1)return t+e.substring(i);return t}function u_(e,t){if(t[e])return e;var i=a_[e];if(i&&t[i])return i;var n=h_(e);i=a_[n];if(t[i])return i;if(t[n])return n;return s_}l_(["ja","ko","th","vi","zh","id"],function(e){return 0}),l_(["fa","hi"],function(e){if(e>=0&&e<=1)return 0;return 1}),l_(["fr","pt"],function(e){if(e>=0&&e<2)return 0;return 1}),l_(["da"],function(e){if(e===1||!Number.isInteger(e)&&e>=0&&e<=1)return 0;return 1}),l_(["de","en","it","el","es","tr","fi","sv","nb","no","ur"],function(e){if(e===1)return 0;return 1}),l_(["ru","uk"],function(e){if(Number.isInteger(e)){var t=e%10;var i=e%100;if(t===1&&i!==11)return 0;else if(t>=2&&t<=4&&(i<12||i>14))return 1;else if(t===0||t>=5&&t<=9||i>=11&&i<=14)return 2}return 3}),l_(["pl"],function(e){if(Number.isInteger(e)){if(e===1)return 0;var t=e%10;var i=e%100;if(t>=2&&t<=4&&(i<12||i>14))return 1;else if(t>=0&&t<=1||t>=5&&t<=9||i>=12&&i<=14)return 2}return 3}),l_(["ar"],function(e){if(e===0)return 0;else if(e===1)return 1;else if(e===2)return 2;if(Number.isInteger(e)){var t=e%100;if(t>=3&&t<=10)return 3;else if(t>=11&&t<=99)return 4}return 5});var f_=o_[h_(s_)];function d_(e){return o_[e]||f_}var p_=new RegExp("^"+"\\s*"+"(?:"+"(?:"+"[a-z]+[a-z0-9\\-\\+\\.]*"+":"+")?"+"//"+"|"+"data:"+"|blob:"+")","i"),m_="animation",__="audio",v_="image",g_="json",y_="model",b_="material",x_="text",S_="texture",w_="cubemap",T_="shader",M_="css",C_="html",A_="script",P_="container",E_=[],I_=function(){function e(e){this.asset=e}var t=e.prototype;t.clear=function e(){for(var t=0;t<E_.length;t++)this[E_[t]]=null};return e}();function R_(e){var r="_"+e;E_.push(r);Object.defineProperty(I_.prototype,e,{get:function e(){return this[r]||null},set:function e(t){var i=!!this[r];var n=!!t;if(i!==n||this[r]&&t&&this[r].hash!==t.hash){if(t)this[r]={url:t.url,filename:t.filename,size:t.size,hash:t.hash,opt:t.opt||0};else this[r]=null;if(this.asset.file){this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file);this.asset.reload()}}}})}R_("dxt"),R_("pvr"),R_("etc1"),R_("etc2"),R_("basis");var L_=-1,D_={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},k_=["pvr","dxt","etc2","etc1","basis"],O_=function(a){G(e,a);function e(e,t,i,n,r){var s;s=a.call(this)||this;s._id=L_--;s.name=e||"";s.type=t;s.tags=new q(H(s));s._preload=false;s.variants=new I_(H(s));s._file=null;s._data=n||{};s.options=r||{};s._resources=[];s._i18n={};s.loaded=false;s.loading=false;s.registry=null;if(i)s.file=i;return s}var t=e.prototype;t.getFileUrl=function e(){var t=this.getPreferredFile();if(!t||!t.url)return null;var i=t.url;if(this.registry&&this.registry.prefix&&!p_.test(i))i=this.registry.prefix+i;if(this.type!=="script"&&t.hash){var n=i.indexOf("?")!==-1?"&":"?";i+=n+"t="+t.hash}return i};t.getPreferredFile=function e(){if(!this.file)return null;if(this.type==="texture"||this.type==="textureatlas"||this.type==="bundle"){var t=this.registry._loader._app;var i=t.graphicsDevice;for(var n=0,r=k_.length;n<r;n++){var s=k_[n];if(!i[D_[s]])continue;if(this.file.variants[s])return this.file.variants[s];if(t.enableBundles){var a=t.bundles.listBundlesForAsset(this);if(!a)continue;for(var o=0,l=a.length;o<l;o++)if(a[o].file&&a[o].file.variants&&a[o].file.variants[s])return this.file}}}return this.file};t.getAbsoluteUrl=function e(t){var i=p.getDirectory(this.file.url);return p.join(i,t)};t.getLocalizedAssetId=function e(t){t=u_(t,this._i18n);return this._i18n[t]||null};t.addLocalizedAssetId=function e(t,i){this._i18n[t]=i;this.fire("add:localized",t,i)};t.removeLocalizedAssetId=function e(t){var i=this._i18n[t];if(i){delete this._i18n[t];this.fire("remove:localized",t,i)}};t.ready=function e(t,i){i=i||this;if(this.resource)t.call(i,this);else this.once("load",function(e){t.call(i,e)})};t.reload=function e(){if(this.loaded){this.loaded=false;this.registry.load(this)}};t.unload=function e(){if(!this.loaded&&this._resources.length===0)return;this.fire("unload",this);this.registry.fire("unload:"+this.id,this);var t=this._resources;this.resources=[];this.loaded=false;if(this.file)this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var i=0;i<t.length;++i){var n=t[i];if(n&&n.destroy)n.destroy()}};U(e,[{key:"id",get:function e(){return this._id},set:function e(t){this._id=t}},{key:"file",get:function e(){return this._file},set:function e(t){var i;var n=!!t;var r=!!this._file;if(n!==r||t&&this._file&&t.hash!==this._file)if(t){if(!this._file)this._file={};this._file.url=t.url;this._file.filename=t.filename;this._file.hash=t.hash;this._file.size=t.size;this._file.variants=this.variants;this._file.contents=t.contents;if(t.hasOwnProperty("variants")){this.variants.clear();if(t.variants)for(i in t.variants){if(!t.variants[i])continue;this.variants[i]=t.variants[i]}}this.fire("change",this,"file",this._file,this._file);this.reload()}else{this._file=null;this.variants.clear()}else if(t&&this._file&&t.hasOwnProperty("variants")){this.variants.clear();if(t.variants)for(i in t.variants){if(!t.variants[i])continue;this.variants[i]=t.variants[i]}}}},{key:"data",get:function e(){return this._data},set:function e(t){var i=this._data;this._data=t;if(t!==i){this.fire("change",this,"data",t,i);if(this.loaded)this.registry._loader.patch(this,this.registry)}}},{key:"resource",get:function e(){return this._resources[0]},set:function e(t){var i=this._resources[0];this._resources[0]=t;this.fire("change",this,"resource",t,i)}},{key:"resources",get:function e(){return this._resources},set:function e(t){var i=this._resources;this._resources=t;this.fire("change",this,"resources",t,i)}},{key:"preload",get:function e(){return this._preload},set:function e(t){t=!!t;if(this._preload===t)return;this._preload=t;if(this._preload&&!this.loaded&&!this.loading&&this.registry)this.registry.load(this)}},{key:"loadFaces",get:function e(){return this._loadFaces},set:function e(t){t=!!t;if(!this.hasOwnProperty("_loadFaces")||t!==this._loadFaces){this._loadFaces=t;if(this.loaded)this.registry._loader.patch(this,this.registry)}}}]);return e}(u),F_=function e(t){return/^data:.*,.*$/i.test(t)},B_=function e(t){return t.substring(t.indexOf(":")+1,t.indexOf(";"))},N_=function e(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},z_=function e(t){switch(t){case 5120:return Tn;case 5121:return Mn;case 5122:return Cn;case 5123:return An;case 5124:return Pn;case 5125:return En;case 5126:return In;default:return 0}},V_=function e(t){switch(t){case 5120:return 1;case 5121:return 1;case 5122:return 2;case 5123:return 2;case 5124:return 4;case 5125:return 4;case 5126:return 4;default:return 0}},U_=function e(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}},G_={POSITION:Ci,NORMAL:Ai,TANGENT:Pi,COLOR_0:Ri,JOINTS_0:Ii,WEIGHTS_0:Ei,TEXCOORD_0:Di,TEXCOORD_1:ki},H_=function e(t,i){var n=N_(t.type);var r=U_(t.componentType);if(!r)return null;var s;if(t.sparse){var a=t.sparse;var o={count:a.count,type:"SCALAR"};var l=e(Object.assign(o,a.indices),i);var h={count:a.count,type:t.scalar,componentType:t.componentType};var c=e(Object.assign(h,a.values),i);if(t.hasOwnProperty("bufferView")){var u={bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type};s=e(u,i).slice()}else s=new r(t.count*n);for(var f=0;f<a.count;++f){var d=l[f];for(var p=0;p<n;++p)s[d*n+p]=c[f*n+p]}}else{var m=i[t.bufferView];s=new r(m.buffer,m.byteOffset+(t.hasOwnProperty("byteOffset")?t.byteOffset:0),t.count*n)}return s},W_=function e(t){if(!t.hasOwnProperty("mode"))return wi;switch(t.mode){case 0:return yi;case 1:return bi;case 2:return xi;case 3:return Si;case 4:return wi;case 5:return Ti;case 6:return Mi;default:return wi}},j_=function e(t){var i=new Uint16Array(t);for(var n=0;n<t;n++)i[n]=n;return i},X_=function e(t,i){var n=t[Ci];if(!n||n.components!==3)return;var r;if(n.size!==n.stride){var s=n.stride/ir[n.type];var a=new tr[n.type](n.buffer,n.offset,n.count*s);r=new tr[n.type](n.count*3);for(var o=0;o<n.count;++o){r[o*3+0]=a[o*s+0];r[o*3+1]=a[o*s+1];r[o*3+2]=a[o*s+2]}}else r=new tr[n.type](n.buffer,n.offset,n.count*3);var l=n.count;if(!i)i=j_(l);var h=Sm(r,i);var c=new Float32Array(h.length);c.set(h);t[Ai]={buffer:c.buffer,size:12,offset:0,stride:12,count:l,components:3,type:In}},q_=function e(o){var l,h;var t=[];var i=[];var n=[];for(l=0;l<o.format.elements.length;++l){var r=o.format.elements[l];if(r.name===Di||r.name===ki)switch(r.dataType){case In:t.push({offset:r.offset/4+1,stride:r.stride/4});break;case An:i.push({offset:r.offset/2+1,stride:r.stride/2});break;case Mn:n.push({offset:r.offset+1,stride:r.stride});break}}var s=function e(t,i,n){var r=new i(o.storage);for(l=0;l<t.length;++l){var s=t[l].offset;var a=t[l].stride;for(h=0;h<o.numVertices;++h){r[s]=n-r[s];s+=a}}};if(t.length>0)s(t,Float32Array,1);if(i.length>0)s(i,Uint16Array,65535);if(n.length>0)s(n,Uint8Array,255)},Y_=function e(t){var i=function e(t){var i=[];for(var n=0;n<t._levels.length;++n){var r=[];if(t.cubemap)for(var s=0;s<6;++s)r.push(t._levels[n][s]);else r=t._levels[n];i.push(r)}return i};var n=new pc.Texture(t.device,t);n._levels=i(t);return n},K_=function e(t){var i=new pc.Asset(t.name+"_clone",t.type,t.file,t.data,t.options);i.loaded=true;i.resource=Y_(t.resource);t.registry.add(i);return i},Q_=function e(t,i,n){var r=i[Ci];var s=r.count;var a=[];for(var o in i)if(i.hasOwnProperty(o))a.push({semantic:o,components:i[o].components,type:i[o].type,normalize:!!i[o].normalize});var l=[Ci,Ai,Pi,Ri,Ii,Ei,Di,ki];a.sort(function(e,t){var i=l.indexOf(e.semantic);var n=l.indexOf(t.semantic);return i<n?-1:n<i?1:0});var h,c,u;var f,d,p;var m=new cr(t,a);var _=true;for(h=0;h<m.elements.length;++h){d=m.elements[h];f=i[d.name];p=f.offset-r.offset;if(f.buffer!==r.buffer||f.stride!==d.stride||f.size!==d.size||p!==d.offset){_=false;break}}var v=new lr(t,m,s,lt);var g=v.lock();var y=new Uint32Array(g);var b;if(_){b=new Uint32Array(r.buffer,r.offset,s*v.format.size/4);y.set(b)}else{var x,S;for(h=0;h<v.format.elements.length;++h){d=v.format.elements[h];x=d.stride/4;f=i[d.name];b=new Uint32Array(f.buffer,f.offset,f.count*f.stride/4);S=f.stride/4;var w=0;var T=d.offset/4;var M=Math.floor((f.size+3)/4);for(c=0;c<s;++c){for(u=0;u<M;++u)y[T+u]=b[w+u];w+=S;T+=x}}}if(!n)q_(v);v.unlock();return v},$_=function e(t,i,n,r,s,a,o){var l,h={},c=[];for(l in i)if(i.hasOwnProperty(l)&&G_.hasOwnProperty(l)){h[l]=i[l];c.push(l+":"+i[l])}c.sort();var u=c.join();var f=o[u];if(!f){var d={};for(l in h){var p=r[i[l]];var m=H_(p,s);var _=s[p.bufferView];var v=G_[l];var g=N_(p.type)*V_(p.componentType);var y=_.hasOwnProperty("byteStride")?_.byteStride:g;d[v]={buffer:m.buffer,size:g,offset:m.byteOffset,stride:y,count:p.count,components:N_(p.type),type:z_(p.componentType),normalize:p.normalized}}if(!d.hasOwnProperty(Ai))X_(d,n);f=Q_(t,d,a);o[u]=f}return f},Z_=function e(t,h,i,c,u,n,r){var f=h.num_points();var s=function e(t){var i=c.GetAttributeByUniqueId(h,t);var n=f*i.num_components();var r=i.data_type();var s,a,o,l;switch(r){case u.DT_UINT8:l=Mn;o=1;s=u._malloc(n*o);c.GetAttributeDataArrayForAllPoints(h,i,u.DT_UINT8,n*o,s);a=new Uint8Array(u.HEAPU8.buffer,s,n).slice();break;case u.DT_UINT16:l=An;o=2;s=u._malloc(n*o);c.GetAttributeDataArrayForAllPoints(h,i,u.DT_UINT16,n*o,s);a=new Uint16Array(u.HEAPU16.buffer,s,n).slice();break;case u.DT_FLOAT32:default:l=In;o=4;s=u._malloc(n*o);c.GetAttributeDataArrayForAllPoints(h,i,u.DT_FLOAT32,n*o,s);a=new Float32Array(u.HEAPF32.buffer,s,n).slice();break}u._free(s);return{values:a,numComponents:i.num_components(),componentSizeInBytes:o,storageType:l,normalized:i.normalized()}};var a={};var o=i.attributes;for(var l in o)if(o.hasOwnProperty(l)&&G_.hasOwnProperty(l)){var d=G_[l];var p=s(o[l]);var m=p.numComponents*p.componentSizeInBytes;a[d]={values:p.values,buffer:p.values.buffer,size:m,offset:0,stride:m,count:f,components:p.numComponents,type:p.storageType,normalize:p.normalized}}if(!a.hasOwnProperty(Ai))X_(a,n);return Q_(t,a,r)},J_=function e(t,i,n,r,s){var a,o,l;var h=i.joints;var c=h.length;var u=[];if(i.hasOwnProperty("inverseBindMatrices")){var f=i.inverseBindMatrices;var d=H_(n[f],r);var p=[];for(a=0;a<c;a++){for(o=0;o<16;o++)p[o]=d[a*16+o];l=new ve;l.set(p);u.push(l)}}else for(a=0;a<c;a++){l=new ve;u.push(l)}var m=[];for(a=0;a<c;a++)m[a]=s[h[a]].name;var _=i.skeleton;var v=new $m(t,u,m);v.skeleton=s[_];v.bones=[];for(a=0;a<h.length;a++)v.bones[a]=s[h[a]];return v},ev=new ve,tv=new ce,iv=function e(P,E,I,R,L,D,k){var O=[];E.primitives.forEach(function(e){var t,i,n;var r=null;var s=new Du(P);var a=true;if(e.hasOwnProperty("extensions")){var o=e.extensions;if(o.hasOwnProperty("KHR_draco_mesh_compression")){var l=window.DracoDecoderModule;if(l){var h=o.KHR_draco_mesh_compression;if(h.hasOwnProperty("attributes")){var c=R[h.bufferView];var u=new l.DecoderBuffer;u.Init(c,c.length);var f=new l.Decoder;var d=f.GetEncodedGeometryType(u);var p,m;switch(d){case l.POINT_CLOUD:t=yi;p=new l.PointCloud;m=f.DecodeBufferToPointCloud(u,p);break;case l.TRIANGULAR_MESH:t=wi;p=new l.Mesh;m=f.DecodeBufferToMesh(u,p);break;case l.INVALID_GEOMETRY_TYPE:}if(!m||!m.ok()||p.ptr==0){L("Failed to decode draco compressed asset: "+(m?m.error_msg():"Mesh asset - invalid draco compressed geometry type: "+d));return}var _=p.num_faces();if(d==l.TRIANGULAR_MESH){var v=p.num_points()>65535;n=_*3;var g=n*(v?4:2);var y=l._malloc(g);if(v){f.GetTrianglesUInt32Array(p,g,y);r=new Uint32Array(l.HEAPU32.buffer,y,n).slice()}else{f.GetTrianglesUInt16Array(p,g,y);r=new Uint16Array(l.HEAPU16.buffer,y,n).slice()}l._free(y)}i=Z_(P,p,h,f,l,r,D);l.destroy(p);l.destroy(f);l.destroy(u);a=false}}}}if(!i){r=e.hasOwnProperty("indices")?H_(I[e.indices],R):null;i=$_(P,e.attributes,r,I,R,D,k);t=W_(e)}s.vertexBuffer=i;s.primitive[0].type=t;s.primitive[0].base=0;s.primitive[0].indexed=r!==null;if(r!==null){var b;if(r instanceof Uint8Array)b=zt;else if(r instanceof Uint16Array)b=Vt;else b=Ut;if(b===Ut&&!P.extUintElement){b=Vt;r=new Uint16Array(r)}var x=new Eu(P,b,r.length,lt,r);s.indexBuffer[0]=x;s.primitive[0].count=r.length}else s.primitive[0].count=i.numVertices;s.materialIndex=e.material;var S=I[e.attributes.POSITION];var w=S.min;var T=S.max;var M=new Ce(new ce((T[0]+w[0])/2,(T[1]+w[1])/2,(T[2]+w[2])/2),new ce((T[0]-w[0])/2,(T[1]-w[1])/2,(T[2]-w[2])/2));s.aabb=M;if(a&&e.hasOwnProperty("targets")){var C=[];e.targets.forEach(function(e,t){var i={};if(e.hasOwnProperty("POSITION")){S=I[e.POSITION];i.deltaPositions=H_(S,R);i.deltaPositionsType=z_(S.componentType);if(S.hasOwnProperty("min")&&S.hasOwnProperty("max")){i.aabb=new Ce;i.aabb.setMinMax(new ce(S.min),new ce(S.max))}}if(e.hasOwnProperty("NORMAL")){S=I[e.NORMAL];i.deltaNormals=H_(S,R);i.deltaNormalsType=z_(S.componentType)}if(E.hasOwnProperty("extras")&&E.extras.hasOwnProperty("targetNames"))i.name=E.extras.targetNames[t];else i.name=C.length.toString(10);C.push(new Qm(i))});s.morph=new Uu(C,P);if(E.hasOwnProperty("weights"))for(var A=0;A<E.weights.length;++A)C[A].defaultWeight=E.weights[A]}O.push(s)});return O},nv=function e(t,i,c){var n=["#ifdef MAPFLOAT","uniform float material_shininess;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_glossMap;","#endif","","void getGlossiness() {","\t\tdGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tdGlossiness *= material_shininess;","#endif","","#ifdef MAPTEXTURE","\t\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tdGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tdGlossiness = 1.0 - dGlossiness;","","\t\tdGlossiness += 0.0000001;","}"].join("\n");var r=["#ifdef MAPCOLOR","uniform vec3 material_specular;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_specularMap;","#endif","","void getSpecularity() {","\t\tdSpecularity = vec3(1.0);","","\t\t#ifdef MAPCOLOR","\t\t\t\tdSpecularity *= material_specular;","\t\t#endif","","\t\t#ifdef MAPTEXTURE","\t\t\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;","\t\t\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));","\t\t#endif","","\t\t#ifdef MAPVERTEX","\t\t\t\tdSpecularity *= saturate(vVertexColor.$VC);","\t\t#endif","}"].join("\n");var s=["#ifdef MAPFLOAT","uniform float material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","uniform sampler2D texture_clearCoatGlossMap;","#endif","","void getClearCoatGlossiness() {","\t\tccGlossiness = 1.0;","","#ifdef MAPFLOAT","\t\tccGlossiness *= material_clearCoatGlossiness;","#endif","","#ifdef MAPTEXTURE","\t\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;","#endif","","#ifdef MAPVERTEX","\t\tccGlossiness *= saturate(vVertexColor.$VC);","#endif","","\t\tccGlossiness = 1.0 - ccGlossiness;","","\t\tccGlossiness += 0.0000001;","}"].join("\n");var u=[1,1];var f=[0,0];var a=function e(t,i,n){var r;var s=t.texCoord;if(s)for(r=0;r<n.length;++r)i[n[r]+"MapUv"]=s;var a=u;var o=f;var l=t.extensions;if(l){var h=l.KHR_texture_transform;if(h){if(h.scale)a=h.scale;if(h.offset)o=h.offset}}for(r=0;r<n.length;++r){i[n[r]+"MapTiling"]=new he(a[0],a[1]);i[n[r]+"MapOffset"]=new he(o[0],c?o[1]:1-a[1]-o[1])}};var o=new pM;o.occludeSpecular=true;o.diffuseTint=true;o.diffuseVertexColor=true;o.specularTint=true;o.specularVertexColor=true;if(t.hasOwnProperty("name"))o.name=t.name;var l,h;if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var d=t.extensions.KHR_materials_pbrSpecularGlossiness;if(d.hasOwnProperty("diffuseFactor")){l=d.diffuseFactor;o.diffuse.set(Math.pow(l[0],1/2.2),Math.pow(l[1],1/2.2),Math.pow(l[2],1/2.2));o.opacity=l[3]!=null?l[3]:1}else{o.diffuse.set(1,1,1);o.opacity=1}if(d.hasOwnProperty("diffuseTexture")){var p=d.diffuseTexture;h=i[p.index];o.diffuseMap=h;o.diffuseMapChannel="rgb";o.opacityMap=h;o.opacityMapChannel="a";a(p,o,["diffuse","opacity"])}o.useMetalness=false;if(d.hasOwnProperty("specularFactor")){l=d.specularFactor;o.specular.set(Math.pow(l[0],1/2.2),Math.pow(l[1],1/2.2),Math.pow(l[2],1/2.2))}else o.specular.set(1,1,1);if(d.hasOwnProperty("glossinessFactor"))o.shininess=100*d.glossinessFactor;else o.shininess=100;if(d.hasOwnProperty("specularGlossinessTexture")){var m=d.specularGlossinessTexture;o.specularMap=o.glossMap=i[m.index];o.specularMapChannel="rgb";o.glossMapChannel="a";a(m,o,["gloss","metalness"])}o.chunks.specularPS=r}else if(t.hasOwnProperty("pbrMetallicRoughness")){var _=t.pbrMetallicRoughness;if(_.hasOwnProperty("baseColorFactor")){l=_.baseColorFactor;o.diffuse.set(Math.pow(l[0],1/2.2),Math.pow(l[1],1/2.2),Math.pow(l[2],1/2.2));o.opacity=l[3]}else{o.diffuse.set(1,1,1);o.opacity=1}if(_.hasOwnProperty("baseColorTexture")){var v=_.baseColorTexture;h=i[v.index];o.diffuseMap=h;o.diffuseMapChannel="rgb";o.opacityMap=h;o.opacityMapChannel="a";a(v,o,["diffuse","opacity"])}o.useMetalness=true;if(_.hasOwnProperty("metallicFactor"))o.metalness=_.metallicFactor;else o.metalness=1;if(_.hasOwnProperty("roughnessFactor"))o.shininess=100*_.roughnessFactor;else o.shininess=100;if(_.hasOwnProperty("metallicRoughnessTexture")){var g=_.metallicRoughnessTexture;o.metalnessMap=o.glossMap=i[g.index];o.metalnessMapChannel="b";o.glossMapChannel="g";a(g,o,["gloss","metalness"])}o.chunks.glossPS=n}if(t.hasOwnProperty("normalTexture")){var y=t.normalTexture;o.normalMap=i[y.index];a(y,o,["normal"]);if(y.hasOwnProperty("scale"))o.bumpiness=y.scale}if(t.hasOwnProperty("occlusionTexture")){var b=t.occlusionTexture;o.aoMap=i[b.index];o.aoMapChannel="r";a(b,o,["ao"])}if(t.hasOwnProperty("emissiveFactor")){l=t.emissiveFactor;o.emissive.set(Math.pow(l[0],1/2.2),Math.pow(l[1],1/2.2),Math.pow(l[2],1/2.2));o.emissiveTint=true}else{o.emissive.set(0,0,0);o.emissiveTint=false}if(t.hasOwnProperty("emissiveTexture")){var x=t.emissiveTexture;o.emissiveMap=i[x.index];a(x,o,["emissive"])}if(t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":o.blendType=ml;if(t.hasOwnProperty("alphaCutoff"))o.alphaTest=t.alphaCutoff;else o.alphaTest=.5;break;case"BLEND":o.blendType=pl;break;default:case"OPAQUE":o.blendType=ml;break}else o.blendType=ml;if(t.hasOwnProperty("doubleSided")){o.twoSidedLighting=t.doubleSided;o.cull=t.doubleSided?xt:St}else{o.twoSidedLighting=false;o.cull=St}if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")){var S=t.extensions.KHR_materials_clearcoat;if(S.hasOwnProperty("clearcoatFactor"))o.clearCoat=S.clearcoatFactor*.25;else o.clearCoat=0;if(S.hasOwnProperty("clearcoatTexture")){var w=S.clearcoatTexture;o.clearCoatMap=i[w.index];o.clearCoatMapChannel="r";a(w,o,["clearCoat"])}if(S.hasOwnProperty("clearcoatRoughnessFactor"))o.clearCoatGlossiness=S.clearcoatRoughnessFactor;else o.clearCoatGlossiness=0;if(S.hasOwnProperty("clearcoatRoughnessTexture")){var T=S.clearcoatRoughnessTexture;o.clearCoatGlossMap=i[T.index];o.clearCoatGlossMapChannel="g";a(T,o,["clearCoatGloss"])}if(S.hasOwnProperty("clearcoatNormalTexture")){var M=S.clearcoatNormalTexture;o.clearCoatNormalMap=i[M.index];a(M,o,["clearCoatNormal"]);if(M.hasOwnProperty("scale"))o.clearCoatBumpiness=M.scale}o.chunks.clearCoatGlossPS=s}if(t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")){o.useLighting=false;o.emissive.copy(o.diffuse);o.emissiveTint=o.diffuseTint;o.emissiveMap=o.diffuseMap;o.emissiveMapUv=o.diffuseMapUv;o.emissiveMapTiling.copy(o.diffuseMapTiling);o.emissiveMapOffset.copy(o.diffuseMapOffset);o.emissiveMapChannel=o.diffuseMapChannel;o.emissiveVertexColor=o.diffuseVertexColor;o.emissiveVertexColorChannel=o.diffuseVertexColorChannel;o.diffuse.set(0,0,0);o.diffuseTint=false;o.diffuseMap=null;o.diffuseVertexColor=false}o.update();return o},rv=function e(t,i,n,r,s){var a=function e(t){var i=H_(t,r);return new Jm(N_(t.type),new i.constructor(i))};var o={STEP:i_,LINEAR:n_,CUBICSPLINE:r_};var l={};var h=[];var c={};var u=[];var f=[];var d;for(d=0;d<t.samplers.length;++d){var p=t.samplers[d];if(!l.hasOwnProperty(p.input)){l[p.input]=h.length;h.push(a(n[p.input]))}if(!c.hasOwnProperty(p.output)){c[p.output]=u.length;u.push(a(n[p.output]))}var m=p.hasOwnProperty("interpolation")&&o.hasOwnProperty(p.interpolation)?o[p.interpolation]:n_;f.push(new Zm([],l[p.input],c[p.output],m))}var _=[];var v={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"};for(d=0;d<t.channels.length;++d){var g=t.channels[d];var y=g.target;var b=f[g.sampler];b._paths.push(t_.encode({entityPath:[s[y.node].path],component:"graph",propertyPath:[v[y.path]]}));if(y.path.startsWith("rotation")&&b.interpolation!==r_)_.push(b.output);else if(y.path.startsWith("weights"))u[b.output]._components=u[b.output].data.length/h[b.input].data.length}_.sort();var x=null;var S;for(d=0;d<_.length;++d){var w=_[d];if(d===0||w!==x){S=u[w];if(S.components===4){var T=S.data;var M=T.length-4;for(var C=0;C<M;C+=4){var A=T[C+0]*T[C+4]+T[C+1]*T[C+5]+T[C+2]*T[C+6]+T[C+3]*T[C+7];if(A<0){T[C+4]*=-1;T[C+5]*=-1;T[C+6]*=-1;T[C+7]*=-1}}}x=w}}var P=0;for(d=0;d<h.length;d++){S=h[d]._data;P=Math.max(P,S.length===0?0:S[S.length-1])}return new e_(t.hasOwnProperty("name")?t.name:"animation_"+i,P,h,u,f)},sv=function e(t,i){var n=new Mf;if(t.hasOwnProperty("name")&&t.name.length>0)n.name=t.name;else n.name="node_"+i;if(t.hasOwnProperty("matrix")){ev.data.set(t.matrix);ev.getTranslation(tv);n.setLocalPosition(tv);ev.getEulerAngles(tv);n.setLocalEulerAngles(tv);ev.getScale(tv);n.setLocalScale(tv)}if(t.hasOwnProperty("rotation")){var r=t.rotation;n.setLocalRotation(r[0],r[1],r[2],r[3])}if(t.hasOwnProperty("translation")){var s=t.translation;n.setLocalPosition(s[0],s[1],s[2])}if(t.hasOwnProperty("scale")){var a=t.scale;n.setLocalScale(a[0],a[1],a[2])}return n},av=function e(t,i,n,r){if(!i.hasOwnProperty("skins")||i.skins.length===0)return[];return i.skins.map(function(e){return J_(t,e,i.accessors,r,n)})},ov=function e(t,i,n,r,s){if(!i.hasOwnProperty("meshes")||i.meshes.length===0||!i.hasOwnProperty("accessors")||i.accessors.length===0||!i.hasOwnProperty("bufferViews")||i.bufferViews.length===0)return[];var a={};return i.meshes.map(function(e){return iv(t,e,i.accessors,n,r,s,a)})},lv=function e(t,i,n,r){if(!t.hasOwnProperty("materials")||t.materials.length===0)return[];var s=n&&n.material&&n.material.preprocess;var a=n&&n.material&&n.material.process||nv;var o=n&&n.material&&n.material.postprocess;return t.materials.map(function(e){if(s)s(e);var t=a(e,i,r);if(o)o(e,t);return t})},hv=function e(n,r,s,t){if(!n.hasOwnProperty("animations")||n.animations.length===0)return[];var a=t&&t.animation&&t.animation.preprocess;var o=t&&t.animation&&t.animation.postprocess;return n.animations.map(function(e,t){if(a)a(e);var i=rv(e,t,n.accessors,s,r);if(o)o(e,i);return i})},cv=function e(t,i){if(!t.hasOwnProperty("nodes")||t.nodes.length===0)return[];var n=i&&i.node&&i.node.preprocess;var r=i&&i.node&&i.node.process||sv;var s=i&&i.node&&i.node.postprocess;var a=t.nodes.map(function(e,t){if(n)n(e);var i=r(e,t);if(s)s(e,i);return i});for(var o=0;o<t.nodes.length;++o){var l=t.nodes[o];if(l.hasOwnProperty("children"))for(var h=0;h<l.children.length;++h){var c=a[o];var u=a[l.children[h]];if(!u.parent)c.addChild(u)}}return a},uv=function e(t,i){var n=[];var r=t.scenes.length;if(r===1&&t.scenes[0].nodes.length===1){var s=t.scenes[0].nodes[0];n.push(i[s])}else for(var a=0;a<r;a++){var o=t.scenes[a];var l=new Mf(o.name);for(var h=0;h<o.nodes.length;h++){var c=i[o.nodes[h]];l.addChild(c)}n.push(l)}return n},fv=function e(t,i,n,r,s,a){var o=s&&s.global&&s.global.preprocess;var l=s&&s.global&&s.global.postprocess;if(o)o(i);var h=i.asset&&i.asset.generator==="PlayCanvas";var c=cv(i,s);var u=uv(i,c);var f=hv(i,c,n,s);var d=lv(i,r.map(function(e){return e.resource}),s,h);var p=ov(t,i,n,a,h);var m=av(t,i,c,n);var _={gltf:i,nodes:c,scenes:u,animations:f,textures:r,materials:d,meshes:p,skins:m};if(l)l(i,_);a(null,_)},dv=function e(t,i){var n={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497};var r=function e(t){switch(t){case 9728:return Mt;case 9729:return Ct;case 9984:return At;case 9985:return Et;case 9986:return Pt;case 9987:return It;default:return Ct}};var s=function e(t){switch(t){case 33071:return We;case 33648:return je;case 10497:return He;default:return He}};if(t){i=i||n;t.minFilter=r(i.minFilter);t.magFilter=r(i.magFilter);t.addressU=s(i.wrapS);t.addressV=s(i.wrapT)}},pv=function e(n,h,r,s,c,t,u){var i=t&&t.image&&t.image.preprocess;var a=t&&t.image&&t.image.processAsync||function(e,t){t(null,null)};var o=t&&t.image&&t.image.postprocess;var f=function e(t){if(o)o(n,t);u(null,t)};var l=function e(t,i,n,r){var s={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"};var a={url:t};if(i){var o=s[i];if(o)a.filename="glb-texture-"+h+"."+o}var l=new O_("texture_"+h,"texture",a,null,{crossOrigin:n});l.on("load",function(){if(r)URL.revokeObjectURL(t);f(l)});l.on("error",function(e,t){u(e)});c.add(l);c.load(l)};if(i)i(n);a(n,function(e,t){if(e)u(e);else if(t)f(t);else if(n.hasOwnProperty("uri"))if(F_(n.uri))l(n.uri,B_(n.uri));else l(p.join(s,n.uri),null,"anonymous");else if(n.hasOwnProperty("bufferView")&&n.hasOwnProperty("mimeType")){var i=new Blob([r[n.bufferView]],{type:n.mimeType});l(URL.createObjectURL(i),n.mimeType,null,true)}else u("Invalid image found in gltf (neither uri or bufferView found). index="+h)})},mv=function e(s,a,o,l,h,c){if(!s.hasOwnProperty("images")||s.images.length===0||!s.hasOwnProperty("textures")||s.textures.length===0){c(null,[]);return}var t=h&&h.texture&&h.texture.preprocess;var i=h&&h.texture&&h.texture.processAsync||function(e,t,i){i(null,null)};var u=h&&h.texture&&h.texture.postprocess;var f=[];var n=[];var d=s.textures.length;var p=function e(t,i){if(!n[i])n[i]=[];n[i].push(t);if(--d===0){var r=[];n.forEach(function(e,n){e.forEach(function(e,t){var i=t===0?f[n]:K_(f[n]);dv(i.resource,(s.samplers||[])[s.textures[e].sampler]);r[e]=i;if(u)u(s.textures[t],i)})});c(null,r)}};for(var r=0;r<s.textures.length;++r){var m=s.textures[r];if(t)t(m);i(m,s.images,function(i,e,t,n){if(t)c(t);else{if(n===undefined||n===null)n=e.source;if(f[n])p(i,n);else{var r=s.images[n];pv(r,i,a,o,l,h,function(e,t){if(e)c(e);else{f[n]=t;p(i,n)}})}}}.bind(null,r,m))}},_v=function e(n,o,l,t,h){var r=[];if(!n.buffers||n.buffers.length===0){h(null,r);return}var i=t&&t.buffer&&t.buffer.preprocess;var s=t&&t.buffer&&t.buffer.processAsync||function(e,t){t(null,null)};var a=t&&t.buffer&&t.buffer.postprocess;var c=n.buffers.length;var u=function e(t,i){r[t]=i;if(a)a(n.buffers[t],i);if(--c===0)h(null,r)};for(var f=0;f<n.buffers.length;++f){var d=n.buffers[f];if(i)i(d);s(d,function(e,t,i,n){if(i)h(i);else if(n)u(e,new Uint8Array(n));else if(t.hasOwnProperty("uri"))if(F_(t.uri)){var r=atob(t.uri.split(",")[1]);var s=new Uint8Array(r.length);for(var a=0;a<r.length;a++)s[a]=r.charCodeAt(a);u(e,s)}else Z.get(p.join(l,t.uri),{cache:true,responseType:"arraybuffer",retry:false},function(e,t,i){if(t)h(t);else u(e,new Uint8Array(i))}.bind(null,e));else u(e,o)}.bind(null,f,d))}},vv=function e(t,i){var n=function e(t){if(typeof TextDecoder!=="undefined")return(new TextDecoder).decode(t);var i="";for(var n=0;n<t.length;n++)i+=String.fromCharCode(t[n]);return decodeURIComponent(escape(i))};var r=JSON.parse(n(t));if(r.asset&&r.asset.version&&parseFloat(r.asset.version)<2){i("Invalid gltf version. Expected version 2.0 or above but found version '"+r.asset.version+"'.");return}i(null,r)},gv=function e(t,i){var n=new DataView(t);var r=n.getUint32(0,true);var s=n.getUint32(4,true);var a=n.getUint32(8,true);if(r!==1179937895){i("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+r.toString(16));return}if(s!==2){i("Invalid version number found in glb header. Expected 2, found "+s);return}if(a<=0||a>t.byteLength){i("Invalid length found in glb header. Found "+a);return}var o=[];var l=12;while(l<a){var h=n.getUint32(l,true);if(l+h+8>t.byteLength)throw new Error("Invalid chunk length found in glb. Found "+h);var c=n.getUint32(l+4,true);var u=new Uint8Array(t,l+8,h);o.push({length:h,type:c,data:u});l+=h+8}if(o.length!==1&&o.length!==2){i("Invalid number of chunks found in glb file.");return}if(o[0].type!==1313821514){i("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+o[0].type.toString(16));return}if(o.length>1&&o[1].type!==5130562){i("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+o[1].type.toString(16));return}i(null,{gltfChunk:o[0].data,binaryChunk:o.length===2?o[1].data:null})},yv=function e(t,i,n){if(t&&t.toLowerCase().endsWith(".glb"))gv(i,n);else n(null,{gltfChunk:i,binaryChunk:null})},bv=function e(r,a,t,o){var s=[];var i=t&&t.bufferView&&t.bufferView.preprocess;var n=t&&t.bufferView&&t.bufferView.processAsync||function(e,t,i){i(null,null)};var l=t&&t.bufferView&&t.bufferView.postprocess;var h=r.bufferViews?r.bufferViews.length:0;if(!h){o(null,null);return}var c=function e(t,i){var n=r.bufferViews[t];if(n.hasOwnProperty("byteStride"))i.byteStride=n.byteStride;s[t]=i;if(l)l(n,i);if(--h===0)o(null,s)};for(var u=0;u<r.bufferViews.length;++u){var f=r.bufferViews[u];if(i)i(f);n(f,a,function(e,t,i,n){if(i)o(i);else if(n)c(e,n);else{var r=a[t.buffer];var s=new Uint8Array(r.buffer,r.byteOffset+(t.hasOwnProperty("byteOffset")?t.byteOffset:0),t.byteLength);c(e,s)}}.bind(null,u,f))}},xv=function(){function e(){}e.parseAsync=function e(t,r,i,s,a,o,l){yv(t,i,function(e,t){if(e){l(e);return}vv(t.gltfChunk,function(e,n){if(e){l(e);return}_v(n,t.binaryChunk,r,o,function(e,t){if(e){l(e);return}bv(n,t,o,function(e,i){if(e){l(e);return}mv(n,i,r,a,o,function(e,t){if(e){l(e);return}fv(s,n,i,t,o,l)})})})})})};e.parse=function e(t,i,n,r){var s=null;r=r||{};yv(t,i,function(e,t){if(e)console.error(e);else vv(t.gltfChunk,function(e,i){if(e)console.error(e);else bv(i,[t.binaryChunk],r,function(e,t){if(e)console.error(e);else fv(n,i,t,[],r,function(e,t){if(e)console.error(e);else s=t})})})});return s};e.createModel=function e(t,m){var i=function e(t,i,n,r,s,a,o){var l=i.materialIndex===undefined?m:s[i.materialIndex];var h=new zu(a,i,l);if(i.morph){var c=new Hu(i.morph);if(i.weights)for(var u=0;u<i.weights.length;u++)c.setWeight(u,i.weights[u]);h.morphInstance=c;t.morphInstances.push(c)}if(o.hasOwnProperty("skin")){var f=o.skin;var d=n[f];i.skin=d;var p=r[f];h.skinInstance=p;t.skinInstances.push(p)}t.meshInstances.push(h)};var n=new Xu;var r,s=[];for(r=0;r<t.skins.length;r++){var a=new ju(t.skins[r]);a.bones=t.skins[r].bones;s.push(a)}if(t.scenes.length===1)n.graph=t.scenes[0];else{n.graph=new Mf("SceneGroup");for(r=0;r<t.scenes.length;r++)n.graph.addChild(t.scenes[r])}for(var o=0;o<t.nodes.length;o++){var l=t.nodes[o];if(l.root===n.graph){var h=t.gltf.nodes[o];if(h.hasOwnProperty("mesh")){var c=t.meshes[h.mesh];for(var u=0;u<c.length;u++)i(n,c[u],t.skins,s,t.materials,l,h)}}}return n};return e}(),Sv=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var t={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(i.load.startsWith("blob:")||i.load.startsWith("data:"))if(p.getExtension(i.original).toLowerCase()===".glb")t.responseType=$.ResponseType.ARRAY_BUFFER;else t.responseType=$.ResponseType.JSON;Z.get(i.load,t,function(e,t){if(e)n("Error loading animation resource: "+i.original+" ["+e+"]");else n(null,t)})};t.open=function e(t,i){if(p.getExtension(t).toLowerCase()===".glb"){var n=xv.parse("filename.glb",i,null);if(!n)return null;return n.animations}return this["_parseAnimationV"+i.animation.version](i)};t._parseAnimationV3=function e(t){var i=t.animation;var n=new Km;n.name=i.name;n.duration=i.duration;for(var r=0;r<i.nodes.length;r++){var s=new Ym;var a=i.nodes[r];s._name=a.name;for(var o=0;o<a.keys.length;o++){var l=a.keys[o];var h=l.time;var c=l.pos;var u=l.rot;var f=l.scale;var d=new ce(c[0],c[1],c[2]);var p=(new be).setFromEulerAngles(u[0],u[1],u[2]);var m=new ce(f[0],f[1],f[2]);var _=new qm(h,d,p,m);s._keys.push(_)}n.addNode(s)}return n};t._parseAnimationV4=function e(t){var i=t.animation;var n=new Km;n.name=i.name;n.duration=i.duration;for(var r=0;r<i.nodes.length;r++){var s=new Ym;var a=i.nodes[r];s._name=a.name;var o=a.defaults.p;var l=a.defaults.r;var h=a.defaults.s;for(var c=0;c<a.keys.length;c++){var u=a.keys[c];var f=u.t;var d=o?o:u.p;var p=l?l:u.r;var m=h?h:u.s;var _=new ce(d[0],d[1],d[2]);var v=(new be).setFromEulerAngles(p[0],p[1],p[2]);var g=new ce(m[0],m[1],m[2]);var y=new qm(f,_,v,g);s._keys.push(y)}n.addNode(s)}return n};return e}(),wv=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var t={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(i.load.startsWith("blob:"))t.responseType=$.ResponseType.JSON;Z.get(i.load,t,function(e,t){if(e)n("Error loading animation clip resource: "+i.original+" ["+e+"]");else n(null,t)})};t.open=function e(t,i){var n=i.name;var r=i.duration;var s=i.inputs.map(function(e){return new Jm(1,e)});var a=i.outputs.map(function(e){return new Jm(e.components,e.data)});var o=i.curves.map(function(e){return new Zm([e.path],e.inputIndex,e.outputIndex,e.interpolation)});return new e_(n,r,s,a,o)};return e}(),Tv=function(){function e(e){this._layers=[];this._parameters={};var t;if(!Array.isArray(e.layers))for(var i in e.layers){var n=e.layers[i];var r={name:n.name,states:[],transitions:[]};for(t=0;t<n.states.length;t++)r.states.push(e.states[n.states[t]]);for(t=0;t<n.transitions.length;t++){var s=e.transitions[n.transitions[t]];if(s.conditions&&!Array.isArray(s.conditions)){var a=Object.keys(s.conditions);var o=[];for(var l=0;l<a.length;l++){var h=s.conditions[a[l]];if(h.parameterName)o.push(h)}s.conditions=o}if(Number.isInteger(s.from))s.from=e.states[s.from].name;if(Number.isInteger(s.to))s.to=e.states[s.to].name;r.transitions.push(s)}this._layers.push(r)}else this._layers=e.layers;for(var c in e.parameters){var u=e.parameters[c];this._parameters[u.name]={type:u.type,value:u.value}}}U(e,[{key:"parameters",get:function e(){return Object.assign({},this._parameters)}},{key:"layers",get:function e(){return this._layers}}]);return e}(),Mv=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var t={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(i.load.startsWith("blob:"))t.responseType=$.ResponseType.JSON;Z.get(i.load,t,function(e,t){if(e)n("Error loading animation state graph resource: "+i.original+" ["+e+"]");else n(null,t)})};t.open=function e(t,i){return new Tv(i)};return e}(),Cv=function(){function e(e){if(e instanceof Audio)this.audio=e;else this.buffer=e}U(e,[{key:"duration",get:function e(){var t=0;if(this.buffer)t=this.buffer.duration;else if(this.audio)t=this.audio.duration;return t||0}}]);return e}(),Av=function(){if(typeof window==="undefined")return false;var e=window.navigator.userAgent;var t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var i=e.indexOf("Trident/");if(i>0){var n=e.indexOf("rv:");return parseInt(e.substring(n+3,e.indexOf(".",n)),10)}return false}(),Pv={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"},Ev=function(){function e(e){this.manager=e;this.maxRetries=0}var t=e.prototype;t._isSupported=function e(t){var i=p.getExtension(t);if(Pv[i])return true;return false};t.load=function e(n,r){if(typeof n==="string")n={load:n,original:n};var t=function e(t){r(null,new Cv(t))};var i=function e(t){var i="Error loading audio url: "+n.original;if(t)i+=": "+(t.message||t);console.warn(i);r(i)};if(this._createSound){if(!this._isSupported(n.original)){i("Audio format for "+n.original+" not supported");return}this._createSound(n.load,t,i)}else i(null)};t.open=function e(t,i){return i};t._createSound=function e(t,i,n){if(Fm()){var r=this.manager;if(!r.context){n("Audio manager has no audio context");return}var s={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(t.startsWith("blob:")||t.startsWith("data:"))s.responseType=$.ResponseType.ARRAY_BUFFER;Z.get(t,s,function(e,t){if(e){n(e);return}r.context.decodeAudioData(t,i,n)})}else if(Om()){var a=null;try{a=new Audio}catch(e){n("No support for Audio element");return}if(Av)document.body.appendChild(a);var o=function e(){a.removeEventListener("canplaythrough",e);if(Av)document.body.removeChild(a);i(a)};a.onerror=function(){a.onerror=null;if(Av)document.body.removeChild(a);n()};a.addEventListener("canplaythrough",o);a.src=t}};return e}(),Iv=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{responseType:$.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)n(null,t);else n("Error loading binary resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}(),Rv=function(){function e(e){this._blobUrls={};for(var t=0,i=e.length;t<i;t++)if(e[t].url)this._blobUrls[e[t].name]=e[t].url}var t=e.prototype;t.hasBlobUrl=function e(t){return!!this._blobUrls[t]};t.getBlobUrl=function e(t){return this._blobUrls[t]};t.destroy=function e(){for(var t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null};return e}(),Lv;function Dv(d){var c;var p;if(typeof TextDecoder!=="undefined"){c=new TextDecoder("utf-8");p=new TextDecoder("windows-1252")}else console.warn("TextDecoder not supported - pc.Untar module will not work");function m(e){this._fields=e}m.parse=function(e,t,i){var n=new Uint8Array(e,t,i);var r=0;var s=[];while(r<i){var a;for(a=r;a<i;a++)if(n[a]==32)break;if(a>=i)throw new Error("Invalid PAX header data format.");var o=parseInt(c.decode(new Uint8Array(e,t+r,a-r)),10);var l=c.decode(new Uint8Array(e,t+a+1,o-(a-r)-2));var h=l.split("=");if(h.length!==2)throw new Error("Invalid PAX header data format.");if(h[1].length===0)h[1]=null;s.push({name:h[0],value:h[1]});r+=o}return new m(s)};m.prototype.applyHeader=function(e){for(var t=0;t<this._fields.length;t++){var i=this._fields[t].name;var n=this._fields[t].value;if(i==="path")i="name";if(n===null)delete e[i];else e[i]=n}};function r(e){this._arrayBuffer=e||new ArrayBuffer(0);this._bufferView=new DataView(this._arrayBuffer);this._globalPaxHeader=null;this._paxHeader=null;this._bytesRead=0}if(!d)Lv=r;r.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&this._bufferView.getUint32(this._bytesRead)!==0};r.prototype._readNextFile=function(){var e=new DataView(this._arrayBuffer,this._bytesRead,512);var t=p.decode(e);this._bytesRead+=512;var i=t.substr(0,100).replace(/\0/g,"");var n=t.substr(257,6);var r=parseInt(t.substr(124,12),8);var s=t.substr(156,1);var a=this._bytesRead;var o=null;var l=false;switch(s){case"0":case"":l=true;if(!d){var h=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+r)]);o=URL.createObjectURL(h)}break;case"g":this._globalPaxHeader=m.parse(this._arrayBuffer,this._bytesRead,r);break;case"x":this._paxHeader=m.parse(this._arrayBuffer,this._bytesRead,r);break}this._bytesRead+=r;var c=r%512;if(c!==0)this._bytesRead+=512-c;if(!l)return null;if(n.indexOf("ustar")!==-1){var u=t.substr(345,155).replace(/\0/g,"");if(u.length>0)i=u.trim()+i.trim()}var f={name:i,start:a,size:r,url:o};if(this._globalPaxHeader)this._globalPaxHeader.applyHeader(f);if(this._paxHeader){this._paxHeader.applyHeader(f);this._paxHeader=null}return f};r.prototype.untar=function(e){if(!c){console.error("Cannot untar because TextDecoder interface is not available for this platform.");return[]}var t=[];while(this._hasNext()){var i=this._readNextFile();if(!i)continue;if(e&&i.name)i.name=e+i.name;t.push(i)}return t};if(d)self.onmessage=function(e){var t=e.data.id;try{var i=new r(e.data.arrayBuffer);var n=i.untar(e.data.prefix);postMessage({id:t,files:n,arrayBuffer:e.data.arrayBuffer},[e.data.arrayBuffer])}catch(e){postMessage({id:t,error:e.toString()})}}}var kv=null;function Ov(){if(!kv){var e="("+Dv.toString()+")(true)\n\n";var t=new Blob([e],{type:"application/javascript"});kv=URL.createObjectURL(t)}return kv}var Fv=function(){function e(e){this._requestId=0;this._pendingRequests={};this._filenamePrefix=e;this._worker=new Worker(Ov());this._worker.addEventListener("message",this._onMessage.bind(this))}var t=e.prototype;t._onMessage=function e(t){var i=t.data.id;if(!this._pendingRequests[i])return;var n=this._pendingRequests[i];delete this._pendingRequests[i];if(t.data.error)n(t.data.error);else{var r=t.data.arrayBuffer;for(var s=0,a=t.data.files.length;s<a;s++){var o=t.data.files[s];var l=new Blob([r.slice(o.start,o.start+o.size)]);o.url=URL.createObjectURL(l)}n(null,t.data.files)}};t.untar=function e(t,i){var n=this._requestId++;this._pendingRequests[n]=i;this._worker.postMessage({id:n,prefix:this._filenamePrefix,arrayBuffer:t},[t])};t.hasPendingRequests=function e(){for(var t in this._pendingRequests)return true;return false};t.destroy=function e(){if(this._worker){this._worker.terminate();this._worker=null;this._pendingRequests=null}};return e}();Dv();var Bv=function(){function e(e){this._assets=e;this._worker=null;this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var r=this;Z.get(i.load,{responseType:$.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)try{r._untar(t,n)}catch(e){n("Error loading bundle resource "+i.original+": "+e)}else n("Error loading bundle resource "+i.original+": "+e)})};t._untar=function e(t,i){var n=this;if(m.workers){if(!n._worker)n._worker=new Fv(n._assets.prefix);n._worker.untar(t,function(e,t){i(e,t);if(!n._worker.hasPendingRequests()){n._worker.destroy();n._worker=null}})}else{var r=new Lv(t);var s=r.untar(n._assets.prefix);i(null,s)}};t.open=function e(t,i){return new Rv(i)};t.patch=function e(t,i){};return e}(),Nv=function(l){G(h,l);function h(e,t){var i;i=l.call(this,e)||this;if(e instanceof rM)t=e;i._batchHandle=null;i.c={};i._app=t;if(!t){i._app=rM.getApplication();if(!i._app)throw new Error("Couldn't find current application")}i._guid=null;i._destroying=false;i._template=false;return i}var e=h.prototype;e.addComponent=function e(t,i){var n=this._app.systems[t];if(!n)return null;if(this.c[t])return null;return n.addComponent(this,i)};e.removeComponent=function e(t){var i=this._app.systems[t];if(!i)return;if(!this.c[t])return;i.removeComponent(this)};e.findComponent=function e(t){var i=this.findOne(function(e){return e.c&&e.c[t]});return i&&i.c[t]};e.findComponents=function e(t){var i=this.find(function(e){return e.c&&e.c[t]});return i.map(function(e){return e.c[t]})};e.getGuid=function e(){if(!this._guid)this.setGuid(d.create());return this._guid};e.setGuid=function e(t){var i=this._app._entityIndex;if(this._guid)delete i[this._guid];this._guid=t;i[this._guid]=this};e._notifyHierarchyStateChanged=function e(t,i){var n=false;if(t===this&&this._app._enableList.length===0)n=true;t._beingEnabled=true;t._onHierarchyStateChanged(i);if(t._onHierarchyStatePostChanged)this._app._enableList.push(t);var r,s;var a=t._children;for(r=0,s=a.length;r<s;r++)if(a[r]._enabled)this._notifyHierarchyStateChanged(a[r],i);t._beingEnabled=false;if(n){for(r=0;r<this._app._enableList.length;r++)this._app._enableList[r]._onHierarchyStatePostChanged();this._app._enableList.length=0}};e._onHierarchyStateChanged=function e(t){l.prototype._onHierarchyStateChanged.call(this,t);var i;var n=this.c;for(var r in n)if(n.hasOwnProperty(r)){i=n[r];if(i.enabled)if(t)i.onEnable();else i.onDisable()}};e._onHierarchyStatePostChanged=function e(){var t=this.c;for(var i in t)if(t.hasOwnProperty(i))t[i].onPostStateChange()};e.findByGuid=function e(t){if(this._guid===t)return this;var i=this._app._entityIndex[t];if(i&&(i===this||i.isDescendantOf(this)))return i;return null};e.destroy=function e(){var t;this._destroying=true;for(t in this.c)this.c[t].enabled=false;for(t in this.c)this.c[t].system.removeComponent(this);if(this._parent)this._parent.removeChild(this);var i=this._children;var n=i.shift();while(n){if(n instanceof h)n.destroy();n._parent=null;n=i.shift()}this.fire("destroy",this);this.off();if(this._guid)delete this._app._entityIndex[this._guid];this._destroying=false};e.clone=function e(){var t={};var e=this._cloneRecursively(t);t[this.getGuid()]=e;zv(this,this,e,t);return e};e._cloneRecursively=function e(t){var i=new h(this._app);l.prototype._cloneInternal.call(this,i);for(var n in this.c){var r=this.c[n];r.system.cloneComponent(this,i)}var s;for(s=0;s<this._children.length;s++){var a=this._children[s];if(a instanceof h){var o=a._cloneRecursively(t);i.addChild(o);t[a.getGuid()]=o}}return i};return h}(Mf);function zv(e,t,i,n){var r,s;if(t instanceof Nv){var a=t.c;for(var o in a){var l=a[o];var h=l.system.getPropertiesOfType("entity");for(r=0,s=h.length;r<s;r++){var c=h[r];var u=c.name;var f=l[u];var d=!!e.findByGuid(f);if(d){var p=n[f].getGuid();if(p)i.c[o][u]=p;else console.warn("Could not find corresponding entity id when resolving duplicated entity references")}}}if(a.script&&!i._app.useLegacyScriptAttributeCloning)i.script.resolveDuplicatedEntityReferenceProperties(a.script,n);var m=t.children.filter(function(e){return e instanceof Nv});var _=i.children.filter(function(e){return e instanceof Nv});for(r=0,s=m.length;r<s;r++)zv(e,m[r],_[r],n)}}var Vv=function(){function e(e){this.data=e;this.model=null;this.renders=[];this.materials=[];this.textures=[];this.animations=[];this.registry=null}var t=e.prototype;t.instantiateModelEntity=function e(t){var i=new pc.Entity;i.addComponent("model",Object.assign({type:"asset",asset:this.model},t));return i};t.instantiateRenderEntity=function e(f){var t=function e(t,i,n){if(n){var r=new Nv;n._cloneInternal(r);var s=null;for(var a=0;a<i.meshInstances.length;a++){var o=i.meshInstances[a];if(o.node===n){var l=new zu(r,o.mesh,o.material);if(o.morphInstance)l.morphInstance=o.morphInstance.clone();if(o.skinInstance)t.push({src:o.skinInstance,dst:l});if(!s)s=[];s.push(l)}}if(s){r.addComponent("render",Object.assign({type:"asset"},f));r.render.meshInstances=s}var h=n.children;for(var c=0;c<h.length;c++){var u=e(t,i,h[c]);r.addChild(u)}return r}return null};var i=[];var n=t(i,this.model.resource,this.model.resource.graph);for(var r=0;r<i.length;r++){var s=i[r].src;var a=i[r].dst;var o=s.skin;var l=new ju(o);var h=[];for(var c=0;c<o.boneNames.length;c++){var u=o.boneNames[c];var d=n.findByName(u);h.push(d)}l.bones=h;a.skinInstance=l}return n};t.destroy=function e(){var i=this.registry;var n=function e(t){i.remove(t);t.unload()};var t=function e(t){t.forEach(function(e){n(e)})};if(this.animations){t(this.animations);this.animations=null}if(this.textures){t(this.textures);this.textures=null}if(this.materials){t(this.materials);this.materials=null}if(this.model){n(this.model);this.model=null}this.data=null;this.assets=null};return e}(),Uv=function(){function e(e,t){this._device=e;this._defaultMaterial=t;this.maxRetries=0}var t=e.prototype;t._getUrlWithoutParams=function e(t){return t.indexOf("?")>=0?t.split("?")[0]:t};t.load=function e(i,n,r){if(typeof i==="string")i={load:i,original:i};var t={responseType:$.ResponseType.ARRAY_BUFFER,retry:this.maxRetries>0,maxRetries:this.maxRetries};var s=this;var a=function e(t){xv.parseAsync(s._getUrlWithoutParams(i.original),p.extractPath(i.load),t,s._device,r.registry,r.options,function(e,t){if(e)n(e);else n(null,new Vv(t))})};if(r&&r.file&&r.file.contents)a(r.file.contents);else Z.get(i.load,t,function(e,t){if(!n)return;if(e)n("Error loading model: "+i.original+" ["+e+"]");else a(t)})};t.open=function e(t,i,n){return i};t.patch=function e(s,a){var t=s.resource;var i=t&&t.data;if(i){var n=function e(t,i,n){var r=new O_(s.name+"/"+t+"/"+n,t,{url:""});r.resource=i;r.loaded=true;a.add(r);return r};var r;var o=n("model",xv.createModel(i,this._defaultMaterial),0);var l=[];for(r=0;r<i.meshes.length;++r)l.push(n("render",i.meshes[r],r));var h=[];for(r=0;r<i.materials.length;++r)h.push(n("material",i.materials[r],r));var c=[];for(r=0;r<i.animations.length;++r)c.push(n("animation",i.animations[r],r));t.data=null;t.model=o;t.renders=l;t.materials=h;t.textures=i.textures;t.animations=c;t.registry=a}};return e}(),Gv=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)n(null,t);else n("Error loading css resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}();function Hv(e){var t=document.createElement("style");t.type="text/css";if(t.styleSheet)t.styleSheet.cssText=e;else t.appendChild(document.createTextNode(e));return t}var Wv=function(){function e(e,t,i){this._device=e;this._registry=t;this._loader=i}var t=e.prototype;t.load=function e(t,i,n){this.loadAssets(n,i)};t.open=function e(t,i,n){return n?n.resource:null};t.patch=function e(i,n){this.loadAssets(i,function(e,t){if(e){n.fire("error",i);n.fire("error:"+i.id,e,i);i.fire("error",i)}})};t.getAssetIds=function e(t){var i=[];i[0]=t.file;if((t.loadFaces||!t.file)&&t.data&&t.data.textures)for(var n=0;n<6;++n)i[n+1]=t.data.textures[n];else i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=null;return i};t.compareAssetIds=function e(t,i){if(t&&i){if(parseInt(t,10)===t||typeof t==="string")return t===i;return t.url===i.url}return t!==null===(i!==null)};t.update=function e(t,i,n){var r=t.data||{};var s=t._handlerState.assets;var a=t._resources;var o,l,h;var c=[null,null,null,null,null,null,null];var u=function e(){if(r.hasOwnProperty("type"))return r.type;if(r.hasOwnProperty("rgbm"))return r.rgbm?vn:_n;return null};if(!t.loaded||n[0]!==s[0]){if(n[0]){o=n[0].resource;for(h=0;h<6;++h){var f=[o._levels[h]];if(h===0&&this._device.useTexCubeLod)for(l=1;l<o._levels.length;++l)f[l]=o._levels[l];var d=new bu(this._device,{name:t.name+"_prelitCubemap"+(o.width>>h),cubemap:true,type:u()||o.type,width:o.width>>h,height:o.height>>h,format:o.format,levels:f,fixCubemapSeams:true,addressU:We,addressV:We});c[h+1]=d}}}else{c[1]=a[1]||null;c[2]=a[2]||null;c[3]=a[3]||null;c[4]=a[4]||null;c[5]=a[5]||null;c[6]=a[6]||null}var p=n.slice(1);if(!t.loaded||!this.cmpArrays(p,s.slice(1))){if(p.indexOf(null)===-1){var m=p.map(function(e){return e.resource});var _=[];for(l=0;l<m[0]._levels.length;++l)_.push(m.map(function(e){return e._levels[l]}));var v=new bu(this._device,{name:t.name+"_faces",cubemap:true,type:u()||m[0].type,width:m[0].width,height:m[0].height,format:m[0].format,levels:_,minFilter:r.hasOwnProperty("minFilter")?r.minFilter:m[0].minFilter,magFilter:r.hasOwnProperty("magFilter")?r.magFilter:m[0].magFilter,anisotropy:r.hasOwnProperty("anisotropy")?r.anisotropy:1,addressU:We,addressV:We,fixCubemapSeams:!!n[0]});c[0]=v}}else c[0]=a[0]||null;if(!this.cmpArrays(c,a)){t.resources=c;t._handlerState.assetIds=i;t._handlerState.assets=n;for(h=0;h<a.length;++h)if(a[h]!==null&&c.indexOf(a[h])===-1)a[h].destroy()}for(h=0;h<s.length;++h)if(s[h]!==null&&n.indexOf(s[h])===-1)s[h].unload()};t.cmpArrays=function e(t,i){if(t.length!==i.length)return false;for(var n=0;n<t.length;++n)if(t[n]!==i[n])return false;return true};t.resolveId=function e(t){var i=parseInt(t,10);return i===t||i.toString()===t?i:t};t.loadAssets=function e(n,r){if(!n.hasOwnProperty("_handlerState"))n._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]};var s=this;var a=s.getAssetIds(n);var o=[null,null,null,null,null,null,null];var t=n._handlerState.assetIds;var i=n._handlerState.assets;var l=s._registry;var h=7;var c=function e(t,i){o[t]=i;h--;if(h===0){s.update(n,a,o);r(null,n.resources)}};var u=function e(t,i){var n=i&&i.resource&&i.resource._levels[0];if(n&&typeof ImageBitmap!=="undefined"&&n instanceof ImageBitmap)createImageBitmap(n,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(e){i.resource._levels[0]=e;c(t,i)}).catch(function(e){r(e)});else c(t,i)};var f=function e(t,i,n){r(i)};var d=function e(t,i){if(i.loaded)u(t,i);else{l.once("load:"+i.id,u.bind(s,t));l.once("error:"+i.id,f.bind(s,t));if(!i.loading)l.load(i)}};var p;for(var m=0;m<7;++m){var _=this.resolveId(a[m]);if(!_)c(m,null);else if(s.compareAssetIds(_,t[m]))c(m,i[m]);else if(parseInt(_,10)===_){p=l.get(_);if(p)d(m,p);else setTimeout(function(e,t){var i=l.get(t);if(i)d(e,i);else f(e,"failed to find dependent cubemap asset="+t)}.bind(null,m,_))}else{var v=typeof _==="string"?{url:_,filename:_}:_;p=new O_(n.name+"_part_"+m,"texture",v);l.add(p);l.once("load:"+p.id,u.bind(s,m));l.once("error:"+p.id,f.bind(s,m));l.load(p)}}};return e}(),jv=function(){function e(){}var t=e.prototype;t.load=function e(t,i){i(null,null)};t.open=function e(t,i){return i};return e}(),Xv="msdf",qv="bitmap",Yv=function(){function e(e,t){this.type=t?t.type||Xv:Xv;this.em=1;this.textures=e;this.intensity=0;this._data=null;this.data=t}U(e,[{key:"data",get:function e(){return this._data},set:function e(t){this._data=t;if(!t)return;if(this._data.intensity!==undefined)this.intensity=this._data.intensity;if(!this._data.info)this._data.info={};if(!this._data.version||this._data.version<2){this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}];if(this._data.chars)for(var i in this._data.chars)this._data.chars[i].map=0}}}]);return e}();function Kv(r){if(r.version<3){if(r.version<2)r.info.maps=r.info.maps||[{width:r.info.width,height:r.info.height}];r.chars=Object.keys(r.chars||{}).reduce(function(e,t){var i=r.chars[t];var n=i.letter!==undefined?i.letter:Ae.fromCodePoint(t);if(r.version<2)i.map=i.map||0;e[n]=i;return e},{});r.version=3}return r}var Qv=function(){function e(e){this._loader=e;this.maxRetries=0}var t=e.prototype;t.load=function e(n,r,t){if(typeof n==="string")n={load:n,original:n};var s=this;if(p.getExtension(n.original)===".json")Z.get(n.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e){var i=Kv(t);s._loadTextures(n.load.replace(".json",".png"),i,function(e,t){if(e)return r(e);r(null,{data:i,textures:t})})}else r("Error loading font resource: "+n.original+" ["+e+"]")});else{if(t&&t.data)t.data=Kv(t.data);this._loadTextures(n.load,t&&t.data,r)}};t._loadTextures=function e(i,t,r){var s=t.info.maps.length;var a=0;var o=null;var l=new Array(s);var h=this._loader;var n=function e(n){var t=function e(t,i){if(o)return;if(t){o=t;return r(t)}i.upload();l[n]=i;a++;if(a===s)r(null,l)};if(n===0)h.load(i,"texture",t);else h.load(i.replace(".png",n+".png"),"texture",t)};for(var c=0;c<s;c++)n(c)};t.open=function e(t,i,n){var r;if(i.textures)r=new Yv(i.textures,i.data);else r=new Yv(i,null);return r};t.patch=function e(t,i){var n=t.resource;if(!n.data&&t.data)n.data=t.data;else if(!t.data&&n.data)t.data=n.data;if(t.data)t.data=Kv(t.data)};return e}(),$v=function(s){G(e,s);function e(e,t){var i;i=s.call(this)||this;i._assets=[];i._registry=t;i._loaded=false;i._count=0;i._total=0;i._failed=[];i._waitingAssets=[];if(e.length&&e[0]instanceof O_)i._assets=e;else for(var n=0;n<e.length;n++){var r=t.get(e[n]);if(r)i._assets.push(r);else{i._waitForAsset(e[n]);i._total++}}return i}var t=e.prototype;t.destroy=function e(){var t=this;this._registry.off("load",this._onLoad);this._registry.off("error",this._onError);this._waitingAssets.forEach(function(e){t._registry.off("add:"+e,this._onAddAsset)});this.off("progress");this.off("load")};t.load=function e(t,i){var n=0;var r=this._assets.length;var s;this._count=0;this._failed=[];this._callback=t;this._scope=i;this._registry.on("load",this._onLoad,this);this._registry.on("error",this._onError,this);for(n=0;n<r;n++){s=this._assets[n];if(!s.loading&&!s.loaded){this._registry.load(s);this._total++}}};t.ready=function e(t,i){i=i||this;if(this._loaded)t.call(i,this._assets);else this.once("load",function(e){t.call(i,e)})};t._loadingComplete=function e(){this._loaded=true;this._registry.off("load",this._onLoad,this);this._registry.off("error",this._onError,this);if(this._failed&&this._failed.length){if(this._callback)this._callback.call(this._scope,"Failed to load some assets",this._failed);this.fire("error",this._failed)}else{if(this._callback)this._callback.call(this._scope);this.fire("load",this._assets)}};t._onLoad=function e(t){var i=this;if(this._assets.indexOf(t)>=0){this._count++;this.fire("progress",t)}if(this._count===this._total)setTimeout(function(){i._loadingComplete(i._failed)},0)};t._onError=function e(t,i){var n=this;if(this._assets.indexOf(i)>=0){this._count++;this._failed.push(i)}if(this._count===this._total)setTimeout(function(){n._loadingComplete(n._failed)},0)};t._onAddAsset=function e(t){var i=this._waitingAssets.indexOf(t);if(i>=0)this._waitingAssets.splice(i,1);this._assets.push(t);var n;var r=this._assets.length;for(n=0;n<r;n++){t=this._assets[n];if(!t.loading&&!t.loaded)this._registry.load(t)}};t._waitForAsset=function e(t){this._waitingAssets.push(t);this._registry.once("add:"+t,this._onAddAsset,this)};return e}(u),Zv={waitForTemplatesInScene:function e(t,i,n){if(t.collapsedInstances){var r=Zv._getAllCollapsedEntities(t);Zv.waitForTemplateAssets(r,i,n,t)}else n(null,t)},waitForTemplateAssets:function e(t,i,n,r){var s=Zv._extractTemplateIds(t);var a=new $v(s,i);a.load(function(e){n(e,r)})},_getAllCollapsedEntities:function e(t){var i={};t.collapsedInstances.forEach(function(e){Object.assign(i,e.instanceEntities)});return i},_extractTemplateIds:function e(t){var i=[];for(var n in t){var r=t[n].template_id;if(r)i.push(r)}return i},expandTemplateEntities:function e(t,i){var n={};for(var r in i){var s=i[r];n[r]=s.collapsed_entity?Zv.expandEntity(t,s):s}return n},expandEntity:function e(t,i){}},Jv={setCompressedPRS:function e(t,i,n){var r=n.singleVecs;var s,a;var o=i.___1;if(!o){s=n.tripleVecs;a=i.___2}var l=o?o[0]:s[a];t.setLocalPosition(r[l],r[l+1],r[l+2]);l=o?o[1]:s[a+1];t.setLocalEulerAngles(r[l],r[l+1],r[l+2]);l=o?o[2]:s[a+2];t.setLocalScale(r[l],r[l+1],r[l+2])},oneCharToKey:function e(t,i){var n=t.charCodeAt(0)-i.fieldFirstCode;return i.fieldArray[n]},multCharToKey:function e(t,i){var n=0;for(var r=0;r<t.length;r++)n=n*i.fieldCodeBase+t.charCodeAt(r)-i.fieldFirstCode;return i.fieldArray[n]}},eg=function(){function r(e,t){this._node=e;this._data=t}var e=r.prototype;e.run=function e(){var t=Object.prototype.toString.call(this._node);if(t==="[object Object]")this._handleMap();else if(t==="[object Array]")this._handleArray();else this._result=this._node;return this._result};e._handleMap=function e(){this._result={};var t=Object.keys(this._node);t.forEach(this._handleKey,this)};e._handleKey=function e(t){var i=t;var n=t.length;if(n===1)i=Jv.oneCharToKey(t,this._data);else if(n===2)i=Jv.multCharToKey(t,this._data);this._result[i]=new r(this._node[t],this._data).run()};e._handleArray=function e(){this._result=[];this._node.forEach(this._handleArElt,this)};e._handleArElt=function e(t){var i=new r(t,this._data).run();this._result.push(i)};return r}(),tg=function(){function e(e,t){this._app=e;this._isTemplate=t}var t=e.prototype;t.parse=function e(t){var i={};var n,r,s;var a=null;var o=t.compressedFormat;if(o)t.entities=new eg(t.entities,o).run();if(t.collapsedInstances)this._addCollapsedToEntities(this._app,t);for(n in t.entities){var l=t.entities[n];s=this._createEntity(l,o);i[n]=s;if(l.parent===null)a=s}for(n in t.entities){s=i[n];var h=t.entities[n].children;var c=h.length;for(r=0;r<c;r++){var u=i[h[r]];if(u)s.addChild(u)}}this._openComponentData(a,t.entities);delete t.compressedFormat;return a};t._createEntity=function e(t,i){var n=new Nv;n.name=t.name;n.setGuid(t.resource_id);this._setPosRotScale(n,t,i);n._enabled=t.enabled!==undefined?t.enabled:true;if(this._isTemplate)n._template=true;else n._enabledInHierarchy=n._enabled;n.template=t.template;if(t.tags)for(var r=0;r<t.tags.length;r++)n.tags.add(t.tags[r]);if(t.labels)t.labels.forEach(function(e){n.addLabel(e)});return n};t._setPosRotScale=function e(t,i,n){if(n)Jv.setCompressedPRS(t,i,n);else{var r=i.position;var s=i.rotation;var a=i.scale;t.setLocalPosition(r[0],r[1],r[2]);t.setLocalEulerAngles(s[0],s[1],s[2]);t.setLocalScale(a[0],a[1],a[2])}};t._openComponentData=function e(t,i){var n=this._app.systems.list;var r,s=n.length;var a=i[t.getGuid()];for(r=0;r<s;r++){var o=n[r];var l=a.components[o.id];if(l)o.addComponent(t,l)}s=a.children.length;var h=t._children;for(r=0;r<s;r++)h[r]=this._openComponentData(h[r],i);return t};t._addCollapsedToEntities=function e(i,n){n.collapsedInstances.forEach(function(e){var t=Zv.expandTemplateEntities(i,e.instanceEntities);Object.assign(n.entities,t)})};return e}(),ig=function(){function e(e){this._app=e;this.maxRetries=0}var t=e.prototype;t.load=function e(n,r){if(typeof n==="string")n={load:n,original:n};var s=this._app.assets;Z.get(n.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)Zv.waitForTemplatesInScene(t,s,r);else{var i="Error while loading scene "+n.original;if(e.message){i+=": "+e.message;if(e.stack)i+="\n"+e.stack}else i+=": "+e;r(i)}})};t.open=function e(t,i){this._app.systems.script.preloading=true;var n=new tg(this._app,false);var r=n.parse(i);this._app.systems.script.preloading=false;return r};return e}(),ng=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)n(null,t);else n("Error loading html resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}(),rg=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var t={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(i.load.startsWith("blob:"))t.responseType=$.ResponseType.JSON;Z.get(i.load,t,function(e,t){if(!e)n(null,t);else n("Error loading JSON resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}(),sg={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",alphaFade:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",opacityFadesSpecular:"boolean",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},ag,og,lg=[];for(ag in sg){og=sg[ag];if(og==="texture")lg.push(ag)}var hg=[];for(ag in sg){og=sg[ag];if(og==="cubemap")hg.push(ag)}var cg=function(){function e(e,t,i,n,r){this.propertyName=e;this.parent=t;this._scope=r;this._registry=i;this.id=null;this.url=null;this.asset=null;this._onAssetLoad=n.load;this._onAssetAdd=n.add;this._onAssetRemove=n.remove;this._onAssetUnload=n.unload}var t=e.prototype;t._bind=function e(){if(this.id){if(this._onAssetLoad)this._registry.on("load:"+this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:"+this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:"+this.id,this._onRemove,this);if(this._onAssetUnload)this._registry.on("unload:"+this.id,this._onUnload,this)}if(this.url){if(this._onAssetLoad)this._registry.on("load:url:"+this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.once("add:url:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.on("remove:url:"+this.url,this._onRemove,this)}};t._unbind=function e(){if(this.id){if(this._onAssetLoad)this._registry.off("load:"+this.id,this._onLoad,this);if(this._onAssetAdd)this._registry.off("add:"+this.id,this._onAdd,this);if(this._onAssetRemove)this._registry.off("remove:"+this.id,this._onRemove,this);if(this._onAssetUnload)this._registry.off("unload:"+this.id,this._onUnload,this)}if(this.url){if(this._onAssetLoad)this._registry.off("load:"+this.url,this._onLoad,this);if(this._onAssetAdd)this._registry.off("add:"+this.url,this._onAdd,this);if(this._onAssetRemove)this._registry.off("remove:"+this.url,this._onRemove,this)}};t._onLoad=function e(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)};t._onAdd=function e(t){this.asset=t;this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)};t._onRemove=function e(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t);this.asset=null};t._onUnload=function e(t){this._onAssetUnload.call(this._scope,this.propertyName,this.parent,t)};U(e,[{key:"id",get:function e(){return this._id},set:function e(t){if(this.url)throw Error("Can't set id and url");this._unbind();this._id=t;this.asset=this._registry.get(this._id);this._bind()}},{key:"url",get:function e(){return this._url},set:function e(t){if(this.id)throw Error("Can't set id and url");this._unbind();this._url=t;this.asset=this._registry.getByUrl(this._url);this._bind()}}]);return e}();function ug(){this.removeInvalid=true;this.valid=true;this.enumValidators={occludeSpecular:this._createEnumValidator([Bh,Nh,zh]),cull:this._createEnumValidator([xt,St,wt,Tt]),blendType:this._createEnumValidator([fl,dl,pl,ml,_l,vl,gl,yl,bl,xl,Sl]),shadingModel:this._createEnumValidator([bh,xh])}}ug.prototype.setInvalid=function(e,t){this.valid=false;if(this.removeInvalid)delete t[e]},ug.prototype.validate=function(e){var t=sg;var i;var n;var r=e.mappingFormat==="path";for(var s in e){i=t[s];if(!i){this.valid=false;continue}if(i.startsWith("enum")){var a=i.split(":")[1];if(this.enumValidators[a])if(!this.enumValidators[a](e[s]))this.setInvalid(s,e)}else if(i==="number"){if(typeof e[s]!=="number")this.setInvalid(s,e)}else if(i==="boolean"){if(typeof e[s]!=="boolean")this.setInvalid(s,e)}else if(i==="string"){if(typeof e[s]!=="string")this.setInvalid(s,e)}else if(i==="vec2"){if(!(e[s]instanceof Array&&e[s].length===2))this.setInvalid(s,e)}else if(i==="rgb"){if(!(e[s]instanceof Array&&e[s].length===3))this.setInvalid(s,e)}else if(i==="texture"){if(!r){if(!(typeof e[s]==="number"||e[s]===null))if(!(e[s]instanceof bu))this.setInvalid(s,e)}else if(!(typeof e[s]==="string"||e[s===null]))if(!(e[s]instanceof bu))this.setInvalid(s,e)}else if(i==="boundingbox"){if(!(e[s].center&&e[s].center instanceof Array&&e[s].center.length===3))this.setInvalid(s,e);if(!(e[s].halfExtents&&e[s].halfExtents instanceof Array&&e[s].halfExtents.length===3))this.setInvalid(s,e)}else if(i==="cubemap"){if(!(typeof e[s]==="number"||e[s]===null||e[s]===undefined))if(!(e[s]instanceof bu&&e[s].cubemap))this.setInvalid(s,e)}else if(i==="chunks"){var o=Object.keys(e[s]);for(n=0;n<o.length;n++)if(typeof e[s][o[n]]!=="string")this.setInvalid(o[n],e[s])}else console.error("Unknown material type: "+i)}e.validated=true;return this.valid},ug.prototype._createEnumValidator=function(t){return function(e){return t.indexOf(e)>=0}};var fg=function(){function e(){this._validator=null}var t=e.prototype;t.parse=function e(t){var i=this.migrate(t);var n=this._validate(i);var r=new pM;this.initialize(r,n);return r};t.initialize=function e(t,i){if(!i.validated){if(!this._validator)this._validator=new ug;this._validator.validate(i)}if(i.chunks)t.chunks.copy(i.chunks);for(var n in i){var r=sg[n];var s=i[n];if(r==="vec2")t[n]=new he(s[0],s[1]);else if(r==="rgb")t[n]=new ge(s[0],s[1],s[2]);else if(r==="texture"){if(s instanceof bu)t[n]=s;else if(!(t[n]instanceof bu&&typeof s==="number"&&s>0))t[n]=null}else if(r==="cubemap"){if(s instanceof bu)t[n]=s;else if(!(t[n]instanceof bu&&typeof s==="number"&&s>0))t[n]=null}else if(r==="boundingbox"){var a=new ce(s.center[0],s.center[1],s.center[2]);var o=new ce(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2]);t[n]=new Ce(a,o)}else t[n]=i[n]}t.update()};t.migrate=function e(t){if(t.shadingModel===undefined)if(t.shader==="blinn")t.shadingModel=xh;else t.shadingModel=bh;if(t.shader)delete t.shader;if(t.mapping_format){t.mappingFormat=t.mapping_format;delete t.mapping_format}var i;var n=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(i=0;i<n.length;i++){var r=n[i][0];var s=n[i][1];if(t[r]!==undefined&&!(t[s]!==undefined)){t[s]=t[r];delete t[r]}}var a=["fresnelFactor","shadowSampleType"];for(i=0;i<a.length;i++){var o=a[i];if(t.hasOwnProperty(o))delete t[o]}return t};t._validate=function e(t){if(!this._validator)this._validator=new ug;this._validator.validate(t);return t};return e}(),dg={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},pg=function(){function e(e){this._assets=e.assets;this._device=e.graphicsDevice;this._placeholderTextures=null;this._parser=new fg;this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e){if(n){t._engine=true;n(null,t)}}else if(n)n("Error loading material: "+i.original+" ["+e+"]")})};t.open=function e(t,i){var n=this._parser.parse(i);if(i._engine){n._data=i;delete i._engine}return n};t._createPlaceholders=function e(){this._placeholderTextures={};var t={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(var i in t){if(!t.hasOwnProperty(i))continue;this._placeholderTextures[i]=new bu(this._device,{width:2,height:2,format:Kt});this._placeholderTextures[i].name="placeholder";var n=this._placeholderTextures[i].lock();for(var r=0;r<4;r++)for(var s=0;s<4;s++)n[r*4+s]=t[i][s];this._placeholderTextures[i].unlock()}};t.patch=function e(t,i){if(t.resource._data){t._data=t.resource._data;delete t.resource._data}t.data.name=t.name;t.resource.name=t.name;this._bindAndAssignAssets(t,i);t.off("unload",this._onAssetUnload,this);t.on("unload",this._onAssetUnload,this)};t._onAssetUnload=function e(t){delete t.data.parameters;delete t.data.chunks;delete t.data.name};t._assignTexture=function e(t,i,n){i.data[t]=n;i.resource[t]=n};t._assignPlaceholderTexture=function e(t,i){if(!this._placeholderTextures)this._createPlaceholders();var n=dg[t];var r=this._placeholderTextures[n];i.resource[t]=r};t._onTextureLoad=function e(t,i,n){this._assignTexture(t,i,n.resource);i.resource.update()};t._onTextureAdd=function e(t,i,n){this._assets.load(n)};t._onTextureRemove=function e(t,i,n){var r=i.resource;if(r)if(r[t]===n.resource){this._assignTexture(t,i,null);r.update()}};t._assignCubemap=function e(t,i,n){i.data[t]=n[0];if(n.length===7){i.data.prefilteredCubeMap128=n[1];i.data.prefilteredCubeMap64=n[2];i.data.prefilteredCubeMap32=n[3];i.data.prefilteredCubeMap16=n[4];i.data.prefilteredCubeMap8=n[5];i.data.prefilteredCubeMap4=n[6]}};t._onCubemapLoad=function e(t,i,n){this._assignCubemap(t,i,n.resources);this._parser.initialize(i.resource,i.data)};t._onCubemapAdd=function e(t,i,n){if(i.data.shadingModel===bh)i.loadFaces=true;this._assets.load(n)};t._onCubemapRemove=function e(t,i,n){var r=i.resource;if(r[t]===n.resource){this._assignCubemap(t,i,[null,null,null,null,null,null,null]);r.update()}};t._bindAndAssignAssets=function e(t,i){var n=this._parser.migrate(t.data);var r=t.resource;var s=n.mappingFormat==="path";var a=lg;var o,l,h;for(o=0;o<a.length;o++){l=a[o];h=r._assetReferences[l];if(n[l]&&!(n[l]instanceof bu)){if(!h){h=new cg(l,t,i,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this);r._assetReferences[l]=h}if(s)h.url=t.getAbsoluteUrl(n[l]);else h.id=n[l];if(h.asset){if(h.asset.resource)this._assignTexture(l,t,h.asset.resource);else this._assignPlaceholderTexture(l,t);i.load(h.asset)}}else if(h)if(s)h.url=null;else h.id=null}var c=hg;for(o=0;o<c.length;o++){l=c[o];h=r._assetReferences[l];if(n[l]&&!(n[l]instanceof bu)){if(!h){h=new cg(l,t,i,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this);r._assetReferences[l]=h}if(s)h.url=n[l];else h.id=n[l];if(h.asset){if(h.asset.loaded)this._assignCubemap(l,t,h.asset.resources);i.load(h.asset)}}}this._parser.initialize(r,n)};return e}(),mg=function(){function e(e){this._device=e}var t=e.prototype;t.parse=function e(t){var i=xv.parse("filename.glb",t,this._device);if(!i)return null;return xv.createModel(i,Cu.defaultMaterial)};return e}(),_g=function e(){this.index=0;this.boneIndices=[0,0,0,0]},vg=function(){function e(){this.partition=0;this.vertexStart=0;this.vertexCount=0;this.indexStart=0;this.indexCount=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}var t=e.prototype;t.addVertex=function e(t,i,n){var r=-1;if(this.indexMap[i]!==undefined){r=this.indexMap[i];this.indices.push(r)}else{for(var s=0;s<4;s++){if(n.blendWeight.data[i*4+s]===0)continue;var a=n.blendIndices.data[t.index*4+s];t.boneIndices[s]=this.getBoneRemap(a)}r=this.vertices.length;this.indices.push(r);this.vertices.push(t);this.indexMap[i]=r}};t.addPrimitive=function e(t,i,n,r){var s,a;var o=[];var l=0;var h=t.length;for(s=0;s<h;s++){var c=t[s];var u=c.index;for(var f=0;f<4;f++)if(n.blendWeight.data[u*4+f]>0){var d=n.blendIndices.data[u*4+f];var p=true;for(a=0;a<l;a++)if(o[a]==d){p=false;break}if(p){o[l]=d;var m=this.getBoneRemap(d);l+=m===-1?1:0}}}if(this.boneIndices.length+l>r)return false;for(s=0;s<l;s++)this.boneIndices.push(o[s]);for(s=0;s<h;s++)this.addVertex(t[s],i[s],n);return true};t.getBoneRemap=function e(t){for(var i=0;i<this.boneIndices.length;i++)if(this.boneIndices[i]===t)return i;return-1};return e}();function gg(e){var t;var i=e.vertices;var n=e.skins;var r=e.meshes;var s=e.meshInstances;for(t=0;t<r.length;t++){r[t].vertices=i[r[t].vertices];if(r[t].skin!==undefined)r[t].skin=n[r[t].skin]}for(t=0;t<s.length;t++)s[t].mesh=r[s[t].mesh]}function yg(e){var t;var i=e.vertices;var n=e.skins;var r=e.meshes;var s=e.meshInstances;for(t=0;t<r.length;t++){r[t].vertices=i.indexOf(r[t].vertices);if(r[t].skin!==undefined)r[t].skin=n.indexOf(r[t].skin)}for(t=0;t<s.length;t++)s[t].mesh=r.indexOf(s[t].mesh)}function bg(e,t,i){var n,r,s,a;gg(e);var o=e.vertices;var l=e.skins;var h;var c=e.meshes;var u=e.meshInstances;var f=function e(t){var i=new _g;i.index=t;return i};for(n=l.length-1;n>=0;n--)if(l[n].boneNames.length>i){var d=l.splice(n,1)[0];var p=[];for(r=0;r<c.length;r++)if(c[r].skin===d)p.push(c[r]);for(r=0;r<p.length;r++){a=c.indexOf(p[r]);if(a!==-1)c.splice(a,1)}if(p.length===0)throw new Error("partitionSkin: There should be at least one mesh that references a skin");var m=p[0].vertices;for(r=1;r<p.length;r++)if(p[r].vertices!==m)throw new Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var _;var v=[];var g=[];var y=[];var b=0;for(r=0;r<p.length;r++){h=p[r];var x=h.indices;for(var S=h.base;S<h.base+h.count;){a=x[S++];g[0]=f(a);y[0]=a;a=x[S++];g[1]=f(a);y[1]=a;a=x[S++];g[2]=f(a);y[2]=a;var w=false;for(var T=b;T<v.length;T++){_=v[T];if(_.addPrimitive(g,y,m,i)){w=true;break}}if(!w){_=new vg;_.originalMesh=h;_.addPrimitive(g,y,m,i);v.push(_)}}b=v.length}var M=[];var C=[];for(r=0;r<v.length;r++){_=v[r];if(_.vertices.length&&_.indices.length){var A=M.length;var P=_.vertices.length;var E=C.length;var I=_.indices.length;_.partition=r;_.vertexStart=A;_.vertexCount=P;_.indexStart=E;_.indexCount=I;var R;var L;R=0;L=A;while(R<P)M[L++]=_.vertices[R++];R=0;L=E;while(R<I)C[L++]=_.indices[R++]+A}}var D=[];for(r=0;r<v.length;r++){_=v[r];var k=[];var O=[];for(s=0;s<_.boneIndices.length;s++){k.push(d.inverseBindMatrices[_.boneIndices[s]]);O.push(d.boneNames[_.boneIndices[s]])}var F={inverseBindMatrices:k,boneNames:O};D.push(F);l.push(F)}var B,N,z,V;var U={};for(N in m)U[N]={components:m[N].components,data:[],type:m[N].type};for(N in m)if(N==="blendIndices"){var G=U[N].data;for(r=0;r<M.length;r++){var H=M[r].boneIndices;G.push(H[0],H[1],H[2],H[3])}}else{B=m[N];z=B.data;V=B.components;for(r=0;r<M.length;r++){a=M[r].index;for(s=0;s<V;s++)U[N].data.push(z[a*V+s])}}o[o.indexOf(m)]=U;for(r=0;r<v.length;r++){_=v[r];h={aabb:{min:[0,0,0],max:[0,0,0]},vertices:U,skin:D[r],indices:C.splice(0,_.indexCount),type:"triangles",base:0,count:_.indexCount};c.push(h);for(s=u.length-1;s>=0;s--)if(u[s].mesh===_.originalMesh){u.push({mesh:h,node:u[s].node});if(t)t.push({material:t[s].material,path:t[s].path})}}for(r=0;r<v.length;r++){_=v[r];for(s=u.length-1;s>=0;s--)if(u[s].mesh===_.originalMesh){u.splice(s,1);if(t)t.splice(s,1)}}}yg(e)}var xg={points:yi,lines:bi,lineloop:xi,linestrip:Si,triangles:wi,trianglestrip:Ti,trianglefan:Mi},Sg={int8:Tn,uint8:Mn,int16:Cn,uint16:An,int32:Pn,uint32:En,float32:In},wg=function(){function e(e){this._device=e}var t=e.prototype;t.parse=function e(t){var i=t.model;if(!i)return null;if(i.version<=1)return null;var n=this._parseNodes(t);var r=this._parseSkins(t,n);var s=this._parseVertexBuffers(t);var a=this._parseIndexBuffers(t,s);var o=this._parseMorphs(t,n,s);var l=this._parseMeshes(t,r.skins,o.morphs,s,a.buffer,a.data);var h=this._parseMeshInstances(t,n,l,r.skins,r.instances,o.morphs,o.instances);var c=new Xu;c.graph=n[0];c.meshInstances=h;c.skinInstances=r.instances;c.morphInstances=o.instances;c.getGraph().syncHierarchy();return c};t._parseNodes=function e(t){var i=t.model;var n=[];var r;for(r=0;r<i.nodes.length;r++){var s=i.nodes[r];var a=new Mf(s.name);a.setLocalPosition(s.position[0],s.position[1],s.position[2]);a.setLocalEulerAngles(s.rotation[0],s.rotation[1],s.rotation[2]);a.setLocalScale(s.scale[0],s.scale[1],s.scale[2]);a.scaleCompensation=!!s.scaleCompensation;n.push(a)}for(r=1;r<i.parents.length;r++)n[i.parents[r]].addChild(n[r]);return n};t._parseSkins=function e(t,i){var n=t.model;var r=[];var s=[];var a,o;if(!this._device.supportsBoneTextures&&n.skins.length>0){var l=this._device.getBoneLimit();bg(n,null,l)}for(a=0;a<n.skins.length;a++){var h=n.skins[a];var c=[];for(o=0;o<h.inverseBindMatrices.length;o++){var u=h.inverseBindMatrices[o];c[o]=(new ve).set(u)}var f=new $m(this._device,c,h.boneNames);r.push(f);var d=new ju(f);var p=[];for(o=0;o<f.boneNames.length;o++){var m=f.boneNames[o];var _=i[0].findByName(m);p.push(_)}d.bones=p;s.push(d)}return{skins:r,instances:s}};t._getMorphVertexCount=function e(t,i,n){for(var r=0;r<t.meshes.length;r++){var s=t.meshes[r];if(s.morph===i){var a=n[s.vertices];return a.numVertices}}return undefined};t._parseMorphs=function e(t,i,n){var r=t.model;var s=[];var a=[];var o,l,h;var c,u,f;if(r.morphs){var d=function e(t,i,n){var r=new Float32Array(n*3);for(var s=0;s<i.length;s++){var a=i[s]*3;r[a]=t[s*3];r[a+1]=t[s*3+1];r[a+2]=t[s*3+2]}return r};for(o=0;o<r.morphs.length;o++){c=r.morphs[o].targets;f=[];h=this._getMorphVertexCount(r,o,n);for(l=0;l<c.length;l++){var p=c[l].aabb;var m=p.min;var _=p.max;var v=new Ce(new ce((_[0]+m[0])*.5,(_[1]+m[1])*.5,(_[2]+m[2])*.5),new ce((_[0]-m[0])*.5,(_[1]-m[1])*.5,(_[2]-m[2])*.5));var g=c[l].indices;var y=c[l].deltaPositions;var b=c[l].deltaNormals;if(g){y=d(y,g,h);b=d(b,g,h)}u=new Qm({deltaPositions:y,deltaNormals:b,name:c[l].name,aabb:v});f.push(u)}var x=new Uu(f,this._device);s.push(x);var S=new Hu(x);a.push(S)}}return{morphs:s,instances:a}};t._parseVertexBuffers=function e(t){var i=t.model;var n=[];var r,s;var a={position:Ci,normal:Ai,tangent:Pi,blendWeight:Ei,blendIndices:Ii,color:Ri,texCoord0:Di,texCoord1:ki,texCoord2:Oi,texCoord3:Fi,texCoord4:Bi,texCoord5:Ni,texCoord6:zi,texCoord7:Vi};var o,l;for(o=0;o<i.vertices.length;o++){var h=i.vertices[o];var c=[];for(s in h){r=h[s];c.push({semantic:a[s],components:r.components,type:Sg[r.type],normalize:a[s]===Ri})}var u=new cr(this._device,c);var f=h.position.data.length/h.position.components;var d=new lr(this._device,u,f);var p=new Tr(d);for(l=0;l<f;l++){for(s in h){r=h[s];switch(r.components){case 1:p.element[a[s]].set(r.data[l]);break;case 2:p.element[a[s]].set(r.data[l*2],r.data[l*2+1]);break;case 3:p.element[a[s]].set(r.data[l*3],r.data[l*3+1],r.data[l*3+2]);break;case 4:p.element[a[s]].set(r.data[l*4],r.data[l*4+1],r.data[l*4+2],r.data[l*4+3]);break}}p.next()}p.end();n.push(d)}return n};t._parseIndexBuffers=function e(t,i){var n=t.model;var r=null;var s=null;var a;var o=0;for(a=0;a<n.meshes.length;a++){var l=n.meshes[a];if(l.indices!==undefined)o+=l.indices.length}var h=0;for(a=0;a<i.length;a++)h=Math.max(h,i[a].numVertices);if(o>0)if(h>65535&&this._device.extUintElement){r=new Eu(this._device,Ut,o);s=new Uint32Array(r.lock())}else{r=new Eu(this._device,Vt,o);s=new Uint16Array(r.lock())}return{buffer:r,data:s}};t._parseMeshes=function e(t,i,n,r,s,a){var o=t.model;var l=[];var h=0;var c;for(c=0;c<o.meshes.length;c++){var u=o.meshes[c];var f=u.aabb;var d=f.min;var p=f.max;var m=new Ce(new ce((p[0]+d[0])*.5,(p[1]+d[1])*.5,(p[2]+d[2])*.5),new ce((p[0]-d[0])*.5,(p[1]-d[1])*.5,(p[2]-d[2])*.5));var _=u.indices!==undefined;var v=new Du(this._device);v.vertexBuffer=r[u.vertices];v.indexBuffer[0]=_?s:null;v.primitive[0].type=xg[u.type];v.primitive[0].base=_?u.base+h:u.base;v.primitive[0].count=u.count;v.primitive[0].indexed=_;v.skin=u.skin!==undefined?i[u.skin]:null;v.morph=u.morph!==undefined?n[u.morph]:null;v.aabb=m;if(_){a.set(u.indices,h);h+=u.indices.length}l.push(v)}if(s!==null)s.unlock();return l};t._parseMeshInstances=function e(t,i,n,r,s,a,o){var l=t.model;var h=[];var c;for(c=0;c<l.meshInstances.length;c++){var u=l.meshInstances[c];var f=i[u.node];var d=n[u.mesh];var p=new zu(f,d,Cu.defaultMaterial);if(d.skin){var m=r.indexOf(d.skin);p.skinInstance=s[m]}if(d.morph){var _=a.indexOf(d.morph);p.morphInstance=o[_]}h.push(p)}return h};return e}(),Tg=function(){function e(e,t){this._device=e;this._parsers=[];this._defaultMaterial=t;this.maxRetries=0;this.addParser(new wg(this._device),function(e,t){return p.getExtension(e)===".json"});this.addParser(new mg(this._device),function(e,t){return p.getExtension(e)===".glb"})}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var t={retry:this.maxRetries>0,maxRetries:this.maxRetries};if(i.load.startsWith("blob:")||i.load.startsWith("data:"))if(p.getExtension(i.original).toLowerCase()===".glb")t.responseType=$.ResponseType.ARRAY_BUFFER;else t.responseType=$.ResponseType.JSON;Z.get(i.load,t,function(e,t){if(!n)return;if(!e)n(null,t);else n("Error loading model: "+i.original+" ["+e+"]")})};t.open=function e(t,i){for(var n=0;n<this._parsers.length;n++){var r=this._parsers[n];if(r.decider(t,i))return r.parser.parse(i)}return null};t.patch=function e(o,l){if(!o.resource)return;var h=o.data;var c=this;o.resource.meshInstances.forEach(function(i,e){if(h.mapping){var t=function e(t){if(t.resource)i.material=t.resource;else{t.once("load",e);l.load(t)}t.once("remove",function(e){if(i.material===e.resource)i.material=c._defaultMaterial})};if(!h.mapping[e]){i.material=c._defaultMaterial;return}var n=h.mapping[e].material;var r=h.mapping[e].path;var s;if(n!==undefined)if(!n)i.material=c._defaultMaterial;else{s=l.get(n);if(s)t(s);else l.once("add:"+n,t)}else if(r){var a=o.getAbsoluteUrl(h.mapping[e].path);s=l.getByUrl(a);if(s)t(s);else l.once("add:url:"+a,t)}}})};t.addParser=function e(t,i){this._parsers.push({parser:t,decider:i})};return e}(),Mg=function(t){G(e,t);function e(){var e;e=t.call(this)||this;e._meshes=null;return e}U(e,[{key:"meshes",get:function e(){return this._meshes},set:function e(t){this._meshes=t;this.fire("set:meshes",t)}}]);return e}(u);function Cg(e){var t=this;if(!t.resource)return;var i=e.resource;var n=i.renders&&i.renders[t.data.renderIndex];if(n)t.resource.meshes=n.resource}function Ag(e){var t=this;t.registry.off("load:"+e.id,Cg,t);t.registry.on("load:"+e.id,Cg,t);t.registry.off("remove:"+e.id,Pg,t);t.registry.once("remove:"+e.id,Pg,t);if(!e.resource)t.registry.load(e);else Cg.call(t,e)}function Pg(e){var t=this;t.registry.off("load:"+e.id,Cg,t);if(t.resource)t.resource.meshes=null}var Eg=function(){function e(e){this._registry=e}var t=e.prototype;t.load=function e(t,i,n){};t.open=function e(t,i){return new Mg};t.patch=function e(t,i){if(!t.data.containerAsset)return;var n=i.get(t.data.containerAsset);if(!n){i.once("add:"+t.data.containerAsset,Ag,t);return}Ag.call(t,n)};return e}(),Ig=function(){function e(e){this._handlers={};this._requests={};this._cache={};this._app=e}var t=e.prototype;t.addHandler=function e(t,i){this._handlers[t]=i;i._loader=this};t.removeHandler=function e(t){delete this._handlers[t]};t.getHandler=function e(t){return this._handlers[t]};t.load=function e(t,i,n,r){var s=this._handlers[i];if(!s){var a="No handler for asset type: "+i;n(a);return}if(!t){this._loadNull(s,n,r);return}var o=t+i;if(this._cache[o]!==undefined)n(null,this._cache[o]);else if(this._requests[o])this._requests[o].push(n);else{this._requests[o]=[n];var l=this;var h=function e(t,n){if(t){l._onFailure(o,t);return}s.load(n,function(e,t,i){if(!l._requests[o])return;if(e){l._onFailure(o,e);return}try{l._onSuccess(o,s.open(n.original,t,r),i)}catch(e){l._onFailure(o,e)}},r)};var c=t.split("?")[0];if(this._app.enableBundles&&this._app.bundles.hasUrl(c)){if(!this._app.bundles.canLoadUrl(c)){h("Bundle for "+t+" not loaded yet");return}this._app.bundles.loadUrl(c,function(e,t){h(e,{load:t,original:c})})}else h(null,{load:t,original:r&&r.getPreferredFile().filename||t})}};t._loadNull=function e(r,s,a){var t=function e(t,i,n){if(t)s(t);else try{s(null,r.open(null,i,a),n)}catch(e){s(e)}};r.load(null,t,a)};t._onSuccess=function e(t,i,n){this._cache[t]=i;for(var r=0;r<this._requests[t].length;r++)this._requests[t][r](null,i,n);delete this._requests[t]};t._onFailure=function e(t,i){console.error(i);if(this._requests[t]){for(var n=0;n<this._requests[t].length;n++)this._requests[t][n](i);delete this._requests[t]}};t.open=function e(t,i){var n=this._handlers[t];if(!n){console.warn("No resource handler found for: "+t);return i}return n.open(null,i)};t.patch=function e(t,i){var n=this._handlers[t.type];if(!n){console.warn("No resource handler found for: "+t.type);return}if(n.patch)n.patch(t,i)};t.clearCache=function e(t,i){delete this._cache[t+i]};t.getFromCache=function e(t,i){if(this._cache[t+i])return this._cache[t+i]};t.enableRetry=function e(t){if(t===void 0)t=5;t=Math.max(0,t)||0;for(var i in this._handlers)this._handlers[i].maxRetries=t};t.disableRetry=function e(){for(var t in this._handlers)this._handlers[t].maxRetries=0};t.destroy=function e(){this._handlers={};this._requests={};this._cache={}};return e}(),Rg=function(){function e(e){this._app=e;this.maxRetries=0}var t=e.prototype;t.load=function e(n,r){if(typeof n==="string")n={load:n,original:n};var s=this._app.assets;Z.get(n.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)Zv.waitForTemplatesInScene(t,s,r);else{var i="Error while loading scene "+n.original;if(e.message){i+=": "+e.message;if(e.stack)i+="\n"+e.stack}else i+=": "+e;r(i)}})};t.open=function e(t,i){this._app.systems.script.preloading=true;var n=new tg(this._app,false);var r=n.parse(i);var s=this._app.scene;s.root=r;this._app.applySceneSettings(i.settings);this._app.systems.script.preloading=false;return s};t.patch=function e(t,i){};return e}(),Lg=function(){function e(e){this._app=e;this.maxRetries=0}var t=e.prototype;t.load=function e(n,r){if(typeof n==="string")n={load:n,original:n};Z.get(n.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)r(null,t);else{var i="Error while loading scene settings "+n.original;if(e.message){i+=": "+e.message;if(e.stack)i+="\n"+e.stack}else i+=": "+e;r(i)}})};t.open=function e(t,i){return i.settings};return e}(),Dg=false,kg=false,Og={app:null,create:function e(t,i){if(!Dg)return;var n=i(Og.app);n._pcScriptName=t;Fg._push(n);this.fire("created",t,i)},attribute:function e(t,i,n,r){},createLoadingScreen:function e(t){if(kg)return;kg=true;var i=rM.getApplication();t(i)}};Object.defineProperty(Og,"legacy",{get:function e(){return Dg},set:function e(t){Dg=t}}),f.attach(Og);var Fg=function(){function l(e){this._app=e;this._scripts={};this._cache={}}l._push=function e(t){if(Og.legacy&&l._types.length>0)console.assert("Script Ordering Error. Contact support@playcanvas.com");else l._types.push(t)};var e=l.prototype;e.load=function e(t,a){if(typeof t==="string")t={load:t,original:t};var o=this;Og.app=this._app;this._loadScript(t.load,function(e,t,i){if(!e)if(Og.legacy){var n=null;if(l._types.length)n=l._types.pop();if(n)this._scripts[t]=n;else n=null;a(null,n,i)}else{var r={};for(var s=0;s<l._types.length;s++)r[l._types[s].name]=l._types[s];l._types.length=0;a(null,r,i);delete o._loader._cache[t+"script"]}else a(e)}.bind(this))};e.open=function e(t,i){return i};e.patch=function e(t,i){};e._loadScript=function e(t,i){var n=document.head;var r=document.createElement("script");this._cache[t]=r;r.async=false;r.addEventListener("error",function(e){i("Script: "+e.target.src+" failed to load")},false);var s=false;r.onload=r.onreadystatechange=function(){if(!s&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){s=true;i(null,t,r)}};r.src=t;n.appendChild(r)};return l}();Fg._types=[];var Bg=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)n(null,t);else n("Error loading shader resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}(),Ng=[0,0,1,0,0,1,0,0,1,0,0,1],zg=[0,1,3,2,3,1],Vg=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;i._device=e;i._pixelsPerUnit=t&&t.pixelsPerUnit!==undefined?t.pixelsPerUnit:1;i._renderMode=t&&t.renderMode!==undefined?t.renderMode:_c;i._atlas=t&&t.atlas!==undefined?t.atlas:null;i._frameKeys=t&&t.frameKeys!==undefined?t.frameKeys:null;i._meshes=[];i._updatingProperties=false;i._meshesDirty=false;if(i._atlas&&i._frameKeys)i._createMeshes();return i}var t=e.prototype;t._createMeshes=function e(){var t,i;for(t=0,i=this._meshes.length;t<i;t++){var n=this._meshes[t];if(n)n.destroy()}var r=this._frameKeys.length;this._meshes=new Array(r);var s=this.renderMode===vc||this._renderMode===gc?this._create9SliceMesh:this._createSimpleMesh;for(t=0;t<r;t++){var a=this._atlas.frames[this._frameKeys[t]];this._meshes[t]=a?s.call(this,a):null}this.fire("set:meshes")};t._createSimpleMesh=function e(t){var i=t.rect;var n=this._atlas.texture.width;var r=this._atlas.texture.height;var s=i.z/this._pixelsPerUnit;var a=i.w/this._pixelsPerUnit;var o=t.pivot.x;var l=t.pivot.y;var h=[-o*s,-l*a,0,(1-o)*s,-l*a,0,(1-o)*s,(1-l)*a,0,-o*s,(1-l)*a,0];var c=i.x/n;var u=i.y/r;var f=(i.x+i.z)/n;var d=(i.y+i.w)/r;var p=[c,u,f,u,f,d,c,d];var m=Tm(this._device,h,{uvs:p,normals:Ng,indices:zg});return m};t._create9SliceMesh=function e(){var t=he.ONE;var i=3;var n=3;var r,s;var a,o,l,h,c;var u=[];var f=[];var d=[];var p=[];var m=0;for(r=0;r<=i;r++){h=r===0||r===i?0:1;for(s=0;s<=n;s++){a=-t.x+2*t.x*(r<=1?0:3)/i;o=0;l=-(-t.y+2*t.y*(s<=1?0:3)/n);c=s===0||s===n?0:1;u.push(-a,o,l);f.push(0,1,0);d.push(h,c);if(r<i&&s<n){p.push(m+n+1,m+1,m);p.push(m+n+1,m+n+2,m+1)}m++}}var _={normals:f,uvs:d,indices:p};return Tm(this._device,u,_)};t._onSetFrames=function e(t){if(this._updatingProperties)this._meshesDirty=true;else this._createMeshes()};t._onFrameChanged=function e(t,i){var n=this._frameKeys.indexOf(t);if(n<0)return;if(i){if(this.renderMode===_c)this._meshes[n]=this._createSimpleMesh(i)}else this._meshes[n]=null;this.fire("set:meshes")};t._onFrameRemoved=function e(t){var i=this._frameKeys.indexOf(t);if(i<0)return;this._meshes[i]=null;this.fire("set:meshes")};t.startUpdate=function e(){this._updatingProperties=true;this._meshesDirty=false};t.endUpdate=function e(){this._updatingProperties=false;if(this._meshesDirty&&this._atlas&&this._frameKeys)this._createMeshes();this._meshesDirty=false};t.destroy=function e(){for(var t=X(this._meshes),i;!(i=t()).done;){var n=i.value;if(n)n.destroy()}this._meshes.length=0};U(e,[{key:"frameKeys",get:function e(){return this._frameKeys},set:function e(t){this._frameKeys=t;if(this._atlas&&this._frameKeys)if(this._updatingProperties)this._meshesDirty=true;else this._createMeshes();this.fire("set:frameKeys",t)}},{key:"atlas",get:function e(){return this._atlas},set:function e(t){if(t===this._atlas)return;if(this._atlas){this._atlas.off("set:frames",this._onSetFrames,this);this._atlas.off("set:frame",this._onFrameChanged,this);this._atlas.off("remove:frame",this._onFrameRemoved,this)}this._atlas=t;if(this._atlas&&this._frameKeys){this._atlas.on("set:frames",this._onSetFrames,this);this._atlas.on("set:frame",this._onFrameChanged,this);this._atlas.on("remove:frame",this._onFrameRemoved,this);if(this._updatingProperties)this._meshesDirty=true;else this._createMeshes()}this.fire("set:atlas",t)}},{key:"pixelsPerUnit",get:function e(){return this._pixelsPerUnit},set:function e(t){if(this._pixelsPerUnit===t)return;this._pixelsPerUnit=t;this.fire("set:pixelsPerUnit",t);if(this._atlas&&this._frameKeys&&this.renderMode===_c)if(this._updatingProperties)this._meshesDirty=true;else this._createMeshes()}},{key:"renderMode",get:function e(){return this._renderMode},set:function e(t){if(this._renderMode===t)return;var i=this._renderMode;this._renderMode=t;this.fire("set:renderMode",t);if(i===_c||t===_c)if(this._atlas&&this._frameKeys)if(this._updatingProperties)this._meshesDirty=true;else this._createMeshes()}},{key:"meshes",get:function e(){return this._meshes}}]);return e}(u);function Ug(e){var t=this;if(t.resource)t.resource.atlas=e.resource}function Gg(e){var t=this;t.registry.load(e)}var Hg=function(){function e(e,t){this._assets=e;this._device=t;this.maxRetries=0}var t=e.prototype;t.load=function e(t,i){if(typeof t==="string")t={load:t,original:t};if(p.getExtension(t.original)===".json")Z.get(t.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)i(null,t);else i(e)})};t.open=function e(t,i){var n=new Vg(this._device);if(t)n.__data=i;return n};t.patch=function e(t,i){var n=t.resource;if(n.__data){t.data.pixelsPerUnit=n.__data.pixelsPerUnit;t.data.renderMode=n.__data.renderMode;t.data.frameKeys=n.__data.frameKeys;if(n.__data.textureAtlasAsset){var r=i.getByUrl(n.__data.textureAtlasAsset);if(r)t.data.textureAtlasAsset=r.id;else console.warn("Could not find textureatlas with url: "+n.__data.textureAtlasAsset)}}n.startUpdate();n.renderMode=t.data.renderMode;n.pixelsPerUnit=t.data.pixelsPerUnit;n.frameKeys=t.data.frameKeys;this._updateAtlas(t);n.endUpdate();t.off("change",this._onAssetChange,this);t.on("change",this._onAssetChange,this)};t._updateAtlas=function e(t){var i=t.resource;if(!t.data.textureAtlasAsset){i.atlas=null;return}this._assets.off("load:"+t.data.textureAtlasAsset,Ug,t);this._assets.on("load:"+t.data.textureAtlasAsset,Ug,t);var n=this._assets.get(t.data.textureAtlasAsset);if(n&&n.resource)i.atlas=n.resource;else if(!n){this._assets.off("add:"+t.data.textureAtlasAsset,Gg,t);this._assets.on("add:"+t.data.textureAtlasAsset,Gg,t)}else this._assets.load(n)};t._onAssetChange=function e(t,i,n,r){if(i==="data")if(n&&n.textureAtlasAsset&&r&&n.textureAtlasAsset!==r.textureAtlasAsset){this._assets.off("load:"+r.textureAtlasAsset,Ug,t);this._assets.off("add:"+r.textureAtlasAsset,Gg,t)}};return e}(),Wg=function(){function e(e,t){this._app=e;this._data=t;this._templateRoot=null}var t=e.prototype;t.instantiate=function e(){if(!this._templateRoot)this._parseTemplate();return this._templateRoot.clone()};t._parseTemplate=function e(){var t=new tg(this._app,true);this._templateRoot=t.parse(this._data)};return e}(),jg=function(){function e(e){this._app=e}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};var r=this._app.assets;Z.get(i.load,function(e,t){if(e)n("Error requesting template: "+i.original);else Zv.waitForTemplateAssets(t.entities,r,n,t)})};t.open=function e(t,i){return new Wg(this._app,i)};return e}(),Xg=function(){function e(){this.maxRetries=0}var t=e.prototype;t.load=function e(i,n){if(typeof i==="string")i={load:i,original:i};Z.get(i.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,t){if(!e)n(null,t);else n("Error loading text resource: "+i.original+" ["+e+"]")})};t.open=function e(t,i){return i};t.patch=function e(t,i){};return e}(),qg=function(t){G(e,t);function e(){var e;e=t.call(this)||this;e._texture=null;e._frames=null;return e}var i=e.prototype;i.setFrame=function e(t,i){var n=this._frames[t];if(!n){n={rect:i.rect.clone(),pivot:i.pivot.clone(),border:i.border.clone()};this._frames[t]=n}else{n.rect.copy(i.rect);n.pivot.copy(i.pivot);n.border.copy(i.border)}this.fire("set:frame",t.toString(),n)};i.removeFrame=function e(t){var i=this._frames[t];if(i){delete this._frames[t];this.fire("remove:frame",t.toString(),i)}};i.destroy=function e(){if(this._texture)this._texture.destroy()};U(e,[{key:"texture",get:function e(){return this._texture},set:function e(t){this._texture=t;this.fire("set:texture",t)}},{key:"frames",get:function e(){return this._frames},set:function e(t){this._frames=t;this.fire("set:frames",t)}}]);return e}(u),Yg={repeat:He,clamp:We,mirror:je},Kg={nearest:Mt,linear:Ct,nearest_mip_nearest:At,linear_mip_nearest:Et,nearest_mip_linear:Pt,linear_mip_linear:It},Qg=/^data\.frames\.(\d+)$/,$g=function(){function e(e){this._loader=e;this.maxRetries=0}var t=e.prototype;t.load=function e(n,r){if(typeof n==="string")n={load:n,original:n};var s=this;var t=this._loader.getHandler("texture");if(p.getExtension(n.original)===".json")Z.get(n.load,{retry:this.maxRetries>0,maxRetries:this.maxRetries},function(e,i){if(!e){var t=n.original.replace(".json",".png");s._loader.load(t,"texture",function(e,t){if(e)r(e);else r(null,{data:i,texture:t})})}else r(e)});else return t.load(n,r)};t.open=function e(t,i){var n=new qg;if(i.texture&&i.data){n.texture=i.texture;n.__data=i.data}else{var r=this._loader.getHandler("texture");var s=r.open(t,i);if(!s)return null;n.texture=s}return n};t.patch=function e(t,i){if(t.resource.__data){if(t.resource.__data.minfilter!==undefined)t.data.minfilter=t.resource.__data.minfilter;if(t.resource.__data.magfilter!==undefined)t.data.magfilter=t.resource.__data.magfilter;if(t.resource.__data.addressu!==undefined)t.data.addressu=t.resource.__data.addressu;if(t.resource.__data.addressv!==undefined)t.data.addressv=t.resource.__data.addressv;if(t.resource.__data.mipmaps!==undefined)t.data.mipmaps=t.resource.__data.mipmaps;if(t.resource.__data.anisotropy!==undefined)t.data.anisotropy=t.resource.__data.anisotropy;if(t.resource.__data.rgbm!==undefined)t.data.rgbm=!!t.resource.__data.rgbm;t.data.frames=t.resource.__data.frames;delete t.resource.__data}var n=t.resource.texture;if(n){n.name=t.name;if(t.data.hasOwnProperty("minfilter")&&n.minFilter!==Kg[t.data.minfilter])n.minFilter=Kg[t.data.minfilter];if(t.data.hasOwnProperty("magfilter")&&n.magFilter!==Kg[t.data.magfilter])n.magFilter=Kg[t.data.magfilter];if(t.data.hasOwnProperty("addressu")&&n.addressU!==Yg[t.data.addressu])n.addressU=Yg[t.data.addressu];if(t.data.hasOwnProperty("addressv")&&n.addressV!==Yg[t.data.addressv])n.addressV=Yg[t.data.addressv];if(t.data.hasOwnProperty("mipmaps")&&n.mipmaps!==t.data.mipmaps)n.mipmaps=t.data.mipmaps;if(t.data.hasOwnProperty("anisotropy")&&n.anisotropy!==t.data.anisotropy)n.anisotropy=t.data.anisotropy;if(t.data.hasOwnProperty("rgbm")){var r=t.data.rgbm?vn:_n;if(n.type!==r)n.type=r}}t.resource.texture=n;var s={};for(var a in t.data.frames){var o=t.data.frames[a];s[a]={rect:new ue(o.rect),pivot:new he(o.pivot),border:new ue(o.border)}}t.resource.frames=s;t.off("change",this._onAssetChange,this);t.on("change",this._onAssetChange,this)};t._onAssetChange=function e(t,i,n){var r;if(i==="data"||i==="data.frames"){var s={};for(var a in n.frames){r=n.frames[a];s[a]={rect:new ue(r.rect),pivot:new he(r.pivot),border:new ue(r.border)}}t.resource.frames=s}else{var o=i.match(Qg);if(o){var l=o[1];if(n){if(!t.resource.frames[l])t.resource.frames[l]={rect:new ue(n.rect),pivot:new he(n.pivot),border:new ue(n.border)};else{r=t.resource.frames[l];r.rect.set(n.rect[0],n.rect[1],n.rect[2],n.rect[3]);r.pivot.set(n.pivot[0],n.pivot[1]);r.border.set(n.border[0],n.border[1],n.border[2],n.border[3])}t.resource.fire("set:frame",l,t.resource.frames[l])}else if(t.resource.frames[l]){delete t.resource.frames[l];t.resource.fire("remove:frame",l)}}}};return e}();function Zg(){var b={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFRGBA4444:16};var x={astc:b.cTFASTC_4x4,dxt:b.cTFBC1,etc2:b.cTFETC1,etc1:b.cTFETC1,pvr:b.cTFPVRTC1_4_RGB,atc:b.cTFATC_RGB,none:b.cTFRGB565};var S={astc:b.cTFASTC_4x4,dxt:b.cTFBC3,etc2:b.cTFETC2,etc1:b.cTFRGBA4444,pvr:b.cTFPVRTC1_4_RGBA,atc:b.cTFATC_RGBA_INTERPOLATED_ALPHA,none:b.cTFRGBA4444};var w={};w[b.cTFETC1]=21;w[b.cTFETC2]=23;w[b.cTFBC1]=8;w[b.cTFBC3]=10;w[b.cTFPVRTC1_4_RGB]=26;w[b.cTFPVRTC1_4_RGBA]=27;w[b.cTFASTC_4x4]=28;w[b.cTFATC_RGB]=29;w[b.cTFATC_RGBA_INTERPOLATED_ALPHA]=30;w[b.cTFRGBA32]=7;w[b.cTFRGB565]=3;w[b.cTFRGBA4444]=5;var T=typeof performance!=="undefined";var M=function e(t){var i=function e(t,i){var n=t*(2/255)-1;var r=i*(2/255)-1;var s=Math.sqrt(1-Math.min(1,n*n+r*r));return Math.max(0,Math.min(255,Math.floor((s+1)*.5*255)))};for(var n=0;n<t.length;n+=4){var r=t[n+3];var s=t[n+1];t[n+0]=r;t[n+2]=i(r,s);t[n+3]=255}return t};var C=function e(t){var i=new Uint16Array(t.length/4);for(var n=0;n<t.length;n+=4){var r=t[n+0];var s=t[n+1];var a=t[n+2];i[n/4]=(r&248)<<8|(s&252)<<3|a>>3}return i};var a=function e(t,i,n,r,s){var a=T?performance.now():0;var o=new t.BasisFile(new Uint8Array(r));var l=o.getImageWidth(0,0);var h=o.getImageHeight(0,0);var c=o.getNumImages();var u=o.getNumLevels(0);var f=!!o.getHasAlpha();if(!l||!h||!c||!u){o.close();o.delete();throw new Error("Invalid image dimensions url="+i+" width="+l+" height="+h+" images="+c+" levels="+u)}var d=f?S[n]:x[n];if(d===b.cTFPVRTC1_4_RGB||d===b.cTFPVRTC1_4_RGBA)if((l&l-1)!==0||l!==h)d=d===b.cTFPVRTC1_4_RGB?b.cTFRGB565:b.cTFRGBA32;if(s&&s.unswizzleGGGR)d=b.cTFRGBA32;if(!o.startTranscoding()){o.close();o.delete();throw new Error("Failed to start transcoding url="+i)}var p;var m=[];for(var _=0;_<u;++_){var v=o.getImageTranscodedSizeInBytes(0,_,d);var g=new Uint8Array(v);if(!o.transcodeImage(g,0,_,d,1,0)){o.close();o.delete();throw new Error("Failed to transcode image url="+i)}if(d===b.cTFRGB565||d===b.cTFRGBA4444){var y=new Uint16Array(v/2);for(p=0;p<v/2;++p)y[p]=g[p*2]+g[p*2+1]*256;g=y}m.push(g)}o.close();o.delete();if(s&&s.unswizzleGGGR){d=b.cTFRGB565;for(p=0;p<m.length;++p)m[p]=C(M(m[p]))}return{format:w[d],width:l+3&~3,height:h+3&~3,levels:m,cubemap:false,mipmaps:true,transcodeTime:T?performance.now()-a:0,url:i}};var o=null;var i=[];var r=function e(t,i,n,r){try{var s=a(o,t,i,n,r);s.levels=s.levels.map(function(e){return e.buffer});self.postMessage({url:t,data:s},s.levels)}catch(e){self.postMessage({url:t.toString(),err:e.toString()})}};var n=function e(n){var t=function e(t,i){WebAssembly.instantiate(n,t).then(function(e){i(e)});return{}};self.BASIS(n?{instantiateWasm:t}:null).then(function(e){o=e;o.initializeBasis();for(var t=0;t<i.length;++t)r(i[t].url,i[t].format,i[t].data,i[t].options);i=[]})};self.onmessage=function(e){var t=e.data;switch(t.type){case"init":n(t.module);break;case"transcode":if(o)r(t.url,t.format,t.data,t.options);else i.push(t);break}}}var Jg=function(){try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){var e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return false}();function ey(e){if(e.extCompressedTextureASTC)return"astc";else if(e.extCompressedTextureS3TC)return"dxt";else if(e.extCompressedTextureETC)return"etc2";else if(e.extCompressedTextureETC1)return"etc1";else if(e.extCompressedTexturePVRTC)return"pvr";else if(e.extCompressedTextureATC)return"atc";return"none"}var ty=false,iy=null,ny={},ry=null,sy=[],ay=null;function oy(){if(!ry)ry=ey(rM.getApplication().graphicsDevice);return ry}function ly(e){var t=e.data.url;var i=e.data.err;var n=e.data.data;var r=ny[t];if(!r){console.error("internal logical error encountered in basis transcoder");return}var s;if(i){for(s=0;s<r.length;++s)r[s](i);return}if(n.format===jt||n.format===qt)n.levels=n.levels.map(function(e){return new Uint16Array(e)});else n.levels=n.levels.map(function(e){return new Uint8Array(e)});for(s=0;s<r.length;++s)r[s](null,n);delete ny[t]}function hy(e,t,i,n){if(!ny.hasOwnProperty(e)){ny[e]=[i];iy.postMessage({type:"transcode",url:e,format:oy(),data:t,options:n},[t])}else ny[e].push(i)}function cy(e,t,i){var n=["/* basis.js */",e,"","/* worker */","("+Zg.toString()+")()\n\n"].join("\n");var r=new Blob([n],{type:"application/javascript"});var s=URL.createObjectURL(r);iy=new Worker(s);iy.addEventListener("message",ly);iy.postMessage({type:"init",module:t});if(i)i();for(var a=0;a<sy.length;++a){var o=sy[a];hy(o.url,o.data,o.callback,o.options)}}function uy(e,t,i,n){if(ty)console.warn("basis module is being downloaded more than once");ty=true;if(Jg){var r=null;var s=null;var a=function e(){if(r&&s)cy(r,s,n)};var o=function e(){Z.get(t,{cache:true,responseType:"arraybuffer",retry:false},function(e,t){if(t)WebAssembly.compile(t).then(function(e){s=e;a()})})};if(WebAssembly.compileStreaming)WebAssembly.compileStreaming(fetch(t)).then(function(e){s=e;a()}).catch(function(e){console.error(e);console.warn("compileStreaming() failed for "+t+", falling back to arraybuffer download...");o()});else o();Z.get(e,{cache:true,responseType:"text",retry:false},function(e,t){r=t;a()})}else Z.get(i,{cache:true,responseType:"text",retry:false},function(e,t){if(t)cy(t,null,n)})}function fy(e,t,i){ay={glueUrl:e,wasmUrl:t,fallbackUrl:i}}function dy(e){if(ay)uy(ay.glueUrl,ay.wasmUrl,ay.fallbackUrl,e);else{var t=(window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[];var i=t.find(function(e){return e.moduleName==="BASIS"});if(i){var n=window.ASSET_PREFIX?window.ASSET_PREFIX:"";uy(n+i.glueUrl,n+i.wasmUrl,n+i.fallbackUrl,e)}}}function py(e,t,i,n){if(!iy){sy.push({url:e,data:t,callback:i,options:n});if(!ty)dy()}else hy(e,t,i,n)}var my=function(){function e(e){this.maxRetries=0}var t=e.prototype;t.load=function e(n,r,s){var t={cache:true,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};Z.get(n.load,t,function(e,t){if(e)r(e,t);else{var i=oy()==="pvr"&&s&&s.file&&s.file.variants&&s.file.variants.basis&&(s.file.variants.basis.opt&8)!==0;if(i)s.file.variants.basis.opt&=~8;py(n.load,t,r,{unswizzleGGGR:i})}})};t.open=function e(t,i,n){var r=new bu(n,{name:t,addressU:i.cubemap?We:He,addressV:i.cubemap?We:He,width:i.width,height:i.height,format:i.format,cubemap:i.cubemap,levels:i.levels});r.upload();return r};return e}(),_y=function(){function e(e){this.crossOrigin=e.prefix?"anonymous":null;this.maxRetries=0;this.useImageBitmap=false}var t=e.prototype;t.load=function e(t,i,n){var r;if(n&&n.options&&n.options.hasOwnProperty("crossOrigin"))r=n.options.crossOrigin;else if(p_.test(t.load))r=this.crossOrigin;if(this.useImageBitmap)this._loadImageBitmap(t.load,t.original,r,i);else this._loadImage(t.load,t.original,r,i)};t.open=function e(t,i,n){var r=p.getExtension(t).toLowerCase();var s=r===".jpg"||r===".jpeg"?Yt:Kt;var a=new bu(n,{name:t,width:i.width,height:i.height,format:s});a.setSource(i);return a};t._loadImage=function e(n,r,t,s){var a=new Image;if(t)a.crossOrigin=t;var o=0;var l=this.maxRetries;var h;a.onload=function(){s(null,a)};a.onerror=function(){if(h)return;if(l>0&&++o<=l){var e=Math.pow(2,o)*100;console.log("Error loading Texture from: '"+r+"' - Retrying in "+e+"ms...");var t=n.indexOf("?");var i=t>=0?"&":"?";h=setTimeout(function(){a.src=n+i+"retry="+Date.now();h=null},e)}else s("Error loading Texture from: '"+r+"'")};a.src=n};t._loadImageBitmap=function e(t,i,n,r){var s={cache:true,responseType:"blob",retry:this.maxRetries>0,maxRetries:this.maxRetries};Z.get(t,s,function(e,t){if(e)r(e);else createImageBitmap(t,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(e){r(null,e)}).catch(function(e){r(e)})})};return e}(),vy=[1481919403,3140563232,169478669],gy={33776:Qt,33778:$t,33779:Zt,36196:hi,37492:ci,37496:ui,35840:pi,35841:fi,35842:mi,35843:di},yy=function(){function e(e){this.maxRetries=0}var t=e.prototype;t.load=function e(t,i,n){var r={cache:true,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};Z.get(t.load,r,i)};t.open=function e(t,i,n){var r=this.parse(i);if(!r)return null;var s=new bu(n,{name:t,addressU:r.cubemap?We:He,addressV:r.cubemap?We:He,width:r.width,height:r.height,format:r.format,cubemap:r.cubemap,levels:r.levels});s.upload();return s};t.parse=function e(t){var i=new Uint32Array(t,0,16);if(vy[0]!==i[0]||vy[1]!==i[1]||vy[2]!==i[2])return null;var n={endianness:i[3],glType:i[4],glTypeSize:i[5],glFormat:i[6],glInternalFormat:i[7],glBaseInternalFormat:i[8],pixelWidth:i[9],pixelHeight:i[10],pixelDepth:i[11],numberOfArrayElements:i[12],numberOfFaces:i[13],numberOfMipmapLevels:i[14],bytesOfKeyValueData:i[15]};if(n.pixelDepth>1)return null;if(n.numberOfArrayElements>1)return null;if(n.glFormat!==0)return null;if(!gy[n.glInternalFormat])return null;var r=16*4+n.bytesOfKeyValueData;var s=[];var a=false;for(var o=0;o<(n.numberOfMipmapLevels||1);o++){var l=new Uint32Array(t.slice(r,r+4))[0];r+=4;var h=l/(n.numberOfFaces||1);if(n.numberOfFaces>1){a=true;s.push([])}for(var c=0;c<n.numberOfFaces;c++){var u=new Uint8Array(t,r,h);if(n.numberOfFaces>1)s[o].push(u);else s.push(u);r+=h}r+=3-(r+3)%4}return{format:gy[n.glInternalFormat],width:n.pixelWidth,height:n.pixelHeight,levels:s,cubemap:a}};return e}(),by=function(){function e(e){this.maxRetries=0}var t=e.prototype;t.load=function e(t,i,n){var r={cache:true,responseType:"arraybuffer",retry:this.maxRetries>0,maxRetries:this.maxRetries};Z.get(t.load,r,i)};t.open=function e(t,i,n){var r=new Uint32Array(i,0,128/4);var s=r[4];var a=r[3];var o=Math.max(r[7],1);var l=r[20]===4;var h=r[21];var c=r[22];var u=r[28]===65024;var f=827611204;var d=894720068;var p=116;var m=826496069;var _=825438800;var v=825504336;var g=825439312;var y=825504848;var b=false;var x=false;var S=false;var w=false;var T=false;var M=null;var C;if(l){if(h===f){M=Qt;b=true}else if(h===d){M=Zt;b=true}else if(h===p){M=ii;x=true}else if(h===m){M=hi;b=true;S=true}else if(h===_||h===v){M=h===_?fi:di;b=true;w=true}else if(h===g||h===y){M=h===g?pi:mi;b=true;T=true}}else if(c===32)M=Kt;if(!M){C=new bu(n,{width:4,height:4,format:Yt});C.name="dds-legacy-empty";return C}C=new bu(n,{name:t,addressU:u?We:He,addressV:u?We:He,width:s,height:a,format:M,cubemap:u});var A=128;var P=u?6:1;var E;var I=4;var R=4;var L=h===f?8:16;var D,k,O;for(var F=0;F<P;F++){var B=s;var N=a;for(var z=0;z<o;z++){if(b)if(S)E=Math.floor((B+3)/4)*Math.floor((N+3)/4)*8;else if(w)E=Math.max(B,16)*Math.max(N,8)/4;else if(T)E=Math.max(B,8)*Math.max(N,8)/2;else{D=Math.floor((B+I-1)/I);k=Math.floor((N+R-1)/R);O=D*k;E=O*L}else E=B*N*4;var V=x?new Float32Array(i,A,E):new Uint8Array(i,A,E);if(!u)C._levels[z]=V;else{if(!C._levels[z])C._levels[z]=[];C._levels[z][F]=V}A+=x?E*4:E;B=Math.max(B*.5,1);N=Math.max(N*.5,1)}}C.upload();return C};return e}(),xy={repeat:He,clamp:We,mirror:je},Sy={nearest:Mt,linear:Ct,nearest_mip_nearest:At,linear_mip_nearest:Et,nearest_mip_linear:Pt,linear_mip_linear:It},wy={default:_n,rgbm:vn,rgbe:gn,swizzleGGGR:yn},Ty=function(){function e(){}var t=e.prototype;t.load=function e(t,i,n){throw new Error("not implemented")};t.open=function e(t,i,n){throw new Error("not implemented")};return e}(),My=function e(t){var i=Math.log2(Math.max(t._width,t._height))+1;var n=function e(t){return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement};if(!(t._format===Kt||t._format===ii)||t._volume||t._compressed||t._levels.length===1||t._levels.length===i||n(t._cubemap?t._levels[0][0]:t._levels[0]))return;var r=function e(t,i,n){var r=Math.max(1,t>>1);var s=Math.max(1,i>>1);var a=new n.constructor(r*s*4);var o=Math.floor(t/r);var l=Math.floor(i/s);var h=o*l;for(var c=0;c<s;++c)for(var u=0;u<r;++u)for(var f=0;f<4;++f){var d=0;for(var p=0;p<l;++p)for(var m=0;m<o;++m)d+=n[(u*o+m+(c*l+p)*t)*4+f];a[(u+c*r)*4+f]=d/h}return a};for(var s=t._levels.length;s<i;++s){var a=Math.max(1,t._width>>s-1);var o=Math.max(1,t._height>>s-1);if(t._cubemap){var l=[];for(var h=0;h<6;++h)l.push(r(a,o,t._levels[s-1][h]));t._levels.push(l)}else t._levels.push(r(a,o,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[true,true,true,true,true,true]]:[true]},Cy=function(){function e(e,t,i){this._device=e;this._assets=t;this._loader=i;this.imgParser=new _y(t);this.parsers={dds:new by(t),ktx:new yy(t),basis:new my(t)}}var t=e.prototype;t._getUrlWithoutParams=function e(t){return t.indexOf("?")>=0?t.split("?")[0]:t};t._getParser=function e(t){var i=p.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".","");return this.parsers[i]||this.imgParser};t.load=function e(t,i,n){if(typeof t==="string")t={load:t,original:t};this._getParser(t.original).load(t,i,n)};t.open=function e(t,i,n){if(!t)return;var r=this._getParser(t).open(t,i,this._device);if(r===null)r=new bu(this._device,{width:4,height:4,format:Yt});else My(r);return r};t.patch=function e(t,i){var n=t.resource;if(!n)return;if(t.name&&t.name.length>0)n.name=t.name;var r=t.data;if(r.hasOwnProperty("minfilter"))n.minFilter=Sy[r.minfilter];if(r.hasOwnProperty("magfilter"))n.magFilter=Sy[r.magfilter];if(!n.cubemap){if(r.hasOwnProperty("addressu"))n.addressU=xy[r.addressu];if(r.hasOwnProperty("addressv"))n.addressV=xy[r.addressv]}if(r.hasOwnProperty("mipmaps"))n.mipmaps=r.mipmaps;if(r.hasOwnProperty("anisotropy"))n.anisotropy=r.anisotropy;if(r.hasOwnProperty("flipY"))n.flipY=!!r.flipY;if(r.hasOwnProperty("type"))n.type=wy[r.type];else if(r.hasOwnProperty("rgbm")&&r.rgbm)n.type=vn;else if(t.file&&t.getPreferredFile){var s=t.getPreferredFile();if(s)if(s.opt&&(s.opt&8)!==0)n.type=yn}};U(e,[{key:"crossOrigin",get:function e(){return this.imgParser.crossOrigin},set:function e(t){this.imgParser.crossOrigin=t}},{key:"maxRetries",get:function e(){return this.imgParser.maxRetries},set:function e(t){this.imgParser.maxRetries=t;for(var i in this.parsers)if(this.parsers.hasOwnProperty(i))this.parsers[i].maxRetries=t}}]);return e}(),Ay=function(){function e(e){if(e===void 0)e=null;this._index={};this._key=e}var t=e.prototype;t.addItem=function e(t){var i=t.tags._list;for(var n=0;n<i.length;n++)this.add(i[n],t)};t.removeItem=function e(t){var i=t.tags._list;for(var n=0;n<i.length;n++)this.remove(i[n],t)};t.add=function e(t,i){if(this._index[t]&&this._index[t].list.indexOf(i)!==-1)return;if(!this._index[t]){this._index[t]={list:[]};if(this._key)this._index[t].keys={}}this._index[t].list.push(i);if(this._key)this._index[t].keys[i[this._key]]=i};t.remove=function e(t,i){if(!this._index[t])return;if(this._key)if(!this._index[t].keys[i[this._key]])return;var n=this._index[t].list.indexOf(i);if(n===-1)return;this._index[t].list.splice(n,1);if(this._key)delete this._index[t].keys[i[this._key]];if(this._index[t].list.length===0)delete this._index[t]};t.find=function e(t){var n=this;var i={};var r=[];var s,a,o;var l,h,c,u,f;var d=function e(t,i){return n._index[t].list.length-n._index[i].list.length};for(s=0;s<t.length;s++){h=t[s];if(h instanceof Array){if(h.length===0)continue;if(h.length===1)h=h[0];else{f=false;for(o=0;o<h.length;o++)if(!this._index[h[o]]){f=true;break}if(f)continue;c=h.slice(0).sort(d);u=c.slice(1);if(u.length===1)u=u[0];for(a=0;a<this._index[c[0]].list.length;a++){l=this._index[c[0]].list[a];if((this._key?!i[l[this._key]]:r.indexOf(l)===-1)&&l.tags.has(u)){if(this._key)i[l[this._key]]=true;r.push(l)}}continue}}if(h&&typeof h==="string"&&this._index[h])for(a=0;a<this._index[h].list.length;a++){l=this._index[h].list[a];if(this._key){if(!i[l[this._key]]){i[l[this._key]]=true;r.push(l)}}else if(r.indexOf(l)===-1)r.push(l)}}return r};return e}(),Py=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._loader=e;t._assets=[];t._cache={};t._names={};t._tags=new Ay("_id");t._urls={};t.prefix=null;return t}var t=e.prototype;t.list=function e(i){i=i||{};return this._assets.filter(function(e){var t=true;if(i.preload!==undefined)t=e.preload===i.preload;return t})};t.add=function e(t){var i=this._assets.push(t)-1;var n;this._cache[t.id]=i;if(!this._names[t.name])this._names[t.name]=[];this._names[t.name].push(i);if(t.file){n=t.file.url;this._urls[n]=i}t.registry=this;this._tags.addItem(t);t.tags.on("add",this._onTagAdd,this);t.tags.on("remove",this._onTagRemove,this);this.fire("add",t);this.fire("add:"+t.id,t);if(n)this.fire("add:url:"+n,t);if(t.preload)this.load(t)};t.remove=function e(t){var i=this._cache[t.id];var n=t.file?t.file.url:null;if(i!==undefined){this._assets.splice(i,1);delete this._cache[t.id];this._names={};this._urls=[];for(var r=0,s=this._assets.length;r<s;r++){var a=this._assets[r];this._cache[a.id]=r;if(!this._names[a.name])this._names[a.name]=[];this._names[a.name].push(r);if(a.file)this._urls[a.file.url]=r}this._tags.removeItem(t);t.tags.off("add",this._onTagAdd,this);t.tags.off("remove",this._onTagRemove,this);t.fire("remove",t);this.fire("remove",t);this.fire("remove:"+t.id,t);if(n)this.fire("remove:url:"+n,t);return true}return false};t.get=function e(t){var i=this._cache[t];return this._assets[i]};t.getByUrl=function e(t){var i=this._urls[t];return this._assets[i]};t.load=function e(s){if(s.loading||s.loaded)return;var a=this;var i=s.getPreferredFile();var o=function e(t){if(t instanceof Array)s.resources=t;else s.resource=t;a._loader.patch(s,a);a.fire("load",s);a.fire("load:"+s.id,s);if(i&&i.url)a.fire("load:url:"+i.url,s);s.fire("load",s)};var t=function e(t,i,n){s.loaded=true;s.loading=false;if(t){a.fire("error",t,s);a.fire("error:"+s.id,t,s);s.fire("error",t,s)}else{if(!Og.legacy&&s.type==="script"){var r=a._loader.getHandler("script");if(r._cache[s.id]&&r._cache[s.id].parentNode===document.head)document.head.removeChild(r._cache[s.id]);r._cache[s.id]=n}o(i)}};if(i||s.type==="cubemap"){this.fire("load:start",s);this.fire("load:"+s.id+":start",s);s.loading=true;a._loader.load(s.getFileUrl(),s.type,t,s)}else{var n=a._loader.open(s.type,s.data);s.loaded=true;o(n)}};t.loadFromUrl=function e(t,i,n){this.loadFromUrlAndFilename(t,null,i,n)};t.loadFromUrlAndFilename=function e(t,i,n,r){var s=this;var a=p.getBasename(i||t);var o={filename:i||a,url:t};var l=s.getByUrl(t);if(!l){l=new O_(a,n,o);s.add(l)}var h=function e(t){t.once("load",function(i){if(n==="material")s._loadTextures(i,function(e,t){r(e,i)});else r(null,i)});t.once("error",function(e){r(e)});s.load(t)};if(l.resource)r(null,l);else if(n==="model")s._loadModel(l,h);else h(l)};t._loadModel=function e(n,r){var t=this;var i=n.getFileUrl();var s=p.getExtension(i);if(s===".json"||s===".glb"){var a=p.getDirectory(i);var o=p.getBasename(i);var l=p.join(a,o.replace(s,".mapping.json"));this._loader.load(l,"json",function(e,i){if(e){n.data={mapping:[]};r(n)}else t._loadMaterials(n,i,function(e,t){n.data=i;r(n)})})}else r(n)};t._loadMaterials=function e(t,i,n){var r=this;var s=[];var a=0;var o=function e(t,i){r._loadTextures(i,function(e,t){s.push(i);if(s.length===a)n(null,s)})};for(var l=0;l<i.mapping.length;l++){var h=i.mapping[l].path;if(h){a++;r.loadFromUrl(t.getAbsoluteUrl(h),"material",o)}}if(a===0)n(null,s)};t._loadTextures=function e(t,n){var i=this;var r=[];var s=0;var a=t.data;if(a.mappingFormat!=="path"){n(null,r);return}var o=function e(t,i){if(t)console.error(t);r.push(i);if(r.length===s)n(null,r)};var l=lg;for(var h=0;h<l.length;h++){var c=a[l[h]];if(c&&typeof c==="string"){s++;i.loadFromUrl(t.getAbsoluteUrl(c),"texture",o)}}if(s===0)n(null,r)};t.findAll=function e(t,i){var n=this;var r=this._names[t];if(r){var s=r.map(function(e){return n._assets[e]});if(i)return s.filter(function(e){return e.type===i});return s}return[]};t._onTagAdd=function e(t,i){this._tags.add(t,i)};t._onTagRemove=function e(t,i){this._tags.remove(t,i)};t.findByTag=function e(){return this._tags.find(arguments)};t.filter=function e(t){var i=[];for(var n=0,r=this._assets.length;n<r;n++)if(t(this._assets[n]))i.push(this._assets[n]);return i};t.find=function e(t,i){var n=this.findAll(t,i);return n.length>0?n[0]:null};return e}(u),Ey=function(){function e(e){this._assets=e;this._bundleAssets={};this._assetsInBundles={};this._urlsInBundles={};this._fileRequests={};this._assets.on("add",this._onAssetAdded,this);this._assets.on("remove",this._onAssetRemoved,this)}var t=e.prototype;t._onAssetAdded=function e(t){if(t.type==="bundle"){this._bundleAssets[t.id]=t;this._registerBundleEventListeners(t.id);for(var i=0,n=t.data.assets.length;i<n;i++)this._indexAssetInBundle(t.data.assets[i],t)}else if(this._assetsInBundles[t.id])this._indexAssetFileUrls(t)};t._registerBundleEventListeners=function e(t){this._assets.on("load:"+t,this._onBundleLoaded,this);this._assets.on("error:"+t,this._onBundleError,this)};t._unregisterBundleEventListeners=function e(t){this._assets.off("load:"+t,this._onBundleLoaded,this);this._assets.off("error:"+t,this._onBundleError,this)};t._indexAssetInBundle=function e(t,i){if(!this._assetsInBundles[t])this._assetsInBundles[t]=[i];else{var n=this._assetsInBundles[t];var r=n.indexOf(i);if(r===-1)n.push(i)}var s=this._assets.get(t);if(s)this._indexAssetFileUrls(s)};t._indexAssetFileUrls=function e(t){var i=this._getAssetFileUrls(t);if(!i)return;for(var n=0,r=i.length;n<r;n++){var s=i[n];this._urlsInBundles[s]=this._assetsInBundles[t.id]}};t._getAssetFileUrls=function e(t){var i=t.getFileUrl();if(!i)return null;i=this._normalizeUrl(i);var n=[i];if(t.type==="font"){var r=t.data.info.maps.length;for(var s=1;s<r;s++)n.push(i.replace(".png",s+".png"))}return n};t._normalizeUrl=function e(t){return t&&t.split("?")[0]};t._onAssetRemoved=function e(t){if(t.type==="bundle"){delete this._bundleAssets[t.id];this._unregisterBundleEventListeners(t.id);var i,n;for(n in this._assetsInBundles){var r=this._assetsInBundles[n];i=r.indexOf(t);if(i!==-1){r.splice(i,1);if(!r.length){delete this._assetsInBundles[n];for(var s in this._urlsInBundles)if(this._urlsInBundles[s]===r)delete this._urlsInBundles[s]}}}this._onBundleError("Bundle "+t.id+" was removed",t)}else if(this._assetsInBundles[t.id]){delete this._assetsInBundles[t.id];var a=this._getAssetFileUrls(t);for(var o=0,l=a.length;o<l;o++)delete this._urlsInBundles[a[o]]}};t._onBundleLoaded=function e(o){if(!o.resource){this._onBundleError("Bundle "+o.id+" failed to load",o);return}requestAnimationFrame(function(){if(!this._fileRequests)return;for(var e in this._fileRequests){var t=this._urlsInBundles[e];if(!t||t.indexOf(o)===-1)continue;var i=decodeURIComponent(e);var n=null;if(!o.resource.hasBlobUrl(i))n="Bundle "+o.id+" does not contain URL "+e;var r=this._fileRequests[e];for(var s=0,a=r.length;s<a;s++)if(n)r[s](n);else r[s](null,o.resource.getBlobUrl(i));delete this._fileRequests[e]}}.bind(this))};t._onBundleError=function e(t,i){for(var n in this._fileRequests){var r=this._findLoadedOrLoadingBundleForUrl(n);if(!r){var s=this._fileRequests[n];for(var a=0,o=s.length;a<o;a++)s[a](t);delete this._fileRequests[n]}}};t._findLoadedOrLoadingBundleForUrl=function e(t){var i=this._urlsInBundles[t];if(!i)return null;var n=i.length;var r;for(r=0;r<n;r++)if(i[r].loaded&&i[r].resource)return i[r];for(r=0;r<n;r++)if(i[r].loading)return i[r];return null};t.listBundlesForAsset=function e(t){return this._assetsInBundles[t.id]||null};t.list=function e(){var t=[];for(var i in this._bundleAssets)t.push(this._bundleAssets[i]);return t};t.hasUrl=function e(t){return!!this._urlsInBundles[t]};t.canLoadUrl=function e(t){return!!this._findLoadedOrLoadingBundleForUrl(t)};t.loadUrl=function e(t,i){var n=this._findLoadedOrLoadingBundleForUrl(t);if(!n){i("URL "+t+" not found in any bundles");return}if(n.loaded){var r=decodeURIComponent(t);if(!n.resource.hasBlobUrl(r)){i("Bundle "+n.id+" does not contain URL "+t);return}i(null,n.resource.getBlobUrl(r))}else if(this._fileRequests.hasOwnProperty(t))this._fileRequests[t].push(i);else this._fileRequests[t]=[i]};t.destroy=function e(){this._assets.off("add",this._onAssetAdded,this);this._assets.off("remove",this._onAssetRemoved,this);for(var t in this._bundleAssets)this._unregisterBundleEventListeners(t);this._assets=null;this._bundleAssets=null;this._assetsInBundles=null;this._urlsInBundles=null;this._fileRequests=null};return e}(),Iy=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t.list=function(){return this._list};t.app=e;t._scripts={};t._list=[];return t}var t=e.prototype;t.destroy=function e(){this.app=null;this.off()};t.add=function e(i){var o=this;var l=i.__name;if(this._scripts.hasOwnProperty(l)){setTimeout(function(){if(i.prototype.swap){var e=o._scripts[l];var t=o._list.indexOf(e);o._list[t]=i;o._scripts[l]=i;o.fire("swap",l,i);o.fire("swap:"+l,i)}else console.warn("script registry already has '"+l+"' script, define 'swap' method for new script type to enable code hot swapping")});return false}this._scripts[l]=i;this._list.push(i);this.fire("add",l,i);this.fire("add:"+l,i);setTimeout(function(){if(!o._scripts.hasOwnProperty(l))return;if(!o.app||!o.app.systems||!o.app.systems.script)return;var e=o.app.systems.script._components;var t,i,n;var r=[];var s=[];for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){var a=e.items[e.loopIndex];if(a._scriptsIndex[l]&&a._scriptsIndex[l].awaiting){if(a._scriptsData&&a._scriptsData[l])n=a._scriptsData[l].attributes;i=a.create(l,{preloading:true,ind:a._scriptsIndex[l].ind,attributes:n});if(i)r.push(i)}}for(t=0;t<r.length;t++)r[t].__initializeAttributes();for(t=0;t<r.length;t++)if(r[t].enabled){r[t]._initialized=true;s.push(r[t]);if(r[t].initialize)r[t].initialize()}for(t=0;t<s.length;t++){if(!s[t].enabled||s[t]._postInitialized)continue;s[t]._postInitialized=true;if(s[t].postInitialize)s[t].postInitialize()}});return true};t.remove=function e(t){var i=t;var n=t;if(typeof n!=="string")n=i.__name;else i=this.get(n);if(this.get(n)!==i)return false;delete this._scripts[n];var r=this._list.indexOf(i);this._list.splice(r,1);this.fire("remove",n,i);this.fire("remove:"+n,i);return true};t.get=function e(t){return this._scripts[t]||null};t.has=function e(t){if(typeof t==="string")return this._scripts.hasOwnProperty(t);if(!t)return false;var i=t.__name;return this._scripts[i]===t};return e}(u),Ry=function(){function e(){}var t=e.prototype;t._validate=function e(t){if(!t.header)throw new Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw new Error('pc.I18n#addData: Missing "header.version" field');if(t.header.version!==1)throw new Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw new Error('pc.I18n#addData: Missing "data" field');else if(!Array.isArray(t.data))throw new Error('pc.I18n#addData: "data" field must be an array');for(var i=0,n=t.data.length;i<n;i++){var r=t.data[i];if(!r.info)throw new Error('pc.I18n#addData: missing "data['+i+'].info" field');if(!r.info.locale)throw new Error('pc.I18n#addData: missing "data['+i+'].info.locale" field');if(typeof r.info.locale!=="string")throw new Error('pc.I18n#addData: "data['+i+'].info.locale" must be a string');if(!r.messages)throw new Error('pc.I18n#addData: missing "data['+i+'].messages" field')}};t.parse=function e(t){return t.data};return e}(),Ly=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t.destroy=function(){this._translations=null;this._availableLangs=null;this._assets=null;this._parser=null;this.off()};t.locale=s_;t._translations={};t._availableLangs={};t._app=e;t._assets=[];t._parser=new Ry;return t}e.findAvailableLocale=function e(t,i){return u_(t,i)};var t=e.prototype;t.getText=function e(t,i){var n=t;var r;if(!i){i=this._locale;r=this._lang}var s=this._translations[i];if(!s){if(!r)r=h_(i);i=this._findFallbackLocale(i,r);s=this._translations[i]}if(s&&s.hasOwnProperty(t)){n=s[t];if(Array.isArray(n))n=n[0];if(n===null||n===undefined)n=t}return n};t.getPluralText=function e(t,i,n){var r=t;var s;var a;if(!n){n=this._locale;a=this._lang;s=this._pluralFn}else{a=h_(n);s=d_(a)}var o=this._translations[n];if(!o){n=this._findFallbackLocale(n,a);a=h_(n);s=d_(a);o=this._translations[n]}if(o&&o[t]&&s){var l=s(i);r=o[t][l];if(r===null||r===undefined)r=t}return r};t.addData=function e(t){var i;try{i=this._parser.parse(t)}catch(e){console.error(e);return}for(var n=0,r=i.length;n<r;n++){var s=i[n];var a=s.info.locale;var o=s.messages;if(!this._translations[a]){this._translations[a]={};var l=h_(a);if(!this._availableLangs[l])this._availableLangs[l]=a}Object.assign(this._translations[a],o);this.fire("data:add",a,o)}};t.removeData=function e(t){var i;var n;try{i=this._parser.parse(t)}catch(e){console.error(e);return}for(var r=0,s=i.length;r<s;r++){var a=i[r];var o=a.info.locale;var l=this._translations[o];if(!l)continue;var h=a.messages;for(n in h)delete l[n];var c=false;for(n in l){c=true;break}if(!c){delete this._translations[o];delete this._availableLangs[h_(o)]}this.fire("data:remove",o,h)}};t._findFallbackLocale=function e(t,i){var n=a_[t];if(n&&this._translations[n])return n;n=a_[i];if(n&&this._translations[n])return n;n=this._availableLangs[i];if(n&&this._translations[n])return n;return s_};t._onAssetAdd=function e(t){t.on("load",this._onAssetLoad,this);t.on("change",this._onAssetChange,this);t.on("remove",this._onAssetRemove,this);t.on("unload",this._onAssetUnload,this);if(t.resource)this._onAssetLoad(t)};t._onAssetLoad=function e(t){this.addData(t.resource)};t._onAssetChange=function e(t){if(t.resource)this.addData(t.resource)};t._onAssetRemove=function e(t){t.off("load",this._onAssetLoad,this);t.off("change",this._onAssetChange,this);t.off("remove",this._onAssetRemove,this);t.off("unload",this._onAssetUnload,this);if(t.resource)this.removeData(t.resource);this._app.assets.once("add:"+t.id,this._onAssetAdd,this)};t._onAssetUnload=function e(t){if(t.resource)this.removeData(t.resource)};U(e,[{key:"locale",get:function e(){return this._locale},set:function e(t){if(this._locale===t)return;var i=h_(t);if(i==="in"){i="id";t=c_(t,i);if(this._locale===t)return}var n=this._locale;this._locale=t;this._lang=i;this._pluralFn=d_(this._lang);this.fire("set:locale",t,n)}},{key:"assets",get:function e(){return this._assets},set:function e(t){var i;var n;var r;var s;var a={};for(i=0,n=t.length;i<n;i++){r=t[i]instanceof O_?t[i].id:t[i];a[r]=true}i=this._assets.length;while(i--){r=this._assets[i];if(!a[r]){this._app.assets.off("add:"+r,this._onAssetAdd,this);s=this._app.assets.get(r);if(s)this._onAssetRemove(s);this._assets.splice(i,1)}}for(r in a){r=parseInt(r,10);if(this._assets.indexOf(r)!==-1)continue;this._assets.push(r);s=this._app.assets.get(r);if(!s)this._app.assets.once("add:"+r,this._onAssetAdd,this);else this._onAssetAdd(s)}}}]);return e}(u),Dy="NONE",ky="FILL_WINDOW",Oy="KEEP_ASPECT",Fy="AUTO",By="FIXED",Ny=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;var a=H(i);i._app=e;i._device=e.graphicsDevice;i.id=t.displayId;i._frameData=null;if(window.VRFrameData)i._frameData=new window.VRFrameData;i.display=t;i._camera=null;i.sitToStandInv=new ve;i.leftView=new ve;i.leftProj=new ve;i.leftViewInv=new ve;i.leftPos=new ce;i.rightView=new ve;i.rightProj=new ve;i.rightViewInv=new ve;i.rightPos=new ce;i.combinedPos=new ce;i.combinedView=new ve;i.combinedProj=new ve;i.combinedViewInv=new ve;i.combinedFov=0;i.combinedAspect=0;i.presenting=false;a._presentChange=function(e){var t;if(e.display)t=e.display;else if(e.detail&&e.detail.display)t=e.detail.display;else if(e.detail&&e.detail.vrdisplay)t=e.detail.vrdisplay;else t=a.display;if(t===a.display){a.presenting=a.display&&a.display.isPresenting;if(a.presenting){var i=a.display.getEyeParameters("left");var n=a.display.getEyeParameters("right");var r=Math.max(i.renderWidth,n.renderWidth)*2;var s=Math.max(i.renderHeight,n.renderHeight);a._app.graphicsDevice.setResolution(r,s);a._app._allowResize=false}else{a._app.setCanvasResolution(Fy);a._app._allowResize=true}a.fire("beforepresentchange",a);a.fire("presentchange",a)}};window.addEventListener("vrdisplaypresentchange",a._presentChange,false);return i}var t=e.prototype;t.destroy=function e(){window.removeEventListener("vrdisplaypresentchange",self._presentChange);if(this._camera)this._camera.vrDisplay=null;this._camera=null};t.poll=function e(){if(this.display){this.display.getFrameData(this._frameData);this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var t=this.display.stageParameters;if(t){this.sitToStandInv.set(t.sittingToStandingTransform).invert();this.combinedView.set(this._frameData.leftViewMatrix);this.leftView.mul2(this.combinedView,this.sitToStandInv);this.combinedView.set(this._frameData.rightViewMatrix);this.rightView.mul2(this.combinedView,this.sitToStandInv)}else{this.leftView.set(this._frameData.leftViewMatrix);this.rightView.set(this._frameData.rightViewMatrix)}var i=this.leftProj.data[3]+this.leftProj.data[0];var n=this.leftProj.data[11]+this.leftProj.data[8];var r=1/Math.sqrt(i*i+n*n);i*=r;n*=r;var s=-Math.atan2(n,i);i=this.rightProj.data[3]+this.rightProj.data[0];n=this.rightProj.data[11]+this.rightProj.data[8];r=1/Math.sqrt(i*i+n*n);i*=r;n*=r;s=Math.max(s,-Math.atan2(n,i));s*=2;this.combinedFov=s;var a=this.rightProj.data[5]/this.rightProj.data[0];this.combinedAspect=a;var o=this.combinedView;o.copy(this.leftView);o.invert();this.leftViewInv.copy(o);var l=this.combinedPos;l.x=this.leftPos.x=o.data[12];l.y=this.leftPos.y=o.data[13];l.z=this.leftPos.z=o.data[14];o.copy(this.rightView);o.invert();this.rightViewInv.copy(o);var h=l.x-o.data[12];var c=l.y-o.data[13];var u=l.z-o.data[14];var f=Math.sqrt(h*h+c*c+u*u);this.rightPos.x=o.data[12];this.rightPos.y=o.data[13];this.rightPos.z=o.data[14];l.x+=o.data[12];l.y+=o.data[13];l.z+=o.data[14];l.x*=.5;l.y*=.5;l.z*=.5;var d=Math.PI*.5;var p=s*.5;var m=Math.PI-(d+p);var _=f*.5*Math.sin(m);var v=o.data[8];var g=o.data[9];var y=o.data[10];o.data[12]=l.x+v*_;o.data[13]=l.y+g*_;o.data[14]=l.z+y*_;this.combinedViewInv.copy(o);o.invert();this.combinedProj.setPerspective(s*Pe.RAD_TO_DEG,a,this.display.depthNear+_,this.display.depthFar+_,true)}};t.requestPresent=function e(t){if(!this.display){if(t)t(new Error("No VrDisplay to requestPresent"));return}if(this.presenting){if(t)t(new Error("VrDisplay already presenting"));return}this.display.requestPresent([{source:this._device.canvas}]).then(function(){if(t)t()},function(e){if(t)t(e)})};t.exitPresent=function e(t){if(!this.display)if(t)t(new Error("No VrDisplay to exitPresent"));if(!this.presenting){if(t)t(new Error("VrDisplay not presenting"));return}this.display.exitPresent().then(function(){if(t)t()},function(){if(t)t(new Error("exitPresent failed"))})};t.requestAnimationFrame=function e(t){if(this.display)this.display.requestAnimationFrame(t)};t.submitFrame=function e(){if(this.display)this.display.submitFrame()};t.reset=function e(){if(this.display)this.display.resetPose()};t.setClipPlanes=function e(t,i){if(this.display){this.display.depthNear=t;this.display.depthFar=i}};t.getFrameData=function e(){if(this.display)return this._frameData};U(e,[{key:"capabilities",get:function e(){if(this.display)return this.display.capabilities;return{}}}]);return e}(u),zy=function(i){G(r,i);function r(e){var t;t=i.call(this)||this;var n=H(t);t.isSupported=r.isSupported;t._index={};t.displays=[];t.display=null;t._app=e;t._onDisplayConnect=t._onDisplayConnect.bind(H(t));t._onDisplayDisconnect=t._onDisplayDisconnect.bind(H(t));n._attach();t._getDisplays(function(e,t){if(e)n.fire("error",e);else{for(var i=0;i<t.length;i++)n._addDisplay(t[i]);n.fire("ready",n.displays)}});return t}var e=r.prototype;e._attach=function e(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)};e._detach=function e(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)};e.destroy=function e(){this._detach()};e.poll=function e(){var t=this.displays.length;if(!t)return;for(var i=0;i<t;i++)if(this.displays[i]._camera)this.displays[i].poll()};e._getDisplays=function e(t){if(navigator.getVRDisplays)navigator.getVRDisplays().then(function(e){if(t)t(null,e)});else if(t)t(new Error("WebVR not supported"))};e._addDisplay=function e(t){if(this._index[t.displayId])return;var i=new Ny(this._app,t);this._index[i.id]=i;this.displays.push(i);if(!this.display)this.display=i;this.fire("displayconnect",i)};e._onDisplayConnect=function e(t){if(t.detail&&t.detail.display)this._addDisplay(t.detail.display);else this._addDisplay(t.display)};e._onDisplayDisconnect=function e(t){var i;if(t.detail&&t.detail.display)i=t.detail.display.displayId;else i=t.display.displayId;var n=this._index[i];if(!n)return;n.destroy();delete this._index[n.id];var r=this.displays.indexOf(n);this.displays.splice(r,1);if(this.display===n)if(this.displays.length)this.display=this.displays[0];else this.display=null;this.fire("displaydisconnect",n)};return r}(u);zy.isSupported=typeof navigator!=="undefined"?!!navigator.getVRDisplays:false;for(var Vy="inline",Uy="immersive-vr",Gy="immersive-ar",Hy="viewer",Wy="local",jy="local-floor",Xy="bounded-floor",qy="unbounded",Yy="gaze",Ky="screen",Qy="tracked-pointer",$y="none",Zy="left",Jy="right",e0="point",t0="plane",i0="mesh",n0=[],r0=[],s0=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this)||this;n.manager=e;n._xrHitTestSource=t;n._transient=i;return n}var t=e.prototype;t.remove=function e(){if(!this._xrHitTestSource)return;var t=this.manager.hitTest.sources;var i=t.indexOf(this);if(i!==-1)t.splice(i,1);this.onStop()};t.onStop=function e(){this._xrHitTestSource.cancel();this._xrHitTestSource=null;this.fire("remove");this.manager.hitTest.fire("remove",this)};t.update=function e(t){if(this._transient){var i=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var n=0;n<i.length;n++){var r=i[n];var s;if(r.inputSource)s=this.manager.input._getByInputSource(r.inputSource);this.updateHitResults(r.results,s)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))};t.updateHitResults=function e(t,i){for(var n=0;n<t.length;n++){var r=t[n].getPose(this.manager._referenceSpace);var s=n0.pop();if(!s)s=new ce;s.copy(r.transform.position);var a=r0.pop();if(!a)a=new be;a.copy(r.transform.orientation);this.fire("result",s,a,i);this.manager.hitTest.fire("result",this,s,a,i);n0.push(s);r0.push(a)}};return e}(u),a0=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t.manager=e;t._supported=!!(window.XRSession&&window.XRSession.prototype.requestHitTestSource);t._session=null;t.sources=[];if(t._supported){t.manager.on("start",t._onSessionStart,H(t));t.manager.on("end",t._onSessionEnd,H(t))}return t}var t=e.prototype;t._onSessionStart=function e(){if(this.manager.type!==Gy)return;this._session=this.manager.session};t._onSessionEnd=function e(){if(!this._session)return;this._session=null;for(var t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]};t.isAvailable=function e(t,i){var n;if(!this._supported)n=new Error("XR HitTest is not supported");if(!this._session)n=new Error("XR Session is not started (1)");if(this.manager.type!==Gy)n=new Error("XR HitTest is available only for AR");if(n){if(t)t(n);if(i)i.fire("error",n);return false}return true};t.start=function e(i){var n=this;i=i||{};if(!this.isAvailable(i.callback,this))return;if(!i.profile&&!i.spaceType)i.spaceType=Hy;var r;var t=i.offsetRay;if(t)r=new XRRay(new DOMPoint(t.origin.x,t.origin.y,t.origin.z),new DOMPoint(t.direction.x,t.direction.y,t.direction.z));var s=i.callback;if(i.spaceType)this._session.requestReferenceSpace(i.spaceType).then(function(e){if(!n._session){var t=new Error("XR Session is not started (2)");if(s)s(t);n.fire("error",t);return}n._session.requestHitTestSource({space:e,entityTypes:i.entityTypes||undefined,offsetRay:r}).then(function(e){n._onHitTestSource(e,false,s)}).catch(function(e){if(s)s(e);n.fire("error",e)})}).catch(function(e){if(s)s(e);n.fire("error",e)});else this._session.requestHitTestSourceForTransientInput({profile:i.profile,entityTypes:i.entityTypes||undefined,offsetRay:r}).then(function(e){n._onHitTestSource(e,true,s)}).catch(function(e){if(s)s(e);n.fire("error",e)})};t._onHitTestSource=function e(t,i,n){if(!this._session){t.cancel();var r=new Error("XR Session is not started (3)");if(n)n(r);this.fire("error",r);return}var s=new s0(this.manager,t,i);this.sources.push(s);if(n)n(null,s);this.fire("add",s)};t.update=function e(t){for(var i=0;i<this.sources.length;i++)this.sources[i].update(t)};U(e,[{key:"supported",get:function e(){return this._supported}}]);return e}(u),o0=function(){function e(e,t){this._index=e;this._hand=t;this._hand._fingers.push(this);this._joints=[];this._tip=null}U(e,[{key:"index",get:function e(){return this._index}},{key:"hand",get:function e(){return this._hand}},{key:"joints",get:function e(){return this._joints}},{key:"tip",get:function e(){return this._tip}}]);return e}(),l0=window.XRHand?[XRHand.THUMB_PHALANX_TIP,XRHand.INDEX_PHALANX_TIP,XRHand.MIDDLE_PHALANX_TIP,XRHand.RING_PHALANX_TIP,XRHand.LITTLE_PHALANX_TIP]:[],h0={},c0=0;c0<l0.length;c0++)h0[l0[c0]]=true;var u0=function(){function e(e,t,i,n){if(n===void 0)n=null;this._index=e;this._id=t;this._hand=i;this._hand._joints.push(this);this._hand._jointsById[t]=this;this._finger=n;if(this._finger)this._finger._joints.push(this);this._wrist=t===XRHand.WRIST;if(this._wrist)this._hand._wrist=this;this._tip=this._finger&&!!h0[t];if(this._tip){this._hand._tips.push(this);if(this._finger)this._finger._tip=this}this._radius=null;this._localTransform=new ve;this._worldTransform=new ve;this._localPosition=new ce;this._localRotation=new be;this._position=new ce;this._rotation=new be;this._dirtyLocal=true}var t=e.prototype;t.update=function e(t){this._dirtyLocal=true;this._radius=t.radius;this._localPosition.copy(t.transform.position);this._localRotation.copy(t.transform.orientation)};t._updateTransforms=function e(){if(this._dirtyLocal){this._dirtyLocal=false;this._localTransform.setTRS(this._localPosition,this._localRotation,ce.ONE)}var t=this._hand._manager;var i=t.camera.parent;if(i)this._worldTransform.mul2(i.getWorldTransform(),this._localTransform);else this._worldTransform.copy(this._localTransform)};t.getPosition=function e(){this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};t.getRotation=function e(){this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};U(e,[{key:"index",get:function e(){return this._index}},{key:"hand",get:function e(){return this._hand}},{key:"finger",get:function e(){return this._finger}},{key:"wrist",get:function e(){return this._wrist}},{key:"tip",get:function e(){return this._tip}},{key:"radius",get:function e(){return this._radius||.005}}]);return e}(),f0=[],d0=new ce,p0=new ce,m0=new ce;if(window.XRHand)f0=[[XRHand.THUMB_METACARPAL,XRHand.THUMB_PHALANX_PROXIMAL,XRHand.THUMB_PHALANX_DISTAL,XRHand.THUMB_PHALANX_TIP],[XRHand.INDEX_METACARPAL,XRHand.INDEX_PHALANX_PROXIMAL,XRHand.INDEX_PHALANX_INTERMEDIATE,XRHand.INDEX_PHALANX_DISTAL,XRHand.INDEX_PHALANX_TIP],[XRHand.MIDDLE_METACARPAL,XRHand.MIDDLE_PHALANX_PROXIMAL,XRHand.MIDDLE_PHALANX_INTERMEDIATE,XRHand.MIDDLE_PHALANX_DISTAL,XRHand.MIDDLE_PHALANX_TIP],[XRHand.RING_METACARPAL,XRHand.RING_PHALANX_PROXIMAL,XRHand.RING_PHALANX_INTERMEDIATE,XRHand.RING_PHALANX_DISTAL,XRHand.RING_PHALANX_TIP],[XRHand.LITTLE_METACARPAL,XRHand.LITTLE_PHALANX_PROXIMAL,XRHand.LITTLE_PHALANX_INTERMEDIATE,XRHand.LITTLE_PHALANX_DISTAL,XRHand.LITTLE_PHALANX_TIP]];var _0=function(o){G(e,o);function e(e){var t;t=o.call(this)||this;t.update=function(e){var t=this._inputSource._xrInputSource;for(var i=0;i<this._joints.length;i++){var n=this._joints[i];var r=t.hand[n._id];if(r){var s=e.getJointPose(r,this._manager._referenceSpace);if(s){n.update(s);if(n.wrist&&!this._tracking){this._tracking=true;this.fire("tracking")}}else if(n.wrist){if(this._tracking){this._tracking=false;this.fire("trackinglost")}break}}}var a=this._jointsById[XRHand.THUMB_METACARPAL];var o=this._jointsById[XRHand.THUMB_PHALANX_TIP];var l=this._jointsById[XRHand.INDEX_PHALANX_PROXIMAL];var h=this._jointsById[XRHand.INDEX_PHALANX_TIP];var c=this._jointsById[XRHand.RING_PHALANX_PROXIMAL];var u=this._jointsById[XRHand.LITTLE_PHALANX_PROXIMAL];if(a&&o&&l&&h&&c&&u){this._inputSource._dirtyRay=true;this._inputSource._rayLocal.origin.lerp(o._localPosition,h._localPosition,.5);var f=a;var d=u;if(this._inputSource.handedness===Zy){var p=f;f=d;d=p}d0.sub2(f._localPosition,this._wrist._localPosition);p0.sub2(d._localPosition,this._wrist._localPosition);m0.cross(d0,p0).normalize();d0.lerp(l._localPosition,c._localPosition,.5);d0.sub(this._wrist._localPosition).normalize();this._inputSource._rayLocal.direction.lerp(m0,d0,.5).normalize()}var m=this._fingerIsClosed(1)&&this._fingerIsClosed(2)&&this._fingerIsClosed(3)&&this._fingerIsClosed(4);if(m){if(!this._inputSource._squeezing){this._inputSource._squeezing=true;this._inputSource.fire("squeezestart");this._manager.input.fire("squeezestart",this._inputSource)}}else if(this._inputSource._squeezing){this._inputSource._squeezing=false;this._inputSource.fire("squeeze");this._manager.input.fire("squeeze",this._inputSource);this._inputSource.fire("squeezeend");this._manager.input.fire("squeezeend",this._inputSource)}};var i=e._xrInputSource.hand;t._manager=e._manager;t._inputSource=e;t._tracking=false;t._fingers=[];t._joints=[];t._jointsById={};t._tips=[];t._wrist=null;if(i[XRHand.WRIST])t._wrist=new u0(0,XRHand.WRIST,H(t),null);for(var n=0;n<f0.length;n++){var r=new o0(n,H(t));for(var s=0;s<f0[n].length;s++){var a=f0[n][s];if(!i[a])continue;new u0(s,a,H(t),r)}}return t}var t=e.prototype;t._fingerIsClosed=function e(t){var i=this._fingers[t];d0.sub2(i.joints[0]._localPosition,i.joints[1]._localPosition).normalize();p0.sub2(i.joints[2]._localPosition,i.joints[3]._localPosition).normalize();return d0.dot(p0)<-.8};t.getJointById=function e(t){return this._jointsById[t]||null};U(e,[{key:"fingers",get:function e(){return this._fingers}},{key:"joints",get:function e(){return this._joints}},{key:"tips",get:function e(){return this._tips}},{key:"wrist",get:function e(){return this._wrist}},{key:"tracking",get:function e(){return this._tracking}}]);return e}(u),v0=new be,g0=0,y0=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;i._updateRayTransforms=function(){var e=this._dirtyRay;this._dirtyRay=false;var t=this._manager.camera.parent;if(t){var i=this._manager.camera.parent.getWorldTransform();i.getTranslation(this._position);this._rotation.setFromMat4(i);this._rotation.transformVector(this._rayLocal.origin,this._ray.origin);this._ray.origin.add(this._position);this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)}else if(e){this._ray.origin.copy(this._rayLocal.origin);this._ray.direction.copy(this._rayLocal.direction)}};i.getLocalRotation=function(){return this._localRotation};i.getOrigin=function(){this._updateRayTransforms();return this._ray.origin};i._id=++g0;i._manager=e;i._xrInputSource=t;i._ray=new Oe;i._rayLocal=new Oe;i._grip=false;i._hand=null;if(t.hand)i._hand=new _0(H(i));i._localTransform=null;i._worldTransform=null;i._position=new ce;i._rotation=new be;i._localPosition=null;i._localRotation=null;i._dirtyLocal=true;i._selecting=false;i._squeezing=false;i._elementInput=true;i._elementEntity=null;i._hitTestSources=[];return i}var t=e.prototype;t.update=function e(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){var i=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);if(i){if(!this._grip){this._grip=true;this._localTransform=new ve;this._worldTransform=new ve;this._localPosition=new ce;this._localRotation=new be}this._dirtyLocal=true;this._localPosition.copy(i.transform.position);this._localRotation.copy(i.transform.orientation)}}var n=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace);if(n){this._dirtyRay=true;this._rayLocal.origin.copy(n.transform.position);this._rayLocal.direction.set(0,0,-1);v0.copy(n.transform.orientation);v0.transformVector(this._rayLocal.direction,this._rayLocal.direction)}}};t._updateTransforms=function e(){if(this._dirtyLocal){this._dirtyLocal=false;this._localTransform.setTRS(this._localPosition,this._localRotation,ce.ONE)}var t=this._manager.camera.parent;if(t)this._worldTransform.mul2(t.getWorldTransform(),this._localTransform);else this._worldTransform.copy(this._localTransform)};t.getPosition=function e(){if(!this._position)return null;this._updateTransforms();this._worldTransform.getTranslation(this._position);return this._position};t.getLocalPosition=function e(){return this._localPosition};t.getRotation=function e(){if(!this._rotation)return null;this._updateTransforms();this._rotation.setFromMat4(this._worldTransform);return this._rotation};t.getDirection=function e(){this._updateRayTransforms();return this._ray.direction};t.hitTestStart=function e(t){if(t===void 0)t={};var i=this;t.profile=this._xrInputSource.profiles[0];var n=t.callback;t.callback=function(e,t){if(t)i.onHitTestSourceAdd(t);if(n)n(e,t)};this._manager.hitTest.start(t)};t.onHitTestSourceAdd=function e(n){this._hitTestSources.push(n);this.fire("hittest:add",n);n.on("result",function(e,t,i){if(i!==this)return;this.fire("hittest:result",n,e,t)},this);n.once("remove",function(){this.onHitTestSourceRemove(n);this.fire("hittest:remove",n)},this)};t.onHitTestSourceRemove=function e(t){var i=this._hitTestSources.indexOf(t);if(i!==-1)this._hitTestSources.splice(i,1)};U(e,[{key:"id",get:function e(){return this._id}},{key:"inputSource",get:function e(){return this._xrInputSource}},{key:"targetRayMode",get:function e(){return this._xrInputSource.targetRayMode}},{key:"handedness",get:function e(){return this._xrInputSource.handedness}},{key:"profiles",get:function e(){return this._xrInputSource.profiles}},{key:"grip",get:function e(){return this._grip}},{key:"hand",get:function e(){return this._hand}},{key:"gamepad",get:function e(){return this._xrInputSource.gamepad||null}},{key:"selecting",get:function e(){return this._selecting}},{key:"squeezing",get:function e(){return this._squeezing}},{key:"elementInput",get:function e(){return this._elementInput},set:function e(t){if(this._elementInput===t)return;this._elementInput=t;if(!this._elementInput)this._elementEntity=null}},{key:"elementEntity",get:function e(){return this._elementEntity}},{key:"hitTestSources",get:function e(){return this._hitTestSources}}]);return e}(u),b0=function(n){G(e,n);function e(e){var t;t=n.call(this)||this;var i=H(t);t.manager=e;t._session=null;t._inputSources=[];t._onInputSourcesChangeEvt=function(e){i._onInputSourcesChange(e)};t.manager.on("start",t._onSessionStart,H(t));t.manager.on("end",t._onSessionEnd,H(t));return t}var t=e.prototype;t._onSessionStart=function e(){this._session=this.manager.session;this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var i=this;this._session.addEventListener("select",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t.fire("select",e);i.fire("select",t,e)});this._session.addEventListener("selectstart",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t._selecting=true;t.fire("selectstart",e);i.fire("selectstart",t,e)});this._session.addEventListener("selectend",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t._selecting=false;t.fire("selectend",e);i.fire("selectend",t,e)});this._session.addEventListener("squeeze",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t.fire("squeeze",e);i.fire("squeeze",t,e)});this._session.addEventListener("squeezestart",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t._squeezing=true;t.fire("squeezestart",e);i.fire("squeezestart",t,e)});this._session.addEventListener("squeezeend",function(e){var t=i._getByInputSource(e.inputSource);t.update(e.frame);t._squeezing=false;t.fire("squeezeend",e);i.fire("squeezeend",t,e)});var t=this._session.inputSources;for(var n=0;n<t.length;n++)this._addInputSource(t[n])};t._onSessionEnd=function e(){var t=this._inputSources.length;while(t--){var i=this._inputSources[t];this._inputSources.splice(t,1);i.fire("remove");this.fire("remove",i)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt);this._session=null};t._onInputSourcesChange=function e(t){var i;for(i=0;i<t.removed.length;i++)this._removeInputSource(t.removed[i]);for(i=0;i<t.added.length;i++)this._addInputSource(t.added[i])};t._getByInputSource=function e(t){for(var i=0;i<this._inputSources.length;i++)if(this._inputSources[i].inputSource===t)return this._inputSources[i];return null};t._addInputSource=function e(t){if(this._getByInputSource(t))return;var i=new y0(this.manager,t);this._inputSources.push(i);this.fire("add",i)};t._removeInputSource=function e(t){for(var i=0;i<this._inputSources.length;i++){if(this._inputSources[i].inputSource!==t)continue;var n=this._inputSources[i];this._inputSources.splice(i,1);var r=n.hitTestSources.length;while(r--)n.hitTestSources[r].remove();n.fire("remove");this.fire("remove",n);return}};t.update=function e(t){for(var i=0;i<this._inputSources.length;i++)this._inputSources[i].update(t)};U(e,[{key:"inputSources",get:function e(){return this._inputSources}}]);return e}(u),x0=new ce,S0=new ce,w0=new ve,T0=new ve,M0=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._manager=e;t._supported=false;t._available=false;t._lightProbeRequested=false;t._lightProbe=null;t._intensity=0;t._rotation=new be;t._color=new ge;t._sphericalHarmonics=new Float32Array(27);t._manager.on("start",t._onSessionStart,H(t));t._manager.on("end",t._onSessionEnd,H(t));return t}var t=e.prototype;t._onSessionStart=function e(){var t=!!this._manager.session.requestLightProbe;if(!t)return;this._supported=true};t._onSessionEnd=function e(){this._supported=false;this._available=false;this._lightProbeRequested=false;this._lightProbe=null};t.start=function e(){var t;if(!this._manager.session)t=new Error("XR session is not running");if(!t&&this._manager.type!==Gy)t=new Error("XR session type is not AR");if(!t&&!this._supported)t=new Error("light-estimation is not supported");if(!t&&this._lightProbe||this._lightProbeRequested)t=new Error("light estimation is already requested");if(t){this.fire("error",t);return}var i=this;this._lightProbeRequested=true;this._manager.session.requestLightProbe().then(function(e){var t=i._lightProbeRequested;i._lightProbeRequested=false;if(i._manager.active){if(t)i._lightProbe=e}else i.fire("error",new Error("XR session is not active"))}).catch(function(e){i._lightProbeRequested=false;i.fire("error",e)})};t.end=function e(){this._lightProbeRequested=false;this._lightProbe=null;this._available=false};t.update=function e(t){if(!this._lightProbe)return;var i=t.getLightEstimate(this._lightProbe);if(!i)return;if(!this._available){this._available=true;this.fire("available")}var n=i.primaryLightIntensity;this._intensity=Math.max(1,Math.max(n.x,Math.max(n.y,n.z)));x0.copy(n).scale(1/this._intensity);this._color.set(x0.x,x0.y,x0.z);x0.set(0,0,0);S0.copy(i.primaryLightDirection);w0.setLookAt(S0,x0,ce.UP);T0.setFromAxisAngle(ce.RIGHT,90);w0.mul(T0);this._rotation.setFromMat4(w0);this._sphericalHarmonics.set(i.sphericalHarmonicsCoefficients)};U(e,[{key:"supported",get:function e(){return this._supported}},{key:"available",get:function e(){return this._available}},{key:"intensity",get:function e(){return this._available?this._intensity:null}},{key:"color",get:function e(){return this._available?this._color:null}},{key:"rotation",get:function e(){return this._available?this._rotation:null}},{key:"sphericalHarmonics",get:function e(){return this._available?this._sphericalHarmonics:null}}]);return e}(u),C0=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;i.destroy=function(){this._image=null;this._pose=null;if(this._bitmap){this._bitmap.close();this._bitmap=null}};i.getRotation=function(){if(this._pose)this._rotation.copy(this._pose.transform.orientation);return this._rotation};i._image=e;i._bitmap=null;i._width=t;i._measuredWidth=0;i._trackable=false;i._tracking=false;i._emulated=false;i._pose=null;i._position=new ce;i._rotation=new be;return i}var t=e.prototype;t.prepare=function e(){var t=this;if(this._bitmap)return{image:this._bitmap,widthInMeters:this._width};return createImageBitmap(this._image).then(function(e){t._bitmap=e;return{image:t._bitmap,widthInMeters:t._width}})};t.getPosition=function e(){if(this._pose)this._position.copy(this._pose.transform.position);return this._position};U(e,[{key:"image",get:function e(){return this._image}},{key:"width",get:function e(){return this._width},set:function e(t){this._width=t}},{key:"trackable",get:function e(){return this._trackable}},{key:"tracking",get:function e(){return this._tracking}},{key:"emulated",get:function e(){return this._emulated}}]);return e}(u),A0=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._manager=e;t._supported=!!window.XRImageTrackingResult;t._available=false;t._images=[];if(t._supported){t._manager.on("start",t._onSessionStart,H(t));t._manager.on("end",t._onSessionEnd,H(t))}return t}var t=e.prototype;t.add=function e(t,i){if(!this._supported||this._manager.active)return null;var n=new C0(t,i);this._images.push(n);return n};t.remove=function e(t){if(this._manager.active)return;var i=this._images.indexOf(t);if(i!==-1){t.destroy();this._images.splice(i,1)}};t._onSessionStart=function e(){var i=this;this._manager.session.getTrackedImageScores().then(function(e){i._available=true;for(var t=0;t<e.length;t++)i._images[t]._trackable=e[t]==="trackable"}).catch(function(e){i._available=false;i.fire("error",e)})};t._onSessionEnd=function e(){this._available=false;for(var t=0;t<this._images.length;t++){this._images[t]._pose=null;this._images[t]._measuredWidth=0;if(this._images[t]._tracking){this._images[t]._tracking=false;this._images[t].fire("untracked")}}};t.prepareImages=function e(t){if(this._images.length)Promise.all(this._images.map(function(e){return e.prepare()})).then(function(e){t(null,e)}).catch(function(e){t(e,null)});else t(null,null)};t.update=function e(t){if(!this._available)return;var i=t.getImageTrackingResults();var n={};var r;for(r=0;r<i.length;r++){n[i[r].index]=i[r];var s=this._images[i[r].index];s._emulated=i[r].trackingState==="emulated";s._measuredWidth=i[r].measuredWidthInMeters;s._dirtyTransform=true;s._pose=t.getPose(i[r].imageSpace,this._manager._referenceSpace)}for(r=0;r<this._images.length;r++)if(this._images[r]._tracking&&!n[r]){this._images[r]._tracking=false;this._images[r].fire("untracked")}else if(!this._images[r]._tracking&&n[r]){this._images[r]._tracking=true;this._images[r].fire("tracked")}};U(e,[{key:"supported",get:function e(){return this._supported}},{key:"available",get:function e(){return this._available}},{key:"images",get:function e(){return this._images}}]);return e}(u),P0=function(){function e(e){this._manager=e;this._supported=!!window.XRDOMOverlayState;this._root=null}U(e,[{key:"supported",get:function e(){return this._supported}},{key:"available",get:function e(){return this._supported&&this._manager.active&&this._manager._session.domOverlayState!==null}},{key:"state",get:function e(){if(!this._supported||!this._manager.active||!this._manager._session.domOverlayState)return null;return this._manager._session.domOverlayState.type}},{key:"root",set:function e(t){if(!this._supported||this._manager.active)return;this._root=t},get:function e(){return this._root}}]);return e}(),E0=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._manager=e;t._depthInfo=null;t._available=false;t._matrixDirty=false;t._matrix=new ve;t._emptyBuffer=new Uint8Array(32);t._depthBuffer=null;t._texture=new bu(t._manager.app.graphicsDevice,{format:Wt,mipmaps:false,addressU:We,addressV:We,minFilter:Ct,magFilter:Ct});t._manager.on("end",t._onSessionEnd,H(t));return t}var t=e.prototype;t._onSessionEnd=function e(){this._depthInfo=null;if(this._available){this._available=false;this.fire("unavailable")}this._depthBuffer=null;this._texture._width=4;this._texture._height=4;this._texture._levels[0]=this._emptyBuffer;this._texture.upload()};t._updateTexture=function e(){if(this._depthInfo){var t=false;if(this._depthInfo.width!==this._texture.width||this._depthInfo.height!==this._texture.height){this._texture._width=this._depthInfo.width;this._texture._height=this._depthInfo.height;this._matrixDirty=true;t=true}var i=this._depthInfo.data;this._depthBuffer=new Uint8Array(i.buffer,i.byteOffset,i.byteLength);this._texture._levels[0]=this._depthBuffer;this._texture.upload();if(t)this.fire("resize",this._depthInfo.width,this._depthInfo.height)}else if(this._depthBuffer){this._depthBuffer=null;this._texture._width=4;this._texture._height=4;this._texture._levels[0]=this._emptyBuffer;this._texture.upload()}};t.update=function e(t,i){if(i){if(!this._depthInfo)this._matrixDirty=true;this._depthInfo=t.getDepthInformation(i)}else{if(this._depthInfo)this._matrixDirty=true;this._depthInfo=null}this._updateTexture();if(this._matrixDirty){this._matrixDirty=false;if(this._depthInfo)this._matrix.data.set(this._depthInfo.normTextureFromNormView.matrix);else this._matrix.setIdentity()}if(this._depthInfo&&!this._available){this._available=true;this.fire("available")}else if(!this._depthInfo&&this._available){this._available=false;this.fire("unavailable")}};t.getDepth=function e(t,i){if(!this._depthInfo)return null;return this._depthInfo.getDepth(t,i)};U(e,[{key:"supported",get:function e(){return!!window.XRDepthInformation}},{key:"available",get:function e(){return this._available}},{key:"width",get:function e(){return this._depthInfo&&this._depthInfo.width||0}},{key:"height",get:function e(){return this._depthInfo&&this._depthInfo.height||0}},{key:"texture",get:function e(){return this._texture}},{key:"uvMatrix",get:function e(){return this._matrix}}]);return e}(u),I0=function(n){G(e,n);function e(e){var t;t=n.call(this)||this;var i=H(t);t.app=e;t._supported=!!navigator.xr;t._available={};t._available[Vy]=false;t._available[Uy]=false;t._available[Gy]=false;t._type=null;t._spaceType=null;t._session=null;t._baseLayer=null;t._referenceSpace=null;t.depthSensing=new E0(H(t));t.domOverlay=new P0(H(t));t.hitTest=new a0(H(t));t.imageTracking=new A0(H(t));t.input=new b0(H(t));t.lightEstimation=new M0(H(t));t._camera=null;t.views=[];t.viewsPool=[];t._localPosition=new ce;t._localRotation=new be;t._depthNear=.1;t._depthFar=1e3;t._width=0;t._height=0;if(t._supported){navigator.xr.addEventListener("devicechange",function(){i._deviceAvailabilityCheck()});t._deviceAvailabilityCheck()}return t}var t=e.prototype;t.start=function e(t,i,n,r){var s=this;var a=r;if(typeof r==="object")a=r.callback;if(!this._available[i]){if(a)a(new Error("XR is not available"));return}if(this._session){if(a)a(new Error("XR session is already started"));return}this._camera=t;this._camera.camera.xr=this;this._type=i;this._spaceType=n;this._setClipPlanes(t.nearClip,t.farClip);var o={requiredFeatures:[n],optionalFeatures:[]};if(i===Gy){o.optionalFeatures.push("light-estimation");o.optionalFeatures.push("hit-test");o.optionalFeatures.push("depth-sensing");if(r&&r.imageTracking)o.optionalFeatures.push("image-tracking");if(this.domOverlay.root){o.optionalFeatures.push("dom-overlay");o.domOverlay={root:this.domOverlay.root}}}else if(i===Uy)o.optionalFeatures.push("hand-tracking");if(r&&r.optionalFeatures)o.optionalFeatures=o.optionalFeatures.concat(r.optionalFeatures);if(this.imageTracking.images.length)this.imageTracking.prepareImages(function(e,t){if(e){if(a)a(e);s.fire("error",e);return}if(t!==null)o.trackedImages=t;s._onStartOptionsReady(i,n,o,a)});else s._onStartOptionsReady(i,n,o,a)};t._onStartOptionsReady=function e(t,i,n,r){var s=this;navigator.xr.requestSession(t,n).then(function(e){s._onSessionStart(e,i,r)}).catch(function(e){s._camera.camera.xr=null;s._camera=null;s._type=null;s._spaceType=null;if(r)r(e);s.fire("error",e)})};t.end=function e(t){if(!this._session){if(t)t(new Error("XR Session is not initialized"));return}if(t)this.once("end",t);this._session.end()};t.isAvailable=function e(t){return this._available[t]};t._deviceAvailabilityCheck=function e(){for(var t in this._available)this._sessionSupportCheck(t)};t._sessionSupportCheck=function e(t){var i=this;navigator.xr.isSessionSupported(t).then(function(e){if(i._available[t]===e)return;i._available[t]=e;i.fire("available",t,e);i.fire("available:"+t,e)}).catch(function(e){i.fire("error",e)})};t._onSessionStart=function e(t,i,n){var r=this;var s=false;this._session=t;var a=function e(){r.fire("visibility:change",t.visibilityState)};var o=function e(){r._setClipPlanes(r._camera.nearClip,r._camera.farClip)};var l=function e(){r._session=null;r._referenceSpace=null;r.views=[];r._width=0;r._height=0;r._type=null;r._spaceType=null;if(r._camera){r._camera.off("set_nearClip",o);r._camera.off("set_farClip",o);r._camera.camera.xr=null;r._camera=null}t.removeEventListener("end",e);t.removeEventListener("visibilitychange",a);if(!s)r.fire("end");r.app.tick()};t.addEventListener("end",l);t.addEventListener("visibilitychange",a);this._camera.on("set_nearClip",o);this._camera.on("set_farClip",o);this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl);t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar});t.requestReferenceSpace(i).then(function(e){r._referenceSpace=e;r.app.tick();if(n)n(null);r.fire("start")}).catch(function(e){s=true;t.end();if(n)n(e);r.fire("error",e)})};t._setClipPlanes=function e(t,i){if(this._depthNear===t&&this._depthFar===i)return;this._depthNear=t;this._depthFar=i;if(!this._session)return;this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar})};t.update=function e(t){if(!this._session)return;var i,n,r,s,a;var o;var l=t.session.renderState.baseLayer.framebufferWidth;var h=t.session.renderState.baseLayer.framebufferHeight;if(this._width!==l||this._height!==h){this._width=l;this._height=h;this.app.graphicsDevice.setResolution(l,h)}var c=t.getViewerPose(this._referenceSpace);o=c?c.views.length:0;if(o>this.views.length)for(i=0;i<=o-this.views.length;i++){n=this.viewsPool.pop();if(!n)n={viewport:new ue,projMat:new ve,viewMat:new ve,viewOffMat:new ve,viewInvMat:new ve,viewInvOffMat:new ve,projViewOffMat:new ve,viewMat3:new le,position:new Float32Array(3),rotation:new be};this.views.push(n)}else if(o<=this.views.length)for(i=0;i<this.views.length-o;i++)this.viewsPool.push(this.views.pop());if(c){var u=c.transform.position;var f=c.transform.orientation;this._localPosition.set(u.x,u.y,u.z);this._localRotation.set(f.x,f.y,f.z,f.w);s=t.session.renderState.baseLayer;for(i=0;i<c.views.length;i++){r=c.views[i];n=this.views[i];a=s.getViewport(r);n.viewport.x=a.x;n.viewport.y=a.y;n.viewport.z=a.width;n.viewport.w=a.height;n.projMat.set(r.projectionMatrix);n.viewMat.set(r.transform.inverse.matrix);n.viewInvMat.set(r.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition);this._camera.camera._node.setLocalRotation(this._localRotation);this.input.update(t);if(this._type===Gy){if(this.hitTest.supported)this.hitTest.update(t);if(this.lightEstimation.supported)this.lightEstimation.update(t);if(this.depthSensing.supported)this.depthSensing.update(t,c&&c.views[0]);if(this.imageTracking.supported)this.imageTracking.update(t)}this.fire("update",t)};U(e,[{key:"supported",get:function e(){return this._supported}},{key:"active",get:function e(){return!!this._session}},{key:"type",get:function e(){return this._type}},{key:"spaceType",get:function e(){return this._spaceType}},{key:"session",get:function e(){return this._session}},{key:"visibilityState",get:function e(){if(!this._session)return null;return this._session.visibilityState}},{key:"camera",get:function e(){return this._camera?this._camera.entity:null}}]);return e}(u),R0=function(n){G(i,n);function i(e,t){var i;i=n.call(this)||this;i.system=e;i.entity=t;if(i.system.schema&&!i._accessorsBuilt)i.buildAccessors(i.system.schema);i.on("set",function(e,t,i){this.fire("set_"+e,e,t,i)});i.on("set_enabled",i.onSetEnabled,H(i));return i}i._buildAccessors=function e(t,i){i.forEach(function(e){var r=typeof e==="object"?e.name:e;Object.defineProperty(t,r,{get:function e(){return this.data[r]},set:function e(t){var i=this.data;var n=i[r];i[r]=t;this.fire("set",r,n,t)},configurable:true})});t._accessorsBuilt=true};var e=i.prototype;e.buildAccessors=function e(t){i._buildAccessors(this,t)};e.onSetEnabled=function e(t,i,n){if(i!==n)if(this.entity.enabled)if(n)this.onEnable();else this.onDisable()};e.onEnable=function e(){};e.onDisable=function e(){};e.onPostStateChange=function e(){};U(i,[{key:"data",get:function e(){var t=this.system.store[this.entity.getGuid()];return t?t.data:null}}]);return i}(u),L0=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t.app=e;t.store={};t.schema=[];return t}e._helper=function e(t,i){for(var n=0,r=t.length;n<r;n++)t[n].f.call(t[n].s,i)};e.initialize=function e(t){this._helper(this._init,t)};e.postInitialize=function e(t){this._helper(this._postInit,t);this.fire("postinitialize",t)};e.update=function e(t,i){this._helper(i?this._toolsUpdate:this._update,t)};e.animationUpdate=function e(t,i){this._helper(this._animationUpdate,t)};e.fixedUpdate=function e(t,i){this._helper(this._fixedUpdate,t)};e.postUpdate=function e(t,i){this._helper(this._postUpdate,t)};e.bind=function e(t,i,n){switch(t){case"initialize":this._init.push({f:i,s:n});break;case"postInitialize":this._postInit.push({f:i,s:n});break;case"update":this._update.push({f:i,s:n});break;case"animationUpdate":this._animationUpdate.push({f:i,s:n});break;case"postUpdate":this._postUpdate.push({f:i,s:n});break;case"fixedUpdate":this._fixedUpdate.push({f:i,s:n});break;case"toolsUpdate":this._toolsUpdate.push({f:i,s:n});break;default:console.error("Component System does not support event",t)}};e._erase=function e(t,i,n){for(var r=0;r<t.length;r++)if(t[r].f===i&&t[r].s===n)t.splice(r--,1)};e.unbind=function e(t,i,n){switch(t){case"initialize":this._erase(this._init,i,n);break;case"postInitialize":this._erase(this._postInit,i,n);break;case"update":this._erase(this._update,i,n);break;case"animationUpdate":this._erase(this._animationUpdate,i,n);break;case"postUpdate":this._erase(this._postUpdate,i,n);break;case"fixedUpdate":this._erase(this._fixedUpdate,i,n);break;case"toolsUpdate":this._erase(this._toolsUpdate,i,n);break;default:console.error("Component System does not support event",t)}};var t=e.prototype;t.addComponent=function e(t,i){var n=new this.ComponentType(this,t);var r=new this.DataType;i=i||{};this.store[t.getGuid()]={entity:t,data:r};t[this.id]=n;t.c[this.id]=n;this.initializeComponentData(n,i,[]);this.fire("add",t,n);return n};t.removeComponent=function e(t){var i=this.store[t.getGuid()];var n=t.c[this.id];this.fire("beforeremove",t,n);delete this.store[t.getGuid()];delete t[this.id];delete t.c[this.id];this.fire("remove",t,i.data)};t.cloneComponent=function e(t,i){var n=this.store[t.getGuid()];return this.addComponent(i,n.data)};t.initializeComponentData=function e(t,i,n){if(i===void 0)i={};var r;var s,a,o;for(var l=0,h=n.length;l<h;l++){r=n[l];if(typeof r==="object"){s=r.name;a=r.type}else{s=r;a=undefined}o=i[s];if(o!==undefined){if(a!==undefined)o=D0(o,a);t[s]=o}else t[s]=t.data[s]}if(t.enabled&&t.entity.enabled)t.onEnable()};t.getPropertiesOfType=function e(t){var i=[];var n=this.schema||[];n.forEach(function(e){if(e&&typeof e==="object"&&e.type===t)i.push(e)});return i};t.destroy=function e(){this.off()};return e}(u);function D0(e,t){if(!e)return e;switch(t){case"rgb":if(e instanceof ge)return e.clone();return new ge(e[0],e[1],e[2]);case"rgba":if(e instanceof ge)return e.clone();return new ge(e[0],e[1],e[2],e[3]);case"vec2":if(e instanceof he)return e.clone();return new he(e[0],e[1]);case"vec3":if(e instanceof ce)return e.clone();return new ce(e[0],e[1],e[2]);case"vec4":if(e instanceof ue)return e.clone();return new ue(e[0],e[1],e[2],e[3]);case"boolean":case"number":case"string":return e;case"entity":return e;default:throw new Error("Could not convert unhandled type: "+t)}}L0._init=[],L0._postInit=[],L0._toolsUpdate=[],L0._update=[],L0._animationUpdate=[],L0._fixedUpdate=[],L0._postUpdate=[],f.attach(L0),L0.destroy=function(){L0.off("initialize");L0.off("postInitialize");L0.off("toolsUpdate");L0.off("update");L0.off("animationUpdate");L0.off("fixedUpdate");L0.off("postUpdate");L0._init=[];L0._postInit=[];L0._toolsUpdate=[];L0._update=[];L0._animationUpdate=[];L0._fixedUpdate=[];L0._postUpdate=[]};var k0=function(){function e(){this._left=Infinity;this._right=-Infinity;this._len=0;this._recip=0;this._p0=0;this._p1=0;this._t=0;this._hermite={valid:false,p0:0,m0:0,p1:0,m1:0}}var t=e.prototype;t.update=function e(t,i){if(t<this._left||t>=this._right){var n=i.length;if(!n){this._left=-Infinity;this._right=Infinity;this._len=0;this._recip=0;this._p0=this._p1=0}else if(t<i[0]){this._left=-Infinity;this._right=i[0];this._len=0;this._recip=0;this._p0=this._p1=0}else if(t>=i[n-1]){this._left=i[n-1];this._right=Infinity;this._len=0;this._recip=0;this._p0=this._p1=n-1}else{var r=this._findKey(t,i);this._left=i[r];this._right=i[r+1];this._len=this._right-this._left;var s=1/this._len;this._recip=isFinite(s)?s:0;this._p0=r;this._p1=r+1}}this._t=this._recip===0?0:(t-this._left)*this._recip;this._hermite.valid=false};t._findKey=function e(t,i){var n=0;while(t>=i[n+1])n++;return n};t.eval=function e(t,i,n){var r=n._data;var s=n._components;var a=this._p0*s;var o;if(i===i_)for(o=0;o<s;++o)t[o]=r[a+o];else{var l=this._t;var h=this._p1*s;switch(i){case n_:for(o=0;o<s;++o)t[o]=Pe.lerp(r[a+o],r[h+o],l);break;case r_:var c=this._hermite;if(!c.valid){var u=l*l;var f=l+l;var d=1-l;var p=d*d;c.valid=true;c.p0=(1+f)*p;c.m0=l*p;c.p1=u*(3-f);c.m1=u*(l-1)}var m=(this._p0*3+1)*s;var _=(this._p0*3+2)*s;var v=(this._p1*3+1)*s;var g=(this._p1*3+0)*s;for(o=0;o<s;++o)t[o]=c.p0*r[m+o]+c.m0*r[_+o]*this._len+c.p1*r[v+o]+c.m1*r[g+o]*this._len;break}}};return e}(),O0=function e(t){this._name=t.name+"Snapshot";this._time=-1;this._cache=[];this._results=[];var i;for(i=0;i<t._inputs.length;++i)this._cache[i]=new k0;var n=t._curves;var r=t._outputs;for(i=0;i<n.length;++i){var s=n[i];var a=r[s._output];var o=[];for(var l=0;l<a._components;++l)o[l]=0;this._results[i]=o}},F0=function(){function e(e,t,i,n,r){this._name=e.name;this._track=e;this._snapshot=new O0(e);this._playing=n;this._time=t;this._speed=i;this._loop=r;this._blendWeight=1;this._blendOrder=0}var t=e.prototype;t._update=function e(t){if(this._playing){var i=this._time;var n=this._track.duration;var r=this._speed;var s=this._loop;i+=r*t;if(r>=0){if(i>n)if(s)i=i%n||0;else{i=this._track.duration;this.pause()}}else if(i<0)if(s)i=n+(i%n||0);else{i=0;this.pause()}this._time=i}if(this._time!=this._snapshot._time)this._track.eval(this._time,this._snapshot)};t.play=function e(){this._playing=true;this._time=0};t.stop=function e(){this._playing=false;this._time=0};t.pause=function e(){this._playing=false};t.resume=function e(){this._playing=true};t.reset=function e(){this._time=0};U(e,[{key:"name",get:function e(){return this._name},set:function e(t){this._name=t}},{key:"track",get:function e(){return this._track}},{key:"snapshot",get:function e(){return this._snapshot}},{key:"time",get:function e(){return this._time},set:function e(t){this._time=t}},{key:"speed",get:function e(){return this._speed},set:function e(t){this._speed=t}},{key:"loop",get:function e(){return this._loop},set:function e(t){this._loop=t}},{key:"blendWeight",get:function e(){return this._blendWeight},set:function e(t){this._blendWeight=t}},{key:"blendOrder",get:function e(){return this._blendOrder},set:function e(t){this._blendOrder=t}}]);return e}(),B0=function(){function v(e){this._binder=e;this._clips=[];this._inputs=[];this._outputs=[];this._targets={}}v._dot=function e(t,i){var n=t.length;var r=0;for(var s=0;s<n;++s)r+=t[s]*i[s];return r};v._normalize=function e(t){var i=v._dot(t,t);if(i>0){i=1/Math.sqrt(i);var n=t.length;for(var r=0;r<n;++r)t[r]*=i}};v._set=function e(t,i,n){var r=t.length;var s;if(n==="quaternion"){var a=v._dot(i,i);if(a>0)a=1/Math.sqrt(a);for(s=0;s<r;++s)t[s]=i[s]*a}else for(s=0;s<r;++s)t[s]=i[s]};v._blendVec=function e(t,i,n){var r=1-n;var s=t.length;for(var a=0;a<s;++a)t[a]=t[a]*r+i[a]*n};v._blendQuat=function e(t,i,n){var r=t.length;var s=1-n;if(v._dot(t,i)<0)n=-n;for(var a=0;a<r;++a)t[a]=t[a]*s+i[a]*n;v._normalize(t)};v._blend=function e(t,i,n,r){if(r==="quaternion")v._blendQuat(t,i,n);else v._blendVec(t,i,n)};v._stableSort=function e(t,i){var n=t.length;for(var r=0;r<n-1;++r)for(var s=r+1;s<n;++s)if(i(t[s],t[r])){var a=t[r];t[r]=t[s];t[s]=a}};var e=v.prototype;e.addClip=function e(t){var i=this._targets;var n=t.track.curves;var r=t.snapshot;var s=[];var a=[];for(var o=0;o<n.length;++o){var l=n[o];var h=l.paths;for(var c=0;c<h.length;++c){var u=h[c];var f=i[u];if(!f){var d=this._binder.resolve(u);if(d){f={target:d,value:[],curves:0,blendCounter:0};for(var p=0;p<f.target.components;++p)f.value.push(0);i[u]=f}}if(f){f.curves++;s.push(r._results[o]);a.push(f)}}}this._clips.push(t);this._inputs.push(s);this._outputs.push(a)};e.removeClip=function e(t){var i=this._targets;var n=this._clips;var r=n[t];var s=r.track.curves;for(var a=0;a<s.length;++a){var o=s[a];var l=o.paths;for(var h=0;h<l.length;++h){var c=l[h];var u=i[c];if(u){u.curves--;if(u.curves===0){this._binder.unresolve(c);delete i[c]}}}}n.splice(t,1);this._inputs.splice(t,1);this._outputs.splice(t,1)};e.removeClips=function e(){while(this._clips.length>0)this.removeClip(0)};e.findClip=function e(t){var i=this._clips;for(var n=0;n<i.length;++n){var r=i[n];if(r.name===t)return r}return null};e.update=function e(t){var i=this._clips;var n=i.map(function(e,t){return t});v._stableSort(n,function(e,t){return i[e].blendOrder<i[t].blendOrder});var r,s;for(r=0;r<i.length;++r){var a=n[r];var o=i[a];var l=this._inputs[a];var h=this._outputs[a];var c=o.blendWeight;if(c>0)o._update(t);var u;var f;var d;if(c>=1)for(s=0;s<l.length;++s){u=l[s];f=h[s];d=f.value;v._set(d,u,f.target.type);f.blendCounter++}else if(c>0)for(s=0;s<l.length;++s){u=l[s];f=h[s];d=f.value;if(f.blendCounter===0)v._set(d,u,f.target.type);else v._blend(d,u,c,f.target.type);f.blendCounter++}}var p=this._targets;for(var m in p)if(p.hasOwnProperty(m)){var _=p[m];_.target.func(_.value);_.blendCounter=0}this._binder.update(t)};U(v,[{key:"clips",get:function e(){return this._clips}}]);return v}(),N0=function(){function e(e,t,i){this._func=e;this._type=t;this._components=i}U(e,[{key:"func",get:function e(){return this._func}},{key:"type",get:function e(){return this._type}},{key:"components",get:function e(){return this._components}}]);return e}(),z0=function(){function e(e){this.graph=e;if(!e)return;var n={};var t=function e(t){n[t.name]=t;for(var i=0;i<t.children.length;++i)e(t.children[i])};t(e);this.nodes=n;var a=function e(t){var i=t;while(i&&!(i instanceof Nv))i=i.parent;var n;if(i)if(i.render)n=i.render.meshInstances;else if(i.model)n=i.model.meshInstances;return n};this.nodeCounts={};this.activeNodes=[];this.handlers={localPosition:function e(t){var i=t.localPosition;var n=function e(t){i.set.apply(i,t)};return new N0(n,"vector",3)},localRotation:function e(t){var i=t.localRotation;var n=function e(t){i.set.apply(i,t)};return new N0(n,"quaternion",4)},localScale:function e(t){var i=t.localScale;var n=function e(t){i.set.apply(i,t)};return new N0(n,"vector",3)},weights:function e(t){var i=a(t);if(i){var n;for(var r=0;r<i.length;++r)if(i[r].node.name===t.name&&i[r].morphInstance){n=i[r].morphInstance;break}if(n){var s=function e(t){for(var i=0;i<t.length;++i)n.setWeight(i,t[i])};return new N0(s,"vector",n.morph._targets.length)}}return null},materialTexture:function(e,i){var t=a(e);if(t){var n;for(var r=0;r<t.length;++r)if(t[r].node.name===e.name){n=t[r];break}if(n){var s=function(e){var t=this.animComponent.system.app.assets.get(e[0]);if(t&&t.resource&&t.type==="texture"){n.material[i]=t.resource;n.material.update()}}.bind(this);return new N0(s,"vector",1)}}return null}.bind(this)}}var t=e.prototype;t.resolve=function e(t){var i=t_.decode(t);var n=this.graph.root.findByPath(this.graph.path+"/"+(i.entityPath[0]||""));if(!n){var r=t_.splitPath(i.entityPath[0],"/");n=this.nodes[r[r.length-1]||""]}if(!n)return null;var s=this.handlers[i.propertyPath[0]];if(!s)return null;var a=s(n);if(!a)return null;if(!this.nodeCounts[n.path]){this.activeNodes.push(n);this.nodeCounts[n.path]=1}else this.nodeCounts[n.path]++;return a};t.unresolve=function e(t){var i=t_.decode(t);if(i.component!=="graph")return;var n=t_.splitPath(i.entityPath[0],"/");var r=this.nodes[n[n.length-1]||""];this.nodeCounts[r.path]--;if(this.nodeCounts[r.path]===0){var s=this.activeNodes;var a=s.indexOf(r.node);var o=s.length;if(a<o-1)s[a]=s[o-1];s.pop()}};t.update=function e(t){var i=this.activeNodes;for(var n=0;n<i.length;++n)i[n]._dirtifyLocal()};return e}(),V0=function(){function e(){this._written=false;this._name="";this._keyFrames=[];this._quat=new be;this._pos=new ce;this._scale=new ce;this._targetNode=null}var t=e.prototype;t.getTarget=function e(){return this._targetNode};t.setTarget=function e(t){this._targetNode=t};return e}(),U0=function(){function e(e){this._animation=null;this._time=0;this.looping=true;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var n=this;function r(e){var t=new V0;t._name=e.name;n._interpolatedKeys.push(t);n._interpolatedKeyDict[e.name]=t;n._currKeyIndices[e.name]=0;for(var i=0;i<e._children.length;i++)r(e._children[i])}r(e)}var t=e.prototype;t.addTime=function e(t){if(this._animation!==null){var i;var n,r;var s,a;var o,l,h;var c=this._animation._nodes;var u=this._animation.duration;if(this._time===u&&!this.looping)return;this._time+=t;if(this._time>u){this._time=this.looping?0:u;for(i=0;i<c.length;i++){n=c[i];r=n._name;this._currKeyIndices[r]=0}}else if(this._time<0){this._time=this.looping?u:0;for(i=0;i<c.length;i++){n=c[i];r=n._name;this._currKeyIndices[r]=n._keys.length-2}}var f=t>=0?1:-1;var d;for(i=0;i<c.length;i++){n=c[i];r=n._name;s=n._keys;a=this._interpolatedKeyDict[r];if(a===undefined)continue;d=false;if(s.length!==1)for(var p=this._currKeyIndices[r];p<s.length-1&&p>=0;p+=f){o=s[p];l=s[p+1];if(o.time<=this._time&&l.time>=this._time){h=(this._time-o.time)/(l.time-o.time);a._pos.lerp(o.position,l.position,h);a._quat.slerp(o.rotation,l.rotation,h);a._scale.lerp(o.scale,l.scale,h);a._written=true;this._currKeyIndices[r]=p;d=true;break}}if(s.length===1||!d&&this._time===0&&this.looping){a._pos.copy(s[0].position);a._quat.copy(s[0].rotation);a._scale.copy(s[0].scale);a._written=true}}}};t.blend=function e(t,i,n){var r=this._interpolatedKeys.length;for(var s=0;s<r;s++){var a=t._interpolatedKeys[s];var o=i._interpolatedKeys[s];var l=this._interpolatedKeys[s];if(a._written&&o._written){l._quat.slerp(a._quat,i._interpolatedKeys[s]._quat,n);l._pos.lerp(a._pos,i._interpolatedKeys[s]._pos,n);l._scale.lerp(a._scale,o._scale,n);l._written=true}else if(a._written){l._quat.copy(a._quat);l._pos.copy(a._pos);l._scale.copy(a._scale);l._written=true}else if(o._written){l._quat.copy(o._quat);l._pos.copy(o._pos);l._scale.copy(o._scale);l._written=true}}};t.setGraph=function e(t){var i;this.graph=t;if(t)for(i=0;i<this._interpolatedKeys.length;i++){var n=this._interpolatedKeys[i];var r=t.findByName(n._name);this._interpolatedKeys[i].setTarget(r)}else for(i=0;i<this._interpolatedKeys.length;i++)this._interpolatedKeys[i].setTarget(null)};t.updateGraph=function e(){if(this.graph)for(var t=0;t<this._interpolatedKeys.length;t++){var i=this._interpolatedKeys[t];if(i._written){var n=i.getTarget();n.localPosition.copy(i._pos);n.localRotation.copy(i._quat);n.localScale.copy(i._scale);if(!n._dirtyLocal)n._dirtifyLocal();i._written=false}}};U(e,[{key:"animation",get:function e(){return this._animation},set:function e(t){this._animation=t;this.currentTime=0}},{key:"currentTime",get:function e(){return this._time},set:function e(t){this._time=t;var i=this._interpolatedKeys.length;for(var n=0;n<i;n++){var r=this._interpolatedKeys[n];var s=r._name;this._currKeyIndices[s]=0}this.addTime(0);this.updateGraph()}},{key:"numNodes",get:function e(){return this._interpolatedKeys.length}}]);return e}(),G0=function(l){G(e,l);function e(e,t){var i;i=l.call(this,e,t)||this;i.animationsIndex={};i.on("set_animations",i.onSetAnimations,H(i));i.on("set_assets",i.onSetAssets,H(i));i.on("set_loop",i.onSetLoop,H(i));return i}var t=e.prototype;t.play=function e(t,i){if(!this.enabled||!this.entity.enabled)return;var n=this.data;if(!n.animations[t])return;i=i||0;n.prevAnim=n.currAnim;n.currAnim=t;if(n.model){if(!n.skeleton&&!n.animEvaluator)this._createAnimationController();var r=n.animations[n.prevAnim];var s=n.animations[n.currAnim];n.blending=i>0&&n.prevAnim;if(n.blending){n.blend=0;n.blendSpeed=1/i}if(n.skeleton)if(n.blending){n.fromSkel.animation=r;n.fromSkel.addTime(n.skeleton._time);n.toSkel.animation=s}else n.skeleton.animation=s;if(n.animEvaluator){var a=n.animEvaluator;if(n.blending)while(a.clips.length>1)a.removeClip(0);else n.animEvaluator.removeClips();var o=new F0(n.animations[n.currAnim],0,1,true,n.loop);o.name=n.currAnim;o.blendWeight=n.blending?0:1;o.reset();n.animEvaluator.addClip(o)}}n.playing=true};t.getAnimation=function e(t){return this.data.animations[t]};t.setModel=function e(t){var i=this.data;if(t!==i.model){this._resetAnimationController();i.model=t;if(i.animations&&i.currAnim&&i.animations[i.currAnim])this.play(i.currAnim)}};t._resetAnimationController=function e(){var t=this.data;t.skeleton=null;t.fromSkel=null;t.toSkel=null;t.animEvaluator=null};t._createAnimationController=function e(){var t=this.data;var i=t.model;var n=t.animations;var r=false;var s=false;for(var a in n)if(n.hasOwnProperty(a)){var o=n[a];if(o.constructor===e_)s=true;else r=true}var l=i.getGraph();if(r){t.fromSkel=new U0(l);t.toSkel=new U0(l);t.skeleton=new U0(l);t.skeleton.looping=t.loop;t.skeleton.setGraph(l)}else if(s)t.animEvaluator=new B0(new z0(l))};t.loadAnimationAssets=function e(t){if(!t||!t.length)return;var n=this;var i=this.system.app.assets;var r,s=t.length;var a=function e(t){if(t.resources.length>1)for(var i=0;i<t.resources.length;i++){n.animations[t.resources[i].name]=t.resources[i];n.animationsIndex[t.id]=t.resources[i].name}else{n.animations[t.name]=t.resource;n.animationsIndex[t.id]=t.name}n.animations=n.animations};var o=function e(t){t.off("change",n.onAssetChanged,n);t.on("change",n.onAssetChanged,n);t.off("remove",n.onAssetRemoved,n);t.on("remove",n.onAssetRemoved,n);if(t.resource)a(t);else{t.once("load",a,n);if(n.enabled&&n.entity.enabled)i.load(t)}};for(r=0;r<s;r++){var l=i.get(t[r]);if(l)o(l);else i.on("add:"+t[r],o)}};t.onAssetChanged=function e(t,i,n,r){var s;if(i==="resource"||i==="resources"){if(i==="resources"&&n&&n.length===0)n=null;if(n){var a=false;if(n.length>1){if(r&&r.length>1)for(s=0;s<r.length;s++)delete this.animations[r[s].name];else delete this.animations[t.name];a=false;for(s=0;s<n.length;s++){this.animations[n[s].name]=n[s];if(!a&&this.data.currAnim===n[s].name)if(this.data.playing&&this.data.enabled&&this.entity.enabled){a=true;this.play(n[s].name,0)}}if(!a){this._stopCurrentAnimation();this.onSetAnimations()}}else{if(r&&r.length>1)for(s=0;s<r.length;s++)delete this.animations[r[s].name];this.animations[t.name]=n[0]||n;a=false;if(this.data.currAnim===t.name)if(this.data.playing&&this.data.enabled&&this.entity.enabled){a=true;this.play(t.name,0)}if(!a){this._stopCurrentAnimation();this.onSetAnimations()}}this.animationsIndex[t.id]=t.name}else{if(r.length>1)for(s=0;s<r.length;s++){delete this.animations[r[s].name];if(this.data.currAnim===r[s].name)this._stopCurrentAnimation()}else{delete this.animations[t.name];if(this.data.currAnim===t.name)this._stopCurrentAnimation()}delete this.animationsIndex[t.id]}}};t.onAssetRemoved=function e(t){t.off("remove",this.onAssetRemoved,this);if(this.animations){if(t.resources.length>1)for(var i=0;i<t.resources.length;i++){delete this.animations[t.resources[i].name];if(this.data.currAnim===t.resources[i].name)this._stopCurrentAnimation()}else{delete this.animations[t.name];if(this.data.currAnim===t.name)this._stopCurrentAnimation()}delete this.animationsIndex[t.id]}};t._stopCurrentAnimation=function e(){var t=this.data;t.currAnim=null;t.playing=false;if(t.skeleton){t.skeleton.currentTime=0;t.skeleton.animation=null}if(t.animEvaluator){for(var i=0;i<t.animEvaluator.clips.length;++i)t.animEvaluator.clips[i].stop();t.animEvaluator.update(0);t.animEvaluator.removeClips()}};t.onSetAnimations=function e(t,i,n){var r=this.data;var s=this.entity.model;if(s){var a=s.model;if(a&&a!==r.model)this.setModel(a)}if(!r.currAnim&&r.activate&&r.enabled&&this.entity.enabled)for(var o in r.animations){this.play(o,0);break}};t.onSetAssets=function e(t,i,n){if(i&&i.length)for(var r=0;r<i.length;r++)if(i[r]){var s=this.system.app.assets.get(i[r]);if(s){s.off("change",this.onAssetChanged,this);s.off("remove",this.onAssetRemoved,this);var a=this.animationsIndex[s.id];if(this.data.currAnim===a)this._stopCurrentAnimation();delete this.animations[a];delete this.animationsIndex[s.id]}}var o=n.map(function(e){return e instanceof O_?e.id:e});this.loadAnimationAssets(o)};t.onSetLoop=function e(t,i,n){var r=this.data;if(r.skeleton)r.skeleton.looping=r.loop;if(r.animEvaluator)for(var s=0;s<r.animEvaluator.clips.length;++s)r.animEvaluator.clips[s].loop=r.loop};t.onSetCurrentTime=function e(t,i,n){var r=this.data;if(r.skeleton){var s=r.skeleton;s.currentTime=n;s.addTime(0);s.updateGraph()}if(r.animEvaluator){var a=r.animEvaluator;for(var o=0;o<a.clips.length;++o)a.clips[o].time=n}};t.onEnable=function e(){l.prototype.onEnable.call(this);var t=this.data;var i=t.assets;var n=this.system.app.assets;if(i)for(var r=0,s=i.length;r<s;r++){var a=i[r];if(!(a instanceof O_))a=n.get(a);if(a&&!a.resource)n.load(a)}if(t.activate&&!t.currAnim)for(var o in t.animations){this.play(o,0);break}};t.onBeforeRemove=function e(){for(var t=0;t<this.assets.length;t++){var i=this.assets[t];if(typeof i==="number")i=this.system.app.assets.get(i);if(!i)continue;i.off("change",this.onAssetChanged,this);i.off("remove",this.onAssetRemoved,this)}var n=this.data;delete n.animation;delete n.skeleton;delete n.fromSkel;delete n.toSkel;delete n.animEvaluator};U(e,[{key:"currentTime",get:function e(){var t=this.data;if(t.skeleton)return this.data.skeleton._time;if(t.animEvaluator){var i=t.animEvaluator.clips;if(i.length>0)return i[i.length-1].time}return 0},set:function e(t){var i=this.data;if(i.skeleton){var n=i.skeleton;n.currentTime=t;n.addTime(0);n.updateGraph()}if(i.animEvaluator){var r=i.animEvaluator;for(var s=0;s<r.clips.length;++s)r.clips[s].time=t}}},{key:"duration",get:function e(){return this.data.animations[this.data.currAnim].duration}}]);return e}(R0),H0=function e(){this.assets=[];this.speed=1;this.loop=true;this.activate=true;this.enabled=true;this.animations={};this.model=null;this.prevAnim=null;this.currAnim=null;this.blending=false;this.blend=0;this.blendSpeed=0;this.playing=false;this.skeleton=null;this.fromSkel=null;this.toSkel=null;this.animEvaluator=null},W0=["enabled","assets","speed","loop","activate","animations","skeleton","model","prevAnim","currAnim","fromSkel","toSkel","blending","blendTimeRemaining","playing"],j0=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="animation";t.ComponentType=G0;t.DataType=H0;t.schema=W0;t.on("beforeremove",t.onBeforeRemove,H(t));t.on("update",t.onUpdate,H(t));L0.bind("update",t.onUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["activate","enabled","loop","speed","assets"];r.prototype.initializeComponentData.call(this,t,i,n)};t.cloneComponent=function e(t,i){var n;this.addComponent(i,{});i.animation.assets=t.animation.assets.slice();i.animation.data.speed=t.animation.speed;i.animation.data.loop=t.animation.loop;i.animation.data.activate=t.animation.activate;i.animation.data.enabled=t.animation.enabled;var r={};var s=t.animation.animations;for(n in s)if(s.hasOwnProperty(n))r[n]=s[n];i.animation.animations=r;var a={};var o=t.animation.animationsIndex;for(n in o)if(o.hasOwnProperty(n))a[n]=o[n];i.animation.animationsIndex=a};t.onBeforeRemove=function e(t,i){i.onBeforeRemove()};t.onUpdate=function e(t){var i=this.store;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];var s=r.data;if(s.enabled&&r.entity.enabled){if(s.blending){s.blend+=t*s.blendSpeed;if(s.blend>=1)s.blend=1}if(s.playing){var a=s.skeleton;if(a!==null&&s.model!==null){if(s.blending)a.blend(s.fromSkel,s.toSkel,s.blend);else{var o=t*s.speed;a.addTime(o);if(s.speed>0&&a._time===a._animation.duration&&!s.loop)s.playing=false;else if(s.speed<0&&a._time===0&&!s.loop)s.playing=false}if(s.blending&&s.blend===1)a.animation=s.toSkel._animation;a.updateGraph()}}var l=s.animEvaluator;if(l){for(var h=0;h<l.clips.length;++h){var c=l.clips[h];c.speed=s.speed;if(!s.playing)c.pause();else c.resume()}if(s.blending)l.clips[1].blendWeight=s.blend;l.update(t)}if(s.blending&&s.blend===1)s.blending=false}}};return e}(L0);R0._buildAccessors(G0.prototype,W0);var X0=function(){function e(e,t,i,n,r){if(r===void 0)r=1;this._state=e;this._parent=t;this._name=i;this._point=Array.isArray(n)?new pc.Vec2(n):n;this._speed=r;this._weight=1;this._animTrack=null}U(e,[{key:"parent",get:function e(){return this._parent}},{key:"name",get:function e(){return this._name}},{key:"path",get:function e(){return this._parent?this._parent.path+"."+this._name:this._name}},{key:"point",get:function e(){return this._point}},{key:"weight",get:function e(){return this._parent?this._parent.weight*this._weight:this._weight},set:function e(t){this._weight=t}},{key:"normalizedWeight",get:function e(){var t=this._state.totalWeight;if(t===0)return 0;return this.weight/t}},{key:"speed",get:function e(){return this._speed}},{key:"animTrack",get:function e(){return this._animTrack},set:function e(t){this._animTrack=t}}]);return e}(),q0="NONE",Y0="PREV_STATE",K0="NEXT_STATE",Q0="PREV_STATE_NEXT_STATE",$0="NEXT_STATE_PREV_STATE",Z0="GREATER_THAN",J0="LESS_THAN",eb="GREATER_THAN_EQUAL_TO",tb="LESS_THAN_EQUAL_TO",ib="EQUAL_TO",nb="NOT_EQUAL_TO",rb="INTEGER",sb="FLOAT",ab="BOOLEAN",ob="TRIGGER",lb="1D",hb="2D_DIRECTIONAL",cb="2D_CARTESIAN",ub="DIRECT",fb="START",db="END",pb="ANY";function mb(e,t,i,n){var r=Math.min(t,i),s=Math.max(t,i);return n?e>=r&&e<=s:e>r&&e<s}function _b(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)}function vb(e,t,i){return e<=t?t:e>=i?i:e}var gb=function(u){G(f,u);function f(e,t,i,n,r,s,a,o){var l;l=u.call(this,e,t,i,n)||this;l._type=r;l._parameters=s;l._parameterValues=null;l._children=[];l._findParameter=o;for(var h=0;h<a.length;h++){var c=a[h];if(c.children)l._children.push(new f(e,H(l),c.name,c.point,c.type,c.parameter?[c.parameter]:c.parameters,c.children,o));else l._children.push(new X0(e,H(l),c.name,c.point,c.speed))}return l}var e=f.prototype;e.getChild=function e(t){for(var i=0;i<this._children.length;i++)if(this._children[i].name===t)return this._children[i]};e.calculateWeights=function e(){var t,i,n,r,s,a,o,l,h,c,u;switch(this._type){case lb:{var f=this._findParameter(this._parameters[0]).value;if(this._parameterValues&&this._parameterValues[0]===f)return;this._parameterValues=[f];this._children[0].weight=0;for(t=0;t<this._children.length-1;t++){var d=this._children[t];var p=this._children[t+1];if(mb(f,d.point,p.point,true)){var m=Math.abs(d.point-p.point);var _=Math.abs(d.point-f);var v=(m-_)/m;d.weight=v;p.weight=1-v}else p.weight=0}break}case cb:{l=this._parameters.map(function(e){return this._findParameter(e).value}.bind(this));if(this._parameterValues&&JSON.stringify(this._parameterValues)===JSON.stringify(l))return;this._parameterValues=l;n=new pc.Vec2(this._parameterValues);u=0;for(t=0;t<this._children.length;t++){r=this._children[t].point.clone();h=Number.MAX_VALUE;for(i=0;i<this._children.length;i++){if(t===i)continue;s=this._children[i].point.clone();o=s.clone().sub(r);a=n.clone().sub(r);c=vb(1-a.clone().dot(o)/o.lengthSq(),0,1);if(c<h)h=c}this._children[t].weight=h;u+=h}for(t=0;t<this._children.length;t++)this._children[t].weight=this._children[t]._weight/u;break}case hb:{l=this._parameters.map(function(e){return this._findParameter(e).value}.bind(this));if(this._parameterValues&&JSON.stringify(this._parameterValues)===JSON.stringify(l))return;this._parameterValues=l;n=new pc.Vec2(this._parameterValues);u=0;for(t=0;t<this._children.length;t++){r=this._children[t].point.clone();h=Number.MAX_VALUE;for(i=0;i<this._children.length;i++){if(t===i)continue;s=this._children[i].point.clone();var g=_b(r,n);var y=_b(r,s);o=new pc.Vec2((s.length()-r.length())/((s.length()+r.length())/2),y*2);a=new pc.Vec2((n.length()-r.length())/((s.length()+r.length())/2),g*2);c=vb(1-Math.abs(a.clone().dot(o)/o.lengthSq()),0,1);if(c<h)h=c}this._children[t].weight=h;u+=h}for(t=0;t<this._children.length;t++)this._children[t].weight=this._children[t]._weight/u;break}case ub:{l=this._parameters.map(function(e){return this._findParameter(e).value}.bind(this));if(this._parameterValues===l)return;this._parameterValues=l;u=0;for(t=0;t<this._children.length;t++)u+=vb(this._parameterValues[t],0,Number.MAX_VALUE);for(t=0;t<this._children.length;t++)this._children[t].weight=vb(this._parameterValues[t],0,Number.MAX_VALUE)/u;break}}};e.getNodeCount=function e(){var t=0;for(var i=0;i<this._children.length;i++){var n=this._children[i];if(n.constructor===f)t+=this._children[i].getNodeCount();else t++}return t};U(f,[{key:"parent",get:function e(){return this._parent}},{key:"name",get:function e(){return this._name}},{key:"point",get:function e(){return this._point}},{key:"weight",get:function e(){this.calculateWeights();return this._parent?this._parent.weight*this._weight:this._weight},set:function e(t){this._weight=t}},{key:"speed",get:function e(){return this._speed}}]);return f}(X0),yb=function(){function e(e,t,i,n,r){this._controller=e;this._name=t;this._animations={};this._animationList=[];this._speed=i||1;this._loop=n===undefined?true:n;var s=this._controller.findParameter.bind(this._controller);if(r)this._blendTree=new gb(this,null,t,1,r.type,r.parameter?[r.parameter]:r.parameters,r.children,s);else this._blendTree=new X0(this,null,t,1,i)}var t=e.prototype;t._getNodeFromPath=function e(t){var i=this._blendTree;for(var n=1;n<t.length;n++)i=i.getChild(t[n]);return i};t.addAnimation=function e(t,i){var n=this._animationList.findIndex(function(e){return e.path===t});if(n>=0)this._animationList[n].animTrack=i;else{var r=this._getNodeFromPath(t);r.animTrack=i;this._animationList.push(r)}};U(e,[{key:"name",get:function e(){return this._name}},{key:"animations",get:function e(){return this._animationList},set:function e(t){this._animationList=t}},{key:"speed",get:function e(){return this._speed}},{key:"loop",get:function e(){return this._loop}},{key:"nodeCount",get:function e(){if(!this._blendTree||!(this._blendTree.constructor===gb))return 1;return this._blendTree.getNodeCount()}},{key:"playable",get:function e(){return this.name===fb||this.name===db||this.name===pb||this.animations.length===this.nodeCount}},{key:"looping",get:function e(){if(this.animations.length>0){var t=this.name+"."+this.animations[0].animTrack.name;var i=this._controller.animEvaluator.findClip(t);if(i)return i.loop}return false}},{key:"totalWeight",get:function e(){var t=0;var i;for(i=0;i<this.animations.length;i++)t+=this.animations[i].weight;return t}},{key:"timelineDuration",get:function e(){var t=0;var i;for(i=0;i<this.animations.length;i++){var n=this.animations[i];if(n.animTrack.duration>t)t=n.animTrack.duration}return t}}]);return e}(),bb=function(){function e(e,t,i,n,r,s,a,o,l){if(l===void 0)l=q0;this._controller=e;this._from=t;this._to=i;this._time=n;this._priority=r;this._conditions=s||[];this._exitTime=a||null;this._transitionOffset=o||null;this._interruptionSource=l}U(e,[{key:"from",get:function e(){return this._from}},{key:"to",get:function e(){return this._to}},{key:"time",get:function e(){return this._time}},{key:"priority",get:function e(){return this._priority}},{key:"conditions",get:function e(){return this._conditions}},{key:"exitTime",get:function e(){return this._exitTime}},{key:"transitionOffset",get:function e(){return this._transitionOffset}},{key:"interruptionSource",get:function e(){return this._interruptionSource}},{key:"hasExitTime",get:function e(){return!!this.exitTime}},{key:"hasConditionsMet",get:function e(){var t=true;var i;for(i=0;i<this.conditions.length;i++){var n=this.conditions[i];var r=this._controller.findParameter(n.parameterName);switch(n.predicate){case Z0:t=t&&r.value>n.value;break;case J0:t=t&&r.value<n.value;break;case eb:t=t&&r.value>=n.value;break;case tb:t=t&&r.value<=n.value;break;case ib:t=t&&r.value===n.value;break;case nb:t=t&&r.value!==n.value;break}if(!t)return t}return t}}]);return e}(),xb=function(){function e(e,t,i,n,r){this._animEvaluator=e;this._states={};this._stateNames=[];var s;for(s=0;s<t.length;s++){this._states[t[s].name]=new yb(this,t[s].name,t[s].speed,t[s].loop,t[s].blendTree);this._stateNames.push(t[s].name)}this._transitions=i.map(function(e){return new bb(this,e.from,e.to,e.time,e.priority,e.conditions,e.exitTime,e.transitionOffset,e.interruptionSource)}.bind(this));this._findTransitionsFromStateCache={};this._findTransitionsBetweenStatesCache={};this._parameters=n;this._previousStateName=null;this._activeStateName=fb;this._playing=false;this._activate=r;this._currTransitionTime=1;this._totalTransitionTime=1;this._isTransitioning=false;this._transitionInterruptionSource=q0;this._transitionPreviousStates=[];this._timeInState=0;this._timeInStateBefore=0}var t=e.prototype;t._findState=function e(t){return this._states[t]};t._getActiveStateProgressForTime=function e(t){if(this.activeStateName===fb||this.activeStateName===db||this.activeStateName===pb)return 1;var i=this._animEvaluator.findClip(this.activeStateAnimations[0].name);if(i)return t/i.track.duration;return null};t._findTransitionsFromState=function e(t){var i=this._findTransitionsFromStateCache[t];if(!i){i=this._transitions.filter(function(e){return e.from===t});i.sort(function(e,t){return e.priority<t.priority});this._findTransitionsFromStateCache[t]=i}return i};t._findTransitionsBetweenStates=function e(t,i){var n=this._findTransitionsBetweenStatesCache[t+"->"+i];if(!n){n=this._transitions.filter(function(e){return e.from===t&&e.to===i});n.sort(function(e,t){return e.priority<t.priority});this._findTransitionsBetweenStatesCache[t+"->"+i]=n}return n};t._findTransition=function e(t,i){var n=[];if(t&&i)n.concat(this._findTransitionsBetweenStates(t,i));else if(!this._isTransitioning){n=n.concat(this._findTransitionsFromState(this._activeStateName));n=n.concat(this._findTransitionsFromState(pb))}else switch(this._transitionInterruptionSource){case Y0:n=n.concat(this._findTransitionsFromState(this._previousStateName));n=n.concat(this._findTransitionsFromState(pb));break;case K0:n=n.concat(this._findTransitionsFromState(this._activeStateName));n=n.concat(this._findTransitionsFromState(pb));break;case Q0:n=n.concat(this._findTransitionsFromState(this._previousStateName));n=n.concat(this._findTransitionsFromState(this._activeStateName));n=n.concat(this._findTransitionsFromState(pb));break;case $0:n=n.concat(this._findTransitionsFromState(this._activeStateName));n=n.concat(this._findTransitionsFromState(this._previousStateName));n=n.concat(this._findTransitionsFromState(pb));break}n=n.filter(function(e){if(e.to===this.activeStateName)return false;if(e.hasExitTime){var t=this._getActiveStateProgressForTime(this._timeInStateBefore);var i=this._getActiveStateProgressForTime(this._timeInState);if(e.exitTime<1&&this.activeState.looping){t-=Math.floor(t);i-=Math.floor(i)}if(!(e.exitTime>t&&e.exitTime<=i))return null}return e.hasConditionsMet}.bind(this));if(n.length>0)return n[0];return null};t._updateStateFromTransition=function e(t){var i;var n;var r;var s;var a;this.previousState=t.from;this.activeState=t.to;for(i=0;i<t.conditions.length;i++){var o=t.conditions[i];var l=this.findParameter(o.parameterName);if(l.type===ob)l.value=false}if(this.previousState){if(!this._isTransitioning)this._transitionPreviousStates=[];this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var h=Math.min(this._currTransitionTime/this._totalTransitionTime,1);for(i=0;i<this._transitionPreviousStates.length;i++){if(!this._isTransitioning)this._transitionPreviousStates[i].weight=1;else if(i!==this._transitionPreviousStates.length-1)this._transitionPreviousStates[i].weight*=1-h;else this._transitionPreviousStates[i].weight=h;r=this._findState(this._transitionPreviousStates[i].name);for(n=0;n<r.animations.length;n++){s=r.animations[n];a=this._animEvaluator.findClip(s.name+".previous."+i);if(!a){a=this._animEvaluator.findClip(s.name);a.name=s.name+".previous."+i}if(i!==this._transitionPreviousStates.length-1)a.pause()}}}this._isTransitioning=true;this._totalTransitionTime=t.time;this._currTransitionTime=0;this._transitionInterruptionSource=t.interruptionSource;var c=t.transitionOffset&&t.transitionOffset>0&&t.transitionOffset<1;var u=this.activeState;for(i=0;i<u.animations.length;i++){a=this._animEvaluator.findClip(u.animations[i].name);if(!a){var f=Number.isFinite(u.animations[i].speed)?u.animations[i].speed:u.speed;a=new F0(u.animations[i].animTrack,0,f,true,u.loop);a.name=u.animations[i].name;this._animEvaluator.addClip(a)}else a.reset();if(t.time>0)a.blendWeight=0;else a.blendWeight=u.animations[i].normalizedWeight;a.play();if(c)a.time=u.timelineDuration*t.transitionOffset;else{var d=u.speed>=0?0:this.activeStateDuration;a.time=d}}var p=0;var m=0;if(c){var _=u.timelineDuration*t.transitionOffset;p=_;m=_}this._timeInState=p;this._timeInStateBefore=m};t._transitionToState=function e(t){if(t===this._activeStateName)return;if(!this._findState(t))return;var i=this._findTransition(this._activeStateName,t);if(!i){this._animEvaluator.removeClips();i=new bb(this,null,t,0,0)}this._updateStateFromTransition(i)};t.assignAnimation=function e(t,i){var n=t.split(".");var r=this._findState(n[0]);if(!r)return;r.addAnimation(n,i);if(!this._playing&&this._activate&&this.playable)this.play()};t.removeNodeAnimations=function e(t){var i=this._findState(t);if(!i)return;i.animations=[]};t.play=function e(t){if(t)this._transitionToState(t);this._playing=true};t.pause=function e(){this._playing=false};t.reset=function e(){this._previousStateName=null;this._activeStateName=fb;this._playing=false;this._currTransitionTime=1;this._totalTransitionTime=1;this._isTransitioning=false;this._timeInState=0;this._timeInStateBefore=0;this._animEvaluator.removeClips()};t.update=function e(t){if(!this._playing)return;var i;var n;var r;var s;var a;this._timeInStateBefore=this._timeInState;this._timeInState+=t;var o=this._findTransition(this._activeStateName);if(o)this._updateStateFromTransition(o);if(this._isTransitioning){this._currTransitionTime+=t;if(this._currTransitionTime<=this._totalTransitionTime){var l=this._currTransitionTime/this._totalTransitionTime;for(i=0;i<this._transitionPreviousStates.length;i++){r=this._findState(this._transitionPreviousStates[i].name);var h=this._transitionPreviousStates[i].weight;for(n=0;n<r.animations.length;n++){s=r.animations[n];a=this._animEvaluator.findClip(s.name+".previous."+i);if(a)a.blendWeight=(1-l)*s.normalizedWeight*h}}r=this.activeState;for(i=0;i<r.animations.length;i++){s=r.animations[i];this._animEvaluator.findClip(s.name).blendWeight=l*s.normalizedWeight}}else{this._isTransitioning=false;var c=this.activeStateAnimations.length;var u=this._animEvaluator.clips.length;for(i=0;i<u-c;i++)this._animEvaluator.removeClip(0);this._transitionPreviousStates=[];r=this.activeState;for(i=0;i<r.animations.length;i++){s=r.animations[i];a=this._animEvaluator.findClip(s.name);if(a)a.blendWeight=s.normalizedWeight}}}else if(this.activeState._blendTree.constructor===gb){r=this.activeState;for(i=0;i<r.animations.length;i++){s=r.animations[i];a=this._animEvaluator.findClip(s.name);if(a)a.blendWeight=s.normalizedWeight}}this._animEvaluator.update(t)};t.findParameter=function e(t){return this._parameters[t]};U(e,[{key:"animEvaluator",get:function e(){return this._animEvaluator}},{key:"activeState",get:function e(){return this._findState(this._activeStateName)},set:function e(t){this._activeStateName=t}},{key:"activeStateName",get:function e(){return this._activeStateName}},{key:"activeStateAnimations",get:function e(){return this.activeState.animations}},{key:"previousState",get:function e(){return this._findState(this._previousStateName)},set:function e(t){this._previousStateName=t}},{key:"previousStateName",get:function e(){return this._previousStateName}},{key:"playable",get:function e(){var t=true;var i;for(i=0;i<this._stateNames.length;i++)if(!this._states[this._stateNames[i]].playable)t=false;return t}},{key:"playing",get:function e(){return this._playing},set:function e(t){this._playing=t}},{key:"activeStateProgress",get:function e(){return this._getActiveStateProgressForTime(this._timeInState)}},{key:"activeStateDuration",get:function e(){if(this.activeStateName===fb||this.activeStateName===db)return 0;var t=0;for(var i=0;i<this.activeStateAnimations.length;i++){var n=this._animEvaluator.findClip(this.activeStateAnimations[i].name);t=Math.max(t,n.track.duration)}return t}},{key:"activeStateCurrentTime",get:function e(){return this._timeInState},set:function e(t){this._timeInStateBefore=t;this._timeInState=t;for(var i=0;i<this.activeStateAnimations.length;i++){var n=this.animEvaluator.findClip(this.activeStateAnimations[i].name);if(n)n.time=t}}},{key:"transitioning",get:function e(){return this._isTransitioning}},{key:"transitionProgress",get:function e(){return this._currTransitionTime/this._totalTransitionTime}},{key:"states",get:function e(){return this._stateNames}}]);return e}(),Sb=new he,wb=new ce,Tb=new ue,Mb=new ge,Cb=new be,Ab=function(n){G(l,n);function l(e,t){var i;i=n.call(this,t)||this;i.animComponent=e;return i}l._packFloat=function e(t){return t[0]};l._packBoolean=function e(t){return!!t[0]};l._packVec2=function e(t){Sb.x=t[0];Sb.y=t[1];return Sb};l._packVec3=function e(t){wb.x=t[0];wb.y=t[1];wb.z=t[2];return wb};l._packVec4=function e(t){Tb.x=t[0];Tb.y=t[1];Tb.z=t[2];Tb.w=t[3];return Tb};l._packColor=function e(t){Mb.r=t[0];Mb.g=t[1];Mb.b=t[2];Mb.a=t[3];return Mb};l._packQuat=function e(t){Cb.x=t[0];Cb.y=t[1];Cb.z=t[2];Cb.w=t[3];return Cb};var e=l.prototype;e.resolve=function e(t){var i=t_.decode(t);var n=this._getEntityFromHierarchy(i.entityPath);if(!n)return null;var r;switch(i.component){case"entity":r=n;break;case"graph":if(n.model&&n.model.model&&n.model.model.graph)r=pc.app.root.findByPath(n.model.model.graph.path+"/"+i.entityPath[0]);if(!r){var s=t_.splitPath(i.entityPath[0],"/");r=this.nodes[s[s.length-1]||""]}if(!r)return null;break;default:r=n.findComponent(i.component);if(!r)return null}return this._createAnimTargetForProperty(r,i.propertyPath)};e.update=function e(t){var i=this.activeNodes;if(i)for(var n=0;n<i.length;n++)i[n]._dirtifyLocal()};e._getEntityFromHierarchy=function e(t){if(!this.animComponent.entity.name===t[0])return null;var i=this.animComponent.entity;if(t.length===1)return i;return i._parent.findByPath(t.join("/"))};e._resolvePath=function e(t,i,n){var r=i.length-(n?0:1);for(var s=0;s<r;s++)t=t[i[s]];return t};e._setter=function e(t,i,n){var r=this._resolvePath(t,i);var s=i[i.length-1];var a="set"+s.substring(0,1).toUpperCase()+s.substring(1);if(r[a]){var o=r[a].bind(r);return function(e){o(n(e))}}var l=r[s];if(typeof l==="object"&&l.hasOwnProperty("copy"))return function(e){l.copy(n(e))};if([he,ce,ue,ge,be].indexOf(r.constructor)!==-1&&i.length>1){var h=i.length>2?this._resolvePath(t,i.slice(0,-1)):t;var c=i[i.length-2];return function(e){r[s]=n(e);h[c]=r}}return function(e){r[s]=n(e)}};e._createAnimTargetForProperty=function e(t,i){if(this.handlers&&i[0]==="weights")return this.handlers.weights(t);else if(this.handlers&&i[0]==="material"&&i.length===2){var n=i[1];if(n.indexOf("Map")===n.length-3)return this.handlers.materialTexture(t,n)}var r=this._resolvePath(t,i,true);if(typeof r==="undefined")return null;var s;var a;var o;if(typeof r==="number"){s=this._setter(t,i,l._packFloat);a="vector";o=1}else if(typeof r==="boolean"){s=this._setter(t,i,l._packBoolean);a="vector";o=1}else if(typeof r==="object")switch(r.constructor){case he:s=this._setter(t,i,l._packVec2);a="vector";o=2;break;case ce:s=this._setter(t,i,l._packVec3);a="vector";o=3;break;case ue:s=this._setter(t,i,l._packVec4);a="vector";o=4;break;case ge:s=this._setter(t,i,l._packColor);a="vector";o=4;break;case be:s=this._setter(t,i,l._packQuat);a="quaternion";o=4;break;default:return null}if(i.indexOf("material")!==-1)return new N0(function(e){s(e);t.material.update()},a,o);return new N0(s,a,o)};return l}(z0),Pb=function(){function e(e,t,i){this._name=e;this._controller=t;this._component=i}var t=e.prototype;t.play=function e(t){this._controller.play(t)};t.pause=function e(){this._controller.pause()};t.reset=function e(){this._controller.reset()};t.update=function e(t){this._controller.update(t)};t.assignAnimation=function e(t,i){if(i.constructor!==e_)return;this._controller.assignAnimation(t,i);if(this._component.activate&&this._component.playable)this._component.playing=true};t.removeNodeAnimations=function e(t){this._controller.removeNodeAnimations(t);this._component.playing=false};U(e,[{key:"name",get:function e(){return this._name}},{key:"playing",get:function e(){return this._controller.playing},set:function e(t){this._controller.playing=t}},{key:"playable",get:function e(){return this._controller.playable}},{key:"activeState",get:function e(){return this._controller.activeStateName}},{key:"previousState",get:function e(){return this._controller.previousStateName}},{key:"activeStateProgress",get:function e(){return this._controller.activeStateProgress}},{key:"activeStateDuration",get:function e(){return this._controller.activeStateDuration}},{key:"activeStateCurrentTime",get:function e(){return this._controller.activeStateCurrentTime},set:function e(t){this._controller.activeStateCurrentTime=t}},{key:"transitioning",get:function e(){return this._controller.transitioning}},{key:"transitionProgress",get:function e(){if(this.transitioning)return this._controller.transitionProgress;return null}},{key:"states",get:function e(){return this._controller.states}}]);return e}(),Eb=function(i){G(e,i);function e(e,t){return i.call(this,e,t)||this}var t=e.prototype;t.loadStateGraph=function e(t){var i;var o=this.data;o.stateGraph=t;o.parameters={};var n=Object.keys(t.parameters);for(i=0;i<n.length;i++){var r=n[i];o.parameters[r]={type:t.parameters[r].type,value:t.parameters[r].value}}o.layers=[];var l;if(this.entity.model){var s=this.entity.model.model;if(s)l=s.getGraph()}else l=this.entity;function a(e,t,i,n){var r=new Ab(this,l);var s=new B0(r);var a=new xb(s,t,i,o.parameters,o.activate);o.layers.push(new Pb(e,a,this));o.layerIndices[e]=n}for(i=0;i<t.layers.length;i++){var h=t.layers[i];a.bind(this)(h.name,h.states,h.transitions,i)}this.setupAnimationAssets()};t.setupAnimationAssets=function e(){for(var t=0;t<this.data.layers.length;t++){var i=this.data.layers[t];var n=i.name;for(var r=0;r<i.states.length;r++){var s=i.states[r];if(s!==fb&&s!==db&&s!==pb){var a=n+":"+s;if(!this.data.animationAssets[a])this.data.animationAssets[a]={asset:null}}}}this.loadAnimationAssets()};t.loadAnimationAssets=function e(){for(var t=0;t<this.data.layers.length;t++){var i=this.data.layers[t];for(var n=0;n<i.states.length;n++){var r=i.states[n];var s=this.data.animationAssets[i.name+":"+r];if(!s||!s.asset){this.removeNodeAnimations(r,i.name);continue}var a=s.asset;var o=this.system.app.assets.get(a);if(o)if(o.resource)this.assignAnimation(r,o.resource,i.name);else{o.once("load",function(t,i){return function(e){this.assignAnimation(i,e.resource,t)}.bind(this)}.bind(this)(i.name,r));this.system.app.assets.load(o)}}}};t.removeStateGraph=function e(){this.data.stateGraph=null;this.data.stateGraphAsset=null;this.data.animationAssets={};this.data.layers=[];this.data.layerIndices={};this.data.parameters={};this.data.playing=false};t.resetStateGraph=function e(){if(this.stateGraphAsset){var t=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(t)}else this.removeStateGraph()};t.reset=function e(){this.data.parameters=Object.assign({},this.data.stateGraph.parameters);for(var t=0;t<this.data.layers.length;t++){var i=this.data.layers[t].playing;this.data.layers[t].reset();this.data.layers[t].playing=i}};t.findAnimationLayer=function e(t){var i=this.data.layerIndices[t];return this.data.layers[i]||null};t.assignAnimation=function e(t,i,n){if(!this.data.stateGraph)return;var r=n?this.findAnimationLayer(n):this.baseLayer;if(!r)return;r.assignAnimation(t,i)};t.removeNodeAnimations=function e(t,i){var n=i?this.findAnimationLayer(i):this.baseLayer;if(!n)return;n.removeNodeAnimations(t)};t.getParameterValue=function e(t,i){var n=this.data.parameters[t];if(n&&n.type===i)return n.value};t.setParameterValue=function e(t,i,n){var r=this.data.parameters[t];if(r&&r.type===i){r.value=n;return}};t.getFloat=function e(t){return this.getParameterValue(t,sb)};t.setFloat=function e(t,i){this.setParameterValue(t,sb,i)};t.getInteger=function e(t){return this.getParameterValue(t,rb)};t.setInteger=function e(t,i){if(typeof i==="number"&&i%1===0)this.setParameterValue(t,rb,i)};t.getBoolean=function e(t){return this.getParameterValue(t,ab)};t.setBoolean=function e(t,i){this.setParameterValue(t,ab,!!i)};t.getTrigger=function e(t){return this.getParameterValue(t,ob)};t.setTrigger=function e(t){this.setParameterValue(t,ob,true)};t.resetTrigger=function e(t){this.setParameterValue(t,ob,false)};U(e,[{key:"stateGraphAsset",get:function e(){return this.data.stateGraphAsset},set:function e(t){if(t===null){this.removeStateGraph();return}var i;var n;if(t instanceof O_){i=t.id;n=this.system.app.assets.get(i);if(!n){this.system.app.assets.add(t);n=this.system.app.assets.get(i)}}else{i=t;n=this.system.app.assets.get(i)}if(!n||this.data.stateGraphAsset===i)return;if(n.resource){this.data.stateGraph=n.resource;this.loadStateGraph(this.data.stateGraph);n.on("change",function(e){this.data.stateGraph=new Tv(e._data);this.loadStateGraph(this.data.stateGraph)}.bind(this))}else{n.once("load",function(e){this.data.stateGraph=e.resource;this.loadStateGraph(this.data.stateGraph)}.bind(this));n.on("change",function(e){this.data.stateGraph=new Tv(e._data);this.loadStateGraph(this.data.stateGraph)}.bind(this));this.system.app.assets.load(n)}this.data.stateGraphAsset=i}},{key:"animationAssets",get:function e(){return this.data.animationAssets},set:function e(t){this.data.animationAssets=t;this.loadAnimationAssets()}},{key:"playable",get:function e(){for(var t=0;t<this.data.layers.length;t++)if(!this.data.layers[t].playable)return false;return true}},{key:"baseLayer",get:function e(){if(this.data.layers.length>0)return this.data.layers[0];return null}}]);return e}(R0),Ib=function e(){this.stateGraphAsset=null;this.animationAssets={};this.speed=1;this.activate=true;this.enabled=true;this.playing=false;this.stateGraph=null;this.layers=[];this.layerIndices={};this.parameters={}},Rb=["enabled","speed","activate","playing"],Lb=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="anim";t.ComponentType=Eb;t.DataType=Ib;t.schema=Rb;t.on("beforeremove",t.onBeforeRemove,H(t));L0.bind("animationUpdate",t.onAnimationUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["activate","enabled","speed","playing"];r.prototype.initializeComponentData.call(this,t,i,n);if(i.stateGraphAsset)t.stateGraphAsset=i.stateGraphAsset;if(i.animationAssets)t.animationAssets=Object.assign(t.data.animationAssets,i.animationAssets)};t.onAnimationUpdate=function e(t){var i=this.store;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];var s=r.data;if(s.enabled&&r.entity.enabled&&s.playing)for(var a=0;a<s.layers.length;a++)s.layers[a].update(t*s.speed)}};return e}(L0);R0._buildAccessors(Eb.prototype,Rb);var Db=function(i){G(e,i);function e(e,t){return i.call(this,e,t)||this}var t=e.prototype;t.setCurrentListener=function e(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}};t.onEnable=function e(){this.setCurrentListener()};t.onDisable=function e(){if(this.system.current===this.entity)this.system.current=null};return e}(R0),kb=function e(){this.enabled=true},Ob=["enabled"],Fb=function(r){G(e,r);function e(e,t){var i;i=r.call(this,e)||this;i.id="audiolistener";i.ComponentType=Db;i.DataType=kb;i.schema=Ob;i.manager=t;i.current=null;L0.bind("update",i.onUpdate,H(i));return i}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["enabled"];r.prototype.initializeComponentData.call(this,t,i,n)};t.onUpdate=function e(t){if(this.current){var i=this.current.getPosition();this.manager.listener.setPosition(i);var n=this.current.getWorldTransform();this.manager.listener.setOrientation(n)}};return e}(L0);R0._buildAccessors(Db.prototype,Ob);var Bb=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i.on("set_assets",i.onSetAssets,H(i));i.on("set_loop",i.onSetLoop,H(i));i.on("set_volume",i.onSetVolume,H(i));i.on("set_pitch",i.onSetPitch,H(i));i.on("set_minDistance",i.onSetMinDistance,H(i));i.on("set_maxDistance",i.onSetMaxDistance,H(i));i.on("set_rollOffFactor",i.onSetRollOffFactor,H(i));i.on("set_distanceModel",i.onSetDistanceModel,H(i));i.on("set_3d",i.onSet3d,H(i));return i}var t=e.prototype;t.play=function e(t){if(!this.enabled||!this.entity.enabled)return;if(this.channel)this.stop();var i;var n=this.data;if(n.sources[t])if(!n["3d"]){i=this.system.manager.playSound(n.sources[t],n);n.currentSource=t;n.channel=i}else{var r=this.entity.getPosition();i=this.system.manager.playSound3d(n.sources[t],r,n);n.currentSource=t;n.channel=i}};t.pause=function e(){if(this.channel)this.channel.pause()};t.unpause=function e(){if(this.channel&&this.channel.paused)this.channel.unpause()};t.stop=function e(){if(this.channel){this.channel.stop();this.channel=null}};t.onSetAssets=function e(t,i,n){var r=[];var s,a=n.length;if(i&&i.length)for(s=0;s<i.length;s++)if(i[s]){var o=this.system.app.assets.get(i[s]);if(o){o.off("change",this.onAssetChanged,this);o.off("remove",this.onAssetRemoved,this);if(this.currentSource===o.name)this.stop()}}if(a)for(s=0;s<a;s++)if(i.indexOf(n[s])<0)if(n[s]instanceof O_)r.push(n[s].id);else r.push(n[s]);if(!this.system._inTools&&r.length)this.loadAudioSourceAssets(r)};t.onAssetChanged=function e(t,i,n,r){if(i==="resource"){var s=this.data.sources;if(s){this.data.sources[t.name]=n;if(this.data.currentSource===t.name)if(this.channel)if(this.channel.paused){this.play(t.name);this.pause()}else this.play(t.name)}}};t.onAssetRemoved=function e(t){t.off("remove",this.onAssetRemoved,this);if(this.data.sources[t.name]){delete this.data.sources[t.name];if(this.data.currentSource===t.name){this.stop();this.data.currentSource=null}}};t.onSetLoop=function e(t,i,n){if(i!=n)if(this.channel)this.channel.setLoop(n)};t.onSetVolume=function e(t,i,n){if(i!=n)if(this.channel)this.channel.setVolume(n)};t.onSetPitch=function e(t,i,n){if(i!=n)if(this.channel)this.channel.setPitch(n)};t.onSetMaxDistance=function e(t,i,n){if(i!=n)if(this.channel instanceof Gm)this.channel.setMaxDistance(n)};t.onSetMinDistance=function e(t,i,n){if(i!=n)if(this.channel instanceof Gm)this.channel.setMinDistance(n)};t.onSetRollOffFactor=function e(t,i,n){if(i!=n)if(this.channel instanceof Gm)this.channel.setRollOffFactor(n)};t.onSetDistanceModel=function e(t,i,n){if(i!==n)if(this.channel instanceof Gm)this.channel.setDistanceModel(n)};t.onSet3d=function e(t,i,n){if(i!==n)if(this.system.initialized&&this.currentSource){var r=false;var s=false;if(this.channel){r=this.channel.paused;s=this.channel.suspended}this.play(this.currentSource);if(this.channel){this.channel.paused=r;this.channel.suspended=s}}};t.onEnable=function e(){var t=this.data.assets;if(t){var i=this.system.app.assets;for(var n=0,r=t.length;n<r;n++){var s=t[n];if(!(s instanceof O_))s=i.get(s);if(s&&!s.resource)i.load(s)}}if(this.system.initialized)if(this.data.activate&&!this.channel)this.play(this.currentSource);else this.unpause()};t.onDisable=function e(){this.pause()};t.loadAudioSourceAssets=function e(i){var n=this;var t=i.map(function(e){return this.system.app.assets.get(e)},this);var r={};var s=null;var a=t.length;var o=function e(t){a--};var l=function(){this.data.sources=r;this.data.currentSource=s;if(this.enabled&&this.activate&&s)this.onEnable()}.bind(this);t.forEach(function(e,t){if(e){s=s||e.name;e.off("change",this.onAssetChanged,this);e.on("change",this.onAssetChanged,this);e.off("remove",this.onAssetRemoved,this);e.on("remove",this.onAssetRemoved,this);e.off("error",o,this);e.on("error",o,this);e.ready(function(e){r[e.name]=e.resource;a--;if(a===0)l()});if(!e.resource&&n.enabled&&n.entity.enabled)this.system.app.assets.load(e)}else{a--;if(a===0)l();this.system.app.assets.on("add:"+i[t],function(e){e.ready(function(e){n.data.sources[e.name]=e.resource});if(!e.resource)n.system.app.assets.load(e)})}},this)};return e}(R0),Nb=function e(){this.enabled=true;this.assets=[];this.activate=true;this.volume=1;this.pitch=1;this.loop=false;this["3d"]=true;this.minDistance=1;this.maxDistance=1e4;this.rollOffFactor=1;this.distanceModel=zm;this.paused=true;this.sources={};this.currentSource=null;this.channel=null},zb=["enabled","assets","volume","pitch","loop","activate","3d","minDistance","maxDistance","rollOffFactor","distanceModel","sources","currentSource","channel"],Vb=function(r){G(e,r);function e(e,t){var i;i=r.call(this,e)||this;i.id="audiosource";i.ComponentType=Bb;i.DataType=Nb;i.schema=zb;i.manager=t;i.initialized=false;L0.bind("initialize",i.onInitialize,H(i));L0.bind("update",i.onUpdate,H(i));i.on("remove",i.onRemove,H(i));return i}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["activate","volume","pitch","loop","3d","minDistance","maxDistance","rollOffFactor","distanceModel","enabled","assets"];r.prototype.initializeComponentData.call(this,t,i,n);t.paused=!(t.enabled&&t.activate)};t.onInitialize=function e(t){if(t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate)t.audiosource.play(t.audiosource.currentSource);var i=t._children;var n,r=i.length;for(n=0;n<r;n++)if(i[n]instanceof Nv)this.onInitialize(i[n]);this.initialized=true};t.onUpdate=function e(t){var i=this.store;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];var s=r.entity;var a=r.data;if(a.enabled&&s.enabled&&a.channel instanceof Gm){var o=s.getPosition();a.channel.setPosition(o)}}};t.onRemove=function e(t,i){if(i.channel){i.channel.stop();i.channel=null}};t.setVolume=function e(t){this.manager.setVolume(t)};return e}(L0);R0._buildAccessors(Bb.prototype,zb);var Ub=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this)||this;if(!e||!(e instanceof R0))throw new Error("The parentComponent argument is required and must be a Component");else if(!t||typeof t!=="string")throw new Error("The propertyName argument is required and must be a string");else if(i&&typeof i!=="object")throw new Error("If provided, the eventConfig argument must be an object");n._parentComponent=e;n._entityPropertyName=t;n._entity=null;n._app=e.system.app;n._configureEventListeners(i||{},{"entity#destroy":n._onEntityDestroy});n._toggleLifecycleListeners("on");return n}var t=e.prototype;t._configureEventListeners=function e(t,i){var n=this._parseEventListenerConfig(t,"external",this._parentComponent);var r=this._parseEventListenerConfig(i,"internal",this);this._eventListenerConfigs=n.concat(r);this._listenerStatusFlags={};this._gainListeners={};this._loseListeners={}};t._parseEventListenerConfig=function e(a,o,l){return Object.keys(a).map(function(e,t){var i=e.split("#");var n=i[0];var r=i[1];var s=a[e];if(i.length!==2||typeof n!=="string"||n.length===0||typeof r!=="string"||r.length===0)throw new Error("Invalid event listener description: `"+e+"`");if(typeof s!=="function")throw new Error("Invalid or missing callback for event listener `"+e+"`");return{id:o+"_"+t+"_"+e,sourceName:n,eventName:r,callback:s,scope:l}},this)};t._toggleLifecycleListeners=function e(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this);this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this);L0[t]("postinitialize",this._onPostInitialize,this);this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);var i=[];for(var n=0;n<this._eventListenerConfigs.length;++n){var r=this._eventListenerConfigs[n];var s=this._app.systems[r.sourceName];if(s){if(i.indexOf(s)===-1)i.push(s);if(s&&r.eventName==="gain")this._gainListeners[r.sourceName]=r;if(s&&r.eventName==="lose")this._loseListeners[r.sourceName]=r}}for(var a=0;a<i.length;++a){i[a][t]("add",this._onComponentAdd,this);i[a][t]("beforeremove",this._onComponentRemove,this)}};t._onSetEntity=function e(t,i,n){if(n instanceof Nv)this._updateEntityReference();else{if(n!==null&&n!==undefined&&typeof n!=="string"){console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof n+"'");return}if(i!==n)this._updateEntityReference()}};t._onPostInitialize=function e(){this._updateEntityReference()};t.onParentComponentEnable=function e(){if(!this._entity)this._updateEntityReference()};t._onSceneLoaded=function e(){this._updateEntityReference()};t._updateEntityReference=function e(){var t=this._parentComponent.data[this._entityPropertyName];var i;if(t instanceof Nv){i=t;t=i.getGuid();this._parentComponent.data[this._entityPropertyName]=t}else{var n=this._parentComponent.system.app.root;var r=this._parentComponent.entity.isDescendantOf(n);i=r&&t?n.findByGuid(t):null}var s=this._entity!==i;if(s){if(this._entity)this._onBeforeEntityChange();this._entity=i;if(this._entity)this._onAfterEntityChange();this.fire("set:entity",this._entity)}};t._onBeforeEntityChange=function e(){this._toggleEntityListeners("off");this._callAllGainOrLoseListeners(this._loseListeners)};t._onAfterEntityChange=function e(){this._toggleEntityListeners("on");this._callAllGainOrLoseListeners(this._gainListeners)};t._onComponentAdd=function e(t,i){var n=i.system.id;if(t===this._entity){this._callGainOrLoseListener(n,this._gainListeners);this._toggleComponentListeners("on",n)}};t._onComponentRemove=function e(t,i){var n=i.system.id;if(t===this._entity){this._callGainOrLoseListener(n,this._loseListeners);this._toggleComponentListeners("off",n,true)}};t._callAllGainOrLoseListeners=function e(t){for(var i in this._entity.c)this._callGainOrLoseListener(i,t)};t._callGainOrLoseListener=function e(t,i){if(this._entity.c.hasOwnProperty(t)&&i[t]){var n=i[t];n.callback.call(n.scope)}};t._toggleEntityListeners=function e(t,i){if(this._entity)for(var n=0;n<this._eventListenerConfigs.length;++n)this._safeToggleListener(t,this._eventListenerConfigs[n],i)};t._toggleComponentListeners=function e(t,i,n){for(var r=0;r<this._eventListenerConfigs.length;++r){var s=this._eventListenerConfigs[r];if(s.sourceName===i)this._safeToggleListener(t,s,n)}};t._safeToggleListener=function e(t,i,n){var r=t==="on";if(r&&this._listenerStatusFlags[i.id])return;var s=this._getEventSource(i.sourceName,n);if(s){s[t](i.eventName,i.callback,i.scope);this._listenerStatusFlags[i.id]=r}};t._getEventSource=function e(t,i){if(t==="entity")return this._entity;var n=this._entity[t];if(n)return n;if(!i)console.warn("Entity has no component with name "+t);return null};t._onEntityDestroy=function e(t){if(this._entity===t){this._toggleEntityListeners("off",true);this._entity=null}};t._onParentComponentRemove=function e(t,i){if(i===this._parentComponent){this._toggleLifecycleListeners("off");this._toggleEntityListeners("off",true)}};t.hasComponent=function e(t){return this._entity&&this._entity.c?!!this._entity.c[t]:false};U(e,[{key:"entity",get:function e(){return this._entity}}]);return e}(u),Gb=0,Hb=1,Wb={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},jb={};jb[Wb.DEFAULT]="_defaultTint",jb[Wb.HOVER]="hoverTint",jb[Wb.PRESSED]="pressedTint",jb[Wb.INACTIVE]="inactiveTint";var Xb={};Xb[Wb.DEFAULT]="_defaultSpriteAsset",Xb[Wb.HOVER]="hoverSpriteAsset",Xb[Wb.PRESSED]="pressedSpriteAsset",Xb[Wb.INACTIVE]="inactiveSpriteAsset";var qb={};qb[Wb.DEFAULT]="_defaultSpriteFrame",qb[Wb.HOVER]="hoverSpriteFrame",qb[Wb.PRESSED]="pressedSpriteFrame",qb[Wb.INACTIVE]="inactiveSpriteFrame";var Yb=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._visualState=Wb.DEFAULT;i._isHovering=false;i._hoveringCounter=0;i._isPressed=false;i._defaultTint=new ge(1,1,1,1);i._defaultSpriteAsset=null;i._defaultSpriteFrame=0;i._imageReference=new Ub(H(i),"imageEntity",{"element#gain":i._onImageElementGain,"element#lose":i._onImageElementLose,"element#set:color":i._onSetColor,"element#set:opacity":i._onSetOpacity,"element#set:spriteAsset":i._onSetSpriteAsset,"element#set:spriteFrame":i._onSetSpriteFrame});i._toggleLifecycleListeners("on",e);return i}var t=e.prototype;t._toggleLifecycleListeners=function e(t,i){this[t]("set_active",this._onSetActive,this);this[t]("set_transitionMode",this._onSetTransitionMode,this);this[t]("set_hoverTint",this._onSetTransitionValue,this);this[t]("set_pressedTint",this._onSetTransitionValue,this);this[t]("set_inactiveTint",this._onSetTransitionValue,this);this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this);this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this);this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this);this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);i.app.systems.element[t]("add",this._onElementComponentAdd,this);i.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)};t._onSetActive=function e(t,i,n){if(i!==n)this._updateVisualState()};t._onSetTransitionMode=function e(t,i,n){if(i!==n){this._cancelTween();this._resetToDefaultVisualState(i);this._forceReapplyVisualState()}};t._onSetTransitionValue=function e(t,i,n){if(i!==n)this._forceReapplyVisualState()};t._onElementComponentRemove=function e(t){if(this.entity===t)this._toggleHitElementListeners("off")};t._onElementComponentAdd=function e(t){if(this.entity===t)this._toggleHitElementListeners("on")};t._onImageElementLose=function e(){this._cancelTween();this._resetToDefaultVisualState(this.transitionMode)};t._onImageElementGain=function e(){this._storeDefaultVisualState();this._forceReapplyVisualState()};t._toggleHitElementListeners=function e(t){if(this.entity.element){var i=t==="on";if(i&&this._hasHitElementListeners)return;this.entity.element[t]("mouseenter",this._onMouseEnter,this);this.entity.element[t]("mouseleave",this._onMouseLeave,this);this.entity.element[t]("mousedown",this._onMouseDown,this);this.entity.element[t]("mouseup",this._onMouseUp,this);this.entity.element[t]("touchstart",this._onTouchStart,this);this.entity.element[t]("touchend",this._onTouchEnd,this);this.entity.element[t]("touchleave",this._onTouchLeave,this);this.entity.element[t]("touchcancel",this._onTouchCancel,this);this.entity.element[t]("selectstart",this._onSelectStart,this);this.entity.element[t]("selectend",this._onSelectEnd,this);this.entity.element[t]("selectenter",this._onSelectEnter,this);this.entity.element[t]("selectleave",this._onSelectLeave,this);this.entity.element[t]("click",this._onClick,this);this._hasHitElementListeners=i}};t._storeDefaultVisualState=function e(){if(this._imageReference.hasComponent("element")){this._storeDefaultColor(this._imageReference.entity.element.color);this._storeDefaultOpacity(this._imageReference.entity.element.opacity);this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset);this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame)}};t._storeDefaultColor=function e(t){this._defaultTint.r=t.r;this._defaultTint.g=t.g;this._defaultTint.b=t.b};t._storeDefaultOpacity=function e(t){this._defaultTint.a=t};t._storeDefaultSpriteAsset=function e(t){this._defaultSpriteAsset=t};t._storeDefaultSpriteFrame=function e(t){this._defaultSpriteFrame=t};t._onSetColor=function e(t){if(!this._isApplyingTint){this._storeDefaultColor(t);this._forceReapplyVisualState()}};t._onSetOpacity=function e(t){if(!this._isApplyingTint){this._storeDefaultOpacity(t);this._forceReapplyVisualState()}};t._onSetSpriteAsset=function e(t){if(!this._isApplyingSprite){this._storeDefaultSpriteAsset(t);this._forceReapplyVisualState()}};t._onSetSpriteFrame=function e(t){if(!this._isApplyingSprite){this._storeDefaultSpriteFrame(t);this._forceReapplyVisualState()}};t._onMouseEnter=function e(t){this._isHovering=true;this._updateVisualState();this._fireIfActive("mouseenter",t)};t._onMouseLeave=function e(t){this._isHovering=false;this._isPressed=false;this._updateVisualState();this._fireIfActive("mouseleave",t)};t._onMouseDown=function e(t){this._isPressed=true;this._updateVisualState();this._fireIfActive("mousedown",t)};t._onMouseUp=function e(t){this._isPressed=false;this._updateVisualState();this._fireIfActive("mouseup",t)};t._onTouchStart=function e(t){this._isPressed=true;this._updateVisualState();this._fireIfActive("touchstart",t)};t._onTouchEnd=function e(t){t.event.preventDefault();this._isPressed=false;this._updateVisualState();this._fireIfActive("touchend",t)};t._onTouchLeave=function e(t){this._isPressed=false;this._updateVisualState();this._fireIfActive("touchleave",t)};t._onTouchCancel=function e(t){this._isPressed=false;this._updateVisualState();this._fireIfActive("touchcancel",t)};t._onSelectStart=function e(t){this._isPressed=true;this._updateVisualState();this._fireIfActive("selectstart",t)};t._onSelectEnd=function e(t){this._isPressed=false;this._updateVisualState();this._fireIfActive("selectend",t)};t._onSelectEnter=function e(t){this._hoveringCounter++;if(this._hoveringCounter===1){this._isHovering=true;this._updateVisualState()}this._fireIfActive("selectenter",t)};t._onSelectLeave=function e(t){this._hoveringCounter--;if(this._hoveringCounter===0){this._isHovering=false;this._isPressed=false;this._updateVisualState()}this._fireIfActive("selectleave",t)};t._onClick=function e(t){this._fireIfActive("click",t)};t._fireIfActive=function e(t,i){if(this.data.active)this.fire(t,i)};t._updateVisualState=function e(t){var i=this._visualState;var n=this._determineVisualState();if((i!==n||t)&&this.enabled){this._visualState=n;if(i===Wb.HOVER)this._fireIfActive("hoverend");if(i===Wb.PRESSED)this._fireIfActive("pressedend");if(n===Wb.HOVER)this._fireIfActive("hoverstart");if(n===Wb.PRESSED)this._fireIfActive("pressedstart");switch(this.transitionMode){case Gb:var r=jb[this._visualState];var s=this[r];this._applyTint(s);break;case Hb:var a=Xb[this._visualState];var o=qb[this._visualState];var l=this[a];var h=this[o];this._applySprite(l,h);break}}};t._forceReapplyVisualState=function e(){this._updateVisualState(true)};t._resetToDefaultVisualState=function e(t){if(this._imageReference.hasComponent("element"))switch(t){case Gb:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;case Hb:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame);break}};t._determineVisualState=function e(){if(!this.active)return Wb.INACTIVE;else if(this._isPressed)return Wb.PRESSED;else if(this._isHovering)return Wb.HOVER;return Wb.DEFAULT};t._applySprite=function e(t,i){i=i||0;if(this._imageReference.hasComponent("element")){this._isApplyingSprite=true;this._imageReference.entity.element.spriteAsset=t;this._imageReference.entity.element.spriteFrame=i;this._isApplyingSprite=false}};t._applyTint=function e(t){this._cancelTween();if(this.fadeDuration===0)this._applyTintImmediately(t);else this._applyTintWithTween(t)};t._applyTintImmediately=function e(t){if(this._imageReference.hasComponent("element")&&t){this._isApplyingTint=true;this._imageReference.entity.element.color=Kb(t);this._imageReference.entity.element.opacity=t.a;this._isApplyingTint=false}};t._applyTintWithTween=function e(t){if(this._imageReference.hasComponent("element")&&t){var i=this._imageReference.entity.element.color;var n=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:ye(),from:new ge(i.r,i.g,i.b,n),to:t.clone(),lerpColor:new ge}}};t._updateTintTween=function e(){var t=ye()-this._tweenInfo.startTime;var i=this.fadeDuration===0?1:t/this.fadeDuration;i=Pe.clamp(i,0,1);if(Math.abs(i-1)>1e-5){var n=this._tweenInfo.lerpColor;n.lerp(this._tweenInfo.from,this._tweenInfo.to,i);this._applyTintImmediately(new ge(n.r,n.g,n.b,n.a))}else{this._applyTintImmediately(this._tweenInfo.to);this._cancelTween()}};t._cancelTween=function e(){delete this._tweenInfo};t.onUpdate=function e(){if(this._tweenInfo)this._updateTintTween()};t.onEnable=function e(){this._isHovering=false;this._hoveringCounter=0;this._isPressed=false;this._imageReference.onParentComponentEnable();this._toggleHitElementListeners("on");this._forceReapplyVisualState()};t.onDisable=function e(){this._toggleHitElementListeners("off");this._resetToDefaultVisualState(this.transitionMode)};t.onRemove=function e(){this._toggleLifecycleListeners("off",this.system);this.onDisable()};return e}(R0);function Kb(e){return new ge(e.r,e.g,e.b)}var Qb=function e(){this.enabled=true;this.active=true;this.imageEntity=null;this.hitPadding=new ue;this.transitionMode=Gb;this.hoverTint=new ge(.75,.75,.75);this.pressedTint=new ge(.5,.5,.5);this.inactiveTint=new ge(.25,.25,.25);this.fadeDuration=0;this.hoverSpriteAsset=null;this.hoverSpriteFrame=0;this.pressedSpriteAsset=null;this.pressedSpriteFrame=0;this.inactiveSpriteAsset=null;this.inactiveSpriteFrame=0},$b=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],Zb=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="button";t.ComponentType=Yb;t.DataType=Qb;t.schema=$b;t.on("beforeremove",t._onRemoveComponent,H(t));L0.bind("update",t.onUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){r.prototype.initializeComponentData.call(this,t,i,$b)};t.onUpdate=function e(t){var i=this.store;for(var n in i){var r=i[n].entity;var s=r.button;if(s.enabled&&r.enabled)s.onUpdate()}};t._onRemoveComponent=function e(t,i){i.onRemove()};return e}(L0),Jb;R0._buildAccessors(Yb.prototype,$b);var ex=function(){function e(e,t){var i=this;this.app=e;this.camera=t;this.effects=[];this.enabled=false;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){i.resizeRenderTargets()};t.on("set_rect",this.onCameraRectChanged,this);this._origOverrideClear=false;this._origClearColorBuffer=false;this._origDepthColorBuffer=false;this._origStencilColorBuffer=false}var t=e.prototype;t._createOffscreenTarget=function e(t,i){var n=this.camera.rect;var r=Math.floor(n.z*this.app.graphicsDevice.width*this.renderTargetScale);var s=Math.floor(n.w*this.app.graphicsDevice.height*this.renderTargetScale);var a=this.app.graphicsDevice;var o=i?a.getHdrFormat():Kt;var l=this.app.graphicsDevice.supportsStencil;var h=t?a.samples:1;var c=new bu(a,{format:o,width:r,height:s});c.name="posteffect #"+this.effects.length;c.minFilter=Mt;c.magFilter=Mt;c.addressU=We;c.addressV=We;return new BM(this.app.graphicsDevice,c,{depth:t,stencil:l,samples:h})};t._resizeOffscreenTarget=function e(t){var i=this.camera.rect;var n=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale);var r=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale);var s=this.app.graphicsDevice;var a=t.colorBuffer.format;t._colorBuffer.destroy();var o=new bu(s,{format:a,width:n,height:r});o.name="posteffect";o.minFilter=Mt;o.magFilter=Mt;o.addressU=We;o.addressV=We;t._colorBuffer=o;t.destroy()};t._destroyOffscreenTarget=function e(t){if(t._colorBuffer)t._colorBuffer.destroy();if(t._depthBuffer)t._depthBuffer.destroy();t.destroy()};t.setRenderTargetScale=function e(t){this.renderTargetScale=t;this.resizeRenderTargets()};t.addEffect=function e(t){var i=this.effects.length===0;var n=this.effects;var r={effect:t,inputTarget:this._createOffscreenTarget(i,t.hdr),outputTarget:null};if(!this.layer){this.layer=new Vf({opaqueSortMode:Tc,transparentSortMode:Tc,passThrough:true,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:false,onPostRender:function e(){for(var t=0;t<this._commandList.length;t++)this._commandList[t]()}});var s=this.app.scene.layers.layerList;var a=0;var o;var l=s.length-1;for(o=l;o>=0;o--)if(s[o].id===Bl){l=o-1;this._origOverrideClear=s[o].overrideClear;this._origClearColorBuffer=s[o].clearColorBuffer;this._origDepthColorBuffer=s[o].clearDepthBuffer;this._origStencilColorBuffer=s[o].clearStencilBuffer;s[o].overrideClear=true;s[o].clearColorBuffer=false;s[o].clearDepthBuffer=this.camera.clearDepthBuffer;s[o].clearStencilBuffer=this.camera.clearStencilBuffer;break}this._sourceLayers=[];for(o=0;o<this.camera.layers.length;o++){var h=this.camera.layers[o];var c=this.app.scene.layers.getLayerById(h);var u=this.app.scene.layers.layerList.indexOf(c);if(u<=l){if(h!=kl){c.renderTarget=r.inputTarget;this._sourceLayers.push(c)}if(u>a)a=u}}this.app.scene.layers.insertOpaque(this.layer,a+1);this._sourceTarget=r.inputTarget;this.layer._commandList=[];this.layer.isPostEffect=true}n.push(r);var f=n.length;if(f>1)n[f-2].outputTarget=r.inputTarget;this._newPostEffect=t;if(t.needsDepthBuffer)this._requestDepthMap();this.enable();this._newPostEffect=undefined};t.removeEffect=function e(t){var i,n,r=-1;for(i=0,n=this.effects.length;i<n;i++)if(this.effects[i].effect===t){r=i;break}if(r>=0){if(r>0)this.effects[r-1].outputTarget=r+1<this.effects.length?this.effects[r+1].inputTarget:null;else if(this.effects.length>1){if(!this.effects[1].inputTarget._depth){this._destroyOffscreenTarget(this.effects[1].inputTarget);this.effects[1].inputTarget=this._createOffscreenTarget(true,this.effects[1].hdr);this._sourceTarget=this.effects[1].inputTarget}for(i=0;i<this._sourceLayers.length;i++)this._sourceLayers[i].renderTarget=this.effects[1].inputTarget}this._destroyOffscreenTarget(this.effects[r].inputTarget);this.effects.splice(r,1)}if(this.enabled)if(t.needsDepthBuffer)this._releaseDepthMap();if(this.effects.length===0)this.disable()};t._requestDepthMaps=function e(){for(var t=0,i=this.effects.length;t<i;t++){var n=this.effects[t].effect;if(this._newPostEffect===n)continue;if(n.needsDepthBuffer)this._requestDepthMap()}};t._releaseDepthMaps=function e(){for(var t=0,i=this.effects.length;t<i;t++){var n=this.effects[t].effect;if(n.needsDepthBuffer)this._releaseDepthMap()}};t._requestDepthMap=function e(){if(!Jb)Jb=this.app.scene.layers.getLayerById(kl);if(Jb)Jb.incrementCounter()};t._releaseDepthMap=function e(){if(Jb)Jb.decrementCounter()};t.destroy=function e(){for(var t=0,i=this.effects.length;t<i;t++)this.effects[t].inputTarget.destroy();this.effects.length=0;this.disable()};t.enable=function e(){if(!this.enabled&&this.effects.length){this.enabled=true;var r=this;this._requestDepthMaps();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=function(){if(r.enabled){var e=null;var t=r.effects.length;if(t){r.layer.renderTarget=r.effects[0].inputTarget;for(var i=0;i<t;i++){var n=r.effects[i];if(i===t-1)e=r.camera.rect;n.effect.render(n.inputTarget,n.outputTarget,e)}}}};this.layer._commandList.push(this.command)}};t.disable=function e(){if(this.enabled){this.enabled=false;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this._releaseDepthMaps();this._destroyOffscreenTarget(this._sourceTarget);var t=this.layer._commandList.indexOf(this.command);if(t>=0)this.layer._commandList.splice(t,1);var i=this.app.scene.layers.layerList;var n=i.length-1;for(t=0;t<=i.length;t++)if(i[t].id===Bl){n=t-1;i[t].overrideClear=this._origOverrideClear;i[t].clearColorBuffer=this._origClearColorBuffer;i[t].clearDepthBuffer=this._origDepthColorBuffer;i[t].clearStencilBuffer=this._origStencilColorBuffer;break}for(t=n;t>=0;t--)if(i[t].cameras.indexOf(this.camera)>=0)i[t].renderTarget=undefined;this.app.scene.layers.removeOpaque(this.layer);this.layer=null}};t._onCanvasResized=function e(t,i){var n=this.camera.rect;var r=this.app.graphicsDevice;this.camera.camera.aspectRatio=r.width*n.z/(r.height*n.w);if(this.resizeTimeout)return;if(ye()-this.resizeLast>100)this.resizeRenderTargets();else this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100)};t.resizeRenderTargets=function e(){if(this.resizeTimeout){clearTimeout(this.resizeTimeout);this.resizeTimeout=null}this.resizeLast=ye();var t=this.camera.rect;var i=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale);var n=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale);var r=this.effects;for(var s=0,a=r.length;s<a;s++){var o=r[s];if(o.inputTarget.width!==i||o.inputTarget.height!==n)this._resizeOffscreenTarget(o.inputTarget)}};t.onCameraRectChanged=function e(t,i,n){if(this.enabled)this.resizeRenderTargets()};return e}(),tx=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._camera=new hf;i._camera.node=t;i._priority=0;i._postEffects=new ex(e.app,H(i));return i}var t=e.prototype;t.screenToWorld=function e(t,i,n,r){var s=this.system.app.graphicsDevice;var a=s.clientRect.width;var o=s.clientRect.height;return this._camera.screenToWorld(t,i,n,a,o,r)};t.worldToScreen=function e(t,i){var n=this.system.app.graphicsDevice;var r=n.clientRect.width;var s=n.clientRect.height;return this._camera.worldToScreen(t,r,s,i)};t.onPrerender=function e(){this._camera._viewMatDirty=true;this._camera._viewProjMatDirty=true};t.addCameraToLayers=function e(){var t=this.layers;for(var i=0;i<t.length;i++){var n=this.system.app.scene.layers.getLayerById(t[i]);if(!n)continue;n.addCamera(this)}};t.removeCameraFromLayers=function e(){var t=this.layers;for(var i=0;i<t.length;i++){var n=this.system.app.scene.layers.getLayerById(t[i]);if(!n)continue;n.removeCamera(this)}};t.onLayersChanged=function e(t,i){this.addCameraToLayers();t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.addCamera(this)};t.onLayerRemoved=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.removeCamera(this)};t.onEnable=function e(){var t=this.system;var i=t.app.scene;var n=i.layers;t.addCamera(this);i.on("set:layers",this.onLayersChanged,this);if(n){n.on("add",this.onLayerAdded,this);n.on("remove",this.onLayerRemoved,this)}if(this.enabled&&this.entity.enabled)this.addCameraToLayers();this.postEffects.enable()};t.onDisable=function e(){var t=this.system;var i=t.app.scene;var n=i.layers;this.postEffects.disable();this.removeCameraFromLayers();i.off("set:layers",this.onLayersChanged,this);if(n){n.off("add",this.onLayerAdded,this);n.off("remove",this.onLayerRemoved,this)}t.removeCamera(this)};t.onRemove=function e(){this.onDisable();this.off()};t.calculateAspectRatio=function e(t){var i=t?t:this.system.app.graphicsDevice;var n=this.rect;return i.width*n.z/(i.height*n.w)};t.frameBegin=function e(t){if(this.aspectRatioMode===kc)this.aspectRatio=this.calculateAspectRatio(t)};t.frameEnd=function e(){};t.enterVr=function e(t,i){if(t instanceof Function&&!i){i=t;t=null}if(!this.system.app.vr){i("VrManager not created. Enable VR in project settings.");return}if(!t)t=this.system.app.vr.display;if(t){var n=this;if(t.capabilities.canPresent)t.requestPresent(function(e){if(!e){n.vrDisplay=t;n.vrDisplay.once("beforepresentchange",function(e){if(!e.presenting)n.vrDisplay=null})}i(e)});else{n.vrDisplay=t;i()}}else i("No pc.VrDisplay to present")};t.exitVr=function e(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var i=this.vrDisplay;this.vrDisplay=null;i.exitPresent(t)}else{this.vrDisplay=null;t()}else t("Not presenting VR")};t.startXr=function e(t,i,n){this.system.app.xr.start(this,t,i,n)};t.endXr=function e(t){if(!this._camera.xr){if(t)t(new Error("Camera is not in XR"));return}this._camera.xr.end(t)};U(e,[{key:"camera",get:function e(){return this._camera}},{key:"layers",get:function e(){return this._camera.layers},set:function e(t){var i,n;var r=this._camera.layers;for(i=0;i<r.length;i++){n=this.system.app.scene.layers.getLayerById(r[i]);if(!n)continue;n.removeCamera(this)}this._camera.layers=t;if(!this.enabled||!this.entity.enabled)return;for(i=0;i<t.length;i++){n=this.system.app.scene.layers.getLayerById(t[i]);if(!n)continue;n.addCamera(this)}}},{key:"postEffects",get:function e(){return this._postEffects}},{key:"priority",get:function e(){return this._priority},set:function e(t){this._priority=t;var i=this.layers;for(var n=0;n<i.length;n++){var r=this.system.app.scene.layers.getLayerById(i[n]);if(!r)continue;r._sortCameras()}}}]);return e}(R0);[{name:"aspectRatio",readonly:false},{name:"aspectRatioMode",readonly:false},{name:"calculateProjection",readonly:false},{name:"calculateTransform",readonly:false},{name:"clearColor",readonly:false},{name:"clearColorBuffer",readonly:false},{name:"clearDepthBuffer",readonly:false},{name:"clearStencilBuffer",readonly:false},{name:"cullFaces",readonly:false},{name:"farClip",readonly:false},{name:"flipFaces",readonly:false},{name:"fov",readonly:false},{name:"frustum",readonly:true},{name:"frustumCulling",readonly:false},{name:"horizontalFov",readonly:false},{name:"nearClip",readonly:false},{name:"orthoHeight",readonly:false},{name:"projection",readonly:false},{name:"projectionMatrix",readonly:true},{name:"rect",readonly:false},{name:"renderTarget",readonly:false},{name:"scissorRect",readonly:false},{name:"viewMatrix",readonly:true},{name:"vrDisplay",readonly:false}].forEach(function(e){var t=e.name;var i={};i.get=function(){return this._camera[t]};if(!e.readonly)i.set=function(e){this._camera[t]=e};Object.defineProperty(tx.prototype,t,i)});var ix=function e(){this.enabled=true},nx=["enabled"],rx=function(o){G(e,o);function e(e){var t;t=o.call(this,e)||this;t.id="camera";t.ComponentType=tx;t.DataType=ix;t.schema=nx;t.cameras=[];t.on("beforeremove",t.onBeforeRemove,H(t));t.app.on("prerender",t.onPrerender,H(t));L0.bind("update",t.onUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["aspectRatio","aspectRatioMode","calculateProjection","calculateTransform","clearColor","clearColorBuffer","clearDepthBuffer","clearStencilBuffer","cullFaces","farClip","flipFaces","fov","frustumCulling","horizontalFov","layers","renderTarget","nearClip","orthoHeight","projection","priority","rect","scissorRect"];for(var r=0;r<n.length;r++){var s=n[r];if(i.hasOwnProperty(s)){var a=i[s];switch(s){case"rect":case"scissorRect":if(Array.isArray(a))t[s]=new ue(a[0],a[1],a[2],a[3]);else t[s]=a;break;case"clearColor":if(Array.isArray(a))t[s]=new ge(a[0],a[1],a[2],a[3]);else t[s]=a;break;default:t[s]=a;break}}}o.prototype.initializeComponentData.call(this,t,i,["enabled"])};t.cloneComponent=function e(t,i){var n=t.camera;this.addComponent(i,{aspectRatio:n.aspectRatio,aspectRatioMode:n.aspectRatioMode,calculateProjection:n.calculateProjection,calculateTransform:n.calculateTransform,clearColor:n.clearColor,clearColorBuffer:n.clearColorBuffer,clearDepthBuffer:n.clearDepthBuffer,clearStencilBuffer:n.clearStencilBuffer,cullFaces:n.cullFaces,farClip:n.farClip,flipFaces:n.flipFaces,fov:n.fov,frustumCulling:n.frustumCulling,horizontalFov:n.horizontalFov,layers:n.layers,renderTarget:n.renderTarget,nearClip:n.nearClip,orthoHeight:n.orthoHeight,projection:n.projection,priority:n.priority,rect:n.rect,scissorRect:n.scissorRect})};t.onBeforeRemove=function e(t,i){this.removeCamera(i)};t.onUpdate=function e(t){if(this.app.vr){var i=this.store;for(var n in i){var r=i[n];if(r.data.enabled&&r.entity.enabled){var s=r.entity.camera;var a=s.vrDisplay;if(a){a.setClipPlanes(s.nearClip,s.farClip);if(r.entity){r.entity.localTransform.copy(a.combinedViewInv);r.entity._dirtyLocal=false;r.entity._dirtifyWorld()}}}}}};t.onPrerender=function e(){for(var t=0,i=this.cameras.length;t<i;t++)this.cameras[t].onPrerender()};t.addCamera=function e(t){this.cameras.push(t);this.sortCamerasByPriority()};t.removeCamera=function e(t){var i=this.cameras.indexOf(t);if(i>=0){this.cameras.splice(i,1);this.sortCamerasByPriority()}};t.sortCamerasByPriority=function e(){this.cameras.sort(function(e,t){return e.priority-t.priority})};return e}(L0);R0._buildAccessors(tx.prototype,nx);var sx=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._compoundParent=null;i.entity.on("insert",i._onInsert,H(i));i.on("set_type",i.onSetType,H(i));i.on("set_halfExtents",i.onSetHalfExtents,H(i));i.on("set_radius",i.onSetRadius,H(i));i.on("set_height",i.onSetHeight,H(i));i.on("set_axis",i.onSetAxis,H(i));i.on("set_asset",i.onSetAsset,H(i));i.on("set_model",i.onSetModel,H(i));return i}var t=e.prototype;t.onSetType=function e(t,i,n){if(i!==n)this.system.changeType(this,i,n)};t.onSetHalfExtents=function e(t,i,n){var r=this.data.type;if(this.data.initialized&&r==="box")this.system.recreatePhysicalShapes(this)};t.onSetRadius=function e(t,i,n){var r=this.data.type;if(this.data.initialized&&(r==="sphere"||r==="capsule"||r==="cylinder"||r==="cone"))this.system.recreatePhysicalShapes(this)};t.onSetHeight=function e(t,i,n){var r=this.data.type;if(this.data.initialized&&(r==="capsule"||r==="cylinder"||r==="cone"))this.system.recreatePhysicalShapes(this)};t.onSetAxis=function e(t,i,n){var r=this.data.type;if(this.data.initialized&&(r==="capsule"||r==="cylinder"||r==="cone"))this.system.recreatePhysicalShapes(this)};t.onSetAsset=function e(t,i,n){var r;var s=this.system.app.assets;if(i){r=s.get(i);if(r)r.off("remove",this.onAssetRemoved,this)}if(n){if(n instanceof O_)this.data.asset=n.id;r=s.get(this.data.asset);if(r){r.off("remove",this.onAssetRemoved,this);r.on("remove",this.onAssetRemoved,this)}}if(this.data.initialized&&this.data.type==="mesh"){if(!n)this.data.model=null;this.system.recreatePhysicalShapes(this)}};t.onSetModel=function e(t,i,n){if(this.data.initialized&&this.data.type==="mesh")this.system.implementations.mesh.doRecreatePhysicalShape(this)};t.onAssetRemoved=function e(t){t.off("remove",this.onAssetRemoved,this);if(this.data.asset===t.id)this.asset=null};t._getCompoundChildShapeIndex=function e(t){var i=this.data.shape;var n=i.getNumChildShapes();for(var r=0;r<n;r++){var s=i.getChildShape(r);if(s.ptr===t.ptr)return r}return null};t._onInsert=function e(t){if(typeof Ammo==="undefined")return;if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody){var i=this.entity.parent;while(i){if(i.collision&&i.collision.type==="compound"){if(i.collision.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(i.collision);else this.system.recreatePhysicalShapes(this);break}i=i.parent}}};t._updateCompound=function e(){var t=this.entity;if(t._dirtyWorld){var i=t._dirtyLocal;var n=t;while(n&&!i){if(n.collision&&n.collision===this._compoundParent)break;if(n._dirtyLocal)i=true;n=n.parent}if(i){t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t);var r=this._compoundParent.entity.rigidbody;if(r)r.activate()}}};t.onEnable=function e(){if(this.data.type==="mesh"&&this.data.asset&&this.data.initialized){var t=this.system.app.assets.get(this.data.asset);if(t&&(!t.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}if(this.entity.rigidbody){if(this.entity.rigidbody.enabled)this.entity.rigidbody.enableSimulation()}else if(this._compoundParent&&this!==this._compoundParent)if(this._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(this._compoundParent);else{var i=this.system._getNodeTransform(this.entity,this._compoundParent.entity);this._compoundParent.shape.addChildShape(i,this.data.shape);Ammo.destroy(i);if(this._compoundParent.entity.rigidbody)this._compoundParent.entity.rigidbody.activate()}else if(this.entity.trigger)this.entity.trigger.enable()};t.onDisable=function e(){if(this.entity.rigidbody)this.entity.rigidbody.disableSimulation();else if(this._compoundParent&&this!==this._compoundParent){if(!this._compoundParent.entity._destroying){this.system._removeCompoundChild(this._compoundParent,this.data.shape);if(this._compoundParent.entity.rigidbody)this._compoundParent.entity.rigidbody.activate()}}else if(this.entity.trigger)this.entity.trigger.disable()};t.onBeforeRemove=function e(){if(this.asset)this.asset=null;this.entity.off("insert",this._onInsert,this);this.off()};return e}(R0),ax=function e(){this.enabled=true;this.type="box";this.halfExtents=new ce(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.asset=null;this.shape=null;this.model=null;this.initialized=false},ox="static",lx="dynamic",hx="kinematic",cx=1,ux=2,fx=4,dx=1,px=2,mx=3,_x=4,vx=5,gx=0,yx=1,bx=1,xx=2,Sx=4,wx=8,Tx=16,Mx=32,Cx=64,Ax=128,Px=256,Ex=512,Ix=1024,Rx=2048,Lx=4096,Dx=8192,kx=16384,Ox=0,Fx=65535,Bx=2,Nx=65535^2,zx=65535^(2|4),Vx,Ux,Gx,Hx=function(){function e(e,t,i){this.entity=t.entity;this.component=t;this.app=e;if(typeof Ammo!=="undefined"&&!Vx){Vx=new Ammo.btVector3;Ux=new Ammo.btQuaternion;Gx=new Ammo.btTransform}this.initialize(i)}var t=e.prototype;t.initialize=function e(t){var i=this.entity;var n=t.shape;if(n&&typeof Ammo!=="undefined"){if(i.trigger)i.trigger.destroy();var r=1;var s=i.getPosition();var a=i.getRotation();Vx.setValue(s.x,s.y,s.z);Ux.setValue(a.x,a.y,a.z,a.w);Gx.setOrigin(Vx);Gx.setRotation(Ux);var o=this.app.systems.rigidbody.createBody(r,n,Gx);o.setRestitution(0);o.setFriction(0);o.setDamping(0,0);Vx.setValue(0,0,0);o.setLinearFactor(Vx);o.setAngularFactor(Vx);o.setCollisionFlags(o.getCollisionFlags()|fx);o.entity=i;this.body=o;if(this.component.enabled&&i.enabled)this.enable()}};t.destroy=function e(){var t=this.body;if(!t)return;this.disable();this.app.systems.rigidbody.destroyBody(t)};t._getEntityTransform=function e(t){var i=this.entity.getPosition();var n=this.entity.getRotation();Vx.setValue(i.x,i.y,i.z);Ux.setValue(n.x,n.y,n.z,n.w);t.setOrigin(Vx);t.setRotation(Ux)};t.updateTransform=function e(){this._getEntityTransform(Gx);var t=this.body;t.setWorldTransform(Gx);t.activate()};t.enable=function e(){var t=this.body;if(!t)return;var i=this.app.systems;i.rigidbody.addBody(t,Tx,Nx^Tx);i.rigidbody._triggers.push(this);t.forceActivationState(dx);this.updateTransform()};t.disable=function e(){var t=this.body;if(!t)return;var i=this.app.systems;var n=i.rigidbody._triggers.indexOf(this);if(n>-1)i.rigidbody._triggers.splice(n,1);i.rigidbody.removeBody(t);t.forceActivationState(vx)};return e}(),Wx=new ve,jx=new ce,Xx=new be,qx=["enabled","type","halfExtents","radius","axis","height","asset","shape","model"],Yx=function(){function e(e){this.system=e}var t=e.prototype;t.beforeInitialize=function e(t,i){i.shape=null;i.model=new Xu;i.model.graph=new Mf};t.afterInitialize=function e(t,i){this.recreatePhysicalShapes(t);t.data.initialized=true};t.reset=function e(t,i){this.beforeInitialize(t,i);this.afterInitialize(t,i)};t.recreatePhysicalShapes=function e(t){var i=t.entity;var n=t.data;if(typeof Ammo!=="undefined"){if(i.trigger){i.trigger.destroy();delete i.trigger}if(n.shape){if(t._compoundParent){this.system._removeCompoundChild(t._compoundParent,n.shape);if(t._compoundParent.entity.rigidbody)t._compoundParent.entity.rigidbody.activate()}Ammo.destroy(n.shape);n.shape=null}n.shape=this.createPhysicalShape(t.entity,n);var r=!t._compoundParent;if(n.type==="compound"&&(!t._compoundParent||t===t._compoundParent)){t._compoundParent=t;i.forEach(this._addEachDescendant,t)}else if(n.type!=="compound"){if(t._compoundParent&&t===t._compoundParent)i.forEach(this.system.implementations.compound._updateEachDescendant,t);if(!t.rigidbody){t._compoundParent=null;var s=i.parent;while(s){if(s.collision&&s.collision.type==="compound"){t._compoundParent=s.collision;break}s=s.parent}}}if(t._compoundParent)if(t!==t._compoundParent)if(r&&t._compoundParent.shape.getNumChildShapes()===0)this.system.recreatePhysicalShapes(t._compoundParent);else{this.system.updateCompoundChildTransform(i);if(t._compoundParent.entity.rigidbody)t._compoundParent.entity.rigidbody.activate()}if(i.rigidbody){i.rigidbody.disableSimulation();i.rigidbody.createBody();if(i.enabled&&i.rigidbody.enabled)i.rigidbody.enableSimulation()}else if(!t._compoundParent)if(!i.trigger)i.trigger=new Hx(this.system.app,t,n);else i.trigger.initialize(n)}};t.createPhysicalShape=function e(t,i){return undefined};t.updateTransform=function e(t,i,n,r){if(t.entity.trigger)t.entity.trigger.updateTransform()};t.beforeRemove=function e(t,i){if(i.data.shape){if(i._compoundParent&&!i._compoundParent.entity._destroying){this.system._removeCompoundChild(i._compoundParent,i.data.shape);if(i._compoundParent.entity.rigidbody)i._compoundParent.entity.rigidbody.activate()}i._compoundParent=null;Ammo.destroy(i.data.shape);i.data.shape=null}};t.remove=function e(t,i){var n=this.system.app;if(t.rigidbody&&t.rigidbody.body){n.systems.rigidbody.removeBody(t.rigidbody.body);t.rigidbody.disableSimulation()}if(t.trigger){t.trigger.destroy();delete t.trigger}if(n.scene.containsModel(i.model)){n.root.removeChild(i.model.graph);n.scene.removeModel(i.model)}};t.clone=function e(t,i){var n=this.system.store[t.getGuid()];var r={enabled:n.data.enabled,type:n.data.type,halfExtents:[n.data.halfExtents.x,n.data.halfExtents.y,n.data.halfExtents.z],radius:n.data.radius,axis:n.data.axis,height:n.data.height,asset:n.data.asset,model:n.data.model};return this.system.addComponent(i,r)};return e}(),Kx=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){if(typeof Ammo!=="undefined"){var n=i.halfExtents;var r=new Ammo.btVector3(n?n.x:.5,n?n.y:.5,n?n.z:.5);var s=new Ammo.btBoxShape(r);Ammo.destroy(r);return s}return undefined};return e}(Yx),Qx=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){if(typeof Ammo!=="undefined")return new Ammo.btSphereShape(i.radius);return undefined};return e}(Yx),$x=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){var n=null;var r=i.axis!==undefined?i.axis:1;var s=i.radius||.5;var a=Math.max((i.height||2)-2*s,0);if(typeof Ammo!=="undefined")switch(r){case 0:n=new Ammo.btCapsuleShapeX(s,a);break;case 1:n=new Ammo.btCapsuleShape(s,a);break;case 2:n=new Ammo.btCapsuleShapeZ(s,a);break}return n};return e}(Yx),Zx=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){var n=null;var r=null;var s=i.axis!==undefined?i.axis:1;var a=i.radius!==undefined?i.radius:.5;var o=i.height!==undefined?i.height:1;if(typeof Ammo!=="undefined")switch(s){case 0:n=new Ammo.btVector3(o*.5,a,a);r=new Ammo.btCylinderShapeX(n);break;case 1:n=new Ammo.btVector3(a,o*.5,a);r=new Ammo.btCylinderShape(n);break;case 2:n=new Ammo.btVector3(a,a,o*.5);r=new Ammo.btCylinderShapeZ(n);break}if(n)Ammo.destroy(n);return r};return e}(Yx),Jx=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){var n=null;var r=i.axis!==undefined?i.axis:1;var s=i.radius!==undefined?i.radius:.5;var a=i.height!==undefined?i.height:1;if(typeof Ammo!=="undefined")switch(r){case 0:n=new Ammo.btConeShapeX(s,a);break;case 1:n=new Ammo.btConeShape(s,a);break;case 2:n=new Ammo.btConeShapeZ(s,a);break}return n};return e}(Yx),eS=function(l){G(e,l);function e(e){return l.call(this,e)||this}var t=e.prototype;t.beforeInitialize=function e(t,i){};t.createPhysicalShape=function e(t,i){if(typeof Ammo!=="undefined"&&i.model){var n=i.model;var r=new Ammo.btCompoundShape;var s,a;for(s=0;s<n.meshInstances.length;s++){var o=n.meshInstances[s];var l=o.mesh;var h;if(this.system._triMeshCache[l.id])h=this.system._triMeshCache[l.id];else{var c=l.indexBuffer[mh];var u=l.vertexBuffer;var f=u.getFormat();var d=f.size/4;var p;for(a=0;a<f.elements.length;a++){var m=f.elements[a];if(m.name===Ci)p=new Float32Array(u.lock(),m.offset)}var _=new Uint16Array(c.lock());var v=l.primitive[0].count/3;var g=new Ammo.btVector3;var y=new Ammo.btVector3;var b=new Ammo.btVector3;var x,S,w;var T=l.primitive[0].base;h=new Ammo.btTriangleMesh;this.system._triMeshCache[l.id]=h;for(a=0;a<v;a++){x=_[T+a*3]*d;S=_[T+a*3+1]*d;w=_[T+a*3+2]*d;g.setValue(p[x],p[x+1],p[x+2]);y.setValue(p[S],p[S+1],p[S+2]);b.setValue(p[w],p[w+1],p[w+2]);h.addTriangle(g,y,b,true)}Ammo.destroy(g);Ammo.destroy(y);Ammo.destroy(b)}var M=true;var C=new Ammo.btBvhTriangleMeshShape(h,M);var A=this.system._getNodeScaling(o.node);C.setLocalScaling(A);Ammo.destroy(A);var P=this.system._getNodeTransform(o.node);r.addChildShape(P,C);Ammo.destroy(P)}var E=t.getWorldTransform();var I=E.getScale();var R=new Ammo.btVector3(I.x,I.y,I.z);r.setLocalScaling(R);Ammo.destroy(R);return r}return undefined};t.recreatePhysicalShapes=function e(t){var i=t.data;if(i.asset!==null&&t.enabled&&t.entity.enabled)this.loadModelAsset(t);else this.doRecreatePhysicalShape(t)};t.loadModelAsset=function e(t){var i=this;var n=t.data.asset;var r=t.data;var s=this.system.app.assets;var a=s.get(n);if(a){a.ready(function(e){r.model=e.resource;i.doRecreatePhysicalShape(t)});s.load(a)}else s.once("add:"+n,function(e){e.ready(function(e){r.model=e.resource;i.doRecreatePhysicalShape(t)});s.load(e)})};t.doRecreatePhysicalShape=function e(t){var i=t.entity;var n=t.data;if(n.model){this.destroyShape(n);n.shape=this.createPhysicalShape(i,n);if(i.rigidbody){i.rigidbody.disableSimulation();i.rigidbody.createBody();if(i.enabled&&i.rigidbody.enabled)i.rigidbody.enableSimulation()}else if(!i.trigger)i.trigger=new Hx(this.system.app,t,n);else i.trigger.initialize(n)}else{this.beforeRemove(i,t);this.remove(i,n)}};t.updateTransform=function e(t,i,n,r){if(t.shape){var s=t.entity.getWorldTransform();var a=s.getScale();var o=t.shape.getLocalScaling();if(a.x!==o.x()||a.y!==o.y()||a.z!==o.z())this.doRecreatePhysicalShape(t)}l.prototype.updateTransform.call(this,t,i,n,r)};t.destroyShape=function e(t){if(!t.shape)return;var i=t.shape.getNumChildShapes();for(var n=0;n<i;n++){var r=t.shape.getChildShape(n);Ammo.destroy(r)}Ammo.destroy(t.shape);t.shape=null};t.remove=function e(t,i){this.destroyShape(i);l.prototype.remove.call(this,t,i)};return e}(Yx),tS=function(t){G(e,t);function e(e){return t.call(this,e)||this}var i=e.prototype;i.createPhysicalShape=function e(t,i){if(typeof Ammo!=="undefined")return new Ammo.btCompoundShape;return undefined};i._addEachDescendant=function e(t){if(!t.collision||t.rigidbody)return;t.collision._compoundParent=this;if(t!==this.entity)t.collision.system.recreatePhysicalShapes(t.collision)};i._updateEachDescendant=function e(t){if(!t.collision)return;if(t.collision._compoundParent!==this)return;t.collision._compoundParent=null;if(t!==this.entity&&!t.rigidbody)t.collision.system.recreatePhysicalShapes(t.collision)};i._updateEachDescendantTransform=function e(t){if(!t.collision||t.collision._compoundParent!==this.collision._compoundParent)return;this.collision.system.updateCompoundChildTransform(t)};return e}(Yx),iS=function(c){G(e,c);function e(e){var t;t=c.call(this,e)||this;t.id="collision";t.ComponentType=sx;t.DataType=ax;t.schema=qx;t.implementations={};t._triMeshCache={};t.on("beforeremove",t.onBeforeRemove,H(t));t.on("remove",t.onRemove,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["type","halfExtents","radius","axis","height","shape","model","asset","enabled"];var r={};for(var s=0,a=n.length;s<a;s++){var o=n[s];r[o]=i[o]}var l;if(i.hasOwnProperty("asset")){l=n.indexOf("model");if(l!==-1)n.splice(l,1)}else if(i.hasOwnProperty("model")){l=n.indexOf("asset");if(l!==-1)n.splice(l,1)}if(!r.type)r.type=t.data.type;t.data.type=r.type;if(r.halfExtents&&Array.isArray(r.halfExtents))r.halfExtents=new ce(r.halfExtents[0],r.halfExtents[1],r.halfExtents[2]);var h=this._createImplementation(r.type);h.beforeInitialize(t,r);c.prototype.initializeComponentData.call(this,t,r,n);h.afterInitialize(t,r)};t._createImplementation=function e(t){if(this.implementations[t]===undefined){var i;switch(t){case"box":i=new Kx(this);break;case"sphere":i=new Qx(this);break;case"capsule":i=new $x(this);break;case"cylinder":i=new Zx(this);break;case"cone":i=new Jx(this);break;case"mesh":i=new eS(this);break;case"compound":i=new tS(this);break}this.implementations[t]=i}return this.implementations[t]};t._getImplementation=function e(t){return this.implementations[t.collision.data.type]};t.cloneComponent=function e(t,i){return this._getImplementation(t).clone(t,i)};t.onBeforeRemove=function e(t,i){this.implementations[i.data.type].beforeRemove(t,i);i.onBeforeRemove()};t.onRemove=function e(t,i){this.implementations[i.type].remove(t,i)};t.updateCompoundChildTransform=function e(t){this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape);if(t.enabled&&t.collision.enabled){var i=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(i,t.collision.data.shape);Ammo.destroy(i)}};t._removeCompoundChild=function e(t,i){if(t.shape.removeChildShape)t.shape.removeChildShape(i);else{var n=t._getCompoundChildShapeIndex(i);if(n!==null)t.shape.removeChildShapeByIndex(n)}};t.onTransformChanged=function e(t,i,n,r){this.implementations[t.data.type].updateTransform(t,i,n,r)};t.changeType=function e(t,i,n){this.implementations[i].beforeRemove(t.entity,t);this.implementations[i].remove(t.entity,t.data);this._createImplementation(n).reset(t,t.data)};t.recreatePhysicalShapes=function e(t){this.implementations[t.data.type].recreatePhysicalShapes(t)};t._calculateNodeRelativeTransform=function e(t,i){if(t===i){var n=t.getWorldTransform().getScale();Wx.setScale(n.x,n.y,n.z)}else{this._calculateNodeRelativeTransform(t.parent,i);Wx.mul(t.getLocalTransform())}};t._getNodeScaling=function e(t){var i=t.getWorldTransform();var n=i.getScale();return new Ammo.btVector3(n.x,n.y,n.z)};t._getNodeTransform=function e(t,i){var n,r;if(i){this._calculateNodeRelativeTransform(t,i);n=jx;r=Xx;Wx.getTranslation(n);r.setFromMat4(Wx)}else{n=t.getPosition();r=t.getRotation()}var s=new Ammo.btTransform;s.setIdentity();var a=s.getOrigin();a.setValue(n.x,n.y,n.z);var o=new Ammo.btQuaternion;o.setValue(r.x,r.y,r.z,r.w);s.setRotation(o);Ammo.destroy(o);Ammo.destroy(a);return s};t.destroy=function e(){for(var t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null;c.prototype.destroy.call(this)};return e}(L0);R0._buildAccessors(sx.prototype,qx);var nS=function(){function e(){this.list=[]}var t=e.prototype;t.add=function e(t){var i=t.id;if(this[i])throw new Error("ComponentSystem name '"+i+"' already registered or not allowed");this[i]=t;this.list.push(t)};t.remove=function e(t){var i=t.id;if(!this[i])throw new Error("No ComponentSystem named '"+i+"' registered");delete this[i];var n=this.list.indexOf(this[i]);if(n!==-1)this.list.splice(n,1)};return e}(),rS="group",sS="image",aS="text",oS=function(){function t(e){this.func=e.func===undefined?Nt:e.func;this.ref=e.ref||0;this.readMask=e.readMask===undefined?255:e.readMask;this.writeMask=e.writeMask===undefined?255:e.writeMask;this.fail=e.fail||an;this.zfail=e.zfail||an;this.zpass=e.zpass||an}var e=t.prototype;e.clone=function e(){return new t({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})};return t}(),lS=function(){function e(e,t,i){this._entity=e;this._element=e.element;this.model=new Xu;this.node=new Mf;this.model.graph=this.node;this.mesh=t;this.meshInstance=new zu(this.node,this.mesh,i);this.meshInstance.name="ImageElement: "+e.name;this.meshInstance.castShadow=false;this.meshInstance.receiveShadow=false;this._meshDirty=false;this.model.meshInstances.push(this.meshInstance);this._entity.addChild(this.model.graph);this.model._entity=this._entity;this.unmaskMeshInstance=null}var t=e.prototype;t.destroy=function e(){this.setMaterial(null);this._element.removeModelFromLayers(this.model);this.model.destroy();this.model=null;this.node=null;this.mesh=null;this.meshInstance=null;this._entity=null;this._element=null};t.setMesh=function e(t){if(!this.meshInstance)return;this.mesh=t;this.meshInstance.mesh=t;this.meshInstance.visible=!!t;if(this.unmaskMeshInstance)this.unmaskMeshInstance.mesh=t;this.forceUpdateAabb()};t.setMask=function e(t){if(!this.meshInstance)return;if(t){this.unmaskMeshInstance=new zu(this.node,this.mesh,this.meshInstance.material);this.unmaskMeshInstance.name="Unmask: "+this._entity.name;this.unmaskMeshInstance.castShadow=false;this.unmaskMeshInstance.receiveShadow=false;this.unmaskMeshInstance.pick=false;this.model.meshInstances.push(this.unmaskMeshInstance);for(var i in this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(i,this.meshInstance.parameters[i].data)}else{var n=this.model.meshInstances.indexOf(this.unmaskMeshInstance);if(n>=0)this.model.meshInstances.splice(n,1);this.unmaskMeshInstance=null}if(this._entity.enabled&&this._element.enabled){this._element.removeModelFromLayers(this.model);this._element.addModelToLayers(this.model)}};t.setMaterial=function e(t){if(!this.meshInstance)return;this.meshInstance.material=t;if(this.unmaskMeshInstance)this.unmaskMeshInstance.material=t};t.setParameter=function e(t,i){if(!this.meshInstance)return;this.meshInstance.setParameter(t,i);if(this.unmaskMeshInstance)this.unmaskMeshInstance.setParameter(t,i)};t.deleteParameter=function e(t){if(!this.meshInstance)return;this.meshInstance.deleteParameter(t);if(this.unmaskMeshInstance)this.unmaskMeshInstance.deleteParameter(t)};t.setUnmaskDrawOrder=function e(){if(!this.meshInstance)return;var t=function e(t){var i;var n=t.children;var r=n.length;if(r){for(var s=0;s<r;s++)if(n[s].element)i=n[s];if(!i)return null;var a=e(i);if(a)return a;return i}return null};if(this.unmaskMeshInstance){var i=t(this._entity);if(i&&i.element)this.unmaskMeshInstance.drawOrder=i.element.drawOrder+i.element.getMaskOffset();else this.unmaskMeshInstance.drawOrder=this.meshInstance.drawOrder+this._element.getMaskOffset()}};t.setDrawOrder=function e(t){if(!this.meshInstance)return;this.meshInstance.drawOrder=t};t.setCull=function e(t){if(!this.meshInstance)return;var i=this._element;var n=null;if(t&&i._isScreenCulled())n=function e(t){return i.isVisibleForCamera(t)};this.meshInstance.cull=t;this.meshInstance.isVisibleFunc=n;if(this.unmaskMeshInstance){this.unmaskMeshInstance.cull=t;this.unmaskMeshInstance.isVisibleFunc=n}};t.setScreenSpace=function e(t){if(!this.meshInstance)return;this.meshInstance.screenSpace=t;if(this.unmaskMeshInstance)this.unmaskMeshInstance.screenSpace=t};t.setLayer=function e(t){if(!this.meshInstance)return;this.meshInstance.layer=t;if(this.unmaskMeshInstance)this.unmaskMeshInstance.layer=t};t.forceUpdateAabb=function e(t){if(!this.meshInstance)return;this.meshInstance._aabbVer=-1;if(this.unmaskMeshInstance)this.unmaskMeshInstance._aabbVer=-1};t.setAabbFunc=function e(t){if(!this.meshInstance)return;this.meshInstance._updateAabbFunc=t;if(this.unmaskMeshInstance)this.unmaskMeshInstance._updateAabbFunc=t};return e}(),hS=function(){function e(e){this._element=e;this._entity=e.entity;this._system=e.system;this._textureAsset=null;this._texture=null;this._materialAsset=null;this._material=null;this._spriteAsset=null;this._sprite=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new ue(0,0,1,1);this._mask=false;this._maskRef=0;this._outerScale=new he;this._outerScaleUniform=new Float32Array(2);this._innerOffset=new ue;this._innerOffsetUniform=new Float32Array(4);this._atlasRect=new ue;this._atlasRectUniform=new Float32Array(4);this._defaultMesh=this._createMesh();this._renderable=new lS(this._entity,this._defaultMesh,this._material);this._color=new ge(1,1,1,1);this._colorUniform=new Float32Array([1,1,1]);this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",1);this._updateAabbFunc=this._updateAabb.bind(this);this._onScreenChange(this._element.screen);this._element.on("resize",this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)}var t=e.prototype;t.destroy=function e(){this.textureAsset=null;this.spriteAsset=null;this.materialAsset=null;this._renderable.setMesh(this._defaultMesh);this._renderable.destroy();this._defaultMesh=null;this._element.off("resize",this._onParentResizeOrPivotChange,this);this._element.off("set:pivot",this._onParentResizeOrPivotChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)};t._onResolutionChange=function e(t){};t._onParentResizeOrPivotChange=function e(){if(this._renderable.mesh)this._updateMesh(this._renderable.mesh)};t._onScreenSpaceChange=function e(t){this._updateMaterial(t)};t._onScreenChange=function e(t,i){if(t)this._updateMaterial(t.screen.screenSpace);else this._updateMaterial(false)};t._onDrawOrderChange=function e(t){this._renderable.setDrawOrder(t);if(this.mask&&this._element.screen)this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)};t._hasUserMaterial=function e(){return!!this._materialAsset||!!this._material&&this._system.defaultImageMaterials.indexOf(this._material)===-1};t._use9Slicing=function e(){return this.sprite&&(this.sprite.renderMode===vc||this.sprite.renderMode===gc)};t._updateMaterial=function e(t){var i=!!this._mask;var n=!!(this.sprite&&this.sprite.renderMode===vc);var r=!!(this.sprite&&this.sprite.renderMode===gc);if(!this._hasUserMaterial())this._material=this._system.getImageElementMaterial(t,i,n,r);if(this._renderable){this._renderable.setCull(true);this._renderable.setMaterial(this._material);this._renderable.setScreenSpace(t);this._renderable.setLayer(t?El:Ll)}};t._createMesh=function e(){var t=this._element;var i=t.calculatedWidth;var n=t.calculatedHeight;var r=this._rect;var s=new ArrayBuffer(4*8*4);var a=new Float32Array(s);a[5]=1;a[6]=r.x;a[7]=r.y;a[8]=i;a[13]=1;a[14]=r.x+r.z;a[15]=r.y;a[16]=i;a[17]=n;a[21]=1;a[22]=r.x+r.z;a[23]=r.y+r.w;a[25]=n;a[29]=1;a[30]=r.x;a[31]=r.y+r.w;var o=[{semantic:Ci,components:3,type:In},{semantic:Ai,components:3,type:In},{semantic:Di,components:2,type:In}];var l=this._system.app.graphicsDevice;var h=new cr(l,o);var c=new lr(l,h,4,lt,s);var u=new Du(l);u.vertexBuffer=c;u.primitive[0].type=Mi;u.primitive[0].base=0;u.primitive[0].count=4;u.primitive[0].indexed=false;u.aabb.setMinMax(ce.ZERO,new ce(i,n,0));this._updateMesh(u);return u};t._updateMesh=function e(t){var i=this._element;var n=i.calculatedWidth;var r=i.calculatedHeight;var s=i._isScreenSpace();this._updateMaterial(s);if(this._renderable)this._renderable.forceUpdateAabb();if(this.sprite&&(this.sprite.renderMode===vc||this.sprite.renderMode===gc)){var a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];var o=2/a.rect.z;var l=2/a.rect.w;this._innerOffset.set(a.border.x*o,a.border.y*l,a.border.z*o,a.border.w*l);var h=this.sprite.atlas.texture;this._atlasRect.set(a.rect.x/h.width,a.rect.y/h.height,a.rect.z/h.width,a.rect.w/h.height);var c=this._pixelsPerUnit!==null?this._pixelsPerUnit:this.sprite.pixelsPerUnit;var u=a.rect.z/c;var f=a.rect.w/c;this._outerScale.set(Math.max(n,this._innerOffset.x*u),Math.max(r,this._innerOffset.y*f));var d=u;var p=f;this._outerScale.x/=u;this._outerScale.y/=f;d*=Pe.clamp(n/(this._innerOffset.x*u),1e-4,1);p*=Pe.clamp(r/(this._innerOffset.y*f),1e-4,1);if(this._renderable){this._innerOffsetUniform[0]=this._innerOffset.x;this._innerOffsetUniform[1]=this._innerOffset.y;this._innerOffsetUniform[2]=this._innerOffset.z;this._innerOffsetUniform[3]=this._innerOffset.w;this._renderable.setParameter("innerOffset",this._innerOffsetUniform);this._atlasRectUniform[0]=this._atlasRect.x;this._atlasRectUniform[1]=this._atlasRect.y;this._atlasRectUniform[2]=this._atlasRect.z;this._atlasRectUniform[3]=this._atlasRect.w;this._renderable.setParameter("atlasRect",this._atlasRectUniform);this._outerScaleUniform[0]=this._outerScale.x;this._outerScaleUniform[1]=this._outerScale.y;this._renderable.setParameter("outerScale",this._outerScaleUniform);this._renderable.setAabbFunc(this._updateAabbFunc);this._renderable.node.setLocalScale(d,p,1);this._renderable.node.setLocalPosition((.5-i.pivot.x)*n,(.5-i.pivot.y)*r,0)}}else{var m=t.vertexBuffer;var _=new Float32Array(m.lock());var v=i.pivot.x;var g=i.pivot.y;_[0]=0-v*n;_[1]=0-g*r;_[8]=n-v*n;_[9]=0-g*r;_[16]=n-v*n;_[17]=r-g*r;_[24]=0-v*n;_[25]=r-g*r;var y=1;var b=1;var x=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var S=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];if(S){x=S.rect;y=this._sprite.atlas.texture.width;b=this._sprite.atlas.texture.height}}_[6]=x.x/y;_[7]=x.y/b;_[14]=(x.x+x.z)/y;_[15]=x.y/b;_[22]=(x.x+x.z)/y;_[23]=(x.y+x.w)/b;_[30]=x.x/y;_[31]=(x.y+x.w)/b;m.unlock();var w=new ce(0-v*n,0-g*r,0);var T=new ce(n-v*n,r-g*r,0);t.aabb.setMinMax(w,T);if(this._renderable){this._renderable.node.setLocalScale(1,1,1);this._renderable.node.setLocalPosition(0,0,0);this._renderable.setAabbFunc(null)}}this._meshDirty=false};t._updateSprite=function e(){var t=false;var i=null;if(this._sprite&&this._sprite.atlas){i=this._sprite.meshes[this.spriteFrame];t=this._sprite.renderMode===vc||this._sprite.renderMode===gc}this.mesh=t?i:this._defaultMesh;if(this.mesh)if(!this._element._beingInitialized)this._updateMesh(this.mesh);else this._meshDirty=true};t._updateAabb=function e(t){t.center.set(0,0,0);t.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001);t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform());return t};t._toggleMask=function e(){this._element._dirtifyMask();var t=this._element._isScreenSpace();this._updateMaterial(t);this._renderable.setMask(!!this._mask)};t._onMaterialLoad=function e(t){this.material=t.resource};t._onMaterialAdded=function e(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this);if(this._materialAsset===t.id)this._bindMaterialAsset(t)};t._bindMaterialAsset=function e(t){if(!this._entity.enabled)return;t.on("load",this._onMaterialLoad,this);t.on("change",this._onMaterialChange,this);t.on("remove",this._onMaterialRemove,this);if(t.resource)this._onMaterialLoad(t);else this._system.app.assets.load(t)};t._unbindMaterialAsset=function e(t){t.off("load",this._onMaterialLoad,this);t.off("change",this._onMaterialChange,this);t.off("remove",this._onMaterialRemove,this)};t._onMaterialChange=function e(){};t._onMaterialRemove=function e(){};t._onTextureAdded=function e(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this);if(this._textureAsset===t.id)this._bindTextureAsset(t)};t._bindTextureAsset=function e(t){if(!this._entity.enabled)return;t.on("load",this._onTextureLoad,this);t.on("change",this._onTextureChange,this);t.on("remove",this._onTextureRemove,this);if(t.resource)this._onTextureLoad(t);else this._system.app.assets.load(t)};t._unbindTextureAsset=function e(t){t.off("load",this._onTextureLoad,this);t.off("change",this._onTextureChange,this);t.off("remove",this._onTextureRemove,this)};t._onTextureLoad=function e(t){this.texture=t.resource};t._onTextureChange=function e(t){};t._onTextureRemove=function e(t){};t._onSpriteAssetAdded=function e(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this);if(this._spriteAsset===t.id)this._bindSpriteAsset(t)};t._bindSpriteAsset=function e(t){if(!this._entity.enabled)return;t.on("load",this._onSpriteAssetLoad,this);t.on("change",this._onSpriteAssetChange,this);t.on("remove",this._onSpriteAssetRemove,this);if(t.resource)this._onSpriteAssetLoad(t);else this._system.app.assets.load(t)};t._unbindSpriteAsset=function e(t){t.off("load",this._onSpriteAssetLoad,this);t.off("change",this._onSpriteAssetChange,this);t.off("remove",this._onSpriteAssetRemove,this);if(t.data.textureAtlasAsset)this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)};t._onSpriteAssetLoad=function e(t){if(!t||!t.resource)this.sprite=null;else if(!t.resource.atlas){var i=t.data.textureAtlasAsset;if(i){var n=this._system.app.assets;n.off("load:"+i,this._onTextureAtlasLoad,this);n.once("load:"+i,this._onTextureAtlasLoad,this)}}else this.sprite=t.resource};t._onSpriteAssetChange=function e(t){this._onSpriteAssetLoad(t)};t._onSpriteAssetRemove=function e(t){};t._bindSprite=function e(t){t.on("set:meshes",this._onSpriteMeshesChange,this);t.on("set:pixelsPerUnit",this._onSpritePpuChange,this);t.on("set:atlas",this._onAtlasTextureChange,this);if(t.atlas)t.atlas.on("set:texture",this._onAtlasTextureChange,this)};t._unbindSprite=function e(t){t.off("set:meshes",this._onSpriteMeshesChange,this);t.off("set:pixelsPerUnit",this._onSpritePpuChange,this);t.off("set:atlas",this._onAtlasTextureChange,this);if(t.atlas)t.atlas.off("set:texture",this._onAtlasTextureChange,this)};t._onSpriteMeshesChange=function e(){if(this._sprite)this._spriteFrame=Pe.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1);this._updateSprite()};t._onSpritePpuChange=function e(){if(this.sprite.renderMode!==_c&&this._pixelsPerUnit===null)this._updateSprite()};t._onAtlasTextureChange=function e(){if(this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture){this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture);this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)}else{this._renderable.deleteParameter("texture_emissiveMap");this._renderable.deleteParameter("texture_opacityMap")}};t._onTextureAtlasLoad=function e(t){var i=this._spriteAsset;if(i instanceof O_)this._onSpriteAssetLoad(i);else this._onSpriteAssetLoad(this._system.app.assets.get(i))};t.onEnable=function e(){var t;if(this._materialAsset){t=this._system.app.assets.get(this._materialAsset);if(t&&t.resource!==this._material)this._bindMaterialAsset(t)}if(this._textureAsset){t=this._system.app.assets.get(this._textureAsset);if(t&&t.resource!==this._texture)this._bindTextureAsset(t)}if(this._spriteAsset){t=this._system.app.assets.get(this._spriteAsset);if(t&&t.resource!==this._sprite)this._bindSpriteAsset(t)}this._element.addModelToLayers(this._renderable.model)};t.onDisable=function e(){this._element.removeModelFromLayers(this._renderable.model)};t._setStencil=function e(t){this._renderable.meshInstance.stencilFront=t;this._renderable.meshInstance.stencilBack=t;var i=0;if(this._element.maskedBy)i=this._element.maskedBy.element._image._maskRef;if(this._renderable.unmaskMeshInstance){var n=new oS({ref:i+1,func:Dt,zpass:un});this._renderable.unmaskMeshInstance.stencilFront=n;this._renderable.unmaskMeshInstance.stencilBack=n}};U(e,[{key:"color",get:function e(){return this._color},set:function e(t){var i=t.r;var n=t.g;var r=t.b;if(this._color.r===i&&this._color.g===n&&this._color.b===r)return;this._color.r=i;this._color.g=n;this._color.b=r;this._colorUniform[0]=i;this._colorUniform[1]=n;this._colorUniform[2]=r;this._renderable.setParameter("material_emissive",this._colorUniform);if(this._element)this._element.fire("set:color",this._color)}},{key:"opacity",get:function e(){return this._color.a},set:function e(t){if(t===this._color.a)return;this._color.a=t;this._renderable.setParameter("material_opacity",t);if(this._element)this._element.fire("set:opacity",t)}},{key:"rect",get:function e(){return this._rect},set:function e(t){var i,n,r,s;if(t instanceof ue){i=t.x;n=t.y;r=t.z;s=t.w}else{i=t[0];n=t[1];r=t[2];s=t[3]}if(i===this._rect.x&&n===this._rect.y&&r===this._rect.z&&s===this._rect.w)return;this._rect.set(i,n,r,s);if(this._renderable.mesh)if(!this._element._beingInitialized)this._updateMesh(this._renderable.mesh);else this._meshDirty=true}},{key:"material",get:function e(){return this._material},set:function e(t){if(this._material===t)return;if(!t){var i=this._element._isScreenSpace();if(this.mask)t=i?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial;else t=i?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial}this._material=t;if(t){this._renderable.setMaterial(t);if(this._hasUserMaterial()){this._renderable.deleteParameter("material_opacity");this._renderable.deleteParameter("material_emissive")}else{this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b;this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",this._color.a)}}}},{key:"materialAsset",get:function e(){return this._materialAsset},set:function e(t){var i=this._system.app.assets;var n=t;if(t instanceof O_)n=t.id;if(this._materialAsset!==n){if(this._materialAsset){i.off("add:"+this._materialAsset,this._onMaterialAdded,this);var r=i.get(this._materialAsset);if(r){r.off("load",this._onMaterialLoad,this);r.off("change",this._onMaterialChange,this);r.off("remove",this._onMaterialRemove,this)}}this._materialAsset=n;if(this._materialAsset){var s=i.get(this._materialAsset);if(!s){this.material=null;i.on("add:"+this._materialAsset,this._onMaterialAdded,this)}else this._bindMaterialAsset(s)}else this.material=null}}},{key:"texture",get:function e(){return this._texture},set:function e(t){if(this._texture===t)return;if(this._textureAsset){var i=this._system.app.assets.get(this._textureAsset);if(i&&i.resource!==t)this.textureAsset=null}this._texture=t;if(t){if(this._spriteAsset)this.spriteAsset=null;this._renderable.setParameter("texture_emissiveMap",this._texture);this._renderable.setParameter("texture_opacityMap",this._texture);this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b;this._renderable.setParameter("material_emissive",this._colorUniform);this._renderable.setParameter("material_opacity",this._color.a)}else{this._renderable.deleteParameter("texture_emissiveMap");this._renderable.deleteParameter("texture_opacityMap")}}},{key:"textureAsset",get:function e(){return this._textureAsset},set:function e(t){var i=this._system.app.assets;var n=t;if(t instanceof O_)n=t.id;if(this._textureAsset!==n){if(this._textureAsset){i.off("add:"+this._textureAsset,this._onTextureAdded,this);var r=i.get(this._textureAsset);if(r){r.off("load",this._onTextureLoad,this);r.off("change",this._onTextureChange,this);r.off("remove",this._onTextureRemove,this)}}this._textureAsset=n;if(this._textureAsset){var s=i.get(this._textureAsset);if(!s){this.texture=null;i.on("add:"+this._textureAsset,this._onTextureAdded,this)}else this._bindTextureAsset(s)}else this.texture=null}}},{key:"spriteAsset",get:function e(){return this._spriteAsset},set:function e(t){var i=this._system.app.assets;var n=t;if(t instanceof O_)n=t.id;if(this._spriteAsset!==n){if(this._spriteAsset){i.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this);var r=i.get(this._spriteAsset);if(r)this._unbindSpriteAsset(r)}this._spriteAsset=n;if(this._spriteAsset){var s=i.get(this._spriteAsset);if(!s){this.sprite=null;i.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)}else this._bindSpriteAsset(s)}else this.sprite=null;if(this._element)this._element.fire("set:spriteAsset",n)}}},{key:"sprite",get:function e(){return this._sprite},set:function e(t){if(this._sprite===t)return;if(this._sprite)this._unbindSprite(this._sprite);if(this._spriteAsset){var i=this._system.app.assets.get(this._spriteAsset);if(i&&i.resource!==t)this.spriteAsset=null}this._sprite=t;if(this._sprite){this._bindSprite(this._sprite);if(this._textureAsset)this.textureAsset=null}if(this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture){this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture);this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)}else{this._renderable.deleteParameter("texture_emissiveMap");this._renderable.deleteParameter("texture_opacityMap")}if(this._sprite)this._spriteFrame=Pe.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1);this._updateSprite()}},{key:"spriteFrame",get:function e(){return this._spriteFrame},set:function e(t){var i=this._spriteFrame;if(this._sprite)this._spriteFrame=Pe.clamp(t,0,this._sprite.frameKeys.length-1);else this._spriteFrame=t;if(this._spriteFrame===i)return;this._updateSprite();if(this._element)this._element.fire("set:spriteFrame",t)}},{key:"mesh",get:function e(){return this._renderable.mesh},set:function e(t){this._renderable.setMesh(t);if(this._defaultMesh===t)this._renderable.setAabbFunc(null);else this._renderable.setAabbFunc(this._updateAabbFunc)}},{key:"mask",get:function e(){return this._mask},set:function e(t){if(this._mask!==t){this._mask=t;this._toggleMask()}}},{key:"pixelsPerUnit",get:function e(){return this._pixelsPerUnit},set:function e(t){if(this._pixelsPerUnit===t)return;this._pixelsPerUnit=t;if(this._sprite&&(this._sprite.renderMode===vc||this._sprite.renderMode===gc))this._updateSprite()}},{key:"aabb",get:function e(){if(this._renderable.meshInstance)return this._renderable.meshInstance.aabb;return null}}]);return e}(),cS=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._app=e;e.i18n.on("set:locale",t._onSetLocale,H(t));t._autoLoad=false;t._disableLocalization=false;t._defaultAsset=null;t._localizedAsset=null;return t}var t=e.prototype;t._bindDefaultAsset=function e(){var t=this._app.assets.get(this._defaultAsset);if(!t)this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);else this._onDefaultAssetAdd(t)};t._unbindDefaultAsset=function e(){if(!this._defaultAsset)return;this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var t=this._app.assets.get(this._defaultAsset);if(!t)return;t.off("add:localized",this._onLocaleAdd,this);t.off("remove:localized",this._onLocaleRemove,this);t.off("remove",this._onDefaultAssetRemove,this)};t._onDefaultAssetAdd=function e(t){if(this._defaultAsset!==t.id)return;t.on("add:localized",this._onLocaleAdd,this);t.on("remove:localized",this._onLocaleRemove,this);t.once("remove",this._onDefaultAssetRemove,this)};t._onDefaultAssetRemove=function e(t){if(this._defaultAsset!==t.id)return;t.off("add:localized",this._onLocaleAdd,this);t.off("remove:localized",this._onLocaleAdd,this);this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)};t._bindLocalizedAsset=function e(){if(!this._autoLoad)return;var t=this._app.assets.get(this._localizedAsset);if(!t)return;t.on("load",this._onLocalizedAssetLoad,this);t.on("change",this._onLocalizedAssetChange,this);t.on("remove",this._onLocalizedAssetRemove,this);if(t.resource)this._onLocalizedAssetLoad(t);else this._app.assets.load(t)};t._unbindLocalizedAsset=function e(){var t=this._app.assets.get(this._localizedAsset);if(!t)return;t.off("load",this._onLocalizedAssetLoad,this);t.off("change",this._onLocalizedAssetChange,this);t.off("remove",this._onLocalizedAssetRemove,this)};t._onLocalizedAssetAdd=function e(t){if(this._localizedAsset!==t.id)return;this._bindLocalizedAsset()};t._onLocalizedAssetLoad=function e(t){this.fire("load",t)};t._onLocalizedAssetChange=function e(t,i,n,r){this.fire("change",t,i,n,r)};t._onLocalizedAssetRemove=function e(t){if(this._localizedAsset===t.id)this.localizedAsset=this._defaultAsset;this.fire("remove",t)};t._onLocaleAdd=function e(t,i){if(this._app.i18n.locale!==t)return;this._onSetLocale(t)};t._onLocaleRemove=function e(t,i){if(this._app.i18n.locale!==t)return;this._onSetLocale(t)};t._onSetLocale=function e(t){if(!this._defaultAsset){this.localizedAsset=null;return}var i=this._app.assets.get(this._defaultAsset);if(!i||this._disableLocalization){this.localizedAsset=this._defaultAsset;return}var n=i.getLocalizedAssetId(t);if(!n){this.localizedAsset=this._defaultAsset;return}this.localizedAsset=n};t.destroy=function e(){this.defaultAsset=null;this._app.i18n.off("set:locale",this._onSetLocale,this);this.off()};U(e,[{key:"defaultAsset",get:function e(){return this._defaultAsset},set:function e(t){var i=t instanceof O_?t.id:t;if(this._defaultAsset===i)return;if(this._defaultAsset)this._unbindDefaultAsset();this._defaultAsset=i;if(this._defaultAsset)this._bindDefaultAsset();this._onSetLocale(this._app.i18n.locale)}},{key:"localizedAsset",get:function e(){return this._localizedAsset},set:function e(t){var i=t instanceof O_?t.id:t;if(this._localizedAsset===i)return;if(this._localizedAsset){this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this);this._unbindLocalizedAsset();this._localizedAsset=null}this._localizedAsset=i;if(this._localizedAsset){var n=this._app.assets.get(this._localizedAsset);if(!n)this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this);else this._bindLocalizedAsset()}}},{key:"autoLoad",get:function e(){return this._autoLoad},set:function e(t){if(this._autoLoad===t)return;this._autoLoad=t;if(this._autoLoad&&this._localizedAsset){this._unbindLocalizedAsset();this._bindLocalizedAsset()}}},{key:"disableLocalization",get:function e(){return this._disableLocalization},set:function e(t){if(this._disableLocalization===t)return;this._disableLocalization=t;this._onSetLocale(this._app.i18n.locale)}}]);return e}(u),uS=0,fS=1,dS=2,pS=3,mS=4,_S=5,vS=6,gS=7,yS=8,bS=" \t\n\r\v\f",xS=/[A-Z|a-z|0-9|_|-|/]/,SS=function(){function e(e){this._symbols=e;this._index=0;this._last=0;this._cur=this._symbols.length>0?this._symbols[0]:null;this._buf=[];this._mode="text";this._error=null}var t=e.prototype;t.read=function e(){var t=this._read();while(t===yS)t=this._read();if(t!==uS&&t!==fS)this._last=this._index;return t};t.buf=function e(){return this._buf};t.last=function e(){return this._last};t.error=function e(){return this._error};t.debugPrint=function e(){var t=["EOF","ERROR","TEXT","OPEN_BRACKET","CLOSE_BRACKET","EQUALS","STRING","IDENTIFIER","WHITESPACE"];var i=this.read();var n="";while(true){n+=(n.length>0?"\n":"")+t[i]+" '"+this.buf().join("")+"'";if(i===uS||i===fS)break;i=this.read()}return n};t._read=function e(){this._buf=[];if(this._eof())return uS;return this._mode==="text"?this._text():this._tag()};t._text=function e(){while(true)switch(this._cur){case null:return this._buf.length>0?dS:uS;case"[":this._mode="tag";return this._buf.length>0?dS:this._tag();case"\\":this._next();switch(this._cur){case"[":this._store();break;default:this._output("\\");break}break;default:this._store();break}};t._tag=function e(){while(true)switch(this._cur){case null:this._error="unexpected end of input reading tag";return fS;case"[":this._store();return pS;case"]":this._store();this._mode="text";return mS;case"=":this._store();return _S;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:if(!this._isIdentifierSymbol(this._cur)){this._error="unrecognized character";return fS}return this._identifier()}};t._whitespace=function e(){this._store();while(bS.indexOf(this._cur)!==-1)this._store();return yS};t._string=function e(){this._next();while(true)switch(this._cur){case null:this._error="unexpected end of input reading string";return fS;case'"':this._next();return vS;default:this._store();break}};t._identifier=function e(){this._store();while(this._cur!==null&&this._isIdentifierSymbol(this._cur))this._store();return gS};t._isIdentifierSymbol=function e(t){return t.length===1&&t.match(xS)!==null};t._eof=function e(){return this._cur===null};t._next=function e(){if(!this._eof()){this._index++;this._cur=this._index<this._symbols.length?this._symbols[this._index]:null}return this._cur};t._store=function e(){this._buf.push(this._cur);return this._next()};t._output=function e(t){this._buf.push(t)};return e}(),wS=function(){function e(e){this._scanner=new SS(e);this._error=null}var t=e.prototype;t.parse=function e(t,i){while(true){var n=this._scanner.read();switch(n){case uS:return true;case fS:return false;case dS:Array.prototype.push.apply(t,this._scanner.buf());break;case pS:if(!this._parseTag(t,i))return false;break;default:return false}}};t.error=function e(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"};t._parseTag=function e(t,i){var n=this._scanner.read();if(n!==gS){this._error="expected identifier";return false}var r=this._scanner.buf().join("");if(r[0]==="/"){for(var s=i.length-1;s>=0;--s)if(r==="/"+i[s].name&&i[s].end===null){i[s].end=t.length;n=this._scanner.read();if(n!==mS){this._error="expected close bracket";return false}return true}this._error="failed to find matching tag";return false}var a={name:r,value:null,attributes:{},start:t.length,end:null};n=this._scanner.read();if(n===_S){n=this._scanner.read();if(n!==vS){this._error="expected string";return false}a.value=this._scanner.buf().join("");n=this._scanner.read()}while(true){switch(n){case mS:i.push(a);return true;case gS:var o=this._scanner.buf().join("");n=this._scanner.read();if(n!==_S){this._error="expected equals";return false}n=this._scanner.read();if(n!==vS){this._error="expected string";return false}var l=this._scanner.buf().join("");a.attributes[o]=l;break;default:this._error="expected close bracket or identifier";return false}n=this._scanner.read()}};return e}();function TS(e,t){for(var i in t){if(!t.hasOwnProperty(i))continue;var n=t[i];if(n instanceof Object){if(!e.hasOwnProperty(i))e[i]={};TS(e[i],t[i])}else e[i]=n}}function MS(e){if(e.length===0)return null;var t={};for(var i=0;i<e.length;++i){var n=e[i];var r={};r[n.name]={value:n.value,attributes:n.attributes};TS(t,r)}return t}function CS(e,t){var i;if(e.length===0)return null;var n={};for(i=0;i<e.length;++i){var r=e[i];if(!n.hasOwnProperty(r.start))n[r.start]={open:[r],close:null};else if(n[r.start].open===null)n[r.start].open=[r];else n[r.start].open.push(r);if(!n.hasOwnProperty(r.end))n[r.end]={open:null,close:[r]};else if(n[r.end].close===null)n[r.end].close=[r];else n[r.end].close.push(r)}var s=[];function a(e){s=s.filter(function(t){return e.find(function(e){return e===t})===undefined})}function o(e){for(var t=0;t<e.length;++t)s.push(e[t])}var l=Object.keys(n).sort(function(e,t){return e-t});var h=[];for(i=0;i<l.length;++i){var c=n[l[i]];if(c.close!==null)a(c.close);if(c.open!==null)o(c.open);h.push({start:l[i],tags:MS(s)})}var u=[];var f=null;for(i=0;i<h.length;++i){var d=h[i];while(u.length<d.start)u.push(f?f.tags:null);f=d}while(u.length<t)u.push(null);return u}function AS(e){var t=new wS(e);var i=[];var n=[];if(!t.parse(i,n)){console.warn(t.error());return{symbols:e,tags:null}}var r=n.find(function(e){return e.end===null});if(r){console.warn("Markup error: found unclosed tag='"+r.name+"'");return{symbols:e,tags:null}}var s=CS(n,i.length);return{symbols:i,tags:s}}var PS=function(){function e(){}e.evaluate=function e(t){return AS(t)};return e}(),ES=function e(){this.count=0;this.quad=0;this.lines={};this.positions=[];this.normals=[];this.uvs=[];this.colors=[];this.indices=[];this.meshInstance=null},IS=/^[\r\n]$/,RS=/^[ \t]$/,LS=/^[ \t\-]$/,DS=["","","","","","","","","","","",""],kS={width:0,height:0,xadvance:0,xoffset:0,yoffset:0},OS=function(){function e(e){this._element=e;this._system=e.system;this._entity=e.entity;this._text="";this._symbols=[];this._colorPalette=[];this._symbolColors=null;this._i18nKey=null;this._fontAsset=new cS(this._system.app);this._fontAsset.disableLocalization=true;this._fontAsset.on("load",this._onFontLoad,this);this._fontAsset.on("change",this._onFontChange,this);this._fontAsset.on("remove",this._onFontRemove,this);this._font=null;this._color=new ge(1,1,1,1);this._colorUniform=new Float32Array(3);this._spacing=1;this._fontSize=32;this._fontMinY=0;this._fontMaxY=0;this._originalFontSize=32;this._maxFontSize=32;this._minFontSize=8;this._autoFitWidth=false;this._autoFitHeight=false;this._maxLines=-1;this._lineHeight=32;this._scaledLineHeight=32;this._wrapLines=false;this._drawOrder=0;this._alignment=new he(.5,.5);this._autoWidth=true;this._autoHeight=true;this.width=0;this.height=0;this._node=new Mf;this._model=new Xu;this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=null;this._aabbDirty=true;this._aabb=new Ce;this._noResize=false;this._currentMaterialType=null;this._maskedMaterialSrc=null;this._rtlReorder=false;this._unicodeConverter=false;this._rtl=false;this._outlineColor=new ge(0,0,0,1);this._outlineColorUniform=new Float32Array(4);this._outlineThicknessScale=.2;this._outlineThickness=0;this._shadowColor=new ge(0,0,0,1);this._shadowColorUniform=new Float32Array(4);this._shadowOffsetScale=.005;this._shadowOffset=new he(0,0);this._shadowOffsetUniform=new Float32Array(2);this._enableMarkup=false;this._onScreenChange(this._element.screen);e.on("resize",this._onParentResize,this);e.on("set:screen",this._onScreenChange,this);e.on("screen:set:screenspace",this._onScreenSpaceChange,this);e.on("set:draworder",this._onDrawOrderChange,this);e.on("set:pivot",this._onPivotChange,this);this._system.app.i18n.on("set:locale",this._onLocaleSet,this);this._system.app.i18n.on("data:add",this._onLocalizationData,this);this._system.app.i18n.on("data:remove",this._onLocalizationData,this);this._rangeStart=0;this._rangeEnd=0}var t=e.prototype;t.destroy=function e(){this._setMaterial(null);if(this._model){this._element.removeModelFromLayers(this._model);this._model.destroy();this._model=null}this._fontAsset.destroy();this.font=null;this._element.off("resize",this._onParentResize,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this);this._system.app.i18n.off("set:locale",this._onLocaleSet,this);this._system.app.i18n.off("data:add",this._onLocalizationData,this);this._system.app.i18n.off("data:remove",this._onLocalizationData,this)};t._onParentResize=function e(t,i){if(this._noResize)return;if(this._font)this._updateText()};t._onScreenChange=function e(t){if(t)this._updateMaterial(t.screen.screenSpace);else this._updateMaterial(false)};t._onScreenSpaceChange=function e(t){this._updateMaterial(t)};t._onDrawOrderChange=function e(t){this._drawOrder=t;if(this._model){var i;var n;for(i=0,n=this._model.meshInstances.length;i<n;i++)this._model.meshInstances[i].drawOrder=t}};t._onPivotChange=function e(t){if(this._font)this._updateText()};t._onLocaleSet=function e(t){if(!this._i18nKey)return;if(this.fontAsset){var i=this._system.app.assets.get(this.fontAsset);if(!i||!i.resource||i.resource!==this._font)this.font=null}this._resetLocalizedText()};t._onLocalizationData=function e(t,i){if(this._i18nKey&&i[this._i18nKey])this._resetLocalizedText()};t._resetLocalizedText=function e(){this._setText(this._system.app.i18n.getText(this._i18nKey))};t._setText=function e(t){if(this.unicodeConverter){var i=this._system.getUnicodeConverter();if(i)t=i(t);else console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}if(this._text!==t){if(this._font)this._updateText(t);this._text=t}};t._updateText=function e(t){var i;var n;var r;var s;if(t===undefined)t=this._text;this._symbols=Ae.getSymbols(t);if(this._symbols.length===0)this._symbols=[" "];if(this._enableMarkup){r=PS.evaluate(this._symbols);this._symbols=r.symbols;s=r.tags}if(this._rtlReorder){var a=this._system.app.systems.element.getRtlReorder();if(a){r=a(this._symbols);this._rtl=r.rtl;this._symbols=r.mapping.map(function(e){return this._symbols[e]},this);if(s)s=r.mapping.map(function(e){return s[e]})}else console.warn("Element created with rtlReorder option but no rtlReorder function registered")}else this._rtl=false;if(s){var o={};this._colorPalette=[Math.round(this._color.r*255),Math.round(this._color.g*255),Math.round(this._color.b*255)];this._symbolColors=[];o[this._color.toString(false).toLowerCase()]=0;for(i=0,n=this._symbols.length;i<n;++i){var l=s[i];var h=0;if(l&&l.color&&l.color.value){var c=l.color.value;if(c.length===7&&c[0]==="#"){var u=c.substring(1).toLowerCase();if(o.hasOwnProperty(u))h=o[u];else if(/^([0-9a-f]{2}){3}$/.test(u)){h=this._colorPalette.length/3;o[u]=h;this._colorPalette.push(parseInt(u.substring(0,2),16));this._colorPalette.push(parseInt(u.substring(2,4),16));this._colorPalette.push(parseInt(u.substring(4,6),16))}}}this._symbolColors.push(h)}}else{this._colorPalette=[];this._symbolColors=null}var f=this._calculateCharsPerTexture();var d=false;var p=this._element;var m=p._isScreenSpace();var _=p._isScreenCulled();var v=function e(t){return p.isVisibleForCamera(t)};for(i=0,n=this._meshInfo.length;i<n;i++){var g=f[i]||0;var y=this._meshInfo[i];if(y.count!==g){if(!d){p.removeModelFromLayers(this._model);d=true}y.count=g;y.positions.length=y.normals.length=g*3*4;y.indices.length=g*3*2;y.uvs.length=g*2*4;y.colors.length=g*4*4;if(y.meshInstance)this._removeMeshInstance(y.meshInstance);if(g===0){y.meshInstance=null;continue}for(var b=0;b<g;b++){y.indices[b*3*2+0]=b*4;y.indices[b*3*2+1]=b*4+1;y.indices[b*3*2+2]=b*4+3;y.indices[b*3*2+3]=b*4+2;y.indices[b*3*2+4]=b*4+3;y.indices[b*3*2+5]=b*4+1;y.normals[b*4*3+0]=0;y.normals[b*4*3+1]=0;y.normals[b*4*3+2]=-1;y.normals[b*4*3+3]=0;y.normals[b*4*3+4]=0;y.normals[b*4*3+5]=-1;y.normals[b*4*3+6]=0;y.normals[b*4*3+7]=0;y.normals[b*4*3+8]=-1;y.normals[b*4*3+9]=0;y.normals[b*4*3+10]=0;y.normals[b*4*3+11]=-1}var x=Tm(this._system.app.graphicsDevice,y.positions,{uvs:y.uvs,normals:y.normals,colors:y.colors,indices:y.indices});var S=new zu(this._node,x,this._material);S.name="Text Element: "+this._entity.name;S.castShadow=false;S.receiveShadow=false;S.cull=!m;S.screenSpace=m;S.drawOrder=this._drawOrder;if(_){S.cull=true;S.isVisibleFunc=v}this._setTextureParams(S,this._font.textures[i]);if(this._symbolColors){this._colorUniform[0]=1;this._colorUniform[1]=1;this._colorUniform[2]=1}else{this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b}S.setParameter("material_emissive",this._colorUniform);S.setParameter("material_opacity",this._color.a);S.setParameter("font_sdfIntensity",this._font.intensity);S.setParameter("font_pxrange",this._getPxRange(this._font));S.setParameter("font_textureWidth",this._font.data.info.maps[i].width);this._outlineColorUniform[0]=this._outlineColor.r;this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;S.setParameter("outline_color",this._outlineColorUniform);S.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness);this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;S.setParameter("shadow_color",this._shadowColorUniform);var w=this._font.data.info.maps[i].width/this._font.data.info.maps[i].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=w*this._shadowOffsetScale*this._shadowOffset.y;S.setParameter("shadow_offset",this._shadowOffsetUniform);y.meshInstance=S;this._model.meshInstances.push(S)}}if(this._element.maskedBy)this._element._setMaskedBy(this._element.maskedBy);if(d&&this._element.enabled&&this._entity.enabled)this._element.addModelToLayers(this._model);this._updateMeshes();this._rangeStart=0;this._rangeEnd=this._symbols.length;this._updateRenderRange()};t._removeMeshInstance=function e(t){t.material=null;var i=t.mesh;if(i)i.destroy();var n=this._model.meshInstances.indexOf(t);if(n!==-1)this._model.meshInstances.splice(n,1)};t._setMaterial=function e(t){var i;var n;this._material=t;if(this._model)for(i=0,n=this._model.meshInstances.length;i<n;i++){var r=this._model.meshInstances[i];r.material=t}};t._updateMaterial=function e(t){var i=this._element;var n=i._isScreenCulled();var r=function e(t){return i.isVisibleForCamera(t)};var s=this._font&&this._font.type===Xv;this._material=this._system.getTextElementMaterial(t,s);if(this._model)for(var a=0,o=this._model.meshInstances.length;a<o;a++){var l=this._model.meshInstances[a];l.cull=!t;l.material=this._material;l.screenSpace=t;if(n){l.cull=true;l.isVisibleFunc=r}else l.isVisibleFunc=null}};t._updateMeshes=function e(){var t=this._font.data;var o=this;var i=Math.min(this._minFontSize,this._maxFontSize);var n=this._maxFontSize;var r=this._shouldAutoFit();if(r)this._fontSize=this._maxFontSize;var s=32;var a=this._symbols.length;var l=0;var h=0;var c=0;var u=0;var f=1;var d=0;var p=0;var m=0;var _=0;var v=0;var g=0;var y=Math.abs(this._element.anchor.x-this._element.anchor.z)>=1e-4;var b=this._element.calculatedWidth;if(this.autoWidth&&!y||!this._wrapLines)b=Number.POSITIVE_INFINITY;var x=0;var S=0;var w=1;var T,M,C,A,P;function E(e,t,i){o._lineWidths.push(Math.abs(i));var n=m>t?t+1:m;var r=m>t?m+1:t;var s=e.slice(n,r);if(g){var a=s.length;while(a--&&g>0)if(IS.test(s[a])){s.splice(a,1);g--}}o._lineContents.push(s.join(""));l=0;h-=o._scaledLineHeight;f++;_=0;v=0;g=0;d=0;m=t}var I=true;while(I){I=false;if(r)this._scaledLineHeight=this._lineHeight*this._fontSize/(this._maxFontSize||1e-4);else this._scaledLineHeight=this._lineHeight;this.width=0;this.height=0;this._lineWidths=[];this._lineContents=[];l=0;h=0;c=0;u=0;f=1;d=0;p=0;m=0;_=0;v=0;g=0;w=this._fontSize/s;x=this._fontMinY*w;S=this._fontMaxY*w;for(C=0;C<this._meshInfo.length;C++){this._meshInfo[C].quad=0;this._meshInfo[C].lines={}}var R=255;var L=255;var D=255;for(C=0;C<a;C++){T=this._symbols[C];var k=0;var O=0;var F=0;var B=1;var N,z;M=t.chars[T];if(!M)if(DS.indexOf(T)!==-1)M=kS;else if(t.chars[" "])M=t.chars[" "];else for(var V in t.chars){M=t.chars[V];break}if(M){var U=0;if(v>0){var G=this._font.data.kerning;if(G){var H=G[Ae.getCodePoint(this._symbols[C-1])||0];if(H)U=H[Ae.getCodePoint(this._symbols[C])||0]||0}}N=M.scale||1;z=(M.width+M.height)/2;B=w*z/N;F=(M.xadvance+U)*w;k=(M.xoffset-U)*w;O=M.yoffset*w}else console.error("Couldn't substitute missing character: '"+T+"'");var W=IS.test(T);if(W){g++;if(this._maxLines<0||f<this._maxLines){E(this._symbols,C,u);p=C+1;m=C+1}continue}var j=RS.test(T);var X=this._meshInfo[M&&M.map||0];var q=l+this._spacing*F;if(q>b&&v>0&&!j)if(this._maxLines<0||f<this._maxLines)if(_===0){p=C;E(this._symbols,C,u)}else{var Y=Math.max(C-p,0);if(this._meshInfo.length<=1){X.lines[f-1]-=Y;X.quad-=Y}else{var K=p;var Q=C;for(A=K;A<Q;A++){var $=this._symbols[A];var Z=t.chars[$];var J=this._meshInfo[Z&&Z.map||0];J.lines[f-1]-=1;J.quad-=1}}C-=Y+1;E(this._symbols,p,d);continue}P=X.quad;X.lines[f-1]=P;var ee=l-k;var te=ee+B;var ie=h-O;var ne=ie+B;if(this._rtl){var re=B-k-this._spacing*F-k;ee-=re;te-=re}X.positions[P*4*3+0]=ee;X.positions[P*4*3+1]=ie;X.positions[P*4*3+2]=c;X.positions[P*4*3+3]=te;X.positions[P*4*3+4]=ie;X.positions[P*4*3+5]=c;X.positions[P*4*3+6]=te;X.positions[P*4*3+7]=ne;X.positions[P*4*3+8]=c;X.positions[P*4*3+9]=ee;X.positions[P*4*3+10]=ne;X.positions[P*4*3+11]=c;this.width=Math.max(this.width,q);var se;if(this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth){se=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4));se=Pe.clamp(se,i,n);if(se!==this._element.fontSize){this._fontSize=se;I=true;break}}this.height=Math.max(this.height,S-(h+x));if(this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight){se=Pe.clamp(this._fontSize-1,i,n);if(se!==this._element.fontSize){this._fontSize=se;I=true;break}}l+=this._spacing*F;if(!j&&!W)u=l;var ae=LS.test(T);if(ae){_++;d=u;p=C+1}v++;var oe=this._getUv(T);X.uvs[P*4*2+0]=oe[0];X.uvs[P*4*2+1]=oe[1];X.uvs[P*4*2+2]=oe[2];X.uvs[P*4*2+3]=oe[1];X.uvs[P*4*2+4]=oe[2];X.uvs[P*4*2+5]=oe[3];X.uvs[P*4*2+6]=oe[0];X.uvs[P*4*2+7]=oe[3];if(this._symbolColors){var le=this._symbolColors[C]*3;R=this._colorPalette[le];L=this._colorPalette[le+1];D=this._colorPalette[le+2]}X.colors[P*4*4+0]=R;X.colors[P*4*4+1]=L;X.colors[P*4*4+2]=D;X.colors[P*4*4+3]=255;X.colors[P*4*4+4]=R;X.colors[P*4*4+5]=L;X.colors[P*4*4+6]=D;X.colors[P*4*4+7]=255;X.colors[P*4*4+8]=R;X.colors[P*4*4+9]=L;X.colors[P*4*4+10]=D;X.colors[P*4*4+11]=255;X.colors[P*4*4+12]=R;X.colors[P*4*4+13]=L;X.colors[P*4*4+14]=D;X.colors[P*4*4+15]=255;X.quad++}if(I)continue;if(m<a)E(this._symbols,a,l)}this._noResize=true;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=false;var he=this._element.pivot.x;var ce=this._element.pivot.y;var ue=this._alignment.x;var fe=this._alignment.y;for(C=0;C<this._meshInfo.length;C++){if(this._meshInfo[C].count===0)continue;var de=0;for(var pe in this._meshInfo[C].lines){var me=this._meshInfo[C].lines[pe];var _e=this._lineWidths[parseInt(pe,10)];var ve=-he*this._element.calculatedWidth+ue*(this._element.calculatedWidth-_e)*(this._rtl?-1:1);var ge=(1-ce)*this._element.calculatedHeight-S-(1-fe)*(this._element.calculatedHeight-this.height);for(P=de;P<=me;P++){this._meshInfo[C].positions[P*4*3]+=ve;this._meshInfo[C].positions[P*4*3+3]+=ve;this._meshInfo[C].positions[P*4*3+6]+=ve;this._meshInfo[C].positions[P*4*3+9]+=ve;this._meshInfo[C].positions[P*4*3+1]+=ge;this._meshInfo[C].positions[P*4*3+4]+=ge;this._meshInfo[C].positions[P*4*3+7]+=ge;this._meshInfo[C].positions[P*4*3+10]+=ge}if(this._rtl)for(P=de;P<=me;P++){var ye=P*4*3;for(var be=0;be<4;++be)this._meshInfo[C].positions[ye+be*3]=this._element.calculatedWidth-this._meshInfo[C].positions[ye+be*3]+ve*2;var xe=this._meshInfo[C].positions[ye+3];var Se=this._meshInfo[C].positions[ye+6];this._meshInfo[C].positions[ye+3]=this._meshInfo[C].positions[ye+0];this._meshInfo[C].positions[ye+6]=this._meshInfo[C].positions[ye+9];this._meshInfo[C].positions[ye+0]=xe;this._meshInfo[C].positions[ye+9]=Se}de=me+1}var we=this._meshInfo[C].count*4;var Te=this._meshInfo[C].quad*4;var Me=new Tr(this._meshInfo[C].meshInstance.mesh.vertexBuffer);for(var Ce=0;Ce<we;Ce++){if(Ce>=Te){Me.element[Ci].set(0,0,0);Me.element[Di].set(0,0);Me.element[Ri].set(0,0,0,0)}else{Me.element[Ci].set(this._meshInfo[C].positions[Ce*3+0],this._meshInfo[C].positions[Ce*3+1],this._meshInfo[C].positions[Ce*3+2]);Me.element[Di].set(this._meshInfo[C].uvs[Ce*2+0],this._meshInfo[C].uvs[Ce*2+1]);Me.element[Ri].set(this._meshInfo[C].colors[Ce*4+0],this._meshInfo[C].colors[Ce*4+1],this._meshInfo[C].colors[Ce*4+2],this._meshInfo[C].colors[Ce*4+3])}Me.next()}Me.end();this._meshInfo[C].meshInstance.mesh.aabb.compute(this._meshInfo[C].positions);this._meshInfo[C].meshInstance._aabbVer=-1}this._aabbDirty=true};t._onFontRender=function e(){this.font=this._font};t._onFontLoad=function e(t){if(this.font!==t.resource)this.font=t.resource};t._onFontChange=function e(t,i,n,r){if(i==="data"){this._font.data=n;var s=this._font.data.info.maps.length;for(var a=0;a<s;a++){if(!this._meshInfo[a])continue;var o=this._meshInfo[a].meshInstance;if(o){o.setParameter("font_sdfIntensity",this._font.intensity);o.setParameter("font_pxrange",this._getPxRange(this._font));o.setParameter("font_textureWidth",this._font.data.info.maps[a].width)}}}};t._onFontRemove=function e(t){};t._setTextureParams=function e(t,i){if(this._font)if(this._font.type===Xv){t.deleteParameter("texture_emissiveMap");t.deleteParameter("texture_opacityMap");t.setParameter("texture_msdfMap",i)}else if(this._font.type===qv){t.deleteParameter("texture_msdfMap");t.setParameter("texture_emissiveMap",i);t.setParameter("texture_opacityMap",i)}};t._getPxRange=function e(t){var i=Object.keys(this._font.data.chars);for(var n=0;n<i.length;n++){var r=this._font.data.chars[i[n]];if(r.range)return(r.scale||1)*r.range}return 2};t._getUv=function e(t){var i=this._font.data;if(!i.chars[t]){var n=" ";if(i.chars[n])return this._getUv(n);return[0,0,0,0]}var r=i.chars[t].map;var s=i.info.maps[r].width;var a=i.info.maps[r].height;var o=i.chars[t].x;var l=i.chars[t].y;var h=o;var c=l;var u=o+i.chars[t].width;var f=l-i.chars[t].height;var d=1-i.chars[t].height/a;return[h/s,d-c/a,u/s,d-f/a]};t.onEnable=function e(){this._fontAsset.autoLoad=true;if(this._model)this._element.addModelToLayers(this._model)};t.onDisable=function e(){this._fontAsset.autoLoad=false;if(this._model)this._element.removeModelFromLayers(this._model)};t._setStencil=function e(t){if(this._model){var i=this._model.meshInstances;for(var n=0;n<i.length;n++){i[n].stencilFront=t;i[n].stencilBack=t}}};t._shouldAutoFitWidth=function e(){return this._autoFitWidth&&!this._autoWidth};t._shouldAutoFitHeight=function e(){return this._autoFitHeight&&!this._autoHeight};t._shouldAutoFit=function e(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight};t._calculateCharsPerTexture=function e(t){var i={};if(t===undefined)t=this._symbols.length;var n,r,s,a,o;for(n=0,r=t;n<r;n++){s=this._symbols[n];a=this._font.data.chars[s];if(!a){a=this._font.data.chars[" "];if(!a)a=this._font.data.chars[Object.keys(this._font.data.chars)[0]]}o=a.map;if(!i[o])i[o]=1;else i[o]++}return i};t._updateRenderRange=function e(){var t=this._rangeStart===0?0:this._calculateCharsPerTexture(this._rangeStart);var i=this._rangeEnd===0?0:this._calculateCharsPerTexture(this._rangeEnd);var n,r;for(n=0,r=this._meshInfo.length;n<r;n++){var s=t[n]||0;var a=i[n]||0;var o=this._meshInfo[n].meshInstance;if(o){var l=o.mesh;if(l){l.primitive[0].base=s*3*2;l.primitive[0].count=(a-s)*3*2}}}};U(e,[{key:"text",get:function e(){return this._text},set:function e(t){this._i18nKey=null;var i=t!=null&&t.toString()||"";this._setText(i)}},{key:"key",get:function e(){return this._i18nKey},set:function e(t){var i=t!==null?t.toString():null;if(this._i18nKey===i)return;this._i18nKey=i;if(i){this._fontAsset.disableLocalization=false;this._resetLocalizedText()}else this._fontAsset.disableLocalization=true}},{key:"color",get:function e(){return this._color},set:function e(t){var i=t.r;var n=t.g;var r=t.b;if(this._color.r===i&&this._color.g===n&&this._color.b===r)return;this._color.r=i;this._color.g=n;this._color.b=r;if(this._symbolColors){if(this._font)this._updateText()}else{this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b;for(var s=0,a=this._model.meshInstances.length;s<a;s++){var o=this._model.meshInstances[s];o.setParameter("material_emissive",this._colorUniform)}}}},{key:"opacity",get:function e(){return this._color.a},set:function e(t){if(this._color.a===t)return;this._color.a=t;if(this._model)for(var i=0,n=this._model.meshInstances.length;i<n;i++){var r=this._model.meshInstances[i];r.setParameter("material_opacity",t)}}},{key:"lineHeight",get:function e(){return this._lineHeight},set:function e(t){var i=this._lineHeight;this._lineHeight=t;this._scaledLineHeight=t;if(i!==t&&this._font)this._updateText()}},{key:"wrapLines",get:function e(){return this._wrapLines},set:function e(t){var i=this._wrapLines;this._wrapLines=t;if(i!==t&&this._font)this._updateText()}},{key:"lines",get:function e(){return this._lineContents}},{key:"spacing",get:function e(){return this._spacing},set:function e(t){var i=this._spacing;this._spacing=t;if(i!==t&&this._font)this._updateText()}},{key:"fontSize",get:function e(){return this._fontSize},set:function e(t){var i=this._fontSize;this._fontSize=t;this._originalFontSize=t;if(i!==t&&this._font)this._updateText()}},{key:"fontAsset",get:function e(){return this._fontAsset.localizedAsset},set:function e(t){this._fontAsset.defaultAsset=t}},{key:"font",get:function e(){return this._font},set:function e(t){var i;var n;var r;if(this._font){r=this._font.type;if(this._font.off)this._font.off("render",this._onFontRender,this)}this._font=t;this._fontMinY=0;this._fontMaxY=0;if(!t)return;var s=this._font.data;for(var a in s.chars){var o=s.chars[a];if(o.bounds){this._fontMinY=Math.min(this._fontMinY,o.bounds[1]);this._fontMaxY=Math.max(this._fontMaxY,o.bounds[3])}}if(this._font.on)this._font.on("render",this._onFontRender,this);if(this._fontAsset.localizedAsset){var l=this._system.app.assets.get(this._fontAsset.localizedAsset);if(l.resource!==this._font)this._fontAsset.defaultAsset=null}if(t.type!==r){var h=this._element._isScreenSpace();this._updateMaterial(h)}for(i=0,n=this._font.textures.length;i<n;i++)if(!this._meshInfo[i])this._meshInfo[i]=new ES;else{var c=this._meshInfo[i].meshInstance;if(c){c.setParameter("font_sdfIntensity",this._font.intensity);c.setParameter("font_pxrange",this._getPxRange(this._font));c.setParameter("font_textureWidth",this._font.data.info.maps[i].width);this._setTextureParams(c,this._font.textures[i])}}var u=false;for(i=this._font.textures.length;i<this._meshInfo.length;i++)if(this._meshInfo[i].meshInstance){if(!u){this._element.removeModelFromLayers(this._model);u=true}this._removeMeshInstance(this._meshInfo[i].meshInstance)}if(this._meshInfo.length>this._font.textures.length)this._meshInfo.length=this._font.textures.length;this._updateText()}},{key:"alignment",get:function e(){return this._alignment},set:function e(t){if(t instanceof he)this._alignment.set(t.x,t.y);else this._alignment.set(t[0],t[1]);if(this._font)this._updateText()}},{key:"autoWidth",get:function e(){return this._autoWidth},set:function e(t){var i=this._autoWidth;this._autoWidth=t;if(t&&Math.abs(this._element.anchor.x-this._element.anchor.z)<1e-4)this._element.width=this.width;if(i!==t){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;if(n!==this._fontSize){this._fontSize=n;if(this._font)this._updateText()}}}},{key:"autoHeight",get:function e(){return this._autoHeight},set:function e(t){var i=this._autoHeight;this._autoHeight=t;if(t&&Math.abs(this._element.anchor.y-this._element.anchor.w)<1e-4)this._element.height=this.height;if(i!==t){var n=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;if(n!==this._fontSize){this._fontSize=n;if(this._font)this._updateText()}}}},{key:"rtlReorder",get:function e(){return this._rtlReorder},set:function e(t){if(this._rtlReorder!==t){this._rtlReorder=t;if(this._font)this._updateText()}}},{key:"unicodeConverter",get:function e(){return this._unicodeConverter},set:function e(t){if(this._unicodeConverter!==t){this._unicodeConverter=t;this._setText(this._text)}}},{key:"aabb",get:function e(){if(this._aabbDirty){var t=false;for(var i=0;i<this._meshInfo.length;i++){if(!this._meshInfo[i].meshInstance)continue;if(!t){this._aabb.copy(this._meshInfo[i].meshInstance.aabb);t=true}else this._aabb.add(this._meshInfo[i].meshInstance.aabb)}this._aabbDirty=false}return this._aabb}},{key:"outlineColor",get:function e(){return this._outlineColor},set:function e(t){var i=t instanceof ge?t.r:t[0];var n=t instanceof ge?t.g:t[1];var r=t instanceof ge?t.b:t[2];var s=t instanceof ge?t.a:t[3];if(this._outlineColor.r===i&&this._outlineColor.g===n&&this._outlineColor.b===r&&this._outlineColor.a===s)return;this._outlineColor.r=i;this._outlineColor.g=n;this._outlineColor.b=r;this._outlineColor.a=s;if(this._model){this._outlineColorUniform[0]=this._outlineColor.r;this._outlineColorUniform[1]=this._outlineColor.g;this._outlineColorUniform[2]=this._outlineColor.b;this._outlineColorUniform[3]=this._outlineColor.a;for(var a=0,o=this._model.meshInstances.length;a<o;a++){var l=this._model.meshInstances[a];l.setParameter("outline_color",this._outlineColorUniform)}}}},{key:"outlineThickness",get:function e(){return this._outlineThickness},set:function e(t){var i=this._outlineThickness;this._outlineThickness=t;if(i!==t&&this._font)if(this._model)for(var n=0,r=this._model.meshInstances.length;n<r;n++){var s=this._model.meshInstances[n];s.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}},{key:"shadowColor",get:function e(){return this._shadowColor},set:function e(t){var i=t instanceof ge?t.r:t[0];var n=t instanceof ge?t.g:t[1];var r=t instanceof ge?t.b:t[2];var s=t instanceof ge?t.a:t[3];if(this._shadowColor.r===i&&this._shadowColor.g===n&&this._shadowColor.b===r&&this._shadowColor.a===s)return;this._shadowColor.r=i;this._shadowColor.g=n;this._shadowColor.b=r;this._shadowColor.a=s;if(this._model){this._shadowColorUniform[0]=this._shadowColor.r;this._shadowColorUniform[1]=this._shadowColor.g;this._shadowColorUniform[2]=this._shadowColor.b;this._shadowColorUniform[3]=this._shadowColor.a;for(var a=0,o=this._model.meshInstances.length;a<o;a++){var l=this._model.meshInstances[a];l.setParameter("shadow_color",this._shadowColorUniform)}}}},{key:"shadowOffset",get:function e(){return this._shadowOffset},set:function e(t){var i=t instanceof he?t.x:t[0],n=t instanceof he?t.y:t[1];if(this._shadowOffset.x===i&&this._shadowOffset.y===n)return;this._shadowOffset.set(i,n);if(this._font&&this._model)for(var r=0,s=this._model.meshInstances.length;r<s;r++){var a=this._font.data.info.maps[r].width/this._font.data.info.maps[r].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x;this._shadowOffsetUniform[1]=a*this._shadowOffsetScale*this._shadowOffset.y;var o=this._model.meshInstances[r];o.setParameter("shadow_offset",this._shadowOffsetUniform)}}},{key:"minFontSize",get:function e(){return this._minFontSize},set:function e(t){if(this._minFontSize===t)return;this._minFontSize=t;if(this.font&&this._shouldAutoFit())this._updateText()}},{key:"maxFontSize",get:function e(){return this._maxFontSize},set:function e(t){if(this._maxFontSize===t)return;this._maxFontSize=t;if(this.font&&this._shouldAutoFit())this._updateText()}},{key:"autoFitWidth",get:function e(){return this._autoFitWidth},set:function e(t){if(this._autoFitWidth===t)return;this._autoFitWidth=t;this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;if(this.font)this._updateText()}},{key:"autoFitHeight",get:function e(){return this._autoFitHeight},set:function e(t){if(this._autoFitHeight===t)return;this._autoFitHeight=t;this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize;if(this.font)this._updateText()}},{key:"maxLines",get:function e(){return this._maxLines},set:function e(t){if(this._maxLines===t)return;if(t===null&&this._maxLines===-1)return;this._maxLines=t===null?-1:t;if(this.font&&this._wrapLines)this._updateText()}},{key:"enableMarkup",get:function e(){return this._enableMarkup},set:function e(t){t=!!t;if(this._enableMarkup===t)return;this._enableMarkup=t;if(this.font)this._updateText()}},{key:"symbols",get:function e(){return this._symbols}},{key:"symbolColors",get:function e(){if(this._symbolColors===null)return null;return this._symbolColors.map(function(e){return this._colorPalette.slice(e*3,e*3+3)},this)}},{key:"rtl",get:function e(){return this._rtl}},{key:"rangeStart",get:function e(){return this._rangeStart},set:function e(t){t=Math.max(0,Math.min(t,this._symbols.length));if(t!==this._rangeStart){this._rangeStart=t;this._updateRenderRange()}}},{key:"rangeEnd",get:function e(){return this._rangeEnd},set:function e(t){t=Math.max(this._rangeStart,Math.min(t,this._symbols.length));if(t!==this._rangeEnd){this._rangeEnd=t;this._updateRenderRange()}}}]);return e}(),FS=new ce,BS=new ve,NS=new ce,zS=new ce,VS=new ve,US=new ve,GS=new ve,HS=new ve,WS=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._beingInitialized=false;i._anchor=new ue;i._localAnchor=new ue;i._pivot=new he;i._width=i._calculatedWidth=32;i._height=i._calculatedHeight=32;i._margin=new ue(0,0,-32,-32);i._modelTransform=new ve;i._screenToWorld=new ve;i._anchorTransform=new ve;i._anchorDirty=true;i._parentWorldTransform=new ve;i._screenTransform=new ve;i._screenCorners=[new ce,new ce,new ce,new ce];i._canvasCorners=[new he,new he,new he,new he];i._worldCorners=[new ce,new ce,new ce,new ce];i._cornersDirty=true;i._canvasCornersDirty=true;i._worldCornersDirty=true;i.entity.on("insert",i._onInsert,H(i));i._patch();i.screen=null;i._type=rS;i._image=null;i._text=null;i._group=null;i._drawOrder=0;i._useInput=false;i._layers=[Bl];i._addedModels=[];i._batchGroupId=-1;i._offsetReadAt=0;i._maskOffset=.5;i._maskedBy=null;return i}var t=e.prototype;t._patch=function e(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition};t._unpatch=function e(){this.entity._sync=Nv.prototype._sync;this.entity.setPosition=Nv.prototype.setPosition;this.entity.setLocalPosition=Nv.prototype.setLocalPosition};t._setPosition=function e(t,i,n){if(!this.element.screen)return Nv.prototype.setPosition.call(this,t,i,n);if(t instanceof ce)FS.copy(t);else FS.set(t,i,n);this.getWorldTransform();BS.copy(this.element._screenToWorld).invert();BS.transformPoint(FS,this.localPosition);if(!this._dirtyLocal)this._dirtifyLocal()};t._setLocalPosition=function e(t,i,n){if(t instanceof ce)this.localPosition.copy(t);else this.localPosition.set(t,i,n);var r=this.element;var s=this.localPosition;var a=r._pivot;r._margin.x=s.x-r._calculatedWidth*a.x;r._margin.z=r._localAnchor.z-r._localAnchor.x-r._calculatedWidth-r._margin.x;r._margin.y=s.y-r._calculatedHeight*a.y;r._margin.w=r._localAnchor.w-r._localAnchor.y-r._calculatedHeight-r._margin.y;if(!this._dirtyLocal)this._dirtifyLocal()};t._sync=function e(){var t=this.element;var i=t.screen;if(i){if(t._anchorDirty){var n=0;var r=0;var s=0;var a=1;if(this._parent&&this._parent.element){n=this._parent.element.calculatedWidth;r=this._parent.element.calculatedHeight;s=this._parent.element.pivot.x;a=this._parent.element.pivot.y}else{var o=i.screen.resolution;n=o.x/i.screen.scale;r=o.y/i.screen.scale}t._anchorTransform.setTranslate(n*(t.anchor.x-s),-(r*(a-t.anchor.y)),0);t._anchorDirty=false;t._calculateLocalAnchors()}if(t._sizeDirty)t._calculateSize(false,false)}if(this._dirtyLocal){this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale);var l=this.localPosition;var h=t._pivot;t._margin.x=l.x-t._calculatedWidth*h.x;t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x;t._margin.y=l.y-t._calculatedHeight*h.y;t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y;this._dirtyLocal=false}if(!i){if(this._dirtyWorld){t._cornersDirty=true;t._canvasCornersDirty=true;t._worldCornersDirty=true}return Nv.prototype._sync.call(this)}if(this._dirtyWorld){if(this._parent===null)this.worldTransform.copy(this.localTransform);else{if(this._parent.element)t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform);else t._screenToWorld.copy(t._anchorTransform);t._modelTransform.mul2(t._screenToWorld,this.localTransform);if(i){t._screenToWorld.mul2(i.screen._screenMatrix,t._screenToWorld);if(!i.screen.screenSpace)t._screenToWorld.mul2(i.worldTransform,t._screenToWorld);this.worldTransform.mul2(t._screenToWorld,this.localTransform);var c=t._parentWorldTransform;c.setIdentity();var u=this._parent;if(u&&u.element&&u!==i){VS.setTRS(ce.ZERO,u.getLocalRotation(),u.getLocalScale());c.mul2(u.element._parentWorldTransform,VS)}var f=NS;f.set(0,0,this.localPosition.z);var d=zS;d.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0);VS.setTranslate(-d.x,-d.y,-d.z);US.setTRS(f,this.getLocalRotation(),this.getLocalScale());GS.setTranslate(d.x,d.y,d.z);t._screenTransform.mul2(t._parentWorldTransform,GS).mul(US).mul(VS);t._cornersDirty=true;t._canvasCornersDirty=true;t._worldCornersDirty=true}else this.worldTransform.copy(t._modelTransform)}this._dirtyWorld=false}};t._onInsert=function e(t){var i=this._parseUpToScreen();this.entity._dirtifyWorld();this._updateScreen(i.screen);this._dirtifyMask()};t._dirtifyMask=function e(){var t=this.entity;while(t){var i=t.parent;if((i===null||i.screen)&&t.element){if(!this.system._prerender||!this.system._prerender.length){this.system._prerender=[];this.system.app.once("prerender",this._onPrerender,this)}var n=this.system._prerender.indexOf(this.entity);if(n>=0)this.system._prerender.splice(n,1);var r=this.system._prerender.indexOf(t);if(r<0)this.system._prerender.push(t)}t=i}};t._onPrerender=function e(){for(var t=0;t<this.system._prerender.length;t++){var i=this.system._prerender[t];if(i.element){var n=1;i.element.syncMask(n)}}this.system._prerender.length=0};t._bindScreen=function e(t){t._bindElement(this)};t._unbindScreen=function e(t){t._unbindElement(this)};t._updateScreen=function e(t){if(this.screen&&this.screen!==t)this._unbindScreen(this.screen.screen);var i=this.screen;this.screen=t;if(this.screen)this._bindScreen(this.screen.screen);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen,i);this._anchorDirty=true;var n=this.entity.children;for(var r=0,s=n.length;r<s;r++)if(n[r].element)n[r].element._updateScreen(t);if(this.screen)this.screen.screen.syncDrawOrder()};t.syncMask=function e(t){var i=this._parseUpToScreen();this._updateMask(i.mask,t)};t._setMaskedBy=function e(t){var i=this._image||this._text;if(t){var n=t.element._image._maskRef;var r=new oS({ref:n,func:Dt});if(i&&i._setStencil)i._setStencil(r);this._maskedBy=t}else{if(i&&i._setStencil)i._setStencil(null);this._maskedBy=null}};t._updateMask=function e(t,i){var n,r,s,a;if(t){this._setMaskedBy(t);if(this.mask){var o=t.element._image._maskRef;s=new oS({ref:o,func:Dt,zpass:hn});this._image._setStencil(s);this._image._maskRef=i;i++;t=this.entity}a=this.entity.children;for(n=0,r=a.length;n<r;n++)if(a[n].element)a[n].element._updateMask(t,i);if(this.mask)i--}else{this._setMaskedBy(null);if(this.mask){s=new oS({ref:i,func:Nt,zpass:ln});this._image._setStencil(s);this._image._maskRef=i;i++;t=this.entity}a=this.entity.children;for(n=0,r=a.length;n<r;n++)if(a[n].element)a[n].element._updateMask(t,i);if(this.mask)i--}};t._parseUpToScreen=function e(){var t={screen:null,mask:null};var i=this.entity._parent;while(i&&!i.screen){if(i.element&&i.element.mask)if(!t.mask)t.mask=i;i=i.parent}if(i&&i.screen)t.screen=i;return t};t._onScreenResize=function e(t){this._anchorDirty=true;this._cornersDirty=true;this._worldCornersDirty=true;this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("screen:set:resolution",t)};t._onScreenSpaceChange=function e(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)};t._onScreenRemove=function e(){if(this.screen)if(this.screen._destroying)this.screen=null;else this._updateScreen(null)};t._calculateLocalAnchors=function e(){var t=1e3;var i=1e3;var n=this.entity._parent;if(n&&n.element){t=n.element.calculatedWidth;i=n.element.calculatedHeight}else if(this.screen){var r=this.screen.screen.resolution;var s=this.screen.screen.scale;t=r.x/s;i=r.y/s}this._localAnchor.set(this._anchor.x*t,this._anchor.y*i,this._anchor.z*t,this._anchor.w*i)};t.getOffsetPosition=function e(t,i){var n=this.entity.getLocalPosition().clone();n.x+=t;n.y+=i;this._screenToWorld.transformPoint(n,n);return n};t.onLayersChanged=function e(t,i){this.addModelToLayers(this._image?this._image._model:this._text._model);t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;if(this._image)t.addMeshInstances(this._image._model.meshInstances);else if(this._text)t.addMeshInstances(this._text._model.meshInstances)};t.onLayerRemoved=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;if(this._image)t.removeMeshInstances(this._image._model.meshInstances);else if(this._text)t.removeMeshInstances(this._text._model.meshInstances)};t.onEnable=function e(){if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();if(this._group)this._group.onEnable();if(this.useInput&&this.system.app.elementInput)this.system.app.elementInput.addElement(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.on("add",this.onLayerAdded,this);this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)}if(this._batchGroupId>=0)this.system.app.batcher.insert(Yu.ELEMENT,this.batchGroupId,this.entity);this.fire("enableelement")};t.onDisable=function e(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.off("add",this.onLayerAdded,this);this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)}if(this._image)this._image.onDisable();if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();if(this.system.app.elementInput&&this.useInput)this.system.app.elementInput.removeElement(this);if(this._batchGroupId>=0)this.system.app.batcher.remove(Yu.ELEMENT,this.batchGroupId,this.entity);this.fire("disableelement")};t.onRemove=function e(){this.entity.off("insert",this._onInsert,this);this._unpatch();if(this._image)this._image.destroy();if(this._text)this._text.destroy();if(this.system.app.elementInput&&this.useInput)this.system.app.elementInput.removeElement(this);if(this.screen&&this.screen.screen){this._unbindScreen(this.screen.screen);this.screen.screen.syncDrawOrder()}this.off()};t._calculateSize=function e(t,i){if(!this.entity._parent&&!this.screen)return;this._calculateLocalAnchors();var n=this._absRight-this._absLeft;var r=this._absTop-this._absBottom;if(t)this._setWidth(n);else this._setCalculatedWidth(n,false);if(i)this._setHeight(r);else this._setCalculatedHeight(r,false);var s=this.entity.getLocalPosition();s.x=this._margin.x+this._calculatedWidth*this._pivot.x;s.y=this._margin.y+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(s);this._sizeDirty=false};t._setWidth=function e(t){this._width=t;this._setCalculatedWidth(t,false);this.fire("set:width",this._width)};t._setHeight=function e(t){this._height=t;this._setCalculatedHeight(t,false);this.fire("set:height",this._height)};t._setCalculatedWidth=function e(t,i){if(Math.abs(t-this._calculatedWidth)<=1e-4)return;this._calculatedWidth=t;this.entity._dirtifyLocal();if(i){var n=this.entity.getLocalPosition();var r=this._pivot;this._margin.x=n.x-this._calculatedWidth*r.x;this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x}this._flagChildrenAsDirty();this.fire("set:calculatedWidth",this._calculatedWidth);this.fire("resize",this._calculatedWidth,this._calculatedHeight)};t._setCalculatedHeight=function e(t,i){if(Math.abs(t-this._calculatedHeight)<=1e-4)return;this._calculatedHeight=t;this.entity._dirtifyLocal();if(i){var n=this.entity.getLocalPosition();var r=this._pivot;this._margin.y=n.y-this._calculatedHeight*r.y;this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y}this._flagChildrenAsDirty();this.fire("set:calculatedHeight",this._calculatedHeight);this.fire("resize",this._calculatedWidth,this._calculatedHeight)};t._flagChildrenAsDirty=function e(){var t,i;var n=this.entity._children;for(t=0,i=n.length;t<i;t++)if(n[t].element){n[t].element._anchorDirty=true;n[t].element._sizeDirty=true}};t.addModelToLayers=function e(t){var i;this._addedModels.push(t);for(var n=0;n<this.layers.length;n++){i=this.system.app.scene.layers.getLayerById(this.layers[n]);if(!i)continue;i.addMeshInstances(t.meshInstances)}};t.removeModelFromLayers=function e(t){var i;var n=this._addedModels.indexOf(t);if(n>=0)this._addedModels.splice(n,1);for(var r=0;r<this.layers.length;r++){i=this.system.app.scene.layers.getLayerById(this.layers[r]);if(!i)continue;i.removeMeshInstances(t.meshInstances)}};t.getMaskOffset=function e(){var t=this.system.app.frame;if(this._offsetReadAt!==t){this._maskOffset=.5;this._offsetReadAt=t}var i=this._maskOffset;this._maskOffset-=.001;return i};t.isVisibleForCamera=function e(t){var i,n,r,s;if(this.maskedBy){var a=this.maskedBy.element.screenCorners;i=Math.min(Math.min(a[0].x,a[1].x),Math.min(a[2].x,a[3].x));n=Math.max(Math.max(a[0].x,a[1].x),Math.max(a[2].x,a[3].x));s=Math.min(Math.min(a[0].y,a[1].y),Math.min(a[2].y,a[3].y));r=Math.max(Math.max(a[0].y,a[1].y),Math.max(a[2].y,a[3].y))}else{var o=this.system.app.graphicsDevice.width;var l=this.system.app.graphicsDevice.height;var h=t._rect.z*o;var c=t._rect.w*l;i=t._rect.x*o;n=i+h;r=(1-t._rect.y)*l;s=r-c}var u=this.screenCorners;var f=Math.min(Math.min(u[0].x,u[1].x),Math.min(u[2].x,u[3].x));var d=Math.max(Math.max(u[0].x,u[1].x),Math.max(u[2].x,u[3].x));var p=Math.min(Math.min(u[0].y,u[1].y),Math.min(u[2].y,u[3].y));var m=Math.max(Math.max(u[0].y,u[1].y),Math.max(u[2].y,u[3].y));if(d<i||f>n||p>r||m<s)return false;return true};t._isScreenSpace=function e(){if(this.screen&&this.screen.screen)return this.screen.screen.screenSpace;return false};t._isScreenCulled=function e(){if(this.screen&&this.screen.screen)return this.screen.screen.cull;return false};return e}(R0);Object.defineProperty(WS.prototype,"type",{get:function e(){return this._type},set:function e(t){if(t!==this._type){this._type=t;if(this._image){this._image.destroy();this._image=null}if(this._text){this._text.destroy();this._text=null}if(t===sS)this._image=new hS(this);else if(t===aS)this._text=new OS(this)}}}),Object.defineProperty(WS.prototype,"layers",{get:function e(){return this._layers},set:function e(t){var i,n,r;if(this._addedModels.length)for(i=0;i<this._layers.length;i++){r=this.system.app.scene.layers.getLayerById(this._layers[i]);if(r)for(n=0;n<this._addedModels.length;n++)r.removeMeshInstances(this._addedModels[n].meshInstances)}this._layers=t;if(!this.enabled||!this.entity.enabled||!this._addedModels.length)return;for(i=0;i<this._layers.length;i++){r=this.system.app.scene.layers.getLayerById(this._layers[i]);if(r)for(n=0;n<this._addedModels.length;n++)r.addMeshInstances(this._addedModels[n].meshInstances)}}}),Object.defineProperty(WS.prototype,"drawOrder",{get:function e(){return this._drawOrder},set:function e(t){var i=0;if(this.screen)i=this.screen.screen.priority;if(t>16777215)t=16777215;this._drawOrder=(i<<24)+t;this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(WS.prototype,"_absLeft",{get:function e(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(WS.prototype,"_absRight",{get:function e(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(WS.prototype,"_absTop",{get:function e(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(WS.prototype,"_absBottom",{get:function e(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(WS.prototype,"margin",{get:function e(){return this._margin},set:function e(t){this._margin.copy(t);this._calculateSize(true,true);this.fire("set:margin",this._margin)}}),Object.defineProperty(WS.prototype,"left",{get:function e(){return this._margin.x},set:function e(t){this._margin.x=t;var i=this.entity.getLocalPosition();var n=this._absRight;var r=this._localAnchor.x+t;this._setWidth(n-r);i.x=t+this._calculatedWidth*this._pivot.x;this.entity.setLocalPosition(i)}}),Object.defineProperty(WS.prototype,"right",{get:function e(){return this._margin.z},set:function e(t){this._margin.z=t;var i=this.entity.getLocalPosition();var n=this._absLeft;var r=this._localAnchor.z-t;this._setWidth(r-n);i.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x);this.entity.setLocalPosition(i)}}),Object.defineProperty(WS.prototype,"top",{get:function e(){return this._margin.w},set:function e(t){this._margin.w=t;var i=this.entity.getLocalPosition();var n=this._absBottom;var r=this._localAnchor.w-t;this._setHeight(r-n);i.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y);this.entity.setLocalPosition(i)}}),Object.defineProperty(WS.prototype,"bottom",{get:function e(){return this._margin.y},set:function e(t){this._margin.y=t;var i=this.entity.getLocalPosition();var n=this._absTop;var r=this._localAnchor.y+t;this._setHeight(n-r);i.y=t+this._calculatedHeight*this._pivot.y;this.entity.setLocalPosition(i)}}),Object.defineProperty(WS.prototype,"width",{get:function e(){return this._width},set:function e(t){this._width=t;if(!this._hasSplitAnchorsX)this._setCalculatedWidth(t,true);this.fire("set:width",this._width)}}),Object.defineProperty(WS.prototype,"height",{get:function e(){return this._height},set:function e(t){this._height=t;if(!this._hasSplitAnchorsY)this._setCalculatedHeight(t,true);this.fire("set:height",this._height)}}),Object.defineProperty(WS.prototype,"calculatedWidth",{get:function e(){return this._calculatedWidth},set:function e(t){this._setCalculatedWidth(t,true)}}),Object.defineProperty(WS.prototype,"calculatedHeight",{get:function e(){return this._calculatedHeight},set:function e(t){this._setCalculatedHeight(t,true)}}),Object.defineProperty(WS.prototype,"pivot",{get:function e(){return this._pivot},set:function e(t){var i=this._pivot.x;var n=this._pivot.y;if(t instanceof he)this._pivot.set(t.x,t.y);else this._pivot.set(t[0],t[1]);var r=this._margin.x+this._margin.z;var s=this._pivot.x-i;this._margin.x+=r*s;this._margin.z-=r*s;var a=this._margin.y+this._margin.w;var o=this._pivot.y-n;this._margin.y+=a*o;this._margin.w-=a*o;this._anchorDirty=true;this._cornersDirty=true;this._worldCornersDirty=true;this._calculateSize(false,false);this._flagChildrenAsDirty();this.fire("set:pivot",this._pivot)}}),Object.defineProperty(WS.prototype,"anchor",{get:function e(){return this._anchor},set:function e(t){if(t instanceof ue)this._anchor.set(t.x,t.y,t.z,t.w);else this._anchor.set(t[0],t[1],t[2],t[3]);if(!this.entity._parent&&!this.screen)this._calculateLocalAnchors();else this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this._anchorDirty=true;if(!this.entity._dirtyLocal)this.entity._dirtifyLocal();this.fire("set:anchor",this._anchor)}}),Object.defineProperty(WS.prototype,"_hasSplitAnchorsX",{get:function e(){return Math.abs(this._anchor.x-this._anchor.z)>.001}}),Object.defineProperty(WS.prototype,"_hasSplitAnchorsY",{get:function e(){return Math.abs(this._anchor.y-this._anchor.w)>.001}}),Object.defineProperty(WS.prototype,"aabb",{get:function e(){if(this._image)return this._image.aabb;if(this._text)return this._text.aabb;return null}}),Object.defineProperty(WS.prototype,"screenCorners",{get:function e(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,this._absTop,0);var i=this.screen.screen.screenSpace;for(var n=0;n<4;n++){this._screenTransform.transformPoint(this._screenCorners[n],this._screenCorners[n]);if(i)this._screenCorners[n].scale(this.screen.screen.scale);if(t)this._screenCorners[n].add(t)}this._cornersDirty=false;this._canvasCornersDirty=true;this._worldCornersDirty=true;return this._screenCorners}}),Object.defineProperty(WS.prototype,"canvasCorners",{get:function e(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;var t=this.system.app.graphicsDevice;var i=this.screenCorners;var n=t.canvas.clientWidth/t.width;var r=t.canvas.clientHeight/t.height;for(var s=0;s<4;s++)this._canvasCorners[s].set(i[s].x*n,(t.height-i[s].y)*r);this._canvasCornersDirty=false;return this._canvasCorners}}),Object.defineProperty(WS.prototype,"worldCorners",{get:function e(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var t=this.screenCorners;if(!this.screen.screen.screenSpace){VS.copy(this.screen.screen._screenMatrix);VS.data[13]=-VS.data[13];VS.mul2(this.screen.getWorldTransform(),VS);for(var i=0;i<4;i++)VS.transformPoint(t[i],this._worldCorners[i])}}else{var n=this.entity.getLocalPosition();VS.setTranslate(-n.x,-n.y,-n.z);US.setTRS(ce.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale());GS.setTranslate(n.x,n.y,n.z);var r=this.entity.parent?this.entity.parent:this.entity;HS.copy(r.getWorldTransform());HS.mul(GS).mul(US).mul(VS);NS.set(n.x-this.pivot.x*this.calculatedWidth,n.y-this.pivot.y*this.calculatedHeight,n.z);HS.transformPoint(NS,this._worldCorners[0]);NS.set(n.x+(1-this.pivot.x)*this.calculatedWidth,n.y-this.pivot.y*this.calculatedHeight,n.z);HS.transformPoint(NS,this._worldCorners[1]);NS.set(n.x+(1-this.pivot.x)*this.calculatedWidth,n.y+(1-this.pivot.y)*this.calculatedHeight,n.z);HS.transformPoint(NS,this._worldCorners[2]);NS.set(n.x-this.pivot.x*this.calculatedWidth,n.y+(1-this.pivot.y)*this.calculatedHeight,n.z);HS.transformPoint(NS,this._worldCorners[3])}this._worldCornersDirty=false;return this._worldCorners}}),Object.defineProperty(WS.prototype,"textWidth",{get:function e(){return this._text?this._text.width:0}}),Object.defineProperty(WS.prototype,"textHeight",{get:function e(){return this._text?this._text.height:0}}),Object.defineProperty(WS.prototype,"useInput",{get:function e(){return this._useInput},set:function e(t){if(this._useInput===t)return;this._useInput=t;if(this.system.app.elementInput)if(t){if(this.enabled&&this.entity.enabled)this.system.app.elementInput.addElement(this)}else this.system.app.elementInput.removeElement(this);else if(this._useInput===true)console.warn("Elements will not get any input events because this.system.app.elementInput is not created");this.fire("set:useInput",t)}}),Object.defineProperty(WS.prototype,"batchGroupId",{get:function e(){return this._batchGroupId},set:function e(t){if(this._batchGroupId===t)return;if(this.entity.enabled&&this._batchGroupId>=0)this.system.app.batcher.remove(Yu.ELEMENT,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)this.system.app.batcher.insert(Yu.ELEMENT,t,this.entity);if(t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled)if(this._image&&this._image._renderable.model)this.addModelToLayers(this._image._renderable.model);else if(this._text&&this._text._model)this.addModelToLayers(this._text._model);this._batchGroupId=t}}),Object.defineProperty(WS.prototype,"maskedBy",{get:function e(){return this._maskedBy}});var jS=function e(i){Object.defineProperty(WS.prototype,i,{get:function e(){if(this._text)return this._text[i];else if(this._image)return this._image[i];return null},set:function e(t){if(this._text)this._text[i]=t;else if(this._image)this._image[i]=t}})};jS("fontSize"),jS("minFontSize"),jS("maxFontSize"),jS("maxLines"),jS("autoFitWidth"),jS("autoFitHeight"),jS("color"),jS("font"),jS("fontAsset"),jS("spacing"),jS("lineHeight"),jS("wrapLines"),jS("lines"),jS("alignment"),jS("autoWidth"),jS("autoHeight"),jS("rtlReorder"),jS("unicodeConverter"),jS("text"),jS("key"),jS("texture"),jS("textureAsset"),jS("material"),jS("materialAsset"),jS("sprite"),jS("spriteAsset"),jS("spriteFrame"),jS("pixelsPerUnit"),jS("opacity"),jS("rect"),jS("mask"),jS("outlineColor"),jS("outlineThickness"),jS("shadowColor"),jS("shadowOffset"),jS("enableMarkup"),jS("rangeStart"),jS("rangeEnd");var XS=function e(){this.enabled=true},qS=["enabled"],YS=function(c){G(e,c);function e(e){var t;t=c.call(this,e)||this;t.id="element";t.ComponentType=WS;t.DataType=XS;t.schema=qS;t._unicodeConverter=null;t._rtlReorder=null;t._defaultTexture=new bu(e.graphicsDevice,{width:1,height:1,format:Kt});t._defaultTexture.name="element-system";var i=t._defaultTexture.lock();var n=new Uint8Array(4);n[0]=255;n[1]=255;n[2]=255;n[3]=255;i.set(n);t._defaultTexture.unlock();t.defaultImageMaterial=null;t.defaultImage9SlicedMaterial=null;t.defaultImage9TiledMaterial=null;t.defaultImageMaskMaterial=null;t.defaultImage9SlicedMaskMaterial=null;t.defaultImage9TiledMaskMaterial=null;t.defaultScreenSpaceImageMaterial=null;t.defaultScreenSpaceImage9SlicedMaterial=null;t.defaultScreenSpaceImage9TiledMaterial=null;t.defaultScreenSpaceImageMask9SlicedMaterial=null;t.defaultScreenSpaceImageMask9TiledMaterial=null;t.defaultScreenSpaceImageMaskMaterial=null;t.defaultTextMaterial=null;t.defaultBitmapTextMaterial=null;t.defaultScreenSpaceTextMaterial=null;t.defaultScreenSpaceBitmapTextMaterial=null;t.defaultImageMaterials=[];t.on("beforeremove",t.onRemoveComponent,H(t));return t}var t=e.prototype;t.destroy=function e(){this._defaultTexture.destroy()};t.initializeComponentData=function e(t,i,n){t._beingInitialized=true;if(i.anchor!==undefined)if(i.anchor instanceof ue)t.anchor.copy(i.anchor);else t.anchor.set(i.anchor[0],i.anchor[1],i.anchor[2],i.anchor[3]);if(i.pivot!==undefined)if(i.pivot instanceof he)t.pivot.copy(i.pivot);else t.pivot.set(i.pivot[0],i.pivot[1]);var r=Math.abs(t.anchor.x-t.anchor.z)>.001;var s=Math.abs(t.anchor.y-t.anchor.w)>.001;var a=false;var o;if(i.margin!==undefined){if(i.margin instanceof ue)t.margin.copy(i.margin);else t._margin.set(i.margin[0],i.margin[1],i.margin[2],i.margin[3]);a=true}if(i.left!==undefined){t._margin.x=i.left;a=true}if(i.bottom!==undefined){t._margin.y=i.bottom;a=true}if(i.right!==undefined){t._margin.z=i.right;a=true}if(i.top!==undefined){t._margin.w=i.top;a=true}if(a)t.margin=t._margin;var l=false;if(i.width!==undefined&&!r)t.width=i.width;else if(r)l=true;if(i.height!==undefined&&!s)t.height=i.height;else if(s)l=true;if(l)t.anchor=t.anchor;if(i.enabled!==undefined)t.enabled=i.enabled;if(i.useInput!==undefined)t.useInput=i.useInput;t.batchGroupId=i.batchGroupId===undefined||i.batchGroupId===null?-1:i.batchGroupId;if(i.layers&&Array.isArray(i.layers))t.layers=i.layers.slice(0);if(i.type!==undefined)t.type=i.type;if(t.type===sS){if(i.rect!==undefined)t.rect=i.rect;if(i.color!==undefined){o=i.color;if(!(o instanceof ge))o=new ge(i.color[0],i.color[1],i.color[2]);t.color=o}if(i.opacity!==undefined)t.opacity=i.opacity;if(i.textureAsset!==undefined)t.textureAsset=i.textureAsset;if(i.texture)t.texture=i.texture;if(i.spriteAsset!==undefined)t.spriteAsset=i.spriteAsset;if(i.sprite)t.sprite=i.sprite;if(i.spriteFrame!==undefined)t.spriteFrame=i.spriteFrame;if(i.pixelsPerUnit!==undefined&&i.pixelsPerUnit!==null)t.pixelsPerUnit=i.pixelsPerUnit;if(i.materialAsset!==undefined)t.materialAsset=i.materialAsset;if(i.material)t.material=i.material;if(i.mask!==undefined)t.mask=i.mask}else if(t.type===aS){if(i.autoWidth!==undefined)t.autoWidth=i.autoWidth;if(i.autoHeight!==undefined)t.autoHeight=i.autoHeight;if(i.rtlReorder!==undefined)t.rtlReorder=i.rtlReorder;if(i.unicodeConverter!==undefined)t.unicodeConverter=i.unicodeConverter;if(i.text!==null&&i.text!==undefined)t.text=i.text;else if(i.key!==null&&i.key!==undefined)t.key=i.key;if(i.color!==undefined){o=i.color;if(!(o instanceof ge))o=new ge(o[0],o[1],o[2]);t.color=o}if(i.opacity!==undefined)t.opacity=i.opacity;if(i.spacing!==undefined)t.spacing=i.spacing;if(i.fontSize!==undefined){t.fontSize=i.fontSize;if(!i.lineHeight)t.lineHeight=i.fontSize}if(i.lineHeight!==undefined)t.lineHeight=i.lineHeight;if(i.maxLines!==undefined)t.maxLines=i.maxLines;if(i.wrapLines!==undefined)t.wrapLines=i.wrapLines;if(i.minFontSize!==undefined)t.minFontSize=i.minFontSize;if(i.maxFontSize!==undefined)t.maxFontSize=i.maxFontSize;if(i.autoFitWidth)t.autoFitWidth=i.autoFitWidth;if(i.autoFitHeight)t.autoFitHeight=i.autoFitHeight;if(i.fontAsset!==undefined)t.fontAsset=i.fontAsset;if(i.font!==undefined)t.font=i.font;if(i.alignment!==undefined)t.alignment=i.alignment;if(i.outlineColor!==undefined)t.outlineColor=i.outlineColor;if(i.outlineThickness!==undefined)t.outlineThickness=i.outlineThickness;if(i.shadowColor!==undefined)t.shadowColor=i.shadowColor;if(i.shadowOffset!==undefined)t.shadowOffset=i.shadowOffset;if(i.enableMarkup!==undefined)t.enableMarkup=i.enableMarkup}var h=t._parseUpToScreen();if(h.screen)t._updateScreen(h.screen);c.prototype.initializeComponentData.call(this,t,i,n);t._beingInitialized=false;if(t.type===sS&&t._image._meshDirty)t._image._updateMesh(t._image.mesh)};t.onRemoveComponent=function e(t,i){i.onRemove()};t.cloneComponent=function e(t,i){var n=t.element;var r={enabled:n.enabled,width:n.width,height:n.height,anchor:n.anchor.clone(),pivot:n.pivot.clone(),margin:n.margin.clone(),alignment:n.alignment&&n.alignment.clone()||n.alignment,autoWidth:n.autoWidth,autoHeight:n.autoHeight,type:n.type,rect:n.rect&&n.rect.clone()||n.rect,rtlReorder:n.rtlReorder,unicodeConverter:n.unicodeConverter,materialAsset:n.materialAsset,material:n.material,color:n.color&&n.color.clone()||n.color,opacity:n.opacity,textureAsset:n.textureAsset,texture:n.texture,spriteAsset:n.spriteAsset,sprite:n.sprite,spriteFrame:n.spriteFrame,pixelsPerUnit:n.pixelsPerUnit,spacing:n.spacing,lineHeight:n.lineHeight,wrapLines:n.wrapLines,layers:n.layers,fontSize:n.fontSize,minFontSize:n.minFontSize,maxFontSize:n.maxFontSize,autoFitWidth:n.autoFitWidth,autoFitHeight:n.autoFitHeight,maxLines:n.maxLines,fontAsset:n.fontAsset,font:n.font,useInput:n.useInput,batchGroupId:n.batchGroupId,mask:n.mask,outlineColor:n.outlineColor&&n.outlineColor.clone()||n.outlineColor,outlineThickness:n.outlineThickness,shadowColor:n.shadowColor&&n.shadowColor.clone()||n.shadowColor,shadowOffset:n.shadowOffset&&n.shadowOffset.clone()||n.shadowOffset,enableMarkup:n.enableMarkup};if(n.key!==undefined&&n.key!==null)r.key=n.key;else r.text=n.text;return this.addComponent(i,r)};t.getTextElementMaterial=function e(t,i){if(t){if(i){if(!this.defaultScreenSpaceTextMaterial){this.defaultScreenSpaceTextMaterial=new pM;this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial";this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture;this.defaultScreenSpaceTextMaterial.useLighting=false;this.defaultScreenSpaceTextMaterial.useGammaTonemap=false;this.defaultScreenSpaceTextMaterial.useFog=false;this.defaultScreenSpaceTextMaterial.useSkybox=false;this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0);this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1);this.defaultScreenSpaceTextMaterial.opacity=.5;this.defaultScreenSpaceTextMaterial.blendType=_l;this.defaultScreenSpaceTextMaterial.depthWrite=false;this.defaultScreenSpaceTextMaterial.depthTest=false;this.defaultScreenSpaceTextMaterial.emissiveVertexColor=true;this.defaultScreenSpaceTextMaterial.update()}return this.defaultScreenSpaceTextMaterial}if(!this.defaultScreenSpaceBitmapTextMaterial){this.defaultScreenSpaceBitmapTextMaterial=new pM;this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial";this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5);this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture;this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=true;this.defaultScreenSpaceBitmapTextMaterial.opacity=.5;this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture;this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a";this.defaultScreenSpaceBitmapTextMaterial.useLighting=false;this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=false;this.defaultScreenSpaceBitmapTextMaterial.useFog=false;this.defaultScreenSpaceBitmapTextMaterial.useSkybox=false;this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0);this.defaultScreenSpaceBitmapTextMaterial.blendType=_l;this.defaultScreenSpaceBitmapTextMaterial.depthWrite=false;this.defaultScreenSpaceBitmapTextMaterial.depthTest=false;this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=true;this.defaultScreenSpaceBitmapTextMaterial.update()}return this.defaultScreenSpaceBitmapTextMaterial}if(i){if(!this.defaultTextMaterial){this.defaultTextMaterial=new pM;this.defaultTextMaterial.name="defaultTextMaterial";this.defaultTextMaterial.msdfMap=this._defaultTexture;this.defaultTextMaterial.useLighting=false;this.defaultTextMaterial.useGammaTonemap=false;this.defaultTextMaterial.useFog=false;this.defaultTextMaterial.useSkybox=false;this.defaultTextMaterial.diffuse.set(0,0,0);this.defaultTextMaterial.emissive.set(1,1,1);this.defaultTextMaterial.opacity=.5;this.defaultTextMaterial.blendType=_l;this.defaultTextMaterial.depthWrite=false;this.defaultTextMaterial.emissiveVertexColor=true;this.defaultTextMaterial.update()}return this.defaultTextMaterial}if(!this.defaultBitmapTextMaterial){this.defaultBitmapTextMaterial=new pM;this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial";this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5);this.defaultBitmapTextMaterial.emissiveTint=true;this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture;this.defaultBitmapTextMaterial.opacity=.5;this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture;this.defaultBitmapTextMaterial.opacityMapChannel="a";this.defaultBitmapTextMaterial.useLighting=false;this.defaultBitmapTextMaterial.useGammaTonemap=false;this.defaultBitmapTextMaterial.useFog=false;this.defaultBitmapTextMaterial.useSkybox=false;this.defaultBitmapTextMaterial.diffuse.set(0,0,0);this.defaultBitmapTextMaterial.blendType=_l;this.defaultBitmapTextMaterial.depthWrite=false;this.defaultBitmapTextMaterial.emissiveVertexColor=true;this.defaultBitmapTextMaterial.update()}return this.defaultBitmapTextMaterial};t._createBaseImageMaterial=function e(){var t=new pM;t.diffuse.set(0,0,0);t.emissive.set(.5,.5,.5);t.emissiveMap=this._defaultTexture;t.emissiveTint=true;t.opacityMap=this._defaultTexture;t.opacityMapChannel="a";t.opacityTint=true;t.opacity=0;t.useLighting=false;t.useGammaTonemap=false;t.useFog=false;t.useSkybox=false;t.blendType=_l;t.depthWrite=false;return t};t.getImageElementMaterial=function e(t,i,n,r){if(t)if(i)if(n){if(!this.defaultScreenSpaceImageMask9SlicedMaterial){this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial();this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial";this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=vc;this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=false;this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1;this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=false;this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=false;this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=false;this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=false;this.defaultScreenSpaceImageMask9SlicedMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)}return this.defaultScreenSpaceImageMask9SlicedMaterial}else if(r){if(!this.defaultScreenSpaceImageMask9TiledMaterial){this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone();this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial";this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=gc;this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=false;this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1;this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=false;this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=false;this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=false;this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=false;this.defaultScreenSpaceImageMask9TiledMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)}return this.defaultScreenSpaceImageMask9TiledMaterial}else{if(!this.defaultScreenSpaceImageMaskMaterial){this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial();this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial";this.defaultScreenSpaceImageMaskMaterial.depthTest=false;this.defaultScreenSpaceImageMaskMaterial.alphaTest=1;this.defaultScreenSpaceImageMaskMaterial.redWrite=false;this.defaultScreenSpaceImageMaskMaterial.greenWrite=false;this.defaultScreenSpaceImageMaskMaterial.blueWrite=false;this.defaultScreenSpaceImageMaskMaterial.alphaWrite=false;this.defaultScreenSpaceImageMaskMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)}return this.defaultScreenSpaceImageMaskMaterial}else if(n){if(!this.defaultScreenSpaceImage9SlicedMaterial){this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial();this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial";this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=vc;this.defaultScreenSpaceImage9SlicedMaterial.depthTest=false;this.defaultScreenSpaceImage9SlicedMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)}return this.defaultScreenSpaceImage9SlicedMaterial}else if(r){if(!this.defaultScreenSpaceImage9TiledMaterial){this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial();this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial";this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=gc;this.defaultScreenSpaceImage9TiledMaterial.depthTest=false;this.defaultScreenSpaceImage9TiledMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)}return this.defaultScreenSpaceImage9TiledMaterial}else{if(!this.defaultScreenSpaceImageMaterial){this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial();this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial";this.defaultScreenSpaceImageMaterial.depthTest=false;this.defaultScreenSpaceImageMaterial.update();this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)}return this.defaultScreenSpaceImageMaterial}else if(i)if(n){if(!this.defaultImage9SlicedMaskMaterial){this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial();this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial";this.defaultImage9SlicedMaskMaterial.nineSlicedMode=vc;this.defaultImage9SlicedMaskMaterial.alphaTest=1;this.defaultImage9SlicedMaskMaterial.redWrite=false;this.defaultImage9SlicedMaskMaterial.greenWrite=false;this.defaultImage9SlicedMaskMaterial.blueWrite=false;this.defaultImage9SlicedMaskMaterial.alphaWrite=false;this.defaultImage9SlicedMaskMaterial.update();this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)}return this.defaultImage9SlicedMaskMaterial}else if(r){if(!this.defaultImage9TiledMaskMaterial){this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial();this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial";this.defaultImage9TiledMaskMaterial.nineSlicedMode=gc;this.defaultImage9TiledMaskMaterial.alphaTest=1;this.defaultImage9TiledMaskMaterial.redWrite=false;this.defaultImage9TiledMaskMaterial.greenWrite=false;this.defaultImage9TiledMaskMaterial.blueWrite=false;this.defaultImage9TiledMaskMaterial.alphaWrite=false;this.defaultImage9TiledMaskMaterial.update();this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)}return this.defaultImage9TiledMaskMaterial}else{if(!this.defaultImageMaskMaterial){this.defaultImageMaskMaterial=this._createBaseImageMaterial();this.defaultImageMaskMaterial.name="defaultImageMaskMaterial";this.defaultImageMaskMaterial.alphaTest=1;this.defaultImageMaskMaterial.redWrite=false;this.defaultImageMaskMaterial.greenWrite=false;this.defaultImageMaskMaterial.blueWrite=false;this.defaultImageMaskMaterial.alphaWrite=false;this.defaultImageMaskMaterial.update();this.defaultImageMaterials.push(this.defaultImageMaskMaterial)}return this.defaultImageMaskMaterial}else if(n){if(!this.defaultImage9SlicedMaterial){this.defaultImage9SlicedMaterial=this._createBaseImageMaterial();this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial";this.defaultImage9SlicedMaterial.nineSlicedMode=vc;this.defaultImage9SlicedMaterial.update();this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)}return this.defaultImage9SlicedMaterial}else if(r){if(!this.defaultImage9TiledMaterial){this.defaultImage9TiledMaterial=this._createBaseImageMaterial();this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial";this.defaultImage9TiledMaterial.nineSlicedMode=gc;this.defaultImage9TiledMaterial.update();this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)}return this.defaultImage9TiledMaterial}else{if(!this.defaultImageMaterial){this.defaultImageMaterial=this._createBaseImageMaterial();this.defaultImageMaterial.name="defaultImageMaterial";this.defaultImageMaterial.update();this.defaultImageMaterials.push(this.defaultImageMaterial)}return this.defaultImageMaterial}};t.registerUnicodeConverter=function e(t){this._unicodeConverter=t};t.registerRtlReorder=function e(t){this._rtlReorder=t};t.getUnicodeConverter=function e(){return this._unicodeConverter};t.getRtlReorder=function e(){return this._rtlReorder};return e}(L0);R0._buildAccessors(WS.prototype,qS);var KS=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._minWidth=0;i._minHeight=0;i._maxWidth=null;i._maxHeight=null;i._fitWidthProportion=0;i._fitHeightProportion=0;i._excludeFromLayout=false;return i}return e}(R0);function QS(e){var i="_"+e;Object.defineProperty(KS.prototype,e,{get:function e(){return this[i]},set:function e(t){if(this[i]!==t){this[i]=t;this.fire("resize")}}})}QS("minWidth"),QS("minHeight"),QS("maxWidth"),QS("maxHeight"),QS("fitWidthProportion"),QS("fitHeightProportion"),QS("excludeFromLayout");var $S=function e(){this.enabled=true},ZS=["enabled"],JS=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="layoutchild";t.ComponentType=KS;t.DataType=$S;t.schema=ZS;return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){if(i.enabled!==undefined)t.enabled=i.enabled;if(i.minWidth!==undefined)t.minWidth=i.minWidth;if(i.minHeight!==undefined)t.minHeight=i.minHeight;if(i.maxWidth!==undefined)t.maxWidth=i.maxWidth;if(i.maxHeight!==undefined)t.maxHeight=i.maxHeight;if(i.fitWidthProportion!==undefined)t.fitWidthProportion=i.fitWidthProportion;if(i.fitHeightProportion!==undefined)t.fitHeightProportion=i.fitHeightProportion;if(i.excludeFromLayout!==undefined)t.excludeFromLayout=i.excludeFromLayout;r.prototype.initializeComponentData.call(this,t,i,n)};t.cloneComponent=function e(t,i){var n=t.layoutchild;return this.addComponent(i,{enabled:n.enabled,minWidth:n.minWidth,minHeight:n.minHeight,maxWidth:n.maxWidth,maxHeight:n.maxHeight,fitWidthProportion:n.fitWidthProportion,fitHeightProportion:n.fitHeightProportion,excludeFromLayout:n.excludeFromLayout})};return e}(L0);R0._buildAccessors(KS.prototype,ZS);var ew=0,tw=1,iw=2,nw=3,rw={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},sw={};sw[Fc]=Bc,sw[Bc]=Fc;var aw={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},ow={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},lw=new he;function hw(e){var m;var _=rw[e];var v=rw[sw[e]];function u(e,t){return-t[_.size]*e.pivot[_.axis]}function f(e,t){return-t[v.size]*e.pivot[v.axis]}function d(e,t){return t[_.size]*(1-e.pivot[_.axis])}function t(e,t){e=e.filter(s);m=t;lw.x=m.containerSize.x-m.padding.x-m.padding.z;lw.y=m.containerSize.y-m.padding.y-m.padding.w;a(e);var i=l(o(e));var n=c(i,h(i));var r=S(i,n);w(i,n,r);T(i,n,r);return M(i)}function s(e){var t=e.entity.layoutchild;return!t||!t.enabled||!t.excludeFromLayout}function a(e){for(var t=0;t<e.length;++t){var i=e[t];var n=i.anchor;if(n.x!==0||n.y!==0||n.z!==0||n.w!==0)i.anchor=ue.ZERO}}function o(e){if(!m.wrap)return[e];var t=[[]];var i=C(e);var n=0;var r=m[_.fitting]===iw;for(var s=0;s<e.length;++s){if(t[t.length-1].length>0)n+=m.spacing[_.axis];var a=i[s][_.size];n+=a;if(!r&&n>lw[_.axis]&&t[t.length-1].length!==0){n=a;t.push([])}t[t.length-1].push(e[s]);if(r&&n>lw[_.axis]&&s!==e.length-1){n=0;t.push([])}}return t}function l(e){var t=m.orientation===Fc&&m.reverseX||m.orientation===Bc&&m.reverseY;var i=m.orientation===Fc&&m.reverseY||m.orientation===Bc&&m.reverseX;if(t)for(var n=0;n<e.length;++n)if(t)e[n].reverse();if(i)e.reverse();return e}function h(e){var t=[];for(var i=0;i<e.length;++i){var n=e[i];var r=C(n);var s=g(r,_);var a=p(m[_.fitting],s,lw[_.axis]);if(a===ow.APPLY_STRETCHING)y(r,s,_);else if(a===ow.APPLY_SHRINKING)b(r,s,_);t.push(r)}return t}function c(e,t){var i=[];var n=[];var r;var s;var a;for(s=0;s<e.length;++s){a=e[s];a.largestElement=null;a.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(r=0;r<a.length;++r){var o=t[s][r];if(o[v.size]>a.largestSize[v.size]){a.largestElement=a[r];a.largestSize=o}}i.push(a.largestElement);n.push(a.largestSize)}var l=g(n,v);var h=p(m[v.fitting],l,lw[v.axis]);if(h===ow.APPLY_STRETCHING)y(n,l,v);else if(h===ow.APPLY_SHRINKING)b(n,l,v);for(s=0;s<e.length;++s){a=e[s];for(r=0;r<a.length;++r){var c=t[s][r];var u=c[v.size];var f=e.length===1?lw[v.axis]:a.largestSize[v.size];var d=p(m[v.fitting],u,f);if(d===ow.APPLY_STRETCHING)c[v.size]=Math.min(f,c[v.maxSize]);else if(d===ow.APPLY_SHRINKING)c[v.size]=Math.max(f,c[v.minSize])}}return t}function p(e,t,i){switch(e){case ew:return ow.NONE;case tw:if(t<i)return ow.APPLY_STRETCHING;return ow.NONE;case iw:if(t>=i)return ow.APPLY_SHRINKING;return ow.NONE;case nw:if(t<i)return ow.APPLY_STRETCHING;else if(t>=i)return ow.APPLY_SHRINKING;return ow.NONE;default:throw new Error("Unrecognized fitting mode: "+e)}}function g(e,t){var i=E(e,t.size);var n=(e.length-1)*m.spacing[t.axis];return i+n}function y(e,t,i){var n=L(e,i.maxSize);var r=I(e,i.fittingProportion);var s=k(r,n);var a=lw[i.axis]-t;for(var o=0;o<e.length;++o){var l=n[o];var h=x(l,a,r,s);var c=e[l][i.size]+h;var u=e[l][i.maxSize];var f=Math.min(c,u);e[l][i.size]=f;var d=Math.max(c-f,0);var p=h-d;a-=p}}function b(e,t,i){var n=L(e,i.minSize,true);var r=I(e,i.fittingProportion);var s=R(r);var a=k(s,n);var o=t-lw[i.axis];for(var l=0;l<e.length;++l){var h=n[l];var c=x(h,o,s,a);var u=e[h][i.size]-c;var f=e[h][i.minSize];var d=Math.max(u,f);e[h][i.size]=d;var p=Math.max(d-u,0);var m=c-p;o-=m}}function x(e,t,i,n){var r=i[e];var s=n[e];if(Math.abs(r)<1e-5&&Math.abs(s)<1e-5)return t;return t*r/s}function S(e,t){var i={};i[_.axis]=0;i[v.axis]=0;e[_.size]=Number.NEGATIVE_INFINITY;var n=[];for(var r=0;r<e.length;++r){var s=e[r];if(s.length===0)return;var a=[];var o=t[r];for(var l=0;l<s.length;++l){var h=s[l];var c=o[l];i[v.axis]-=f(h,c);i[_.axis]-=u(h,c);a[l]={};a[l][_.axis]=i[_.axis];a[l][v.axis]=i[v.axis];i[v.axis]+=f(h,c);i[_.axis]+=d(h,c)+m.spacing[_.axis]}s[_.size]=i[_.axis]-m.spacing[_.axis];s[v.size]=s.largestSize[v.size];e[_.size]=Math.max(e[_.size],s[_.size]);i[_.axis]=0;i[v.axis]+=s[v.size]+m.spacing[v.axis];n.push(a)}e[v.size]=i[v.axis]-m.spacing[v.axis];return n}function w(e,t,i){var n=m.alignment[_.axis];var r=m.alignment[v.axis];var s=m.padding[_.axis];var a=m.padding[v.axis];for(var o=0;o<e.length;++o){var l=e[o];var h=t[o];var c=i[o];var u=(lw[_.axis]-l[_.size])*n+s;var f=(lw[v.axis]-e[v.size])*r+a;for(var d=0;d<l.length;++d){var p=(l[v.size]-h[d][v.size])*m.alignment[v.axis];c[d][_.axis]+=u;c[d][v.axis]+=f+p}}}function T(e,t,i){for(var n=0;n<e.length;++n){var r=e[n];var s=t[n];var a=i[n];for(var o=0;o<r.length;++o){var l=r[o];l[_.calculatedSize]=s[o][_.size];l[v.calculatedSize]=s[o][v.size];if(m.orientation===Fc)l.entity.setLocalPosition(a[o][_.axis],a[o][v.axis],l.entity.getLocalPosition().z);else l.entity.setLocalPosition(a[o][v.axis],a[o][_.axis],l.entity.getLocalPosition().z)}}}function M(e){var t=e.width;var i=e.height;var n=(lw.x-t)*m.alignment.x+m.padding.x;var r=(lw.y-i)*m.alignment.y+m.padding.y;return{bounds:new ue(n,r,t,i)}}function C(e){var t=[];for(var i=0;i<e.length;++i){var n=e[i];var r=Math.max(A(n,"minWidth"),0);var s=Math.max(A(n,"minHeight"),0);var a=Math.max(A(n,"maxWidth"),r);var o=Math.max(A(n,"maxHeight"),s);var l=P(A(n,"width"),r,a);var h=P(A(n,"height"),s,o);var c=A(n,"fitWidthProportion");var u=A(n,"fitHeightProportion");t.push({minWidth:r,minHeight:s,maxWidth:a,maxHeight:o,width:l,height:h,fitWidthProportion:c,fitHeightProportion:u})}return t}function A(e,t){var i=e.entity.layoutchild;if(i&&i.enabled&&i[t]!==undefined&&i[t]!==null)return i[t];else if(e[t]!==undefined)return e[t];return aw[t]}function P(e,t,i){return Math.min(Math.max(e,t),i)}function E(e,i){return e.reduce(function(e,t){return e+t[i]},0)}function I(e,t){var i=E(e,t);var n=[];var r=e.length;var s;if(i===0)for(s=0;s<r;++s)n.push(1/r);else for(s=0;s<r;++s)n.push(e[s][t]/i);return n}function R(e){if(e.length===1)return[1];var t=[];var i=e.length;for(var n=0;n<i;++n)t.push((1-e[n])/(i-1));return t}function L(e,i,n){e.forEach(r);return e.slice().sort(function(e,t){return n?t[i]-e[i]:e[i]-t[i]}).map(D)}function r(e,t){e.index=t}function D(e){return e.index}function k(e,t){var i=[];i[t[e.length-1]]=e[t[e.length-1]];for(var n=e.length-2;n>=0;--n)i[t[n]]=i[t[n+1]]+e[t[n]];return i}return t}var cw={};cw[Fc]=hw(Fc),cw[Bc]=hw(Bc);var uw=function(){function e(){}var t=e.prototype;t.calculateLayout=function e(t,i){var n=cw[i.orientation];if(!n)throw new Error("Unrecognized orientation value: "+i.orientation);else return n(t,i)};return e}();function fw(e){return e.element}function dw(e){return e.enabled&&e.element&&e.element.enabled}var pw=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._orientation=Fc;i._reverseX=false;i._reverseY=true;i._alignment=new he(0,1);i._padding=new ue;i._spacing=new he;i._widthFitting=ew;i._heightFitting=ew;i._wrap=false;i._layoutCalculator=new uw;i._listenForReflowEvents(i.entity,"on");i.entity.children.forEach(function(e){this._listenForReflowEvents(e,"on")}.bind(H(i)));i.entity.on("childinsert",i._onChildInsert,H(i));i.entity.on("childremove",i._onChildRemove,H(i));e.app.systems.element.on("add",i._onElementOrLayoutComponentAdd,H(i));e.app.systems.element.on("beforeremove",i._onElementOrLayoutComponentRemove,H(i));e.app.systems.layoutchild.on("add",i._onElementOrLayoutComponentAdd,H(i));e.app.systems.layoutchild.on("beforeremove",i._onElementOrLayoutComponentRemove,H(i));return i}var t=e.prototype;t._isSelfOrChild=function e(t){return t===this.entity||this.entity.children.indexOf(t)!==-1};t._listenForReflowEvents=function e(t,i){if(t.element){t.element[i]("enableelement",this._scheduleReflow,this);t.element[i]("disableelement",this._scheduleReflow,this);t.element[i]("resize",this._scheduleReflow,this);t.element[i]("set:pivot",this._scheduleReflow,this)}if(t.layoutchild){t.layoutchild[i]("set_enabled",this._scheduleReflow,this);t.layoutchild[i]("resize",this._scheduleReflow,this)}};t._onElementOrLayoutComponentAdd=function e(t){if(this._isSelfOrChild(t)){this._listenForReflowEvents(t,"on");this._scheduleReflow()}};t._onElementOrLayoutComponentRemove=function e(t){if(this._isSelfOrChild(t)){this._listenForReflowEvents(t,"off");this._scheduleReflow()}};t._onChildInsert=function e(t){this._listenForReflowEvents(t,"on");this._scheduleReflow()};t._onChildRemove=function e(t){this._listenForReflowEvents(t,"off");this._scheduleReflow()};t._scheduleReflow=function e(){if(this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow)this.system.scheduleReflow(this)};t.reflow=function e(){var t=fw(this.entity);var i=this.entity.children.filter(dw).map(fw);if(!t||i.length===0)return;var n=Math.max(t.calculatedWidth,0);var r=Math.max(t.calculatedHeight,0);var s={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new he(n,r)};this._isPerformingReflow=true;var a=this._layoutCalculator.calculateLayout(i,s);this._isPerformingReflow=false;this.fire("reflow",a)};t.onEnable=function e(){this._scheduleReflow()};t.onRemove=function e(){this.entity.off("childinsert",this._onChildInsert,this);this.entity.off("childremove",this._onChildRemove,this);this._listenForReflowEvents(this.entity,"off");this.entity.children.forEach(function(e){this._listenForReflowEvents(e,"off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)};return e}(R0);function mw(e){var i="_"+e;Object.defineProperty(pw.prototype,e,{get:function e(){return this[i]},set:function e(t){if(this[i]!==t){this[i]=t;this._scheduleReflow()}}})}mw("orientation"),mw("reverseX"),mw("reverseY"),mw("alignment"),mw("padding"),mw("spacing"),mw("widthFitting"),mw("heightFitting"),mw("wrap");var _w=function e(){this.enabled=true},vw=["enabled"],gw=100,yw=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="layoutgroup";t.ComponentType=pw;t.DataType=_w;t.schema=vw;t._reflowQueue=[];t.on("beforeremove",t._onRemoveComponent,H(t));L0.bind("postUpdate",t._onPostUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){if(i.enabled!==undefined)t.enabled=i.enabled;if(i.orientation!==undefined)t.orientation=i.orientation;if(i.reverseX!==undefined)t.reverseX=i.reverseX;if(i.reverseY!==undefined)t.reverseY=i.reverseY;if(i.alignment!==undefined){if(i.alignment instanceof he)t.alignment.copy(i.alignment);else t.alignment.set(i.alignment[0],i.alignment[1]);t.alignment=t.alignment}if(i.padding!==undefined){if(i.padding instanceof ue)t.padding.copy(i.padding);else t.padding.set(i.padding[0],i.padding[1],i.padding[2],i.padding[3]);t.padding=t.padding}if(i.spacing!==undefined){if(i.spacing instanceof he)t.spacing.copy(i.spacing);else t.spacing.set(i.spacing[0],i.spacing[1]);t.spacing=t.spacing}if(i.widthFitting!==undefined)t.widthFitting=i.widthFitting;if(i.heightFitting!==undefined)t.heightFitting=i.heightFitting;if(i.wrap!==undefined)t.wrap=i.wrap;r.prototype.initializeComponentData.call(this,t,i,n)};t.cloneComponent=function e(t,i){var n=t.layoutgroup;return this.addComponent(i,{enabled:n.enabled,orientation:n.orientation,reverseX:n.reverseX,reverseY:n.reverseY,alignment:n.alignment,padding:n.padding,spacing:n.spacing,widthFitting:n.widthFitting,heightFitting:n.heightFitting,wrap:n.wrap})};t.scheduleReflow=function e(t){if(this._reflowQueue.indexOf(t)===-1)this._reflowQueue.push(t)};t._onPostUpdate=function e(){this._processReflowQueue()};t._processReflowQueue=function e(){if(this._reflowQueue.length===0)return;var t=0;while(this._reflowQueue.length>0){var i=this._reflowQueue.slice();this._reflowQueue.length=0;i.sort(function(e,t){return e.entity.graphDepth-t.entity.graphDepth});for(var n=0;n<i.length;++n)i[n].reflow();if(++t>=gw){console.warn("Max reflow iterations limit reached, bailing.");break}}};t._onRemoveComponent=function e(t,i){i.onRemove()};return e}(L0);R0._buildAccessors(pw.prototype,vw);var bw=new ce,xw=new ce,Sw=new ce,ww={r:0,g:1,b:2,a:3},Tw=function(){function t(){this._type=Nl;this._color=new ge(.8,.8,.8);this._intensity=1;this._castShadows=false;this.enabled=false;this.mask=1;this.isStatic=false;this.key=0;this.bakeDir=true;this.attenuationStart=10;this.attenuationEnd=10;this._falloffMode=0;this._shadowType=Yl;this._vsmBlurSize=11;this.vsmBlurMode=th;this.vsmBias=.01*.25;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=true;this._cookieChannel="rgb";this._cookieTransform=null;this._cookieTransformUniform=new Float32Array(4);this._cookieOffset=null;this._cookieOffsetUniform=new Float32Array(2);this._cookieTransformSet=false;this._cookieOffsetSet=false;this._innerConeAngle=40;this._outerConeAngle=45;this._shape=Gl;this._finalColor=new Float32Array([.8,.8,.8]);var e=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([e,e,e]);this._position=new ce(0,0,0);this._direction=new ce(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new ve;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5e-4;this._normalOffsetBias=0;this.shadowUpdateMode=rc;this._scene=null;this._node=null;this._rendererParams=[];this._isVsm=false;this._isPcf=true;this._cacheShadowMap=false;this._isCachedShadowMap=false;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=[]}var e=t.prototype;e.destroy=function e(){this._destroyShadowMap()};e.clone=function e(){var e=new t;e.type=this._type;e.setColor(this._color);e.intensity=this._intensity;e.castShadows=this.castShadows;e.enabled=this.enabled;e.attenuationStart=this.attenuationStart;e.attenuationEnd=this.attenuationEnd;e.falloffMode=this._falloffMode;e.shadowType=this._shadowType;e.vsmBlurSize=this._vsmBlurSize;e.vsmBlurMode=this.vsmBlurMode;e.vsmBias=this.vsmBias;e.shadowUpdateMode=this.shadowUpdateMode;e.mask=this.mask;e.innerConeAngle=this._innerConeAngle;e.outerConeAngle=this._outerConeAngle;e.shape=this._shape;e.shadowBias=this.shadowBias;e.normalOffsetBias=this._normalOffsetBias;e.shadowResolution=this._shadowResolution;e.shadowDistance=this.shadowDistance;return e};e.getColor=function e(){return this._color};e.getBoundingSphere=function e(t){if(this._type===Ul){var i=this.attenuationEnd;var n=this._outerConeAngle;var r=Math.cos(n*Pe.DEG_TO_RAD);var s=this._node;bw.copy(s.up);bw.scale(-i*.5*r);bw.add(s.getPosition());t.center=bw;xw.copy(s.up);xw.scale(-i);Sw.copy(s.right);Sw.scale(Math.sin(n*Pe.DEG_TO_RAD)*i);xw.add(Sw);t.radius=xw.length()*.5}else if(this._type===zl){t.center=this._node.getPosition();t.radius=this.attenuationEnd}};e.getBoundingBox=function e(t){if(this._type===Ul){var i=this.attenuationEnd;var n=this._outerConeAngle;var r=this._node;var s=Math.abs(Math.sin(n*Pe.DEG_TO_RAD)*i);t.center.set(0,-i*.5,0);t.halfExtents.set(s,i*.5,s);t.setFromTransformedAabb(t,r.getWorldTransform())}else if(this._type===zl){t.center.copy(this._node.getPosition());t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd)}};e._updateFinalColor=function e(){var t=this._color;var i=t.r;var n=t.g;var r=t.b;var s=this._intensity;var a=this._finalColor;var o=this._linearFinalColor;a[0]=i*s;a[1]=n*s;a[2]=r*s;if(s>=1){o[0]=Math.pow(i,2.2)*s;o[1]=Math.pow(n,2.2)*s;o[2]=Math.pow(r,2.2)*s}else{o[0]=Math.pow(a[0],2.2);o[1]=Math.pow(a[1],2.2);o[2]=Math.pow(a[2],2.2)}};e.setColor=function e(){var t,i,n;if(arguments.length===1){t=arguments[0].r;i=arguments[0].g;n=arguments[0].b}else if(arguments.length===3){t=arguments[0];i=arguments[1];n=arguments[2]}this._color.set(t,i,n);this._updateFinalColor()};e._destroyShadowMap=function e(){if(this._shadowCamera){if(!this._isCachedShadowMap){var t=this._shadowCamera.renderTarget;var i;if(t)if(t.length)for(i=0;i<t.length;i++){if(t[i].colorBuffer)t[i].colorBuffer.destroy();t[i].destroy()}else{if(t.colorBuffer)t.colorBuffer.destroy();if(t.depthBuffer)t.depthBuffer.destroy();t.destroy()}}this._shadowCamera.renderTarget=null;this._shadowCamera=null;this._shadowCubeMap=null;if(this.shadowUpdateMode===ic)this.shadowUpdateMode=nc}};e.updateShadow=function e(){if(this.shadowUpdateMode!==rc)this.shadowUpdateMode=nc};e.updateKey=function e(){var t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(this._normalOffsetBias!==0?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|ww[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12|this._shape<<9;if(this._cookieChannel.length===3){t|=ww[this._cookieChannel.charAt(1)]<<16;t|=ww[this._cookieChannel.charAt(2)]<<14}if(t!==this.key&&this._scene!==null)this._scene.layers._dirtyLights=true;this.key=t};e.uploadAreaLightLUTs=function e(){function t(e,t,i){var n=new bu(e,{width:64,height:64,format:i,addressU:We,addressV:We,type:_n,magFilter:Ct,minFilter:Mt,anisotropy:1});n.lock().set(t);n.unlock();n.upload();return n}function i(e,t,i){var n=e.length;var r=new Float32Array(n);for(var s=0;s<n;s++){var a=s%4;r[s]=(e[s]+t[a])*i[a]}return r}function n(e){var t=e.length;var i=new Uint16Array(t);var n=Pe.float2Half;for(var r=0;r<t;r++)i[r]=n(e[r]);return i}function r(e){var t=e.length;var i=new Uint8ClampedArray(t);for(var n=0;n<t;n++)i[n]=e[n]*255;return i}var s=rM.getApplication();var a=pc._areaLightLutData;if(a&&!a.ready){a.ready=true;var o=s.graphicsDevice;var l,h;var c=o._areaLightLutFormat;if(c===ii){l=a.data1;h=a.data2}else if(c===ei){l=n(a.data1);h=n(a.data2)}else{var u=[0,.2976,.01381,0];var f=[.999,3.08737,1.6546,.603249];var d=[-.306897,0,0,0];var p=[1.442787,1,1,1];l=r(i(a.data1,u,f));h=r(i(a.data2,d,p))}var m=t(o,l,c);var _=t(o,h,c);o.scope.resolve("areaLightsLutTex1").setValue(m);o.scope.resolve("areaLightsLutTex2").setValue(_)}};U(t,[{key:"type",get:function e(){return this._type},set:function e(t){if(this._type===t)return;this._type=t;this._destroyShadowMap();this.updateKey();var i=this._shadowType;this._shadowType=null;this.shadowType=i}},{key:"shape",get:function e(){return this._shape},set:function e(t){if(t===void 0)t=Gl;if(this._shape===t)return;if(t!==Gl)this.uploadAreaLightLUTs();this._shape=t;this._destroyShadowMap();this.updateKey();var i=this._shadowType;this._shadowType=null;this.shadowType=i}},{key:"shadowType",get:function e(){return this._shadowType},set:function e(t){if(this._shadowType===t)return;var i=rM.getApplication().graphicsDevice;if(this._type===zl)t=Yl;if(t===Jl&&!i.webgl2)t=Yl;if(t===Zl&&!i.textureFloatRenderable)t=$l;if(t===$l&&!i.textureHalfFloatRenderable)t=Ql;this._isVsm=t>=Ql&&t<=Zl;this._isPcf=t===Jl||t===Yl;this._shadowType=t;this._destroyShadowMap();this.updateKey()}},{key:"castShadows",get:function e(){return this._castShadows&&this.mask!==hc&&this.mask!==0},set:function e(t){if(this._castShadows===t)return;this._castShadows=t;this.updateKey()}},{key:"shadowResolution",get:function e(){return this._shadowResolution},set:function e(t){if(this._shadowResolution===t)return;var i=rM.getApplication().graphicsDevice;if(this._type===zl)t=Math.min(t,i.maxCubeMapSize);else t=Math.min(t,i.maxTextureSize);this._shadowResolution=t}},{key:"vsmBlurSize",get:function e(){return this._vsmBlurSize},set:function e(t){if(this._vsmBlurSize===t)return;if(t%2===0)t++;this._vsmBlurSize=t}},{key:"normalOffsetBias",get:function e(){return this._normalOffsetBias},set:function e(t){if(this._normalOffsetBias===t)return;if(!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)this.updateKey();this._normalOffsetBias=t}},{key:"falloffMode",get:function e(){return this._falloffMode},set:function e(t){if(this._falloffMode===t)return;this._falloffMode=t;this.updateKey()}},{key:"innerConeAngle",get:function e(){return this._innerConeAngle},set:function e(t){if(this._innerConeAngle===t)return;this._innerConeAngle=t;this._innerConeAngleCos=Math.cos(t*Math.PI/180)}},{key:"outerConeAngle",get:function e(){return this._outerConeAngle},set:function e(t){if(this._outerConeAngle===t)return;this._outerConeAngle=t;this._outerConeAngleCos=Math.cos(t*Math.PI/180)}},{key:"intensity",get:function e(){return this._intensity},set:function e(t){if(this._intensity!==t){this._intensity=t;this._updateFinalColor()}}},{key:"cookie",get:function e(){return this._cookie},set:function e(t){if(this._cookie===t)return;this._cookie=t;this.updateKey()}},{key:"cookieFalloff",get:function e(){return this._cookieFalloff},set:function e(t){if(this._cookieFalloff===t)return;this._cookieFalloff=t;this.updateKey()}},{key:"cookieChannel",get:function e(){return this._cookieChannel},set:function e(t){if(this._cookieChannel===t)return;if(t.length<3){var i=t.charAt(t.length-1);var n=3-t.length;for(var r=0;r<n;r++)t+=i}this._cookieChannel=t;this.updateKey()}},{key:"cookieTransform",get:function e(){return this._cookieTransform},set:function e(t){if(this._cookieTransform===t)return;this._cookieTransform=t;this._cookieTransformSet=!!t;if(t&&!this._cookieOffset){this.cookieOffset=new he;this._cookieOffsetSet=false}this.updateKey()}},{key:"cookieOffset",get:function e(){return this._cookieOffset},set:function e(t){if(this._cookieOffset===t)return;var i=!!(this._cookieTransformSet||t);if(i&&!t&&this._cookieOffset)this._cookieOffset.set(0,0);else this._cookieOffset=t;this._cookieOffsetSet=!!t;if(t&&!this._cookieTransform){this.cookieTransform=new ue(1,1,0,0);this._cookieTransformSet=false}this.updateKey()}}]);return t}(),Mw=[],Cw=[],Aw=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._cookieAsset=null;i._cookieAssetId=null;i._cookieAssetAdd=false;i._cookieMatrix=null;return i}var t=e.prototype;t.addLightToLayers=function e(){var t;for(var i=0;i<this.layers.length;i++){t=this.system.app.scene.layers.getLayerById(this.layers[i]);if(!t)continue;t.addLight(this)}};t.removeLightFromLayers=function e(){var t;for(var i=0;i<this.layers.length;i++){t=this.system.app.scene.layers.getLayerById(this.layers[i]);if(!t)continue;t.removeLight(this)}};t.onLayersChanged=function e(t,i){if(this.enabled&&this.entity.enabled)this.addLightToLayers();t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;if(this.enabled&&this.entity.enabled)t.addLight(this)};t.onLayerRemoved=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.removeLight(this)};t.refreshProperties=function e(){var t;for(var i=0;i<Mw.length;i++){t=Mw[i];this[t]=this[t]}if(this.enabled&&this.entity.enabled)this.onEnable()};t.updateShadow=function e(){this.light.updateShadow()};t.onCookieAssetSet=function e(){var t=false;if(this._cookieAsset.type==="cubemap"&&!this._cookieAsset.loadFaces){this._cookieAsset.loadFaces=true;t=true}if(!this._cookieAsset.resource||t)this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()};t.onCookieAssetAdd=function e(t){if(this._cookieAssetId!==t.id)return;this._cookieAsset=t;if(this.light.enabled)this.onCookieAssetSet();this._cookieAsset.on("load",this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)};t.onCookieAssetLoad=function e(){if(!this._cookieAsset||!this._cookieAsset.resource)return;this.cookie=this._cookieAsset.resource};t.onCookieAssetRemove=function e(){if(!this._cookieAssetId)return;if(this._cookieAssetAdd){this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this);this._cookieAssetAdd=false}if(this._cookieAsset){this._cookieAsset.off("load",this.onCookieAssetLoad,this);this._cookieAsset.off("remove",this.onCookieAssetRemove,this);this._cookieAsset=null}this.cookie=null};t.onEnable=function e(){this.light.enabled=true;this.system.app.scene.on("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.on("add",this.onLayerAdded,this);this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)}if(this.enabled&&this.entity.enabled)this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()};t.onDisable=function e(){this.light.enabled=false;this.system.app.scene.off("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.off("add",this.onLayerAdded,this);this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)}this.removeLightFromLayers()};t.onRemove=function e(){this.onDisable();this.light.destroy();this.cookieAsset=null};return e}(R0);function Pw(r,e,s,a){var t=Aw.prototype;Mw.push(r);Cw.push(e);Object.defineProperty(t,r,{get:function e(){return this.data[r]},set:function e(t){var i=this.data;var n=i[r];if(!a&&n===t)return;i[r]=t;if(s)s.call(this,t,n)},configurable:true})}function Ew(){Pw("enabled",true,function(e,t){this.onSetEnabled(null,t,e)});Pw("light",null);Pw("type","directional",function(e,t){this.system.changeType(this,t,e);this.refreshProperties()});Pw("color",new ge(1,1,1),function(e,t){this.light.setColor(e)},true);Pw("intensity",1,function(e,t){this.light.intensity=e});Pw("shape",Gl,function(e,t){this.light.shape=e});Pw("castShadows",false,function(e,t){this.light.castShadows=e});Pw("shadowDistance",40,function(e,t){this.light.shadowDistance=e});Pw("shadowResolution",1024,function(e,t){this.light.shadowResolution=e});Pw("shadowBias",.05,function(e,t){this.light.shadowBias=-.01*e});Pw("normalOffsetBias",0,function(e,t){this.light.normalOffsetBias=e});Pw("range",10,function(e,t){this.light.attenuationEnd=e});Pw("innerConeAngle",40,function(e,t){this.light.innerConeAngle=e});Pw("outerConeAngle",45,function(e,t){this.light.outerConeAngle=e});Pw("falloffMode",Xl,function(e,t){this.light.falloffMode=e});Pw("shadowType",Yl,function(e,t){this.light.shadowType=e});Pw("vsmBlurSize",11,function(e,t){this.light.vsmBlurSize=e});Pw("vsmBlurMode",th,function(e,t){this.light.vsmBlurMode=e});Pw("vsmBias",.01*.25,function(e,t){this.light.vsmBias=e});Pw("cookieAsset",null,function(e,t){if(this._cookieAssetId&&(e instanceof O_&&e.id===this._cookieAssetId||e===this._cookieAssetId))return;this.onCookieAssetRemove();this._cookieAssetId=null;if(e instanceof O_){this.data.cookieAsset=e.id;this._cookieAssetId=e.id;this.onCookieAssetAdd(e)}else if(typeof e==="number"){this._cookieAssetId=e;var i=this.system.app.assets.get(e);if(i)this.onCookieAssetAdd(i);else{this._cookieAssetAdd=true;this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this)}}});Pw("cookie",null,function(e,t){this.light.cookie=e});Pw("cookieIntensity",1,function(e,t){this.light.cookieIntensity=e});Pw("cookieFalloff",true,function(e,t){this.light.cookieFalloff=e});Pw("cookieChannel","rgb",function(e,t){this.light.cookieChannel=e});Pw("cookieAngle",0,function(e,t){if(e!==0||this.cookieScale!==null){if(!this._cookieMatrix)this._cookieMatrix=new ue;var i=1;var n=1;if(this.cookieScale){i=this.cookieScale.x;n=this.cookieScale.y}var r=Math.cos(e*Pe.DEG_TO_RAD);var s=Math.sin(e*Pe.DEG_TO_RAD);this._cookieMatrix.set(r/i,-s/i,s/n,r/n);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});Pw("cookieScale",null,function(e,t){if(e!==null||this.cookieAngle!==0){if(!this._cookieMatrix)this._cookieMatrix=new ue;var i=e.x;var n=e.y;var r=Math.cos(this.cookieAngle*Pe.DEG_TO_RAD);var s=Math.sin(this.cookieAngle*Pe.DEG_TO_RAD);this._cookieMatrix.set(r/i,-s/i,s/n,r/n);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},true);Pw("cookieOffset",null,function(e,t){this.light.cookieOffset=e},true);Pw("shadowUpdateMode",rc,function(e,t){this.light.shadowUpdateMode=e});Pw("mask",1,function(e,t){this.light.mask=e});Pw("affectDynamic",true,function(e,t){if(e)this.light.mask|=oc;else this.light.mask&=~oc});Pw("affectLightmapped",false,function(e,t){if(e){this.light.mask|=lc;if(this.bake)this.light.mask&=~hc}else{this.light.mask&=~lc;if(this.bake)this.light.mask|=hc}});Pw("bake",false,function(e,t){if(e){this.light.mask|=hc;if(this.affectLightmapped)this.light.mask&=~lc}else{this.light.mask&=~hc;if(this.affectLightmapped)this.light.mask|=lc}});Pw("bakeDir",true,function(e,t){this.light.bakeDir=e});Pw("isStatic",false,function(e,t){this.light.isStatic=e});Pw("layers",[Dl],function(e,t){var i,n;for(i=0;i<t.length;i++){n=this.system.app.scene.layers.getLayerById(t[i]);if(!n)continue;n.removeLight(this)}for(i=0;i<e.length;i++){n=this.system.app.scene.layers.getLayerById(e[i]);if(!n)continue;if(this.enabled&&this.entity.enabled)n.addLight(this)}})}Ew();var Iw=function e(){var t=Mw;var i=Cw;var n;for(var r=0;r<t.length;r++){n=i[r];if(n&&n.clone)this[t[r]]=n.clone();else this[t[r]]=n}},Rw={directional:Nl,omni:zl,point:zl,spot:Ul},Lw=function(h){G(e,h);function e(e){var t;t=h.call(this,e)||this;t.id="light";t.ComponentType=Aw;t.DataType=Iw;t.on("beforeremove",t._onRemoveComponent,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i){var n=Mw;var r={};for(var s=0,a=n.length;s<a;s++){var o=n[s];r[o]=i[o]}if(!r.type)r.type=t.data.type;t.data.type=r.type;if(r.layers&&Array.isArray(r.layers))r.layers=r.layers.slice(0);if(r.color&&Array.isArray(r.color))r.color=new ge(r.color[0],r.color[1],r.color[2]);if(r.cookieOffset&&r.cookieOffset instanceof Array)r.cookieOffset=new he(r.cookieOffset[0],r.cookieOffset[1]);if(r.cookieScale&&r.cookieScale instanceof Array)r.cookieScale=new he(r.cookieScale[0],r.cookieScale[1]);if(r.enable){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");r.enabled=r.enable}var l=new Tw;l.type=Rw[r.type];l._node=t.entity;l._scene=this.app.scene;t.data.light=l;h.prototype.initializeComponentData.call(this,t,r,n)};t._onRemoveComponent=function e(t,i){i.onRemove()};t.cloneComponent=function e(t,i){var n=t.light;var r=[];var s;var a=Mw;for(var o=0;o<a.length;o++){s=a[o];if(s==="light")continue;if(n[s]&&n[s].clone)r[s]=n[s].clone();else r[s]=n[s]}this.addComponent(i,r)};t.changeType=function e(t,i,n){if(i!==n)t.light.type=Rw[n]};return e}(L0),Dw=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._type="asset";i._asset=null;i._model=null;i._mapping={};i._castShadows=true;i._receiveShadows=true;i._materialAsset=null;i._material=e.defaultMaterial;i._castShadowsLightmap=true;i._lightmapped=false;i._lightmapSizeMultiplier=1;i._isStatic=false;i._layers=[Dl];i._batchGroupId=-1;i._aabb=null;i._area=null;i._assetOld=0;i._materialEvents=null;i._dirtyModelAsset=false;i._dirtyMaterialAsset=false;i._clonedModel=false;t.on("remove",i.onRemoveChild,H(i));t.on("insert",i.onInsertChild,H(i));return i}var t=e.prototype;t.addModelToLayers=function e(){var t;var i=this.system.app.scene.layers;for(var n=0;n<this._layers.length;n++){t=i.getLayerById(this._layers[n]);if(!t)continue;t.addMeshInstances(this.meshInstances)}};t.removeModelFromLayers=function e(){var t;var i=this.system.app.scene.layers;for(var n=0;n<this._layers.length;n++){t=i.getLayerById(this._layers[n]);if(!t)continue;t.removeMeshInstances(this.meshInstances)}};t.onRemoveChild=function e(){if(this._model)this.removeModelFromLayers()};t.onInsertChild=function e(){if(this._model&&this.enabled&&this.entity.enabled)this.addModelToLayers()};t.onRemove=function e(){if(this.type==="asset")this.asset=null;else this.model=null;this.materialAsset=null;this._unsetMaterialEvents();this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",this.onInsertChild,this)};t.onLayersChanged=function e(t,i){this.addModelToLayers();t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.addMeshInstances(this.meshInstances)};t.onLayerRemoved=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.removeMeshInstances(this.meshInstances)};t._setMaterialEvent=function e(t,i,n,r){var s=i+":"+n;this.system.app.assets.on(s,r,this);if(!this._materialEvents)this._materialEvents=[];if(!this._materialEvents[t])this._materialEvents[t]={};this._materialEvents[t][s]={id:n,handler:r}};t._unsetMaterialEvents=function e(){var t=this.system.app.assets;var i=this._materialEvents;if(!i)return;for(var n=0,r=i.length;n<r;n++){if(!i[n])continue;var s=i[n];for(var a in s)t.off(a,s[a].handler,this)}this._materialEvents=null};t._getAssetByIdOrPath=function e(t){var i=null;var n=isNaN(parseInt(t,10));if(!n)i=this.system.app.assets.get(t);else if(this.asset){var r=this._getMaterialAssetUrl(t);if(r)i=this.system.app.assets.getByUrl(r)}return i};t._getMaterialAssetUrl=function e(t){if(!this.asset)return null;var i=this.system.app.assets.get(this.asset);return i?i.getAbsoluteUrl(t):null};t._loadAndSetMeshInstanceMaterial=function e(t,i,n){var r=this.system.app.assets;if(!t)return;if(t.resource){i.material=t.resource;this._setMaterialEvent(n,"remove",t.id,function(){i.material=this.system.defaultMaterial})}else{this._setMaterialEvent(n,"load",t.id,function(e){i.material=e.resource;this._setMaterialEvent(n,"remove",t.id,function(){i.material=this.system.defaultMaterial})});if(this.enabled&&this.entity.enabled)r.load(t)}};t.onEnable=function e(){var t=this.system.app;var i=t.scene;i.on("set:layers",this.onLayersChanged,this);if(i.layers){i.layers.on("add",this.onLayerAdded,this);i.layers.on("remove",this.onLayerRemoved,this)}var n=this._type==="asset";var r;if(this._model)this.addModelToLayers();else if(n&&this._asset){r=t.assets.get(this._asset);if(r&&r.resource!==this._model)this._bindModelAsset(r)}if(this._materialAsset){r=t.assets.get(this._materialAsset);if(r&&r.resource!==this._material)this._bindMaterialAsset(r)}if(n)if(this._mapping)for(var s in this._mapping)if(this._mapping[s]){r=this._getAssetByIdOrPath(this._mapping[s]);if(r&&!r.resource)t.assets.load(r)}if(this._batchGroupId>=0)t.batcher.insert(Yu.MODEL,this.batchGroupId,this.entity)};t.onDisable=function e(){var t=this.system.app;var i=t.scene;i.off("set:layers",this.onLayersChanged,this);if(i.layers){i.layers.off("add",this.onLayerAdded,this);i.layers.off("remove",this.onLayerRemoved,this)}if(this._batchGroupId>=0)t.batcher.remove(Yu.MODEL,this.batchGroupId,this.entity);if(this._model)this.removeModelFromLayers()};t.hide=function e(){if(this._model){var t,i;var n=this._model.meshInstances;for(t=0,i=n.length;t<i;t++)n[t].visible=false}};t.show=function e(){if(this._model){var t,i;var n=this._model.meshInstances;for(t=0,i=n.length;t<i;t++)n[t].visible=true}};t._bindMaterialAsset=function e(t){t.on("load",this._onMaterialAssetLoad,this);t.on("unload",this._onMaterialAssetUnload,this);t.on("remove",this._onMaterialAssetRemove,this);t.on("change",this._onMaterialAssetChange,this);if(t.resource)this._onMaterialAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}};t._unbindMaterialAsset=function e(t){t.off("load",this._onMaterialAssetLoad,this);t.off("unload",this._onMaterialAssetUnload,this);t.off("remove",this._onMaterialAssetRemove,this);t.off("change",this._onMaterialAssetChange,this)};t._onMaterialAssetAdd=function e(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this);if(this._materialAsset===t.id)this._bindMaterialAsset(t)};t._onMaterialAssetLoad=function e(t){this._setMaterial(t.resource)};t._onMaterialAssetUnload=function e(t){this._setMaterial(this.system.defaultMaterial)};t._onMaterialAssetRemove=function e(t){this._onMaterialAssetUnload(t)};t._onMaterialAssetChange=function e(t){};t._bindModelAsset=function e(t){this._unbindModelAsset(t);t.on("load",this._onModelAssetLoad,this);t.on("unload",this._onModelAssetUnload,this);t.on("change",this._onModelAssetChange,this);t.on("remove",this._onModelAssetRemove,this);if(t.resource)this._onModelAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}};t._unbindModelAsset=function e(t){t.off("load",this._onModelAssetLoad,this);t.off("unload",this._onModelAssetUnload,this);t.off("change",this._onModelAssetChange,this);t.off("remove",this._onModelAssetRemove,this)};t._onModelAssetAdded=function e(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdded,this);if(t.id===this._asset)this._bindModelAsset(t)};t._onModelAssetLoad=function e(t){this.model=t.resource.clone();this._clonedModel=true};t._onModelAssetUnload=function e(t){this.model=null};t._onModelAssetChange=function e(t,i,n,r){if(i==="data")this.mapping=this._mapping};t._onModelAssetRemove=function e(t){this.model=null};t._setMaterial=function e(t){if(this._material===t)return;this._material=t;var i=this._model;if(i&&this._type!=="asset"){var n=i.meshInstances;for(var r=0,s=n.length;r<s;r++)n[r].material=t}};U(e,[{key:"meshInstances",get:function e(){if(!this._model)return null;return this._model.meshInstances},set:function e(t){if(!this._model)return;this._model.meshInstances=t}},{key:"aabb",get:function e(){return this._aabb},set:function e(t){this._aabb=t;var i=this._model.meshInstances;if(i)for(var n=0;n<i.length;n++)i[n].setOverrideAabb(this._aabb)}},{key:"type",get:function e(){return this._type},set:function e(t){if(this._type===t)return;this._area=null;this._type=t;if(t==="asset")if(this._asset!==null)this._bindModelAsset(this._asset);else this.model=null;else{var i=Dm(this.system.app.graphicsDevice,t);this._area=i.area;var n=i.mesh;var r=new Mf;var s=new Xu;s.graph=r;s.meshInstances=[new zu(r,n,this._material)];if(this.system._inTools)s.generateWireframe();this.model=s;this._asset=null}}},{key:"asset",get:function e(){return this._asset},set:function e(t){var i=this.system.app.assets;var n=t;if(t instanceof O_)n=t.id;if(this._asset!==n){if(this._asset){i.off("add:"+this._asset,this._onModelAssetAdded,this);var r=i.get(this._asset);if(r)this._unbindModelAsset(r)}this._asset=n;if(this._asset){var s=i.get(this._asset);if(!s){this.model=null;i.on("add:"+this._asset,this._onModelAssetAdded,this)}else this._bindModelAsset(s)}else this.model=null}}},{key:"model",get:function e(){return this._model},set:function e(t){var i;if(this._model===t)return;if(t&&t._immutable)return;if(this._model){this._model._immutable=false;this.removeModelFromLayers();this.entity.removeChild(this._model.getGraph());delete this._model._entity;if(this._clonedModel){this._model.destroy();this._clonedModel=false}}this._model=t;if(this._model){this._model._immutable=true;var n=this._model.meshInstances;for(i=0;i<n.length;i++){n[i].castShadow=this._castShadows;n[i].receiveShadow=this._receiveShadows;n[i].isStatic=this._isStatic;n[i].setOverrideAabb(this._aabb)}this.lightmapped=this._lightmapped;this.entity.addChild(this._model.graph);if(this.enabled&&this.entity.enabled)this.addModelToLayers();this._model._entity=this.entity;if(this.entity.animation)this.entity.animation.setModel(this._model);if(this.entity.anim)this.entity.anim.resetStateGraph();if(this.type==="asset")this.mapping=this._mapping;else this._unsetMaterialEvents()}}},{key:"lightmapped",get:function e(){return this._lightmapped},set:function e(t){if(t!==this._lightmapped){this._lightmapped=t;if(this._model){var i=this._model.meshInstances;for(var n=0;n<i.length;n++)i[n].setLightmapped(t)}}}},{key:"castShadows",get:function e(){return this._castShadows},set:function e(t){if(this._castShadows===t)return;var i;var n;var r=this._model;if(r){var s=this.layers;var a=this.system.app.scene;if(this._castShadows&&!t)for(n=0;n<s.length;n++){i=this.system.app.scene.layers.getLayerById(this.layers[n]);if(!i)continue;i.removeShadowCasters(r.meshInstances)}var o=r.meshInstances;for(n=0;n<o.length;n++)o[n].castShadow=t;if(!this._castShadows&&t)for(n=0;n<s.length;n++){i=a.layers.getLayerById(s[n]);if(!i)continue;i.addShadowCasters(r.meshInstances)}}this._castShadows=t}},{key:"receiveShadows",get:function e(){return this._receiveShadows},set:function e(t){if(this._receiveShadows===t)return;this._receiveShadows=t;if(this._model){var i=this._model.meshInstances;for(var n=0,r=i.length;n<r;n++)i[n].receiveShadow=t}}},{key:"castShadowsLightmap",get:function e(){return this._castShadowsLightmap},set:function e(t){this._castShadowsLightmap=t}},{key:"lightmapSizeMultiplier",get:function e(){return this._lightmapSizeMultiplier},set:function e(t){this._lightmapSizeMultiplier=t}},{key:"isStatic",get:function e(){return this._isStatic},set:function e(t){if(this._isStatic===t)return;this._isStatic=t;var i,n;if(this._model){var r=this._model.meshInstances;for(i=0;i<r.length;i++){n=r[i];n.isStatic=t}}}},{key:"layers",get:function e(){return this._layers},set:function e(t){var i,n;var r=this.system.app.scene.layers;if(this.meshInstances)for(i=0;i<this._layers.length;i++){n=r.getLayerById(this._layers[i]);if(!n)continue;n.removeMeshInstances(this.meshInstances)}this._layers.length=0;for(i=0;i<t.length;i++)this._layers[i]=t[i];if(!this.enabled||!this.entity.enabled||!this.meshInstances)return;for(i=0;i<this._layers.length;i++){n=r.getLayerById(this._layers[i]);if(!n)continue;n.addMeshInstances(this.meshInstances)}}},{key:"batchGroupId",get:function e(){return this._batchGroupId},set:function e(t){if(this._batchGroupId===t)return;var i=this.system.app.batcher;if(this.entity.enabled&&this._batchGroupId>=0)i.remove(Yu.MODEL,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)i.insert(Yu.MODEL,t,this.entity);if(t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled)this.addModelToLayers();this._batchGroupId=t}},{key:"materialAsset",get:function e(){return this._materialAsset},set:function e(t){var i=t;if(t instanceof O_)i=t.id;var n=this.system.app.assets;if(i!==this._materialAsset){if(this._materialAsset){n.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var r=n.get(this._materialAsset);if(r)this._unbindMaterialAsset(r)}this._materialAsset=i;if(this._materialAsset){var s=n.get(this._materialAsset);if(!s){this._setMaterial(this.system.defaultMaterial);n.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)}else this._bindMaterialAsset(s)}else this._setMaterial(this.system.defaultMaterial)}}},{key:"material",get:function e(){return this._material},set:function e(t){if(this._material===t)return;this.materialAsset=null;this._setMaterial(t)}},{key:"mapping",get:function e(){return this._mapping},set:function e(t){if(this._type!=="asset")return;this._unsetMaterialEvents();if(!t)t={};this._mapping=t;if(!this._model)return;var i=this._model.meshInstances;var n=this.asset?this.system.app.assets.get(this.asset):null;var r=n?n.data.mapping:null;var s=null;for(var a=0,o=i.length;a<o;a++)if(t[a]!==undefined)if(t[a]){s=this.system.app.assets.get(t[a]);this._loadAndSetMeshInstanceMaterial(s,i[a],a)}else i[a].material=this.system.defaultMaterial;else if(r)if(r[a]&&(r[a].material||r[a].path)){if(r[a].material!==undefined)s=this.system.app.assets.get(r[a].material);else if(r[a].path!==undefined){var l=this._getMaterialAssetUrl(r[a].path);if(l)s=this.system.app.assets.getByUrl(l)}this._loadAndSetMeshInstanceMaterial(s,i[a],a)}else i[a].material=this.system.defaultMaterial}}]);return e}(R0),kw=function e(){this.enabled=true},Ow=["enabled"],Fw=function(s){G(e,s);function e(e){var t;t=s.call(this,e)||this;t.id="model";t.ComponentType=Dw;t.DataType=kw;t.schema=Ow;t.defaultMaterial=e.scene.defaultMaterial;t.on("beforeremove",t.onRemove,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["material","materialAsset","asset","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","mapping","layers","isStatic","batchGroupId"];if(i.batchGroupId===null||i.batchGroupId===undefined)i.batchGroupId=-1;if(i.layers&&i.layers.length)i.layers=i.layers.slice(0);for(var r=0;r<n.length;r++)if(i.hasOwnProperty(n[r]))t[n[r]]=i[n[r]];s.prototype.initializeComponentData.call(this,t,i,["enabled"])};t.cloneComponent=function e(t,i){var n={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:_({},t.model.mapping)};var r=t.model.materialAsset;if(!(r instanceof O_)&&r!=null)r=this.app.assets.get(r);var s=t.model.material;if(!s||s===this.defaultMaterial||!r||s===r.resource)n.materialAsset=r;var a=this.addComponent(i,n);if(t.model.model&&t.model.type==="asset"&&!t.model.asset){a.model=t.model.model.clone();a._clonedModel=true}if(!n.materialAsset)a.material=s;if(t.model.model){var o=t.model.model.meshInstances;var l=a.model.meshInstances;for(var h=0;h<o.length;h++){l[h].mask=o[h].mask;l[h].material=o[h].material;l[h].layer=o[h].layer;l[h].receiveShadow=o[h].receiveShadow}}};t.onRemove=function e(t,i){i.onRemove()};return e}(L0);R0._buildAccessors(Dw.prototype,Ow);var Bw=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._type="asset";i._castShadows=true;i._receiveShadows=true;i._castShadowsLightmap=true;i._lightmapped=false;i._lightmapSizeMultiplier=1;i._isStatic=false;i._batchGroupId=-1;i._meshInstances=[];i._layers=[Dl];i._aabb=null;i._area=null;i._rootBone=new Ub(H(i),"rootBone");i._rootBone.on("set:entity",i._onSetRootBone,H(i));i._assetReference=new cg("asset",H(i),e.app.assets,{add:i._onRenderAssetAdded,load:i._onRenderAssetLoad,remove:i._onRenderAssetRemove,unload:i._onRenderAssetUnload},H(i));i._material=e.defaultMaterial;i._materialReferences=[];t.on("remove",i.onRemoveChild,H(i));t.on("insert",i.onInsertChild,H(i));return i}var t=e.prototype;t._onSetRootBone=function e(t){if(t)this._onRootBoneChanged()};t._onRootBoneChanged=function e(){this._clearSkinInstances();this._cloneSkinInstances()};t.destroyMeshInstances=function e(){var t=this._meshInstances;if(t){this.removeFromLayers();for(var i=0;i<t.length;i++)t[i].destroy();this._meshInstances.length=0}};t.addToLayers=function e(){var t,i=this.system.app.scene.layers;for(var n=0;n<this._layers.length;n++){t=i.getLayerById(this._layers[n]);if(t)t.addMeshInstances(this._meshInstances)}};t.removeFromLayers=function e(){if(this._meshInstances&&this._meshInstances.length){var t,i=this.system.app.scene.layers;for(var n=0;n<this._layers.length;n++){t=i.getLayerById(this._layers[n]);if(t)t.removeMeshInstances(this._meshInstances)}}};t.onRemoveChild=function e(){this.removeFromLayers()};t.onInsertChild=function e(){if(this._meshInstances&&this.enabled&&this.entity.enabled)this.addToLayers()};t.onRemove=function e(){this.destroyMeshInstances();this.asset=null;this.materialAsset=null;this.entity.off("remove",this.onRemoveChild,this);this.entity.off("insert",this.onInsertChild,this)};t.onLayersChanged=function e(t,i){this.addToLayers();t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.addMeshInstances(this._meshInstances)};t.onLayerRemoved=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;t.removeMeshInstances(this._meshInstances)};t.onEnable=function e(){var t=this.system.app;var i=t.scene;this._rootBone.onParentComponentEnable();i.on("set:layers",this.onLayersChanged,this);if(i.layers){i.layers.on("add",this.onLayerAdded,this);i.layers.on("remove",this.onLayerRemoved,this)}var n=this._type==="asset";if(this._meshInstances&&this._meshInstances.length)this.addToLayers();else if(n&&this.asset)this._onRenderAssetAdded();for(var r=0;r<this._materialReferences.length;r++)if(this._materialReferences[r].asset)this.system.app.assets.load(this._materialReferences[r].asset);if(this._batchGroupId>=0)t.batcher.insert(Yu.RENDER,this.batchGroupId,this.entity)};t.onDisable=function e(){var t=this.system.app;var i=t.scene;i.off("set:layers",this.onLayersChanged,this);if(i.layers){i.layers.off("add",this.onLayerAdded,this);i.layers.off("remove",this.onLayerRemoved,this)}if(this._batchGroupId>=0)t.batcher.remove(Yu.RENDER,this.batchGroupId,this.entity);this.removeFromLayers()};t.hide=function e(){if(this._meshInstances)for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=false};t.show=function e(){if(this._meshInstances)for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].visible=true};t._onRenderAssetAdded=function e(){if(!this._assetReference.asset)return;if(this._assetReference.asset.resource)this._onRenderAssetLoad();else if(this.enabled&&this.entity.enabled)this.system.app.assets.load(this._assetReference.asset)};t._onRenderAssetLoad=function e(){this.destroyMeshInstances();if(this._assetReference.asset){var t=this._assetReference.asset.resource;t.off("set:meshes",this._onSetMeshes,this);t.on("set:meshes",this._onSetMeshes,this);if(t.meshes)this._onSetMeshes(t.meshes)}};t._onSetMeshes=function e(t){this._cloneMeshes(t)};t._clearSkinInstances=function e(){for(var t=0;t<this._meshInstances.length;t++)this._meshInstances[t].skinInstance=null};t._cloneSkinInstances=function e(){if(this._meshInstances.length&&this._rootBone.entity instanceof Mf){var t,i,n;var r=new Map;for(var s=0;s<this._meshInstances.length;s++){var a=this._meshInstances[s];var o=a.mesh;if(o.skin&&!o.skinInstance){i=o.skin;n=r.get(i);if(!n){n=new ju(i);r.set(i,n);var l=[];for(t=0;t<i.boneNames.length;t++){var h=i.boneNames[t];var c=this._rootBone.entity.findByName(h);if(!c){console.error("Failed to find bone ["+h+"] in the entity hierarchy, RenderComponent on "+this.entity.name+", rootBone: "+this._rootBone.entity.name);c=this.entity}l.push(c)}n.bones=l}a.skinInstance=n}}}};t._cloneMeshes=function e(t){if(t&&t.length){var i=[];for(var n=0;n<t.length;n++){var r=t[n];var s=this._materialReferences[n]&&this._materialReferences[n].asset&&this._materialReferences[n].asset.resource;var a=new zu(this.entity,r,s||this.system.defaultMaterial);i.push(a);if(r.morph)a.morphInstance=new Hu(r.morph)}this.meshInstances=i;this._cloneSkinInstances()}};t._onRenderAssetUnload=function e(){if(this._type==="asset")this.destroyMeshInstances()};t._onRenderAssetRemove=function e(){if(this._assetReference.asset&&this._assetReference.asset.resource)this._assetReference.asset.resource.off("set:meshes",this._onSetMeshes,this);this._onRenderAssetUnload()};t._onMaterialAdded=function e(t,i,n){if(n.resource)this._onMaterialLoad(t,i,n);else if(this.enabled&&this.entity.enabled)this.system.app.assets.load(n)};t._onMaterialLoad=function e(t,i,n){if(this._meshInstances[t])this._meshInstances[t].material=n.resource};t._onMaterialRemove=function e(t,i,n){if(this._meshInstances[t])this._meshInstances[t].material=this.system.defaultMaterial};t._onMaterialUnload=function e(t,i,n){if(this._meshInstances[t])this._meshInstances[t].material=this.system.defaultMaterial};t.generateWireframe=function e(){var t,i,n=[];for(t=0;t<this._meshInstances.length;t++){i=this._meshInstances[t].mesh;if(n.indexOf(i)===-1)n.push(i)}for(t=0;t<n.length;++t){i=n[t];if(!i.primitive[_h])i.generateWireframe()}};U(e,[{key:"aabb",get:function e(){return this._aabb},set:function e(t){this._aabb=t;var i=this._meshInstances;if(i)for(var n=0;n<i.length;n++)i[n].setOverrideAabb(this._aabb)}},{key:"type",get:function e(){return this._type},set:function e(t){if(this._type!==t){this._area=null;this._type=t;this.destroyMeshInstances();if(t!=="asset"){var i=this._material;if(!i||i===this.system.defaultMaterial)i=this._materialReferences[0]&&this._materialReferences[0].asset&&this._materialReferences[0].asset.resource;var n=Dm(this.system.app.graphicsDevice,t);this._area=n.area;this.meshInstances=[new zu(this.entity,n.mesh,i||this.system.defaultMaterial)];if(this.system._inTools)this.generateWireframe()}}}},{key:"meshInstances",get:function e(){return this._meshInstances},set:function e(t){this.destroyMeshInstances();this._meshInstances=t;if(this._meshInstances){var i=this._meshInstances;for(var n=0;n<i.length;n++){i[n].castShadow=this._castShadows;i[n].receiveShadow=this._receiveShadows;i[n].isStatic=this._isStatic;i[n].setLightmapped(this._lightmapped);i[n].setOverrideAabb(this._aabb)}if(this.enabled&&this.entity.enabled)this.addToLayers()}}},{key:"lightmapped",get:function e(){return this._lightmapped},set:function e(t){if(t!==this._lightmapped){this._lightmapped=t;var i=this._meshInstances;if(i)for(var n=0;n<i.length;n++)i[n].setLightmapped(t)}}},{key:"castShadows",get:function e(){return this._castShadows},set:function e(t){if(this._castShadows!==t){var i,n,r=this._meshInstances;if(r){var s=this.layers;var a=this.system.app.scene;if(this._castShadows&&!t)for(i=0;i<s.length;i++){n=a.layers.getLayerById(this.layers[i]);if(n)n.removeShadowCasters(r)}for(i=0;i<r.length;i++)r[i].castShadow=t;if(!this._castShadows&&t)for(i=0;i<s.length;i++){n=a.layers.getLayerById(s[i]);if(n)n.addShadowCasters(r)}}this._castShadows=t}}},{key:"receiveShadows",get:function e(){return this._receiveShadows},set:function e(t){if(this._receiveShadows!==t){this._receiveShadows=t;var i=this._meshInstances;if(i)for(var n=0;n<i.length;n++)i[n].receiveShadow=t}}},{key:"castShadowsLightmap",get:function e(){return this._castShadowsLightmap},set:function e(t){this._castShadowsLightmap=t}},{key:"lightmapSizeMultiplier",get:function e(){return this._lightmapSizeMultiplier},set:function e(t){this._lightmapSizeMultiplier=t}},{key:"isStatic",get:function e(){return this._isStatic},set:function e(t){if(this._isStatic!==t){this._isStatic=t;var i=this._meshInstances;if(i)for(var n=0;n<i.length;n++)i[n].isStatic=t}}},{key:"layers",get:function e(){return this._layers},set:function e(t){var i,n,r=this.system.app.scene.layers;if(this._meshInstances)for(i=0;i<this._layers.length;i++){n=r.getLayerById(this._layers[i]);if(n)n.removeMeshInstances(this._meshInstances)}this._layers.length=0;for(i=0;i<t.length;i++)this._layers[i]=t[i];if(!this.enabled||!this.entity.enabled||!this._meshInstances)return;for(i=0;i<this._layers.length;i++){n=r.getLayerById(this._layers[i]);if(n)n.addMeshInstances(this._meshInstances)}}},{key:"batchGroupId",get:function e(){return this._batchGroupId},set:function e(t){if(this._batchGroupId!==t){var i=this.system.app.batcher;if(this.entity.enabled&&this._batchGroupId>=0)i.remove(Yu.RENDER,this.batchGroupId,this.entity);if(this.entity.enabled&&t>=0)i.insert(Yu.RENDER,t,this.entity);if(t<0&&this._batchGroupId>=0&&this.enabled&&this.entity.enabled)this.addToLayers();this._batchGroupId=t}}},{key:"material",get:function e(){return this._material},set:function e(t){if(this._material!==t){this._material=t;if(this._meshInstances&&this._type!=="asset")for(var i=0;i<this._meshInstances.length;i++)this._meshInstances[i].material=t}}},{key:"materialAssets",get:function e(){return this._materialReferences.map(function(e){return e.id})},set:function e(t){var i;t=t||[];if(this._materialReferences.length>t.length){for(i=t.length;i<this._materialReferences.length;i++)this._materialReferences[i].id=null;this._materialReferences.length=t.length}for(i=0;i<t.length;i++){if(!this._materialReferences[i])this._materialReferences.push(new cg(i,this,this.system.app.assets,{add:this._onMaterialAdded,load:this._onMaterialLoad,remove:this._onMaterialRemove,unload:this._onMaterialUnload},this));if(t[i]){var n=t[i]instanceof O_?t[i].id:t[i];if(this._materialReferences[i].id!==n)this._materialReferences[i].id=n;if(this._materialReferences[i].asset)this._onMaterialAdded(i,this,this._materialReferences[i].asset)}else{this._materialReferences[i].id=null;if(this._meshInstances[i])this._meshInstances[i].material=this.system.defaultMaterial}}}},{key:"asset",get:function e(){return this._assetReference.id},set:function e(t){var i=t instanceof O_?t.id:t;if(this._assetReference.id===i)return;if(this._assetReference.asset&&this._assetReference.asset.resource)this._onRenderAssetRemove();this._assetReference.id=i;if(this._assetReference.asset)this._onRenderAssetAdded()}}]);return e}(R0),Nw=function e(){this.enabled=true;this.rootBone=null},zw=[{name:"rootBone",type:"entity"},"enabled"],Vw=["material","asset","materialAssets","castShadows","receiveShadows","castShadowsLightmap","lightmapped","lightmapSizeMultiplier","type","layers","isStatic","batchGroupId"],Uw=function(s){G(e,s);function e(e){var t;t=s.call(this,e)||this;t.id="render";t.ComponentType=Bw;t.DataType=Nw;t.schema=zw;t.defaultMaterial=e.scene.defaultMaterial;t.on("beforeremove",t.onRemove,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){if(i.batchGroupId===null||i.batchGroupId===undefined)i.batchGroupId=-1;if(i.layers&&i.layers.length)i.layers=i.layers.slice(0);for(var r=0;r<Vw.length;r++)if(i.hasOwnProperty(Vw[r]))t[Vw[r]]=i[Vw[r]];s.prototype.initializeComponentData.call(this,t,i,zw)};t.cloneComponent=function e(t,i){var n;var r={};for(n=0;n<Vw.length;n++)r[Vw[n]]=t.render[Vw[n]];var s=this.addComponent(i,r);if(t.render){var a=t.render.meshInstances;var o=s.meshInstances;for(n=0;n<a.length&&n<o.length;n++){o[n].mask=a[n].mask;o[n].material=a[n].material;o[n].layer=a[n].layer;o[n].receiveShadow=a[n].receiveShadow}}};t.onRemove=function e(t,i){i.onRemove()};return e}(L0);R0._buildAccessors(Bw.prototype,zw);var Gw=["emitterExtents","emitterRadius","emitterExtentsInner","emitterRadiusInner","loop","initialVelocity","animSpeed","normalMap","particleNormal"],Hw=["numParticles","lifetime","rate","rate2","startAngle","startAngle2","lighting","halfLambert","intensity","wrap","wrapBounds","depthWrite","noFog","sort","stretch","alignToMotion","preWarm","emitterShape","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animLoop","colorMap","localSpace","screenSpace","orientation"],Ww=["scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","velocityGraph","velocityGraph2","localVelocityGraph","localVelocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2"],jw=["colorMapAsset","normalMapAsset","meshAsset"],Xw,qw=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i.on("set_colorMapAsset",i.onSetColorMapAsset,H(i));i.on("set_normalMapAsset",i.onSetNormalMapAsset,H(i));i.on("set_meshAsset",i.onSetMeshAsset,H(i));i.on("set_mesh",i.onSetMesh,H(i));i.on("set_loop",i.onSetLoop,H(i));i.on("set_blendType",i.onSetBlendType,H(i));i.on("set_depthSoftening",i.onSetDepthSoftening,H(i));i.on("set_layers",i.onSetLayers,H(i));Gw.forEach(function(e){this.on("set_"+e,this.onSetSimpleProperty,this)}.bind(H(i)));Hw.forEach(function(e){this.on("set_"+e,this.onSetComplexProperty,this)}.bind(H(i)));Ww.forEach(function(e){this.on("set_"+e,this.onSetGraphProperty,this)}.bind(H(i)));i._requestedDepth=false;i._drawOrder=0;return i}var t=e.prototype;t.addModelToLayers=function e(){if(!this.data.model)return;var t;for(var i=0;i<this.layers.length;i++){t=this.system.app.scene.layers.getLayerById(this.layers[i]);if(!t)continue;t.addMeshInstances(this.data.model.meshInstances);this.emitter._layer=t}};t.removeModelFromLayers=function e(t){if(!this.data.model)return;var i;for(var n=0;n<this.layers.length;n++){i=this.system.app.scene.layers.getLayerById(this.layers[n]);if(!i)continue;i.removeMeshInstances(this.data.model.meshInstances)}};t.onSetLayers=function e(t,i,n){if(!this.data.model)return;var r,s;for(r=0;r<i.length;r++){s=this.system.app.scene.layers.getLayerById(i[r]);if(!s)continue;s.removeMeshInstances(this.data.model.meshInstances)}if(!this.enabled||!this.entity.enabled)return;for(r=0;r<n.length;r++){s=this.system.app.scene.layers.getLayerById(n[r]);if(!s)continue;s.addMeshInstances(this.data.model.meshInstances)}};t.onLayersChanged=function e(t,i){this.addModelToLayers();t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this)};t.onLayerAdded=function e(t){if(!this.data.model)return;var i=this.layers.indexOf(t.id);if(i<0)return;t.addMeshInstances(this.data.model.meshInstances)};t.onLayerRemoved=function e(t){if(!this.data.model)return;var i=this.layers.indexOf(t.id);if(i<0)return;t.removeMeshInstances(this.data.model.meshInstances)};t._bindColorMapAsset=function e(t){t.on("load",this._onColorMapAssetLoad,this);t.on("unload",this._onColorMapAssetUnload,this);t.on("remove",this._onColorMapAssetRemove,this);t.on("change",this._onColorMapAssetChange,this);if(t.resource)this._onColorMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}};t._unbindColorMapAsset=function e(t){t.off("load",this._onColorMapAssetLoad,this);t.off("unload",this._onColorMapAssetUnload,this);t.off("remove",this._onColorMapAssetRemove,this);t.off("change",this._onColorMapAssetChange,this)};t._onColorMapAssetLoad=function e(t){this.colorMap=t.resource};t._onColorMapAssetUnload=function e(t){this.colorMap=null};t._onColorMapAssetRemove=function e(t){this._onColorMapAssetUnload(t)};t._onColorMapAssetChange=function e(t){};t.onSetColorMapAsset=function e(t,i,n){var r=this;var s;var a=this.system.app.assets;if(i){s=a.get(i);if(s)this._unbindColorMapAsset(s)}if(n){if(n instanceof O_){this.data.colorMapAsset=n.id;n=n.id}s=a.get(n);if(s)r._bindColorMapAsset(s);else a.once("add:"+n,function(e){r._bindColorMapAsset(e)})}else this.colorMap=null};t._bindNormalMapAsset=function e(t){t.on("load",this._onNormalMapAssetLoad,this);t.on("unload",this._onNormalMapAssetUnload,this);t.on("remove",this._onNormalMapAssetRemove,this);t.on("change",this._onNormalMapAssetChange,this);if(t.resource)this._onNormalMapAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}};t._unbindNormalMapAsset=function e(t){t.off("load",this._onNormalMapAssetLoad,this);t.off("unload",this._onNormalMapAssetUnload,this);t.off("remove",this._onNormalMapAssetRemove,this);t.off("change",this._onNormalMapAssetChange,this)};t._onNormalMapAssetLoad=function e(t){this.normalMap=t.resource};t._onNormalMapAssetUnload=function e(t){this.normalMap=null};t._onNormalMapAssetRemove=function e(t){this._onNormalMapAssetUnload(t)};t._onNormalMapAssetChange=function e(t){};t.onSetNormalMapAsset=function e(t,i,n){var r=this;var s;var a=this.system.app.assets;if(i){s=a.get(i);if(s)this._unbindNormalMapAsset(s)}if(n){if(n instanceof O_){this.data.normalMapAsset=n.id;n=n.id}s=a.get(n);if(s)r._bindNormalMapAsset(s);else a.once("add:"+n,function(e){r._bindNormalMapAsset(e)})}else this.normalMap=null};t._bindMeshAsset=function e(t){t.on("load",this._onMeshAssetLoad,this);t.on("unload",this._onMeshAssetUnload,this);t.on("remove",this._onMeshAssetRemove,this);t.on("change",this._onMeshAssetChange,this);if(t.resource)this._onMeshAssetLoad(t);else{if(!this.enabled||!this.entity.enabled)return;this.system.app.assets.load(t)}};t._unbindMeshAsset=function e(t){t.off("load",this._onMeshAssetLoad,this);t.off("unload",this._onMeshAssetUnload,this);t.off("remove",this._onMeshAssetRemove,this);t.off("change",this._onMeshAssetChange,this)};t._onMeshAssetLoad=function e(t){this._onMeshChanged(t.resource)};t._onMeshAssetUnload=function e(t){this.mesh=null};t._onMeshAssetRemove=function e(t){this._onMeshAssetUnload(t)};t._onMeshAssetChange=function e(t){};t.onSetMeshAsset=function e(t,i,n){var r;var s=this.system.app.assets;if(i){r=s.get(i);if(r)this._unbindMeshAsset(r)}if(n){if(n instanceof O_){this.data.meshAsset=n.id;n=n.id}r=s.get(n);if(r){this._bindMeshAsset(r);if(r.resource)this._onMeshChanged(r.resource);else s.load(r)}}else this._onMeshChanged(null)};t.onSetMesh=function e(t,i,n){if(!n||n instanceof O_||typeof n==="number")this.meshAsset=n;else this._onMeshChanged(n)};t._onMeshChanged=function e(t){if(t&&!(t instanceof Du))if(t.meshInstances[0])t=t.meshInstances[0].mesh;else t=null;this.data.mesh=t;if(this.emitter){this.emitter.mesh=t;this.emitter.resetMaterial();this.rebuild()}};t.onSetLoop=function e(t,i,n){if(this.emitter){this.emitter[t]=n;this.emitter.resetTime()}};t.onSetBlendType=function e(t,i,n){if(this.emitter){this.emitter[t]=n;this.emitter.material.blendType=n;this.emitter.resetMaterial();this.rebuild()}};t._requestDepth=function e(){if(this._requestedDepth)return;if(!Xw)Xw=this.system.app.scene.layers.getLayerById(kl);if(Xw){Xw.incrementCounter();this._requestedDepth=true}};t._releaseDepth=function e(){if(!this._requestedDepth)return;if(Xw){Xw.decrementCounter();this._requestedDepth=false}};t.onSetDepthSoftening=function e(t,i,n){if(i!==n){if(n){if(this.enabled&&this.entity.enabled)this._requestDepth();if(this.emitter)this.emitter[t]=n}else{if(this.enabled&&this.entity.enabled)this._releaseDepth();if(this.emitter)this.emitter[t]=n}if(this.emitter){this.reset();this.emitter.resetMaterial();this.rebuild()}}};t.onSetSimpleProperty=function e(t,i,n){if(this.emitter){this.emitter[t]=n;this.emitter.resetMaterial()}};t.onSetComplexProperty=function e(t,i,n){if(this.emitter){this.emitter[t]=n;this.emitter.resetMaterial();this.rebuild();this.reset()}};t.onSetGraphProperty=function e(t,i,n){if(this.emitter){this.emitter[t]=n;this.emitter.rebuildGraphs();this.emitter.resetMaterial()}};t.onEnable=function e(){var t=this.data;for(var i=0,n=jw.length;i<n;i++){var r=t[jw[i]];if(r){if(!(r instanceof O_)){var s=parseInt(r,10);if(s>=0)r=this.system.app.assets.get(r);else continue}if(r&&!r.resource)this.system.app.assets.load(r)}}if(!this.emitter){var a=t.mesh;if(!(a instanceof Du))a=null;this.emitter=new gm(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:a,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType});this.emitter.meshInstance.node=this.entity;this.emitter.drawOrder=this.drawOrder;this.psys=new Xu;this.psys.graph=this.entity;this.psys.emitter=this.emitter;this.psys.meshInstances=[this.emitter.meshInstance];t.model=this.psys;this.emitter.psys=this.psys;if(!t.autoPlay){this.pause();this.emitter.meshInstance.visible=false}}if(t.model&&this.emitter.colorMap)this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.on("add",this.onLayerAdded,this);this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)}if(this.enabled&&this.entity.enabled&&t.depthSoftening)this._requestDepth()};t.onDisable=function e(){this.system.app.scene.off("set:layers",this.onLayersChanged,this);if(this.system.app.scene.layers){this.system.app.scene.layers.off("add",this.onLayerAdded,this);this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)}if(this.data.model){this.removeModelFromLayers();if(this.data.depthSoftening)this._releaseDepth()}if(this.emitter)this.emitter.camera=null};t.onBeforeRemove=function e(){if(this.enabled)this.enabled=false;var t=this.data;if(t.model){this.entity.removeChild(t.model.getGraph());t.model.destroy();t.model=null}if(this.emitter){this.emitter.destroy();this.emitter=null}for(var i=0;i<jw.length;i++){var n=jw[i];if(t[n])this[n]=null}this.off()};t.reset=function e(){if(this.emitter)this.emitter.reset()};t.stop=function e(){if(this.emitter){this.emitter.loop=false;this.emitter.resetTime();this.emitter.addTime(0,true)}};t.pause=function e(){this.data.paused=true};t.unpause=function e(){this.data.paused=false};t.play=function e(){this.data.paused=false;if(this.emitter){this.emitter.meshInstance.visible=true;this.emitter.loop=this.data.loop;this.emitter.resetTime()}};t.isPlaying=function e(){if(this.data.paused)return false;if(this.emitter&&this.emitter.loop)return true;return Date.now()<=this.emitter.endTime};t.rebuild=function e(){var t=this.enabled;this.enabled=false;if(this.emitter){this.emitter.rebuild();this.emitter.meshInstance.node=this.entity;this.data.model.meshInstances=[this.emitter.meshInstance]}this.enabled=t};U(e,[{key:"drawOrder",get:function e(){return this._drawOrder},set:function e(t){this._drawOrder=t;if(this.emitter)this.emitter.drawOrder=t}}]);return e}(R0),Yw=function e(){this.numParticles=1;this.rate=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new ce;this.emitterExtentsInner=new ce;this.emitterRadius=0;this.emitterRadiusInner=0;this.emitterShape=lh;this.initialVelocity=0;this.wrapBounds=new ce;this.localSpace=false;this.screenSpace=false;this.colorMap=null;this.colorMapAsset=null;this.normalMap=null;this.normalMapAsset=null;this.loop=true;this.preWarm=false;this.sort=0;this.mode=ah;this.scene=null;this.lighting=false;this.halfLambert=false;this.intensity=1;this.stretch=0;this.alignToMotion=false;this.depthSoftening=0;this.meshAsset=null;this.mesh=null;this.depthWrite=false;this.noFog=false;this.orientation=ch;this.particleNormal=new ce(0,1,0);this.animTilesX=1;this.animTilesY=1;this.animStartFrame=0;this.animNumFrames=1;this.animNumAnimations=1;this.animIndex=0;this.randomizeAnimIndex=false;this.animSpeed=1;this.animLoop=true;this.scaleGraph=null;this.scaleGraph2=null;this.colorGraph=null;this.colorGraph2=null;this.alphaGraph=null;this.alphaGraph2=null;this.localVelocityGraph=null;this.localVelocityGraph2=null;this.velocityGraph=null;this.velocityGraph2=null;this.rotationSpeedGraph=null;this.rotationSpeedGraph2=null;this.radialSpeedGraph=null;this.radialSpeedGraph2=null;this.blendType=pl;this.model=null;this.enabled=true;this.paused=false;this.autoPlay=true;this.layers=[Dl]},Kw=["enabled","autoPlay","numParticles","lifetime","rate","rate2","startAngle","startAngle2","loop","preWarm","lighting","halfLambert","intensity","depthWrite","noFog","depthSoftening","sort","blendType","stretch","alignToMotion","emitterShape","emitterExtents","emitterExtentsInner","emitterRadius","emitterRadiusInner","initialVelocity","wrap","wrapBounds","localSpace","screenSpace","colorMapAsset","normalMapAsset","mesh","meshAsset","orientation","particleNormal","localVelocityGraph","localVelocityGraph2","velocityGraph","velocityGraph2","rotationSpeedGraph","rotationSpeedGraph2","radialSpeedGraph","radialSpeedGraph2","scaleGraph","scaleGraph2","colorGraph","colorGraph2","alphaGraph","alphaGraph2","colorMap","normalMap","animTilesX","animTilesY","animStartFrame","animNumFrames","animNumAnimations","animIndex","randomizeAnimIndex","animSpeed","animLoop","layers"],Qw=function(l){G(e,l);function e(e){var t;t=l.call(this,e)||this;t.id="particlesystem";t.ComponentType=qw;t.DataType=Yw;t.schema=Kw;t.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};t.on("beforeremove",t.onBeforeRemove,H(t));L0.bind("update",t.onUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){var r={};n=[];var s=this.propertyTypes;var a;if(i.mesh instanceof O_||typeof i.mesh==="number"){i.meshAsset=i.mesh;delete i.mesh}for(var o in i){if(i.hasOwnProperty(o)){n.push(o);r[o]=i[o]}if(s[o]==="vec3"){if(Array.isArray(r[o]))r[o]=new ce(r[o][0],r[o][1],r[o][2])}else if(s[o]==="curve"){if(!(r[o]instanceof ae)){a=r[o].type;r[o]=new ae(r[o].keys);r[o].type=a}}else if(s[o]==="curveset")if(!(r[o]instanceof oe)){a=r[o].type;r[o]=new oe(r[o].keys);r[o].type=a}if(r.layers&&Array.isArray(r.layers))r.layers=r.layers.slice(0)}l.prototype.initializeComponentData.call(this,t,r,n)};t.cloneComponent=function e(t,i){var n=t.particlesystem.data;var r=this.schema;var s={};for(var a=0,o=r.length;a<o;a++){var l=r[a];var h=n[l];if(h instanceof ce||h instanceof ae||h instanceof oe){h=h.clone();s[l]=h}else if(l==="layers")s.layers=n.layers.slice(0);else if(h!==null&&h!==undefined)s[l]=h}return this.addComponent(i,s)};t.onUpdate=function e(t){var i=this.store;var n,r,s,a;var o=this.app.stats.particles;for(var l in i)if(i.hasOwnProperty(l)){a=i[l];var h=a.entity;var c=a.data;if(c.enabled&&h.enabled){var u=c.model.emitter;if(!u.meshInstance.visible)continue;if(u.lighting){var f,d;var p=c.layers;for(r=0;r<p.length;r++){f=this.app.scene.layers.getLayerById(p[r]);if(!f)continue;if(!f._lightCube)f._lightCube=new Float32Array(6*3);d=f._lightCube;for(r=0;r<6;r++){d[r*3]=this.app.scene.ambientLight.r;d[r*3+1]=this.app.scene.ambientLight.g;d[r*3+2]=this.app.scene.ambientLight.b}var m=f._splitLights[Nl];for(s=0;s<m.length;s++)for(a=0;a<6;a++){var _=Math.max(u.lightCubeDir[a].dot(m[s]._direction),0)*m[s]._intensity;d[a*3]+=m[s]._color.r*_;d[a*3+1]+=m[s]._color.g*_;d[a*3+2]+=m[s]._color.b*_}}u.constantLightCube.setValue(d)}if(!c.paused){u.simTime+=t;if(u.simTime>u.fixedTimeStep){n=Math.floor(u.simTime/u.fixedTimeStep);u.simTime-=n*u.fixedTimeStep}if(n){n=Math.min(n,u.maxSubSteps);for(r=0;r<n;r++)u.addTime(u.fixedTimeStep,false);o._updatesPerFrame+=n;o._frameTime+=u._addTimeTime;u._addTimeTime=0}u.finishFrame()}}}};t.onBeforeRemove=function e(t,i){i.onBeforeRemove()};return e}(L0);R0._buildAccessors(qw.prototype,Kw);var $w=function(){function e(e,t){this._constructor=e;this._pool=[];this._count=0;this._resize(t)}var t=e.prototype;t._resize=function e(t){if(t>this._pool.length)for(var i=this._pool.length;i<t;i++)this._pool[i]=new this._constructor};t.allocate=function e(){if(this._count>=this._pool.length)this._resize(this._pool.length*2);return this._pool[this._count++]};t.freeAll=function e(){this._count=0};return e}(),Zw,Jw,eT,tT,iT,nT=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;if(typeof Ammo!=="undefined"&&!Zw){Zw=new Ammo.btTransform;Jw=new Ammo.btVector3;eT=new Ammo.btVector3;tT=new Ammo.btQuaternion;iT=new Ammo.btVector3(0,0,0)}i.on("set_mass",i.onSetMass,H(i));i.on("set_linearDamping",i.onSetLinearDamping,H(i));i.on("set_angularDamping",i.onSetAngularDamping,H(i));i.on("set_linearFactor",i.onSetLinearFactor,H(i));i.on("set_angularFactor",i.onSetAngularFactor,H(i));i.on("set_friction",i.onSetFriction,H(i));i.on("set_restitution",i.onSetRestitution,H(i));i.on("set_type",i.onSetType,H(i));i.on("set_group",i.onSetGroupOrMask,H(i));i.on("set_mask",i.onSetGroupOrMask,H(i));i.on("set_body",i.onSetBody,H(i));i._linearVelocity=new ce(0,0,0);i._angularVelocity=new ce(0,0,0);return i}var t=e.prototype;t.createBody=function e(){var t=this.entity;var i;if(t.collision){i=t.collision.shape;if(t.trigger){t.trigger.destroy();delete t.trigger}}if(i){if(this.body)this.system.onRemove(this.entity,this);var n=this.type===lx?this.mass:0;this._getEntityTransform(Zw);var r=this.system.createBody(n,i,Zw);r.setRestitution(this.restitution);r.setFriction(this.friction);r.setDamping(this.linearDamping,this.angularDamping);if(this.type===lx){var s=this.linearFactor;Jw.setValue(s.x,s.y,s.z);r.setLinearFactor(Jw);var a=this.angularFactor;Jw.setValue(a.x,a.y,a.z);r.setAngularFactor(Jw)}else if(this.type===hx){r.setCollisionFlags(r.getCollisionFlags()|ux);r.setActivationState(_x)}r.entity=t;t.rigidbody.body=r;if(this.enabled&&this.entity.enabled)this.enableSimulation()}};t.isActive=function e(){var t=this.body;return t?t.isActive():false};t.activate=function e(){var t=this.body;if(t)t.activate()};t.enableSimulation=function e(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var t=this.body;if(t){this.system.addBody(t,this.group,this.mask);switch(this.type){case lx:this.system._dynamic.push(this);t.forceActivationState(dx);this.syncEntityToBody();break;case hx:this.system._kinematic.push(this);t.forceActivationState(_x);break;case ox:t.forceActivationState(dx);this.syncEntityToBody();break}if(this.entity.collision.type==="compound")this.system._compounds.push(this.entity.collision);t.activate();this.data.simulationEnabled=true}}};t.disableSimulation=function e(){var t=this.body;if(t&&this.data.simulationEnabled){var i;i=this.system._compounds.indexOf(this.entity.collision);if(i>-1)this.system._compounds.splice(i,1);i=this.system._dynamic.indexOf(this);if(i>-1)this.system._dynamic.splice(i,1);i=this.system._kinematic.indexOf(this);if(i>-1)this.system._kinematic.splice(i,1);this.system.removeBody(t);t.forceActivationState(vx);this.data.simulationEnabled=false}};t.applyForce=function e(){var t,i,n;var r,s,a;switch(arguments.length){case 1:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;break;case 2:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;r=arguments[1].x;s=arguments[1].y;a=arguments[1].z;break;case 3:t=arguments[0];i=arguments[1];n=arguments[2];break;case 6:t=arguments[0];i=arguments[1];n=arguments[2];r=arguments[3];s=arguments[4];a=arguments[5];break}var o=this.body;if(o){o.activate();Jw.setValue(t,i,n);if(r!==undefined){eT.setValue(r,s,a);o.applyForce(Jw,eT)}else o.applyForce(Jw,iT)}};t.applyTorque=function e(){var t,i,n;switch(arguments.length){case 1:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;break;case 3:t=arguments[0];i=arguments[1];n=arguments[2];break;default:return}var r=this.body;if(r){r.activate();Jw.setValue(t,i,n);r.applyTorque(Jw)}};t.applyImpulse=function e(){var t,i,n;var r,s,a;switch(arguments.length){case 1:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;break;case 2:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;r=arguments[1].x;s=arguments[1].y;a=arguments[1].z;break;case 3:t=arguments[0];i=arguments[1];n=arguments[2];break;case 6:t=arguments[0];i=arguments[1];n=arguments[2];r=arguments[3];s=arguments[4];a=arguments[5];break;default:return}var o=this.body;if(o){o.activate();Jw.setValue(t,i,n);if(r!==undefined){eT.setValue(r,s,a);o.applyImpulse(Jw,eT)}else o.applyImpulse(Jw,iT)}};t.applyTorqueImpulse=function e(){var t,i,n;switch(arguments.length){case 1:t=arguments[0].x;i=arguments[0].y;n=arguments[0].z;break;case 3:t=arguments[0];i=arguments[1];n=arguments[2];break;default:return}var r=this.body;if(r){r.activate();Jw.setValue(t,i,n);r.applyTorqueImpulse(Jw)}};t.isStatic=function e(){return this.type===ox};t.isStaticOrKinematic=function e(){return this.type===ox||this.type===hx};t.isKinematic=function e(){return this.type===hx};t._getEntityTransform=function e(t){var i=this.entity.getPosition();var n=this.entity.getRotation();Jw.setValue(i.x,i.y,i.z);tT.setValue(n.x,n.y,n.z,n.w);t.setOrigin(Jw);t.setRotation(tT)};t.syncEntityToBody=function e(){var t=this.data.body;if(t){this._getEntityTransform(Zw);t.setWorldTransform(Zw);if(this.type===hx){var i=t.getMotionState();if(i)i.setWorldTransform(Zw)}t.activate()}};t._updateDynamic=function e(){var t=this.data.body;if(t.isActive()){var i=t.getMotionState();if(i){i.getWorldTransform(Zw);var n=Zw.getOrigin();var r=Zw.getRotation();this.entity.setPosition(n.x(),n.y(),n.z());this.entity.setRotation(r.x(),r.y(),r.z(),r.w())}}};t._updateKinematic=function e(){var t=this.data.body;var i=t.getMotionState();if(i){this._getEntityTransform(Zw);i.setWorldTransform(Zw)}};t.teleport=function e(){if(arguments.length<3){if(arguments[0])this.entity.setPosition(arguments[0]);if(arguments[1])if(arguments[1]instanceof be)this.entity.setRotation(arguments[1]);else this.entity.setEulerAngles(arguments[1])}else{if(arguments.length===6)this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]);this.entity.setPosition(arguments[0],arguments[1],arguments[2])}this.syncEntityToBody()};t.onEnable=function e(){if(!this.body)this.createBody();this.enableSimulation()};t.onDisable=function e(){this.disableSimulation()};t.onSetMass=function e(t,i,n){var r=this.data.body;if(r&&this.type===lx){var s=this.enabled&&this.entity.enabled;if(s)this.disableSimulation();r.getCollisionShape().calculateLocalInertia(n,Jw);r.setMassProps(n,Jw);r.updateInertiaTensor();if(s)this.enableSimulation()}};t.onSetLinearDamping=function e(t,i,n){var r=this.data.body;if(r)r.setDamping(n,this.data.angularDamping)};t.onSetAngularDamping=function e(t,i,n){var r=this.data.body;if(r)r.setDamping(this.data.linearDamping,n)};t.onSetLinearFactor=function e(t,i,n){var r=this.data.body;if(r&&this.type===lx){Jw.setValue(n.x,n.y,n.z);r.setLinearFactor(Jw)}};t.onSetAngularFactor=function e(t,i,n){var r=this.data.body;if(r&&this.type===lx){Jw.setValue(n.x,n.y,n.z);r.setAngularFactor(Jw)}};t.onSetFriction=function e(t,i,n){var r=this.data.body;if(r)r.setFriction(n)};t.onSetRestitution=function e(t,i,n){var r=this.data.body;if(r)r.setRestitution(n)};t.onSetType=function e(t,i,n){if(n!==i){this.disableSimulation();if(n===lx){this.data.group=bx;this.data.mask=Fx}else if(n===hx){this.data.group=Sx;this.data.mask=Fx}else{this.data.group=xx;this.data.mask=Nx}this.createBody()}};t.onSetGroupOrMask=function e(t,i,n){if(n!==i){var r=this.enabled&&this.entity.enabled;if(r){this.disableSimulation();this.enableSimulation()}}};t.onSetBody=function e(t,i,n){if(this.body&&this.data.simulationEnabled)this.body.activate()};U(e,[{key:"linearVelocity",get:function e(){var t=this.body;if(t&&this.type===lx){var i=t.getLinearVelocity();this._linearVelocity.set(i.x(),i.y(),i.z())}return this._linearVelocity},set:function e(t){var i=this.body;if(i&&this.type===lx){i.activate();Jw.setValue(t.x,t.y,t.z);i.setLinearVelocity(Jw);this._linearVelocity.copy(t)}}},{key:"angularVelocity",get:function e(){var t=this.body;if(t&&this.type===lx){var i=t.getAngularVelocity();this._angularVelocity.set(i.x(),i.y(),i.z())}return this._angularVelocity},set:function e(t){var i=this.body;if(i&&this.type===lx){i.activate();Jw.setValue(t.x,t.y,t.z);i.setAngularVelocity(Jw);this._angularVelocity.copy(t)}}}]);return e}(R0),rT=function e(){this.enabled=true;this.mass=1;this.linearDamping=0;this.angularDamping=0;this.linearFactor=new ce(1,1,1);this.angularFactor=new ce(1,1,1);this.friction=.5;this.restitution=0;this.type=ox;this.group=xx;this.mask=Nx;this.body=null;this.simulationEnabled=false},sT,aT,oT={},lT={},hT=function e(t,i,n){this.entity=t;this.point=i;this.normal=n},cT=function e(t,i,n){if(arguments.length===0){this.a=null;this.b=null;this.localPointA=new ce;this.localPointB=new ce;this.pointA=new ce;this.pointB=new ce;this.normal=new ce}else{this.a=t;this.b=i;this.localPointA=n.localPoint;this.localPointB=n.localPointOther;this.pointA=n.point;this.pointB=n.pointOther;this.normal=n.normal}},uT=function e(t,i,n,r,s){if(arguments.length===0){this.localPoint=new ce;this.localPointOther=new ce;this.point=new ce;this.pointOther=new ce;this.normal=new ce}else{this.localPoint=t;this.localPointOther=i;this.point=n;this.pointOther=r;this.normal=s}},fT=function e(t,i){this.other=t;this.contacts=i},dT=["enabled","type","mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","restitution","group","mask","body"],pT=function(l){G(e,l);function e(e){var t;t=l.call(this,e)||this;t.id="rigidbody";t._stats=e.stats.frame;t.ComponentType=nT;t.DataType=rT;t.contactPointPool=null;t.contactResultPool=null;t.singleContactResultPool=null;t.schema=dT;t.maxSubSteps=10;t.fixedTimeStep=1/60;t.gravity=new ce(0,-9.81,0);t._dynamic=[];t._kinematic=[];t._triggers=[];t._compounds=[];t.on("beforeremove",t.onBeforeRemove,H(t));t.on("remove",t.onRemove,H(t));return t}var t=e.prototype;t.onLibraryLoaded=function e(){if(typeof Ammo!=="undefined"){this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);if(this.dynamicsWorld.setInternalTickCallback){var t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}sT=new Ammo.btVector3;aT=new Ammo.btVector3;this.contactPointPool=new $w(uT,1);this.contactResultPool=new $w(fT,1);this.singleContactResultPool=new $w(cT,1);L0.bind("update",this.onUpdate,this)}else L0.unbind("update",this.onUpdate,this)};t.initializeComponentData=function e(t,i,n){n=["enabled","mass","linearDamping","angularDamping","linearFactor","angularFactor","friction","restitution","type","group","mask"];var r={};for(var s=0,a=n.length;s<a;s++){var o=n[s];r[o]=i[o]}if(i.bodyType)r.type=i.bodyType;if(r.linearFactor&&Array.isArray(r.linearFactor))r.linearFactor=new ce(r.linearFactor[0],r.linearFactor[1],r.linearFactor[2]);if(r.angularFactor&&Array.isArray(r.angularFactor))r.angularFactor=new ce(r.angularFactor[0],r.angularFactor[1],r.angularFactor[2]);l.prototype.initializeComponentData.call(this,t,r,n)};t.cloneComponent=function e(t,i){var n={enabled:t.rigidbody.enabled,mass:t.rigidbody.mass,linearDamping:t.rigidbody.linearDamping,angularDamping:t.rigidbody.angularDamping,linearFactor:[t.rigidbody.linearFactor.x,t.rigidbody.linearFactor.y,t.rigidbody.linearFactor.z],angularFactor:[t.rigidbody.angularFactor.x,t.rigidbody.angularFactor.y,t.rigidbody.angularFactor.z],friction:t.rigidbody.friction,restitution:t.rigidbody.restitution,type:t.rigidbody.type,group:t.rigidbody.group,mask:t.rigidbody.mask};this.addComponent(i,n)};t.onBeforeRemove=function e(t,i){if(i.enabled)i.enabled=false};t.onRemove=function e(t,i){var n=i.body;if(n){this.removeBody(n);this.destroyBody(n);i.body=null}};t.addBody=function e(t,i,n){if(i!==undefined&&n!==undefined)this.dynamicsWorld.addRigidBody(t,i,n);else this.dynamicsWorld.addRigidBody(t)};t.removeBody=function e(t){this.dynamicsWorld.removeRigidBody(t)};t.createBody=function e(t,i,n){var r=new Ammo.btVector3(0,0,0);if(t!==0)i.calculateLocalInertia(t,r);var s=new Ammo.btDefaultMotionState(n);var a=new Ammo.btRigidBodyConstructionInfo(t,s,i,r);var o=new Ammo.btRigidBody(a);Ammo.destroy(a);Ammo.destroy(r);return o};t.destroyBody=function e(t){var i=t.getMotionState();if(i)Ammo.destroy(i);Ammo.destroy(t)};t.raycastFirst=function e(t,i){var n=null;sT.setValue(t.x,t.y,t.z);aT.setValue(i.x,i.y,i.z);var r=new Ammo.ClosestRayResultCallback(sT,aT);this.dynamicsWorld.rayTest(sT,aT,r);if(r.hasHit()){var s=r.get_m_collisionObject();var a=Ammo.castObject(s,Ammo.btRigidBody);if(a){var o=r.get_m_hitPointWorld();var l=r.get_m_hitNormalWorld();n=new hT(a.entity,new ce(o.x(),o.y(),o.z()),new ce(l.x(),l.y(),l.z()));if(arguments.length>2){var h=arguments[2];h(n)}}}Ammo.destroy(r);return n};t.raycastAll=function e(t,i){var n=[];sT.setValue(t.x,t.y,t.z);aT.setValue(i.x,i.y,i.z);var r=new Ammo.AllHitsRayResultCallback(sT,aT);this.dynamicsWorld.rayTest(sT,aT,r);if(r.hasHit()){var s=r.get_m_collisionObjects();var a=r.get_m_hitPointWorld();var o=r.get_m_hitNormalWorld();var l=s.size();for(var h=0;h<l;h++){var c=Ammo.castObject(s.at(h),Ammo.btRigidBody);if(c){var u=a.at(h);var f=o.at(h);var d=new hT(c.entity,new ce(u.x(),u.y(),u.z()),new ce(f.x(),f.y(),f.z()));n.push(d)}}}Ammo.destroy(r);return n};t._storeCollision=function e(t,i){var n=false;var r=t.getGuid();oT[r]=oT[r]||{others:[],entity:t};if(oT[r].others.indexOf(i)<0){oT[r].others.push(i);n=true}lT[r]=lT[r]||{others:[],entity:t};lT[r].others.push(i);return n};t._createContactPointFromAmmo=function e(t){var i=t.get_m_localPointA();var n=t.get_m_localPointB();var r=t.getPositionWorldOnA();var s=t.getPositionWorldOnB();var a=t.get_m_normalWorldOnB();var o=this.contactPointPool.allocate();o.localPoint.set(i.x(),i.y(),i.z());o.localPointOther.set(n.x(),n.y(),n.z());o.point.set(r.x(),r.y(),r.z());o.pointOther.set(s.x(),s.y(),s.z());o.normal.set(a.x(),a.y(),a.z());return o};t._createReverseContactPointFromAmmo=function e(t){var i=t.get_m_localPointA();var n=t.get_m_localPointB();var r=t.getPositionWorldOnA();var s=t.getPositionWorldOnB();var a=t.get_m_normalWorldOnB();var o=this.contactPointPool.allocate();o.localPointOther.set(i.x(),i.y(),i.z());o.localPoint.set(n.x(),n.y(),n.z());o.pointOther.set(r.x(),r.y(),r.z());o.point.set(s.x(),s.y(),s.z());o.normal.set(a.x(),a.y(),a.z());return o};t._createSingleContactResult=function e(t,i,n){var r=this.singleContactResultPool.allocate();r.a=t;r.b=i;r.localPointA=n.localPoint;r.localPointB=n.localPointOther;r.pointA=n.point;r.pointB=n.pointOther;r.normal=n.normal;return r};t._createContactResult=function e(t,i){var n=this.contactResultPool.allocate();n.other=t;n.contacts=i;return n};t._cleanOldCollisions=function e(){for(var t in oT)if(oT.hasOwnProperty(t)){var i=lT[t];var n=oT[t];var r=n.entity;var s=r.collision;var a=r.rigidbody;var o=n.others;var l=o.length;var h=l;while(h--){var c=o[h];if(!i||i.others.indexOf(c)<0){o.splice(h,1);if(r.trigger){if(s)s.fire("triggerleave",c);if(c.rigidbody)c.rigidbody.fire("triggerleave",r)}else if(!c.trigger){if(a)a.fire("collisionend",c);if(s)s.fire("collisionend",c)}}}if(o.length===0)delete oT[t]}};t._hasContactEvent=function e(t){var i=t.collision;if(i&&(i.hasEvent("collisionstart")||i.hasEvent("collisionend")||i.hasEvent("contact")))return true;var n=t.rigidbody;return n&&(n.hasEvent("collisionstart")||n.hasEvent("collisionend")||n.hasEvent("contact"))};t._checkForCollisions=function e(t,i){var n=Ammo.wrapPointer(t,Ammo.btDynamicsWorld);var r=n.getDispatcher();var s=r.getNumManifolds();lT={};for(var a=0;a<s;a++){var o=r.getManifoldByIndexInternal(a);var l=o.getBody0();var h=o.getBody1();var c=Ammo.castObject(l,Ammo.btRigidBody);var u=Ammo.castObject(h,Ammo.btRigidBody);var f=c.entity;var d=u.entity;if(!f||!d)continue;var p=c.getCollisionFlags();var m=u.getCollisionFlags();var _=o.getNumContacts();var v=[];var g=[];var y,b,x,S,w;if(_>0)if(p&fx||m&fx){b=f.collision&&(f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave"));x=d.collision&&(d.collision.hasEvent("triggerenter")||d.collision.hasEvent("triggerleave"));S=f.rigidbody&&(f.rigidbody.hasEvent("triggerenter")||f.rigidbody.hasEvent("triggerleave"));w=d.rigidbody&&(d.rigidbody.hasEvent("triggerenter")||d.rigidbody.hasEvent("triggerleave"));if(b){y=this._storeCollision(f,d);if(y&&!(m&fx))f.collision.fire("triggerenter",d)}if(x){y=this._storeCollision(d,f);if(y&&!(p&fx))d.collision.fire("triggerenter",f)}if(S){if(!y)y=this._storeCollision(d,f);if(y)f.rigidbody.fire("triggerenter",d)}if(w){if(!y)y=this._storeCollision(f,d);if(y)d.rigidbody.fire("triggerenter",f)}}else{b=this._hasContactEvent(f);x=this._hasContactEvent(d);var T=this.hasEvent("contact");if(T||b||x){for(var M=0;M<_;M++){var C=o.getContactPoint(M);var A=this._createContactPointFromAmmo(C);var P=null;if(b||x){P=this._createReverseContactPointFromAmmo(C);v.push(A);g.push(P)}if(T){var E=this._createSingleContactResult(f,d,A);this.fire("contact",E)}}if(b){var I=this._createContactResult(d,v);y=this._storeCollision(f,d);if(f.collision){f.collision.fire("contact",I);if(y)f.collision.fire("collisionstart",I)}if(f.rigidbody){f.rigidbody.fire("contact",I);if(y)f.rigidbody.fire("collisionstart",I)}}if(x){var R=this._createContactResult(f,g);y=this._storeCollision(d,f);if(d.collision){d.collision.fire("contact",R);if(y)d.collision.fire("collisionstart",R)}if(d.rigidbody){d.rigidbody.fire("contact",R);if(y)d.rigidbody.fire("collisionstart",R)}}}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()};t.onUpdate=function e(t){var i,n;var r=this.dynamicsWorld.getGravity();if(r.x()!==this.gravity.x||r.y()!==this.gravity.y||r.z()!==this.gravity.z){r.setValue(this.gravity.x,this.gravity.y,this.gravity.z);this.dynamicsWorld.setGravity(r)}var s=this._triggers;for(i=0,n=s.length;i<n;i++)s[i].updateTransform();var a=this._compounds;for(i=0,n=a.length;i<n;i++)a[i]._updateCompound();var o=this._kinematic;for(i=0,n=o.length;i<n;i++)o[i]._updateKinematic();this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep);var l=this._dynamic;for(i=0,n=l.length;i<n;i++)l[i]._updateDynamic();if(!this.dynamicsWorld.setInternalTickCallback)this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)};t.destroy=function e(){if(typeof Ammo!=="undefined"){Ammo.destroy(this.dynamicsWorld);Ammo.destroy(this.solver);Ammo.destroy(this.overlappingPairCache);Ammo.destroy(this.dispatcher);Ammo.destroy(this.collisionConfiguration);this.dynamicsWorld=null;this.solver=null;this.overlappingPairCache=null;this.dispatcher=null;this.collisionConfiguration=null}};return e}(L0);R0._buildAccessors(nT.prototype,dT);var mT="none",_T="blend",vT=new ve,gT=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._resolution=new he(640,320);i._referenceResolution=new he(640,320);i._scaleMode=mT;i.scale=1;i._scaleBlend=.5;i._priority=0;i._screenSpace=false;i.cull=i._screenSpace;i._screenMatrix=new ve;i._elements=new Set;e.app.graphicsDevice.on("resizecanvas",i._onResize,H(i));return i}var t=e.prototype;t.syncDrawOrder=function e(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)};t._recurseDrawOrderSync=function e(t,i){if(!(t instanceof Nv))return i;if(t.element){var n=t.element.drawOrder;t.element.drawOrder=i++;if(t.element._batchGroupId>=0&&n!=t.element.drawOrder)this.system.app.batcher.markGroupDirty(t.element._batchGroupId)}if(t.particlesystem)t.particlesystem.drawOrder=i++;var r=t.children;for(var s=0;s<r.length;s++)i=this._recurseDrawOrderSync(r[s],i);return i};t._processDrawOrderSync=function e(){var t=1;this._recurseDrawOrderSync(this.entity,t);this.fire("syncdraworder")};t._calcProjectionMatrix=function e(){var t;var i;var n;var r;var s=1;var a=-1;var o=this._resolution.x/this.scale;var l=this._resolution.y/this.scale;t=0;i=o;n=-l;r=0;this._screenMatrix.setOrtho(t,i,n,r,s,a);if(!this._screenSpace){vT.setScale(.5*o,.5*l,1);this._screenMatrix.mul2(vT,this._screenMatrix)}};t._updateScale=function e(){this.scale=this._calcScale(this._resolution,this.referenceResolution)};t._calcScale=function e(t,i){var n=Math.log2(t.x/i.x);var r=Math.log2(t.y/i.y);return Math.pow(2,n*(1-this._scaleBlend)+r*this._scaleBlend)};t._onResize=function e(t,i){if(this._screenSpace){this._resolution.set(t,i);this.resolution=this._resolution}};t._bindElement=function e(t){this._elements.add(t)};t._unbindElement=function e(t){this._elements.delete(t)};t.onRemove=function e(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove");this._elements.forEach(function(e){return e._onScreenRemove()});this._elements.clear();this.off()};U(e,[{key:"resolution",set:function e(t){var i=this;if(!this._screenSpace)this._resolution.set(t.x,t.y);else this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this._updateScale();this._calcProjectionMatrix();if(!this.entity._dirtyLocal)this.entity._dirtifyLocal();this.fire("set:resolution",this._resolution);this._elements.forEach(function(e){return e._onScreenResize(i._resolution)})},get:function e(){return this._resolution}},{key:"referenceResolution",set:function e(t){var i=this;this._referenceResolution.set(t.x,t.y);this._updateScale();this._calcProjectionMatrix();if(!this.entity._dirtyLocal)this.entity._dirtifyLocal();this.fire("set:referenceresolution",this._resolution);this._elements.forEach(function(e){return e._onScreenResize(i._resolution)})},get:function e(){if(this._scaleMode===mT)return this._resolution;return this._referenceResolution}},{key:"screenSpace",set:function e(t){this._screenSpace=t;if(this._screenSpace)this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this.resolution=this._resolution;if(!this.entity._dirtyLocal)this.entity._dirtifyLocal();this.fire("set:screenspace",this._screenSpace);this._elements.forEach(function(e){return e._onScreenSpaceChange()})},get:function e(){return this._screenSpace}},{key:"scaleMode",set:function e(t){if(t!==mT&&t!==_T)t=mT;if(!this._screenSpace&&t!==mT)t=mT;this._scaleMode=t;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function e(){return this._scaleMode}},{key:"scaleBlend",set:function e(t){var i=this;this._scaleBlend=t;this._updateScale();this._calcProjectionMatrix();if(!this.entity._dirtyLocal)this.entity._dirtifyLocal();this.fire("set:scaleblend",this._scaleBlend);this._elements.forEach(function(e){return e._onScreenResize(i._resolution)})},get:function e(){return this._scaleBlend}},{key:"priority",get:function e(){return this._priority},set:function e(t){if(t>255)t=255;this._priority=t}}]);return e}(R0),yT=function e(){this.enabled=true},bT=["enabled"],xT=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="screen";t.ComponentType=gT;t.DataType=yT;t.schema=bT;t.windowResolution=new he;t._drawOrderSyncQueue=new N;t.app.graphicsDevice.on("resizecanvas",t._onResize,H(t));L0.bind("update",t._onUpdate,H(t));t.on("beforeremove",t.onRemoveComponent,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){if(i.priority!==undefined)t.priority=i.priority;if(i.screenSpace!==undefined)t.screenSpace=i.screenSpace;t.cull=t.screenSpace;if(i.scaleMode!==undefined)t.scaleMode=i.scaleMode;if(i.scaleBlend!==undefined)t.scaleBlend=i.scaleBlend;if(i.resolution!==undefined){if(i.resolution instanceof he)t._resolution.copy(i.resolution);else t._resolution.set(i.resolution[0],i.resolution[1]);t.resolution=t._resolution}if(i.referenceResolution!==undefined){if(i.referenceResolution instanceof he)t._referenceResolution.copy(i.referenceResolution);else t._referenceResolution.set(i.referenceResolution[0],i.referenceResolution[1]);t.referenceResolution=t._referenceResolution}t.syncDrawOrder();r.prototype.initializeComponentData.call(this,t,i,n)};t.destroy=function e(){this.off();this.app.graphicsDevice.off("resizecanvas",this._onResize,this)};t._onUpdate=function e(t){var i=this.store;for(var n in i)if(i[n].entity.screen.update)i[n].entity.screen.update(t)};t._onResize=function e(t,i){this.windowResolution.x=t;this.windowResolution.y=i};t.cloneComponent=function e(t,i){var n=t.screen;return this.addComponent(i,{enabled:n.enabled,screenSpace:n.screenSpace,scaleMode:n.scaleMode,resolution:n.resolution.clone(),referenceResolution:n.referenceResolution.clone()})};t.onRemoveComponent=function e(t,i){i.onRemove()};t.processDrawOrderSyncQueue=function e(){var t=this._drawOrderSyncQueue.list();for(var i=0;i<t.length;i++){var n=t[i];n.callback.call(n.scope)}this._drawOrderSyncQueue.clear()};t.queueDrawOrderSync=function e(t,i,n){if(!this._drawOrderSyncQueue.list().length)this.app.once("prerender",this.processDrawOrderSyncQueue,this);if(!this._drawOrderSyncQueue.has(t))this._drawOrderSyncQueue.push(t,{callback:i,scope:n})};return e}(L0);R0._buildAccessors(gT.prototype,bT);var ST=["x","y","z","w"],wT=[undefined,undefined,he,ce,ue];function TT(e,t,i,n){var r;var s;switch(t.type){case"boolean":return!!i;case"number":if(typeof i==="number")return i;else if(typeof i==="string"){var a=parseInt(i,10);if(isNaN(a))return null;return a}else if(typeof i==="boolean")return 0+i;return null;case"json":var o={};if(Array.isArray(t.schema)){if(!i||typeof i!=="object")i={};for(r=0;r<t.schema.length;r++){var l=t.schema[r];if(!l.name)continue;if(l.array){o[l.name]=[];var h=Array.isArray(i[l.name])?i[l.name]:[];for(s=0;s<h.length;s++)o[l.name].push(TT(e,l,h[s]))}else{var c=i.hasOwnProperty(l.name)?i[l.name]:l.default;o[l.name]=TT(e,l,c)}}}return o;case"asset":if(i instanceof O_)return i;else if(typeof i==="number")return e.assets.get(i)||null;else if(typeof i==="string")return e.assets.get(parseInt(i,10))||null;return null;case"entity":if(i instanceof Mf)return i;else if(typeof i==="string")return e.getEntityFromIndex(i);return null;case"rgb":case"rgba":if(i instanceof ge){if(n instanceof ge){n.copy(i);return n}return i.clone()}else if(i instanceof Array&&i.length>=3&&i.length<=4){for(r=0;r<i.length;r++)if(typeof i[r]!=="number")return null;if(!n)n=new ge;n.r=i[0];n.g=i[1];n.b=i[2];n.a=i.length===3?1:i[3];return n}else if(typeof i==="string"&&/#([0-9abcdef]{2}){3,4}/i.test(i)){if(!n)n=new ge;n.fromString(i);return n}return null;case"vec2":case"vec3":case"vec4":var u=parseInt(t.type.slice(3),10);var f=wT[u];if(i instanceof f){if(n instanceof f){n.copy(i);return n}return i.clone()}else if(i instanceof Array&&i.length===u){for(r=0;r<i.length;r++)if(typeof i[r]!=="number")return null;if(!n)n=new f;for(r=0;r<u;r++)n[ST[r]]=i[r];return n}return null;case"curve":if(i){var d;if(i instanceof ae||i instanceof oe)d=i.clone();else{var p=i.keys[0]instanceof Array?oe:ae;d=new p(i.keys);d.type=i.type}return d}break}return i}var MT=function(){function t(e){this.scriptType=e;this.index={}}var e=t.prototype;e.add=function e(l,h){if(this.index[l])return;else if(t.reservedNames.has(l))return;this.index[l]=h;Object.defineProperty(this.scriptType.prototype,l,{get:function e(){return this.__attributes[l]},set:function e(t){var i="attr";var n="attr:"+l;var r=this.__attributes[l];var s=r;if(r&&h.type!=="json"&&r.clone)if(this._callbacks[i]||this._callbacks[n])s=r.clone();if(h.array){this.__attributes[l]=[];if(t){var a;var o;for(a=0,o=t.length;a<o;a++)this.__attributes[l].push(TT(this.app,h,t[a],r?r[a]:null))}}else this.__attributes[l]=TT(this.app,h,t,r);this.fire(i,l,this.__attributes[l],s);this.fire(n,this.__attributes[l],s)}})};e.remove=function e(t){if(!this.index[t])return false;delete this.index[t];delete this.scriptType.prototype[t];return true};e.has=function e(t){return!!this.index[t]};e.get=function e(t){return this.index[t]||null};return t}();MT.reservedNames=new Set(["app","entity","enabled","_enabled","_enabledOld","_destroyed","__attributes","__attributesRaw","__scriptType","__executionOrder","_callbacks","has","get","on","off","fire","once","hasEvent"]);var CT=function(n){G(h,n);function h(e,t){var i;i=n.call(this,e,t)||this;i._scripts=[];i._updateList=new z({sortBy:"__executionOrder"});i._postUpdateList=new z({sortBy:"__executionOrder"});i._scriptsIndex={};i._destroyedScripts=[];i._destroyed=false;i._scriptsData=null;i._oldState=true;i._enabled=true;i._beingEnabled=false;i._isLoopingThroughScripts=false;i._executionOrder=-1;i.on("set_enabled",i._onSetEnabled,H(i));return i}var e=h.prototype;e.onEnable=function e(){this._beingEnabled=true;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();this._beingEnabled=false};e.onDisable=function e(){this._checkState()};e.onPostStateChange=function e(){var t;var i=this._beginLooping();for(var n=0,r=this.scripts.length;n<r;n++){t=this.scripts[n];if(t._initialized&&!t._postInitialized&&t.enabled){t._postInitialized=true;if(t.postInitialize)this._scriptMethod(t,h.scriptMethods.postInitialize)}}this._endLooping(i)};e._beginLooping=function e(){var t=this._isLoopingThroughScripts;this._isLoopingThroughScripts=true;return t};e._endLooping=function e(t){this._isLoopingThroughScripts=t;if(!this._isLoopingThroughScripts)this._removeDestroyedScripts()};e._onSetEnabled=function e(t,i,n){this._beingEnabled=true;this._checkState();this._beingEnabled=false};e._checkState=function e(){var t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t;this.fire(t?"enable":"disable");this.fire("state",t);if(t)this.system._addComponentToEnabled(this);else this.system._removeComponentFromEnabled(this);var i=this._beginLooping();var n;for(var r=0,s=this.scripts.length;r<s;r++){n=this.scripts[r];n.enabled=n._enabled}this._endLooping(i)};e._onBeforeRemove=function e(){this.fire("remove");var t=this._beginLooping();for(var i=0;i<this.scripts.length;i++){var n=this.scripts[i];if(!n)continue;this.destroy(n.__scriptType.__name)}this._endLooping(t)};e._removeDestroyedScripts=function e(){var t=this._destroyedScripts.length;if(!t)return;var i;for(i=0;i<t;i++){var n=this._destroyedScripts[i];this._removeScriptInstance(n)}this._destroyedScripts.length=0;this._resetExecutionOrder(0,this._scripts.length)};e._onInitializeAttributes=function e(){for(var t=0,i=this.scripts.length;t<i;t++)this.scripts[t].__initializeAttributes()};e._scriptMethod=function e(t,i,n){t[i](n)};e._onInitialize=function e(){var t,i=this._scripts;var n=this._beginLooping();for(var r=0,s=i.length;r<s;r++){t=i[r];if(!t._initialized&&t.enabled){t._initialized=true;if(t.initialize)this._scriptMethod(t,h.scriptMethods.initialize)}}this._endLooping(n)};e._onPostInitialize=function e(){this.onPostStateChange()};e._onUpdate=function e(t){var i=this;var n=i._updateList;if(!n.length)return;var r;var s=i._beginLooping();for(n.loopIndex=0;n.loopIndex<n.length;n.loopIndex++){r=n.items[n.loopIndex];if(r.enabled)i._scriptMethod(r,h.scriptMethods.update,t)}i._endLooping(s)};e._onPostUpdate=function e(t){var i=this;var n=i._postUpdateList;if(!n.length)return;var r=i._beginLooping();var s;for(n.loopIndex=0;n.loopIndex<n.length;n.loopIndex++){s=n.items[n.loopIndex];if(s.enabled)i._scriptMethod(s,h.scriptMethods.postUpdate,t)}i._endLooping(r)};e._insertScriptInstance=function e(t,i,n){if(i===-1){this._scripts.push(t);t.__executionOrder=n;if(t.update)this._updateList.append(t);if(t.postUpdate)this._postUpdateList.append(t)}else{this._scripts.splice(i,0,t);t.__executionOrder=i;this._resetExecutionOrder(i+1,n+1);if(t.update)this._updateList.insert(t);if(t.postUpdate)this._postUpdateList.insert(t)}};e._removeScriptInstance=function e(t){var i=this._scripts.indexOf(t);if(i===-1)return i;this._scripts.splice(i,1);if(t.update)this._updateList.remove(t);if(t.postUpdate)this._postUpdateList.remove(t);return i};e._resetExecutionOrder=function e(t,i){for(var n=t;n<i;n++)this._scripts[n].__executionOrder=n};e._resolveEntityScriptAttribute=function e(t,i,n,r,s,a){if(t.array){var o=n.length;if(!o)return;var l=n.slice();for(var h=0;h<o;h++){var c=l[h]instanceof Nv?l[h].getGuid():l[h];if(a[c])l[h]=r?a[c].getGuid():a[c]}s[i]=l}else{if(n instanceof Nv)n=n.getGuid();else if(typeof n!=="string")return;if(a[n])s[i]=a[n]}};e.has=function e(t){if(typeof t==="string")return!!this._scriptsIndex[t];if(!t)return false;var i=t;var n=i.__name;var r=this._scriptsIndex[n];var s=r&&r.instance;return s instanceof i};e.get=function e(t){if(typeof t==="string"){var i=this._scriptsIndex[t];return i?i.instance:null}if(!t)return null;var n=t;var r=n.__name;var s=this._scriptsIndex[r];var a=s&&s.instance;return a instanceof n?a:null};e.create=function e(t,i){if(i===void 0)i={};var n=this;var r=t;var s=t;if(typeof r==="string")r=this.system.app.scripts.get(r);else if(r)s=r.__name;if(r){if(!this._scriptsIndex[s]||!this._scriptsIndex[s].instance){var a=new r({app:this.system.app,entity:this.entity,enabled:i.hasOwnProperty("enabled")?i.enabled:true,attributes:i.attributes});var o=this._scripts.length;var l=-1;if(typeof i.ind==="number"&&i.ind!==-1&&o>i.ind)l=i.ind;this._insertScriptInstance(a,l,o);this._scriptsIndex[s]={instance:a,onSwap:function e(){n.swap(s)}};this[s]=a;if(!i.preloading)a.__initializeAttributes();this.fire("create",s,a);this.fire("create:"+s,a);this.system.app.scripts.on("swap:"+s,this._scriptsIndex[s].onSwap);if(!i.preloading){if(a.enabled&&!a._initialized){a._initialized=true;if(a.initialize)this._scriptMethod(a,h.scriptMethods.initialize)}if(a.enabled&&!a._postInitialized){a._postInitialized=true;if(a.postInitialize)this._scriptMethod(a,h.scriptMethods.postInitialize)}}return a}console.warn("script '"+s+"' is already added to entity '"+this.entity.name+"'")}else{this._scriptsIndex[s]={awaiting:true,ind:this._scripts.length};console.warn("script '"+s+"' is not found, awaiting it to be added to registry")}return null};e.destroy=function e(t){var i=t;var n=t;if(typeof n==="string")n=this.system.app.scripts.get(n);else if(n)i=n.__name;var r=this._scriptsIndex[i];delete this._scriptsIndex[i];if(!r)return false;var s=r.instance;if(s&&!s._destroyed){s.enabled=false;s._destroyed=true;if(!this._isLoopingThroughScripts){var a=this._removeScriptInstance(s);if(a>=0)this._resetExecutionOrder(a,this._scripts.length)}else this._destroyedScripts.push(s)}this.system.app.scripts.off("swap:"+i,r.onSwap);delete this[i];this.fire("destroy",i,s||null);this.fire("destroy:"+i,s||null);if(s)s.fire("destroy");return true};e.swap=function e(t){var i=t;var n=t;if(typeof n==="string")n=this.system.app.scripts.get(n);else if(n)i=n.__name;var r=this._scriptsIndex[i];if(!r||!r.instance)return false;var s=r.instance;var a=this._scripts.indexOf(s);var o=new n({app:this.system.app,entity:this.entity,enabled:s.enabled,attributes:s.__attributes});if(!o.swap)return false;o.__initializeAttributes();this._scripts[a]=o;this._scriptsIndex[i].instance=o;this[i]=o;o.__executionOrder=a;if(s.update)this._updateList.remove(s);if(s.postUpdate)this._postUpdateList.remove(s);if(o.update)this._updateList.insert(o);if(o.postUpdate)this._postUpdateList.insert(o);this._scriptMethod(o,h.scriptMethods.swap,s);this.fire("swap",i,o);this.fire("swap:"+i,o);return true};e.resolveDuplicatedEntityReferenceProperties=function e(t,i){var n=this.entity.script;var r,s;for(var a in t._scriptsIndex){var o=this.system.app.scripts.get(a);if(!o)continue;var l=t._scriptsIndex[a];if(!l||!l.instance)continue;var h=n[a].__attributesRaw;var c=n[a].__attributes;if(!h&&!c)continue;var u=!!h;var f=l.instance.__attributes;for(var d in f){if(!f[d])continue;var p=o.attributes.get(d);if(!p)continue;if(p.type==="entity")this._resolveEntityScriptAttribute(p,d,f[d],u,h||c,i);else if(p.type==="json"&&Array.isArray(p.schema)){var m=f[d];var _=h?h[d]:c[d];for(r=0;r<p.schema.length;r++){var v=p.schema[r];if(v.type!=="entity")continue;if(p.array)for(s=0;s<m.length;s++)this._resolveEntityScriptAttribute(v,v.name,m[s][v.name],u,_[s],i);else this._resolveEntityScriptAttribute(v,v.name,m[v.name],u,_,i)}}}}};e.move=function e(t,i){var n=this._scripts.length;if(i>=n||i<0)return false;var r=t;var s=t;if(typeof s!=="string")s=t.__name;else r=null;var a=this._scriptsIndex[s];if(!a||!a.instance)return false;var o=a.instance;if(r&&!(o instanceof r))return false;var l=this._scripts.indexOf(o);if(l===-1||l===i)return false;this._scripts.splice(i,0,this._scripts.splice(l,1)[0]);this._resetExecutionOrder(0,n);this._updateList.sort();this._postUpdateList.sort();this.fire("move",s,o,i,l);this.fire("move:"+s,o,i,l);return true};U(h,[{key:"enabled",get:function e(){return this._enabled},set:function e(t){var i=this._enabled;this._enabled=t;this.fire("set","enabled",i,t)}},{key:"scripts",get:function e(){return this._scripts},set:function e(t){this._scriptsData=t;for(var i in t){if(!t.hasOwnProperty(i))continue;var n=this._scriptsIndex[i];if(n){if(typeof t[i].enabled==="boolean")n.enabled=!!t[i].enabled;if(typeof t[i].attributes==="object")for(var r in t[i].attributes){if(MT.reservedNames.has(r))continue;if(!n.__attributes.hasOwnProperty(r)){var s=this.system.app.scripts.get(i);if(s)s.attributes.add(r,{})}n[r]=t[i].attributes[r]}}else console.log(this.order)}}}]);return h}(R0);CT.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};var AT=function e(){this.enabled=true},PT="_onInitializeAttributes",ET="_onInitialize",IT="_onPostInitialize",RT="_onUpdate",LT="_onPostUpdate",DT=0,kT=function(i){G(e,i);function e(e){var t;t=i.call(this,e)||this;t.id="script";t.ComponentType=CT;t.DataType=AT;t._components=new z({sortBy:"_executionOrder"});t._enabledComponents=new z({sortBy:"_executionOrder"});t.preloading=true;t.on("beforeremove",t._onBeforeRemove,H(t));L0.bind("initialize",t._onInitialize,H(t));L0.bind("postInitialize",t._onPostInitialize,H(t));L0.bind("update",t._onUpdate,H(t));L0.bind("postUpdate",t._onPostUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i){t._executionOrder=DT++;this._components.append(t);if(DT>Number.MAX_SAFE_INTEGER)this._resetExecutionOrder();t.enabled=i.hasOwnProperty("enabled")?!!i.enabled:true;if(t.enabled&&t.entity.enabled)this._enabledComponents.append(t);if(i.hasOwnProperty("order")&&i.hasOwnProperty("scripts")){t._scriptsData=i.scripts;for(var n=0;n<i.order.length;n++)t.create(i.order[n],{enabled:i.scripts[i.order[n]].enabled,attributes:i.scripts[i.order[n]].attributes,preloading:this.preloading})}};t.cloneComponent=function e(t,i){var n,r;var s=[];var a={};for(n=0;n<t.script._scripts.length;n++){var o=t.script._scripts[n];var l=o.__scriptType.__name;s.push(l);var h={};for(r in o.__attributes)h[r]=o.__attributes[r];a[l]={enabled:o._enabled,attributes:h}}for(r in t.script._scriptsIndex)if(r.awaiting)s.splice(r.ind,0,r);var c={enabled:t.script.enabled,order:s,scripts:a};return this.addComponent(i,c)};t._resetExecutionOrder=function e(){DT=0;for(var t=0,i=this._components.length;t<i;t++)this._components.items[t]._executionOrder=DT++};t._callComponentMethod=function e(t,i,n){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][i](n)};t._onInitialize=function e(){this.preloading=false;this._callComponentMethod(this._components,PT);this._callComponentMethod(this._enabledComponents,ET)};t._onPostInitialize=function e(){this._callComponentMethod(this._enabledComponents,IT)};t._onUpdate=function e(t){this._callComponentMethod(this._enabledComponents,RT,t)};t._onPostUpdate=function e(t){this._callComponentMethod(this._enabledComponents,LT,t)};t._addComponentToEnabled=function e(t){this._enabledComponents.insert(t)};t._removeComponentFromEnabled=function e(t){this._enabledComponents.remove(t)};t._onBeforeRemove=function e(t,i){var n=this._components.items.indexOf(i);if(n>=0)i._onBeforeRemove();this._removeComponentFromEnabled(i);this._components.remove(i)};return e}(L0),OT=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i.on("set_scripts",i.onSetScripts,H(i));return i}var t=e.prototype;t.send=function e(t,i){var n=Array.prototype.slice.call(arguments,2);var r=this.entity.script.instances;var s;if(r&&r[t]){s=r[t].instance[i];if(s)return s.apply(r[t].instance,n)}};t.onEnable=function e(){if(this.data.areScriptsLoaded&&!this.system.preloading){if(!this.data.initialized)this.system._initializeScriptComponent(this);else this.system._enableScriptComponent(this);if(!this.data.postInitialized)this.system._postInitializeScriptComponent(this)}};t.onDisable=function e(){this.system._disableScriptComponent(this)};t.onSetScripts=function e(t,i,n){if(!this.system._inTools||this.runInTools){if(this._updateScriptAttributes(i,n))return;if(this.enabled)this.system._disableScriptComponent(this);this.system._destroyScriptComponent(this);this.data.areScriptsLoaded=false;var r=n;var s=r.map(function(e){return e.url});if(this._loadFromCache(s))return;this._loadScripts(s)}};t._updateScriptAttributes=function e(t,i){var n=true;if(t.length!==i.length)n=false;else{var r,s=i.length;for(r=0;r<s;r++)if(t[r].url!==i[r].url){n=false;break}}if(n)for(var a in this.instances)if(this.instances.hasOwnProperty(a))this.system._updateAccessors(this.entity,this.instances[a]);return n};t._loadFromCache=function e(t){var i,n;var r=[];var s=this.system.app._scriptPrefix||"";var a=/^http(s)?:\/\//i;for(i=0,n=t.length;i<n;i++){var o=t[i];if(!a.test(o))o=p.join(s,o);var l=this.system.app.loader.getFromCache(o,"script");if(!l)return false;r.push(l)}for(i=0,n=r.length;i<n;i++){var h=r[i];if(h===true)continue;if(h&&this.entity.script)if(!this.entity.script.instances[h._pcScriptName]){var c=new h(this.entity);this.system._preRegisterInstance(this.entity,t[i],h._pcScriptName,c)}}if(this.data)this.data.areScriptsLoaded=true;if(!this.system.preloading){this.system.onInitialize(this.entity);this.system.onPostInitialize(this.entity)}return true};t._loadScripts=function e(t){var r=t.length;var i=this.system.app._scriptPrefix||"";t.forEach(function(e){var t=null;var n=null;if(e.toLowerCase().startsWith("http://")||e.toLowerCase().startsWith("https://")){n=e;t=e}else{n=e;t=p.join(i,e)}this.system.app.loader.load(t,"script",function(e,t){r--;if(!e){if(t&&this.entity.script)if(!this.entity.script.instances[t._pcScriptName]){var i=new t(this.entity);this.system._preRegisterInstance(this.entity,n,t._pcScriptName,i)}}else console.error(e);if(r===0){this.data.areScriptsLoaded=true;if(!this.system.preloading){this.system.onInitialize(this.entity);this.system.onPostInitialize(this.entity)}}}.bind(this))}.bind(this))};return e}(R0),FT=function e(){this.scripts=[];this.enabled=true;this.instances={};this._instances={};this.runInTools=false;this.attributes={};this.initialized=false;this.postInitialized=false;this.areScriptsLoaded=false},BT=["enabled","scripts","instances","runInTools"],NT="initialize",zT="postInitialize",VT="update",UT="postUpdate",GT="fixedUpdate",HT="toolsUpdate",WT="onEnable",jT="onDisable",XT=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="script";t.ComponentType=OT;t.DataType=FT;t.schema=BT;t.preloading=false;t.instancesWithUpdate=[];t.instancesWithFixedUpdate=[];t.instancesWithPostUpdate=[];t.instancesWithToolsUpdate=[];t.on("beforeremove",t.onBeforeRemove,H(t));L0.bind(NT,t.onInitialize,H(t));L0.bind(zT,t.onPostInitialize,H(t));L0.bind(VT,t.onUpdate,H(t));L0.bind(GT,t.onFixedUpdate,H(t));L0.bind(UT,t.onPostUpdate,H(t));L0.bind(HT,t.onToolsUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["runInTools","enabled","scripts"];if(i.scripts&&i.scripts.length)i.scripts.forEach(function(e){if(e.attributes&&Array.isArray(e.attributes)){var t={};for(var i=0;i<e.attributes.length;i++)t[e.attributes[i].name]=e.attributes[i];e.attributes=t}});r.prototype.initializeComponentData.call(this,t,i,n)};t.cloneComponent=function e(t,i){var n=this.store[t.getGuid()];var r={runInTools:n.data.runInTools,scripts:[],enabled:n.data.enabled};var s=n.data.scripts;for(var a=0,o=s.length;a<o;a++){var l=s[a].attributes;if(l)delete s[a].attributes;r.scripts.push(_({},s[a]));if(l){r.scripts[a].attributes=this._cloneAttributes(l);s[a].attributes=l}}return this.addComponent(i,r)};t.onBeforeRemove=function e(t,i){if(i.enabled)this._disableScriptComponent(i);this._destroyScriptComponent(i)};t.onInitialize=function e(t){this._registerInstances(t);if(t.enabled){if(t.script&&t.script.enabled)this._initializeScriptComponent(t.script);var i=t._children;var n,r=i.length;for(n=0;n<r;n++)if(i[n]instanceof Nv)this.onInitialize(i[n])}};t.onPostInitialize=function e(t){if(t.enabled){if(t.script&&t.script.enabled)this._postInitializeScriptComponent(t.script);var i=t._children;var n,r=i.length;for(n=0;n<r;n++)if(i[n]instanceof Nv)this.onPostInitialize(i[n])}};t._callInstancesMethod=function e(t,i){var n=t.data.instances;for(var r in n)if(n.hasOwnProperty(r)){var s=n[r].instance;if(s[i])s[i]()}};t._initializeScriptComponent=function e(t){this._callInstancesMethod(t,NT);t.data.initialized=true;if(t.enabled&&t.entity.enabled)this._enableScriptComponent(t)};t._enableScriptComponent=function e(t){this._callInstancesMethod(t,WT)};t._disableScriptComponent=function e(t){this._callInstancesMethod(t,jT)};t._destroyScriptComponent=function e(t){var i;var n=t.data.instances;for(var r in n)if(n.hasOwnProperty(r)){var s=n[r].instance;if(s.destroy)s.destroy();if(s.update){i=this.instancesWithUpdate.indexOf(s);if(i>=0)this.instancesWithUpdate.splice(i,1)}if(s.fixedUpdate){i=this.instancesWithFixedUpdate.indexOf(s);if(i>=0)this.instancesWithFixedUpdate.splice(i,1)}if(s.postUpdate){i=this.instancesWithPostUpdate.indexOf(s);if(i>=0)this.instancesWithPostUpdate.splice(i,1)}if(s.toolsUpdate){i=this.instancesWithToolsUpdate.indexOf(s);if(i>=0)this.instancesWithToolsUpdate.splice(i,1)}if(t.instances[r].instance===t[r])delete t[r];delete t.instances[r]}};t._postInitializeScriptComponent=function e(t){this._callInstancesMethod(t,zT);t.data.postInitialized=true};t._updateInstances=function e(t,i,n){var r;for(var s=0,a=i.length;s<a;s++){r=i[s];if(r&&r.entity&&r.entity.enabled&&r.entity.script.enabled)r[t](n)}};t.onUpdate=function e(t){this._updateInstances(VT,this.instancesWithUpdate,t)};t.onFixedUpdate=function e(t){this._updateInstances(GT,this.instancesWithFixedUpdate,t)};t.onPostUpdate=function e(t){this._updateInstances(UT,this.instancesWithPostUpdate,t)};t.onToolsUpdate=function e(t){this._updateInstances(HT,this.instancesWithToolsUpdate,t)};t.broadcast=function e(t,i){var n=Array.prototype.slice.call(arguments,2);var r,s,a;var o=this.store;for(r in o)if(o.hasOwnProperty(r)){s=o[r].data;if(s.instances[t]){a=s.instances[t].instance[i];if(a)a.apply(s.instances[t].instance,n)}}};t._preRegisterInstance=function e(t,i,n,r){if(t.script){t.script.data._instances=t.script.data._instances||{};if(t.script.data._instances[n])throw Error("Script name collision '"+n+"'. Scripts from '"+i+"' and '"+t.script.data._instances[n].url+"' {"+t.getGuid()+"}");t.script.data._instances[n]={url:i,name:n,instance:r}}};t._registerInstances=function e(t){var i,n,r;if(t.script)if(t.script.data._instances){t.script.instances=t.script.data._instances;for(r in t.script.instances){i=t.script.instances[r];n=i.instance;f.attach(n);if(n.update)this.instancesWithUpdate.push(n);if(n.fixedUpdate)this.instancesWithFixedUpdate.push(n);if(n.postUpdate)this.instancesWithPostUpdate.push(n);if(n.toolsUpdate)this.instancesWithToolsUpdate.push(n);if(t.script.scripts)this._createAccessors(t,i);if(t.script[r])throw Error("Script with name '"+r+"' is already attached to Script Component");else t.script[r]=n}delete t.script.data._instances}var s=t._children;var a,o=s.length;for(a=0;a<o;a++)if(s[a]instanceof Nv)this._registerInstances(s[a])};t._cloneAttributes=function e(t){var i={};for(var n in t){if(!t.hasOwnProperty(n))continue;if(t[n].type!=="entity")i[n]=_({},t[n]);else{var r=t[n].value;delete t[n].value;i[n]=_({},t[n]);i[n].value=r;t[n].value=r}}return i};t._createAccessors=function e(t,i){var n=this;var r;var s=t.script.scripts.length;var a=i.url;for(r=0;r<s;r++){var o=t.script.scripts[r];if(o.url===a){var l=o.attributes;if(o.name&&l){for(var h in l)if(l.hasOwnProperty(h))n._createAccessor(l[h],i);t.script.data.attributes[o.name]=n._cloneAttributes(l)}break}}};t._createAccessor=function e(n,r){var s=this;n={name:n.name,value:n.value,type:n.type};s._convertAttributeValue(n);Object.defineProperty(r.instance,n.name,{get:function e(){return n.value},set:function e(t){var i=n.value;n.value=t;s._convertAttributeValue(n);r.instance.fire("set",n.name,i,n.value)},configurable:true})};t._updateAccessors=function e(t,i){var n=this;var r;var s=t.script.scripts.length;var a;var o=i.url;var l,h,c,u;var f;var d;for(r=0;r<s;r++){l=t.script;h=l.scripts[r];if(h.url===o){c=h.name;u=h.attributes;if(c){if(u)for(a in u)if(u.hasOwnProperty(a))n._createAccessor(u[a],i);f=l.data.attributes[c];if(f)for(a in f){d=f[a];if(!(a in u))delete i.instance[d.name];else if(u[a].value!==d.value)if(i.instance.onAttributeChanged)i.instance.onAttributeChanged(d.name,d.value,u[a].value)}if(u)l.data.attributes[c]=n._cloneAttributes(u);else delete l.data.attributes[c]}break}}};t._convertAttributeValue=function e(t){if(t.type==="rgb"||t.type==="rgba"){if(Array.isArray(t.value))t.value=t.value.length===3?new ge(t.value[0],t.value[1],t.value[2]):new ge(t.value[0],t.value[1],t.value[2],t.value[3])}else if(t.type==="vec2"){if(Array.isArray(t.value))t.value=new he(t.value[0],t.value[1])}else if(t.type==="vec3"||t.type==="vector"){if(Array.isArray(t.value))t.value=new ce(t.value[0],t.value[1],t.value[2])}else if(t.type==="vec4"){if(Array.isArray(t.value))t.value=new ue(t.value[0],t.value[1],t.value[2],t.value[3])}else if(t.type==="entity"){if(t.value!==null&&typeof t.value==="string")t.value=this.app.root.findByGuid(t.value)}else if(t.type==="curve"||t.type==="colorcurve"){var i=t.value.keys[0]instanceof Array?oe:ae;t.value=new i(t.value.keys);t.value.type=t.value.type}};return e}(L0);R0._buildAccessors(OT.prototype,BT);var qT=new he,YT=new ce,KT=new ce,QT=new ce,$T=new ce,ZT=new ce,JT=new be,e1={x:"y",y:"x"},t1=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;if(!e||!(e instanceof WS))throw new Error("Element was null or not an ElementComponent");if(t&&t!=="x"&&t!=="y")throw new Error("Unrecognized axis: "+t);i._element=e;i._app=e.system.app;i._axis=t||null;i._enabled=true;i._dragScale=new ce;i._dragStartMousePosition=new ce;i._dragStartHandlePosition=new ce;i._deltaMousePosition=new ce;i._deltaHandlePosition=new ce;i._isDragging=false;i._toggleLifecycleListeners("on");return i}var t=e.prototype;t._toggleLifecycleListeners=function e(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this);this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)};t._toggleDragListeners=function e(t){var i=t==="on";var n=i?"addEventListener":"removeEventListener";if(this._hasDragListeners&&i)return;if(!this._handleMouseUpOrTouchEnd)this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this);if(this._app.mouse){this._app.mouse[t]("mousemove",this._onMove,this);window[n]("mouseup",this._handleMouseUpOrTouchEnd,false)}if(m.touch){this._app.touch[t]("touchmove",this._onMove,this);window[n]("touchend",this._handleMouseUpOrTouchEnd,false);window[n]("touchcancel",this._handleMouseUpOrTouchEnd,false)}this._hasDragListeners=i};t._onMouseDownOrTouchStart=function e(t){if(this._element&&!this._isDragging&&this.enabled){this._dragCamera=t.camera;this._calculateDragScale();var i=this._screenToLocal(t);if(i){this._toggleDragListeners("on");this._isDragging=true;this._dragStartMousePosition.copy(i);this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition());this.fire("drag:start")}}};t._onMouseUpOrTouchEnd=function e(){if(this._isDragging){this._isDragging=false;this._toggleDragListeners("off");this.fire("drag:end")}};t._screenToLocal=function e(t){this._determineInputPosition(t);this._chooseRayOriginAndDirection();$T.copy(this._element.entity.getPosition());ZT.copy(this._element.entity.forward).scale(-1);var i=ZT.dot(QT);if(Math.abs(i)>0){var n=$T.sub(KT);var r=n.dot(ZT)/i;var s=KT.add(QT.scale(r));JT.copy(this._element.entity.getRotation()).invert().transformVector(s,s);s.mul(this._dragScale);return s}return null};t._determineInputPosition=function e(t){var i=this._app.graphicsDevice.maxPixelRatio;if(typeof t.x!=="undefined"&&typeof t.y!=="undefined"){qT.x=t.x*i;qT.y=t.y*i}else if(t.changedTouches){qT.x=t.changedTouches[0].x*i;qT.y=t.changedTouches[0].y*i}else console.warn("Could not determine position from input event")};t._chooseRayOriginAndDirection=function e(){if(this._element.screen&&this._element.screen.screen.screenSpace){KT.set(qT.x,-qT.y,0);QT.set(0,0,-1)}else{YT.copy(this._dragCamera.screenToWorld(qT.x,qT.y,1));KT.copy(this._dragCamera.entity.getPosition());QT.copy(YT).sub(KT).normalize()}};t._calculateDragScale=function e(){var t=this._element.entity.parent;var i=this._element.screen&&this._element.screen.screen;var n=i&&i.screenSpace;var r=n?i.scale:1;var s=this._dragScale;s.set(r,r,r);while(t){s.mul(t.getLocalScale());t=t.parent;if(n&&t.screen)break}s.x=1/s.x;s.y=1/s.y;s.z=1/s.z};t._onMove=function e(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled){var i=this._screenToLocal(t);if(this._dragStartMousePosition&&i){this._deltaMousePosition.copy(i).sub(this._dragStartMousePosition);this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition);if(this._axis){var n=this._element.entity.getLocalPosition();var r=e1[this._axis];this._deltaHandlePosition[r]=n[r]}this._element.entity.setLocalPosition(this._deltaHandlePosition);this.fire("drag:move",this._deltaHandlePosition)}}};t.destroy=function e(){this._toggleLifecycleListeners("off");this._toggleDragListeners("off")};U(e,[{key:"enabled",get:function e(){return this._enabled},set:function e(t){this._enabled=t}},{key:"isDragging",get:function e(){return this._isDragging}}]);return e}(u),i1=0,n1=1,r1=2,s1=0,a1=1,o1=new he,l1=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._viewportReference=new Ub(H(i),"viewportEntity",{"element#gain":i._onViewportElementGain,"element#resize":i._onSetContentOrViewportSize});i._contentReference=new Ub(H(i),"contentEntity",{"element#gain":i._onContentElementGain,"element#lose":i._onContentElementLose,"element#resize":i._onSetContentOrViewportSize});i._scrollbarUpdateFlags={};i._scrollbarReferences={};i._scrollbarReferences[Fc]=new Ub(H(i),"horizontalScrollbarEntity",{"scrollbar#set:value":i._onSetHorizontalScrollbarValue,"scrollbar#gain":i._onHorizontalScrollbarGain});i._scrollbarReferences[Bc]=new Ub(H(i),"verticalScrollbarEntity",{"scrollbar#set:value":i._onSetVerticalScrollbarValue,"scrollbar#gain":i._onVerticalScrollbarGain});i._prevContentSizes={};i._prevContentSizes[Fc]=null;i._prevContentSizes[Bc]=null;i._scroll=new he;i._velocity=new ce;i._dragStartPosition=new ce;i._disabledContentInput=false;i._disabledContentInputEntities=[];i._toggleLifecycleListeners("on",e);i._toggleElementListeners("on");return i}var t=e.prototype;t._toggleLifecycleListeners=function e(t,i){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this);this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this);i.app.systems.element[t]("add",this._onElementComponentAdd,this);i.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)};t._toggleElementListeners=function e(t){if(this.entity.element){if(t==="on"&&this._hasElementListeners)return;this.entity.element[t]("resize",this._onSetContentOrViewportSize,this);this._hasElementListeners=t==="on"}};t._onElementComponentAdd=function e(t){if(this.entity===t)this._toggleElementListeners("on")};t._onElementComponentRemove=function e(t){if(this.entity===t)this._toggleElementListeners("off")};t._onViewportElementGain=function e(){this._syncAll()};t._onContentElementGain=function e(){this._destroyDragHelper();this._contentDragHelper=new t1(this._contentReference.entity.element);this._contentDragHelper.on("drag:start",this._onContentDragStart,this);this._contentDragHelper.on("drag:end",this._onContentDragEnd,this);this._contentDragHelper.on("drag:move",this._onContentDragMove,this);this._prevContentSizes[Fc]=null;this._prevContentSizes[Bc]=null;this._syncAll()};t._onContentElementLose=function e(){this._destroyDragHelper()};t._onContentDragStart=function e(){if(this._contentReference.entity&&this.enabled&&this.entity.enabled)this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())};t._onContentDragEnd=function e(){this._prevContentDragPosition=null;this._enableContentInput()};t._onContentDragMove=function e(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled){this._wasDragged=true;this._setScrollFromContentPosition(t);this._setVelocityFromContentPositionDelta(t);if(!this._disabledContentInput){var i=t.x-this._dragStartPosition.x;var n=t.y-this._dragStartPosition.y;if(Math.abs(i)>this.dragThreshold||Math.abs(n)>this.dragThreshold)this._disableContentInput()}}};t._onSetContentOrViewportSize=function e(){this._syncAll()};t._onSetHorizontalScrollbarValue=function e(t){if(!this._scrollbarUpdateFlags[Fc]&&this.enabled&&this.entity.enabled)this._onSetScroll(t,null)};t._onSetVerticalScrollbarValue=function e(t){if(!this._scrollbarUpdateFlags[Bc]&&this.enabled&&this.entity.enabled)this._onSetScroll(null,t)};t._onSetHorizontalScrollingEnabled=function e(){this._syncScrollbarEnabledState(Fc)};t._onSetVerticalScrollingEnabled=function e(){this._syncScrollbarEnabledState(Bc)};t._onHorizontalScrollbarGain=function e(){this._syncScrollbarEnabledState(Fc);this._syncScrollbarPosition(Fc)};t._onVerticalScrollbarGain=function e(){this._syncScrollbarEnabledState(Bc);this._syncScrollbarPosition(Bc)};t._onSetScroll=function e(t,i,n){if(n!==false)this._velocity.set(0,0,0);var r=false;r|=this._updateAxis(t,"x",Fc);r|=this._updateAxis(i,"y",Bc);if(r)this.fire("set:scroll",this._scroll)};t._updateAxis=function e(t,i,n){var r=t!==null&&Math.abs(t-this._scroll[i])>1e-5;if(r||this._isDragging()||t===0){this._scroll[i]=this._determineNewScrollValue(t,i,n);this._syncContentPosition(n);this._syncScrollbarPosition(n)}return r};t._determineNewScrollValue=function e(t,i,n){if(!this._getScrollingEnabled(n))return this._scroll[i];switch(this.scrollMode){case i1:return Pe.clamp(t,0,this._getMaxScrollValue(n));case n1:this._setVelocityFromOvershoot(t,i,n);return t;case r1:return t;default:console.warn("Unhandled scroll mode:"+this.scrollMode);return t}};t._syncAll=function e(){this._syncContentPosition(Fc);this._syncContentPosition(Bc);this._syncScrollbarPosition(Fc);this._syncScrollbarPosition(Bc);this._syncScrollbarEnabledState(Fc);this._syncScrollbarEnabledState(Bc)};t._syncContentPosition=function e(t){var i=this._getAxis(t);var n=this._getSign(t);var r=this._contentReference.entity;if(r){var s=this._prevContentSizes[t];var a=this._getContentSize(t);if(s!==null&&Math.abs(s-a)>1e-4){var o=this._getMaxOffset(t,s);var l=this._getMaxOffset(t,a);if(l===0)this._scroll[i]=1;else this._scroll[i]=Pe.clamp(this._scroll[i]*o/l,0,1)}var h=this._scroll[i]*this._getMaxOffset(t);var c=r.getLocalPosition();c[i]=h*n;r.setLocalPosition(c);this._prevContentSizes[t]=a}};t._syncScrollbarPosition=function e(t){var i=this._getAxis(t);var n=this._scrollbarReferences[t].entity;if(n&&n.scrollbar){this._scrollbarUpdateFlags[t]=true;n.scrollbar.value=this._scroll[i];n.scrollbar.handleSize=this._getScrollbarHandleSize(i,t);this._scrollbarUpdateFlags[t]=false}};t._syncScrollbarEnabledState=function e(t){var i=this._scrollbarReferences[t].entity;if(i){var n=this._getScrollingEnabled(t);var r=this._getScrollbarVisibility(t);switch(r){case s1:i.enabled=n;return;case a1:i.enabled=n&&this._contentIsLargerThanViewport(t);return;default:console.warn("Unhandled scrollbar visibility:"+r);i.enabled=n}}};t._contentIsLargerThanViewport=function e(t){return this._getContentSize(t)>this._getViewportSize(t)};t._contentPositionToScrollValue=function e(t){var i=this._getMaxOffset(Fc);var n=this._getMaxOffset(Bc);if(i===0)o1.x=0;else o1.x=t.x/i;if(n===0)o1.y=0;else o1.y=t.y/-n;return o1};t._getMaxOffset=function e(t,i){i=i===undefined?this._getContentSize(t):i;var n=this._getViewportSize(t);if(i<n)return-this._getViewportSize(t);return n-i};t._getMaxScrollValue=function e(t){return this._contentIsLargerThanViewport(t)?1:0};t._getScrollbarHandleSize=function e(t,i){var n=this._getViewportSize(i);var r=this._getContentSize(i);if(Math.abs(r)<.001)return 1;var s=Math.min(n/r,1);var a=this._toOvershoot(this._scroll[t],i);if(a===0)return s;return s/(1+Math.abs(a))};t._getViewportSize=function e(t){return this._getSize(t,this._viewportReference)};t._getContentSize=function e(t){return this._getSize(t,this._contentReference)};t._getSize=function e(t,i){if(i.entity&&i.entity.element)return i.entity.element[this._getCalculatedDimension(t)];return 0};t._getScrollingEnabled=function e(t){if(t===Fc)return this.horizontal;else if(t===Bc)return this.vertical;console.warn("Unrecognized orientation: "+t)};t._getScrollbarVisibility=function e(t){if(t===Fc)return this.horizontalScrollbarVisibility;else if(t===Bc)return this.verticalScrollbarVisibility;console.warn("Unrecognized orientation: "+t)};t._getSign=function e(t){return t===Fc?1:-1};t._getAxis=function e(t){return t===Fc?"x":"y"};t._getCalculatedDimension=function e(t){return t===Fc?"calculatedWidth":"calculatedHeight"};t._destroyDragHelper=function e(){if(this._contentDragHelper)this._contentDragHelper.destroy()};t.onUpdate=function e(){if(this._contentReference.entity){this._updateVelocity();this._syncScrollbarEnabledState(Fc);this._syncScrollbarEnabledState(Bc)}};t._updateVelocity=function e(){if(!this._isDragging()){if(this.scrollMode===n1){if(this._hasOvershoot("x",Fc))this._setVelocityFromOvershoot(this.scroll.x,"x",Fc);if(this._hasOvershoot("y",Bc))this._setVelocityFromOvershoot(this.scroll.y,"y",Bc)}this._velocity.x*=1-this.friction;this._velocity.y*=1-this.friction;if(Math.abs(this._velocity.x)>1e-4||Math.abs(this._velocity.y)>1e-4){var t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x;t.y+=this._velocity.y;this._contentReference.entity.setLocalPosition(t);this._setScrollFromContentPosition(t)}}};t._hasOvershoot=function e(t,i){return Math.abs(this._toOvershoot(this.scroll[t],i))>.001};t._toOvershoot=function e(t,i){var n=this._getMaxScrollValue(i);if(t<0)return t;else if(t>n)return t-n;return 0};t._setVelocityFromOvershoot=function e(t,i,n){var r=this._toOvershoot(t,n);var s=r*this._getMaxOffset(n)*this._getSign(n);if(Math.abs(s)>0)this._velocity[i]=-s/(this.bounceAmount*50+1)};t._setVelocityFromContentPositionDelta=function e(t){if(this._prevContentDragPosition){this._velocity.sub2(t,this._prevContentDragPosition);this._prevContentDragPosition.copy(t)}else{this._velocity.set(0,0,0);this._prevContentDragPosition=t.clone()}};t._setScrollFromContentPosition=function e(t){var i=this._contentPositionToScrollValue(t);if(this._isDragging())i=this._applyScrollValueTension(i);this._onSetScroll(i.x,i.y,false)};t._applyScrollValueTension=function e(t){var i;var n;var r=1;i=this._getMaxScrollValue(Fc);n=this._toOvershoot(t.x,Fc);if(n>0)t.x=i+r*Math.log10(1+n);else if(n<0)t.x=-r*Math.log10(1-n);i=this._getMaxScrollValue(Bc);n=this._toOvershoot(t.y,Bc);if(n>0)t.y=i+r*Math.log10(1+n);else if(n<0)t.y=-r*Math.log10(1-n);return t};t._isDragging=function e(){return this._contentDragHelper&&this._contentDragHelper.isDragging};t._setScrollbarComponentsEnabled=function e(t){if(this._scrollbarReferences[Fc].hasComponent("scrollbar"))this._scrollbarReferences[Fc].entity.scrollbar.enabled=t;if(this._scrollbarReferences[Bc].hasComponent("scrollbar"))this._scrollbarReferences[Bc].entity.scrollbar.enabled=t};t._setContentDraggingEnabled=function e(t){if(this._contentDragHelper)this._contentDragHelper.enabled=t};t._enableContentInput=function e(){while(this._disabledContentInputEntities.length){var t=this._disabledContentInputEntities.pop();if(t.element)t.element.useInput=true}this._disabledContentInput=false};t._disableContentInput=function e(){var s=this;var t=function e(t){if(t.element&&t.element.useInput){s._disabledContentInputEntities.push(t);t.element.useInput=false}var i=t.children;var n,r;for(n=0,r=i.length;n<r;n++)e(i[n])};var i=this._contentReference.entity;if(i){var n=i.children;var r,a=n.length;for(r=0;r<a;r++)t(n[r])}this._disabledContentInput=true};t.onEnable=function e(){this._viewportReference.onParentComponentEnable();this._contentReference.onParentComponentEnable();this._scrollbarReferences[Fc].onParentComponentEnable();this._scrollbarReferences[Bc].onParentComponentEnable();this._setScrollbarComponentsEnabled(true);this._setContentDraggingEnabled(true);this._syncAll()};t.onDisable=function e(){this._setScrollbarComponentsEnabled(false);this._setContentDraggingEnabled(false)};t.onRemove=function e(){this._toggleLifecycleListeners("off",this.system);this._toggleElementListeners("off");this._destroyDragHelper()};U(e,[{key:"scroll",get:function e(){return this._scroll},set:function e(t){this._onSetScroll(t.x,t.y)}}]);return e}(R0),h1=function e(){this.enabled=true},c1=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],u1=10,f1=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="scrollview";t.ComponentType=l1;t.DataType=h1;t.schema=c1;t.on("beforeremove",t._onRemoveComponent,H(t));L0.bind("update",t.onUpdate,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){if(i.dragThreshold===undefined)i.dragThreshold=u1;r.prototype.initializeComponentData.call(this,t,i,c1)};t.onUpdate=function e(t){var i=this.store;for(var n in i){var r=i[n].entity;var s=r.scrollview;if(s.enabled&&r.enabled)s.onUpdate()}};t._onRemoveComponent=function e(t,i){i.onRemove()};return e}(L0);R0._buildAccessors(l1.prototype,c1);var d1=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._app=e.app;i._handleReference=new Ub(H(i),"handleEntity",{"element#gain":i._onHandleElementGain,"element#lose":i._onHandleElementLose,"element#set:anchor":i._onSetHandleAlignment,"element#set:margin":i._onSetHandleAlignment,"element#set:pivot":i._onSetHandleAlignment});i._toggleLifecycleListeners("on");return i}var t=e.prototype;t._toggleLifecycleListeners=function e(t){this[t]("set_value",this._onSetValue,this);this[t]("set_handleSize",this._onSetHandleSize,this);this[t]("set_orientation",this._onSetOrientation,this)};t._onHandleElementGain=function e(){this._destroyDragHelper();this._handleDragHelper=new t1(this._handleReference.entity.element,this._getAxis());this._handleDragHelper.on("drag:move",this._onHandleDrag,this);this._updateHandlePositionAndSize()};t._onHandleElementLose=function e(){this._destroyDragHelper()};t._onHandleDrag=function e(t){if(this._handleReference.entity&&this.enabled&&this.entity.enabled)this.value=this._handlePositionToScrollValue(t[this._getAxis()])};t._onSetValue=function e(t,i,n){if(Math.abs(n-i)>1e-5){this.data.value=Pe.clamp(n,0,1);this._updateHandlePositionAndSize();this.fire("set:value",this.data.value)}};t._onSetHandleSize=function e(t,i,n){if(Math.abs(n-i)>1e-5){this.data.handleSize=Pe.clamp(n,0,1);this._updateHandlePositionAndSize()}};t._onSetHandleAlignment=function e(){this._updateHandlePositionAndSize()};t._onSetOrientation=function e(t,i,n){if(n!==i&&this._handleReference.hasComponent("element"))this._handleReference.entity.element[this._getOppositeDimension()]=0};t._updateHandlePositionAndSize=function e(){var t=this._handleReference.entity;var i=t&&t.element;if(t){var n=t.getLocalPosition();n[this._getAxis()]=this._getHandlePosition();this._handleReference.entity.setLocalPosition(n)}if(i)i[this._getDimension()]=this._getHandleLength()};t._handlePositionToScrollValue=function e(t){return t*this._getSign()/this._getUsableTrackLength()};t._scrollValueToHandlePosition=function e(t){return t*this._getSign()*this._getUsableTrackLength()};t._getUsableTrackLength=function e(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)};t._getTrackLength=function e(){if(this.entity.element)return this.orientation===Fc?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight;return 0};t._getHandleLength=function e(){return this._getTrackLength()*this.handleSize};t._getHandlePosition=function e(){return this._scrollValueToHandlePosition(this.value)};t._getSign=function e(){return this.orientation===Fc?1:-1};t._getAxis=function e(){return this.orientation===Fc?"x":"y"};t._getDimension=function e(){return this.orientation===Fc?"width":"height"};t._getOppositeDimension=function e(){return this.orientation===Fc?"height":"width"};t._destroyDragHelper=function e(){if(this._handleDragHelper)this._handleDragHelper.destroy()};t._setHandleDraggingEnabled=function e(t){if(this._handleDragHelper)this._handleDragHelper.enabled=t};t.onEnable=function e(){this._handleReference.onParentComponentEnable();this._setHandleDraggingEnabled(true)};t.onDisable=function e(){this._setHandleDraggingEnabled(false)};t.onRemove=function e(){this._destroyDragHelper();this._toggleLifecycleListeners("off")};return e}(R0),p1=function e(){this.enabled=true},m1=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}],_1=function(r){G(e,r);function e(e){var t;t=r.call(this,e)||this;t.id="scrollbar";t.ComponentType=d1;t.DataType=p1;t.schema=m1;t.on("beforeremove",t._onRemoveComponent,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){r.prototype.initializeComponentData.call(this,t,i,m1)};t._onRemoveComponent=function e(t,i){i.onRemove()};return e}(L0);R0._buildAccessors(d1.prototype,m1);var v1=0,g1=1,y1=2;function b1(e,t){return e%t||0}var x1=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this)||this;n._manager=e;n._volume=i.volume!==undefined?Pe.clamp(Number(i.volume)||0,0,1):1;n._pitch=i.pitch!==undefined?Math.max(.01,Number(i.pitch)||0):1;n._loop=!!(i.loop!==undefined?i.loop:false);n._sound=t;n._state=y1;n._suspended=false;n._suspendEndEvent=false;n._suspendInstanceEvents=false;n._playWhenLoaded=true;n._startTime=Math.max(0,Number(i.startTime)||0);n._duration=Math.max(0,Number(i.duration)||0);n._startOffset=null;n.source=null;n._onPlayCallback=i.onPlay;n._onPauseCallback=i.onPause;n._onResumeCallback=i.onResume;n._onStopCallback=i.onStop;n._onEndCallback=i.onEnd;if(Fm()){n._startedAt=0;n._currentTime=0;n._currentOffset=0;n._inputNode=null;n._connectorNode=null;n._firstNode=null;n._lastNode=null;n._initializeNodes();n._endedHandler=n._onEnded.bind(H(n))}else{n._isReady=false;n._loadedMetadataHandler=n._onLoadedMetadata.bind(H(n));n._timeUpdateHandler=n._onTimeUpdate.bind(H(n));n._endedHandler=n._onEnded.bind(H(n));n._createSource()}return n}var t=e.prototype;t._onPlay=function e(){this.fire("play");if(this._onPlayCallback)this._onPlayCallback(this)};t._onPause=function e(){this.fire("pause");if(this._onPauseCallback)this._onPauseCallback(this)};t._onResume=function e(){this.fire("resume");if(this._onResumeCallback)this._onResumeCallback(this)};t._onStop=function e(){this.fire("stop");if(this._onStopCallback)this._onStopCallback(this)};t._onEnded=function e(){if(this._suspendEndEvent){this._suspendEndEvent=false;return}this.fire("end");if(this._onEndCallback)this._onEndCallback(this);this.stop()};t._onManagerVolumeChange=function e(){this.volume=this._volume};t._onManagerSuspend=function e(){if(this._state===v1&&!this._suspended){this._suspended=true;this.pause()}};t._onManagerResume=function e(){if(this._suspended){this._suspended=false;this.resume()}};U(e,[{key:"loop",get:function e(){return this._loop},set:function e(t){this._loop=!!t;if(this.source)this.source.loop=this._loop}},{key:"startTime",get:function e(){return this._startTime},set:function e(t){this._startTime=Math.max(0,Number(t)||0);var i=this._state===v1;this.stop();if(i)this.play()}},{key:"duration",get:function e(){if(!this._sound)return 0;if(this._duration)return b1(this._duration,this._sound.duration);return this._sound.duration},set:function e(t){this._duration=Math.max(0,Number(t)||0);var i=this._state===v1;this.stop();if(i)this.play()}},{key:"isPlaying",get:function e(){return this._state===v1}},{key:"isPaused",get:function e(){return this._state===g1}},{key:"isStopped",get:function e(){return this._state===y1}},{key:"isSuspended",get:function e(){return this._suspended}}]);return e}(u);if(Fm()){Object.assign(x1.prototype,{_initializeNodes:function e(){this.gain=this._manager.context.createGain();this._inputNode=this.gain;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)},play:function e(){if(this._state!==y1)this.stop();if(!this.source)this._createSource();var t=b1(this._startOffset,this.duration);t=b1(this._startTime+t,this._sound.duration);this._startOffset=null;if(this._duration)this.source.start(0,t,this._duration);else this.source.start(0,t);this._startedAt=this._manager.context.currentTime;this._currentTime=0;this._currentOffset=t;this._state=v1;this._playWhenLoaded=false;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);if(this._manager.suspended)this._onManagerSuspend();if(!this._suspendInstanceEvents)this._onPlay();return true},pause:function e(){if(this._state!==v1||!this.source)return false;this._updateCurrentTime();this._state=g1;this._suspendEndEvent=true;this.source.stop(0);this.source=null;this._playWhenLoaded=false;this._startOffset=null;if(!this._suspendInstanceEvents)this._onPause();return true},resume:function e(){if(this._state!==g1)return false;if(!this.source)this._createSource();var t=this.currentTime;if(this._startOffset!==null){t=b1(this._startOffset,this.duration);t=b1(this._startTime+t,this._sound.duration);this._startOffset=null}if(this._duration)this.source.start(0,t,this._duration);else this.source.start(0,t);this._state=v1;this._startedAt=this._manager.context.currentTime;this._currentOffset=t;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=false;if(!this._suspendInstanceEvents)this._onResume();return true},stop:function e(){if(this._state===y1||!this.source)return false;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._startedAt=0;this._currentTime=0;this._currentOffset=0;this._startOffset=null;this._playWhenLoaded=false;this._suspendEndEvent=true;if(this._state===v1)this.source.stop(0);this.source=null;this._state=y1;if(!this._suspendInstanceEvents)this._onStop();return true},setExternalNodes:function e(t,i){if(!t){console.error("The firstNode must be a valid Audio Node");return}if(!i)i=t;var n=this._manager.context.destination;if(this._firstNode!==t){if(this._firstNode)this._connectorNode.disconnect(this._firstNode);else this._connectorNode.disconnect(n);this._firstNode=t;this._connectorNode.connect(t)}if(this._lastNode!==i){if(this._lastNode)this._lastNode.disconnect(n);this._lastNode=i;this._lastNode.connect(n)}},clearExternalNodes:function e(){var t=this._manager.context.destination;if(this._firstNode){this._connectorNode.disconnect(this._firstNode);this._firstNode=null}if(this._lastNode){this._lastNode.disconnect(t);this._lastNode=null}this._connectorNode.connect(t)},getExternalNodes:function e(){return[this._firstNode,this._lastNode]},_createSource:function e(){if(!this._sound)return null;var t=this._manager.context;if(this._sound.buffer){this.source=t.createBufferSource();this.source.buffer=this._sound.buffer;this.source.connect(this._inputNode);this.source.onended=this._endedHandler;this.source.loopStart=b1(this._startTime,this.source.buffer.duration);if(this._duration)this.source.loopEnd=Math.max(this.source.loopStart,b1(this._startTime+this._duration,this.source.buffer.duration))}return this.source},_updateCurrentTime:function e(){this._currentTime=b1((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset,this.duration)},_onManagerDestroy:function e(){if(this.source&&this._state===v1){this.source.stop(0);this.source=null}}});Object.defineProperty(x1.prototype,"volume",{get:function e(){return this._volume},set:function e(t){t=Pe.clamp(t,0,1);this._volume=t;if(this.gain)this.gain.gain.value=t*this._manager.volume}});Object.defineProperty(x1.prototype,"pitch",{get:function e(){return this._pitch},set:function e(t){this._currentOffset=this.currentTime;this._startedAt=this._manager.context.currentTime;this._pitch=Math.max(Number(t)||0,.01);if(this.source)this.source.playbackRate.value=this._pitch}});Object.defineProperty(x1.prototype,"sound",{get:function e(){return this._sound},set:function e(t){this._sound=t;if(this._state!==y1)this.stop();else this._createSource()}});Object.defineProperty(x1.prototype,"currentTime",{get:function e(){if(this._startOffset!==null)return this._startOffset;if(this._state===g1)return this._currentTime;if(this._state===y1||!this.source)return 0;this._updateCurrentTime();return this._currentTime},set:function e(t){if(t<0)return;if(this._state===v1){this.stop();var i=this._suspendInstanceEvents;this._suspendInstanceEvents=true;this._startOffset=t;this.play();this._suspendInstanceEvents=i}else{this._startOffset=t;this._currentTime=t}}})}else{Object.assign(x1.prototype,{play:function e(){if(this._state!==y1)this.stop();if(!this.source)if(!this._createSource())return false;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=v1;this._playWhenLoaded=false;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);if(this._manager.suspended)this._onManagerSuspend();if(!this._suspendInstanceEvents)this._onPlay();return true},pause:function e(){if(!this.source||this._state!==v1)return false;this._suspendEndEvent=true;this.source.pause();this._playWhenLoaded=false;this._state=g1;this._startOffset=null;if(!this._suspendInstanceEvents)this._onPause();return true},resume:function e(){if(!this.source||this._state!==g1)return false;this._state=v1;this._playWhenLoaded=false;if(this.source.paused){this.source.play();if(!this._suspendInstanceEvents)this._onResume()}return true},stop:function e(){if(!this.source||this._state===y1)return false;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=true;this.source.pause();this._playWhenLoaded=false;this._state=y1;this._startOffset=null;if(!this._suspendInstanceEvents)this._onStop();return true},setExternalNodes:function e(){},clearExternalNodes:function e(){},getExternalNodes:function e(){return[null,null]},_onLoadedMetadata:function e(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=true;var t=b1(this._startOffset,this.duration);t=b1(this._startTime+t,this._sound.duration);this._startOffset=null;this.source.currentTime=t},_createSource:function e(){if(this._sound&&this._sound.audio){this._isReady=false;this.source=this._sound.audio.cloneNode(true);this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler);this.source.addEventListener("timeupdate",this._timeUpdateHandler);this.source.onended=this._endedHandler}return this.source},_onTimeUpdate:function e(){if(!this._duration)return;if(this.source.currentTime>b1(this._startTime+this._duration,this.source.duration))if(this.loop)this.source.currentTime=b1(this._startTime,this.source.duration);else{this.source.removeEventListener("timeupdate",this._timeUpdateHandler);this.source.pause();this._onEnded()}},_onManagerDestroy:function e(){if(this.source)this.source.pause()}});Object.defineProperty(x1.prototype,"volume",{get:function e(){return this._volume},set:function e(t){t=Pe.clamp(t,0,1);this._volume=t;if(this.source)this.source.volume=t*this._manager.volume}});Object.defineProperty(x1.prototype,"pitch",{get:function e(){return this._pitch},set:function e(t){this._pitch=Math.max(Number(t)||0,.01);if(this.source)this.source.playbackRate=this._pitch}});Object.defineProperty(x1.prototype,"sound",{get:function e(){return this._sound},set:function e(t){this.stop();this._sound=t}});Object.defineProperty(x1.prototype,"currentTime",{get:function e(){if(this._startOffset!==null)return this._startOffset;if(this._state===y1||!this.source)return 0;return this.source.currentTime-this._startTime},set:function e(t){if(t<0)return;this._startOffset=t;if(this.source&&this._isReady){this.source.currentTime=b1(this._startTime+b1(t,this.duration),this._sound.duration);this._startOffset=null}}})}var S1=1e4,w1=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this,e,t,i)||this;i=i||{};n._position=new ce;if(i.position)n.position=i.position;n._velocity=new ce;if(i.velocity)n.velocity=i.velocity;n.maxDistance=i.maxDistance!==undefined?Number(i.maxDistance):S1;n.refDistance=i.refDistance!==undefined?Number(i.refDistance):1;n.rollOffFactor=i.rollOffFactor!==undefined?Number(i.rollOffFactor):1;n.distanceModel=i.distanceModel!==undefined?i.distanceModel:Nm;return n}return e}(x1);if(Fm()){Object.assign(w1.prototype,{_initializeNodes:function e(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}});Object.defineProperty(w1.prototype,"position",{get:function e(){return this._position},set:function e(t){this._position.copy(t);this.panner.setPosition(t.x,t.y,t.z)}});Object.defineProperty(w1.prototype,"velocity",{get:function e(){return this._velocity},set:function e(t){this._velocity.copy(t);this.panner.setVelocity(t.x,t.y,t.z)}});Object.defineProperty(w1.prototype,"maxDistance",{get:function e(){return this.panner.maxDistance},set:function e(t){this.panner.maxDistance=t}});Object.defineProperty(w1.prototype,"refDistance",{get:function e(){return this.panner.refDistance},set:function e(t){this.panner.refDistance=t}});Object.defineProperty(w1.prototype,"rollOffFactor",{get:function e(){return this.panner.rolloffFactor},set:function e(t){this.panner.rolloffFactor=t}});Object.defineProperty(w1.prototype,"distanceModel",{get:function e(){return this.panner.distanceModel},set:function e(t){this.panner.distanceModel=t}})}else{var T1=new ce;var M1=function e(t,i,n,r,s,a){T1=T1.sub2(t,i);var o=T1.length();if(o<n)return 1;else if(o>r)return 0;var l=0;if(a===Nm)l=1-s*(o-n)/(r-n);else if(a===zm)l=n/(n+s*(o-n));else if(a===Vm)l=Math.pow(o/n,-s);return Pe.clamp(l,0,1)};Object.defineProperty(w1.prototype,"position",{get:function e(){return this._position},set:function e(t){this._position.copy(t);if(this.source){var i=this._manager.listener;var n=i.getPosition();var r=M1(n,this._position,this.refDistance,this.maxDistance,this.rollOffFactor,this.distanceModel);var s=this.volume;this.source.volume=s*r*this._manager.volume}}});Object.defineProperty(w1.prototype,"velocity",{get:function e(){return this._velocity},set:function e(t){this._velocity.copy(t)}});Object.defineProperty(w1.prototype,"maxDistance",{get:function e(){return this._maxDistance},set:function e(t){this._maxDistance=t}});Object.defineProperty(w1.prototype,"refDistance",{get:function e(){return this._refDistance},set:function e(t){this._refDistance=t}});Object.defineProperty(w1.prototype,"rollOffFactor",{get:function e(){return this._rollOffFactor},set:function e(t){this._rollOffFactor=t}});Object.defineProperty(w1.prototype,"distanceModel",{get:function e(){return this._distanceModel},set:function e(t){this._distanceModel=t}})}var C1={volume:0,pitch:0,loop:false,startTime:0,duration:0,position:new ce,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},A1=function(r){G(e,r);function e(e,t,i){var n;n=r.call(this)||this;n._component=e;n._assets=e.system.app.assets;n._manager=e.system.manager;n.name=t||"Untitled";i=i||{};n._volume=i.volume!==undefined?Pe.clamp(Number(i.volume)||0,0,1):1;n._pitch=i.pitch!==undefined?Math.max(.01,Number(i.pitch)||0):1;n._loop=!!(i.loop!==undefined?i.loop:false);n._duration=i.duration>0?i.duration:null;n._startTime=Math.max(0,Number(i.startTime)||0);n._overlap=!!i.overlap;n._autoPlay=!!i.autoPlay;n._firstNode=null;n._lastNode=null;n._asset=i.asset;if(n._asset instanceof O_)n._asset=n._asset.id;n._onInstancePlayHandler=n._onInstancePlay.bind(H(n));n._onInstancePauseHandler=n._onInstancePause.bind(H(n));n._onInstanceResumeHandler=n._onInstanceResume.bind(H(n));n._onInstanceStopHandler=n._onInstanceStop.bind(H(n));n._onInstanceEndHandler=n._onInstanceEnd.bind(H(n));n.instances=[];return n}var t=e.prototype;t.play=function e(){if(!this.overlap)this.stop();if(!this.isLoaded&&!this._hasAsset())return;var n=this._createInstance();this.instances.push(n);if(!this.isLoaded){var t=function e(t){var i=n._playWhenLoaded;n.sound=t;if(i)n.play()};this.off("load",t);this.once("load",t);this.load()}else n.play();return n};t.pause=function e(){var t=false;var i=this.instances;for(var n=0,r=i.length;n<r;n++)if(i[n].pause())t=true;return t};t.resume=function e(){var t=false;var i=this.instances;for(var n=0,r=i.length;n<r;n++)if(i[n].resume())t=true;return t};t.stop=function e(){var t=false;var i=this.instances;var n=i.length;while(n--){i[n].stop();t=true}i.length=0;return t};t.load=function e(){if(!this._hasAsset())return;var t=this._assets.get(this._asset);if(!t){this._assets.off("add:"+this._asset,this._onAssetAdd,this);this._assets.once("add:"+this._asset,this._onAssetAdd,this);return}t.off("remove",this._onAssetRemoved,this);t.on("remove",this._onAssetRemoved,this);if(!t.resource){t.off("load",this._onAssetLoad,this);t.once("load",this._onAssetLoad,this);this._assets.load(t);return}this.fire("load",t.resource)};t.setExternalNodes=function e(t,i){if(!t){console.error("The firstNode must have a valid AudioNode");return}if(!i)i=t;this._firstNode=t;this._lastNode=i;if(!this._overlap){var n=this.instances;for(var r=0,s=n.length;r<s;r++)n[r].setExternalNodes(t,i)}};t.clearExternalNodes=function e(){this._firstNode=null;this._lastNode=null;if(!this._overlap){var t=this.instances;for(var i=0,n=t.length;i<n;i++)t[i].clearExternalNodes()}};t.getExternalNodes=function e(){return[this._firstNode,this._lastNode]};t._hasAsset=function e(){return this._asset!=null};t._createInstance=function e(){var t=null;var i=this._component;var n=null;if(this._hasAsset()){var r=this._assets.get(this._asset);if(r)n=r.resource}var s=C1;s.volume=this._volume*i.volume;s.pitch=this._pitch*i.pitch;s.loop=this._loop;s.startTime=this._startTime;s.duration=this._duration;s.onPlay=this._onInstancePlayHandler;s.onPause=this._onInstancePauseHandler;s.onResume=this._onInstanceResumeHandler;s.onStop=this._onInstanceStopHandler;s.onEnd=this._onInstanceEndHandler;if(i.positional){s.position.copy(i.entity.getPosition());s.maxDistance=i.maxDistance;s.refDistance=i.refDistance;s.rollOffFactor=i.rollOffFactor;s.distanceModel=i.distanceModel;t=new w1(this._manager,n,s)}else t=new x1(this._manager,n,s);if(this._firstNode)t.setExternalNodes(this._firstNode,this._lastNode);return t};t._onInstancePlay=function e(t){this.fire("play",t);this._component.fire("play",this,t)};t._onInstancePause=function e(t){this.fire("pause",t);this._component.fire("pause",this,t)};t._onInstanceResume=function e(t){this.fire("resume",t);this._component.fire("resume",this,t)};t._onInstanceStop=function e(t){var i=this.instances.indexOf(t);if(i!==-1)this.instances.splice(i,1);this.fire("stop",t);this._component.fire("stop",this,t)};t._onInstanceEnd=function e(t){var i=this.instances.indexOf(t);if(i!==-1)this.instances.splice(i,1);this.fire("end",t);this._component.fire("end",this,t)};t._onAssetAdd=function e(t){this.load()};t._onAssetLoad=function e(t){this.load()};t._onAssetRemoved=function e(t){t.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+t.id,this._onAssetAdd,this);this.stop()};t.updatePosition=function e(t){var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].position=t};U(e,[{key:"volume",get:function e(){return this._volume},set:function e(t){this._volume=Pe.clamp(Number(t)||0,0,1);if(!this._overlap){var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].volume=this._volume*this._component.volume}}},{key:"pitch",get:function e(){return this._pitch},set:function e(t){this._pitch=Math.max(Number(t)||0,.01);if(!this._overlap){var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].pitch=this.pitch*this._component.pitch}}},{key:"loop",get:function e(){return this._loop},set:function e(t){this._loop=!!t;var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].loop=this._loop}},{key:"autoPlay",get:function e(){return this._autoPlay},set:function e(t){this._autoPlay=!!t}},{key:"overlap",get:function e(){return this._overlap},set:function e(t){this._overlap=!!t}},{key:"startTime",get:function e(){return this._startTime},set:function e(t){this._startTime=Math.max(0,Number(t)||0);if(!this._overlap){var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].startTime=this._startTime}}},{key:"duration",get:function e(){var t=0;if(this._hasAsset()){var i=this._assets.get(this._asset);t=i.resource?i.resource.duration:0}if(this._duration!=null)return this._duration%(t||1);return t},set:function e(t){this._duration=Math.max(0,Number(t)||0)||null;if(!this._overlap){var i=this.instances;for(var n=0,r=i.length;n<r;n++)i[n].duration=this._duration}}},{key:"asset",get:function e(){return this._asset},set:function e(t){var i=this._asset;if(i){this._assets.off("add:"+i,this._onAssetAdd,this);var n=this._assets.get(i);if(n)n.off("remove",this._onAssetRemoved,this)}this._asset=t;if(this._asset instanceof O_)this._asset=this._asset.id;if(this._hasAsset()&&this._component.enabled&&this._component.entity.enabled)this.load()}},{key:"isLoaded",get:function e(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(t)return!!t.resource}return false}},{key:"isPlaying",get:function e(){var t=this.instances;for(var i=0,n=t.length;i<n;i++)if(t[i].isPlaying)return true;return false}},{key:"isPaused",get:function e(){var t=this.instances;var i=t.length;if(i===0)return false;for(var n=0;n<i;n++)if(!t[n].isPaused)return false;return true}},{key:"isStopped",get:function e(){var t=this.instances;for(var i=0,n=t.length;i<n;i++)if(!t[i].isStopped)return false;return true}}]);return e}(u),P1=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._volume=1;i._pitch=1;i._positional=true;i._refDistance=1;i._maxDistance=1e4;i._rollOffFactor=1;i._distanceModel=Nm;i._slots={};i._playingBeforeDisable={};return i}var t=e.prototype;t.onEnable=function e(){if(this.system._inTools)return;var t=this._slots;var i=this._playingBeforeDisable;for(var n in t){var r=t[n];if(r.autoPlay&&r.isStopped)r.play();else if(i[n])r.resume();else if(!r.isLoaded)r.load()}};t.onDisable=function e(){var t=this._slots;var i={};for(var n in t)if(!t[n].overlap)if(t[n].isPlaying){t[n].pause();i[n]=true}this._playingBeforeDisable=i};t.onRemove=function e(){this.off()};t.addSlot=function e(t,i){var n=this._slots;if(n[t])return null;var r=new A1(this,t,i);n[t]=r;if(r.autoPlay&&this.enabled&&this.entity.enabled)r.play();return r};t.removeSlot=function e(t){var i=this._slots;if(i[t]){i[t].stop();delete i[t]}};t.slot=function e(t){return this._slots[t]};t.play=function e(t){if(!this.enabled||!this.entity.enabled)return null;var i=this._slots[t];if(!i)return null;return i.play()};t.pause=function e(t){var i;var n=this._slots;if(t){i=n[t];if(!i)return;i.pause()}else for(var r in n)n[r].pause()};t.resume=function e(t){var i=this._slots;if(t){var n=i[t];if(!n)return;if(n.isPaused)n.resume()}else for(var r in i)i[r].resume()};t.stop=function e(t){var i=this._slots;if(t){var n=i[t];if(!n)return;n.stop()}else for(var r in i)i[r].stop()};U(e,[{key:"positional",get:function e(){return this._positional},set:function e(t){this._positional=t;var i=this._slots;for(var n in i){var r=i[n];if(!r.overlap){var s=r.instances;var a=s.length;for(var o=a-1;o>=0;o--){var l=s[o].isPlaying||s[o].isSuspended;var h=s[o].currentTime;if(l)s[o].stop();var c=r._createInstance();if(l){c.play();c.currentTime=h}s.push(c)}}}}},{key:"slots",get:function e(){return this._slots},set:function e(t){var i;var n=this._slots;if(n)for(i in n)n[i].stop();var r={};for(i in t)if(!(t[i]instanceof A1)){if(t[i].name)r[t[i].name]=new A1(this,t[i].name,t[i])}else r[t[i].name]=t[i];this._slots=r;if(this.enabled&&this.entity.enabled)this.onEnable()}}]);return e}(R0);function E1(l,h){Object.defineProperty(P1.prototype,l,{get:function e(){return this[h]},set:function e(t){this[h]=t;var i=this._slots;for(var n in i){var r=i[n];if(!r.overlap){var s=r.instances;for(var a=0,o=s.length;a<o;a++)s[a][l]=t}}}})}function I1(l,h){Object.defineProperty(P1.prototype,l,{get:function e(){return this[h]},set:function e(t){this[h]=t;var i=this._slots;for(var n in i){var r=i[n];if(!r.overlap){var s=r.instances;for(var a=0,o=s.length;a<o;a++)s[a][l]=r[l]*t}}}})}I1("pitch","_pitch"),I1("volume","_volume"),E1("refDistance","_refDistance"),E1("maxDistance","_maxDistance"),E1("rollOffFactor","_rollOffFactor"),E1("distanceModel","_distanceModel");var R1=function e(){this.enabled=true},L1=["enabled"],D1=function(s){G(e,s);function e(e,t){var i;i=s.call(this,e)||this;i.id="sound";i.ComponentType=P1;i.DataType=R1;i.schema=L1;i.manager=t;L0.bind("update",i.onUpdate,H(i));i.on("beforeremove",i.onBeforeRemove,H(i));return i}var t=e.prototype;t.initializeComponentData=function e(t,i,n){n=["volume","pitch","positional","refDistance","maxDistance","rollOffFactor","distanceModel","slots"];for(var r=0;r<n.length;r++)if(i.hasOwnProperty(n[r]))t[n[r]]=i[n[r]];s.prototype.initializeComponentData.call(this,t,i,["enabled"])};t.cloneComponent=function e(t,i){var n=t.sound;var r=n.slots;var s={};for(var a in r){var o=r[a];s[a]={name:o.name,volume:o.volume,pitch:o.pitch,loop:o.loop,duration:o.duration,startTime:o.startTime,overlap:o.overlap,autoPlay:o.autoPlay,asset:o.asset}}var l={distanceModel:n.distanceModel,enabled:n.enabled,maxDistance:n.maxDistance,pitch:n.pitch,positional:n.positional,refDistance:n.refDistance,rollOffFactor:n.rollOffFactor,slots:s,volume:n.volume};return this.addComponent(i,l)};t.onUpdate=function e(t){var i=this.store;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];var s=r.entity;if(s.enabled){var a=s.sound;if(a.enabled&&a.positional){var o=s.getPosition();var l=a.slots;for(var h in l)l[h].updatePosition(o)}}}};t.onBeforeRemove=function e(t,i){var n=i.slots;for(var r in n)if(!n[r].overlap)n[r].stop();i.onRemove()};U(e,[{key:"volume",get:function e(){return this.manager.volume},set:function e(t){this.manager.volume=t}},{key:"context",get:function e(){if(!Fm())return null;return this.manager.context}}]);return e}(L0);R0._buildAccessors(P1.prototype,L1);var k1="simple",O1="animated",F1=function(n){G(e,n);function e(e,t){var i;i=n.call(this)||this;i._component=e;i._frame=0;i._sprite=null;i._spriteAsset=null;i.spriteAsset=t.spriteAsset;i.name=t.name;i.fps=t.fps||0;i.loop=t.loop||false;i._playing=false;i._paused=false;i._time=0;return i}var t=e.prototype;t._onSpriteAssetAdded=function e(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this);if(this._spriteAsset===t.id)this._bindSpriteAsset(t)};t._bindSpriteAsset=function e(t){t.on("load",this._onSpriteAssetLoad,this);t.on("remove",this._onSpriteAssetRemove,this);if(t.resource)this._onSpriteAssetLoad(t);else this._component.system.app.assets.load(t)};t._unbindSpriteAsset=function e(t){t.off("load",this._onSpriteAssetLoad,this);t.off("remove",this._onSpriteAssetRemove,this);if(t.resource&&t.resource.atlas)this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)};t._onSpriteAssetLoad=function e(t){if(!t.resource)this.sprite=null;else if(!t.resource.atlas){var i=t.data.textureAtlasAsset;var n=this._component.system.app.assets;n.off("load:"+i,this._onTextureAtlasLoad,this);n.once("load:"+i,this._onTextureAtlasLoad,this)}else this.sprite=t.resource};t._onTextureAtlasLoad=function e(t){var i=this._spriteAsset;if(i instanceof O_)this._onSpriteAssetLoad(i);else this._onSpriteAssetLoad(this._component.system.app.assets.get(i))};t._onSpriteAssetRemove=function e(t){this.sprite=null};t._onSpriteMeshesChange=function e(){if(this._component.currentClip===this)this._component._showFrame(this.frame)};t._onSpritePpuChanged=function e(){if(this._component.currentClip===this)if(this.sprite.renderMode!==_c)this._component._showFrame(this.frame)};t._update=function e(t){if(this.fps===0)return;if(!this._playing||this._paused||!this._sprite)return;var i=this.fps<0?-1:1;var n=this._time+t*this._component.speed*i;var r=this.duration;var s=n>r||n<0;this._setTime(n);var a=this.frame;if(this._sprite)a=Math.floor(this._sprite.frameKeys.length*this._time/r);else a=0;if(a!==this._frame)this._setFrame(a);if(s)if(this.loop){this.fire("loop");this._component.fire("loop",this)}else{this._playing=false;this._paused=false;this.fire("end");this._component.fire("end",this)}};t._setTime=function e(t){this._time=t;var i=this.duration;if(this._time<0)if(this.loop)this._time=this._time%i+i;else this._time=0;else if(this._time>i)if(this.loop)this._time%=i;else this._time=i};t._setFrame=function e(t){if(this._sprite)this._frame=Pe.clamp(t,0,this._sprite.frameKeys.length-1);else this._frame=t;if(this._component.currentClip===this)this._component._showFrame(this._frame)};t._destroy=function e(){if(this._sprite)this.sprite=null;if(this._spriteAsset)this.spriteAsset=null};t.play=function e(){if(this._playing)return;this._playing=true;this._paused=false;this.frame=0;this.fire("play");this._component.fire("play",this)};t.pause=function e(){if(!this._playing||this._paused)return;this._paused=true;this.fire("pause");this._component.fire("pause",this)};t.resume=function e(){if(!this._paused)return;this._paused=false;this.fire("resume");this._component.fire("resume",this)};t.stop=function e(){if(!this._playing)return;this._playing=false;this._paused=false;this._time=0;this.frame=0;this.fire("stop");this._component.fire("stop",this)};U(e,[{key:"spriteAsset",get:function e(){return this._spriteAsset},set:function e(t){var i=this._component.system.app.assets;var n=t;if(t instanceof O_)n=t.id;if(this._spriteAsset!==n){if(this._spriteAsset){var r=i.get(this._spriteAsset);if(r)this._unbindSpriteAsset(r)}this._spriteAsset=n;if(this._spriteAsset){var s=i.get(this._spriteAsset);if(!s){this.sprite=null;i.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)}else this._bindSpriteAsset(s)}else this.sprite=null}}},{key:"sprite",get:function e(){return this._sprite},set:function e(t){if(this._sprite){this._sprite.off("set:meshes",this._onSpriteMeshesChange,this);this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this);this._sprite.off("set:atlas",this._onSpriteMeshesChange,this);if(this._sprite.atlas)this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)}this._sprite=t;if(this._sprite){this._sprite.on("set:meshes",this._onSpriteMeshesChange,this);this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this);this._sprite.on("set:atlas",this._onSpriteMeshesChange,this);if(this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)}if(this._component.currentClip===this){var i;if(!t||!t.atlas){i=this._component._meshInstance;if(i){i.deleteParameter("texture_emissiveMap");i.deleteParameter("texture_opacityMap")}this._component._hideModel()}else{if(t.atlas.texture){i=this._component._meshInstance;if(i){i.setParameter("texture_emissiveMap",t.atlas.texture);i.setParameter("texture_opacityMap",t.atlas.texture)}if(this._component.enabled&&this._component.entity.enabled)this._component._showModel()}if(this.time&&this.fps)this.time=this.time;else this.frame=this.frame}}}},{key:"frame",get:function e(){return this._frame},set:function e(t){this._setFrame(t);var i=this.fps||Number.MIN_VALUE;this._setTime(this._frame/i)}},{key:"isPlaying",get:function e(){return this._playing}},{key:"isPaused",get:function e(){return this._paused}},{key:"duration",get:function e(){if(this._sprite){var t=this.fps||Number.MIN_VALUE;return this._sprite.frameKeys.length/Math.abs(t)}return 0}},{key:"time",get:function e(){return this._time},set:function e(t){this._setTime(t);if(this._sprite)this.frame=Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps)));else this.frame=0}}]);return e}(u),B1="texture_emissiveMap",N1="texture_opacityMap",z1="material_emissive",V1="material_opacity",U1="innerOffset",G1="outerScale",H1="atlasRect",W1=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._type=k1;i._material=e.defaultMaterial;i._color=new ge(1,1,1,1);i._colorUniform=new Float32Array(3);i._speed=1;i._flipX=false;i._flipY=false;i._width=1;i._height=1;i._drawOrder=0;i._layers=[Dl];i._outerScale=new he(1,1);i._outerScaleUniform=new Float32Array(2);i._innerOffset=new ue;i._innerOffsetUniform=new Float32Array(4);i._atlasRect=new ue;i._atlasRectUniform=new Float32Array(4);i._batchGroupId=-1;i._batchGroup=null;i._node=new Mf;i._model=new Xu;i._model.graph=i._node;i._meshInstance=null;t.addChild(i._model.graph);i._model._entity=t;i._updateAabbFunc=i._updateAabb.bind(H(i));i._addedModel=false;i._autoPlayClip=null;i._clips={};i._defaultClip=new F1(H(i),{name:i.entity.name,fps:0,loop:false,spriteAsset:null});i._currentClip=i._defaultClip;return i}var t=e.prototype;t.onEnable=function e(){var t=this.system.app;var i=t.scene;i.on("set:layers",this._onLayersChanged,this);if(i.layers){i.layers.on("add",this._onLayerAdded,this);i.layers.on("remove",this._onLayerRemoved,this)}this._showModel();if(this._autoPlayClip)this._tryAutoPlay();if(this._batchGroupId>=0)t.batcher.insert(Yu.SPRITE,this._batchGroupId,this.entity)};t.onDisable=function e(){var t=this.system.app;var i=t.scene;i.off("set:layers",this._onLayersChanged,this);if(i.layers){i.layers.off("add",this._onLayerAdded,this);i.layers.off("remove",this._onLayerRemoved,this)}this.stop();this._hideModel();if(this._batchGroupId>=0)t.batcher.remove(Yu.SPRITE,this._batchGroupId,this.entity)};t.onDestroy=function e(){this._currentClip=null;if(this._defaultClip){this._defaultClip._destroy();this._defaultClip=null}for(var t in this._clips)this._clips[t]._destroy();this._clips=null;this._hideModel();this._model=null;if(this._node){if(this._node.parent)this._node.parent.removeChild(this._node);this._node=null}if(this._meshInstance){this._meshInstance.material=null;this._meshInstance.mesh=null;this._meshInstance=null}};t._showModel=function e(){if(this._addedModel)return;if(!this._meshInstance)return;var t;var i;var n=[this._meshInstance];for(t=0,i=this._layers.length;t<i;t++){var r=this.system.app.scene.layers.getLayerById(this._layers[t]);if(r)r.addMeshInstances(n)}this._addedModel=true};t._hideModel=function e(){if(!this._addedModel||!this._meshInstance)return;var t;var i;var n=[this._meshInstance];for(t=0,i=this._layers.length;t<i;t++){var r=this.system.app.scene.layers.getLayerById(this._layers[t]);if(r)r.removeMeshInstances(n)}this._addedModel=false};t._showFrame=function e(t){if(!this.sprite)return;var i=this.sprite.meshes[t];if(!i){if(this._meshInstance){this._meshInstance.mesh=null;this._meshInstance.visible=false}return}var n;if(this.sprite.renderMode===vc)n=this.system.default9SlicedMaterialSlicedMode;else if(this.sprite.renderMode===gc)n=this.system.default9SlicedMaterialTiledMode;else n=this.system.defaultMaterial;if(!this._meshInstance){this._meshInstance=new zu(this._node,i,this._material);this._meshInstance.castShadow=false;this._meshInstance.receiveShadow=false;this._meshInstance.drawOrder=this._drawOrder;this._model.meshInstances.push(this._meshInstance);this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b;this._meshInstance.setParameter(z1,this._colorUniform);this._meshInstance.setParameter(V1,this._color.a);if(this.enabled&&this.entity.enabled)this._showModel()}if(this._meshInstance.material!==n)this._meshInstance.material=n;if(this._meshInstance.mesh!==i){this._meshInstance.mesh=i;this._meshInstance.visible=true;this._meshInstance._aabbVer=-1}if(this.sprite.atlas&&this.sprite.atlas.texture){this._meshInstance.setParameter(B1,this.sprite.atlas.texture);this._meshInstance.setParameter(N1,this.sprite.atlas.texture)}else{this._meshInstance.deleteParameter(B1);this._meshInstance.deleteParameter(N1)}if(this.sprite.atlas&&(this.sprite.renderMode===vc||this.sprite.renderMode===gc)){this._meshInstance._updateAabbFunc=this._updateAabbFunc;var r=this.sprite.atlas.frames[this.sprite.frameKeys[t]];if(r){var s=2/r.rect.z;var a=2/r.rect.w;this._innerOffset.set(r.border.x*s,r.border.y*a,r.border.z*s,r.border.w*a);var o=this.sprite.atlas.texture;this._atlasRect.set(r.rect.x/o.width,r.rect.y/o.height,r.rect.z/o.width,r.rect.w/o.height)}else this._innerOffset.set(0,0,0,0);this._innerOffsetUniform[0]=this._innerOffset.x;this._innerOffsetUniform[1]=this._innerOffset.y;this._innerOffsetUniform[2]=this._innerOffset.z;this._innerOffsetUniform[3]=this._innerOffset.w;this._meshInstance.setParameter(U1,this._innerOffsetUniform);this._atlasRectUniform[0]=this._atlasRect.x;this._atlasRectUniform[1]=this._atlasRect.y;this._atlasRectUniform[2]=this._atlasRect.z;this._atlasRectUniform[3]=this._atlasRect.w;this._meshInstance.setParameter(H1,this._atlasRectUniform)}else this._meshInstance._updateAabbFunc=null;this._updateTransform()};t._updateTransform=function e(){var t=this.flipX?-1:1;var i=this.flipY?-1:1;var n=0;var r=0;if(this.sprite&&(this.sprite.renderMode===vc||this.sprite.renderMode===gc)){var s=1;var a=1;if(this.sprite.atlas){var o=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];if(o){s=o.rect.z;a=o.rect.w;n=(.5-o.pivot.x)*this._width;r=(.5-o.pivot.y)*this._height}}var l=s/this.sprite.pixelsPerUnit;var h=a/this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*l),Math.max(this._height,this._innerOffset.y*h));t*=l;i*=h;this._outerScale.x/=l;this._outerScale.y/=h;t*=Pe.clamp(this._width/(this._innerOffset.x*l),1e-4,1);i*=Pe.clamp(this._height/(this._innerOffset.y*h),1e-4,1);if(this._meshInstance){this._outerScaleUniform[0]=this._outerScale.x;this._outerScaleUniform[1]=this._outerScale.y;this._meshInstance.setParameter(G1,this._outerScaleUniform)}}this._node.setLocalScale(t,i,1);this._node.setLocalPosition(n,r,0)};t._updateAabb=function e(t){t.center.set(0,0,0);t.halfExtents.set(this._outerScale.x*.5,this._outerScale.y*.5,.001);t.setFromTransformedAabb(t,this._node.getWorldTransform());return t};t._tryAutoPlay=function e(){if(!this._autoPlayClip)return;if(this.type!==O1)return;var t=this._clips[this._autoPlayClip];if(t&&!t.isPlaying&&(!this._currentClip||!this._currentClip.isPlaying))if(this.enabled&&this.entity.enabled)this.play(t.name)};t._onLayersChanged=function e(t,i){t.off("add",this.onLayerAdded,this);t.off("remove",this.onLayerRemoved,this);i.on("add",this.onLayerAdded,this);i.on("remove",this.onLayerRemoved,this);if(this.enabled&&this.entity.enabled)this._showModel()};t._onLayerAdded=function e(t){var i=this.layers.indexOf(t.id);if(i<0)return;if(this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance)t.addMeshInstances([this._meshInstance])};t._onLayerRemoved=function e(t){if(!this._meshInstance)return;var i=this.layers.indexOf(t.id);if(i<0)return;t.removeMeshInstances([this._meshInstance])};t.removeModelFromLayers=function e(){var t;for(var i=0;i<this.layers.length;i++){t=this.system.app.scene.layers.getLayerById(this.layers[i]);if(!t)continue;t.removeMeshInstances([this._meshInstance])}};t.addClip=function e(t){var i=new F1(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});this._clips[t.name]=i;if(i.name&&i.name===this._autoPlayClip)this._tryAutoPlay();return i};t.removeClip=function e(t){delete this._clips[t]};t.clip=function e(t){return this._clips[t]};t.play=function e(t){var i=this._clips[t];var n=this._currentClip;if(n&&n!==i)n._playing=false;this._currentClip=i;if(this._currentClip){this._currentClip=i;this._currentClip.play()}return i};t.pause=function e(){if(this._currentClip===this._defaultClip)return;if(this._currentClip.isPlaying)this._currentClip.pause()};t.resume=function e(){if(this._currentClip===this._defaultClip)return;if(this._currentClip.isPaused)this._currentClip.resume()};t.stop=function e(){if(this._currentClip===this._defaultClip)return;this._currentClip.stop()};U(e,[{key:"type",get:function e(){return this._type},set:function e(t){if(this._type===t)return;this._type=t;if(this._type===k1){this.stop();this._currentClip=this._defaultClip;if(this.enabled&&this.entity.enabled){this._currentClip.frame=this.frame;if(this._currentClip.sprite)this._showModel();else this._hideModel()}}else if(this._type===O1){this.stop();if(this._autoPlayClip)this._tryAutoPlay();if(this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled)this._showModel();else this._hideModel()}}},{key:"frame",get:function e(){return this._currentClip.frame},set:function e(t){this._currentClip.frame=t}},{key:"spriteAsset",get:function e(){return this._defaultClip._spriteAsset},set:function e(t){this._defaultClip.spriteAsset=t}},{key:"sprite",get:function e(){return this._currentClip.sprite},set:function e(t){this._currentClip.sprite=t}},{key:"material",get:function e(){return this._material},set:function e(t){this._material=t;if(this._meshInstance)this._meshInstance.material=t}},{key:"color",get:function e(){return this._color},set:function e(t){this._color.r=t.r;this._color.g=t.g;this._color.b=t.b;if(this._meshInstance){this._colorUniform[0]=this._color.r;this._colorUniform[1]=this._color.g;this._colorUniform[2]=this._color.b;this._meshInstance.setParameter(z1,this._colorUniform)}}},{key:"opacity",get:function e(){return this._color.a},set:function e(t){this._color.a=t;if(this._meshInstance)this._meshInstance.setParameter(V1,t)}},{key:"clips",get:function e(){return this._clips},set:function e(t){var i,n;if(!t){for(i in this._clips)this.removeClip(i);return}for(i in this._clips){var r=false;for(n in t)if(t[n].name===i){r=true;this._clips[i].fps=t[n].fps;this._clips[i].loop=t[n].loop;if(t[n].hasOwnProperty("sprite"))this._clips[i].sprite=t[n].sprite;else if(t[n].hasOwnProperty("spriteAsset"))this._clips[i].spriteAsset=t[n].spriteAsset;break}if(!r)this.removeClip(i)}for(n in t){if(this._clips[t[n].name])continue;this.addClip(t[n])}if(this._autoPlayClip)this._tryAutoPlay();if(!this._currentClip||!this._currentClip.sprite)this._hideModel()}},{key:"currentClip",get:function e(){return this._currentClip}},{key:"speed",get:function e(){return this._speed},set:function e(t){this._speed=t}},{key:"flipX",get:function e(){return this._flipX},set:function e(t){if(this._flipX===t)return;this._flipX=t;this._updateTransform()}},{key:"flipY",get:function e(){return this._flipY},set:function e(t){if(this._flipY===t)return;this._flipY=t;this._updateTransform()}},{key:"width",get:function e(){return this._width},set:function e(t){if(t===this._width)return;this._width=t;this._outerScale.x=this._width;if(this.sprite&&(this.sprite.renderMode===gc||this.sprite.renderMode===vc))this._updateTransform()}},{key:"height",get:function e(){return this._height},set:function e(t){if(t===this._height)return;this._height=t;this._outerScale.y=this.height;if(this.sprite&&(this.sprite.renderMode===gc||this.sprite.renderMode===vc))this._updateTransform()}},{key:"batchGroupId",get:function e(){return this._batchGroupId},set:function e(t){if(this._batchGroupId===t)return;var i=this._batchGroupId;this._batchGroupId=t;if(this.entity.enabled&&i>=0)this.system.app.batcher.remove(Yu.SPRITE,i,this.entity);if(this.entity.enabled&&t>=0)this.system.app.batcher.insert(Yu.SPRITE,t,this.entity);else if(i>=0)if(this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled)this._showModel()}},{key:"autoPlayClip",get:function e(){return this._autoPlayClip},set:function e(t){this._autoPlayClip=t instanceof F1?t.name:t;this._tryAutoPlay()}},{key:"drawOrder",get:function e(){return this._drawOrder},set:function e(t){this._drawOrder=t;if(this._meshInstance)this._meshInstance.drawOrder=t}},{key:"layers",get:function e(){return this._layers},set:function e(t){if(this._addedModel)this._hideModel();this._layers=t;if(!this._meshInstance)return;if(this.enabled&&this.entity.enabled)this._showModel()}},{key:"aabb",get:function e(){if(this._meshInstance)return this._meshInstance.aabb;return null}}]);return e}(R0),j1=function e(){this.enabled=true},X1=["enabled"],q1=function(s){G(e,s);function e(e){var t;t=s.call(this,e)||this;t.id="sprite";t.ComponentType=W1;t.DataType=j1;t.schema=X1;t._defaultTexture=null;t._defaultMaterial=null;t._default9SlicedMaterialSlicedMode=null;t._default9SlicedMaterialTiledMode=null;L0.bind("update",t.onUpdate,H(t));t.on("beforeremove",t.onBeforeRemove,H(t));return t}var t=e.prototype;t.destroy=function e(){if(this._defaultTexture){this._defaultTexture.destroy();this._defaultTexture=null}};t.initializeComponentData=function e(t,i,n){if(i.enabled!==undefined)t.enabled=i.enabled;t.type=i.type;if(i.layers&&Array.isArray(i.layers))t.layers=i.layers.slice(0);if(i.drawOrder!==undefined)t.drawOrder=i.drawOrder;if(i.color!==undefined){if(i.color instanceof ge)t.color.set(i.color.r,i.color.g,i.color.b,i.opacity!==undefined?i.opacity:1);else t.color.set(i.color[0],i.color[1],i.color[2],i.opacity!==undefined?i.opacity:1);t.color=t.color}if(i.opacity!==undefined)t.opacity=i.opacity;if(i.flipX!==undefined)t.flipX=i.flipX;if(i.flipY!==undefined)t.flipY=i.flipY;if(i.width!==undefined)t.width=i.width;if(i.height!==undefined)t.height=i.height;if(i.spriteAsset!==undefined)t.spriteAsset=i.spriteAsset;if(i.sprite)t.sprite=i.sprite;if(i.frame!==undefined)t.frame=i.frame;if(i.clips)for(var r in i.clips)t.addClip(i.clips[r]);if(i.speed!==undefined)t.speed=i.speed;if(i.autoPlayClip)t.autoPlayClip=i.autoPlayClip;t.batchGroupId=i.batchGroupId===undefined||i.batchGroupId===null?-1:i.batchGroupId;s.prototype.initializeComponentData.call(this,t,i,n)};t.cloneComponent=function e(t,i){var n=t.sprite;return this.addComponent(i,{enabled:n.enabled,type:n.type,spriteAsset:n.spriteAsset,sprite:n.sprite,frame:n.frame,color:n.color.clone(),opacity:n.opacity,flipX:n.flipX,flipY:n.flipY,speed:n.speed,clips:n.clips,autoPlayClip:n.autoPlayClip,batchGroupId:n.batchGroupId,drawOrder:n.drawOrder,layers:n.layers.slice(0)})};t.onUpdate=function e(t){var i=this.store;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];if(r.data.enabled&&r.entity.enabled){var s=r.entity.sprite;if(s._currentClip)s._currentClip._update(t)}}};t.onBeforeRemove=function e(t,i){i.onDestroy()};U(e,[{key:"defaultMaterial",get:function e(){if(!this._defaultMaterial){var t=new bu(this.app.graphicsDevice,{width:1,height:1,format:Kt});var i=new Uint8Array(t.lock());i[0]=i[1]=i[2]=i[3]=255;t.name="sprite";t.unlock();var n=new pM;n.diffuse.set(0,0,0);n.emissive.set(.5,.5,.5);n.emissiveMap=t;n.emissiveMapTint=true;n.opacityMap=t;n.opacityMapChannel="a";n.opacityTint=true;n.opacity=0;n.useLighting=false;n.useGammaTonemap=false;n.useFog=false;n.useSkybox=false;n.blendType=_l;n.depthWrite=false;n.pixelSnap=false;n.cull=xt;n.update();this._defaultTexture=t;this._defaultMaterial=n}return this._defaultMaterial},set:function e(t){this._defaultMaterial=t}},{key:"default9SlicedMaterialSlicedMode",get:function e(){if(!this._default9SlicedMaterialSlicedMode){var t=this.defaultMaterial.clone();t.nineSlicedMode=vc;t.update();this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode},set:function e(t){this._default9SlicedMaterialSlicedMode=t}},{key:"default9SlicedMaterialTiledMode",get:function e(){if(!this._default9SlicedMaterialTiledMode){var t=this.defaultMaterial.clone();t.nineSlicedMode=gc;t.update();this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode},set:function e(t){this._default9SlicedMaterialTiledMode=t}}]);return e}(L0);R0._buildAccessors(W1.prototype,X1);var Y1=function(n){G(e,n);function e(e,t){var i;i=n.call(this,e,t)||this;i._oldState=true;i._size=new ce;i.on("set_enabled",i._onSetEnabled,H(i));return i}var t=e.prototype;t.onEnable=function e(){this._checkState()};t.onDisable=function e(){this._checkState()};t._onSetEnabled=function e(t,i,n){this._checkState()};t._checkState=function e(){var t=this.enabled&&this.entity.enabled;if(t===this._oldState)return;this._oldState=t;this.fire("enable");this.fire("state",this.enabled)};t._onBeforeRemove=function e(){this.fire("remove")};U(e,[{key:"size",set:function e(t){if(t instanceof ce)this._size.copy(t);else if(t instanceof Array&&t.length>=3)this.size.set(t[0],t[1],t[2])},get:function e(){return this._size}}]);return e}(R0),K1=function e(){this.enabled=true},Q1=["enabled"],$1=function(i){G(e,i);function e(e){var t;t=i.call(this,e)||this;t.id="zone";t.ComponentType=Y1;t.DataType=K1;t.schema=Q1;t.on("beforeremove",t._onBeforeRemove,H(t));return t}var t=e.prototype;t.initializeComponentData=function e(t,i,n){t.enabled=i.hasOwnProperty("enabled")?!!i.enabled:true;if(i.size)if(i.size instanceof ce)t.size.copy(i.size);else if(i.size instanceof Array&&i.size.length>=3)t.size.set(i.size[0],i.size[1],i.size[2])};t.cloneComponent=function e(t,i){var n={size:t.zone.size};return this.addComponent(i,n)};t._onBeforeRemove=function e(t,i){i._onBeforeRemove()};return e}(L0);R0._buildAccessors(Y1.prototype,Q1);var Z1=function(){function e(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0};this.shaders=e._shaderStats;this.vram=e._vram;Object.defineProperty(this.vram,"totalUsed",{get:function e(){return this.tex+this.vb+this.ib}});Object.defineProperty(this.vram,"geom",{get:function e(){return this.vb+this.ib}})}U(e,[{key:"scene",get:function e(){return rM.getApplication().scene._stats}},{key:"lightmapper",get:function e(){return rM.getApplication().lightmapper._stats}},{key:"batcher",get:function e(){return rM.getApplication().batcher._stats}}]);return e}(),J1=function e(t,i){this.name=t;this.url=i},eM=function(){function e(e){this._app=e;this._list=[];this._index={};this._urlIndex={}}var t=e.prototype;t.destroy=function e(){this._app=null};t.list=function e(){return this._list};t.add=function e(t,i){if(this._index.hasOwnProperty(t))return false;var n=new J1(t,i);var r=this._list.push(n);this._index[n.name]=r-1;this._urlIndex[n.url]=r-1;return true};t.find=function e(t){if(this._index.hasOwnProperty(t))return this._list[this._index[t]];return null};t.findByUrl=function e(t){if(this._urlIndex.hasOwnProperty(t))return this._list[this._urlIndex[t]];return null};t.remove=function e(t){if(this._index.hasOwnProperty(t)){var i=this._index[t];var n=this._list[i];delete this._urlIndex[n.url];delete this._index[t];this._list.splice(i,1);for(i=0;i<this._list.length;i++){n=this._list[i];this._index[n.name]=i;this._urlIndex[n.url]=i}}};t.loadSceneHierarchy=function e(r,s){var a=this;var o=this._app.loader.getHandler("hierarchy");if(this._app.assets&&this._app.assets.prefix&&!p_.test(r))r=p.join(this._app.assets.prefix,r);o.load(r,function(i,n){if(i){if(s)s(i);return}var e=function e(){a._app.systems.script.preloading=true;var t=o.open(r,n);a._app.systems.script.preloading=false;a._app.loader.clearCache(r,"hierarchy");a._app.root.addChild(t);L0.initialize(t);L0.postInitialize(t);if(s)s(i,t)};a._app._preloadScripts(n,e)})};t.loadSceneSettings=function e(t,i){var n=this;if(this._app.assets&&this._app.assets.prefix&&!p_.test(t))t=p.join(this._app.assets.prefix,t);this._app.loader.load(t,"scenesettings",function(e,t){if(!e){n._app.applySceneSettings(t);if(i)i(null)}else if(i)i(e)})};t.loadScene=function e(n,r){var s=this;var a=this._app.loader.getHandler("scene");if(this._app.assets&&this._app.assets.prefix&&!p_.test(n))n=p.join(this._app.assets.prefix,n);a.load(n,function(e,i){if(!e){var t=function e(){s._app.systems.script.preloading=true;var t=a.open(n,i);s._app.systems.script.preloading=false;s._app.loader.clearCache(n,"scene");s._app.loader.patch({resource:t,type:"scene"},s._app.assets);s._app.root.addChild(t.root);if(s._app.systems.rigidbody&&typeof Ammo!=="undefined")s._app.systems.rigidbody.gravity.set(t._gravity.x,t._gravity.y,t._gravity.z);if(r)r(null,t)};s._app._preloadScripts(i,t)}else if(r)r(e)})};return e}(),tM=function(){function e(e){this.length=e;this.count=0}var t=e.prototype;t.inc=function e(){this.count++};t.done=function e(){return this.count===this.length};return e}(),iM=false,nM=new Mf;o.app=null;var rM=function(n){G(h,n);function h(e,t){var i;if(t===void 0)t={};i=n.call(this)||this;console.log("Powered by PlayCanvas "+r+" "+s);h._applications[e.id]=H(i);h._currentApplication=H(i);o.app=H(i);i._time=0;i.timeScale=1;i.maxDeltaTime=.1;i.frame=0;i.autoRender=true;i.renderNextFrame=false;i.useLegacyScriptAttributeCloning=Og.legacy;i._librariesLoaded=false;i._fillMode=Oy;i._resolutionMode=By;i._allowResize=true;i.context=H(i);if(!t.graphicsDeviceOptions)t.graphicsDeviceOptions={};t.graphicsDeviceOptions.xrCompatible=true;t.graphicsDeviceOptions.alpha=t.graphicsDeviceOptions.alpha||false;i.graphicsDevice=new OM(e,t.graphicsDeviceOptions);i.stats=new Z1(i.graphicsDevice);i._soundManager=new Xm(t);i.loader=new Ig(H(i));i._entityIndex={};i.scene=new km;i.root=new Nv(H(i));i.root._enabledInHierarchy=true;i._enableList=[];i._enableList.size=0;i.assets=new Py(i.loader);if(t.assetPrefix)i.assets.prefix=t.assetPrefix;i.bundles=new Ey(i.assets);i.enableBundles=typeof TextDecoder!=="undefined";i.scriptsOrder=t.scriptsOrder||[];i.scripts=new Iy(H(i));i.i18n=new Ly(H(i));i.scenes=new eM(H(i));var g=H(i);i.defaultLayerWorld=new Vf({name:"World",id:Dl});if(i.graphicsDevice.webgl2){i.defaultLayerDepth=new Vf({enabled:false,name:"Depth",id:kl,onEnable:function e(){if(this.renderTarget)return;var t=new bu(g.graphicsDevice,{format:si,width:g.graphicsDevice.width,height:g.graphicsDevice.height});t.name="rt-depth2";t.minFilter=Mt;t.magFilter=Mt;t.addressU=We;t.addressV=We;this.renderTarget=new BM({colorBuffer:null,depthBuffer:t,autoResolve:false});g.graphicsDevice.scope.resolve("uDepthMap").setValue(t)},onDisable:function e(){if(!this.renderTarget)return;this.renderTarget._depthBuffer.destroy();this.renderTarget.destroy();this.renderTarget=null},onPreRenderOpaque:function e(t){var i=g.graphicsDevice.gl;this.srcFbo=i.getParameter(i.FRAMEBUFFER_BINDING);if(!this.renderTarget||this.renderTarget.width!==g.graphicsDevice.width||this.renderTarget.height!==g.graphicsDevice.height){this.onDisable();this.onEnable()}this.oldClear=this.cameras[t].camera._clearOptions;this.cameras[t].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function e(t){if(!this.renderTarget)return;this.cameras[t].camera._clearOptions=this.oldClear;var i=g.graphicsDevice.gl;g.graphicsDevice.setRenderTarget(this.renderTarget);g.graphicsDevice.updateBegin();i.bindFramebuffer(i.READ_FRAMEBUFFER,this.srcFbo);i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer);i.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,i.DEPTH_BUFFER_BIT,i.NEAREST)}});i.defaultLayerDepth.depthClearOptions={flags:0}}else{i.defaultLayerDepth=new Vf({enabled:false,name:"Depth",id:kl,shaderPass:fc,onEnable:function e(){if(this.renderTarget)return;var t=new bu(g.graphicsDevice,{format:Kt,width:g.graphicsDevice.width,height:g.graphicsDevice.height});t.name="rt-depth1";t.minFilter=Mt;t.magFilter=Mt;t.addressU=We;t.addressV=We;this.renderTarget=new BM(g.graphicsDevice,t,{depth:true,stencil:g.graphicsDevice.supportsStencil});g.graphicsDevice.scope.resolve("uDepthMap").setValue(t)},onDisable:function e(){if(!this.renderTarget)return;this.renderTarget._colorBuffer.destroy();this.renderTarget.destroy();this.renderTarget=null},onPostCull:function e(t){var i=this.instances.visibleOpaque[t];var n=i.list;var r=0;var s=g.scene.layers.layerList;var a=g.scene.layers.subLayerEnabled;var o=g.scene.layers.subLayerList;var l=g.scene.layers.getLayerById(Dl).renderTarget;var h=this.cameras[t];var c;var u;var f,d,p,m,_;for(var v=0;v<s.length;v++){c=s[v];if(c===this)break;if(c.renderTarget!==l||!c.enabled||!a[v])continue;d=c.cameras.indexOf(h);if(d<0)continue;_=o[v];f=_?c.instances.visibleTransparent[d]:c.instances.visibleOpaque[d];p=f.length;f=f.list;for(u=0;u<p;u++){m=f[u];if(m.material&&m.material.depthWrite&&!m._noDepthDrawGl1){n[r]=m;r++}}}i.length=r},onPreRenderOpaque:function e(t){if(!this.renderTarget||this.renderTarget.width!==g.graphicsDevice.width||this.renderTarget.height!==g.graphicsDevice.height){this.onDisable();this.onEnable()}this.oldClear=this.cameras[t].camera._clearOptions;this.cameras[t].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function e(){g.graphicsDevice.setColorWrite(true,true,true,true)},onPostRenderOpaque:function e(t){if(!this.renderTarget)return;this.cameras[t].camera._clearOptions=this.oldClear}});i.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:ft|dt}}i.defaultLayerSkybox=new Vf({enabled:false,name:"Skybox",id:Ol,opaqueSortMode:Tc});i.defaultLayerUi=new Vf({enabled:true,name:"UI",id:Bl,transparentSortMode:Mc,passThrough:false});i.defaultLayerImmediate=new Vf({enabled:true,name:"Immediate",id:Fl,opaqueSortMode:Tc,passThrough:true});i.defaultLayerComposition=new ep;i.defaultLayerComposition.pushOpaque(i.defaultLayerWorld);i.defaultLayerComposition.pushOpaque(i.defaultLayerDepth);i.defaultLayerComposition.pushOpaque(i.defaultLayerSkybox);i.defaultLayerComposition.pushTransparent(i.defaultLayerWorld);i.defaultLayerComposition.pushOpaque(i.defaultLayerImmediate);i.defaultLayerComposition.pushTransparent(i.defaultLayerImmediate);i.defaultLayerComposition.pushTransparent(i.defaultLayerUi);i.scene.layers=i.defaultLayerComposition;i._immediateLayer=i.defaultLayerImmediate;i.scene.on("set:layers",function(e,t){var i=t.layerList;var n;for(var r=0;r<i.length;r++){n=i[r];switch(n.id){case kl:n.onEnable=g.defaultLayerDepth.onEnable;n.onDisable=g.defaultLayerDepth.onDisable;n.onPreRenderOpaque=g.defaultLayerDepth.onPreRenderOpaque;n.onPostRenderOpaque=g.defaultLayerDepth.onPostRenderOpaque;n.depthClearOptions=g.defaultLayerDepth.depthClearOptions;n.rgbaDepthClearOptions=g.defaultLayerDepth.rgbaDepthClearOptions;n.shaderPass=g.defaultLayerDepth.shaderPass;n.onPostCull=g.defaultLayerDepth.onPostCull;n.onDrawCall=g.defaultLayerDepth.onDrawCall;break;case Bl:n.passThrough=g.defaultLayerUi.passThrough;break;case Fl:n.passThrough=g.defaultLayerImmediate.passThrough;break}}});i.renderer=new Yd(i.graphicsDevice);i.renderer.scene=i.scene;i.lightmapper=new _p(i.graphicsDevice,i.root,i.scene,i.renderer,i.assets);i.once("prerender",i._firstBake,H(i));i.batcher=new rf(i.graphicsDevice,i.root,i.scene);i.once("prerender",i._firstBatch,H(i));i.keyboard=t.keyboard||null;i.mouse=t.mouse||null;i.touch=t.touch||null;i.gamepads=t.gamepads||null;i.elementInput=t.elementInput||null;if(i.elementInput)i.elementInput.app=H(i);i.vr=null;i.xr=new I0(H(i));if(i.elementInput)i.elementInput.attachSelectEvents();i._inTools=false;i._skyboxLast=0;i._scriptPrefix=t.scriptPrefix||"";if(i.enableBundles)i.loader.addHandler("bundle",new Bv(i.assets));i.loader.addHandler("animation",new Sv);i.loader.addHandler("animclip",new wv);i.loader.addHandler("animstategraph",new Mv);i.loader.addHandler("model",new Tg(i.graphicsDevice,i.scene.defaultMaterial));i.loader.addHandler("render",new Eg(i.assets));i.loader.addHandler("material",new pg(H(i)));i.loader.addHandler("texture",new Cy(i.graphicsDevice,i.assets,i.loader));i.loader.addHandler("text",new Xg);i.loader.addHandler("json",new rg);i.loader.addHandler("audio",new Ev(i._soundManager));i.loader.addHandler("script",new Fg(H(i)));i.loader.addHandler("scene",new Rg(H(i)));i.loader.addHandler("cubemap",new Wv(i.graphicsDevice,i.assets,i.loader));i.loader.addHandler("html",new ng);i.loader.addHandler("css",new Gv);i.loader.addHandler("shader",new Bg);i.loader.addHandler("hierarchy",new ig(H(i)));i.loader.addHandler("scenesettings",new Lg(H(i)));i.loader.addHandler("folder",new jv);i.loader.addHandler("font",new Qv(i.loader));i.loader.addHandler("binary",new Iv);i.loader.addHandler("textureatlas",new $g(i.loader));i.loader.addHandler("sprite",new Hg(i.assets,i.graphicsDevice));i.loader.addHandler("template",new jg(H(i)));i.loader.addHandler("container",new Uv(i.graphicsDevice,i.scene.defaultMaterial));i.systems=new nS;i.systems.add(new pT(H(i)));i.systems.add(new iS(H(i)));i.systems.add(new j0(H(i)));i.systems.add(new Lb(H(i)));i.systems.add(new Fw(H(i)));i.systems.add(new Uw(H(i)));i.systems.add(new rx(H(i)));i.systems.add(new Lw(H(i)));if(Og.legacy)i.systems.add(new XT(H(i)));else i.systems.add(new kT(H(i)));i.systems.add(new Vb(H(i),i._soundManager));i.systems.add(new D1(H(i),i._soundManager));i.systems.add(new Fb(H(i),i._soundManager));i.systems.add(new Qw(H(i)));i.systems.add(new xT(H(i)));i.systems.add(new YS(H(i)));i.systems.add(new Zb(H(i)));i.systems.add(new f1(H(i)));i.systems.add(new _1(H(i)));i.systems.add(new q1(H(i)));i.systems.add(new yw(H(i)));i.systems.add(new JS(H(i)));i.systems.add(new $1(H(i)));i._visibilityChangeHandler=i.onVisibilityChange.bind(H(i));if(typeof document!=="undefined")if(document.hidden!==undefined){i._hiddenAttr="hidden";document.addEventListener("visibilitychange",i._visibilityChangeHandler,false)}else if(document.mozHidden!==undefined){i._hiddenAttr="mozHidden";document.addEventListener("mozvisibilitychange",i._visibilityChangeHandler,false)}else if(document.msHidden!==undefined){i._hiddenAttr="msHidden";document.addEventListener("msvisibilitychange",i._visibilityChangeHandler,false)}else if(document.webkitHidden!==undefined){i._hiddenAttr="webkitHidden";document.addEventListener("webkitvisibilitychange",i._visibilityChangeHandler,false)}i.meshInstanceArray=[];i.tick=aM(H(i));return i}h.getApplication=function e(t){return t?h._applications[t]:h._currentApplication};var e=h.prototype;e.configure=function e(t,s){var a=this;Z.get(t,function(e,t){if(e){s(e);return}var i=t.application_properties;var n=t.scenes;var r=t.assets;a._parseApplicationProperties(i,function(e){a._parseScenes(n);a._parseAssets(r);if(!e)s(null);else s(e)})})};e.preload=function e(t){var n=this;var i,r;n.fire("preload:start");var s=this.assets.list({preload:true});var a=new tM(s.length);var o=false;var l=function e(){if(!n.graphicsDevice)return;if(!o&&a.done()){o=true;n.fire("preload:end");t()}};r=s.length;var h=function e(){return a.count};if(a.length){var c=function e(t){a.inc();n.fire("preload:progress",h()/r);if(a.done())l()};var u=function e(t,i){a.inc();n.fire("preload:progress",h()/r);if(a.done())l()};for(i=0;i<s.length;i++)if(!s[i].loaded){s[i].once("load",c);s[i].once("error",u);this.assets.load(s[i])}else{a.inc();n.fire("preload:progress",h()/r);if(a.done())l()}}else l()};e._preloadScripts=function e(t,n){if(!Og.legacy){n();return}var r=this;r.systems.script.preloading=true;var i=this._getScriptReferences(t);var s=0,a=i.length;var o=new tM(a);var l;var h=/^http(s)?:\/\//;if(a){var c=function e(t,i){if(t)console.error(t);o.inc();if(o.done()){r.systems.script.preloading=false;n()}};for(s=0;s<a;s++){l=i[s];if(!h.test(l.toLowerCase())&&r._scriptPrefix)l=p.join(r._scriptPrefix,i[s]);this.loader.load(l,"script",c)}}else{r.systems.script.preloading=false;n()}};e._parseApplicationProperties=function e(t,i){var n;var r;if(typeof t.maxAssetRetries==="number"&&t.maxAssetRetries>0)this.loader.enableRetry(t.maxAssetRetries);if(!t.useDevicePixelRatio)t.useDevicePixelRatio=t.use_device_pixel_ratio;if(!t.resolutionMode)t.resolutionMode=t.resolution_mode;if(!t.fillMode)t.fillMode=t.fill_mode;this._width=t.width;this._height=t.height;if(t.useDevicePixelRatio)this.graphicsDevice.maxPixelRatio=window.devicePixelRatio;this.setCanvasResolution(t.resolutionMode,this._width,this._height);this.setCanvasFillMode(t.fillMode,this._width,this._height);if(t.layers&&t.layerOrder){var s=new ep;var a={};for(var o in t.layers){var l=t.layers[o];l.id=parseInt(o,10);l.enabled=l.id!==kl;a[o]=new Vf(l)}for(n=0,r=t.layerOrder.length;n<r;n++){var h=t.layerOrder[n];var c=a[h.layer];if(!c)continue;if(h.transparent)s.pushTransparent(c);else s.pushOpaque(c);s.subLayerEnabled[n]=h.enabled}this.scene.layers=s}if(t.batchGroups)for(n=0,r=t.batchGroups.length;n<r;n++){var u=t.batchGroups[n];this.batcher.addGroup(u.name,u.dynamic,u.maxAabbSize,u.id,u.layers)}if(t.i18nAssets)this.i18n.assets=t.i18nAssets;this._loadLibraries(t.libraries,i)};e._loadLibraries=function e(t,n){var i=t.length;var r=i;var s=this;var a=/^http(s)?:\/\//;if(i){var o=function e(t,i){r--;if(t)n(t);else if(r===0){s.onLibrariesLoaded();n(null)}};for(var l=0;l<i;++l){var h=t[l];if(!a.test(h.toLowerCase())&&s._scriptPrefix)h=p.join(s._scriptPrefix,h);this.loader.load(h,"script",o)}}else{s.onLibrariesLoaded();n(null)}};e._parseScenes=function e(t){if(!t)return;for(var i=0;i<t.length;i++)this.scenes.add(t[i].name,t[i].url)};e._parseAssets=function e(t){var i,n;var r=[];var s={};var a={};if(!Og.legacy){for(i=0;i<this.scriptsOrder.length;i++){n=this.scriptsOrder[i];if(!t[n])continue;s[n]=true;r.push(t[n])}if(this.enableBundles)for(n in t)if(t[n].type==="bundle"){a[n]=true;r.push(t[n])}for(n in t){if(s[n]||a[n])continue;r.push(t[n])}}else{if(this.enableBundles)for(n in t)if(t[n].type==="bundle"){a[n]=true;r.push(t[n])}for(n in t){if(a[n])continue;r.push(t[n])}}for(i=0;i<r.length;i++){var o=r[i];var l=new O_(o.name,o.type,o.file,o.data);l.id=parseInt(o.id,10);l.preload=o.preload?o.preload:false;l.loaded=o.type==="script"&&o.data&&o.data.loadingType>0;l.tags.add(o.tags);if(o.i18n)for(var h in o.i18n)l.addLocalizedAssetId(h,o.i18n[h]);this.assets.add(l)}};e._getScriptReferences=function e(t){var i,n;var r=[];if(t.settings.priority_scripts)r=t.settings.priority_scripts;var s=[];var a={};for(i=0;i<r.length;i++){s.push(r[i]);a[r[i]]=true}var o=t.entities;for(n in o){if(!o[n].components.script)continue;var l=o[n].components.script.scripts;for(i=0;i<l.length;i++){if(a[l[i].url])continue;s.push(l[i].url);a[l[i].url]=true}}return s};e.start=function e(){this.frame=0;this.fire("start",{timestamp:ye(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();L0.initialize(this.root);this.fire("initialize");L0.postInitialize(this.root);this.fire("postinitialize");this.tick()};e.update=function e(t){this.frame++;this.graphicsDevice.updateClientRect();if(this.vr)this.vr.poll();if(Og.legacy)L0.fixedUpdate(1/60,this._inTools);L0.update(t,this._inTools);L0.animationUpdate(t,this._inTools);L0.postUpdate(t,this._inTools);this.fire("update",t);if(this.controller)this.controller.update(t);if(this.mouse)this.mouse.update(t);if(this.keyboard)this.keyboard.update(t);if(this.gamepads)this.gamepads.update(t)};e.render=function e(){this.fire("prerender");this.root.syncHierarchy();this.batcher.updateAll();this.renderer.renderComposition(this.scene.layers);this.fire("postrender")};e._fillFrameStatsBasic=function e(t,i,n){var r=this.stats.frame;r.dt=i;r.ms=n;if(t>r._timeToCountFrames){r.fps=r._fpsAccum;r._fpsAccum=0;r._timeToCountFrames=t+1e3}else r._fpsAccum++;this.stats.drawCalls.total=this.graphicsDevice._drawCallsPerFrame;this.graphicsDevice._drawCallsPerFrame=0};e._fillFrameStats=function e(){var t=this.stats.frame;t.cameras=this.renderer._camerasRendered;t.materials=this.renderer._materialSwitches;t.shaders=this.graphicsDevice._shaderSwitchesPerFrame;t.shadowMapUpdates=this.renderer._shadowMapUpdates;t.shadowMapTime=this.renderer._shadowMapTime;t.depthMapTime=this.renderer._depthMapTime;t.forwardTime=this.renderer._forwardTime;var i=this.graphicsDevice._primsPerFrame;t.triangles=i[wi]/3+Math.max(i[Ti]-2,0)+Math.max(i[Mi]-2,0);t.cullTime=this.renderer._cullTime;t.sortTime=this.renderer._sortTime;t.skinTime=this.renderer._skinTime;t.morphTime=this.renderer._morphTime;t.instancingTime=this.renderer._instancingTime;t.otherPrimitives=0;for(var n=0;n<i.length;n++){if(n<wi)t.otherPrimitives+=i[n];i[n]=0}this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;this.renderer._layerCompositionUpdateTime=0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;t=this.stats.drawCalls;t.forward=this.renderer._forwardDrawCalls;t.culled=this.renderer._numDrawCallsCulled;t.depth=0;t.shadow=this.renderer._shadowDrawCalls;t.skinned=this.renderer._skinDrawCalls;t.immediate=0;t.instanced=0;t.removedByInstancing=0;t.misc=t.total-(t.forward+t.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._numDrawCallsCulled=0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;t=this.stats.particles;t.updatesPerFrame=t._updatesPerFrame;t.frameTime=t._frameTime;t._updatesPerFrame=0;t._frameTime=0};e.setCanvasFillMode=function e(t,i,n){this._fillMode=t;this.resizeCanvas(i,n)};e.setCanvasResolution=function e(t,i,n){this._resolutionMode=t;if(t===Fy&&i===undefined){i=this.graphicsDevice.canvas.clientWidth;n=this.graphicsDevice.canvas.clientHeight}this.graphicsDevice.resizeCanvas(i,n)};e.isHidden=function e(){return document[this._hiddenAttr]};e.onVisibilityChange=function e(){if(this.isHidden())this._soundManager.suspend();else this._soundManager.resume()};e.resizeCanvas=function e(t,i){if(!this._allowResize)return;if(this.xr&&this.xr.session)return;var n=window.innerWidth;var r=window.innerHeight;if(this._fillMode===Oy){var s=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;var a=n/r;if(s>a){t=n;i=t/s}else{i=r;t=i*s}}else if(this._fillMode===ky){t=n;i=r}this.graphicsDevice.canvas.style.width=t+"px";this.graphicsDevice.canvas.style.height=i+"px";if(this._resolutionMode===Fy)this.setCanvasResolution(Fy);return{width:t,height:i}};e.onLibrariesLoaded=function e(){this._librariesLoaded=true;this.systems.rigidbody.onLibraryLoaded()};e.applySceneSettings=function e(t){var i;if(this.systems.rigidbody&&typeof Ammo!=="undefined"){var n=t.physics.gravity;this.systems.rigidbody.gravity.set(n[0],n[1],n[2])}this.scene.applySettings(t);if(t.render.hasOwnProperty("skybox"))if(t.render.skybox){i=this.assets.get(t.render.skybox);if(i)this.setSkybox(i);else this.assets.once("add:"+t.render.skybox,this.setSkybox,this)}else this.setSkybox(null)};e.setSkybox=function e(t){if(t){if(this._skyboxLast===t.id){if(this.scene.skyboxMip===0&&!t.loadFaces)this._skyboxLoad(t);else this._onSkyboxChange(t);return}if(this._skyboxLast){this.assets.off("add:"+this._skyboxLast,this.setSkybox,this);this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this);this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)}this._skyboxLast=t.id;this.assets.on("load:"+t.id,this._onSkyboxChange,this);this.assets.once("remove:"+t.id,this._skyboxRemove,this);if(t.resource)this.scene.setSkybox(t.resources);this._skyboxLoad(t)}else{if(!this._skyboxLast)return;this._skyboxRemove({id:this._skyboxLast})}};e.enableVr=function e(){if(!this.vr)this.vr=new zy(this)};e.disableVr=function e(){if(this.vr){this.vr.destroy();this.vr=null}};e._onSkyboxChange=function e(t){this.scene.setSkybox(t.resources)};e._skyboxLoad=function e(t){if(this.scene.skyboxMip===0)t.loadFaces=true;this.assets.load(t);this._onSkyboxChange(t)};e._skyboxRemove=function e(t){if(!this._skyboxLast)return;this.assets.off("add:"+t.id,this.setSkybox,this);this.assets.off("load:"+t.id,this._onSkyboxChange,this);this.assets.off("remove:"+t.id,this._skyboxRemove,this);this.scene.setSkybox(null);this._skyboxLast=null};e._firstBake=function e(){this.lightmapper.bake(null,this.scene.lightmapMode)};e._firstBatch=function e(){if(this.scene._needsStaticPrepare){this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene);this.scene._needsStaticPrepare=false}this.batcher.generate()};e._processTimestamp=function e(t){return t};e._preRenderImmediate=function e(){for(var t=0;t<this._immediateData.lineBatches.length;t++)if(this._immediateData.lineBatches[t])this._immediateData.lineBatches[t].finalize(this.meshInstanceArray)};e._postRenderImmediate=function e(){for(var t=0;t<this._immediateData.layers.length;t++)this._immediateData.layers[t].clearMeshInstances(true);this._immediateData.layers.length=0};e._initImmediate=function e(){if(!this._immediateData){this._immediateData=new $d(this.graphicsDevice);this.on("prerender",this._preRenderImmediate,this);this.on("postrender",this._postRenderImmediate,this)}};e._addLines=function e(t,i,n){var r=n&&n.layer?n.layer:this.scene.layers.getLayerById(Fl);var s=n&&n.depthTest!==undefined?n.depthTest:true;var a=n&&n.mask?n.mask:undefined;this._initImmediate();this._immediateData.addLayer(r);var o=this._immediateData.getLayerIdx(r);if(o===undefined){var l=new Zd;l.init(this.graphicsDevice,this._immediateData.lineVertexFormat,r,t.length/2);l.material.depthTest=s;if(a)l.meshInstance.mask=a;o=this._immediateData.lineBatches.push(l)-1;this._immediateData.addLayerIdx(o,r)}else{this._immediateData.lineBatches[o].init(this.graphicsDevice,this._immediateData.lineVertexFormat,r,t.length/2);this._immediateData.lineBatches[o].material.depthTest=s;if(a)this._immediateData.lineBatches[o].meshInstance.mask=a}this._immediateData.lineBatches[o].addLines(t,i)};e.renderLine=function e(t,i,n){var r=n;var s;var a=arguments[3];var o=arguments[4];if(a instanceof ge){r=a;if(typeof o==="number"){if(!iM){console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead");iM=true}if(o===ec)s={layer:this.scene.layers.getLayerById(Fl),depthTest:false};else s={layer:this.scene.layers.getLayerById(Fl),depthTest:true}}else s=o}else if(typeof a==="number"){if(!iM){console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead");iM=true}r=n;if(a===ec)s={layer:this.scene.layers.getLayerById(Fl),depthTest:false};else s={layer:this.scene.layers.getLayerById(Fl),depthTest:true}}else if(a)s=a;this._addLines([t,i],[n,r],s)};e.renderLines=function e(t,i,n){if(!n)n={layer:this.scene.layers.getLayerById(Fl),depthTest:true};else if(typeof n==="number"){if(!iM){console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead");iM=true}if(n===ec)n={layer:this.scene.layers.getLayerById(Fl),depthTest:false};else n={layer:this.scene.layers.getLayerById(Fl),depthTest:true}}var r=!!i.length;if(r)if(t.length!==i.length){console.error("renderLines: position/color arrays have different lengths");return}if(t.length%2!==0){console.error("renderLines: array length is not divisible by 2");return}this._addLines(t,i,n)};e.renderWireCube=function e(t,i,n){var r;this._initImmediate();if(!this._immediateData.cubeLocalPos){var s=.5;this._immediateData.cubeLocalPos=[new ce(-s,-s,-s),new ce(-s,s,-s),new ce(s,s,-s),new ce(s,-s,-s),new ce(-s,-s,s),new ce(-s,s,s),new ce(s,s,s),new ce(s,-s,s)];this._immediateData.cubeWorldPos=[new ce,new ce,new ce,new ce,new ce,new ce,new ce,new ce]}var a=this._immediateData.cubeLocalPos;var o=this._immediateData.cubeWorldPos;for(r=0;r<8;r++)t.transformPoint(a[r],o[r]);this.renderLines([o[0],o[1],o[1],o[2],o[2],o[3],o[3],o[0],o[4],o[5],o[5],o[6],o[6],o[7],o[7],o[4],o[0],o[4],o[1],o[5],o[2],o[6],o[3],o[7]],i,n)};e.renderMeshInstance=function e(t,i){if(!i)i={layer:this.scene.layers.getLayerById(Fl)};this._initImmediate();this._immediateData.addLayer(i.layer);this.meshInstanceArray[0]=t;i.layer.addMeshInstances(this.meshInstanceArray,true)};e.renderMesh=function e(t,i,n,r){if(!r)r={layer:this.scene.layers.getLayerById(Fl)};this._initImmediate();nM.worldTransform=n;nM._dirtyWorld=nM._dirtyNormal=false;var s=new zu(nM,t,i);s.cull=false;if(r.mask)s.mask=r.mask;this._immediateData.addLayer(r.layer);this.meshInstanceArray[0]=s;r.layer.addMeshInstances(this.meshInstanceArray,true)};e.renderQuad=function e(t,i,n){if(!n)n={layer:this.scene.layers.getLayerById(Fl)};this._initImmediate();if(!this._immediateData.quadMesh){var r=new cr(this.graphicsDevice,[{semantic:Ci,components:3,type:In}]);var s=new lr(this.graphicsDevice,r,4);var a=new Tr(s);a.element[Ci].set(-.5,-.5,0);a.next();a.element[Ci].set(.5,-.5,0);a.next();a.element[Ci].set(-.5,.5,0);a.next();a.element[Ci].set(.5,.5,0);a.end();this._immediateData.quadMesh=new Du(this.graphicsDevice);this._immediateData.quadMesh.vertexBuffer=s;this._immediateData.quadMesh.primitive[0].type=Ti;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=false}nM.worldTransform=t;nM._dirtyWorld=nM._dirtyNormal=false;var o=new zu(nM,this._immediateData.quadMesh,i);o.cull=false;this.meshInstanceArray[0]=o;this._immediateData.addLayer(n.layer);n.layer.addMeshInstances(this.meshInstanceArray,true)};e.destroy=function e(){var t,i;var n=this.graphicsDevice.canvas.id;this.off("librariesloaded");document.removeEventListener("visibilitychange",this._visibilityChangeHandler,false);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,false);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,false);document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,false);this._visibilityChangeHandler=null;this.onVisibilityChange=null;this.root.destroy();this.root=null;if(this.mouse){this.mouse.off();this.mouse.detach();this.mouse=null}if(this.keyboard){this.keyboard.off();this.keyboard.detach();this.keyboard=null}if(this.touch){this.touch.off();this.touch.detach();this.touch=null}if(this.elementInput){this.elementInput.detach();this.elementInput=null}if(this.controller)this.controller=null;var r=this.systems.list;for(t=0,i=r.length;t<i;t++)r[t].destroy();L0.destroy();var s=this.assets.list();for(t=0;t<s.length;t++){s[t].unload();s[t].off()}this.assets.off();this.bundles.destroy();this.bundles=null;this.i18n.destroy();this.i18n=null;for(var a in this.loader.getHandler("script")._cache){var o=this.loader.getHandler("script")._cache[a];var l=o.parentNode;if(l)l.removeChild(o)}this.loader.getHandler("script")._cache={};this.loader.destroy();this.loader=null;this.scene.destroy();this.scene=null;this.systems=[];this.context=null;this.scripts.destroy();this.scripts=null;this.scenes.destroy();this.scenes=null;this.lightmapper.destroy();this.lightmapper=null;this.batcher.destroyManager();this.batcher=null;this._entityIndex={};this.defaultLayerDepth.onPreRenderOpaque=null;this.defaultLayerDepth.onPostRenderOpaque=null;this.defaultLayerDepth.onDisable=null;this.defaultLayerDepth.onEnable=null;this.defaultLayerDepth=null;this.defaultLayerWorld=null;Pr();if(this.vr){this.vr.destroy();this.vr=null}this.xr.end();this.graphicsDevice.destroy();this.graphicsDevice=null;this.renderer=null;this.tick=null;this.off();if(this._soundManager){this._soundManager.destroy();this._soundManager=null}Og.app=null;gm.DEFAULT_PARAM_TEXTURE=null;h._applications[n]=null;if(h._currentApplication===this)h._currentApplication=null};e.getEntityFromIndex=function e(t){return this._entityIndex[t]};U(h,[{key:"fillMode",get:function e(){return this._fillMode}},{key:"resolutionMode",get:function e(){return this._resolutionMode}}]);return h}(u);rM._currentApplication=null,rM._applications={};var sM={},aM=function e(t){var s=t;var a;return function(e,t){if(!s.graphicsDevice)return;rM._currentApplication=s;if(a){window.cancelAnimationFrame(a);a=null}o.app=s;var i=s._processTimestamp(e)||ye();var n=i-(s._time||i);var r=n/1e3;r=Pe.clamp(r,0,s.maxDeltaTime);r*=s.timeScale;s._time=i;if(s.vr&&s.vr.display)a=s.vr.display.requestAnimationFrame(s.tick);else if(s.xr.session)a=s.xr.session.requestAnimationFrame(s.tick);else a=window.requestAnimationFrame(s.tick);if(s.graphicsDevice.contextLost)return;s._fillFrameStatsBasic(i,r,n);s.fire("frameupdate",n);if(t){s.xr.update(t);s.graphicsDevice.defaultFramebuffer=t.session.renderState.baseLayer.framebuffer}else s.graphicsDevice.defaultFramebuffer=null;s.update(r);s.fire("framerender");if(s.autoRender||s.renderNextFrame){s.render();s.renderNextFrame=false}sM.timestamp=ye();sM.target=s;s.fire("frameend",sM);s.fire("frameEnd",sM);if(s.vr&&s.vr.display&&s.vr.display.presenting)s.vr.display.submitFrame()}},oM=[],lM=[],hM=[],cM=[],uM={},fM=[],dM=function(){function e(){}var t=e.prototype;t.copy=function e(t){for(var i in t)if(t.hasOwnProperty(i)&&i!=="copy")this[i]=t[i]};return e}(),pM=function(t){G(n,t);function n(){var e;e=t.call(this)||this;e._assetReferences={};e._validator=null;e.shaderOptBuilder=new Au;e.reset();return e}var e=n.prototype;e.reset=function e(){for(var t=0;t<oM.length;t++){var i=lM[t];this[oM[t]]=i?i.clone?i.clone():i:i}for(var n=0;n<hM.length;n++)this[hM[n]]=null;for(var r=0;r<cM.length;r++)this[cM[r]]=new Float32Array(3);this._chunks=new dM;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)};e.clone=function e(){var e=new n;this._cloneInternal(e);for(var t=0;t<oM.length;t++){var i=oM[t];if(this[i]!==undefined)if(this[i]&&this[i].copy)if(e[i])e[i].copy(this[i]);else e[i]=this[i].clone();else e[i]=this[i]}return e};e._updateMapTransform=function e(t,i,n){if(i.x===1&&i.y===1&&n.x===0&&n.y===0)return null;t=t||new ue;t.set(i.x,i.y,n.x,n.y);return t};e._setParameter=function e(t,i){if(!this.parameters[t])this._propsSet.push(t);this.setParameter(t,i)};e._clearParameters=function e(){var t=this._propsSet;for(var i=0;i<t.length;i++)delete this.parameters[t[i]];this._propsSet=[]};e._updateMap=function e(t){var i=t+"Map";var n=this[i];if(n){this._setParameter("texture_"+i,n);var r=i+"Transform";this[r]=this._updateMapTransform(this[r],this[i+"Tiling"],this[i+"Offset"]);var s=this[r];if(s){var a=i+"TransformUniform";var o=this[a];if(!o){o=new Float32Array(4);this[a]=o}o[0]=s.x;o[1]=s.y;o[2]=s.z;o[3]=s.w;this._setParameter("texture_"+r,o)}}};e.getUniform=function e(t,i,n){var r=uM[t];if(r)return r(this,i,n);return null};e.updateUniforms=function e(){this._clearParameters();this._setParameter("material_ambient",this.ambientUniform);if(!this.diffuseMap||this.diffuseTint)this._setParameter("material_diffuse",this.diffuseUniform);if(!this.useMetalness){if(!this.specularMap||this.specularTint)this._setParameter("material_specular",this.specularUniform)}else if(!this.metalnessMap||this.metalness<1)this._setParameter("material_metalness",this.metalness);if(this.enableGGXSpecular)this._setParameter("material_anisotropy",this.anisotropy);if(this.clearCoat>0){this._setParameter("material_clearCoat",this.clearCoat);this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness);this._setParameter("material_clearCoatReflectivity",this.clearCoat);this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness)}var t=this.getUniform("shininess",this.shininess,true);this._setParameter(t.name,t.value);if(!this.emissiveMap||this.emissiveTint)this._setParameter("material_emissive",this.emissiveUniform);if(this.emissiveMap)this._setParameter("material_emissiveIntensity",this.emissiveIntensity);if(this.refraction>0){this._setParameter("material_refraction",this.refraction);this._setParameter("material_refractionIndex",this.refractionIndex)}this._setParameter("material_opacity",this.opacity);if(this.opacityFadesSpecular===false)this._setParameter("material_alphaFade",this.alphaFade);if(this.occludeSpecular)this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);if(this.cubeMapProjection===yh)this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,true));for(var i in mu)this._updateMap(i);if(this.ambientSH)this._setParameter("ambientSH[0]",this.ambientSH);if(this.normalMap)this._setParameter("material_bumpiness",this.bumpiness);if(this.normalMap&&this.normalDetailMap)this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness);if(this.heightMap){t=this.getUniform("heightMapFactor",this.heightMapFactor,true);this._setParameter(t.name,t.value)}if(this.cubeMap)this._setParameter("texture_cubeMap",this.cubeMap);if(this.prefilteredCubeMap128)this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128);else if(this._scene&&this._scene._skyboxPrefiltered[0])this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]);if(this.prefilteredCubeMap64)this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64);else if(this._scene&&this._scene._skyboxPrefiltered[1])this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]);if(this.prefilteredCubeMap32)this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32);else if(this._scene&&this._scene._skyboxPrefiltered[2])this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]);if(this.prefilteredCubeMap16)this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16);else if(this._scene&&this._scene._skyboxPrefiltered[3])this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);if(this.prefilteredCubeMap8)this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8);else if(this._scene&&this._scene._skyboxPrefiltered[4])this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);if(this.prefilteredCubeMap4)this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4);else if(this._scene&&this._scene._skyboxPrefiltered[5])this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]);if(this.sphereMap)this._setParameter("texture_sphereMap",this.sphereMap);if(this.dpAtlas)this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);if(this.dirtyShader||!this._scene){this.shader=null;this.clearVariants()}this._processColor()};e._processColor=function e(){if(!this.dirtyColor)return;if(!this._scene&&this.useGammaTonemap)return;var t=false;if(this.useGammaTonemap)t=this._scene.gammaCorrection;for(var i=0;i<fM.length;i++){var n=this["_"+fM[i]];var r=this[fM[i]+"Uniform"];if(t){r[0]=Math.pow(n.r,2.2);r[1]=Math.pow(n.g,2.2);r[2]=Math.pow(n.b,2.2)}else{r[0]=n.r;r[1]=n.g;r[2]=n.b}}for(var s=0;s<3;s++)this.emissiveUniform[s]*=this.emissiveIntensity;this.dirtyColor=false};e.updateShader=function e(t,i,n,r,s,a){if(!this._colorProcessed&&this._scene){this._colorProcessed=true;this._processColor()}var o=t.useTexCubeLod;var l=!t.extTextureLod;var h,c,u,f,d,p;if(this.useSkybox){h=i._skyboxPrefiltered[0];c=i._skyboxPrefiltered[1];u=i._skyboxPrefiltered[2];f=i._skyboxPrefiltered[3];d=i._skyboxPrefiltered[4];p=i._skyboxPrefiltered[5]}var m=this.prefilteredCubeMap128||h;var _=this.prefilteredCubeMap64||c;var v=this.prefilteredCubeMap32||u;var g=this.prefilteredCubeMap16||f;var y=this.prefilteredCubeMap8||d;var b=this.prefilteredCubeMap4||p;if(m){var x=m&&_&&v&&g&&y&&b;if(l&&x){if(!m.dpAtlas){var S=[m,_,v,g,y,b];m.dpAtlas=Tu(t,S);m.sh=GM(t,g)}this.dpAtlas=m.dpAtlas;this.ambientSH=m.sh;this._setParameter("ambientSH[0]",this.ambientSH);this._setParameter("texture_sphereMap",this.dpAtlas)}else if(o)if(m._levels.length<6)if(x)this._setParameter("texture_prefilteredCubeMap128",m);else console.log("Can't use prefiltered cubemap: "+x+", "+o+", "+m._levels);else this._setParameter("texture_prefilteredCubeMap128",m);else if(x){this._setParameter("texture_prefilteredCubeMap128",m);this._setParameter("texture_prefilteredCubeMap64",_);this._setParameter("texture_prefilteredCubeMap32",v);this._setParameter("texture_prefilteredCubeMap16",g);this._setParameter("texture_prefilteredCubeMap8",y);this._setParameter("texture_prefilteredCubeMap4",b)}else console.log("Can't use prefiltered cubemap: "+x+", "+o+", "+m._levels);if(this.useSkybox&&!i.skyboxRotation.equals(be.IDENTITY)&&i._skyboxRotationMat3)this._setParameter("cubeMapRotationMatrix",i._skyboxRotationMat3.data)}var w=s>uc&&s<=mc;var T=w?_u.optionsContextMin:_u.optionsContext;if(w)this.shaderOptBuilder.updateMinRef(T,t,i,this,n,r,s,a,m);else this.shaderOptBuilder.updateRef(T,t,i,this,n,r,s,a,m);if(this.onUpdateShader)T=this.onUpdateShader(T);var M=t.getProgramLibrary();this.shader=M.getProgram("standard",T);if(!n){this.clearVariants();this.variants[0]=this.shader}this.dirtyShader=false};return n}(Cu);function mM(e,t,i,n,r,s,a){var o="_"+t+"Map";var l=o+"Tiling";var h=o+"Offset";var c=o.substring(1)+"Transform";var u=c+"Uniform";var f=o+"Uv";var d=o+"Channel";var p="_"+t+"VertexColor";var m="_"+t+"VertexColorChannel";var _="_"+t+"Mode";e[o]=null;e[l]=new he(1,1);e[h]=new he(0,0);e[c]=null;e[u]=null;e[f]=i;if(n>0){var v=r?r:n>1?"rgb":"g";e[d]=v;if(s)e[m]=v}if(s)e[p]=false;if(a)e[_]=Sh;mu[t]=n;Object.defineProperty(pM.prototype,o.substring(1),{get:function e(){return this[o]},set:function e(t){var i=this[o];if(!!i^!!t)this.dirtyShader=true;if(i&&t)if(i.type!==t.type||i.fixCubemapSeams!==t.fixCubemapSeams||i.format!==t.format)this.dirtyShader=true;this[o]=t}});var g=l.substring(1);var y=h.substring(1);Object.defineProperty(pM.prototype,g,{get:function e(){return this[l]},set:function e(t){this.dirtyShader=true;this[l]=t}});uM[g]=function(e,t,i){var n=e._updateMapTransform(i?e[c]:null,t,e[h]);return{name:"texture_"+c,value:n.data}};Object.defineProperty(pM.prototype,y,{get:function e(){return this[h]},set:function e(t){this.dirtyShader=true;this[h]=t}});uM[y]=function(e,t,i){var n=e._updateMapTransform(i?e[c]:null,e[l],t);return{name:"texture_"+c,value:n.data}};Object.defineProperty(pM.prototype,f.substring(1),{get:function e(){return this[f]},set:function e(t){if(this[f]!==t)this.dirtyShader=true;this[f]=t}});Object.defineProperty(pM.prototype,d.substring(1),{get:function e(){return this[d]},set:function e(t){if(this[d]!==t)this.dirtyShader=true;this[d]=t}});if(s){Object.defineProperty(pM.prototype,p.substring(1),{get:function e(){return this[p]},set:function e(t){this.dirtyShader=true;this[p]=t}});Object.defineProperty(pM.prototype,m.substring(1),{get:function e(){return this[m]},set:function e(t){if(this[m]!==t)this.dirtyShader=true;this[m]=t}})}if(a)Object.defineProperty(pM.prototype,_.substring(1),{get:function e(){return this[_]},set:function e(t){this.dirtyShader=true;this[_]=t}});oM.push(o.substring(1));oM.push(l.substring(1));oM.push(h.substring(1));oM.push(f.substring(1));oM.push(d.substring(1));if(s){oM.push(p.substring(1));oM.push(m.substring(1))}if(a)oM.push(_.substring(1));hM.push(c)}function _M(e,o,t,l){var h="_"+o;var c=o+"Uniform";var i=o+"Intensity";var u="_"+i;e[h]=t;e[c]=new Float32Array(3);Object.defineProperty(pM.prototype,o,{get:function e(){this.dirtyColor=true;this.dirtyShader=true;return this[h]},set:function e(t){var i=this[h];var n=i.r===0&&i.g===0&&i.b===0||i.r===1&&i.g===1&&i.b===1;var r=t.r===0&&t.g===0&&t.b===0||t.r===1&&t.g===1&&t.b===1;if(n^r)this.dirtyShader=true;this.dirtyColor=true;this[h]=t}});oM.push(o);cM.push(c);fM.push(o);uM[o]=function(e,t,i){var n=i?e[c]:new Float32Array(3);var r=false;if(e.useGammaTonemap){var s=e._scene||rM.getApplication().scene;r=s.gammaCorrection}for(var a=0;a<3;a++){if(r)n[a]=Math.pow(t.data[a],2.2);else n[a]=t.data[a];if(l)n[a]*=e[u]}return{name:"material_"+o,value:n}};if(l){e[u]=1;Object.defineProperty(pM.prototype,i,{get:function e(){return this[u]},set:function e(t){var i=this[u];var n=i===0||i===1;var r=t===0||t===1;if(n^r)this.dirtyShader=true;this.dirtyColor=true;this[u]=t}});oM.push(i);uM[i]=function(e,t,i){var n=i?e[c]:new Float32Array(3);var r=false;if(e.useGammaTonemap){var s=e._scene||rM.getApplication().scene;r=s.gammaCorrection}for(var a=0;a<3;a++){if(r)n[a]=Math.pow(e[h].data[a],2.2);else n[a]=e[h].data[a];n[a]*=e[u]}return{name:"material_"+o,value:n}}}}function vM(e,n,t,i){var s="_"+n;e[s]=t;Object.defineProperty(pM.prototype,n,{get:function e(){return this[s]},set:function e(t){var i=this[s];if(i===t)return;this[s]=t;var n=i===0||i===1;var r=t===0||t===1;if(n||r)this.dirtyShader=true}});oM.push(n);uM[n]=i!==undefined?i:function(e,t,i){return{name:"material_"+n,value:t}}}function gM(e,t,i){var n="_"+t;e[n]=null;Object.defineProperty(pM.prototype,t,{get:function e(){return this[n]},set:function e(t){var i=this[n];if(!!i^!!t)this.dirtyShader=true;this[n]=t}});oM.push(t);uM[t]=i}function yM(e,i,t){Object.defineProperty(pM.prototype,t,{get:function e(){return this[i]},set:function e(t){this[i]=t}})}function bM(e){Object.defineProperty(pM.prototype,"chunks",{get:function e(){this.dirtyShader=true;return this._chunks},set:function e(t){this.dirtyShader=true;this._chunks=t}});oM.push("chunks")}function xM(e,t,i){var n="_"+t;e[n]=i;Object.defineProperty(pM.prototype,t,{get:function e(){return this[n]},set:function e(t){if(this[n]!==t)this.dirtyShader=true;this[n]=t}});oM.push(t)}function SM(e){e.dirtyShader=true;e.dirtyColor=true;e._scene=null;e._colorProcessed=false;_M(e,"ambient",new ge(.7,.7,.7));_M(e,"diffuse",new ge(1,1,1));_M(e,"specular",new ge(0,0,0));_M(e,"emissive",new ge(0,0,0),true);vM(e,"shininess",25,function(e,t){var i;if(e.shadingModel===bh)i=Math.pow(2,t*.01*11);else i=t*.01;return{name:"material_shininess",value:i}});vM(e,"heightMapFactor",1,function(e,t){return{name:"material_heightMapFactor",value:t*.025}});vM(e,"opacity",1);vM(e,"alphaFade",1);vM(e,"alphaTest",0);vM(e,"bumpiness",1);vM(e,"normalDetailMapBumpiness",1);vM(e,"reflectivity",1);vM(e,"occludeSpecularIntensity",1);vM(e,"refraction",0);vM(e,"refractionIndex",1/1.5);vM(e,"metalness",1);vM(e,"anisotropy",0);vM(e,"clearCoat",0);vM(e,"clearCoatGlossiness",1);vM(e,"clearCoatBumpiness",1);vM(e,"aoUvSet",0,null);gM(e,"ambientSH",function(e,t,i){return{name:"ambientSH[0]",value:t}});gM(e,"cubeMapProjectionBox",function(e,t,i){var n=i?e.cubeMapMinUniform:new Float32Array(3);var r=i?e.cubeMapMaxUniform:new Float32Array(3);n[0]=t.center.x-t.halfExtents.x;n[1]=t.center.y-t.halfExtents.y;n[2]=t.center.z-t.halfExtents.z;r[0]=t.center.x+t.halfExtents.x;r[1]=t.center.y+t.halfExtents.y;r[2]=t.center.z+t.halfExtents.z;return[{name:"envBoxMin",value:n},{name:"envBoxMax",value:r}]});bM();xM(e,"ambientTint",false);xM(e,"diffuseTint",false);xM(e,"specularTint",false);xM(e,"emissiveTint",false);xM(e,"fastTbn",false);xM(e,"specularAntialias",false);xM(e,"useMetalness",false);xM(e,"enableGGXSpecular",false);xM(e,"occludeDirect",false);xM(e,"normalizeNormalMap",true);xM(e,"conserveEnergy",true);xM(e,"opacityFadesSpecular",true);xM(e,"occludeSpecular",Nh);xM(e,"shadingModel",xh);xM(e,"fresnelModel",Al);xM(e,"cubeMapProjection",gh);xM(e,"customFragmentShader",null);xM(e,"forceFragmentPrecision",null);xM(e,"useFog",true);xM(e,"useLighting",true);xM(e,"useGammaTonemap",true);xM(e,"useSkybox",true);xM(e,"forceUv1",false);xM(e,"pixelSnap",false);xM(e,"twoSidedLighting",false);xM(e,"nineSlicedMode",undefined);mM(e,"diffuse",0,3,"",true);mM(e,"specular",0,3,"",true);mM(e,"emissive",0,3,"",true);mM(e,"normal",0,-1,"",false);mM(e,"metalness",0,1,"",true);mM(e,"gloss",0,1,"",true);mM(e,"opacity",0,1,"a",true);mM(e,"height",0,1,"",false);mM(e,"ao",0,1,"",true);mM(e,"light",1,3,"",true);mM(e,"msdf",0,3,"",false);mM(e,"diffuseDetail",0,3,"",false,true);mM(e,"normalDetail",0,-1,"",false);mM(e,"clearCoat",0,1,"",true);mM(e,"clearCoatGloss",0,1,"",true);mM(e,"clearCoatNormal",0,-1,"",false);gM(e,"cubeMap");gM(e,"sphereMap");gM(e,"dpAtlas");gM(e,"prefilteredCubeMap128");gM(e,"prefilteredCubeMap64");gM(e,"prefilteredCubeMap32");gM(e,"prefilteredCubeMap16");gM(e,"prefilteredCubeMap8");gM(e,"prefilteredCubeMap4");yM(e,"diffuseTint","diffuseMapTint");yM(e,"specularTint","specularMapTint");yM(e,"emissiveTint","emissiveMapTint");yM(e,"aoVertexColor","aoMapVertexColor");yM(e,"diffuseVertexColor","diffuseMapVertexColor");yM(e,"specularVertexColor","specularMapVertexColor");yM(e,"emissiveVertexColor","emissiveMapVertexColor");yM(e,"metalnessVertexColor","metalnessMapVertexColor");yM(e,"glossVertexColor","glossMapVertexColor");yM(e,"opacityVertexColor","opacityMapVertexColor");yM(e,"lightVertexColor","lightMapVertexColor");for(var t=0;t<oM.length;t++)lM[t]=e[oM[t]];e._propsSet=[]}pM.TEXTURE_PARAMETERS=lg,pM.CUBEMAP_PARAMETERS=hg,SM(pM.prototype);var wM=function(){function e(e){this._device=e;this._cache={};this._generators={};this._isClearingCache=false;this._precached=false;this._programsCollection=[];this._defaultStdMatOption={};this._defaultStdMatOptionMin={};var t=new pM;t.shaderOptBuilder.updateRef(this._defaultStdMatOption,e,{},t,null,[],cc,null,null);t.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,e,{},t,null,[],dc,null,null)}var t=e.prototype;t.register=function e(t,i){if(!this.isRegistered(t))this._generators[t]=i};t.unregister=function e(t){if(this.isRegistered(t))delete this._generators[t]};t.isRegistered=function e(t){var i=this._generators[t];return i!==undefined};t.getProgram=function e(t,i){var n=this._generators[t];if(n===undefined)return null;var r=this._device;var s=n.generateKey(i);var a=this._cache[s];if(!a){var o;if(i.lights){o=i.lights;i.lights=o.map(function(e){var t=e.clone?e.clone():e;t.key=e.key;return t})}this.storeNewProgram(t,i);if(i.lights)i.lights=o;if(this._precached)console.warn("ProgramLibrary#getProgram: Cache miss for shader",t,"key",s,"after shaders precaching");var l=n.createShaderDefinition(r,i);a=this._cache[s]=new Ir(r,l)}return a};t.storeNewProgram=function e(t,i){var n={};if(t==="standard"){var r=this._getDefaultStdMatOptions(i.pass);for(var s in i)if(i.hasOwnProperty(s)&&r[s]!==i[s]||s==="pass")n[s]=i[s]}else n=i;this._programsCollection.push(JSON.stringify({name:t,options:n}))};t.dumpPrograms=function e(){var t="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\n";t+="var shaders = [";if(this._programsCollection[0])t+="\n\t"+this._programsCollection[0];for(var i=1;i<this._programsCollection.length;++i)t+=",\n\t"+this._programsCollection[i];t+="\n];\n";t+="device.programLib.precompile(shaders);\n";t+='if (pc.version != "'+r+'" || pc.revision != "'+s+'")\n';t+='\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");';var n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t));n.setAttribute("download","precompile-shaders.js");n.style.display="none";document.body.appendChild(n);n.click();document.body.removeChild(n)};t.clearCache=function e(){var t=this._cache;this._isClearingCache=true;for(var i in t)if(t.hasOwnProperty(i))t[i].destroy();this._cache={};this._isClearingCache=false};t.removeFromCache=function e(t){if(this._isClearingCache)return;var i=this._cache;for(var n in i)if(i.hasOwnProperty(n))if(i[n]===t){delete i[n];break}};t._getDefaultStdMatOptions=function e(t){return t>uc&&t<=mc?this._defaultStdMatOptionMin:this._defaultStdMatOption};t.precompile=function e(t){if(t){var i=new Array(t.length);for(var n=0;n<t.length;n++){if(t[n].name==="standard"){var r=t[n].options;var s=this._getDefaultStdMatOptions(r.pass);for(var a in s)if(s.hasOwnProperty(a)&&r[a]===undefined)r[a]=s[a];r.useTexCubeLod=this._device.useTexCubeLod}i[n]=this.getProgram(t[n].name,t[n].options)}}this._precached=true};return e}(),TM=function(){function e(){this.globalId=0;this.revision=0}var t=e.prototype;t.equals=function e(t){return this.globalId===t.globalId&&this.revision===t.revision};t.copy=function e(t){this.globalId=t.globalId;this.revision=t.revision};t.reset=function e(){this.globalId=0;this.revision=0};return e}(),MM=0,CM=function(){function e(){MM++;this.version=new TM;this.version.globalId=MM}var t=e.prototype;t.increment=function e(){this.version.revision++};return e}(),AM=function(){function e(e){this.name=e;this.value=null;this.versionObject=new CM}var t=e.prototype;t.setValue=function e(t){this.value=t;this.versionObject.increment()};t.getValue=function e(){return this.value};return e}(),PM=function(){function i(e){this.name=e;this.variables={};this.namespaces={}}var e=i.prototype;e.resolve=function e(t){if(!this.variables.hasOwnProperty(t))this.variables[t]=new AM(t);return this.variables[t]};e.getSubSpace=function e(t){if(!this.namespaces.hasOwnProperty(t))this.namespaces[t]=new i(t);return this.namespaces[t]};return i}(),EM=function e(t,i,n,r){this.locationId=r;this.scopeId=t.scope.resolve(i);this.version=new TM;if(i.substr(i.length-3)==="[0]")switch(n){case Dn:n=Yn;break;case kn:n=Zn;break;case On:n=Jn;break;case Fn:n=er;break}this.dataType=n;this.value=[null,null,null,null];this.array=[]},IM="resizecanvas",RM=function e(t,i){var n=t.width;var r=t.height;if(n>i||r>i){var s=i/Math.max(n,r);var a=Math.floor(n*s);var o=Math.floor(r*s);console.warn("Image dimensions larger than max supported texture size of "+i+". "+"Resizing from "+n+", "+r+" to "+a+", "+o+".");var l=document.createElement("canvas");l.width=a;l.height=o;var h=l.getContext("2d");h.drawImage(t,0,0,n,r,0,0,a,o);return l}return t};function LM(e,t){var i=true;var n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null);var r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0);if(e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)i=false;e.bindTexture(e.TEXTURE_2D,null);e.deleteTexture(n);e.bindFramebuffer(e.FRAMEBUFFER,null);e.deleteFramebuffer(r);return i}function DM(e,t){var i=true;var n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var r=new Uint16Array(4*2*2);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,r);if(e.getError()!==e.NO_ERROR){i=false;console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")}e.bindTexture(e.TEXTURE_2D,null);e.deleteTexture(n);return i}function kM(e){if(!e.textureFloatRenderable)return false;var t=Qc(e,ul.fullscreenQuadVS,ul.precisionTestPS,"ptest1");var i=Qc(e,ul.fullscreenQuadVS,ul.precisionTest2PS,"ptest2");var n={format:ii,width:1,height:1,mipmaps:false,minFilter:Mt,magFilter:Mt};var r=new bu(e,n);r.name="testFHP";var s=new BM(e,r,{depth:false});Ar(e,s,t);n.format=Kt;var a=new bu(e,n);a.name="testFHP";var o=new BM(e,a,{depth:false});e.constantTexSource.setValue(r);Ar(e,o,i);var l=e.activeFramebuffer;e.setFramebuffer(o._glFrameBuffer);var h=new Uint8Array(4);e.readPixels(0,0,1,1,h);e.setFramebuffer(l);var c=h[0]/255;var u=h[1]/255;var f=h[2]/255;var d=h[3]/255;var p=c/(256*256*256)+u/(256*256)+f/256+d;r.destroy();s.destroy();a.destroy();o.destroy();return p===0}var OM=function(_){G(e,_);function e(e,t){var i;i=_.call(this)||this;var n;i.canvas=e;i._enableAutoInstancing=false;i.autoInstancingMaxObjects=16384;i.defaultFramebuffer=null;i._maxPixelRatio=1;i._width=0;i._height=0;i.updateClientRect();i.shaders=[];i.buffers=[];i.textures=[];i.targets=[];i.contextLost=false;i._contextLostHandler=function(e){e.preventDefault();this.contextLost=true;this.loseContext();this.fire("devicelost")}.bind(H(i));i._contextRestoredHandler=function(){this.restoreContext();this.contextLost=false;this.fire("devicerestored")}.bind(H(i));var r=t&&t.preferWebGl2!==undefined?t.preferWebGl2:true;var s=r?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"];var a=null;t=t||{};t.stencil=true;for(n=0;n<s.length;n++){try{a=e.getContext(s[n],t)}catch(e){}if(a){i.webgl2=r&&n<2;break}}if(!a)throw new Error("WebGL not supported");i.gl=a;i._tempEnableSafariTextureUnitWorkaround=!!window.safari;var o=!!window.chrome;var l=navigator.appVersion.indexOf("Mac")!==-1;i._tempMacChromeBlitFramebufferWorkaround=l&&o&&!t.alpha;window.setupVertexArrayObject(a);e.addEventListener("webglcontextlost",i._contextLostHandler,false);e.addEventListener("webglcontextrestored",i._contextRestoredHandler,false);i.initializeExtensions();i.initializeCapabilities();i.initializeRenderState();i.initializeContextCaches();i.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:ft|dt};i.glAddress=[a.REPEAT,a.CLAMP_TO_EDGE,a.MIRRORED_REPEAT];i.glBlendEquation=[a.FUNC_ADD,a.FUNC_SUBTRACT,a.FUNC_REVERSE_SUBTRACT,i.webgl2?a.MIN:i.extBlendMinmax?i.extBlendMinmax.MIN_EXT:a.FUNC_ADD,i.webgl2?a.MAX:i.extBlendMinmax?i.extBlendMinmax.MAX_EXT:a.FUNC_ADD];i.glBlendFunction=[a.ZERO,a.ONE,a.SRC_COLOR,a.ONE_MINUS_SRC_COLOR,a.DST_COLOR,a.ONE_MINUS_DST_COLOR,a.SRC_ALPHA,a.SRC_ALPHA_SATURATE,a.ONE_MINUS_SRC_ALPHA,a.DST_ALPHA,a.ONE_MINUS_DST_ALPHA];i.glComparison=[a.NEVER,a.LESS,a.EQUAL,a.LEQUAL,a.GREATER,a.NOTEQUAL,a.GEQUAL,a.ALWAYS];i.glStencilOp=[a.KEEP,a.ZERO,a.REPLACE,a.INCR,a.INCR_WRAP,a.DECR,a.DECR_WRAP,a.INVERT];i.glClearFlag=[0,a.COLOR_BUFFER_BIT,a.DEPTH_BUFFER_BIT,a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT,a.STENCIL_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.COLOR_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.DEPTH_BUFFER_BIT,a.STENCIL_BUFFER_BIT|a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT];i.glCull=[0,a.BACK,a.FRONT,a.FRONT_AND_BACK];i.glFilter=[a.NEAREST,a.LINEAR,a.NEAREST_MIPMAP_NEAREST,a.NEAREST_MIPMAP_LINEAR,a.LINEAR_MIPMAP_NEAREST,a.LINEAR_MIPMAP_LINEAR];i.glPrimitive=[a.POINTS,a.LINES,a.LINE_LOOP,a.LINE_STRIP,a.TRIANGLES,a.TRIANGLE_STRIP,a.TRIANGLE_FAN];i.glType=[a.BYTE,a.UNSIGNED_BYTE,a.SHORT,a.UNSIGNED_SHORT,a.INT,a.UNSIGNED_INT,a.FLOAT];i.pcUniformType={};i.pcUniformType[a.BOOL]=Rn;i.pcUniformType[a.INT]=Ln;i.pcUniformType[a.FLOAT]=Dn;i.pcUniformType[a.FLOAT_VEC2]=kn;i.pcUniformType[a.FLOAT_VEC3]=On;i.pcUniformType[a.FLOAT_VEC4]=Fn;i.pcUniformType[a.INT_VEC2]=Bn;i.pcUniformType[a.INT_VEC3]=Nn;i.pcUniformType[a.INT_VEC4]=zn;i.pcUniformType[a.BOOL_VEC2]=Vn;i.pcUniformType[a.BOOL_VEC3]=Un;i.pcUniformType[a.BOOL_VEC4]=Gn;i.pcUniformType[a.FLOAT_MAT2]=Hn;i.pcUniformType[a.FLOAT_MAT3]=Wn;i.pcUniformType[a.FLOAT_MAT4]=jn;i.pcUniformType[a.SAMPLER_2D]=Xn;i.pcUniformType[a.SAMPLER_CUBE]=qn;if(i.webgl2){i.pcUniformType[a.SAMPLER_2D_SHADOW]=Kn;i.pcUniformType[a.SAMPLER_CUBE_SHADOW]=Qn;i.pcUniformType[a.SAMPLER_3D]=$n}i.targetToSlot={};i.targetToSlot[a.TEXTURE_2D]=0;i.targetToSlot[a.TEXTURE_CUBE_MAP]=1;i.targetToSlot[a.TEXTURE_3D]=2;var h,c,u,f;var d;i.commitFunction=[];i.commitFunction[Rn]=function(e,t){if(e.value!==t){a.uniform1i(e.locationId,t);e.value=t}};i.commitFunction[Ln]=i.commitFunction[Rn];i.commitFunction[Dn]=function(e,t){if(e.value!==t){a.uniform1f(e.locationId,t);e.value=t}};i.commitFunction[kn]=function(e,t){d=e.value;h=t[0];c=t[1];if(d[0]!==h||d[1]!==c){a.uniform2fv(e.locationId,t);d[0]=h;d[1]=c}};i.commitFunction[On]=function(e,t){d=e.value;h=t[0];c=t[1];u=t[2];if(d[0]!==h||d[1]!==c||d[2]!==u){a.uniform3fv(e.locationId,t);d[0]=h;d[1]=c;d[2]=u}};i.commitFunction[Fn]=function(e,t){d=e.value;h=t[0];c=t[1];u=t[2];f=t[3];if(d[0]!==h||d[1]!==c||d[2]!==u||d[3]!==f){a.uniform4fv(e.locationId,t);d[0]=h;d[1]=c;d[2]=u;d[3]=f}};i.commitFunction[Bn]=function(e,t){d=e.value;h=t[0];c=t[1];if(d[0]!==h||d[1]!==c){a.uniform2iv(e.locationId,t);d[0]=h;d[1]=c}};i.commitFunction[Vn]=i.commitFunction[Bn];i.commitFunction[Nn]=function(e,t){d=e.value;h=t[0];c=t[1];u=t[2];if(d[0]!==h||d[1]!==c||d[2]!==u){a.uniform3iv(e.locationId,t);d[0]=h;d[1]=c;d[2]=u}};i.commitFunction[Un]=i.commitFunction[Nn];i.commitFunction[zn]=function(e,t){d=e.value;h=t[0];c=t[1];u=t[2];f=t[3];if(d[0]!==h||d[1]!==c||d[2]!==u||d[3]!==f){a.uniform4iv(e.locationId,t);d[0]=h;d[1]=c;d[2]=u;d[3]=f}};i.commitFunction[Gn]=i.commitFunction[zn];i.commitFunction[Hn]=function(e,t){a.uniformMatrix2fv(e.locationId,false,t)};i.commitFunction[Wn]=function(e,t){a.uniformMatrix3fv(e.locationId,false,t)};i.commitFunction[jn]=function(e,t){a.uniformMatrix4fv(e.locationId,false,t)};i.commitFunction[Yn]=function(e,t){a.uniform1fv(e.locationId,t)};i.commitFunction[Zn]=function(e,t){a.uniform2fv(e.locationId,t)};i.commitFunction[Jn]=function(e,t){a.uniform3fv(e.locationId,t)};i.commitFunction[er]=function(e,t){a.uniform4fv(e.locationId,t)};i.scope=new PM("Device");i.programLib=new wM(H(i));for(var p in vu)i.programLib.register(p,vu[p]);i.supportsBoneTextures=i.extTextureFloat&&i.maxVertexTextures>0;i.useTexCubeLod=i.extTextureLod&&i.maxTextures<16;var m=i.vertexUniformsCount;m-=4*4;m-=8;m-=1;m-=4*4;i.boneLimit=Math.floor(m/3);i.boneLimit=Math.min(i.boneLimit,128);if(i.unmaskedRenderer==="Mali-450 MP")i.boneLimit=34;i._drawCallsPerFrame=0;i._shaderSwitchesPerFrame=0;i._primsPerFrame=[];for(n=yi;n<=Mi;n++)i._primsPerFrame[n]=0;i._renderTargetCreationTime=0;i._vram={tex:0,vb:0,ib:0};i._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};i.constantTexSource=i.scope.resolve("source");if(i.extTextureFloat)if(i.webgl2)i.textureFloatRenderable=!!i.extColorBufferFloat;else i.textureFloatRenderable=LM(a,a.FLOAT);else i.textureFloatRenderable=false;if(i.extTextureHalfFloat)if(i.webgl2)i.textureHalfFloatRenderable=!!i.extColorBufferFloat;else i.textureHalfFloatRenderable=LM(a,i.extTextureHalfFloat.HALF_FLOAT_OES);else i.textureHalfFloatRenderable=false;i.supportsMorphTargetTexturesCore=i.maxPrecision==="highp"&&i.maxVertexTextures>=2;i._textureFloatHighPrecision=undefined;i._textureHalfFloatUpdatable=undefined;i.grabPassAvailable=true;i.grabPassApha=t.alpha;i.createGrabPass();cr.init(H(i));i._areaLightLutFormat=Kt;if(i.extTextureHalfFloat&&i.textureHalfFloatUpdatable)i._areaLightLutFormat=ei;else if(i.extTextureFloat)i._areaLightLutFormat=ii;return i}var t=e.prototype;t.getPrecision=function e(){var t=this.gl;var i="highp";if(t.getShaderPrecisionFormat){var n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT);var r=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT);var s=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);var a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT);var o=n.precision>0&&s.precision>0;var l=r.precision>0&&a.precision>0;if(!o)if(l)i="mediump";else i="lowp"}return i};t.initializeExtensions=function e(){var i=this.gl;var t;var n=i.getSupportedExtensions();var r=function e(){for(var t=0;t<arguments.length;t++)if(n.indexOf(arguments[t])!==-1)return i.getExtension(arguments[t]);return null};if(this.webgl2){this.extBlendMinmax=true;this.extDrawBuffers=true;this.extInstancing=true;this.extStandardDerivatives=true;this.extTextureFloat=true;this.extTextureHalfFloat=true;this.extTextureHalfFloatLinear=true;this.extTextureLod=true;this.extUintElement=true;this.extVertexArrayObject=true;this.extColorBufferFloat=r("EXT_color_buffer_float");this.extDisjointTimerQuery=r("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query")}else{this.extBlendMinmax=r("EXT_blend_minmax");this.extDrawBuffers=r("EXT_draw_buffers");this.extInstancing=r("ANGLE_instanced_arrays");if(this.extInstancing){t=this.extInstancing;i.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t);i.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t);i.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)}this.extStandardDerivatives=r("OES_standard_derivatives");this.extTextureFloat=r("OES_texture_float");this.extTextureHalfFloat=r("OES_texture_half_float");this.extTextureHalfFloatLinear=r("OES_texture_half_float_linear");this.extTextureLod=r("EXT_shader_texture_lod");this.extUintElement=r("OES_element_index_uint");this.extVertexArrayObject=r("OES_vertex_array_object");if(this.extVertexArrayObject){t=this.extVertexArrayObject;i.createVertexArray=t.createVertexArrayOES.bind(t);i.deleteVertexArray=t.deleteVertexArrayOES.bind(t);i.isVertexArray=t.isVertexArrayOES.bind(t);i.bindVertexArray=t.bindVertexArrayOES.bind(t)}this.extColorBufferFloat=null;this.extDisjointTimerQuery=null}this.extDebugRendererInfo=r("WEBGL_debug_renderer_info");this.extTextureFloatLinear=r("OES_texture_float_linear");this.extFloatBlend=r("EXT_float_blend");this.extTextureFilterAnisotropic=r("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic");this.extCompressedTextureETC1=r("WEBGL_compressed_texture_etc1");this.extCompressedTextureETC=r("WEBGL_compressed_texture_etc");this.extCompressedTexturePVRTC=r("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc");this.extCompressedTextureS3TC=r("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc");this.extCompressedTextureATC=r("WEBGL_compressed_texture_atc");this.extCompressedTextureASTC=r("WEBGL_compressed_texture_astc");this.extParallelShaderCompile=r("KHR_parallel_shader_compile");this.supportsInstancing=!!this.extInstancing};t.initializeCapabilities=function e(){var t=this.gl;var i;this.maxPrecision=this.precision=this.getPrecision();var n=t.getContextAttributes();this.supportsMsaa=n.antialias;this.supportsStencil=n.stencil;this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE);this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE);this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);if(this.webgl2){this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS);this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS);this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)}else{i=this.extDrawBuffers;this.maxDrawBuffers=i?t.getParameter(i.MAX_DRAW_BUFFERS_EXT):1;this.maxColorAttachments=i?t.getParameter(i.MAX_COLOR_ATTACHMENTS_EXT):1;this.maxVolumeSize=1}i=this.extDebugRendererInfo;this.unmaskedRenderer=i?t.getParameter(i.UNMASKED_RENDERER_WEBGL):"";this.unmaskedVendor=i?t.getParameter(i.UNMASKED_VENDOR_WEBGL):"";i=this.extTextureFilterAnisotropic;this.maxAnisotropy=i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1;this.samples=t.getParameter(t.SAMPLES)};t.initializeRenderState=function e(){var t=this.gl;this.blending=false;t.disable(t.BLEND);this.blendSrc=qe;this.blendDst=Xe;this.blendSrcAlpha=qe;this.blendDstAlpha=Xe;this.separateAlphaBlend=false;this.blendEquation=nt;this.blendAlphaEquation=nt;this.separateAlphaEquation=false;t.blendFunc(t.ONE,t.ZERO);t.blendEquation(t.FUNC_ADD);this.writeRed=true;this.writeGreen=true;this.writeBlue=true;this.writeAlpha=true;t.colorMask(true,true,true,true);this.cullMode=St;t.enable(t.CULL_FACE);t.cullFace(t.BACK);this.depthTest=true;t.enable(t.DEPTH_TEST);this.depthFunc=kt;t.depthFunc(t.LEQUAL);this.depthWrite=true;t.depthMask(true);this.stencil=false;t.disable(t.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=Nt;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=255;t.stencilFunc(t.ALWAYS,0,255);this.stencilFailFront=this.stencilFailBack=an;this.stencilZfailFront=this.stencilZfailBack=an;this.stencilZpassFront=this.stencilZpassBack=an;this.stencilWriteMaskFront=255;this.stencilWriteMaskBack=255;t.stencilOp(t.KEEP,t.KEEP,t.KEEP);t.stencilMask(255);this.alphaToCoverage=false;this.raster=true;if(this.webgl2){t.disable(t.SAMPLE_ALPHA_TO_COVERAGE);t.disable(t.RASTERIZER_DISCARD)}this.depthBiasEnabled=false;t.disable(t.POLYGON_OFFSET_FILL);this.clearDepth=1;t.clearDepth(1);this.clearRed=0;this.clearBlue=0;this.clearGreen=0;this.clearAlpha=0;t.clearColor(0,0,0,0);this.clearStencil=0;t.clearStencil(0);this.vx=this.vy=this.vw=this.vh=0;this.sx=this.sy=this.sw=this.sh=0;if(this.webgl2)t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST);else if(this.extStandardDerivatives)t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST);t.enable(t.SCISSOR_TEST);t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE);this.unpackFlipY=false;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,false);this.unpackPremultiplyAlpha=false;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false)};t.initializeContextCaches=function e(){this.vertexShaderCache={};this.fragmentShaderCache={};this._vaoMap=new Map;this.boundVao=null;this.indexBuffer=null;this.vertexBuffers=[];this.shader=null;this.renderTarget=null;this.activeFramebuffer=null;this.feedback=null;this.transformFeedbackBuffer=null;this.textureUnit=0;this.textureUnits=[];for(var t=0;t<this.maxCombinedTextures;t++)this.textureUnits.push([null,null,null])};t.loseContext=function e(){var t;for(t=0;t<this.shaders.length;t++)this.shaders[t].loseContext();this.destroyGrabPass();while(this.textures.length>0){var i=this.textures[0];this.destroyTexture(i);i.dirtyAll()}for(t=0;t<this.buffers.length;t++)this.buffers[t].loseContext();for(t=0;t<this.targets.length;t++)this.targets[t].loseContext()};t.restoreContext=function e(){this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();this.initializeContextCaches();var t,i;for(t=0,i=this.shaders.length;t<i;t++)this.compileAndLinkShader(this.shaders[t]);for(t=0,i=this.buffers.length;t<i;t++)this.buffers[t].unlock();this.createGrabPass()};t.createGrabPass=function e(){if(this.grabPassTexture)return;var t=new bu(this,{format:this.grabPassApha===false?Yt:Kt,minFilter:Ct,magFilter:Ct,addressU:We,addressV:We,mipmaps:false});t.name="texture_grabPass";var i=this.scope.resolve(t.name);i.setValue(t);var n=new BM({colorBuffer:t,depth:false});this.grabPassRenderTarget=n;this.grabPassTextureId=i;this.grabPassTexture=t};t.updateGrabPass=function e(){var t=this.gl;if(!this.grabPassAvailable)return false;var i=this.renderTarget;var n=i&&i._glResolveFrameBuffer;var r=this.grabPassTexture;var s=this.width;var a=this.height;if(this.webgl2&&!this._tempMacChromeBlitFramebufferWorkaround&&s===r._width&&a===r._height){if(n)i.resolve(true);var o=i?i._glFrameBuffer:null;var l=i?i._glResolveFrameBuffer||i._glFrameBuffer:null;this.initRenderTarget(this.grabPassRenderTarget);var h=this.grabPassRenderTarget._glFrameBuffer;t.bindFramebuffer(t.READ_FRAMEBUFFER,l);t.bindFramebuffer(t.DRAW_FRAMEBUFFER,h);t.blitFramebuffer(0,0,s,a,0,0,s,a,t.COLOR_BUFFER_BIT,t.NEAREST);t.bindFramebuffer(t.DRAW_FRAMEBUFFER,o)}else{if(n){i.resolve(true);t.bindFramebuffer(t.FRAMEBUFFER,i._glResolveFrameBuffer)}var c=r._glFormat;t.copyTexImage2D(t.TEXTURE_2D,0,c,0,0,s,a,0);r._width=s;r._height=a;if(n)t.bindFramebuffer(t.FRAMEBUFFER,i._glFrameBuffer)}return true};t.destroyGrabPass=function e(){this.grabPassRenderTarget.destroy();this.grabPassRenderTarget=null;this.grabPassTextureId=null;this.grabPassTexture.destroy();this.grabPassTexture=null};t.updateClientRect=function e(){this.clientRect=this.canvas.getBoundingClientRect()};t.setViewport=function e(t,i,n,r){if(this.vx!==t||this.vy!==i||this.vw!==n||this.vh!==r){this.gl.viewport(t,i,n,r);this.vx=t;this.vy=i;this.vw=n;this.vh=r}};t.setScissor=function e(t,i,n,r){if(this.sx!==t||this.sy!==i||this.sw!==n||this.sh!==r){this.gl.scissor(t,i,n,r);this.sx=t;this.sy=i;this.sw=n;this.sh=r}};t.getProgramLibrary=function e(){return this.programLib};t.setProgramLibrary=function e(t){this.programLib=t};t.setFramebuffer=function e(t){if(this.activeFramebuffer!==t){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t);this.activeFramebuffer=t}};t._checkFbo=function e(){var t=this.gl;var i=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(i){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED");break;case t.FRAMEBUFFER_COMPLETE:break}};t.copyRenderTarget=function e(t,i,n,r){var s=this.gl;if(!this.webgl2&&r)return false;if(n)if(!i){if(!t._colorBuffer)return false}else{if(!t._colorBuffer||!i._colorBuffer)return false;if(t._colorBuffer._format!==i._colorBuffer._format)return false}if(r){if(!t._depthBuffer||!i._depthBuffer)return false;if(t._depthBuffer._format!==i._depthBuffer._format)return false}if(this.webgl2&&i){var a=this.renderTarget;this.renderTarget=i;this.updateBegin();s.bindFramebuffer(s.READ_FRAMEBUFFER,t?t._glFrameBuffer:null);s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i._glFrameBuffer);var o=t?t.width:i.width;var l=t?t.height:i.height;s.blitFramebuffer(0,0,o,l,0,0,o,l,(n?s.COLOR_BUFFER_BIT:0)|(r?s.DEPTH_BUFFER_BIT:0),s.NEAREST);this.renderTarget=a;s.bindFramebuffer(s.FRAMEBUFFER,a?a._glFrameBuffer:null)}else{var h=this.getCopyShader();this.constantTexSource.setValue(t._colorBuffer);Ar(this,i,h)}return true};t.initRenderTarget=function e(t){if(t._glFrameBuffer)return;t._device=this;var i=this.gl;t._glFrameBuffer=i.createFramebuffer();this.setFramebuffer(t._glFrameBuffer);var n=t._colorBuffer;if(n){if(!n._glTexture){n._width=Math.min(n.width,this.maxRenderBufferSize);n._height=Math.min(n.height,this.maxRenderBufferSize);this.setTexture(n,0)}i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,n._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,n._glTexture,0)}var r=t._depthBuffer;if(r&&this.webgl2){if(!r._glTexture){r._width=Math.min(r.width,this.maxRenderBufferSize);r._height=Math.min(r.height,this.maxRenderBufferSize);this.setTexture(r,0)}if(t._stencil)i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,r._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,t._depthBuffer._glTexture,0);else i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,r._cubemap?i.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:i.TEXTURE_2D,t._depthBuffer._glTexture,0)}else if(t._depth){var s=t._samples>1&&this.webgl2;if(!s){if(!t._glDepthBuffer)t._glDepthBuffer=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,t._glDepthBuffer);if(t._stencil){i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,t.width,t.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,t._glDepthBuffer)}else{i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t.width,t.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,t._glDepthBuffer)}i.bindRenderbuffer(i.RENDERBUFFER,null)}}if(this.webgl2&&t._samples>1){t._glResolveFrameBuffer=t._glFrameBuffer;t._glFrameBuffer=i.createFramebuffer();this.setFramebuffer(t._glFrameBuffer);if(n){if(!t._glMsaaColorBuffer)t._glMsaaColorBuffer=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,t._glMsaaColorBuffer);i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,n._glInternalFormat,t.width,t.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.RENDERBUFFER,t._glMsaaColorBuffer)}if(t._depth){if(!t._glMsaaDepthBuffer)t._glMsaaDepthBuffer=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,t._glMsaaDepthBuffer);if(t._stencil){i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,i.DEPTH24_STENCIL8,t.width,t.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,t._glMsaaDepthBuffer)}else{i.renderbufferStorageMultisample(i.RENDERBUFFER,t._samples,i.DEPTH_COMPONENT32F,t.width,t.height);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,t._glMsaaDepthBuffer)}}}this.targets.push(t)};t.getCopyShader=function e(){if(!this._copyShader)this._copyShader=Qc(this,ul.fullscreenQuadVS,ul.outputTex2DPS,"outputTex2D");return this._copyShader};t.updateBegin=function e(){this.boundVao=null;if(this._tempEnableSafariTextureUnitWorkaround)for(var t=0;t<this.textureUnits.length;++t)for(var i=0;i<3;++i)this.textureUnits[t][i]=null;var n=this.renderTarget;if(n)if(!n._glFrameBuffer)this.initRenderTarget(n);else this.setFramebuffer(n._glFrameBuffer);else this.setFramebuffer(this.defaultFramebuffer)};t.updateEnd=function e(){var t=this.gl;this.boundVao=null;this.gl.bindVertexArray(null);var i=this.renderTarget;if(i){var n=i._colorBuffer;if(n&&n._glTexture&&n.mipmaps&&n.pot){this.activeTexture(this.maxCombinedTextures-1);this.bindTexture(n);t.generateMipmap(n._glTarget)}if(this.webgl2&&i._samples>1&&i.autoResolve)i.resolve()}};t.initializeTexture=function e(t){var i=this.gl;var n;t._glTexture=i.createTexture();t._glTarget=t._cubemap?i.TEXTURE_CUBE_MAP:t._volume?i.TEXTURE_3D:i.TEXTURE_2D;switch(t._format){case Gt:t._glFormat=i.ALPHA;t._glInternalFormat=i.ALPHA;t._glPixelType=i.UNSIGNED_BYTE;break;case Ht:t._glFormat=i.LUMINANCE;t._glInternalFormat=i.LUMINANCE;t._glPixelType=i.UNSIGNED_BYTE;break;case Wt:t._glFormat=i.LUMINANCE_ALPHA;t._glInternalFormat=i.LUMINANCE_ALPHA;t._glPixelType=i.UNSIGNED_BYTE;break;case jt:t._glFormat=i.RGB;t._glInternalFormat=i.RGB;t._glPixelType=i.UNSIGNED_SHORT_5_6_5;break;case Xt:t._glFormat=i.RGBA;t._glInternalFormat=i.RGBA;t._glPixelType=i.UNSIGNED_SHORT_5_5_5_1;break;case qt:t._glFormat=i.RGBA;t._glInternalFormat=i.RGBA;t._glPixelType=i.UNSIGNED_SHORT_4_4_4_4;break;case Yt:t._glFormat=i.RGB;t._glInternalFormat=this.webgl2?i.RGB8:i.RGB;t._glPixelType=i.UNSIGNED_BYTE;break;case Kt:t._glFormat=i.RGBA;t._glInternalFormat=this.webgl2?i.RGBA8:i.RGBA;t._glPixelType=i.UNSIGNED_BYTE;break;case Qt:n=this.extCompressedTextureS3TC;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case $t:n=this.extCompressedTextureS3TC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Zt:n=this.extCompressedTextureS3TC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case hi:n=this.extCompressedTextureETC1;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB_ETC1_WEBGL;break;case fi:n=this.extCompressedTexturePVRTC;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case di:n=this.extCompressedTexturePVRTC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case pi:n=this.extCompressedTexturePVRTC;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case mi:n=this.extCompressedTexturePVRTC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case ci:n=this.extCompressedTextureETC;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB8_ETC2;break;case ui:n=this.extCompressedTextureETC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA8_ETC2_EAC;break;case _i:n=this.extCompressedTextureASTC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case vi:n=this.extCompressedTextureATC;t._glFormat=i.RGB;t._glInternalFormat=n.COMPRESSED_RGB_ATC_WEBGL;break;case gi:n=this.extCompressedTextureATC;t._glFormat=i.RGBA;t._glInternalFormat=n.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case Jt:n=this.extTextureHalfFloat;t._glFormat=i.RGB;if(this.webgl2){t._glInternalFormat=i.RGB16F;t._glPixelType=i.HALF_FLOAT}else{t._glInternalFormat=i.RGB;t._glPixelType=n.HALF_FLOAT_OES}break;case ei:n=this.extTextureHalfFloat;t._glFormat=i.RGBA;if(this.webgl2){t._glInternalFormat=i.RGBA16F;t._glPixelType=i.HALF_FLOAT}else{t._glInternalFormat=i.RGBA;t._glPixelType=n.HALF_FLOAT_OES}break;case ti:t._glFormat=i.RGB;if(this.webgl2)t._glInternalFormat=i.RGB32F;else t._glInternalFormat=i.RGB;t._glPixelType=i.FLOAT;break;case ii:t._glFormat=i.RGBA;if(this.webgl2)t._glInternalFormat=i.RGBA32F;else t._glInternalFormat=i.RGBA;t._glPixelType=i.FLOAT;break;case ni:t._glFormat=i.RED;t._glInternalFormat=i.R32F;t._glPixelType=i.FLOAT;break;case ri:if(this.webgl2){t._glFormat=i.DEPTH_COMPONENT;t._glInternalFormat=i.DEPTH_COMPONENT32F;t._glPixelType=i.FLOAT}else{t._glFormat=i.DEPTH_COMPONENT;t._glInternalFormat=i.DEPTH_COMPONENT;t._glPixelType=i.UNSIGNED_SHORT}break;case si:t._glFormat=i.DEPTH_STENCIL;t._glInternalFormat=i.DEPTH24_STENCIL8;t._glPixelType=i.UNSIGNED_INT_24_8;break;case ai:t._glFormat=i.RGB;t._glInternalFormat=i.R11F_G11F_B10F;t._glPixelType=i.FLOAT;break;case oi:t._glFormat=i.RGB;t._glInternalFormat=i.SRGB8;t._glPixelType=i.UNSIGNED_BYTE;break;case li:t._glFormat=i.RGBA;t._glInternalFormat=i.SRGB8_ALPHA8;t._glPixelType=i.UNSIGNED_BYTE;break}this.textures.push(t)};t.destroyTexture=function e(t){if(t._glTexture){var i=this.textures.indexOf(t);if(i!==-1)this.textures.splice(i,1);for(var n in this.scope.variables){var r=this.scope.variables[n];if(r.value===t)r.value=null}for(var s=0;s<this.textureUnits.length;s++){var a=this.textureUnits[s];for(var o=0;o<a.length;o++)if(a[o]===t._glTexture)a[o]=null}var l=this.gl;l.deleteTexture(t._glTexture);delete t._glTexture;delete t._glTarget;delete t._glFormat;delete t._glInternalFormat;delete t._glPixelType;this._vram.tex-=t._gpuSize}};t.setUnpackFlipY=function e(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;var i=this.gl;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,t)}};t.setUnpackPremultiplyAlpha=function e(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;var i=this.gl;i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}};t._isBrowserInterface=function e(t){return typeof HTMLCanvasElement!=="undefined"&&t instanceof HTMLCanvasElement||typeof HTMLImageElement!=="undefined"&&t instanceof HTMLImageElement||typeof HTMLVideoElement!=="undefined"&&t instanceof HTMLVideoElement||typeof ImageBitmap!=="undefined"&&t instanceof ImageBitmap};t.uploadTexture=function e(t){var i=this.gl;if(!t._needsUpload&&(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot))return;var n=0;var r;var s;var a=Math.log2(Math.max(t._width,t._height))+1;while(t._levels[n]||n===0){if(!t._needsUpload&&n===0){n++;continue}else if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;r=t._levels[n];if(n==1&&!t._compressed&&t._levels.length<a){i.generateMipmap(t._glTarget);t._mipmapsUploaded=true}if(t._cubemap){var o;if(this._isBrowserInterface(r[0]))for(o=0;o<6;o++){if(!t._levelsUpdated[0][o])continue;var l=r[o];if(l instanceof HTMLImageElement)if(l.width>this.maxCubeMapSize||l.height>this.maxCubeMapSize){l=RM(l,this.maxCubeMapSize);if(n===0){t._width=l.width;t._height=l.height}}this.setUnpackFlipY(false);this.setUnpackPremultiplyAlpha(t._premultiplyAlpha);i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,t._glInternalFormat,t._glFormat,t._glPixelType,l)}else{s=1/Math.pow(2,n);for(o=0;o<6;o++){if(!t._levelsUpdated[0][o])continue;var h=r[o];if(t._compressed)i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,h);else{this.setUnpackFlipY(false);this.setUnpackPremultiplyAlpha(t._premultiplyAlpha);i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+o,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,h)}}}}else if(t._volume){s=1/Math.pow(2,n);if(t._compressed)i.compressedTexImage3D(i.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,r);else{this.setUnpackFlipY(false);this.setUnpackPremultiplyAlpha(t._premultiplyAlpha);i.texImage3D(i.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,t._glFormat,t._glPixelType,r)}}else{if(this._isBrowserInterface(r)){if(r instanceof HTMLImageElement)if(r.width>this.maxTextureSize||r.height>this.maxTextureSize){r=RM(r,this.maxTextureSize);if(n===0){t._width=r.width;t._height=r.height}}this.setUnpackFlipY(t._flipY);this.setUnpackPremultiplyAlpha(t._premultiplyAlpha);i.texImage2D(i.TEXTURE_2D,n,t._glInternalFormat,t._glFormat,t._glPixelType,r)}else{s=1/Math.pow(2,n);if(t._compressed)i.compressedTexImage2D(i.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,r);else{this.setUnpackFlipY(false);this.setUnpackPremultiplyAlpha(t._premultiplyAlpha);i.texImage2D(i.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,r)}}if(n===0)t._mipmapsUploaded=false;else t._mipmapsUploaded=true}n++}if(t._needsUpload)if(t._cubemap)for(var c=0;c<6;c++)t._levelsUpdated[0][c]=false;else t._levelsUpdated[0]=false;if(!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&t.pot&&t._levels.length===1){i.generateMipmap(t._glTarget);t._mipmapsUploaded=true}if(t._gpuSize)this._vram.tex-=t._gpuSize;t._gpuSize=t.gpuSize;this._vram.tex+=t._gpuSize};t.activeTexture=function e(t){if(this.textureUnit!==t){this.gl.activeTexture(this.gl.TEXTURE0+t);this.textureUnit=t}};t.bindTexture=function e(t){var i=t._glTarget;var n=t._glTexture;var r=this.textureUnit;var s=this.targetToSlot[i];if(this.textureUnits[r][s]!==n){this.gl.bindTexture(i,n);this.textureUnits[r][s]=n}};t.bindTextureOnUnit=function e(t,i){var n=t._glTarget;var r=t._glTexture;var s=this.targetToSlot[n];if(this.textureUnits[i][s]!==r){this.activeTexture(i);this.gl.bindTexture(n,r);this.textureUnits[i][s]=r}};t.setTextureParameters=function e(t){var i=this.gl;var n=t._parameterFlags;var r=t._glTarget;if(n&1){var s=t._minFilter;if(!t.pot||!t._mipmaps||t._compressed&&t._levels.length===1)if(s===At||s===Pt)s=Mt;else if(s===Et||s===It)s=Ct;i.texParameteri(r,i.TEXTURE_MIN_FILTER,this.glFilter[s])}if(n&2)i.texParameteri(r,i.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]);if(n&4)if(this.webgl2)i.texParameteri(r,i.TEXTURE_WRAP_S,this.glAddress[t._addressU]);else i.texParameteri(r,i.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:We]);if(n&8)if(this.webgl2)i.texParameteri(r,i.TEXTURE_WRAP_T,this.glAddress[t._addressV]);else i.texParameteri(r,i.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:We]);if(n&16)if(this.webgl2)i.texParameteri(r,i.TEXTURE_WRAP_R,this.glAddress[t._addressW]);if(n&32)if(this.webgl2)i.texParameteri(r,i.TEXTURE_COMPARE_MODE,t._compareOnRead?i.COMPARE_REF_TO_TEXTURE:i.NONE);if(n&64)if(this.webgl2)i.texParameteri(r,i.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]);if(n&128){var a=this.extTextureFilterAnisotropic;if(a)i.texParameterf(r,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))}};t.setTexture=function e(t,i){if(!t._glTexture)this.initializeTexture(t);if(t._parameterFlags>0||t._needsUpload||t._needsMipmapsUpload||t===this.grabPassTexture){this.activeTexture(i);this.bindTexture(t);if(t._parameterFlags){this.setTextureParameters(t);t._parameterFlags=0}var n=false;if(t===this.grabPassTexture){n=this.updateGrabPass();n=true}if(!n&&(t._needsUpload||t._needsMipmapsUpload)){this.uploadTexture(t);t._needsUpload=false;t._needsMipmapsUpload=false}}else this.bindTextureOnUnit(t,i)};t.createVertexArray=function e(t){var i,n,r;var s;var a=t.length>1;if(a){r="";for(i=0;i<t.length;i++){n=t[i];r+=n.id+n.format.renderingingHash}s=this._vaoMap.get(r)}if(!s){var o=this.gl;s=o.createVertexArray();o.bindVertexArray(s);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null);var l,h;for(i=0;i<t.length;i++){n=t[i];o.bindBuffer(o.ARRAY_BUFFER,n.bufferId);h=n.format.elements;for(var c=0;c<h.length;c++){l=h[c];var u=ar[l.name];o.vertexAttribPointer(u,l.numComponents,this.glType[l.dataType],l.normalize,l.stride,l.offset);o.enableVertexAttribArray(u);if(n.instancing)o.vertexAttribDivisor(u,1)}}o.bindVertexArray(null);o.bindBuffer(o.ARRAY_BUFFER,null);if(a)this._vaoMap.set(r,s)}return s};t.setBuffers=function e(){var t=this.gl;var i,n;if(this.vertexBuffers.length===1){i=this.vertexBuffers[0];if(!i._vao)i._vao=this.createVertexArray(this.vertexBuffers);n=i._vao}else n=this.createVertexArray(this.vertexBuffers);if(this.boundVao!==n){this.boundVao=n;t.bindVertexArray(n)}this.vertexBuffers.length=0;var r=this.indexBuffer?this.indexBuffer.bufferId:null;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r)};t.draw=function e(t,i,n){var r=this.gl;var s,a,o;var l,h,c,u;var f,d,p,m;var _=this.shader;var v=_.samplers;var g=_.uniforms;if(!n)this.setBuffers();var y=0;for(s=0,o=v.length;s<o;s++){l=v[s];h=l.scopeId.value;if(!h)continue;if(h instanceof bu){c=h;this.setTexture(c,y);if(l.slot!==y){r.uniform1i(l.locationId,y);l.slot=y}y++}else{l.array.length=0;u=h.length;for(a=0;a<u;a++){c=h[a];this.setTexture(c,y);l.array[a]=y;y++}r.uniform1iv(l.locationId,l.array)}}for(s=0,o=g.length;s<o;s++){f=g[s];d=f.scopeId;p=f.version;m=d.versionObject.version;if(p.globalId!==m.globalId||p.revision!==m.revision){p.globalId=m.globalId;p.revision=m.revision;if(d.value!==null)this.commitFunction[f.dataType](f,d.value)}}if(this.webgl2&&this.transformFeedbackBuffer){r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId);r.beginTransformFeedback(r.POINTS)}var b=this.glPrimitive[t.type];var x=t.count;if(t.indexed){var S=this.indexBuffer;var w=S.glFormat;var T=t.base*S.bytesPerIndex;if(i>0)r.drawElementsInstanced(b,x,w,T,i);else r.drawElements(b,x,w,T)}else{var M=t.base;if(i>0)r.drawArraysInstanced(b,M,x,i);else r.drawArrays(b,M,x)}if(this.webgl2&&this.transformFeedbackBuffer){r.endTransformFeedback();r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,0,null)}this._drawCallsPerFrame++};t.clear=function e(t){var i=this.defaultClearOptions;t=t||i;var n=t.flags==undefined?i.flags:t.flags;if(n!==0){var r=this.gl;if(n&ft){var s=t.color==undefined?i.color:t.color;this.setClearColor(s[0],s[1],s[2],s[3])}if(n&dt){var a=t.depth==undefined?i.depth:t.depth;this.setClearDepth(a);if(!this.depthWrite)r.depthMask(true)}if(n&pt){var o=t.stencil==undefined?i.stencil:t.stencil;this.setClearStencil(o)}r.clear(this.glClearFlag[n]);if(n&dt)if(!this.depthWrite)r.depthMask(false)}};t.readPixels=function e(t,i,n,r,s){var a=this.gl;a.readPixels(t,i,n,r,a.RGBA,a.UNSIGNED_BYTE,s)};t.setClearDepth=function e(t){if(t!==this.clearDepth){this.gl.clearDepth(t);this.clearDepth=t}};t.setClearColor=function e(t,i,n,r){if(t!==this.clearRed||i!==this.clearGreen||n!==this.clearBlue||r!==this.clearAlpha){this.gl.clearColor(t,i,n,r);this.clearRed=t;this.clearGreen=i;this.clearBlue=n;this.clearAlpha=r}};t.setClearStencil=function e(t){if(t!==this.clearStencil){this.gl.clearStencil(t);this.clearStencil=t}};t.setRenderTarget=function e(t){this.renderTarget=t};t.getRenderTarget=function e(){return this.renderTarget};t.getDepthTest=function e(){return this.depthTest};t.setDepthTest=function e(t){if(this.depthTest!==t){var i=this.gl;if(t)i.enable(i.DEPTH_TEST);else i.disable(i.DEPTH_TEST);this.depthTest=t}};t.setDepthFunc=function e(t){if(this.depthFunc===t)return;this.gl.depthFunc(this.glComparison[t]);this.depthFunc=t};t.getDepthWrite=function e(){return this.depthWrite};t.setDepthWrite=function e(t){if(this.depthWrite!==t){this.gl.depthMask(t);this.depthWrite=t}};t.setColorWrite=function e(t,i,n,r){if(this.writeRed!==t||this.writeGreen!==i||this.writeBlue!==n||this.writeAlpha!==r){this.gl.colorMask(t,i,n,r);this.writeRed=t;this.writeGreen=i;this.writeBlue=n;this.writeAlpha=r}};t.setAlphaToCoverage=function e(t){if(!this.webgl2)return;if(this.alphaToCoverage===t)return;this.alphaToCoverage=t;if(t)this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE);else this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE)};t.setTransformFeedbackBuffer=function e(t){if(this.transformFeedbackBuffer===t)return;this.transformFeedbackBuffer=t;if(this.webgl2){var i=this.gl;if(t){if(!this.feedback)this.feedback=i.createTransformFeedback();i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,this.feedback)}else i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,null)}};t.setRaster=function e(t){if(this.raster===t)return;this.raster=t;if(this.webgl2)if(t)this.gl.disable(this.gl.RASTERIZER_DISCARD);else this.gl.enable(this.gl.RASTERIZER_DISCARD)};t.setDepthBias=function e(t){if(this.depthBiasEnabled===t)return;this.depthBiasEnabled=t;if(t)this.gl.enable(this.gl.POLYGON_OFFSET_FILL);else this.gl.disable(this.gl.POLYGON_OFFSET_FILL)};t.setDepthBiasValues=function e(t,i){this.gl.polygonOffset(i,t)};t.getBlending=function e(){return this.blending};t.setBlending=function e(t){if(this.blending!==t){var i=this.gl;if(t)i.enable(i.BLEND);else i.disable(i.BLEND);this.blending=t}};t.setStencilTest=function e(t){if(this.stencil!==t){var i=this.gl;if(t)i.enable(i.STENCIL_TEST);else i.disable(i.STENCIL_TEST);this.stencil=t}};t.setStencilFunc=function e(t,i,n){if(this.stencilFuncFront!==t||this.stencilRefFront!==i||this.stencilMaskFront!==n||this.stencilFuncBack!==t||this.stencilRefBack!==i||this.stencilMaskBack!==n){var r=this.gl;r.stencilFunc(this.glComparison[t],i,n);this.stencilFuncFront=this.stencilFuncBack=t;this.stencilRefFront=this.stencilRefBack=i;this.stencilMaskFront=this.stencilMaskBack=n}};t.setStencilFuncFront=function e(t,i,n){if(this.stencilFuncFront!==t||this.stencilRefFront!==i||this.stencilMaskFront!==n){var r=this.gl;r.stencilFuncSeparate(r.FRONT,this.glComparison[t],i,n);this.stencilFuncFront=t;this.stencilRefFront=i;this.stencilMaskFront=n}};t.setStencilFuncBack=function e(t,i,n){if(this.stencilFuncBack!==t||this.stencilRefBack!==i||this.stencilMaskBack!==n){var r=this.gl;r.stencilFuncSeparate(r.BACK,this.glComparison[t],i,n);this.stencilFuncBack=t;this.stencilRefBack=i;this.stencilMaskBack=n}};t.setStencilOperation=function e(t,i,n,r){if(this.stencilFailFront!==t||this.stencilZfailFront!==i||this.stencilZpassFront!==n||this.stencilFailBack!==t||this.stencilZfailBack!==i||this.stencilZpassBack!==n){this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[i],this.glStencilOp[n]);this.stencilFailFront=this.stencilFailBack=t;this.stencilZfailFront=this.stencilZfailBack=i;this.stencilZpassFront=this.stencilZpassBack=n}if(this.stencilWriteMaskFront!==r||this.stencilWriteMaskBack!==r){this.gl.stencilMask(r);this.stencilWriteMaskFront=r;this.stencilWriteMaskBack=r}};t.setStencilOperationFront=function e(t,i,n,r){if(this.stencilFailFront!==t||this.stencilZfailFront!==i||this.stencilZpassFront!==n){this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[i],this.glStencilOp[n]);this.stencilFailFront=t;this.stencilZfailFront=i;this.stencilZpassFront=n}if(this.stencilWriteMaskFront!==r){this.gl.stencilMaskSeparate(this.gl.FRONT,r);this.stencilWriteMaskFront=r}};t.setStencilOperationBack=function e(t,i,n,r){if(this.stencilFailBack!==t||this.stencilZfailBack!==i||this.stencilZpassBack!==n){this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[i],this.glStencilOp[n]);this.stencilFailBack=t;this.stencilZfailBack=i;this.stencilZpassBack=n}if(this.stencilWriteMaskBack!==r){this.gl.stencilMaskSeparate(this.gl.BACK,r);this.stencilWriteMaskBack=r}};t.setBlendFunction=function e(t,i){if(this.blendSrc!==t||this.blendDst!==i||this.separateAlphaBlend){this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[i]);this.blendSrc=t;this.blendDst=i;this.separateAlphaBlend=false}};t.setBlendFunctionSeparate=function e(t,i,n,r){if(this.blendSrc!==t||this.blendDst!==i||this.blendSrcAlpha!==n||this.blendDstAlpha!==r||!this.separateAlphaBlend){this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[i],this.glBlendFunction[n],this.glBlendFunction[r]);this.blendSrc=t;this.blendDst=i;this.blendSrcAlpha=n;this.blendDstAlpha=r;this.separateAlphaBlend=true}};t.setBlendEquation=function e(t){if(this.blendEquation!==t||this.separateAlphaEquation){this.gl.blendEquation(this.glBlendEquation[t]);this.blendEquation=t;this.separateAlphaEquation=false}};t.setBlendEquationSeparate=function e(t,i){if(this.blendEquation!==t||this.blendAlphaEquation!==i||!this.separateAlphaEquation){this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[i]);this.blendEquation=t;this.blendAlphaEquation=i;this.separateAlphaEquation=true}};t.setCullMode=function e(t){if(this.cullMode!==t){if(t===xt)this.gl.disable(this.gl.CULL_FACE);else{if(this.cullMode===xt)this.gl.enable(this.gl.CULL_FACE);var i=this.glCull[t];if(this.cullFace!==i){this.gl.cullFace(i);this.cullFace=i}}this.cullMode=t}};t.getCullMode=function e(){return this.cullMode};t.setIndexBuffer=function e(t){this.indexBuffer=t};t.setVertexBuffer=function e(t){if(t)this.vertexBuffers.push(t)};t.compileShaderSource=function e(t,i){var n=this.gl;var r=i?this.vertexShaderCache[t]:this.fragmentShaderCache[t];if(!r){r=n.createShader(i?n.VERTEX_SHADER:n.FRAGMENT_SHADER);n.shaderSource(r,t);n.compileShader(r);if(i)this.vertexShaderCache[t]=r;else this.fragmentShaderCache[t]=r}return r};t.compileAndLinkShader=function e(t){var i=this.gl;var n=t.definition;var r,s=n.attributes;var a=this.compileShaderSource(n.vshader,true);var o=this.compileShaderSource(n.fshader,false);var l=i.createProgram();i.attachShader(l,a);i.attachShader(l,o);if(this.webgl2&&n.useTransformFeedback){var h=[];for(r in s)if(s.hasOwnProperty(r))h.push("out_"+r);i.transformFeedbackVaryings(l,h,i.INTERLEAVED_ATTRIBS)}for(r in s)if(s.hasOwnProperty(r)){var c=s[r];var u=ar[c];i.bindAttribLocation(l,u,r)}i.linkProgram(l);t._glVertexShader=a;t._glFragmentShader=o;t._glProgram=l};t.createShader=function e(t){this.compileAndLinkShader(t);this.shaders.push(t)};t.destroyShader=function e(t){var i=this.shaders.indexOf(t);if(i!==-1)this.shaders.splice(i,1);if(t._glProgram){this.gl.deleteProgram(t._glProgram);t._glProgram=null;this.removeShaderFromCache(t)}};t._addLineNumbers=function e(t){var i=t.split("\n");for(var n=0,r=i.length;n<r;n++)i[n]=n+1+":\t"+i[n];return i.join("\n")};t.postLink=function e(t){var i=this.gl;var n=t._glVertexShader;var r=t._glFragmentShader;var s=t._glProgram;var a=t.definition;if(!i.getShaderParameter(n,i.COMPILE_STATUS)){console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(a.vshader)+"\n\n"+i.getShaderInfoLog(n));return false}if(!i.getShaderParameter(r,i.COMPILE_STATUS)){console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(a.fshader)+"\n\n"+i.getShaderInfoLog(r));return false}if(!i.getProgramParameter(s,i.LINK_STATUS)){console.error("Failed to link shader program. Error: "+i.getProgramInfoLog(s));return false}var o,l,h,c;o=0;var u=i.getProgramParameter(s,i.ACTIVE_ATTRIBUTES);while(o<u){l=i.getActiveAttrib(s,o++);h=i.getAttribLocation(s,l.name);if(a.attributes[l.name]===undefined)console.error('Vertex shader attribute "'+l.name+'" is not mapped to a semantic in shader definition.');c=new EM(this,a.attributes[l.name],this.pcUniformType[l.type],h);t.attributes.push(c)}o=0;var f=i.getProgramParameter(s,i.ACTIVE_UNIFORMS);while(o<f){l=i.getActiveUniform(s,o++);h=i.getUniformLocation(s,l.name);c=new EM(this,l.name,this.pcUniformType[l.type],h);if(l.type===i.SAMPLER_2D||l.type===i.SAMPLER_CUBE||this.webgl2&&(l.type===i.SAMPLER_2D_SHADOW||l.type===i.SAMPLER_CUBE_SHADOW||l.type===i.SAMPLER_3D))t.samplers.push(c);else t.uniforms.push(c)}t.ready=true;return true};t.setShader=function e(t){if(t!==this.shader){if(!t.ready)if(!this.postLink(t))return false;this.shader=t;this.gl.useProgram(t._glProgram);this.attributesInvalidated=true}return true};t.getHdrFormat=function e(){if(this.textureHalfFloatRenderable)return ei;else if(this.textureFloatRenderable)return ii;return Kt};t.getBoneLimit=function e(){return this.boneLimit};t.setBoneLimit=function e(t){this.boneLimit=t};t.resizeCanvas=function e(t,i){this._width=t;this._height=i;var n=Math.min(this._maxPixelRatio,window.devicePixelRatio);t*=n;i*=n;if(this.canvas.width===t&&this.canvas.height===i)return;this.canvas.width=t;this.canvas.height=i;this.fire(IM,t,i)};t.setResolution=function e(t,i){this._width=t;this._height=i;this.canvas.width=t;this.canvas.height=i;this.fire(IM,t,i)};t.clearShaderCache=function e(){var t=this.gl;var i;for(i in this.fragmentShaderCache){t.deleteShader(this.fragmentShaderCache[i]);delete this.fragmentShaderCache[i]}for(i in this.vertexShaderCache){t.deleteShader(this.vertexShaderCache[i]);delete this.vertexShaderCache[i]}this.programLib.clearCache()};t.clearVertexArrayObjectCache=function e(){var n=this.gl;this._vaoMap.forEach(function(e,t,i){n.deleteVertexArray(e)});this._vaoMap.clear()};t.removeShaderFromCache=function e(t){this.programLib.removeFromCache(t)};t.destroy=function e(){var t=this.gl;this.destroyGrabPass();if(this.webgl2&&this.feedback)t.deleteTransformFeedback(this.feedback);this.clearShaderCache();this.clearVertexArrayObjectCache();this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,false);this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,false);this._contextLostHandler=null;this._contextRestoredHandler=null;this.canvas=null;this.gl=null};U(e,[{key:"width",get:function e(){return this.gl.drawingBufferWidth||this.canvas.width}},{key:"height",get:function e(){return this.gl.drawingBufferHeight||this.canvas.height}},{key:"fullscreen",get:function e(){return!!document.fullscreenElement},set:function e(t){if(t){var i=this.gl.canvas;i.requestFullscreen()}else document.exitFullscreen()}},{key:"enableAutoInstancing",get:function e(){return this._enableAutoInstancing},set:function e(t){this._enableAutoInstancing=t&&this.extInstancing}},{key:"maxPixelRatio",get:function e(){return this._maxPixelRatio},set:function e(t){this._maxPixelRatio=t;this.resizeCanvas(this._width,this._height)}},{key:"textureFloatHighPrecision",get:function e(){if(this._textureFloatHighPrecision===undefined)this._textureFloatHighPrecision=kM(this);return this._textureFloatHighPrecision}},{key:"textureHalfFloatUpdatable",get:function e(){if(this._textureHalfFloatUpdatable===undefined)if(this.webgl2)this._textureHalfFloatUpdatable=true;else this._textureHalfFloatUpdatable=DM(this.gl,this.extTextureHalfFloat.HALF_FLOAT_OES);return this._textureHalfFloatUpdatable}}]);return e}(u),FM={depth:true,face:0},BM=function(){function e(e){var t=arguments[1];var i=arguments[2];if(e instanceof OM){this._colorBuffer=t;e=i}else this._colorBuffer=e.colorBuffer;this._glFrameBuffer=null;this._glDepthBuffer=null;e=e!==undefined?e:FM;this._depthBuffer=e.depthBuffer;this._face=e.face!==undefined?e.face:0;if(this._depthBuffer){var n=this._depthBuffer._format;if(n===ri){this._depth=true;this._stencil=false}else if(n===si){this._depth=true;this._stencil=true}else{this._depth=false;this._stencil=false}}else{this._depth=e.depth!==undefined?e.depth:true;this._stencil=e.stencil!==undefined?e.stencil:false}this._samples=e.samples!==undefined?e.samples:1;this.autoResolve=e.autoResolve!==undefined?e.autoResolve:true;this._glResolveFrameBuffer=null;this._glMsaaColorBuffer=null;this._glMsaaDepthBuffer=null}var t=e.prototype;t.destroy=function e(){if(!this._device)return;var t=this._device;var i=t.targets.indexOf(this);if(i!==-1)t.targets.splice(i,1);var n=t.gl;if(this._glFrameBuffer){n.deleteFramebuffer(this._glFrameBuffer);this._glFrameBuffer=null}if(this._glDepthBuffer){n.deleteRenderbuffer(this._glDepthBuffer);this._glDepthBuffer=null}if(this._glResolveFrameBuffer){n.deleteFramebuffer(this._glResolveFrameBuffer);this._glResolveFrameBuffer=null}if(this._glMsaaColorBuffer){n.deleteRenderbuffer(this._glMsaaColorBuffer);this._glMsaaColorBuffer=null}if(this._glMsaaDepthBuffer){n.deleteRenderbuffer(this._glMsaaDepthBuffer);this._glMsaaDepthBuffer=null}};t.loseContext=function e(){this._glFrameBuffer=undefined;this._glDepthBuffer=undefined;this._glResolveFrameBuffer=undefined;this._glMsaaColorBuffer=undefined;this._glMsaaDepthBuffer=undefined};t.resolve=function e(t,i){if(t===void 0)t=true;if(i===void 0)i=!!this._depthBuffer;if(!this._device)return;if(!this._device.webgl2)return;var n=this._device.gl;n.bindFramebuffer(n.READ_FRAMEBUFFER,this._glFrameBuffer);n.bindFramebuffer(n.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);n.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?n.COLOR_BUFFER_BIT:0)|(i?n.DEPTH_BUFFER_BIT:0),n.NEAREST);n.bindFramebuffer(n.FRAMEBUFFER,this._glFrameBuffer)};t.copy=function e(t,i,n){if(!this._device)if(t._device)this._device=t._device;else return false;return this._device.copyRenderTarget(t,this,i,n)};U(e,[{key:"colorBuffer",get:function e(){return this._colorBuffer}},{key:"depthBuffer",get:function e(){return this._depthBuffer}},{key:"face",get:function e(){return this._face}},{key:"width",get:function e(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}},{key:"height",get:function e(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}}]);return e}();function NM(e,t,i){var n=t._colorBuffer;if(n.format!=Kt)return;var r=new Uint8Array(n.width*n.height*4);var s=e.gl;e.setFramebuffer(t._glFrameBuffer);s.readPixels(0,0,n.width,n.height,s.RGBA,s.UNSIGNED_BYTE,r);if(!n._levels)n._levels=[];if(!n._levels[0])n._levels[0]=[];n._levels[0][i]=r}function zM(e){var t=e.device;var i=e.sourceCubemap;var n=e.method;var r=e.samples;var s=e.cpuSync;if(s&&!i._levels[0])return;var a=i.type;var o=a===vn;var l=Qc(t,ul.fullscreenQuadVS,ul.rgbmPS+ul.prefilterCubemapPS.replace(/\$METHOD/g,n===0?"cos":"phong").replace(/\$NUMSAMPLES/g,r).replace(/\$textureCube/g,o?"textureCubeRGBM":"textureCube"),"prefilter"+n+""+r+""+o);var h=Qc(t,ul.fullscreenQuadVS,ul.outputCubemapPS,"outputCubemap");var c=t.scope.resolve("source");var u=t.scope.resolve("params");var f=new ue;var d=i.width;var p=i.format;var m=[[],e.filteredFixed,e.filteredRgbm,e.filteredFixedRgbm];var _=n===0?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1];var v=[64,32,16,8,4,2,1];var g=7;var y;var b,x,S;var w=p===Yt;var T=false;var M,C;if(s)T=i._levels[0][0]instanceof HTMLImageElement;if((w||T)&&s){p=Kt;M=new bu(t,{cubemap:true,type:a,format:p,width:d,height:d,mipmaps:false});M.name="prefiltered-cube";for(x=0;x<6;x++){y=new BM(t,M,{face:x,depth:false});f.x=x;f.y=0;c.setValue(i);u.setValue(f.data);Ar(t,y,h);NM(t,y,x)}i=M}if(d>128){var A=Math.round(Math.log2(128));var P=Math.round(Math.log2(d));var E=P-A;for(b=0;b<E;b++){d=i.width*.5;var I=n===0?1:Math.pow(2,Math.round(Math.log2(_[0])+(E-b)*2));M=new bu(t,{cubemap:true,type:a,format:p,width:d,height:d,mipmaps:false});M.name="prefiltered-cube";for(x=0;x<6;x++){y=new BM(t,M,{face:x,depth:false});f.x=x;f.y=I;f.z=d;f.w=o?3:0;c.setValue(i);u.setValue(f.data);Ar(t,y,h);if(b===E-1&&s)NM(t,y,x)}i=M}}e.sourceCubemap=i;var R=null;if(!o&&e.filteredFixedRgbm){M=new bu(t,{cubemap:true,type:vn,format:Kt,width:d,height:d,mipmaps:false});M.name="prefiltered-cube";for(x=0;x<6;x++){y=new BM(t,M,{face:x,depth:false});f.x=x;f.w=2;c.setValue(i);u.setValue(f.data);Ar(t,y,h);NM(t,y,x)}R=M}var L=n===0?1:2048;var D=n===0?0:-1;m[D]=[];for(b=0;b<g;b++)for(S=D;S<m.length;S++)if(m[S]!=null){m[S][b]=new bu(t,{cubemap:true,type:S<2?a:vn,format:S<2?p:Kt,fixCubemapSeams:S===1||S===3,width:v[b],height:v[b],mipmaps:false});m[S][b].name="prefiltered-cube"}for(S=D;S<m.length;S++)if(m[S]!=null){if(S>1&&o){m[S]=m[S-2];continue}for(b=0;b<g;b++)for(x=0;x<6;x++){y=new BM(t,m[S][b],{face:x,depth:false});f.x=x;f.y=S<0?L:_[b];f.z=v[b];f.w=o?3:S;c.setValue(b===0?i:n===0?m[0][b-1]:m[-1][b-1]);u.setValue(f.data);Ar(t,y,l);if(s)NM(t,y,x)}}e.filtered=m[0];var k;if(s&&e.singleFilteredFixed){k=[i].concat(e.filteredFixed);C=new bu(t,{cubemap:true,type:a,fixCubemapSeams:true,format:p,width:128,height:128,addressU:We,addressV:We});C.name="prefiltered-cube";for(b=0;b<k.length;b++)C._levels[b]=k[b]._levels[0];C.upload();C._prefilteredMips=true;e.singleFilteredFixed=C}if(s&&e.singleFilteredFixedRgbm&&e.filteredFixedRgbm){k=[R].concat(e.filteredFixedRgbm);C=new bu(t,{cubemap:true,type:vn,fixCubemapSeams:true,format:Kt,width:128,height:128,addressU:We,addressV:We});C.name="prefiltered-cube";for(b=0;b<k.length;b++)C._levels[b]=k[b]._levels[0];C.upload();C._prefilteredMips=true;e.singleFilteredFixedRgbm=C}}function VM(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}function UM(e,t,i){var n=2*(e+.5)/i-1;var r=2*(t+.5)/i-1;n*=1-1/i;r*=1-1/i;var s=1/i;var a=n-s;var o=r-s;var l=n+s;var h=r+s;var c=VM(a,o)-VM(a,h)-VM(l,o)+VM(l,h);if(e===0&&t===0||e===i-1&&t===0||e===0&&t===i-1||e===i-1&&t===i-1)c/=3;else if(e===0||t===0||e===i-1||t===i-1)c*=.5;return c}function GM(e,t,i){var n;var r=t.width;var s,a;if(t.format!==Kt)return;if(!t._levels[0])return;if(!t._levels[0][0].length)if(t._levels[0][0]instanceof HTMLImageElement){var o=e.gl;var l=Qc(e,ul.fullscreenQuadVS,ul.fullscreenQuadPS,"fsQuadSimple");var h=e.scope.resolve("source");for(n=0;n<6;n++){var c=t._levels[0][n];var u=new bu(e,{cubemap:false,type:_n,format:t.format,width:r,height:r,mipmaps:false});u.name="prefiltered-cube";u._levels[0]=c;u.upload();var f=new bu(e,{cubemap:false,type:_n,format:t.format,width:r,height:r,mipmaps:false});f.name="prefiltered-cube";var d=new BM(e,f,{depth:false});h.setValue(u);Ar(e,d,l);var p=new Uint8Array(r*r*4);o.bindFramebuffer(o.FRAMEBUFFER,d._glFrameBuffer);o.readPixels(0,0,u.width,u.height,o.RGBA,o.UNSIGNED_BYTE,p);t._levels[0][n]=p}}else return;var m=[];for(a=0;a<r;a++)for(s=0;s<r;s++){var _=s/(r-1)*2-1;var v=a/(r-1)*2-1;m[a*r+s]=new ce(_,v,1).normalize()}var g=new Float32Array(9*3);var y=0;var b=1*3;var x=2*3;var S=3*3;var w=4*3;var T=5*3;var M=6*3;var C=7*3;var A=8*3;var P=0;var E=1;var I=2;var R=3;var L=4;var D=5;var k,O,F,B,N,z,V,U,G;var H,W,j,X,q;var Y=0;for(n=0;n<6;n++)for(a=0;a<r;a++)for(s=0;s<r;s++){k=a*r+s;N=UM(s,a,r);H=N*4/17;W=N*8/17;j=N*15/17;X=N*5/68;q=N*15/68;z=m[k];if(n==P){V=z.z;U=-z.y;G=-z.x}else if(n==E){V=-z.z;U=-z.y;G=z.x}else if(n==I){V=z.x;U=z.z;G=z.y}else if(n==R){V=z.x;U=-z.z;G=-z.y}else if(n==L){V=z.x;U=-z.y;G=z.z}else if(n==D){V=-z.x;U=-z.y;G=-z.z}if(!i)V=-V;F=t._levels[0][n][k*4+3]/255;for(O=0;O<3;O++){B=t._levels[0][n][k*4+O]/255;if(t.type===vn){B*=F*8;B*=B}else B=Math.pow(B,2.2);g[y+O]+=B*H;g[b+O]+=B*W*V;g[x+O]+=B*W*U;g[S+O]+=B*W*G;g[w+O]+=B*j*V*G;g[T+O]+=B*j*G*U;g[M+O]+=B*j*U*V;g[C+O]+=B*X*(3*G*G-1);g[A+O]+=B*q*(V*V-U*U);Y+=N}}for(O=0;O<g.length;O++)g[O]*=4*Math.PI/Y;return g}function HM(e){switch(e.type){case vn:return"RGBM";case gn:return"RGBE";default:switch(e.format){case Jt:case ti:case ei:case ii:return"Linear";default:return"Gamma"}}}function WM(e,t,i,n,r){if(r===void 0)r=1024;var s=n!==undefined?"prefilter":"reproject";var a="decode"+HM(t);var o="encode"+HM(i);var l=t.cubemap?"sampleCubemap":"sampleEquirect";var h=i.cubemap?"getDirectionCubemap":"getDirectionEquirect";var c=Qc(e,ul.fullscreenQuadVS,"#define PROCESS_FUNC "+s+"\n"+"#define DECODE_FUNC "+a+"\n"+"#define ENCODE_FUNC "+o+"\n"+"#define SOURCE_FUNC "+l+"\n"+"#define TARGET_FUNC "+h+"\n"+"#define NUM_SAMPLES "+r+"\n\n"+ul.reprojectPS,s+a+o+l+h,null,e.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n");var u=e.scope.resolve(t.cubemap?"sourceCube":"sourceTex");u.setValue(t);var f=e.scope.resolve("params");var d=new Float32Array(4);d[1]=n!==undefined?n:1;d[2]=1-(t.fixCubemapSeams?1/t.width:0);d[3]=1-(i.fixCubemapSeams?1/i.width:0);for(var p=0;p<(i.cubemap?6:1);p++){var m=new BM(e,i,{face:p,depth:false});d[0]=p;f.setValue(d);Ar(e,m,c)}}var jM={type:Ti,base:0,count:4,indexed:false},XM=function(){function e(e){this.device=e;this.shader=null;this.depthMap=null;this.vertexBuffer=qM(e);this.needsDepthBuffer=false}var t=e.prototype;t.render=function e(t,i,n){};return e}();function qM(e){var t=new cr(e,[{semantic:Ci,components:2,type:In}]);var i=new lr(e,t,4);var n=new Tr(i);n.element[Ci].set(-1,-1);n.next();n.element[Ci].set(1,-1);n.next();n.element[Ci].set(-1,1);n.next();n.element[Ci].set(1,1);n.end();return i}function YM(e,t,i,n,r){var s=e.getRenderTarget();e.setRenderTarget(t);e.updateBegin();var a=t!==null?t.width:e.width;var o=t!==null?t.height:e.height;var l=0;var h=0;if(r){l=r.x*a;h=r.y*o;a*=r.z;o*=r.w}var c=e.vx;var u=e.vy;var f=e.vw;var d=e.vh;e.setViewport(l,h,a,o);var p=e.sx;var m=e.sy;var _=e.sw;var v=e.sh;e.setScissor(l,h,a,o);var g=e.getBlending();var y=e.getDepthTest();var b=e.getDepthWrite();var x=e.getCullMode();var S=e.writeRed;var w=e.writeGreen;var T=e.writeBlue;var M=e.writeAlpha;e.setBlending(false);e.setDepthTest(false);e.setDepthWrite(false);e.setCullMode(xt);e.setColorWrite(true,true,true,true);e.setVertexBuffer(i,0);e.setShader(n);e.draw(jM);e.setBlending(g);e.setDepthTest(y);e.setDepthWrite(b);e.setCullMode(x);e.setColorWrite(S,w,T,M);e.updateEnd();e.setRenderTarget(s);e.updateBegin();e.setViewport(c,u,f,d);e.setScissor(p,m,_,v)}var KM=function(){function e(e,t){if(t===void 0)t=ut;this.device=e.device;var i=this.device.gl;this._inputBuffer=e;if(t===ut&&e.usage!==t){i.bindBuffer(i.ARRAY_BUFFER,e.bufferId);i.bufferData(i.ARRAY_BUFFER,e.storage,i.DYNAMIC_COPY)}this._outputBuffer=new lr(e.device,e.format,e.numVertices,t,e.storage)}e.createShader=function e(t,i,n){return Qc(t,i,null,n,true)};var t=e.prototype;t.destroy=function e(){this._outputBuffer.destroy()};t.process=function e(t,i){if(i===void 0)i=true;var n=this.device;n.setRenderTarget(null);n.updateBegin();n.setVertexBuffer(this._inputBuffer,0);n.setRaster(false);n.setTransformFeedbackBuffer(this._outputBuffer);n.setShader(t);n.draw({type:yi,base:0,count:this._inputBuffer.numVertices,indexed:false});n.setTransformFeedbackBuffer(null);n.setRaster(true);n.updateEnd();if(i){var r=this._inputBuffer.bufferId;this._inputBuffer.bufferId=this._outputBuffer.bufferId;this._outputBuffer.bufferId=r;r=this._inputBuffer._vao;this._inputBuffer._vao=this._outputBuffer._vao;this._outputBuffer._vao=r}};U(e,[{key:"inputBuffer",get:function e(){return this._inputBuffer}},{key:"outputBuffer",get:function e(){return this._outputBuffer}}]);return e}(),QM=function(e){G(t,e);function t(){return e.call(this)||this}var i=t.prototype;i.clone=function e(){var e=new t;Cu.prototype._cloneInternal.call(this,e);return e};i.updateShader=function e(t){var i={skin:!!this.meshInstances[0].skinInstance};var n=t.getProgramLibrary();this.shader=n.getProgram("depth",i)};return t}(Cu),$M=function(){function e(e,t,i){if(e instanceof OM)e=rM.getApplication();this.app=e;this.device=e.graphicsDevice;var n=this.device;this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.mapping=[];this.scene=null;this.drawCalls=[];this.layer=null;this.layerComp=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:ft|dt};var r=this;this._clearDepthOptions={depth:1,flags:dt};this.clearDepthCommand=new Nu(0,0,function(){n.clear(r._clearDepthOptions)});this.resize(t,i);this._ignoreOpacityFor=null}var t=e.prototype;t.getSelection=function e(t,i,n,r){var s=this.device;if(typeof t==="object"){var a=t;t=a.x;i=a.y;n=a.width;r=a.height}else i=this.layer.renderTarget.height-(i+(r||1));t=Math.floor(t);i=Math.floor(i);n=Math.floor(Math.max(n||1,1));r=Math.floor(Math.max(r||1,1));var o=s.renderTarget;s.setRenderTarget(this.layer.renderTarget);s.updateBegin();var l=new Uint8Array(4*n*r);s.readPixels(t,i,n,r,l);s.updateEnd();s.setRenderTarget(o);var h=[];var c=this.mapping;var u,f,d,p;for(var m=0;m<n*r;m++){u=l[4*m+0];f=l[4*m+1];d=l[4*m+2];p=u<<16|f<<8|d;if(p!==16777215){var _=c[p];if(h.indexOf(_)===-1)h.push(_)}}return h};t.prepare=function e(t,i,n){var r=this.device;var s,a;var o=this;if(t instanceof hf)t=t.node.camera;this.scene=i;var l=null;var h=null;if(n instanceof Vf)l=n;else h=n;if(!this.layer){var c=r.scope.resolve("uColor");this.layer=new Vf({name:"Picker",shaderPass:mc,opaqueSortMode:Tc,onEnable:function e(){if(this.renderTarget)return;var t=new bu(r,{format:Kt,width:o.width,height:o.height,mipmaps:false});t.name="pick";t.minFilter=Mt;t.magFilter=Mt;t.addressU=We;t.addressV=We;this.renderTarget=new BM(r,t,{depth:true})},onDisable:function e(){if(!this.renderTarget)return;this.renderTarget._colorBuffer.destroy();this.renderTarget.destroy();this.renderTarget=null},onDrawCall:function e(t,i){o.pickColor[0]=(i>>16&255)/255;o.pickColor[1]=(i>>8&255)/255;o.pickColor[2]=(i&255)/255;c.setValue(o.pickColor);r.setBlending(false);o.mapping[i]=t}});this.layerComp=new ep;this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;this._instancesVersion=-1}var u,f,d;if(!l){this.layer.clearMeshInstances();var p=i.layers.layerList;var m=i.layers.subLayerEnabled;var _=i.layers.subLayerList;var v;var g,y;for(s=0;s<p.length;s++)if(p[s].overrideClear&&p[s]._clearDepthBuffer)p[s]._pickerCleared=false;for(s=0;s<p.length;s++){v=p[s];if(v.renderTarget!==h||!v.enabled||!m[s])continue;g=v.cameras.indexOf(t);if(g<0)continue;if(v.overrideClear&&v._clearDepthBuffer&&!v._pickerCleared){this.meshInstances.push(this.clearDepthCommand);v._pickerCleared=true}y=_[s];u=y?v.instances.transparentMeshInstances:v.instances.opaqueMeshInstances;f=u.length;for(a=0;a<f;a++){d=u[a];if(d.pick)this.meshInstances.push(d)}}}else if(this._instancesVersion!==l._version){this.layer.clearMeshInstances();u=l.instances.opaqueMeshInstances;f=u.length;for(a=0;a<f;a++){d=u[a];if(d.pick)this.meshInstances.push(d)}u=l.instances.transparentMeshInstances;f=u.length;for(a=0;a<f;a++){d=u[a];if(d.pick)this.meshInstances.push(d)}this._instancesVersion=l._version}if(this.layer.cameras[0]!==t){this.layer.clearCameras();this.layer.addCamera(t)}this.onLayerPreRender(this.layer,l,h);o.mapping.length=0;this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};t.onLayerPreRender=function e(t,i,n){if(this.width!==t.renderTarget.width||this.height!==t.renderTarget.height){t.onDisable();t.onEnable()}t.oldClear=t.cameras[0].camera._clearOptions;t.oldAspectMode=t.cameras[0].aspectRatioMode;t.oldAspect=t.cameras[0].aspectRatio;t.cameras[0].camera._clearOptions=this.clearOptions;t.cameras[0].aspectRatioMode=Oc;var r=n?n:i?i.renderTarget:null;t.cameras[0].aspectRatio=t.cameras[0].calculateAspectRatio(r);this.app.renderer.updateCameraFrustum(t.cameras[0].camera)};t.onLayerPostRender=function e(t){t.cameras[0].camera._clearOptions=t.oldClear;t.cameras[0].aspectRatioMode=t.oldAspectMode;t.cameras[0].aspectRatio=t.oldAspect};t.resize=function e(t,i){this.width=t;this.height=i};U(e,[{key:"renderTarget",get:function e(){return this.layer.renderTarget}}]);return e}(),ZM=4096,JM=512,eC=function(o){G(e,o);function e(e,t){var i;if(t===void 0)t={};i=o.call(this)||this;i.type="bitmap";i.app=e;i.intensity=0;i.fontWeight=t.fontWeight||"normal";i.fontSize=parseInt(t.fontSize,10);i.glyphSize=i.fontSize;i.fontName=t.fontName||"Arial";i.color=t.color||new ge(1,1,1);i.padding=t.padding||0;var n=t.width>ZM?ZM:t.width||JM;var r=t.height>ZM?ZM:t.height||JM;var s=document.createElement("canvas");s.height=r;s.width=n;var a=new bu(i.app.graphicsDevice,{format:Kt,autoMipmap:true});a.name="font";a.setSource(s);a.minFilter=It;a.magFilter=Ct;a.addressU=We;a.addressV=We;i.textures=[a];i.chars="";i.data={};return i}var t=e.prototype;t.createTextures=function e(t){var i=this._normalizeCharsSet(t);if(i.length!==this.chars.length){this._renderAtlas(i);return}for(var n=0;n<i.length;n++)if(i[n]!==this.chars[n]){this._renderAtlas(i);return}};t.updateTextures=function e(t){var i=this._normalizeCharsSet(t);var n=[];for(var r=0;r<i.length;r++){var s=i[r];if(!this.data.chars[s])n.push(s)}if(n.length>0)this._renderAtlas(this.chars.concat(n))};t.destroy=function e(){for(var t=0;t<this.textures.length;t++)this.textures[t].destroy();this.chars=null;this.color=null;this.data=null;this.fontName=null;this.fontSize=null;this.glyphSize=null;this.intensity=null;this.textures=null;this.type=null;this.fontWeight=null};t._getAndClearContext=function e(t,i){var n=t.width;var r=t.height;var s=t.getContext("2d",{alpha:true});s.clearRect(0,0,n,r);s.fillStyle=i;s.fillRect(0,0,n,r);return s};t._colorToRgbString=function e(t,i){var n;var r=Math.round(255*t.r);var s=Math.round(255*t.g);var a=Math.round(255*t.b);if(i)n="rgba("+r+", "+s+", "+a+", "+t.a+")";else n="rgb("+r+", "+s+", "+a+")";return n};t.renderCharacter=function e(t,i,n,r,s){t.fillStyle=s;t.fillText(i,n,r)};t._renderAtlas=function e(t){this.chars=t;var i=1;var n=this.textures[i-1].getSource();var r=n.width;var s=n.height;var a=this._colorToRgbString(this.color,false);var o=this.color.a;this.color.a=1/255;var l=this._colorToRgbString(this.color,true);this.color.a=o;var h="center";var c="alphabetic";var u=this._getAndClearContext(n,l);u.font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName;u.textAlign=h;u.textBaseline=c;this.data=this._createJson(this.chars,this.fontName,r,s);var f=Ae.getSymbols(this.chars.join(""));var d=this.textures.length;var p=0;var m=0;var _={};var v,g;for(v=0;v<f.length;v++){g=f[v];_[g]=this._getTextMetrics(g);p=Math.max(p,_[g].height);m=Math.max(m,_[g].descent)}this.glyphSize=Math.max(this.glyphSize,p);var y=this.glyphSize+this.padding*2;var b=this.glyphSize+this.padding*2;var x=this.glyphSize/2+this.padding;var S=b-m-this.padding;var w=0;var T=0;for(v=0;v<f.length;v++){g=f[v];var M=Ae.getCodePoint(f[v]);var C=this.fontSize;u.font=this.fontWeight+" "+C.toString()+"px "+this.fontName;u.textAlign=h;u.textBaseline=c;var A=u.measureText(g).width;if(A>C){C=this.fontSize*this.fontSize/A;u.font=this.fontWeight+" "+C.toString()+"px "+this.fontName;A=this.fontSize}this.renderCharacter(u,g,w+x,T+S,a);var P=this.padding+(this.glyphSize-A)/2;var E=-this.padding+_[g].descent-m;var I=A;this._addChar(this.data,g,M,w,T,y,b,P,E,I,i-1,r,s);w+=y;if(w+y>r){w=0;T+=b;if(T+b>s){this.textures[i-1].upload();i++;T=0;if(i>d){n=document.createElement("canvas");n.height=s;n.width=r;u=this._getAndClearContext(n,l);var R=new bu(this.app.graphicsDevice,{format:Kt,autoMipmap:true});R.name="font-atlas";R.setSource(n);R.minFilter=It;R.magFilter=Ct;R.addressU=We;R.addressV=We;this.textures.push(R)}else{n=this.textures[i-1].getSource();u=this._getAndClearContext(n,l)}}}}this.textures[i-1].upload();if(i<d){for(v=i;v<d;v++)this.textures[v].destroy();this.textures.splice(i)}this.fire("render")};t._createJson=function e(t,i,n,r){var s={version:3,intensity:this.intensity,info:{face:i,width:n,height:r,maps:[{width:n,height:r}]},chars:{}};return s};t._addChar=function e(t,i,n,r,s,a,o,l,h,c,u,f,d){if(t.info.maps.length<u+1)t.info.maps.push({width:f,height:d});var p=this.fontSize/32;t.chars[i]={id:n,letter:i,x:r,y:s,width:a,height:o,xadvance:c/p,xoffset:l/p,yoffset:(h+this.padding)/p,scale:p,range:1,map:u,bounds:[0,0,a/p,o/p]}};t._normalizeCharsSet=function e(t){var i=this.app.systems.element.getUnicodeConverter();if(i)t=i(t);var n={};var r=Ae.getSymbols(t);var s;for(s=0;s<r.length;s++){var a=r[s];if(n[a])continue;n[a]=a}var o=Object.keys(n);return o.sort()};t._getTextMetrics=function e(t){var i=document.createElement("span");i.id="content-span";i.innerHTML=t;var n=document.createElement("div");n.id="content-block";n.style.display="inline-block";n.style.width="1px";n.style.height="0px";var r=document.createElement("div");r.appendChild(i);r.appendChild(n);r.style.font=this.fontName;r.style.fontSize=this.fontSize+"px";var s=document.body;s.appendChild(r);var a=-1;var o=-1;var l=-1;try{n.style["vertical-align"]="baseline";a=n.offsetTop-i.offsetTop;n.style["vertical-align"]="bottom";l=n.offsetTop-i.offsetTop;o=l-a}finally{document.body.removeChild(r)}return{ascent:a,descent:o,height:l}};return e}(u),tC=function(){function e(){}var t=e.prototype;t.load=function e(t,i,n){throw new Error("not implemented")};t.open=function e(t,i,n){throw new Error("not implemented")};t.patch=function e(t,i){};return e}(),iC=new RegExp("^\\s*function(?:\\s|\\s*\\/\\*.*\\*\\/\\s*)+([^\\(\\s\\/]*)\\s*"),nC=function(n){G(e,n);function e(e){var t;t=n.call(this)||this;var i=t.constructor;t.app=e.app;t.entity=e.entity;t._enabled=typeof e.enabled==="boolean"?e.enabled:true;t._enabledOld=t.enabled;t.__destroyed=false;t.__attributes={};t.__attributesRaw=e.attributes||{};t.__scriptType=i;t.__executionOrder=-1;return t}e.__getScriptName=function e(t){if(typeof t!=="function")return undefined;if("name"in Function.prototype)return t.name;if(t===Function||t===Function.prototype.constructor)return"Function";var i=(""+t).match(iC);return i?i[1]:undefined};var t=e.prototype;t.__initializeAttributes=function e(t){if(!t&&!this.__attributesRaw)return;for(var i in this.__scriptType.attributes.index)if(this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(i))this[i]=this.__attributesRaw[i];else if(!this.__attributes.hasOwnProperty(i))if(this.__scriptType.attributes.index[i].hasOwnProperty("default"))this[i]=this.__scriptType.attributes.index[i].default;else this[i]=null;this.__attributesRaw=null};e.extend=function e(t){for(var i in t){if(!t.hasOwnProperty(i))continue;this.prototype[i]=t[i]}};U(e,[{key:"enabled",get:function e(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function e(t){this._enabled=!!t;if(this.enabled===this._enabledOld)return;this._enabledOld=this.enabled;this.fire(this.enabled?"enable":"disable");this.fire("state",this.enabled);if(!this._initialized&&this.enabled){this._initialized=true;this.__initializeAttributes(true);if(this.initialize)this.entity.script._scriptMethod(this,CT.scriptMethods.initialize)}if(this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled){this._postInitialized=true;if(this.postInitialize)this.entity.script._scriptMethod(this,CT.scriptMethods.postInitialize)}}}],[{key:"scriptName",get:function e(){return this.__name}},{key:"attributes",get:function e(){if(!this.hasOwnProperty("__attributes"))this.__attributes=new MT(this);return this.__attributes}}]);return e}(u);nC.__name=null;var rC=new Set(["system","entity","create","destroy","swap","move","scripts","_scripts","_scriptsIndex","_scriptsData","enabled","_oldState","onEnable","onDisable","onPostStateChange","_onSetEnabled","_checkState","_onBeforeRemove","_onInitializeAttributes","_onInitialize","_onPostInitialize","_onUpdate","_onPostUpdate","_callbacks","has","get","on","off","fire","once","hasEvent"]);function sC(e,t){if(Og.legacy)return null;if(rC.has(e))throw new Error("script name: '"+e+"' is reserved, please change script name");var i=function e(t){nC.call(this,t)};i.prototype=Object.create(nC.prototype);i.prototype.constructor=i;i.extend=nC.extend;i.attributes=new MT(i);oC(i,e,t);return i}var aC={};function oC(e,t,i){if(e.legacy)return;if(typeof e!=="function")throw new Error("script class: '"+e+"' must be a constructor function (i.e. class).");if(!(e.prototype instanceof nC))throw new Error("script class: '"+nC.__getScriptName(e)+"' does not extend pc.ScriptType.");t=t||e.__name||nC.__getScriptName(e);if(rC.has(t))throw new Error("script name: '"+t+"' is reserved, please change script name");e.__name=t;var n=i?i.scripts:rM.getApplication().scripts;n.add(e);Fg._push(e)}MT.reservedNames.forEach(function(e,t,i){aC[e]=1}),sC.reservedAttributes=aC;var lC="mouse",hC="keyboard",cC="gamepad",uC="mousex",fC="mousey",dC="padlx",pC="padly",mC="padrx",_C="padry",vC="key",gC="keydown",yC="keyup",bC="mousedown",xC="mousemove",SC="mouseup",wC="mousewheel",TC="touchstart",MC="touchend",CC="touchmove",AC="touchcancel",PC="select",EC="selectstart",IC="selectend",RC=8,LC=9,DC=13,kC=13,OC=16,FC=17,BC=18,NC=19,zC=20,VC=27,UC=32,GC=33,HC=34,WC=35,jC=36,XC=37,qC=38,YC=39,KC=40,QC=44,$C=45,ZC=46,JC=48,eA=49,tA=50,iA=51,nA=52,rA=53,sA=54,aA=55,oA=56,lA=57,hA=59,cA=61,uA=65,fA=66,dA=67,pA=68,mA=69,_A=70,vA=71,gA=72,yA=73,bA=74,xA=75,SA=76,wA=77,TA=78,MA=79,CA=80,AA=81,PA=82,EA=83,IA=84,RA=85,LA=86,DA=87,kA=88,OA=89,FA=90,BA=91,NA=93,zA=96,VA=97,UA=98,GA=99,HA=100,WA=101,jA=102,XA=103,qA=104,YA=105,KA=106,QA=107,$A=108,ZA=109,JA=110,eP=111,tP=112,iP=113,nP=114,rP=115,sP=116,aP=117,oP=118,lP=119,hP=120,cP=121,uP=122,fP=123,dP=188,pP=190,mP=191,_P=219,vP=220,gP=221,yP=224,bP=-1,xP=0,SP=1,wP=2,TP=0,MP=1,CP=2,AP=3,PP=0,EP=1,IP=2,RP=3,LP=4,DP=5,kP=6,OP=7,FP=8,BP=9,NP=10,zP=11,VP=12,UP=13,GP=14,HP=15,WP=16,jP=0,XP=1,qP=2,YP=3,KP=function e(t,i){if(i){this.key=i.keyCode;this.element=i.target;this.event=i}else{this.key=null;this.element=null;this.event=null}},QP=new KP;function $P(e){QP.key=e.keyCode;QP.element=e.target;QP.event=e;return QP}function ZP(e){if(typeof e==="string")return e.toUpperCase().charCodeAt(0);return e}var JP={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},eE=function(n){G(e,n);function e(e,t){var i;if(t===void 0)t={};i=n.call(this)||this;i._element=null;i._keyDownHandler=i._handleKeyDown.bind(H(i));i._keyUpHandler=i._handleKeyUp.bind(H(i));i._keyPressHandler=i._handleKeyPress.bind(H(i));i._keymap={};i._lastmap={};if(e)i.attach(e);i.preventDefault=t.preventDefault||false;i.stopPropagation=t.stopPropagation||false;return i}var t=e.prototype;t.attach=function e(t){if(this._element)this.detach();this._element=t;this._element.addEventListener("keydown",this._keyDownHandler,false);this._element.addEventListener("keypress",this._keyPressHandler,false);this._element.addEventListener("keyup",this._keyUpHandler,false)};t.detach=function e(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};t.toKeyIdentifier=function e(t){t=ZP(t);var i;var n;var r;var s=JP[t.toString()];if(s)return s;n=t.toString(16).toUpperCase();r=n.length;for(i=0;i<4-r;i++)n="0"+n;return"U+"+n};t._handleKeyDown=function e(t){var i=t.keyCode||t.charCode;if(i===undefined)return;var n=this.toKeyIdentifier(i);this._keymap[n]=true;this.fire("keydown",$P(t));if(this.preventDefault)t.preventDefault();if(this.stopPropagation)t.stopPropagation()};t._handleKeyUp=function e(t){var i=t.keyCode||t.charCode;if(i===undefined)return;var n=this.toKeyIdentifier(i);delete this._keymap[n];this.fire("keyup",$P(t));if(this.preventDefault)t.preventDefault();if(this.stopPropagation)t.stopPropagation()};t._handleKeyPress=function e(t){this.fire("keypress",$P(t));if(this.preventDefault)t.preventDefault();if(this.stopPropagation)t.stopPropagation()};t.update=function e(){var t;for(t in this._lastmap)delete this._lastmap[t];for(t in this._keymap)if(this._keymap.hasOwnProperty(t))this._lastmap[t]=this._keymap[t]};t.isPressed=function e(t){var i=ZP(t);var n=this.toKeyIdentifier(i);return!!this._keymap[n]};t.wasPressed=function e(t){var i=ZP(t);var n=this.toKeyIdentifier(i);return!!this._keymap[n]&&!!!this._lastmap[n]};t.wasReleased=function e(t){var i=ZP(t);var n=this.toKeyIdentifier(i);return!!!this._keymap[n]&&!!this._lastmap[n]};return e}(u);function tE(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)}var iE=function e(t,i){var n={x:0,y:0};if(i){if(i instanceof e)throw Error("Expected MouseEvent");n=t._getTargetCoords(i)}else i={};if(n){this.x=n.x;this.y=n.y}else if(tE()){this.x=0;this.y=0}else return;this.wheelDelta=0;if(i.type==="wheel")if(i.deltaY>0)this.wheelDelta=1;else if(i.deltaY<0)this.wheelDelta=-1;if(tE()){this.dx=i.movementX||i.webkitMovementX||i.mozMovementX||0;this.dy=i.movementY||i.webkitMovementY||i.mozMovementY||0}else{this.dx=this.x-t._lastX;this.dy=this.y-t._lastY}if(i.type==="mousedown"||i.type==="mouseup")this.button=i.button;else this.button=bP;this.buttons=t._buttons.slice(0);this.element=i.target;this.ctrlKey=i.ctrlKey||false;this.altKey=i.altKey||false;this.shiftKey=i.shiftKey||false;this.metaKey=i.metaKey||false;this.event=i},nE=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._lastX=0;t._lastY=0;t._buttons=[false,false,false];t._lastbuttons=[false,false,false];t._upHandler=t._handleUp.bind(H(t));t._downHandler=t._handleDown.bind(H(t));t._moveHandler=t._handleMove.bind(H(t));t._wheelHandler=t._handleWheel.bind(H(t));t._contextMenuHandler=function(e){e.preventDefault()};t._target=null;t._attached=false;t.attach(e);return t}e.isPointerLocked=function e(){return tE()};var t=e.prototype;t.attach=function e(t){this._target=t;if(this._attached)return;this._attached=true;var i=m.passiveEvents?{passive:false}:false;window.addEventListener("mouseup",this._upHandler,i);window.addEventListener("mousedown",this._downHandler,i);window.addEventListener("mousemove",this._moveHandler,i);window.addEventListener("wheel",this._wheelHandler,i)};t.detach=function e(){if(!this._attached)return;this._attached=false;this._target=null;var t=m.passiveEvents?{passive:false}:false;window.removeEventListener("mouseup",this._upHandler,t);window.removeEventListener("mousedown",this._downHandler,t);window.removeEventListener("mousemove",this._moveHandler,t);window.removeEventListener("wheel",this._wheelHandler,t)};t.disableContextMenu=function e(){if(!this._target)return;this._target.addEventListener("contextmenu",this._contextMenuHandler)};t.enableContextMenu=function e(){if(!this._target)return;this._target.removeEventListener("contextmenu",this._contextMenuHandler)};t.enablePointerLock=function e(t,i){if(!document.body.requestPointerLock){if(i)i();return}var n=function e(){t();document.removeEventListener("pointerlockchange",e)};var r=function e(){i();document.removeEventListener("pointerlockerror",e)};if(t)document.addEventListener("pointerlockchange",n,false);if(i)document.addEventListener("pointerlockerror",r,false);document.body.requestPointerLock()};t.disablePointerLock=function e(t){if(!document.exitPointerLock)return;var i=function e(){t();document.removeEventListener("pointerlockchange",e)};if(t)document.addEventListener("pointerlockchange",i,false);document.exitPointerLock()};t.update=function e(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]};t.isPressed=function e(t){return this._buttons[t]};t.wasPressed=function e(t){return this._buttons[t]&&!this._lastbuttons[t]};t.wasReleased=function e(t){return!this._buttons[t]&&this._lastbuttons[t]};t._handleUp=function e(t){this._buttons[t.button]=false;var i=new iE(this,t);if(!i.event)return;this.fire(SC,i)};t._handleDown=function e(t){this._buttons[t.button]=true;var i=new iE(this,t);if(!i.event)return;this.fire(bC,i)};t._handleMove=function e(t){var i=new iE(this,t);if(!i.event)return;this.fire(xC,i);this._lastX=i.x;this._lastY=i.y};t._handleWheel=function e(t){var i=new iE(this,t);if(!i.event)return;this.fire(wC,i)};t._getTargetCoords=function e(t){var i=this._target.getBoundingClientRect();var n=Math.floor(i.left);var r=Math.floor(i.top);if(t.clientX<n||t.clientX>=n+this._target.clientWidth||t.clientY<r||t.clientY>=r+this._target.clientHeight)return null;return{x:t.clientX-n,y:t.clientY-r}};return e}(u),rE=function(){function e(e,t){if(t===void 0)t={};this._keyboard=t.keyboard||null;this._mouse=t.mouse||null;this._gamepads=t.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};if(e)this.attach(e)}var t=e.prototype;t.attach=function e(t){this._element=t;if(this._keyboard)this._keyboard.attach(t);if(this._mouse)this._mouse.attach(t)};t.detach=function e(){if(this._keyboard)this._keyboard.detach();if(this._mouse)this._mouse.detach();this._element=null};t.disableContextMenu=function e(){if(!this._mouse)this._enableMouse();this._mouse.disableContextMenu()};t.enableContextMenu=function e(){if(!this._mouse)this._enableMouse();this._mouse.enableContextMenu()};t.update=function e(t){if(this._keyboard)this._keyboard.update(t);if(this._mouse)this._mouse.update(t);if(this._gamepads)this._gamepads.update(t);this._axesValues={};for(var i in this._axes)this._axesValues[i]=[]};t.registerKeys=function e(t,i){if(!this._keyboard)this._enableKeyboard();if(this._actions[t])throw new Error("Action: "+t+" already registered");if(i===undefined)throw new Error("Invalid button");if(!i.length)i=[i];if(this._actions[t])this._actions[t].push({type:hC,keys:i});else this._actions[t]=[{type:hC,keys:i}]};t.registerMouse=function e(t,i){if(!this._mouse)this._enableMouse();if(i===undefined)throw new Error("Invalid button");if(this._actions[t])this._actions[t].push({type:lC,button:i});else this._actions[t]=[{type:lC,button:-i}]};t.registerPadButton=function e(t,i,n){if(n===undefined)throw new Error("Invalid button");if(this._actions[t])this._actions[t].push({type:cC,button:n,pad:i});else this._actions[t]=[{type:cC,button:n,pad:i}]};t.registerAxis=function e(s){var a=s.name;if(!this._axes[a])this._axes[a]=[];var o=this._axes[a].push(a);s=s||{};s.pad=s.pad||TP;var t=function e(t,i,n,r){switch(i){case"mousex":t._mouse.on(xC,function(e){t._axesValues[a][o]=e.dx/10});break;case"mousey":t._mouse.on(xC,function(e){t._axesValues[a][o]=e.dy/10});break;case"key":t._axes[a].push(function(){return t._keyboard.isPressed(r)?n:0});break;case"padrx":t._axes[a].push(function(){return t._gamepads.getAxis(s.pad,qP)});break;case"padry":t._axes[a].push(function(){return t._gamepads.getAxis(s.pad,YP)});break;case"padlx":t._axes[a].push(function(){return t._gamepads.getAxis(s.pad,jP)});break;case"padly":t._axes[a].push(function(){return t._gamepads.getAxis(s.pad,XP)});break;default:throw new Error("Unknown axis")}};t(this,s.positive,1,s.positiveKey);if(s.negativeKey||s.negative!==s.positive)t(this,s.negative,-1,s.negativeKey)};t.isPressed=function e(t){if(!this._actions[t])return false;var i;var n=0;var r=this._actions[t].length;for(n=0;n<r;++n){i=this._actions[t][n];switch(i.type){case hC:if(this._keyboard){var s,a=i.keys.length;for(s=0;s<a;s++)if(this._keyboard.isPressed(i.keys[s]))return true}break;case lC:if(this._mouse&&this._mouse.isPressed(i.button))return true;break;case cC:if(this._gamepads&&this._gamepads.isPressed(i.pad,i.button))return true;break}}return false};t.wasPressed=function e(t){if(!this._actions[t])return false;var i=0;var n=this._actions[t].length;for(i=0;i<n;++i){var r=this._actions[t][i];switch(r.type){case hC:if(this._keyboard){var s,a=r.keys.length;for(s=0;s<a;s++)if(this._keyboard.wasPressed(r.keys[s]))return true}break;case lC:if(this._mouse&&this._mouse.wasPressed(r.button))return true;break;case cC:if(this._gamepads&&this._gamepads.wasPressed(r.pad,r.button))return true;break}}return false};t.getAxis=function e(t){var i=0;if(this._axes[t]){var n,r=this._axes[t].length;for(n=0;n<r;n++)if(l(this._axes[t][n])==="function"){var s=this._axes[t][n]();if(Math.abs(s)>Math.abs(i))i=s}else if(this._axesValues[t])if(Math.abs(this._axesValues[t][n])>Math.abs(i))i=this._axesValues[t][n]}return i};t._enableMouse=function e(){this._mouse=new nE;if(!this._element)throw new Error("Controller must be attached to an Element");this._mouse.attach(this._element)};t._enableKeyboard=function e(){this._keyboard=new eE;if(!this._element)throw new Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};return e}(),sE,aE,oE=new ce,lE=new ce,hE=new Oe,cE=new Oe,uE=new Oe;hE.end=new ce,cE.end=new ce,uE.end=new ce;var fE=new ce,dE=new ce,pE=new ce,mE=new ce,_E=new ce,vE=new ce,gE=new ce,yE=new he,bE=new ce,xE=new ce,SE=new ce,wE=new ce,TE=new ce,ME=new ce,CE=new ce,AE=new ce,PE=new ue;function EE(e,t,i){return gE.cross(e,t).dot(i)}function IE(e,t,i){fE.sub2(t,e);dE.sub2(i[0],e);pE.sub2(i[1],e);mE.sub2(i[2],e);vE.cross(mE,fE);var n=dE.dot(vE);if(n>=0){if(-pE.dot(vE)<0)return false;if(EE(fE,pE,dE)<0)return false}else{_E.sub2(i[3],e);if(_E.dot(vE)<0)return false;if(EE(fE,dE,_E)<0)return false}if(fE.sub2(i[0],i[2]).lengthSq()<1e-4*1e-4)return false;if(fE.sub2(i[1],i[3]).lengthSq()<1e-4*1e-4)return false;return true}var RE=function(){function e(e,t,i){this.event=e;this.element=t;this.camera=i;this._stopPropagation=false}var t=e.prototype;t.stopPropagation=function e(){this._stopPropagation=true;if(this.event){this.event.stopImmediatePropagation();this.event.stopPropagation()}};return e}(),LE=function(l){G(e,l);function e(e,t,i,n,r,s,a){var o;o=l.call(this,e,t,i)||this;o.x=n;o.y=r;o.ctrlKey=e.ctrlKey||false;o.altKey=e.altKey||false;o.shiftKey=e.shiftKey||false;o.metaKey=e.metaKey||false;o.button=e.button;if(nE.isPointerLocked()){o.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0;o.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0}else{o.dx=n-s;o.dy=r-a}o.wheelDelta=0;if(e.type==="wheel")if(e.deltaY>0)o.wheelDelta=1;else if(e.deltaY<0)o.wheelDelta=-1;return o}return e}(RE),DE=function(o){G(e,o);function e(e,t,i,n,r,s){var a;a=o.call(this,e,t,i)||this;a.touches=e.touches;a.changedTouches=e.changedTouches;a.x=n;a.y=r;a.touch=s;return a}return e}(RE),kE=function(s){G(e,s);function e(e,t,i,n){var r;r=s.call(this,e,t,i)||this;r.inputSource=n;return r}return e}(RE),OE=function(){function e(e,t){this._app=null;this._attached=false;this._target=null;this._enabled=true;this._lastX=0;this._lastY=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=this._handleTouchStart.bind(this);this._touchendHandler=this._handleTouchEnd.bind(this);this._touchcancelHandler=this._touchendHandler;this._touchmoveHandler=this._handleTouchMove.bind(this);this._sortHandler=this._sortElements.bind(this);this._elements=[];this._hoveredElement=null;this._pressedElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};this._selectedElements={};this._selectedPressedElements={};this._useMouse=!t||t.useMouse!==false;this._useTouch=!t||t.useTouch!==false;this._useXr=!t||t.useXr!==false;this._selectEventsAttached=false;if(m.touch)this._clickedEntities={};this.attach(e)}var t=e.prototype;t.attach=function e(t){if(this._attached){this._attached=false;this.detach()}this._target=t;this._attached=true;var i=m.passiveEvents?{passive:true}:false;if(this._useMouse){window.addEventListener("mouseup",this._upHandler,i);window.addEventListener("mousedown",this._downHandler,i);window.addEventListener("mousemove",this._moveHandler,i);window.addEventListener("wheel",this._wheelHandler,i)}if(this._useTouch&&m.touch){this._target.addEventListener("touchstart",this._touchstartHandler,i);this._target.addEventListener("touchend",this._touchendHandler,false);this._target.addEventListener("touchmove",this._touchmoveHandler,false);this._target.addEventListener("touchcancel",this._touchcancelHandler,false)}this.attachSelectEvents()};t.attachSelectEvents=function e(){if(!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported){if(!this._clickedEntities)this._clickedEntities={};this._selectEventsAttached=true;this.app.xr.on("start",this._onXrStart,this)}};t.detach=function e(){if(!this._attached)return;this._attached=false;var t=m.passiveEvents?{passive:true}:false;if(this._useMouse){window.removeEventListener("mouseup",this._upHandler,t);window.removeEventListener("mousedown",this._downHandler,t);window.removeEventListener("mousemove",this._moveHandler,t);window.removeEventListener("wheel",this._wheelHandler,t)}if(this._useTouch){this._target.removeEventListener("touchstart",this._touchstartHandler,t);this._target.removeEventListener("touchend",this._touchendHandler,false);this._target.removeEventListener("touchmove",this._touchmoveHandler,false);this._target.removeEventListener("touchcancel",this._touchcancelHandler,false)}if(this._selectEventsAttached){this._selectEventsAttached=false;this.app.xr.off("start",this._onXrStart,this);this.app.xr.off("end",this._onXrEnd,this);this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",this._onSelectStart,this);this.app.xr.input.off("selectend",this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)}this._target=null};t.addElement=function e(t){if(this._elements.indexOf(t)===-1)this._elements.push(t)};t.removeElement=function e(t){var i=this._elements.indexOf(t);if(i!==-1)this._elements.splice(i,1)};t._handleUp=function e(t){if(!this._enabled)return;if(nE.isPointerLocked())return;this._calcMouseCoords(t);if(sE===null)return;this._onElementMouseEvent("mouseup",t)};t._handleDown=function e(t){if(!this._enabled)return;if(nE.isPointerLocked())return;this._calcMouseCoords(t);if(sE===null)return;this._onElementMouseEvent("mousedown",t)};t._handleMove=function e(t){if(!this._enabled)return;this._calcMouseCoords(t);if(sE===null)return;this._onElementMouseEvent("mousemove",t);this._lastX=sE;this._lastY=aE};t._handleWheel=function e(t){if(!this._enabled)return;this._calcMouseCoords(t);if(sE===null)return;this._onElementMouseEvent("mousewheel",t)};t._determineTouchedElements=function e(t){var i={};var n=this.app.systems.camera.cameras;var r,s,a;for(r=n.length-1;r>=0;r--){var o=n[r];var l=0;for(s=0,a=t.changedTouches.length;s<a;s++){if(i[t.changedTouches[s].identifier]){l++;continue}var h=this._calcTouchCoords(t.changedTouches[s]);var c=this._getTargetElement(o,h.x,h.y);if(c){l++;i[t.changedTouches[s].identifier]={element:c,camera:o,x:h.x,y:h.y}}}if(l===a)break}return i};t._handleTouchStart=function e(t){if(!this._enabled)return;var i=this._determineTouchedElements(t);for(var n=0,r=t.changedTouches.length;n<r;n++){var s=t.changedTouches[n];var a=i[s.identifier];var o=this._touchedElements[s.identifier];if(a&&(!o||a.element!==o.element)){this._fireEvent(t.type,new DE(t,a.element,a.camera,a.x,a.y,s));this._touchesForWhichTouchLeaveHasFired[s.identifier]=false}}for(var l in i)this._touchedElements[l]=i[l]};t._handleTouchEnd=function e(t){if(!this._enabled)return;var i=this.app.systems.camera.cameras;for(var n in this._clickedEntities)delete this._clickedEntities[n];for(var r=0,s=t.changedTouches.length;r<s;r++){var a=t.changedTouches[r];var o=this._touchedElements[a.identifier];if(!o)continue;var l=o.element;var h=o.camera;var c=o.x;var u=o.y;delete this._touchedElements[a.identifier];delete this._touchesForWhichTouchLeaveHasFired[a.identifier];this._fireEvent(t.type,new DE(t,l,h,c,u,a));if(t.touches.length===0){var f=this._calcTouchCoords(a);for(var d=i.length-1;d>=0;d--){var p=this._getTargetElement(i[d],f.x,f.y);if(p===l)if(!this._clickedEntities[l.entity.getGuid()]){this._fireEvent("click",new DE(t,l,h,c,u,a));this._clickedEntities[l.entity.getGuid()]=true}}}}};t._handleTouchMove=function e(t){t.preventDefault();if(!this._enabled)return;var i=this._determineTouchedElements(t);for(var n=0,r=t.changedTouches.length;n<r;n++){var s=t.changedTouches[n];var a=i[s.identifier];var o=this._touchedElements[s.identifier];if(o){var l=this._calcTouchCoords(s);if((!a||a.element!==o.element)&&!this._touchesForWhichTouchLeaveHasFired[s.identifier]){this._fireEvent("touchleave",new DE(t,o.element,o.camera,l.x,l.y,s));this._touchesForWhichTouchLeaveHasFired[s.identifier]=true}this._fireEvent("touchmove",new DE(t,o.element,o.camera,l.x,l.y,s))}}};t._onElementMouseEvent=function e(t,i){var n;var r=this._hoveredElement;this._hoveredElement=null;var s=this.app.systems.camera.cameras;var a;for(var o=s.length-1;o>=0;o--){a=s[o];n=this._getTargetElement(a,sE,aE);if(n)break}if(n){this._fireEvent(t,new LE(i,n,a,sE,aE,this._lastX,this._lastY));this._hoveredElement=n;if(t==="mousedown")this._pressedElement=n}if(r!==this._hoveredElement){if(r)this._fireEvent("mouseleave",new LE(i,r,a,sE,aE,this._lastX,this._lastY));if(this._hoveredElement)this._fireEvent("mouseenter",new LE(i,this._hoveredElement,a,sE,aE,this._lastX,this._lastY))}if(t==="mouseup"&&this._pressedElement)if(this._pressedElement===this._hoveredElement){this._pressedElement=null;if(!this._clickedEntities||!this._clickedEntities[this._hoveredElement.entity.getGuid()])this._fireEvent("click",new LE(i,this._hoveredElement,a,sE,aE,this._lastX,this._lastY))}else this._pressedElement=null};t._onXrStart=function e(){this.app.xr.on("end",this._onXrEnd,this);this.app.xr.on("update",this._onXrUpdate,this);this.app.xr.input.on("selectstart",this._onSelectStart,this);this.app.xr.input.on("selectend",this._onSelectEnd,this);this.app.xr.input.on("remove",this._onXrInputRemove,this)};t._onXrEnd=function e(){this.app.xr.off("update",this._onXrUpdate,this);this.app.xr.input.off("selectstart",this._onSelectStart,this);this.app.xr.input.off("selectend",this._onSelectEnd,this);this.app.xr.input.off("remove",this._onXrInputRemove,this)};t._onXrUpdate=function e(){if(!this._enabled)return;var t=this.app.xr.input.inputSources;for(var i=0;i<t.length;i++)this._onElementSelectEvent("selectmove",t[i],null)};t._onXrInputRemove=function e(t){var i=this._selectedElements[t.id];if(i){t._elementEntity=null;this._fireEvent("selectleave",new kE(null,i,null,t))}delete this._selectedElements[t.id];delete this._selectedPressedElements[t.id]};t._onSelectStart=function e(t,i){if(!this._enabled)return;this._onElementSelectEvent("selectstart",t,i)};t._onSelectEnd=function e(t,i){if(!this._enabled)return;this._onElementSelectEvent("selectend",t,i)};t._onElementSelectEvent=function e(t,i,n){var r;var s=this._selectedElements[i.id];var a;var o=this.app.systems.camera.cameras;var l;if(i.elementInput){uE.set(i.getOrigin(),i.getDirection());for(var h=o.length-1;h>=0;h--){l=o[h];r=this._getTargetElementByRay(uE,l);if(r)break}}i._elementEntity=r||null;if(r){this._selectedElements[i.id]=r;a=r}else delete this._selectedElements[i.id];if(s!==a){if(s)this._fireEvent("selectleave",new kE(n,s,l,i));if(a)this._fireEvent("selectenter",new kE(n,a,l,i))}if(t==="selectstart"){this._selectedPressedElements[i.id]=a;if(a)this._fireEvent("selectstart",new kE(n,a,l,i))}var c=this._selectedPressedElements[i.id];if(!i.elementInput&&c){delete this._selectedPressedElements[i.id];if(s)this._fireEvent("selectend",new kE(n,s,l,i))}if(t==="selectend"&&i.elementInput){delete this._selectedPressedElements[i.id];if(s)this._fireEvent("selectend",new kE(n,s,l,i));if(c&&c===s)this._fireEvent("click",new kE(n,c,l,i))}};t._fireEvent=function e(t,i){var n=i.element;while(true){n.fire(t,i);if(i._stopPropagation)break;if(!n.entity.parent)break;n=n.entity.parent.element;if(!n)break}};t._calcMouseCoords=function e(t){var i=this._target.getBoundingClientRect();var n=Math.floor(i.left);var r=Math.floor(i.top);if(t.clientX<n||t.clientX>=n+this._target.clientWidth||t.clientY<r||t.clientY>=r+this._target.clientHeight){sE=null;aE=null}else{sE=t.clientX-n;aE=t.clientY-r}};t._calcTouchCoords=function e(t){var i=0;var n=0;var r=t.target;while(!(r instanceof HTMLElement))r=r.parentNode;var s=r;do{i+=s.offsetLeft-s.scrollLeft;n+=s.offsetTop-s.scrollTop;s=s.offsetParent}while(s);return{x:t.pageX-i,y:t.pageY-n}};t._sortElements=function e(t,i){var n=this.app.scene.layers.sortTransparentLayers(t.layers,i.layers);if(n!==0)return n;if(t.screen&&!i.screen)return-1;if(!t.screen&&i.screen)return 1;if(!t.screen&&!i.screen)return 0;if(t.screen.screen.screenSpace&&!i.screen.screen.screenSpace)return-1;if(i.screen.screen.screenSpace&&!t.screen.screen.screenSpace)return 1;return i.drawOrder-t.drawOrder};t._getTargetElement=function e(t,i,n){var r=null;this._elements.sort(this._sortHandler);var s,a;for(var o=0,l=this._elements.length;o<l;o++){var h=this._elements[o];var c=false;var u;if(h.screen&&h.screen.screen.screenSpace){if(s===undefined){s=hE;if(this._calculateRayScreen(i,n,t,s)===false)s=null}u=s;c=true}else{if(a===undefined){a=cE;if(this._calculateRay3d(i,n,t,a)===false)a=null}u=a}if(u&&this._checkElement(u,h,c)){r=h;break}}return r};t._getTargetElementByRay=function e(t,i){var n=null;hE.origin.copy(t.origin);hE.direction.copy(t.direction);hE.end.copy(hE.direction).scale(i.farClip*2).add(hE.origin);this._elements.sort(this._sortHandler);for(var r=0,s=this._elements.length;r<s;r++){var a=this._elements[r];if(!a.screen||!a.screen.screen.screenSpace)if(this._checkElement(hE,a,false)){n=a;break}}return n};t._buildHitCorners=function e(t,i,n,r){var s=i;var a=t.entity&&t.entity.button;if(a){var o=t.entity.button.hitPadding||PE;bE.copy(t.entity.up);xE.copy(bE).scale(-1);wE.copy(t.entity.right);SE.copy(wE).scale(-1);bE.scale(o.w*r);xE.scale(o.y*r);wE.scale(o.z*n);SE.scale(o.x*n);TE.copy(s[0]).add(xE).add(SE);ME.copy(s[1]).add(xE).add(wE);CE.copy(s[2]).add(bE).add(wE);AE.copy(s[3]).add(bE).add(SE);s=[TE,ME,CE,AE]}return s};t._calculateScaleToScreen=function e(t){var i=t.entity;var n=t.screen.screen.scale;yE.set(n,n);while(i&&!i.screen){yE.mul(i.getLocalScale());i=i.parent}return yE};t._calculateRayScreen=function e(t,i,n,r){var s=this.app.graphicsDevice.width;var a=this.app.graphicsDevice.height;var o=n.rect.z*s;var l=n.rect.w*a;var h=n.rect.x*s;var c=h+o;var u=(1-n.rect.y)*a;var f=u-l;var d=t*s/this._target.clientWidth;var p=i*a/this._target.clientHeight;if(d>=h&&d<=c&&p<=u&&p>=f){d=s*(d-h)/o;p=a*(p-f)/l;p=a-p;r.origin.set(d,p,1);r.direction.set(0,0,-1);r.end.copy(r.direction).scale(2).add(r.origin);return true}return false};t._calculateRay3d=function e(t,i,n,r){var s=this._target.clientWidth;var a=this._target.clientHeight;var o=n.rect.z*s;var l=n.rect.w*a;var h=n.rect.x*s;var c=h+o;var u=(1-n.rect.y)*a;var f=u-l;var d=t;var p=i;if(t>=h&&t<=c&&i<=u&&p>=f){d=s*(d-h)/o;p=a*(p-f)/l;n.screenToWorld(d,p,n.nearClip,oE);n.screenToWorld(d,p,n.farClip,lE);r.origin.copy(oE);r.direction.set(0,0,-1);r.end.copy(lE);return true}return false};t._checkElement=function e(t,i,n){if(i.maskedBy){var r=this._checkElement(t,i.maskedBy.element,n);if(!r)return false}var s;if(n)s=this._calculateScaleToScreen(i);else s=i.entity.getWorldTransform().getScale();var a=this._buildHitCorners(i,n?i.screenCorners:i.worldCorners,s.x,s.y);if(IE(t.origin,t.end,a))return true;return false};U(e,[{key:"enabled",get:function e(){return this._enabled},set:function e(t){this._enabled=t}},{key:"app",get:function e(){return this._app||rM.getApplication()},set:function e(t){this._app=t}}]);return e}(),FE={DEFAULT:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_3","PAD_FACE_4","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:["PAD_FACE_1","PAD_FACE_2","PAD_FACE_4","PAD_FACE_3","PAD_L_SHOULDER_1","PAD_R_SHOULDER_1","PAD_L_SHOULDER_2","PAD_R_SHOULDER_2","PAD_SELECT","PAD_START","PAD_L_STICK_BUTTON","PAD_R_STICK_BUTTON","PAD_UP","PAD_DOWN","PAD_LEFT","PAD_RIGHT","PAD_VENDOR"],axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},BE={"Product: 0268":"PS3"},NE=function(){function e(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=.25}var t=e.prototype;t.update=function e(){var t,i,n;var r,s;for(t=0,n=this.current.length;t<n;t++){r=this.current[t].pad.buttons;s=r.length;for(i=0;i<s;i++){if(this.previous[t]===undefined)this.previous[t]=[];this.previous[t][i]=r[i].pressed}}this.poll(this.current)};t.poll=function e(t){if(t===void 0)t=[];if(t.length>0)t.length=0;if(this.gamepadsSupported){var i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads();var n,r=i.length;for(n=0;n<r;n++)if(i[n])t.push({map:this.getMap(i[n]),pad:i[n]})}return t};t.getMap=function e(t){for(var i in BE)if(t.id.indexOf(i)>=0)return FE[BE[i]];return FE.DEFAULT};t.isPressed=function e(t,i){if(!this.current[t])return false;var n=this.current[t].map.buttons[i];return this.current[t].pad.buttons[pc[n]].pressed};t.wasPressed=function e(t,i){if(!this.current[t])return false;var n=this.current[t].map.buttons[i];var r=pc[n];return this.current[t].pad.buttons[r].pressed&&!this.previous[t][r]};t.getAxis=function e(t,i){if(!this.current[t])return 0;var n=this.current[t].map.axes[i];var r=this.current[t].pad.axes[pc[n]];if(Math.abs(r)<this.deadZone)r=0;return r};return e}();function zE(e){var t=0;var i=0;var n=e.target;while(!(n instanceof HTMLElement))n=n.parentNode;var r=n;do{t+=r.offsetLeft-r.scrollLeft;i+=r.offsetTop-r.scrollTop;r=r.offsetParent}while(r);return{x:e.pageX-t,y:e.pageY-i}}var VE=function e(t){var i=zE(t);this.id=t.identifier;this.x=i.x;this.y=i.y;this.target=t.target;this.touch=t},UE=function(){function e(e,t){this.element=t.target;this.event=t;this.touches=[];this.changedTouches=[];if(t){var i,n=t.touches.length;for(i=0;i<n;i++)this.touches.push(new VE(t.touches[i]));n=t.changedTouches.length;for(i=0;i<n;i++)this.changedTouches.push(new VE(t.changedTouches[i]))}}var t=e.prototype;t.getTouchById=function e(t,i){var n,r=i.length;for(n=0;n<r;n++)if(i[n].id===t)return i[n];return null};return e}(),GE=function(i){G(e,i);function e(e){var t;t=i.call(this)||this;t._element=null;t._startHandler=t._handleTouchStart.bind(H(t));t._endHandler=t._handleTouchEnd.bind(H(t));t._moveHandler=t._handleTouchMove.bind(H(t));t._cancelHandler=t._handleTouchCancel.bind(H(t));t.attach(e);return t}var t=e.prototype;t.attach=function e(t){if(this._element)this.detach();this._element=t;this._element.addEventListener("touchstart",this._startHandler,false);this._element.addEventListener("touchend",this._endHandler,false);this._element.addEventListener("touchmove",this._moveHandler,false);this._element.addEventListener("touchcancel",this._cancelHandler,false)};t.detach=function e(){if(this._element){this._element.removeEventListener("touchstart",this._startHandler,false);this._element.removeEventListener("touchend",this._endHandler,false);this._element.removeEventListener("touchmove",this._moveHandler,false);this._element.removeEventListener("touchcancel",this._cancelHandler,false)}this._element=null};t._handleTouchStart=function e(t){this.fire("touchstart",new UE(this,t))};t._handleTouchEnd=function e(t){this.fire("touchend",new UE(this,t))};t._handleTouchMove=function e(t){t.preventDefault();this.fire("touchmove",new UE(this,t))};t._handleTouchCancel=function e(t){this.fire("touchcancel",new UE(this,t))};return e}(u),HE=function e(){},WE=[null,null],jE=null,XE,qE=new ue,YE=new Float32Array(4),KE=[],QE=false,$E=false,ZE=false,JE=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*\;/g,eI=/\S+[ \t\n\r]*\;/,tI=/[ \t\n\r]*\;/,iI=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,nI=/(float|int|bool|vec2|vec3|vec4|struct|\,|\;|\{|\})/g,rI=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,sI=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|\,|\;|\{|\})/g,aI=/#version/g,oI=/out highp vec4 pc_fragColor;/g,lI=/#define gl_FragColor/g,hI=/gl_FragColor/g,cI=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,uI=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,fI=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,dI=/void[ \t\n\r]+main/g;function pI(e,t,i){var n=new bu(t,{format:i,width:t.width,height:t.height});n.name="posteffect-pass";n.minFilter=Mt;n.magFilter=Mt;n.addressU=We;n.addressV=We;WE[e]._colorBuffer=n}function mI(e){WE[e].colorBuffer.destroy();WE[e].destroy()}function _I(e){var t=e.match(JE)||[];var i,n,r;var s=[];for(var a=0;a<t.length;a++){i=t[a].search(eI);n=t[a].search(tI);r=t[a].substr(i,n-i);if(r!=="uColorBuffer")s.push(r)}return s}function vI(e,t,i,n){var r=_I(n.definition.fshader);if(r.length===0)return false;var s,a,o,l;var h;for(s=0;s<i;s++)for(a=0;a<r.length;a++){h=r[a];l=_I(e[t[s]].shader.definition.fshader);for(o=0;o<l.length;o++)if(l[o]===h)return true}return false}function gI(e,t){var i=e.length;var n;var r=0;var s=0;var a=0;var o=0;var l="";var h,c;for(h=0;h<i;h++){n=e.charAt(h);if(n==="{"){if(a===0)r=h;a++}else if(n==="}"){if(a===1){s=h;l+=e.substr(o,r-o+1);o=s}a--}}l+=e.substr(o,e.length-o+1);var u=null;var f=l.match(iI)||[];var d,p;for(h=0;h<f.length;h++){d=f[h].split(",");for(c=0;c<d.length;c++){p=d[c].replace(nI,"").trim();if(t.indexOf(p)>=0){if(!u)u=[];u.push(p)}else t.push(p)}}var m=l.match(rI)||[];var _;for(h=0;h<m.length;h++){d=m[h].split(",");for(c=0;c<d.length;c++){p=d[c].replace(sI,"").trim();_=t.indexOf(p);if(_>=0)t.splice(_,1)}}return u}var yI=function(){function e(v,e){this.app=v;this.srcRenderTarget=e.srcRenderTarget;this.hdr=e.hdr;this.blending=e.blending;this.shader=e.shader;this.setup=e.setup;var a=this;var g=v.graphicsDevice;this.layer=new Vf({opaqueSortMode:Tc,transparentSortMode:Tc,passThrough:true,name:e.name,onPostRender:function e(){if(a.srcRenderTarget){qE.x=a.srcRenderTarget.width;qE.y=a.srcRenderTarget.height;qE.z=1/a.srcRenderTarget.width;qE.w=1/a.srcRenderTarget.height}else{qE.x=g.width;qE.y=g.height;qE.z=1/g.width;qE.w=1/g.height}YE[0]=qE.x;YE[1]=qE.y;YE[2]=qE.z;YE[3]=qE.w;XE.setValue(YE);if(this._postEffectCombined&&this._postEffectCombined<0){if(a.setup)a.setup(g,a,qE,null,this.renderTarget);return}var t;if(this._postEffectCombinedSrc)t=this._postEffectCombinedSrc;else t=a.srcRenderTarget?a.srcRenderTarget:WE[this._backbufferRtId];if(t._samples>1)t.resolve(true,false);var i=t._colorBuffer;i.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?Ct:Mt;jE.setValue(i);if(a.setup)a.setup(g,a,qE,t,this.renderTarget);var n=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader;if(n)Ar(g,this.renderTarget,n,null,null,a.blending);if(a.srcRenderTarget)return;var r=v.scene.layers.layerList;for(var s=0;s<r.length;s++){if(r[s]===a.layer)break;if(r[s].renderTarget===WE[0]||r[s].renderTarget===WE[1])r[s].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=true;this.layer.unmodifiedUvs=e.unmodifiedUvs;this.layer.postEffectBilinear=e.bilinear;this.layer.postEffect=this;this.layer.shader=e.shader;this.layer.renderTarget=e.destRenderTarget;if(!jE){jE=g.scope.resolve("uColorBuffer");XE=g.scope.resolve("uScreenSize");var t=g.supportsMsaa?4:1;for(var i=0;i<2;i++){WE[i]=new BM({depth:true,stencil:g.supportsStencil,samples:t,autoResolve:false});WE[i].name="backbuffer"+i}v.on("prerender",function(){var e=v.scene.layers.layerList;var t,i;var n=0;var r=0;QE=false;$E=false;ZE=false;var s=Kt;if(v.scene.layers._dirty){var a=0;var o=false;var l,h;for(t=0;t<e.length;t++){o=false;if(e[t].isPostEffect&&(a===0||e[t].unmodifiedUvs&&e[t].shader&&!vI(e,KE,a,e[t].shader))){KE[a]=t;a++;if(t===e.length-1)o=true}else if(a>0)o=true;if(o){if(a>1){var c="post_";var u;for(i=0;i<a;i++){u=e[KE[i]];c+=u.name?u.name:u.id;if(i<a-1)c+="_"}var f=g.programLib._cache[c];if(!f){var d;var p="vec4 shaderOutput;\n";var m="void main() {\n";var _=[];for(i=0;i<a;i++){d=e[KE[i]].shader.definition.fshader+"\n";d=d.replace(aI,"//").replace(oI,"//").replace(lI,"//").replace(hI,"shaderOutput");if(i>0)d=d.replace(cI,"//").replace(uI,"//").replace(fI,"shaderOutput;//");d=d.replace(dI,"void main"+i);l=gI(d,_);if(l)for(h=0;h<l.length;h++)d=d.replace(new RegExp("\\b"+l[h]+"\\b","g"),l[h]+"NNNN"+i);p+=d;m+="main"+i+"();\n"}m+="gl_FragColor = shaderOutput;\n}\n";f=Qc(g,ul.fullscreenQuadVS,p+m,c)}for(i=0;i<a;i++)e[KE[i]]._postEffectCombined=i===a-1?1:-1;e[KE[a-1]]._postEffectCombinedShader=f;e[KE[a-1]]._postEffectCombinedBilinear=e[KE[0]].postEffectBilinear;e[KE[a-1]]._postEffectCombinedSrc=e[KE[0]].postEffect.srcRenderTarget}KE[0]=t;a=1}}}for(t=0;t<e.length;t++){if(e[t].isPostEffect&&(!e[t].postEffect.srcRenderTarget&&!e[t]._postEffectCombined||!e[t].postEffect._postEffectCombinedSrc&&e[t]._postEffectCombined>=0)){for(i=t-1;i>=n;i--)if(!e[i].renderTarget)e[i].renderTarget=WE[r];e[t]._backbufferRtId=r;n=t;QE=true;if(r===1)$E=true;if(e[t].postEffect.hdr)if(g.webgl2&&g.textureFloatRenderable)s=ai;else if(g.extTextureHalfFloatLinear&&g.textureHalfFloatRenderable)s=ei;else s=Kt;if(e[t].postEffect.shader&&!e[t].renderTarget)r=1-r}else if(!e[t].isPostEffect&&!e[t].renderTarget&&QE)e[t].renderTarget=WE[r];if(e[t].isPostEffect&&!e[t].renderTarget)ZE=true}if(QE)if(!WE[0].colorBuffer)pI(0,g,s);else if(WE[0].width!==g.width||WE[0].height!==g.height||WE[0]._colorBuffer._format!==s){mI(0);pI(0,g,s)}if($E)if(!WE[1].colorBuffer)pI(1,g,s);else if(WE[1].width!==g.width||WE[1].height!==g.height||WE[1]._colorBuffer._format!==s){mI(1);pI(1,g,s)}},this);v.on("postrender",function(){var e=v.graphicsDevice;if(QE&&!ZE){var t=v.scene.layers.layerList;var i;for(var n=t.length-1;n>=0;n--){i=t[n].renderTarget;if(i===WE[0]||i===WE[1])break}if(i){if(i._samples>1)i.resolve(true,false);e.copyRenderTarget(i,null,true,false)}}},this)}}var t=e.prototype;t.addToComposition=function e(t){this.app.scene.layers.insertTransparent(this.layer,t)};return e}(),bI={write:function e(t){console.log(t)},open:function e(){bI.write("Powered by PlayCanvas "+r+" "+s)},info:function e(t){console.info("INFO:\t\t"+t)},debug:function e(t){console.debug("DEBUG:\t "+t)},error:function e(t){console.error("ERROR:\t "+t)},warning:function e(t){console.warn("WARNING: "+t)},alert:function(t){function e(e){return t.apply(this,arguments)}e.toString=function(){return t.toString()};return e}(function(e){bI.write("ALERT:\t "+e);alert(e)}),assert:function e(t,i){if(t===false)bI.write("ASSERT:\t"+i)}};Ae.endsWith=function(e,t){return e.endsWith(t)},Ae.startsWith=function(e,t){return e.startsWith(t)};var xI={now:ye,Timer:Y};function SI(h,c){var e=function e(){};var t=function e(t,i,n,r,s,a,o,l){c.call(this,t,i,n,r,s,a,o,l);h.call(this,t,i,n,r,s,a,o,l)};t._super=c.prototype;e.prototype=c.prototype;t.prototype=new e;return t}function wI(e){return Array.prototype.slice.call(e)}Object.defineProperty(ge.prototype,"data",{get:function e(){if(!this._data)this._data=new Float32Array(4);this._data[0]=this.r;this._data[1]=this.g;this._data[2]=this.b;this._data[3]=this.a;return this._data}}),Object.defineProperty(ge.prototype,"data3",{get:function e(){if(!this._data3)this._data3=new Float32Array(3);this._data3[0]=this.r;this._data3[1]=this.g;this._data3[2]=this.b;return this._data3}}),Pe.INV_LOG2=Math.LOG2E,Pe.intToBytes=Pe.intToBytes32,Pe.bytesToInt=Pe.bytesToInt32,Object.defineProperty(he.prototype,"data",{get:function e(){if(!this._data)this._data=new Float32Array(2);this._data[0]=this.x;this._data[1]=this.y;return this._data}}),Object.defineProperty(ce.prototype,"data",{get:function e(){if(!this._data)this._data=new Float32Array(3);this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;return this._data}}),Object.defineProperty(ue.prototype,"data",{get:function e(){if(!this._data)this._data=new Float32Array(4);this._data[0]=this.x;this._data[1]=this.y;this._data[2]=this.z;this._data[3]=this.w;return this._data}});var TI={Aabb:Ce,Sphere:De,Plane:Ge};De.prototype.intersectRay=De.prototype.intersectsRay,ke.prototype.update=function(e,t){var i=new ve;i.mul2(e,t);this.setFromMat4(i)};var MI=Tn,CI=Mn,AI=Cn,PI=An,EI=Pn,II=En,RI=In;function LI(e){this.name="UnsupportedBrowserError";this.message=e||""}function DI(e){this.name="ContextCreationError";this.message=e||""}LI.prototype=Error.prototype,DI.prototype=Error.prototype;var kI={ADDRESS_CLAMP_TO_EDGE:We,ADDRESS_MIRRORED_REPEAT:je,ADDRESS_REPEAT:He,BLENDMODE_ZERO:Xe,BLENDMODE_ONE:qe,BLENDMODE_SRC_COLOR:Ye,BLENDMODE_ONE_MINUS_SRC_COLOR:Ke,BLENDMODE_DST_COLOR:Qe,BLENDMODE_ONE_MINUS_DST_COLOR:$e,BLENDMODE_SRC_ALPHA:Ze,BLENDMODE_SRC_ALPHA_SATURATE:Je,BLENDMODE_ONE_MINUS_SRC_ALPHA:et,BLENDMODE_DST_ALPHA:tt,BLENDMODE_ONE_MINUS_DST_ALPHA:it,BUFFER_STATIC:lt,BUFFER_DYNAMIC:ht,BUFFER_STREAM:ct,CULLFACE_NONE:xt,CULLFACE_BACK:St,CULLFACE_FRONT:wt,CULLFACE_FRONTANDBACK:Tt,ELEMENTTYPE_INT8:Tn,ELEMENTTYPE_UINT8:Mn,ELEMENTTYPE_INT16:Cn,ELEMENTTYPE_UINT16:An,ELEMENTTYPE_INT32:Pn,ELEMENTTYPE_UINT32:En,ELEMENTTYPE_FLOAT32:In,FILTER_NEAREST:Mt,FILTER_LINEAR:Ct,FILTER_NEAREST_MIPMAP_NEAREST:At,FILTER_NEAREST_MIPMAP_LINEAR:Pt,FILTER_LINEAR_MIPMAP_NEAREST:Et,FILTER_LINEAR_MIPMAP_LINEAR:It,INDEXFORMAT_UINT8:zt,INDEXFORMAT_UINT16:Vt,INDEXFORMAT_UINT32:Ut,PIXELFORMAT_R5_G6_B5:jt,PIXELFORMAT_R8_G8_B8:Yt,PIXELFORMAT_R8_G8_B8_A8:Kt,PRIMITIVE_POINTS:yi,PRIMITIVE_LINES:bi,PRIMITIVE_LINELOOP:xi,PRIMITIVE_LINESTRIP:Si,PRIMITIVE_TRIANGLES:wi,PRIMITIVE_TRISTRIP:Ti,PRIMITIVE_TRIFAN:Mi,SEMANTIC_POSITION:Ci,SEMANTIC_NORMAL:Ai,SEMANTIC_COLOR:Ri,SEMANTIC_TEXCOORD:Li,SEMANTIC_TEXCOORD0:Di,SEMANTIC_TEXCOORD1:ki,SEMANTIC_ATTR0:Gi,SEMANTIC_ATTR1:Hi,SEMANTIC_ATTR2:Wi,SEMANTIC_ATTR3:ji,TEXTURELOCK_READ:pn,TEXTURELOCK_WRITE:mn,drawQuadWithShader:Ar,programlib:vu,shaderChunks:ul,ContextCreationError:DI,Device:OM,IndexBuffer:Eu,ProgramLibrary:wM,RenderTarget:BM,ScopeId:AM,Shader:Ir,ShaderInput:EM,Texture:bu,UnsupportedBrowserError:LI,VertexBuffer:lr,VertexFormat:cr,VertexIterator:Tr},OI={createFullscreenQuad:qM,drawFullscreenQuad:YM,PostEffect:XM,PostEffectQueue:ex};Object.defineProperty(ul,"transformSkinnedVS",{get:function e(){return"#define SKIN\n"+ul.transformVS}}),Object.defineProperties(bu.prototype,{rgbm:{get:function e(){return this.type===vn},set:function e(t){this.type=t?vn:_n}},swizzleGGGR:{get:function e(){return this.type===yn},set:function e(t){this.type=t?yn:_n}}});var FI=pM,BI={partitionSkin:bg,procedural:{calculateTangents:wm,createMesh:Tm,createTorus:Mm,createCylinder:Am,createCapsule:Pm,createCone:Em,createSphere:Im,createPlane:Rm,createBox:Lm},BasicMaterial:Kd,Command:Nu,DepthMaterial:QM,ForwardRenderer:Yd,GraphNode:Mf,Material:Cu,Mesh:Du,MeshInstance:zu,Model:Xu,ParticleEmitter:gm,PhongMaterial:pM,Picker:$M,Projection:{ORTHOGRAPHIC:ph,PERSPECTIVE:dh},Scene:km,Skin:$m,SkinInstance:ju};Mf.prototype._dirtify=function(e){if(e)this._dirtifyLocal();else this._dirtifyWorld()},Mf.prototype.addLabel=function(e){this._labels[e]=true},Mf.prototype.getLabels=function(){return Object.keys(this._labels)},Mf.prototype.hasLabel=function(e){return!!this._labels[e]},Mf.prototype.removeLabel=function(e){delete this._labels[e]},Mf.prototype.findByLabel=function(e,t){var i,n=this._children.length;t=t||[];if(this.hasLabel(e))t.push(this);for(i=0;i<n;++i)t=this._children[i].findByLabel(e,t);return t},Mf.prototype.getChildren=function(){return this.children},Mf.prototype.getName=function(){return this.name},Mf.prototype.getPath=function(){return this.path},Mf.prototype.getRoot=function(){return this.root},Mf.prototype.getParent=function(){return this.parent},Mf.prototype.setName=function(e){this.name=e},Cu.prototype.getName=function(){return this.name},Cu.prototype.setName=function(e){this.name=e},Cu.prototype.getShader=function(){return this.shader},Cu.prototype.setShader=function(e){this.shader=e};var NI={Animation:Km,Key:qm,Node:Ym,Skeleton:U0};Km.prototype.getDuration=function(){return this.duration},Km.prototype.getName=function(){return this.name},Km.prototype.getNodes=function(){return this.nodes},Km.prototype.setDuration=function(e){this.duration=e},Km.prototype.setName=function(e){this.name=e},U0.prototype.getAnimation=function(){return this.animation},U0.prototype.getCurrentTime=function(){return this.currentTime},U0.prototype.getLooping=function(){return this.looping},U0.prototype.getNumNodes=function(){return this.numNodes},U0.prototype.setAnimation=function(e){this.animation=e},U0.prototype.setCurrentTime=function(e){this.currentTime=e},U0.prototype.setLooping=function(e){this.looping=e};var zI={AudioManager:Xm,Channel:Bm,Channel3d:Gm,Listener:jm,Sound:Cv};Xm.prototype.getListener=function(){return this.listener},Xm.prototype.getVolume=function(){return this.volume},Xm.prototype.setVolume=function(e){this.volume=e};var VI={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};Py.prototype.getAssetById=function(e){return this.get(e)},Object.defineProperty(y0.prototype,"ray",{get:function e(){return this._rayLocal}}),Object.defineProperty(y0.prototype,"position",{get:function e(){return this._localPosition}}),Object.defineProperty(y0.prototype,"rotation",{get:function e(){return this._localRotation}});var UI={getTouchTargetCoords:zE,Controller:rE,GamePads:NE,Keyboard:eE,KeyboardEvent:KP,Mouse:nE,MouseEvent:iE,Touch:VE,TouchDevice:GE,TouchEvent:UE};Object.defineProperty(OE.prototype,"wheel",{get:function e(){return this.wheelDelta*-2}}),Object.defineProperty(iE.prototype,"wheel",{get:function e(){return this.wheelDelta*-2}});var GI=ox,HI=lx,WI=hx,jI=cx,XI=ux,qI=fx,YI=dx,KI=px,QI=mx,$I=_x,ZI=vx,JI={Application:rM,Component:R0,ComponentData:HE,ComponentSystem:L0,Entity:Nv,FillMode:{NONE:Dy,FILL_WINDOW:ky,KEEP_ASPECT:Oy},ResolutionMode:{AUTO:Fy,FIXED:By}};rM.prototype.isFullscreen=function(){return!!document.fullscreenElement},rM.prototype.enableFullscreen=function(e,t,i){e=e||this.graphicsDevice.canvas;var n=function e(){t();document.removeEventListener("fullscreenchange",e)};var r=function e(){i();document.removeEventListener("fullscreenerror",e)};if(t)document.addEventListener("fullscreenchange",n,false);if(i)document.addEventListener("fullscreenerror",r,false);if(e.requestFullscreen)e.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT);else i()},rM.prototype.disableFullscreen=function(t){var e=function e(){t();document.removeEventListener("fullscreenchange",e)};if(t)document.addEventListener("fullscreenchange",e,false);document.exitFullscreen()},rM.prototype.getSceneUrl=function(e){var t=this.scenes.find(e);if(t)return t.url;return null},rM.prototype.loadScene=function(e,t){this.scenes.loadScene(e,t)},rM.prototype.loadSceneHierarchy=function(e,t){this.scenes.loadSceneHierarchy(e,t)},rM.prototype.loadSceneSettings=function(e,t){this.scenes.loadSceneSettings(e,t)},Object.defineProperty(tx.prototype,"node",{get:function e(){return this.entity}}),Object.defineProperty(Aw.prototype,"enable",{get:function e(){return this.enabled},set:function e(t){this.enabled=t}}),Dw.prototype.setVisible=function(e){this.enabled=e},Object.defineProperty(nT.prototype,"bodyType",{get:function e(){return this.type},set:function e(t){this.type=t}}),nT.prototype.syncBodyToEntity=function(){this._updateDynamic()},pT.prototype.setGravity=function(){if(arguments.length===1)this.gravity.copy(arguments[0]);else this.gravity.set(arguments[0],arguments[1],arguments[2])},o.ABSOLUTE_URL=p_,o.ACTION_GAMEPAD=cC,o.ACTION_KEYBOARD=hC,o.ACTION_MOUSE=lC,o.ADDRESS_CLAMP_TO_EDGE=We,o.ADDRESS_MIRRORED_REPEAT=je,o.ADDRESS_REPEAT=He,o.ANIM_BLEND_1D=lb,o.ANIM_BLEND_2D_CARTESIAN=cb,o.ANIM_BLEND_2D_DIRECTIONAL=hb,o.ANIM_BLEND_DIRECT=ub,o.ANIM_EQUAL_TO=ib,o.ANIM_GREATER_THAN=Z0,o.ANIM_GREATER_THAN_EQUAL_TO=eb,o.ANIM_INTERRUPTION_NEXT=K0,o.ANIM_INTERRUPTION_NEXT_PREV=$0,o.ANIM_INTERRUPTION_NONE=q0,o.ANIM_INTERRUPTION_PREV=Y0,o.ANIM_INTERRUPTION_PREV_NEXT=Q0,o.ANIM_LESS_THAN=J0,o.ANIM_LESS_THAN_EQUAL_TO=tb,o.ANIM_NOT_EQUAL_TO=nb,o.ANIM_PARAMETER_BOOLEAN=ab,o.ANIM_PARAMETER_FLOAT=sb,o.ANIM_PARAMETER_INTEGER=rb,o.ANIM_PARAMETER_TRIGGER=ob,o.ANIM_STATE_ANY=pb,o.ANIM_STATE_END=db,o.ANIM_STATE_START=fb,o.ASPECT_AUTO=kc,o.ASPECT_MANUAL=Oc,o.ASSET_ANIMATION=m_,o.ASSET_AUDIO=__,o.ASSET_CONTAINER=P_,o.ASSET_CSS=M_,o.ASSET_CUBEMAP=w_,o.ASSET_HTML=C_,o.ASSET_IMAGE=v_,o.ASSET_JSON=g_,o.ASSET_MATERIAL=b_,o.ASSET_MODEL=y_,o.ASSET_SCRIPT=A_,o.ASSET_SHADER=T_,o.ASSET_TEXT=x_,o.ASSET_TEXTURE=S_,o.AXIS_KEY=vC,o.AXIS_MOUSE_X=uC,o.AXIS_MOUSE_Y=fC,o.AXIS_PAD_L_X=dC,o.AXIS_PAD_L_Y=pC,o.AXIS_PAD_R_X=mC,o.AXIS_PAD_R_Y=_C,o.AnimBinder=t_,o.AnimClip=F0,o.AnimClipHandler=wv,o.AnimComponent=Eb,o.AnimComponentLayer=Pb,o.AnimComponentSystem=Lb,o.AnimController=xb,o.AnimCurve=Zm,o.AnimData=Jm,o.AnimEvaluator=B0,o.AnimSnapshot=O0,o.AnimStateGraph=Tv,o.AnimStateGraphHandler=Mv,o.AnimTarget=N0,o.AnimTrack=e_,o.Animation=Km,o.AnimationComponent=G0,o.AnimationComponentSystem=j0,o.AnimationHandler=Sv,o.Application=rM,o.Asset=O_,o.AssetListLoader=$v,o.AssetReference=cg,o.AssetRegistry=Py,o.AudioHandler=Ev,o.AudioListenerComponent=Db,o.AudioListenerComponentSystem=Fb,o.AudioSourceComponent=Bb,o.AudioSourceComponentSystem=Vb,o.BAKE_COLOR=yc,o.BAKE_COLORDIR=bc,o.BLENDEQUATION_ADD=nt,o.BLENDEQUATION_MAX=ot,o.BLENDEQUATION_MIN=at,o.BLENDEQUATION_REVERSE_SUBTRACT=st,o.BLENDEQUATION_SUBTRACT=rt,o.BLENDMODE_DST_ALPHA=tt,o.BLENDMODE_DST_COLOR=Qe,o.BLENDMODE_ONE=qe,o.BLENDMODE_ONE_MINUS_DST_ALPHA=it,o.BLENDMODE_ONE_MINUS_DST_COLOR=$e,o.BLENDMODE_ONE_MINUS_SRC_ALPHA=et,o.BLENDMODE_ONE_MINUS_SRC_COLOR=Ke,o.BLENDMODE_SRC_ALPHA=Ze,o.BLENDMODE_SRC_ALPHA_SATURATE=Je,o.BLENDMODE_SRC_COLOR=Ye,o.BLENDMODE_ZERO=Xe,o.BLEND_ADDITIVE=dl,o.BLEND_ADDITIVEALPHA=gl,o.BLEND_MAX=Sl,o.BLEND_MIN=xl,o.BLEND_MULTIPLICATIVE=vl,o.BLEND_MULTIPLICATIVE2X=yl,o.BLEND_NONE=ml,o.BLEND_NORMAL=pl,o.BLEND_PREMULTIPLIED=_l,o.BLEND_SCREEN=bl,o.BLEND_SUBTRACTIVE=fl,o.BLUR_BOX=eh,o.BLUR_GAUSSIAN=th,o.BODYFLAG_KINEMATIC_OBJECT=ux,o.BODYFLAG_NORESPONSE_OBJECT=fx,o.BODYFLAG_STATIC_OBJECT=cx,o.BODYGROUP_DEFAULT=yx,o.BODYGROUP_DYNAMIC=bx,o.BODYGROUP_ENGINE_1=wx,o.BODYGROUP_ENGINE_2=Mx,o.BODYGROUP_ENGINE_3=Cx,o.BODYGROUP_KINEMATIC=Sx,o.BODYGROUP_NONE=gx,o.BODYGROUP_STATIC=xx,o.BODYGROUP_TRIGGER=Tx,o.BODYGROUP_USER_1=Ax,o.BODYGROUP_USER_2=Px,o.BODYGROUP_USER_3=Ex,o.BODYGROUP_USER_4=Ix,o.BODYGROUP_USER_5=Rx,o.BODYGROUP_USER_6=Lx,o.BODYGROUP_USER_7=Dx,o.BODYGROUP_USER_8=kx,o.BODYMASK_ALL=Fx,o.BODYMASK_NONE=Ox,o.BODYMASK_NOT_STATIC=Nx,o.BODYMASK_NOT_STATIC_KINEMATIC=zx,o.BODYMASK_STATIC=Bx,o.BODYSTATE_ACTIVE_TAG=dx,o.BODYSTATE_DISABLE_DEACTIVATION=_x,o.BODYSTATE_DISABLE_SIMULATION=vx,o.BODYSTATE_ISLAND_SLEEPING=px,o.BODYSTATE_WANTS_DEACTIVATION=mx,o.BODYTYPE_DYNAMIC=lx,o.BODYTYPE_KINEMATIC=hx,o.BODYTYPE_STATIC=ox,o.BUFFER_DYNAMIC=ht,o.BUFFER_GPUDYNAMIC=ut,o.BUFFER_STATIC=lt,o.BUFFER_STREAM=ct,o.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=Hb,o.BUTTON_TRANSITION_MODE_TINT=Gb,o.BasicMaterial=Kd,o.BasisParser=my,o.Batch=qu,o.BatchGroup=Yu,o.BatchManager=rf,o.BinaryHandler=Iv,o.BoundingBox=Ce,o.BoundingSphere=De,o.Bundle=Rv,o.BundleHandler=Bv,o.BundleRegistry=Ey,o.ButtonComponent=Yb,o.ButtonComponentSystem=Zb,o.CLEARFLAG_COLOR=ft,o.CLEARFLAG_DEPTH=dt,o.CLEARFLAG_STENCIL=pt,o.COMPUPDATED_BLEND=Dc,o.COMPUPDATED_CAMERAS=Lc,o.COMPUPDATED_INSTANCES=Ic,o.COMPUPDATED_LIGHTS=Rc,o.CUBEFACE_NEGX=_t,o.CUBEFACE_NEGY=gt,o.CUBEFACE_NEGZ=bt,o.CUBEFACE_POSX=mt,o.CUBEFACE_POSY=vt,o.CUBEFACE_POSZ=yt,o.CUBEPROJ_BOX=yh,o.CUBEPROJ_NONE=gh,o.CULLFACE_BACK=St,o.CULLFACE_FRONT=wt,o.CULLFACE_FRONTANDBACK=Tt,o.CULLFACE_NONE=xt,o.CURVE_CARDINAL=ie,o.CURVE_CATMULL=te,o.CURVE_LINEAR=J,o.CURVE_SMOOTHSTEP=ee,o.CURVE_SPLINE=ne,o.CURVE_STEP=re,o.Camera=hf,o.CameraComponent=tx,o.CameraComponentSystem=rx,o.CanvasFont=eC,o.CollisionComponent=sx,o.CollisionComponentSystem=iS,o.Color=ge,o.Command=Nu,o.Component=R0,o.ComponentData=HE,o.ComponentSystem=L0,o.ComponentSystemRegistry=nS,o.ContactPoint=uT,o.ContactResult=fT,o.ContainerHandler=Uv,o.ContainerResource=Vv,o.ContextCreationError=DI,o.Controller=rE,o.CssHandler=Gv,o.CubemapHandler=Wv,o.Curve=ae,o.CurveSet=oe,o.DETAILMODE_ADD=wh,o.DETAILMODE_MAX=Ah,o.DETAILMODE_MIN=Ch,o.DETAILMODE_MUL=Sh,o.DETAILMODE_OVERLAY=Mh,o.DETAILMODE_SCREEN=Th,o.DISTANCE_EXPONENTIAL=Vm,o.DISTANCE_INVERSE=zm,o.DISTANCE_LINEAR=Nm,o.DefaultAnimBinder=z0,o.DepthMaterial=QM,o.ELEMENTTYPE_FLOAT32=RI,o.ELEMENTTYPE_GROUP=rS,o.ELEMENTTYPE_IMAGE=sS,o.ELEMENTTYPE_INT16=AI,o.ELEMENTTYPE_INT32=EI,o.ELEMENTTYPE_INT8=MI,o.ELEMENTTYPE_TEXT=aS,o.ELEMENTTYPE_UINT16=PI,o.ELEMENTTYPE_UINT32=II,o.ELEMENTTYPE_UINT8=CI,o.EMITTERSHAPE_BOX=lh,o.EMITTERSHAPE_SPHERE=hh,o.EVENT_KEYDOWN=gC,o.EVENT_KEYUP=yC,o.EVENT_MOUSEDOWN=bC,o.EVENT_MOUSEMOVE=xC,o.EVENT_MOUSEUP=SC,o.EVENT_MOUSEWHEEL=wC,o.EVENT_SELECT=PC,o.EVENT_SELECTEND=IC,o.EVENT_SELECTSTART=EC,o.EVENT_TOUCHCANCEL=AC,o.EVENT_TOUCHEND=MC,o.EVENT_TOUCHMOVE=CC,o.EVENT_TOUCHSTART=TC,o.ElementComponent=WS,o.ElementComponentSystem=YS,o.ElementDragHelper=t1,o.ElementInput=OE,o.ElementInputEvent=RE,o.ElementMouseEvent=LE,o.ElementSelectEvent=kE,o.ElementTouchEvent=DE,o.Entity=Nv,o.EntityReference=Ub,o.EventHandler=u,o.FILLMODE_FILL_WINDOW=ky,o.FILLMODE_KEEP_ASPECT=Oy,o.FILLMODE_NONE=Dy,o.FILTER_LINEAR=Ct,o.FILTER_LINEAR_MIPMAP_LINEAR=It,o.FILTER_LINEAR_MIPMAP_NEAREST=Et,o.FILTER_NEAREST=Mt,o.FILTER_NEAREST_MIPMAP_LINEAR=Pt,o.FILTER_NEAREST_MIPMAP_NEAREST=At,o.FITTING_BOTH=nw,o.FITTING_NONE=ew,o.FITTING_SHRINK=iw,o.FITTING_STRETCH=tw,o.FOG_EXP=Ml,o.FOG_EXP2=Cl,o.FOG_LINEAR=Tl,o.FOG_NONE=wl,o.FONT_BITMAP=qv,o.FONT_MSDF=Xv,o.FRESNEL_NONE=Al,o.FRESNEL_SCHLICK=Pl,o.FUNC_ALWAYS=Nt,o.FUNC_EQUAL=Dt,o.FUNC_GREATER=Ot,o.FUNC_GREATEREQUAL=Bt,o.FUNC_LESS=Lt,o.FUNC_LESSEQUAL=kt,o.FUNC_NEVER=Rt,o.FUNC_NOTEQUAL=Ft,o.FolderHandler=jv,o.Font=Yv,o.FontHandler=Qv,o.ForwardRenderer=Yd,o.Frustum=ke,o.GAMMA_NONE=Ph,o.GAMMA_SRGB=Eh,o.GAMMA_SRGBFAST=Ih,o.GAMMA_SRGBHDR=Rh,o.GamePads=NE,o.GraphNode=Mf,o.GraphicsDevice=OM,o.HierarchyHandler=ig,o.HtmlHandler=ng,o.Http=$,o.I18n=Ly,o.INDEXFORMAT_UINT16=Vt,o.INDEXFORMAT_UINT32=Ut,o.INDEXFORMAT_UINT8=zt,o.INTERPOLATION_CUBIC=r_,o.INTERPOLATION_LINEAR=n_,o.INTERPOLATION_STEP=i_,o.ImageElement=hS,o.ImgParser=_y,o.IndexBuffer=Eu,o.IndexedList=N,o.JsonHandler=rg,o.JsonStandardMaterialParser=fg,o.KEY_0=JC,o.KEY_1=eA,o.KEY_2=tA,o.KEY_3=iA,o.KEY_4=nA,o.KEY_5=rA,o.KEY_6=sA,o.KEY_7=aA,o.KEY_8=oA,o.KEY_9=lA,o.KEY_A=uA,o.KEY_ADD=QA,o.KEY_ALT=BC,o.KEY_B=fA,o.KEY_BACKSPACE=RC,o.KEY_BACK_SLASH=vP,o.KEY_C=dA,o.KEY_CAPS_LOCK=zC,o.KEY_CLOSE_BRACKET=gP,o.KEY_COMMA=dP,o.KEY_CONTEXT_MENU=NA,o.KEY_CONTROL=FC,o.KEY_D=pA,o.KEY_DECIMAL=JA,o.KEY_DELETE=ZC,o.KEY_DIVIDE=eP,o.KEY_DOWN=KC,o.KEY_E=mA,o.KEY_END=WC,o.KEY_ENTER=kC,o.KEY_EQUAL=cA,o.KEY_ESCAPE=VC,o.KEY_F=_A,o.KEY_F1=tP,o.KEY_F10=cP,o.KEY_F11=uP,o.KEY_F12=fP,o.KEY_F2=iP,o.KEY_F3=nP,o.KEY_F4=rP,o.KEY_F5=sP,o.KEY_F6=aP,o.KEY_F7=oP,o.KEY_F8=lP,o.KEY_F9=hP,o.KEY_G=vA,o.KEY_H=gA,o.KEY_HOME=jC,o.KEY_I=yA,o.KEY_INSERT=$C,o.KEY_J=bA,o.KEY_K=xA,o.KEY_L=SA,o.KEY_LEFT=XC,o.KEY_M=wA,o.KEY_META=yP,o.KEY_MULTIPLY=KA,o.KEY_N=TA,o.KEY_NUMPAD_0=zA,o.KEY_NUMPAD_1=VA,o.KEY_NUMPAD_2=UA,o.KEY_NUMPAD_3=GA,o.KEY_NUMPAD_4=HA,o.KEY_NUMPAD_5=WA,o.KEY_NUMPAD_6=jA,o.KEY_NUMPAD_7=XA,o.KEY_NUMPAD_8=qA,o.KEY_NUMPAD_9=YA,o.KEY_O=MA,o.KEY_OPEN_BRACKET=_P,o.KEY_P=CA,o.KEY_PAGE_DOWN=HC,o.KEY_PAGE_UP=GC,o.KEY_PAUSE=NC,o.KEY_PERIOD=pP,o.KEY_PRINT_SCREEN=QC,o.KEY_Q=AA,o.KEY_R=PA,o.KEY_RETURN=DC,o.KEY_RIGHT=YC,o.KEY_S=EA,o.KEY_SEMICOLON=hA,o.KEY_SEPARATOR=$A,o.KEY_SHIFT=OC,o.KEY_SLASH=mP,o.KEY_SPACE=UC,o.KEY_SUBTRACT=ZA,o.KEY_T=IA,o.KEY_TAB=LC,o.KEY_U=RA,o.KEY_UP=qC,o.KEY_V=LA,o.KEY_W=DA,o.KEY_WINDOWS=BA,o.KEY_X=kA,o.KEY_Y=OA,o.KEY_Z=FA,o.Key=qm,o.Keyboard=eE,o.KeyboardEvent=KP,o.KtxParser=yy,o.LAYERID_DEPTH=kl,o.LAYERID_IMMEDIATE=Fl,o.LAYERID_SKYBOX=Ol,o.LAYERID_UI=Bl,o.LAYERID_WORLD=Dl,o.LAYER_FX=Rl,o.LAYER_GIZMO=Il,o.LAYER_HUD=El,o.LAYER_WORLD=Ll,o.LIGHTFALLOFF_INVERSESQUARED=ql,o.LIGHTFALLOFF_LINEAR=Xl,o.LIGHTSHAPE_DISK=Wl,o.LIGHTSHAPE_PUNCTUAL=Gl,o.LIGHTSHAPE_RECT=Hl,o.LIGHTSHAPE_SPHERE=jl,o.LIGHTTYPE_DIRECTIONAL=Nl,o.LIGHTTYPE_OMNI=zl,o.LIGHTTYPE_POINT=Vl,o.LIGHTTYPE_SPOT=Ul,o.LINEBATCH_GIZMO=tc,o.LINEBATCH_OVERLAY=ec,o.LINEBATCH_WORLD=Jh,o.Layer=Vf,o.LayerComposition=ep,o.LayoutCalculator=uw,o.LayoutChildComponent=KS,o.LayoutChildComponentSystem=JS,o.LayoutGroupComponent=pw,o.LayoutGroupComponentSystem=yw,o.LegacyDdsParser=by,o.Light=Tw,o.LightComponent=Aw,o.LightComponentSystem=Lw,o.Lightmapper=_p,o.LocalizedAsset=cS,o.MASK_BAKED=lc,o.MASK_DYNAMIC=oc,o.MASK_LIGHTMAP=hc,o.MOUSEBUTTON_LEFT=xP,o.MOUSEBUTTON_MIDDLE=SP,o.MOUSEBUTTON_NONE=bP,o.MOUSEBUTTON_RIGHT=wP,o.Mat3=le,o.Mat4=ve,o.Material=Cu,o.MaterialHandler=pg,o.Mesh=Du,o.MeshInstance=zu,o.Model=Xu,o.ModelComponent=Dw,o.ModelComponentSystem=Fw,o.ModelHandler=Tg,o.Morph=Uu,o.MorphInstance=Hu,o.MorphTarget=Qm,o.Mouse=nE,o.MouseEvent=iE,o.Node=Ym,o.ORIENTATION_HORIZONTAL=Fc,o.ORIENTATION_VERTICAL=Bc,o.OrientedBox=Ve,o.PAD_1=TP,o.PAD_2=MP,o.PAD_3=CP,o.PAD_4=AP,o.PAD_DOWN=UP,o.PAD_FACE_1=PP,o.PAD_FACE_2=EP,o.PAD_FACE_3=IP,o.PAD_FACE_4=RP,o.PAD_LEFT=GP,o.PAD_L_SHOULDER_1=LP,o.PAD_L_SHOULDER_2=kP,o.PAD_L_STICK_BUTTON=NP,o.PAD_L_STICK_X=jP,o.PAD_L_STICK_Y=XP,o.PAD_RIGHT=HP,o.PAD_R_SHOULDER_1=DP,o.PAD_R_SHOULDER_2=OP,o.PAD_R_STICK_BUTTON=zP,o.PAD_R_STICK_X=qP,o.PAD_R_STICK_Y=YP,o.PAD_SELECT=FP,o.PAD_START=BP,o.PAD_UP=VP,o.PAD_VENDOR=WP,o.PARTICLEMODE_CPU=oh,o.PARTICLEMODE_GPU=ah,o.PARTICLEORIENTATION_EMITTER=fh,o.PARTICLEORIENTATION_SCREEN=ch,o.PARTICLEORIENTATION_WORLD=uh,o.PARTICLESORT_DISTANCE=nh,o.PARTICLESORT_NEWER_FIRST=rh,o.PARTICLESORT_NONE=ih,o.PARTICLESORT_OLDER_FIRST=sh,o.PIXELFORMAT_111110F=ai,o.PIXELFORMAT_A8=Gt,o.PIXELFORMAT_ASTC_4x4=_i,o.PIXELFORMAT_ATC_RGB=vi,o.PIXELFORMAT_ATC_RGBA=gi,o.PIXELFORMAT_DEPTH=ri,o.PIXELFORMAT_DEPTHSTENCIL=si,o.PIXELFORMAT_DXT1=Qt,o.PIXELFORMAT_DXT3=$t,o.PIXELFORMAT_DXT5=Zt,o.PIXELFORMAT_ETC1=hi,o.PIXELFORMAT_ETC2_RGB=ci,o.PIXELFORMAT_ETC2_RGBA=ui,o.PIXELFORMAT_L8=Ht,o.PIXELFORMAT_L8_A8=Wt,o.PIXELFORMAT_PVRTC_2BPP_RGBA_1=di,o.PIXELFORMAT_PVRTC_2BPP_RGB_1=fi,o.PIXELFORMAT_PVRTC_4BPP_RGBA_1=mi,o.PIXELFORMAT_PVRTC_4BPP_RGB_1=pi,o.PIXELFORMAT_R32F=ni,o.PIXELFORMAT_R4_G4_B4_A4=qt,o.PIXELFORMAT_R5_G5_B5_A1=Xt,o.PIXELFORMAT_R5_G6_B5=jt,o.PIXELFORMAT_R8_G8_B8=Yt,o.PIXELFORMAT_R8_G8_B8_A8=Kt,o.PIXELFORMAT_RGB16F=Jt,o.PIXELFORMAT_RGB32F=ti,o.PIXELFORMAT_RGBA16F=ei,o.PIXELFORMAT_RGBA32F=ii,o.PIXELFORMAT_SRGB=oi,o.PIXELFORMAT_SRGBA=li,o.PRIMITIVE_LINELOOP=xi,o.PRIMITIVE_LINES=bi,o.PRIMITIVE_LINESTRIP=Si,o.PRIMITIVE_POINTS=yi,o.PRIMITIVE_TRIANGLES=wi,o.PRIMITIVE_TRIFAN=Mi,o.PRIMITIVE_TRISTRIP=Ti,o.PROJECTION_ORTHOGRAPHIC=ph,o.PROJECTION_PERSPECTIVE=dh,o.ParticleEmitter=gm,o.ParticleSystemComponent=qw,o.ParticleSystemComponentSystem=Qw,o.PhongMaterial=FI,o.Picker=$M,o.Plane=Ge,o.PostEffect=XM,o.PostEffectPass=yI,o.PostEffectQueue=ex,o.ProgramLibrary=wM,o.Quat=be,o.RENDERSTYLE_POINTS=vh,o.RENDERSTYLE_SOLID=mh,o.RENDERSTYLE_WIREFRAME=_h,o.RESOLUTION_AUTO=Fy,o.RESOLUTION_FIXED=By,o.RIGIDBODY_ACTIVE_TAG=YI,o.RIGIDBODY_CF_KINEMATIC_OBJECT=XI,o.RIGIDBODY_CF_NORESPONSE_OBJECT=qI,o.RIGIDBODY_CF_STATIC_OBJECT=jI,o.RIGIDBODY_DISABLE_DEACTIVATION=$I,o.RIGIDBODY_DISABLE_SIMULATION=ZI,o.RIGIDBODY_ISLAND_SLEEPING=KI,o.RIGIDBODY_TYPE_DYNAMIC=HI,o.RIGIDBODY_TYPE_KINEMATIC=WI,o.RIGIDBODY_TYPE_STATIC=GI,o.RIGIDBODY_WANTS_DEACTIVATION=QI,o.Ray=Oe,o.RaycastResult=hT,o.RenderHandler=Eg,o.RenderTarget=BM,o.ResourceHandler=tC,o.ResourceLoader=Ig,o.RigidBodyComponent=nT,o.RigidBodyComponentSystem=pT,o.SCALEMODE_BLEND=_T,o.SCALEMODE_NONE=mT,o.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=s1,o.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=a1,o.SCROLL_MODE_BOUNCE=n1,o.SCROLL_MODE_CLAMP=i1,o.SCROLL_MODE_INFINITE=r1,o.SEMANTIC_ATTR=Ui,o.SEMANTIC_ATTR0=Gi,o.SEMANTIC_ATTR1=Hi,o.SEMANTIC_ATTR10=Zi,o.SEMANTIC_ATTR11=Ji,o.SEMANTIC_ATTR12=en,o.SEMANTIC_ATTR13=tn,o.SEMANTIC_ATTR14=nn,o.SEMANTIC_ATTR15=rn,o.SEMANTIC_ATTR2=Wi,o.SEMANTIC_ATTR3=ji,o.SEMANTIC_ATTR4=Xi,o.SEMANTIC_ATTR5=qi,o.SEMANTIC_ATTR6=Yi,o.SEMANTIC_ATTR7=Ki,o.SEMANTIC_ATTR8=Qi,o.SEMANTIC_ATTR9=$i,o.SEMANTIC_BLENDINDICES=Ii,o.SEMANTIC_BLENDWEIGHT=Ei,o.SEMANTIC_COLOR=Ri,o.SEMANTIC_NORMAL=Ai,o.SEMANTIC_POSITION=Ci,o.SEMANTIC_TANGENT=Pi,o.SEMANTIC_TEXCOORD=Li,o.SEMANTIC_TEXCOORD0=Di,o.SEMANTIC_TEXCOORD1=ki,o.SEMANTIC_TEXCOORD2=Oi,o.SEMANTIC_TEXCOORD3=Fi,o.SEMANTIC_TEXCOORD4=Bi,o.SEMANTIC_TEXCOORD5=Ni,o.SEMANTIC_TEXCOORD6=zi,o.SEMANTIC_TEXCOORD7=Vi,o.SHADERDEF_DIRLM=qh,o.SHADERDEF_INSTANCING=jh,o.SHADERDEF_LM=Xh,o.SHADERDEF_MORPH_NORMAL=$h,o.SHADERDEF_MORPH_POSITION=Qh,o.SHADERDEF_MORPH_TEXTURE_BASED=Zh,o.SHADERDEF_NOSHADOW=Vh,o.SHADERDEF_SCREENSPACE=Yh,o.SHADERDEF_SKIN=Uh,o.SHADERDEF_TANGENTS=Kh,o.SHADERDEF_UV0=Gh,o.SHADERDEF_UV1=Hh,o.SHADERDEF_VCOLOR=Wh,o.SHADERTAG_MATERIAL=sn,o.SHADER_DEPTH=fc,o.SHADER_FORWARD=cc,o.SHADER_FORWARDHDR=uc,o.SHADER_PICK=mc,o.SHADER_SHADOW=dc,o.SHADOWUPDATE_NONE=ic,o.SHADOWUPDATE_REALTIME=rc,o.SHADOWUPDATE_THISFRAME=nc,o.SHADOW_DEPTH=Kl,o.SHADOW_PCF3=Yl,o.SHADOW_PCF5=Jl,o.SHADOW_VSM16=$l,o.SHADOW_VSM32=Zl,o.SHADOW_VSM8=Ql,o.SORTKEY_DEPTH=ac,o.SORTKEY_FORWARD=sc,o.SORTMODE_BACK2FRONT=Ac,o.SORTMODE_CUSTOM=Ec,o.SORTMODE_FRONT2BACK=Pc,o.SORTMODE_MANUAL=Mc,o.SORTMODE_MATERIALMESH=Cc,o.SORTMODE_NONE=Tc,o.SPECOCC_AO=Nh,o.SPECOCC_GLOSSDEPENDENT=zh,o.SPECOCC_NONE=Bh,o.SPECULAR_BLINN=xh,o.SPECULAR_PHONG=bh,o.SPRITETYPE_ANIMATED=O1,o.SPRITETYPE_SIMPLE=k1,o.SPRITE_RENDERMODE_SIMPLE=_c,o.SPRITE_RENDERMODE_SLICED=vc,o.SPRITE_RENDERMODE_TILED=gc,o.STENCILOP_DECREMENT=un,o.STENCILOP_DECREMENTWRAP=fn,o.STENCILOP_INCREMENT=hn,o.STENCILOP_INCREMENTWRAP=cn,o.STENCILOP_INVERT=dn,o.STENCILOP_KEEP=an,o.STENCILOP_REPLACE=ln,o.STENCILOP_ZERO=on,o.Scene=km,o.SceneHandler=Rg,o.SceneRegistry=eM,o.SceneRegistryItem=J1,o.SceneSettingsHandler=Lg,o.ScopeId=AM,o.ScopeSpace=PM,o.ScreenComponent=gT,o.ScreenComponentSystem=xT,o.ScriptAttributes=MT,o.ScriptComponent=CT,o.ScriptComponentSystem=kT,o.ScriptHandler=Fg,o.ScriptLegacyComponent=OT,o.ScriptLegacyComponentSystem=XT,o.ScriptRegistry=Iy,o.ScriptType=nC,o.ScrollViewComponent=l1,o.ScrollViewComponentSystem=f1,o.ScrollbarComponent=d1,o.ScrollbarComponentSystem=_1,o.Shader=Ir,o.ShaderHandler=Bg,o.SingleContactResult=cT,o.Skeleton=U0,o.Skin=$m,o.SkinBatchInstance=Ku,o.SkinInstance=ju,o.SortedLoopArray=z,o.Sound=Cv,o.SoundComponent=P1,o.SoundComponentSystem=D1,o.SoundInstance=x1,o.SoundInstance3d=w1,o.SoundManager=Xm,o.SoundSlot=A1,o.Sprite=Vg,o.SpriteAnimationClip=F1,o.SpriteComponent=W1,o.SpriteComponentSystem=q1,o.SpriteHandler=Hg,o.StandardMaterial=pM,o.StencilParameters=oS,o.TEXHINT_ASSET=Sn,o.TEXHINT_LIGHTMAP=wn,o.TEXHINT_NONE=bn,o.TEXHINT_SHADOWMAP=xn,o.TEXTURELOCK_READ=pn,o.TEXTURELOCK_WRITE=mn,o.TEXTURETYPE_DEFAULT=_n,o.TEXTURETYPE_RGBE=gn,o.TEXTURETYPE_RGBM=vn,o.TEXTURETYPE_SWIZZLEGGGR=yn,o.TONEMAP_ACES=Oh,o.TONEMAP_ACES2=Fh,o.TONEMAP_FILMIC=Dh,o.TONEMAP_HEJL=kh,o.TONEMAP_LINEAR=Lh,o.TYPE_FLOAT32=In,o.TYPE_INT16=Cn,o.TYPE_INT32=Pn,o.TYPE_INT8=Tn,o.TYPE_UINT16=An,o.TYPE_UINT32=En,o.TYPE_UINT8=Mn,o.Tags=q,o.Template=Wg,o.TemplateHandler=jg,o.TemplateUtils=Zv,o.TextElement=OS,o.TextHandler=Xg,o.Texture=bu,o.TextureAtlas=qg,o.TextureAtlasHandler=$g,o.TextureHandler=Cy,o.TextureParser=Ty,o.Timer=Y,o.Touch=VE,o.TouchDevice=GE,o.TouchEvent=UE,o.TransformFeedback=KM,o.UNIFORMTYPE_BOOL=Rn,o.UNIFORMTYPE_BVEC2=Vn,o.UNIFORMTYPE_BVEC3=Un,o.UNIFORMTYPE_BVEC4=Gn,o.UNIFORMTYPE_FLOAT=Dn,o.UNIFORMTYPE_FLOATARRAY=Yn,o.UNIFORMTYPE_INT=Ln,o.UNIFORMTYPE_IVEC2=Bn,o.UNIFORMTYPE_IVEC3=Nn,o.UNIFORMTYPE_IVEC4=zn,o.UNIFORMTYPE_MAT2=Hn,o.UNIFORMTYPE_MAT3=Wn,o.UNIFORMTYPE_MAT4=jn,o.UNIFORMTYPE_TEXTURE2D=Xn,o.UNIFORMTYPE_TEXTURE2D_SHADOW=Kn,o.UNIFORMTYPE_TEXTURE3D=$n,o.UNIFORMTYPE_TEXTURECUBE=qn,o.UNIFORMTYPE_TEXTURECUBE_SHADOW=Qn,o.UNIFORMTYPE_VEC2=kn,o.UNIFORMTYPE_VEC2ARRAY=Zn,o.UNIFORMTYPE_VEC3=On,o.UNIFORMTYPE_VEC3ARRAY=Jn,o.UNIFORMTYPE_VEC4=Fn,o.UNIFORMTYPE_VEC4ARRAY=er,o.URI=Q,o.UnsupportedBrowserError=LI,o.VIEW_CENTER=xc;o.VIEW_LEFT=Sc,o.VIEW_RIGHT=wc,o.Vec2=he,o.Vec3=ce,o.Vec4=ue,o.VertexBuffer=lr,o.VertexFormat=cr,o.VertexIterator=Tr,o.VrDisplay=Ny,o.VrManager=zy,o.XRHAND_LEFT=Zy,o.XRHAND_NONE=$y,o.XRHAND_RIGHT=Jy,o.XRSPACE_BOUNDEDFLOOR=Xy,o.XRSPACE_LOCAL=Wy,o.XRSPACE_LOCALFLOOR=jy,o.XRSPACE_UNBOUNDED=qy,o.XRSPACE_VIEWER=Hy,o.XRTARGETRAY_GAZE=Yy,o.XRTARGETRAY_POINTER=Qy,o.XRTARGETRAY_SCREEN=Ky,o.XRTRACKABLE_MESH=i0,o.XRTRACKABLE_PLANE=t0,o.XRTRACKABLE_POINT=e0,o.XRTYPE_AR=Gy,o.XRTYPE_INLINE=Vy,o.XRTYPE_VR=Uy,o.XrDepthSensing=E0,o.XrDomOverlay=P0,o.XrHitTest=a0,o.XrHitTestSource=s0,o.XrImageTracking=A0,o.XrInput=b0,o.XrInputSource=y0,o.XrLightEstimation=M0,o.XrManager=I0,o.XrTrackedImage=C0,o.ZoneComponent=Y1,o.ZoneComponentSystem=$1,o.anim=NI,o.apps=n,o.asset=VI,o.audio=zI,o.basisDownload=uy,o.basisDownloadFromConfig=dy,o.basisInitialize=cy,o.basisSetDownloadConfig=fy,o.basisTargetFormat=oy,o.basisTranscode=py,o.calculateNormals=Sm,o.calculateTangents=wm,o.common=t,o.config=e,o.createBox=Lm,o.createCapsule=Pm,o.createCone=Em,o.createCylinder=Am,o.createMesh=Tm,o.createPlane=Rm,o.createScript=sC,o.createSphere=Im,o.createStyle=Hv,o.createTorus=Mm,o.createURI=K,o.data=a,o.debug=c,o.drawFullscreenQuad=YM,o.drawQuadWithShader=Ar,o.drawTexture=Er,o.events=f,o.extend=_,o.fw=JI,o.getTouchTargetCoords=zE,o.gfx=kI,o.guid=d,o.http=Z,o.inherits=SI,o.input=UI,o.isDefined=h,o.log=bI,o.makeArray=wI,o.math=Pe,o.now=ye,o.path=p,o.platform=m,o.posteffect=OI,o.prefilterCubemap=zM,o.programlib=vu,o.registerScript=oC,o.reprojectTexture=WM,o.revision=s,o.scene=BI,o.script=Og,o.semanticToLocation=ar,o.shFromCubemap=GM,o.shaderChunks=ul,o.shape=TI,o.string=Ae,o.time=xI,o.type=l,o.typedArrayIndexFormats=rr,o.typedArrayIndexFormatsByteSize=sr,o.typedArrayToType=nr,o.typedArrayTypes=tr,o.typedArrayTypesByteSize=ir,o.version=r,Object.defineProperty(o,"__esModule",{value:true})}(t)},"./node_modules/process/browser.js":function(e,t){var i,n,e=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(t){if(i===setTimeout)return setTimeout(t,0);if((i===r||!i)&&setTimeout)return i=setTimeout,setTimeout(t,0);try{return i(t,0)}catch(e){try{return i.call(null,t,0)}catch(e){return i.call(this,t,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:r}catch(e){i=r}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var o,l=[],h=!1,c=-1;function u(){h&&o&&(h=!1,o.length?l=o.concat(l):c=-1,l.length&&f())}function f(){if(!h){var e=a(u);h=!0;for(var t=l.length;t;){for(o=l,l=[];++c<t;)o&&o[c].run();c=-1,t=l.length}o=null,h=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function p(){}e.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];l.push(new d(e,t)),1!==l.length||h||a(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},e.title="browser",e.browser=!0,e.env={},e.argv=[],e.version="",e.versions={},e.on=p,e.addListener=p,e.once=p,e.off=p,e.removeListener=p,e.removeAllListeners=p,e.emit=p,e.prependListener=p,e.prependOnceListener=p,e.listeners=function(e){return[]},e.binding=function(e){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(e){throw new Error("process.chdir is not supported")},e.umask=function(){return 0}},"./node_modules/socket.io-client/build/index.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=t.io=t.Manager=t.protocol=void 0;const a=i("./node_modules/socket.io-client/build/url.js"),o=i("./node_modules/socket.io-client/build/manager.js"),n=i("./node_modules/socket.io-client/build/socket.js");Object.defineProperty(t,"Socket",{enumerable:!0,get:function(){return n.Socket}});const l=i("./node_modules/socket.io-client/node_modules/debug/src/browser.js")("socket.io-client");e.exports=t=r;const h=t.managers={};function r(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var i=a.url(e),n=i.source,r=i.id,e=i.path,e=h[r]&&e in h[r].nsps,e=t.forceNew||t["force new connection"]||!1===t.multiplex||e;let s;return s=e?(l("ignoring socket cache for %s",n),new o.Manager(n,t)):(h[r]||(l("new io instance for %s",n),h[r]=new o.Manager(n,t)),h[r]),i.query&&!t.query&&(t.query=i.query),s.socket(i.path,t)}t.io=r;var s=i("./node_modules/socket.io-parser/dist/index.js");Object.defineProperty(t,"protocol",{enumerable:!0,get:function(){return s.protocol}}),t.connect=r;var c=i("./node_modules/socket.io-client/build/manager.js");Object.defineProperty(t,"Manager",{enumerable:!0,get:function(){return c.Manager}})},"./node_modules/socket.io-client/build/manager.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Manager=void 0;const o=i("./node_modules/engine.io-client/lib/index.js"),n=i("./node_modules/socket.io-client/build/socket.js");var r=i("./node_modules/component-emitter/index.js");const s=i("./node_modules/socket.io-parser/dist/index.js"),l=i("./node_modules/socket.io-client/build/on.js"),a=i("./node_modules/backo2/index.js"),h=i("./node_modules/socket.io-client/node_modules/debug/src/browser.js")("socket.io-client:manager");class c extends r{constructor(e,t){super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(t.randomizationFactor||.5),this.backoff=new a({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const i=t.parser||s;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null!==(t=this.backoff)&&void 0!==t&&t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null!==(t=this.backoff)&&void 0!==t&&t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null!==(t=this.backoff)&&void 0!==t&&t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(h("readyState %s",this._readyState),~this._readyState.indexOf("open"))return this;h("opening %s",this.uri),this.engine=o(this.uri,this.opts);const e=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;const n=l.on(e,"open",function(){i.onopen(),t&&t()});var r=l.on(e,"error",e=>{h("error"),i.cleanup(),i._readyState="closed",super.emit("error",e),t?t(e):i.maybeReconnectOnOpen()});if(!1!==this._timeout){const s=this._timeout;h("connect attempt will timeout after %d",s),0===s&&n();const a=setTimeout(()=>{h("connect attempt timed out after %d",s),n(),e.close(),e.emit("error",new Error("timeout"))},s);this.subs.push(function(){clearTimeout(a)})}return this.subs.push(n),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){h("open"),this.cleanup(),this._readyState="open",super.emit("open");var e=this.engine;this.subs.push(l.on(e,"ping",this.onping.bind(this)),l.on(e,"data",this.ondata.bind(this)),l.on(e,"error",this.onerror.bind(this)),l.on(e,"close",this.onclose.bind(this)),l.on(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){super.emit("ping")}ondata(e){this.decoder.add(e)}ondecoded(e){super.emit("packet",e)}onerror(e){h("error",e),super.emit("error",e)}socket(e,t){let i=this.nsps[e];return i||(i=new n.Socket(this,e,t),this.nsps[e]=i),i}_destroy(e){for(const t of Object.keys(this.nsps)){const e=this.nsps[t];if(e.active)return void h("socket %s is still active, skipping close",t)}this._close()}_packet(t){h("writing packet %j",t),t.query&&0===t.type&&(t.nsp+="?"+t.query);var i=this.encoder.encode(t);for(let e=0;e<i.length;e++)this.engine.write(i[e],t.options)}cleanup(){h("cleanup"),this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){h("disconnect"),this.skipReconnect=!0,this._reconnecting=!1,"opening"===this._readyState&&this.cleanup(),this.backoff.reset(),this._readyState="closed",this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e){h("onclose"),this.cleanup(),this.backoff.reset(),this._readyState="closed",super.emit("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)h("reconnect failed"),this.backoff.reset(),super.emit("reconnect_failed"),this._reconnecting=!1;else{var e=this.backoff.duration();h("will wait %dms before reconnect attempt",e),this._reconnecting=!0;const i=setTimeout(()=>{t.skipReconnect||(h("attempting reconnect"),super.emit("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open(e=>{e?(h("reconnect attempt error"),t._reconnecting=!1,t.reconnect(),super.emit("reconnect_error",e)):(h("reconnect success"),t.onreconnect())}))},e);this.subs.push(function(){clearTimeout(i)})}}onreconnect(){var e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),super.emit("reconnect",e)}}t.Manager=c},"./node_modules/socket.io-client/build/on.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.on=void 0,t.on=function(e,t,i){return e.on(t,i),function(){e.off(t,i)}}},"./node_modules/socket.io-client/build/socket.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Socket=void 0;const r=i("./node_modules/socket.io-parser/dist/index.js");var n=i("./node_modules/component-emitter/index.js");const s=i("./node_modules/socket.io-client/build/on.js"),a=i("./node_modules/socket.io-client/node_modules/debug/src/browser.js")("socket.io-client:socket"),o=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class l extends n{constructor(e,t,i){super(),this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},i&&i.auth&&(this.auth=i.auth),this.io._autoConnect&&this.open()}subEvents(){var e;this.subs||(e=this.io,this.subs=[s.on(e,"open",this.onopen.bind(this)),s.on(e,"packet",this.onpacket.bind(this)),s.on(e,"error",this.onerror.bind(this)),s.on(e,"close",this.onclose.bind(this))])}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(o.hasOwnProperty(e))throw new Error('"'+e+'" is a reserved event name');t.unshift(e);const i={type:r.PacketType.EVENT,data:t,options:{}};i.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(a("emitting packet with ack id %d",this.ids),this.acks[this.ids]=t.pop(),i.id=this.ids++);t=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!t||!this.connected)?a("discard packet as the transport is not currently writable"):this.connected?this.packet(i):this.sendBuffer.push(i),this.flags={},this}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){a("transport is open - connecting"),"function"==typeof this.auth?this.auth(e=>{this.packet({type:r.PacketType.CONNECT,data:e})}):this.packet({type:r.PacketType.CONNECT,data:this.auth})}onerror(e){this.connected||super.emit("connect_error",e)}onclose(e){a("close (%s)",e),this.connected=!1,this.disconnected=!0,delete this.id,super.emit("disconnect",e)}onpacket(e){var t;if(e.nsp===this.nsp)switch(e.type){case r.PacketType.CONNECT:e.data&&e.data.sid?(t=e.data.sid,this.onconnect(t)):super.emit("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case r.PacketType.EVENT:case r.PacketType.BINARY_EVENT:this.onevent(e);break;case r.PacketType.ACK:case r.PacketType.BINARY_ACK:this.onack(e);break;case r.PacketType.DISCONNECT:this.ondisconnect();break;case r.PacketType.CONNECT_ERROR:const i=new Error(e.data.message);i.data=e.data.data,super.emit("connect_error",i)}}onevent(e){const t=e.data||[];a("emitting event %j",t),null!=e.id&&(a("attaching ack callback to event"),t.push(this.ack(e.id))),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length)for(const t of this._anyListeners.slice())t.apply(this,e);super.emit.apply(this,e)}ack(t){const i=this;let n=!1;return function(...e){n||(n=!0,a("sending ack %j",e),i.packet({type:r.PacketType.ACK,id:t,data:e}))}}onack(e){const t=this.acks[e.id];"function"==typeof t?(a("calling ack %s with %j",e.id,e.data),t.apply(this,e.data),delete this.acks[e.id]):a("bad ack %s",e.id)}onconnect(e){a("socket connected with id %s",e),this.id=e,this.connected=!0,this.disconnected=!1,super.emit("connect"),this.emitBuffered()}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>this.packet(e)),this.sendBuffer=[]}ondisconnect(){a("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&(a("performing disconnect (%s)",this.nsp),this.packet({type:r.PacketType.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(t){if(!this._anyListeners)return this;if(t){const i=this._anyListeners;for(let e=0;e<i.length;e++)if(t===i[e])return i.splice(e,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}}t.Socket=l},"./node_modules/socket.io-client/build/url.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.url=void 0;const n=i("./node_modules/parseuri/index.js"),r=i("./node_modules/socket.io-client/node_modules/debug/src/browser.js")("socket.io-client:url");t.url=function(e,t){let i=e;return t=t||"undefined"!=typeof location&&location,"string"==typeof(e=null==e?t.protocol+"//"+t.host:e)&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?t.protocol+e:t.host+e),/^(https?|wss?):\/\//.test(e)||(r("protocol-less url %s",e),e=void 0!==t?t.protocol+"//"+e:"https://"+e),r("parse %s",e),i=n(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/",e=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host,i.id=i.protocol+"://"+e+":"+i.port,i.href=i.protocol+"://"+e+(t&&t.port===i.port?"":":"+i.port),i}},"./node_modules/socket.io-client/node_modules/debug/src/browser.js":function(i,n,r){!function(t){n.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),this.useColors){var n="color: "+this.color;e.splice(1,0,n,"color: inherit");let t=0,i=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e&&(i=t))}),e.splice(i,0,n)}},n.save=function(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch(e){}},n.load=function(){let e;try{e=n.storage.getItem("debug")}catch(e){}!e&&void 0!==t&&"env"in t&&(e=t.env.DEBUG);return e},n.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage=function(){try{return localStorage}catch(e){}}(),n.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),i.exports=r("./node_modules/socket.io-client/node_modules/debug/src/common.js")(n);const e=i.exports["formatters"];e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}.call(this,r("./node_modules/process/browser.js"))},"./node_modules/socket.io-client/node_modules/debug/src/common.js":function(e,t,r){e.exports=function(t){function l(e){let a,t=null;function o(...r){if(o.enabled){const s=o;var e=Number(new Date),t=e-(a||e);s.diff=t,s.prev=a,s.curr=e,a=e,r[0]=l.coerce(r[0]),"string"!=typeof r[0]&&r.unshift("%O");let n=0;r[0]=r[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";n++;const i=l.formatters[t];return"function"==typeof i&&(t=r[n],e=i.call(s,t),r.splice(n,1),n--),e}),l.formatArgs.call(s,r);const i=s.log||l.log;i.apply(s,r)}}return o.namespace=e,o.useColors=l.useColors(),o.color=l.selectColor(e),o.extend=i,o.destroy=l.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null===t?l.enabled(e):t,set:e=>{t=e}}),"function"==typeof l.init&&l.init(o),o}function i(e,t){const i=l(this.namespace+(void 0===t?":":t)+e);return i.log=this.log,i}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return((l.debug=l).default=l).coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},l.disable=function(){var e=[...l.names.map(n),...l.skips.map(n).map(e=>"-"+e)].join(",");return l.enable(""),e},l.enable=function(e){l.save(e),l.names=[],l.skips=[];let t;const i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length;for(t=0;t<n;t++)i[t]&&("-"===(e=i[t].replace(/\*/g,".*?"))[0]?l.skips.push(new RegExp("^"+e.substr(1)+"$")):l.names.push(new RegExp("^"+e+"$")))},l.enabled=function(e){if("*"===e[e.length-1])return!0;let t,i;for(t=0,i=l.skips.length;t<i;t++)if(l.skips[t].test(e))return!1;for(t=0,i=l.names.length;t<i;t++)if(l.names[t].test(e))return!0;return!1},l.humanize=r("./node_modules/ms/index.js"),l.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach(e=>{l[e]=t[e]}),l.names=[],l.skips=[],l.formatters={},l.selectColor=function(t){let i=0;for(let e=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return l.colors[Math.abs(i)%l.colors.length]},l.enable(l.load()),l}},"./node_modules/socket.io-parser/dist/binary.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.reconstructPacket=t.deconstructPacket=void 0;const o=i("./node_modules/socket.io-parser/dist/is-binary.js");t.deconstructPacket=function(e){var t=[],i=e.data;const n=e;return n.data=function t(i,n){if(!i)return i;{if(o.isBinary(i)){const e={_placeholder:!0,num:n.length};return n.push(i),e}if(Array.isArray(i)){const r=new Array(i.length);for(let e=0;e<i.length;e++)r[e]=t(i[e],n);return r}if("object"==typeof i&&!(i instanceof Date)){const s={};for(const a in i)i.hasOwnProperty(a)&&(s[a]=t(i[a],n));return s}}return i}(i,t),n.attachments=t.length,{packet:n,buffers:t}},t.reconstructPacket=function(e,t){return e.data=function t(i,n){if(!i)return i;{if(i&&i._placeholder)return n[i.num];if(Array.isArray(i))for(let e=0;e<i.length;e++)i[e]=t(i[e],n);else if("object"==typeof i)for(const e in i)i.hasOwnProperty(e)&&(i[e]=t(i[e],n))}return i}(e.data,t),e.attachments=void 0,e}},"./node_modules/socket.io-parser/dist/index.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Decoder=t.Encoder=t.PacketType=t.protocol=void 0;var o,n=i("./node_modules/component-emitter/index.js");const r=i("./node_modules/socket.io-parser/dist/binary.js"),s=i("./node_modules/socket.io-parser/dist/is-binary.js"),l=i("./node_modules/socket.io-parser/node_modules/debug/src/browser.js")("socket.io-parser");t.protocol=5,(i=o=t.PacketType||(t.PacketType={}))[i.CONNECT=0]="CONNECT",i[i.DISCONNECT=1]="DISCONNECT",i[i.EVENT=2]="EVENT",i[i.ACK=3]="ACK",i[i.CONNECT_ERROR=4]="CONNECT_ERROR",i[i.BINARY_EVENT=5]="BINARY_EVENT",i[i.BINARY_ACK=6]="BINARY_ACK";t.Encoder=class{encode(e){return l("encoding packet %j",e),e.type!==o.EVENT&&e.type!==o.ACK||!s.hasBinary(e)?[this.encodeAsString(e)]:(e.type=e.type===o.EVENT?o.BINARY_EVENT:o.BINARY_ACK,this.encodeAsBinary(e))}encodeAsString(e){let t=""+e.type;return e.type!==o.BINARY_EVENT&&e.type!==o.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data)),l("encoded %j as %s",e,t),t}encodeAsBinary(e){var t=r.deconstructPacket(e),e=this.encodeAsString(t.packet);const i=t.buffers;return i.unshift(e),i}};class h extends n{constructor(){super()}add(e){let t;if("string"==typeof e)t=this.decodeString(e),t.type===o.BINARY_EVENT||t.type===o.BINARY_ACK?(this.reconstructor=new a(t),0===t.attachments&&super.emit("decoded",t)):super.emit("decoded",t);else{if(!s.isBinary(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emit("decoded",t))}}decodeString(e){let t=0;const i={type:Number(e.charAt(0))};if(void 0===o[i.type])throw new Error("unknown packet type "+i.type);if(i.type===o.BINARY_EVENT||i.type===o.BINARY_ACK){for(var n=t+1;"-"!==e.charAt(++t)&&t!=e.length;);n=e.substring(n,t);if(n!=Number(n)||"-"!==e.charAt(t))throw new Error("Illegal attachments");i.attachments=Number(n)}if("/"===e.charAt(t+1)){for(var r=t+1;++t;){if(","===e.charAt(t))break;if(t===e.length)break}i.nsp=e.substring(r,t)}else i.nsp="/";r=e.charAt(t+1);if(""!==r&&Number(r)==r){for(var s=t+1;++t;){var a=e.charAt(t);if(null==a||Number(a)!=a){--t;break}if(t===e.length)break}i.id=Number(e.substring(s,t+1))}if(e.charAt(++t)){s=function(e){try{return JSON.parse(e)}catch(e){return!1}}(e.substr(t));if(!h.isPayloadValid(i.type,s))throw new Error("invalid payload");i.data=s}return l("decoded %s as %j",e,i),i}static isPayloadValid(e,t){switch(e){case o.CONNECT:return"object"==typeof t;case o.DISCONNECT:return void 0===t;case o.CONNECT_ERROR:return"string"==typeof t||"object"==typeof t;case o.EVENT:case o.BINARY_EVENT:return Array.isArray(t)&&0<t.length;case o.ACK:case o.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}t.Decoder=h;class a{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length!==this.reconPack.attachments)return null;e=r.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}},"./node_modules/socket.io-parser/dist/is-binary.js":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasBinary=t.isBinary=void 0;const n="function"==typeof ArrayBuffer,r=Object.prototype.toString,s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===r.call(Blob),a="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===r.call(File);function o(e){return n&&(e instanceof ArrayBuffer||(t=e,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer))||s&&e instanceof Blob||a&&e instanceof File;var t}t.isBinary=o,t.hasBinary=function i(n,e){if(!n||"object"!=typeof n)return!1;if(Array.isArray(n)){for(let e=0,t=n.length;e<t;e++)if(i(n[e]))return!0;return!1}if(o(n))return!0;if(n.toJSON&&"function"==typeof n.toJSON&&1===arguments.length)return i(n.toJSON(),!0);for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)&&i(n[t]))return!0;return!1}},"./node_modules/socket.io-parser/node_modules/debug/src/browser.js":function(i,n,r){!function(t){n.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),this.useColors){var n="color: "+this.color;e.splice(1,0,n,"color: inherit");let t=0,i=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(t++,"%c"===e&&(i=t))}),e.splice(i,0,n)}},n.save=function(e){try{e?n.storage.setItem("debug",e):n.storage.removeItem("debug")}catch(e){}},n.load=function(){let e;try{e=n.storage.getItem("debug")}catch(e){}!e&&void 0!==t&&"env"in t&&(e=t.env.DEBUG);return e},n.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},n.storage=function(){try{return localStorage}catch(e){}}(),n.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),n.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],n.log=console.debug||console.log||(()=>{}),i.exports=r("./node_modules/socket.io-parser/node_modules/debug/src/common.js")(n);const e=i.exports["formatters"];e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}.call(this,r("./node_modules/process/browser.js"))},"./node_modules/socket.io-parser/node_modules/debug/src/common.js":function(e,t,r){e.exports=function(t){function l(e){let a,t=null;function o(...r){if(o.enabled){const s=o;var e=Number(new Date),t=e-(a||e);s.diff=t,s.prev=a,s.curr=e,a=e,r[0]=l.coerce(r[0]),"string"!=typeof r[0]&&r.unshift("%O");let n=0;r[0]=r[0].replace(/%([a-zA-Z%])/g,(e,t)=>{if("%%"===e)return"%";n++;const i=l.formatters[t];return"function"==typeof i&&(t=r[n],e=i.call(s,t),r.splice(n,1),n--),e}),l.formatArgs.call(s,r);const i=s.log||l.log;i.apply(s,r)}}return o.namespace=e,o.useColors=l.useColors(),o.color=l.selectColor(e),o.extend=i,o.destroy=l.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null===t?l.enabled(e):t,set:e=>{t=e}}),"function"==typeof l.init&&l.init(o),o}function i(e,t){const i=l(this.namespace+(void 0===t?":":t)+e);return i.log=this.log,i}function n(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return((l.debug=l).default=l).coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},l.disable=function(){var e=[...l.names.map(n),...l.skips.map(n).map(e=>"-"+e)].join(",");return l.enable(""),e},l.enable=function(e){l.save(e),l.names=[],l.skips=[];let t;const i=("string"==typeof e?e:"").split(/[\s,]+/),n=i.length;for(t=0;t<n;t++)i[t]&&("-"===(e=i[t].replace(/\*/g,".*?"))[0]?l.skips.push(new RegExp("^"+e.substr(1)+"$")):l.names.push(new RegExp("^"+e+"$")))},l.enabled=function(e){if("*"===e[e.length-1])return!0;let t,i;for(t=0,i=l.skips.length;t<i;t++)if(l.skips[t].test(e))return!1;for(t=0,i=l.names.length;t<i;t++)if(l.names[t].test(e))return!0;return!1},l.humanize=r("./node_modules/ms/index.js"),l.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach(e=>{l[e]=t[e]}),l.names=[],l.skips=[],l.formatters={},l.selectColor=function(t){let i=0;for(let e=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e),i|=0;return l.colors[Math.abs(i)%l.colors.length]},l.enable(l.load()),l}},"./node_modules/tslib/tslib.es6.js":function(e,t,i){"use strict";i.r(t),i.d(t,"__extends",function(){return r}),i.d(t,"__assign",function(){return s}),i.d(t,"__rest",function(){return a}),i.d(t,"__decorate",function(){return o}),i.d(t,"__param",function(){return l}),i.d(t,"__metadata",function(){return h}),i.d(t,"__awaiter",function(){return c}),i.d(t,"__generator",function(){return u}),i.d(t,"__exportStar",function(){return f}),i.d(t,"__values",function(){return d}),i.d(t,"__read",function(){return p}),i.d(t,"__spread",function(){return m}),i.d(t,"__spreadArrays",function(){return _}),i.d(t,"__await",function(){return v}),i.d(t,"__asyncGenerator",function(){return g}),i.d(t,"__asyncDelegator",function(){return y}),i.d(t,"__asyncValues",function(){return b}),i.d(t,"__makeTemplateObject",function(){return x}),i.d(t,"__importStar",function(){return S}),i.d(t,"__importDefault",function(){return w}),i.d(t,"__classPrivateFieldGet",function(){return T}),i.d(t,"__classPrivateFieldSet",function(){return M});var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function r(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var s=function(){return(s=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function a(e,t){var i={};for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var n=0,r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]]);return i}function o(e,t,i,n){var r,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var o=e.length-1;0<=o;o--)(r=e[o])&&(a=(s<3?r(a):3<s?r(t,i,a):r(t,i))||a);return 3<s&&a&&Object.defineProperty(t,i,a),a}function l(i,n){return function(e,t){n(e,t,i)}}function h(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function c(e,a,o,l){return new(o=o||Promise)(function(i,t){function n(e){try{s(l.next(e))}catch(e){t(e)}}function r(e){try{s(l.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(n,r)}s((l=l.apply(e,a||[])).next())})}function u(i,n){var r,s,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(a=2&t[0]?s.return:t[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,t[1])).done)return a;switch(s=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,s=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(a=0<(a=o.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){o.label=t[1];break}if(6===t[0]&&o.label<a[1]){o.label=a[1],a=t;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(t);break}a[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(i,o)}catch(e){t=[6,e],s=0}finally{r=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function f(e,t){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}function d(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&n>=e.length?void 0:e)&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,s=i.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(n=s.next()).done;)a.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return a}function m(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}function _(){for(var e=0,t=0,i=arguments.length;t<i;t++)e+=arguments[t].length;for(var n=Array(e),r=0,t=0;t<i;t++)for(var s=arguments[t],a=0,o=s.length;a<o;a++,r++)n[r]=s[a];return n}function v(e){return this instanceof v?(this.v=e,this):new v(e)}function g(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=i.apply(e,t||[]),s=[],a={};return n("next"),n("throw"),n("return"),a[Symbol.asyncIterator]=function(){return this},a;function n(n){r[n]&&(a[n]=function(i){return new Promise(function(e,t){1<s.push([n,i,e,t])||o(n,i)})})}function o(e,t){try{(i=r[e](t)).value instanceof v?Promise.resolve(i.value.v).then(l,h):c(s[0][2],i)}catch(e){c(s[0][3],e)}var i}function l(e){o("next",e)}function h(e){o("throw",e)}function c(e,t){e(t),s.shift(),s.length&&o(s[0][0],s[0][1])}}function y(n){var r,e={};return t("next"),t("throw",function(e){throw e}),t("return"),e[Symbol.iterator]=function(){return this},e;function t(t,i){e[t]=n[t]?function(e){return(r=!r)?{value:v(n[t](e)),done:"return"===t}:i?i(e):e}:i}}function b(a){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,t=a[Symbol.asyncIterator];return t?t.call(a):(a=d(a),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);function i(s){e[s]=a[s]&&function(r){return new Promise(function(e,t){var i,n;r=a[s](r),i=e,e=t,n=r.done,t=r.value,Promise.resolve(t).then(function(e){i({value:e,done:n})},e)})}}}function x(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function S(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t}function w(e){return e&&e.__esModule?e:{default:e}}function T(e,t){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return t.get(e)}function M(e,t,i){if(!t.has(e))throw new TypeError("attempted to set private field on non-instance");return t.set(e,i),i}},"./node_modules/webpack/buildin/global.js":function(e,t){var i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},"./node_modules/yeast/index.js":function(e,t,i){"use strict";var n,r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),s=64,a={},o=0,l=0;function h(e){for(var t="";t=r[e%s]+t,0<(e=Math.floor(e/s)););return t}function c(){var e=h(+new Date);return e!==n?(o=0,n=e):e+"."+h(o++)}for(;l<s;l++)a[r[l]]=l;c.encode=h,c.decode=function(e){var t=0;for(l=0;l<e.length;l++)t=t*s+a[e.charAt(l)];return t},e.exports=c},"./src/game/animations.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Animations",function(){return n});var c=i("./node_modules/playcanvas/build/playcanvas.js"),n=(r.prototype.addInitAnimFallFromSky=function(e,i,n){var r=0;e.forEach(function(e){var t=e.getLocalPosition();null!=n&&e.setLocalPosition(t.x,n,t.z),e.tween(t).to({x:t.x,y:0,z:t.z},2,c.QuinticOut).delay(i+.1*r).start(),r++})},r.prototype.restartInitAnimation=function(e){e&&e.stopPropagation();e=this.app.root.findByTag("turbina");this.addInitAnimFallFromSky(e,1,15),e=this.app.root.findByTag("wturbine"),this.addInitAnimFallFromSky(e,.6,15),e=this.app.root.findByTag("deposito"),this.addInitAnimFallFromSky(e,3,15),e=this.app.root.findByTag("bomba"),this.addInitAnimFallFromSky(e,2,15),e=this.app.root.findByTag("edificio1"),this.addInitAnimFallFromSky(e,2,15),e=this.app.root.findByTag("edificio2"),this.addInitAnimFallFromSky(e,2,15),e=this.app.root.findByTag("che"),this.addInitAnimFallFromSky(e,4,15);var t=this.app.root.findByTag("path");t.forEach(function(e){return e.enabled=!1});var i=this.app.root.findByTag("texto");i.forEach(function(e){return e.enabled=!1});this.app.tween(0).to(1,8,c.Linear).on("complete",function(e){t.forEach(function(e){return e.enabled=!0}),i.forEach(function(e){return e.enabled=!0})}).start(),this.animOrbitCamera()},r.prototype.animOrbitCamera=function(){var t,i,n,e=this.app.root.findByName("orbitCamera");e.enabled&&e.script&&(t=e.script.orbitCamera,this.cameras.resetOrbitCamera(-116.56,0,23.52),i=new c.Color(0,0,0),n=0,(e=this.app.tween(i).to(new c.Color(1,0,0),6,c.SineInOut)).on("update",function(e){t.yaw-=(i.r-n)*e*17e3,t.pitch-=4*e,t.distance-=2*e,n=i.r}).on("complete",function(){console.log(t.yaw,t.pitch,t.distance)}),e.start())},r.prototype.animObject=function(e,t){var i,n,r,s,a,o,l,h=this;"jump"==t&&(e.setLocalEulerAngles(0,0,0),i=e.getLocalPosition().clone(),(o=e.getLocalPosition().clone()).y+=1,a=e.getLocalScale().clone(),(s=e.getLocalScale().clone()).y-=.2,l=c,r=(n=e).tween(e.getLocalScale()).to(s,.4,l.QuadraticOut).on("complete",function(){h.entities.playSound("jump")}),t=n.tween(e.getLocalScale()).to(a,.03,l.QuinticOut),s=n.tween(e.getLocalPosition()).to(o,.6,l.QuinticOut).on("complete",function(){h.entities.playSound("chop")}),a=n.tween(e.getLocalEulerAngles()).rotate({x:0,y:180,z:0},.2,l.QuinticIn),o=n.tween(e.getLocalEulerAngles()).rotate({x:0,y:360,z:0},.2,l.QuinticOut),l=n.tween(e.getLocalPosition()).to(i,.6,l.BounceOut),r.start().chain(t,s,a,o,l).on("complete",function(){e.animar=!1}))},r);function r(e){this.app=e}},"./src/game/app.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"App",function(){return D});var n=i("./src/game/entities.ts"),r=i("./src/game/multiplayer.ts"),s=i("./src/game/lights.ts"),a=i("./src/game/shaders.ts"),o=i("./src/game/xr.ts"),l=i("./src/game/cameras.ts"),h=i("./src/game/paths.ts"),c=i("./src/game/animations.ts"),u=i("./node_modules/playcanvas/build/playcanvas.js"),f=i("./src/game/assets-loader.ts"),d="\n    attribute vec3 aPosition;\n    attribute vec2 aUv0;\n\n    uniform mat4 matrix_model;\n    uniform mat4 matrix_viewProjection;\n\n    varying vec2 vUv0;\n\n    void main(void)\n    {\n        vUv0 = aUv0;\n        gl_Position = matrix_viewProjection * matrix_model * vec4(aPosition, 1.0);\n    }\n",p="\n//Albedo\nprecision mediump float;\nvarying vec2 vUv0;\nuniform float uTime;\nuniform vec4 dashColor;\nuniform vec4 bgColor;\n\nvoid main(void)\n{\n    vec2 xy = vUv0;//fragCoord.xy; //We obtain our coordinates for the current pixel\n    bool sup = xy.y >= 0.5; //Cuadrante superior para rectas, inferior para curvas\n    bool left = xy.x <= 0.5; //Giro Izq o Derecha\n    vec4 retColor = vec4(0.0, 0.0, 0.0, 0.0); //This is actually transparent\n    bool sameColor = dashColor == bgColor;\n    vec2 grosorDash =vec2(0.40,0.60);\n    \n    if(sup){\n        xy.y = (xy.y - 0.5) * 2.0; //volvemos rango 0 -> 1\n        if(  xy.y > grosorDash.x && xy.y < grosorDash.y &&\n            (\n                xy.x > fract( uTime) \n                && \n                ( fract( uTime) > 0.5 || xy.x < fract( 0.5 + uTime))\n                ||\n                (  xy.x < fract( uTime +0.5)  && fract(uTime) > 0.5 )\n            )\n          )\n        {\n            retColor = dashColor; \n        }else \tif( xy.y > 0.2 && xy.y < 0.8){\n            retColor = bgColor;\n        }\n        gl_FragColor = retColor;\t\t\t\n    }else{\n        xy.y = xy.y  * 2.0; //volvemos rango 0 -> 1\n        xy.x = left ? xy.x * 2.0 : (xy.x - 0.5) * 2.0; //volvemos rango 0 -> 1\n        float len = length(xy);\n        float ang = degrees(atan(xy.x, xy.y))/90.0;\n        ang = left ? ang : (1.0 - ang); //Invertimos para girar en la otra direccin\n        if( (  ang > fract( uTime) \n                && \n                ( fract( uTime) > 0.5 || ang < fract( 0.5 + uTime))\n                ||\n                (  ang < fract( uTime +0.5)  && fract(uTime) > 0.5 )\n            )\n            && len < grosorDash.y && len > grosorDash.x){\n            retColor = dashColor; //vec4(1.0, 1.0, 0.0,1.0);\n        }else \tif( len < 0.8 && len > 0.2){\n            retColor = bgColor; // vec4(0.9, 0.9, 0.7,1.0);\n        }\n        \n        gl_FragColor = retColor;\t\t\t\n    }\n}\n",m="#454649",_="#9b5e02",t="#FFB33F",v="#144377",g="#4186D3",i="#4186D3",y={ground:(new u.Color).fromString(m),energy:(new u.Color).fromString(_),energyDash:(new u.Color).fromString(t),bombWater:(new u.Color).fromString(v),water:(new u.Color).fromString(g),waterDash:(new u.Color).fromString(i)};function b(e){return[e.r,e.g,e.b,e.a]}var x={ground:b(y.ground),energy:b(y.energy),energyDash:b(y.energyDash),water:b(y.water),waterDash:b(y.waterDash),bgColor:[.6,.6,.1,.04]},S=new u.Vec3(-1,0,0),w=new u.Vec3(5,0,1),T=new u.Vec3(7.5,0,3.6),M=new u.Vec3(5,0,3.4),C=new u.Vec3(8.3,0,0),A=new u.Vec3(-.2,0,5),P=new u.Vec3(3.5,0,5),E=(new u.Vec3(5,0,-.5),(new u.Color).fromString(t),(new u.Color).fromString(i)),I=[.9,.9,1,.02],R=[{speed1:0,speed2:120,rotInst:0,x:0+S.x,y:S.y,z:S.z,scale:1,rx:0,ry:0,rz:0,id:"wturbine1",bbox:new u.Vec3(.1,2,.1),animar:!1},{speed1:20,speed2:80,x:1+S.x,y:S.y,z:S.z-.2,scale:1,rx:0,ry:90,rz:0,id:"wturbine2",bbox:new u.Vec3(.1,2,.1),animar:!1},{speed1:0,speed2:10,x:2+S.x,y:S.y,z:S.z-.3,scale:1,rx:0,ry:45,rz:0,id:"wturbine3",bbox:new u.Vec3(.1,2,.1),animar:!1},{speed1:0,speed2:60,x:3+S.x,y:S.y,z:S.z-.2,scale:1,rx:0,ry:45,rz:0,id:"wturbine4",bbox:new u.Vec3(.1,2,.1),animar:!1},{speed1:30,speed2:240,x:4+S.x,y:S.y,z:S.z,scale:1,rx:0,ry:45,rz:0,id:"wturbine5",bbox:new u.Vec3(.1,2,.1),animar:!1}],L=[{id:"teol",texto:"PARQUE EOLICO",pos:new u.Vec3(S.x+2,.001,S.z+.35),fontSize:.2},{id:"tbombas",texto:"BOMBAS",pos:new u.Vec3(T.x+.5,.001,T.z-2.4),fontSize:.2},{id:"tturbinas",texto:"TURBINAS",pos:new u.Vec3(w.x,.001,w.z-.65),fontSize:.2},{id:"tscale",texto:"",pos:new u.Vec3(-1.5,.001,.75),fontSize:.15}],D=(Object.defineProperty(k.prototype,"App",{get:function(){return this.app},enumerable:!1,configurable:!0}),k.prototype.Awake=function(){var e=this;this.initApp(),f.AssetsLoader.loadAssets(this.app,function(){return e.assetsLoaded()})},k.prototype.initApp=function(){var e=this;this.canvas=this.createCanvas(),this.app=new u.Application(this.canvas,{mouse:new u.Mouse(this.canvas),touch:new u.TouchDevice(this.canvas),keyboard:new u.Keyboard(window)}),this.app.addTweenManager(),this.animations=new c.Animations(this.app),this.entities=new n.Entities(this.app,this.multiplayer,this.animations),this.animations.entities=this.entities,this.multiplayer=new r.Multiplayer(this.app,this.entities),this.entities.multiplayer=this.multiplayer,this.cameras=new l.Cameras(this,this.entities),this.animations.cameras=this.cameras,this.entities.setCameras(this.cameras),this.shaders=new a.Shaders(this.app),this.xr=new o.XR(this.app,this.entities,this.multiplayer,this.cameras,this.shaders),this.entities.xr=this.xr,this.paths=new h.Paths(this.app),this.app.start(),this.app.setCanvasFillMode(u.FILLMODE_FILL_WINDOW),this.app.setCanvasResolution(u.RESOLUTION_AUTO),window.addEventListener("resize",function(){e.app.resizeCanvas(e.canvas.width,e.canvas.height)}),console.log("-----\x3e APP INITIALIZED")},k.prototype.assetsLoaded=function(){console.log("ASSETS LOADED"),s.Lights.addAmbientLight(this.app),s.Lights.createSimpleDirectionalShadowLight(this.app,!0),this.crearCHE(),s.Lights.addSkyBox(this.app,0,"background");var e=this.entities.createGround((new u.Color).fromString(m));this.app.root.addChild(e),this.entities.createIntersectPoint(),this.entities.createIntersectPointB(),this.entities.addSoundEntity(e,"click","ui_select"),this.entities.addSoundEntity(e,"jump","jump"),this.entities.addSoundEntity(e,"chop","chop");var t=this.entities.addEntity("wturbine",R);this.crearTurbinas(w,"#333333",_),this.crearBombas(T,"#333333",v),this.crearEdificios(A,P,"#111213","#111213"),this.crearTextosSuelo(L,new u.Color(.9,.9,.9)),this.crearDepositos(M,C,g),this.createPathsAndTexts(),this.entities.updatePathsState(),this.entities.orbitCamera=this.cameras.createOrbitCamera(e,e,!0),this.entities.createInfoBox(t[0],!1),this.sceneReparentAll(),this.multiplayer.init(),this.xr.addSuportXR(),this.entities.addButtons(this.app.root.findByName("sceneParent"),y.ground)},k.prototype.crearCHE=function(){var e=new u.Vec3(5,0,-.5);return this.entities.addEntity("che",[{speed1:0,speed2:0,x:e.x,y:e.y,z:e.z,scale:1,rx:0,ry:0,rz:0,id:"che",bbox:new u.Vec3(.8,.65,.2),animar:!1,animationName:"jump",animSound:"jump"}])},k.prototype.createCanvas=function(){var e=document.createElement("canvas");return e.setAttribute("width","500px"),e.setAttribute("height","500px"),document.body.appendChild(e),e},k.prototype.crearTurbinas=function(e,t,i){var n=new u.Vec3(.3,.48,.24),r=e.y,s=e.x-1.1,e=e.z+.8;return this.entities.addEntity("turbina",[{speed1:0,speed2:80,rotInst:5,x:s,y:r,z:e,scale:.6,rx:0,ry:0,rz:0,id:"turbina1",bbox:n,cmesh:"paletas",color:t,animColor:i,animMesh:"paletas",animar:!1},{speed1:0,speed2:80,rotInst:5,x:.7+s,y:r,z:e,scale:.6,rx:0,ry:90,rz:0,id:"turbina2",bbox:n,cmesh:"paletas",color:t,animColor:i,animMesh:"paletas",animar:!1},{speed1:0,speed2:80,rotInst:5,x:1.4+s,y:r,z:e,scale:.6,rx:0,ry:45,rz:0,id:"turbina3",bbox:n,cmesh:"paletas",color:t,animColor:i,animMesh:"paletas",animar:!1},{speed1:0,speed2:80,rotInst:5,x:s+.7*3,y:r,z:e,scale:.6,rx:0,ry:45,rz:0,id:"turbina4",bbox:n,cmesh:"paletas",color:t,animColor:i,animMesh:"paletas",animar:!1}])},k.prototype.crearBombas=function(e,t,i){var n=e.z-.1,r=new u.Vec3(.3,.45,.08),s=new u.Vec3(.3,.4,.08),i=this.entities.addEntity("bomba",[{speed1:0,speed2:80,x:8,y:e.y,z:n-.18*10,scale:.23,rx:0,ry:0,rz:0,id:"bombaBV1",bbox:r,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:n-1.26,scale:.2,rx:0,ry:0,rz:0,id:"bomba1",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:n-.72,scale:.2,rx:0,ry:0,rz:0,id:"bomba2",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:n-.18,scale:.2,rx:0,ry:0,rz:0,id:"bomba3",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:.54+n,scale:.2,rx:0,ry:0,rz:0,id:"bomba4",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:1.08+n,scale:.2,rx:0,ry:0,rz:0,id:"bomba5",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8.3,y:e.y,z:n+.18*9,scale:.2,rx:0,ry:0,rz:0,id:"bomba6",bbox:s,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1},{speed1:0,speed2:80,x:8,y:e.y,z:2.16+n,scale:.23,rx:0,ry:0,rz:0,id:"bombaBV2",bbox:r,cmesh:"interiorBomba",color:t,animColor:i,animMesh:"interiorBomba",animar:!1}]);return i.forEach(function(e){e.model&&(e.model.receiveShadows=!1)}),i},k.prototype.crearEdificios=function(e,t,i,n){i=this.entities.addEntity("edificio1",[{speed1:0,speed2:0,x:e.x,y:e.y,z:e.z,scale:.5,rx:0,ry:0,rz:0,id:"edificio1",bbox:new u.Vec3(1,.75,.47),cmesh:"roof",color:i,animColor:i,animMesh:"roof",animar:!1}]),n=this.entities.addEntity("edificio2",[{speed1:0,speed2:0,x:t.x,y:t.y,z:t.z,scale:.5,rx:0,ry:0,rz:0,id:"edificio2",bbox:new u.Vec3(1,.8,.45),cmesh:"tejado",color:n,animColor:n,animMesh:"tejado",animar:!1}]);return[i[0],n[0]]},k.prototype.createPathsAndTexts=function(){this.generateEnergyPaths(w,S,T,A,P),this.generateTurbinasPath(w,M,C,!0),this.generateTurbinasPath(w,M,C,!1),this.generateBombasPath(T,M,C,!0),this.generateBombasPath(T,M,C,!1),this.crearTextosSuelo(L,new u.Color(.9,.9,.9))},k.prototype.sceneReparentAll=function(){var t=this.app.root.findByName("sceneParent");t||(t=new u.Entity("sceneParent"),this.app.root.addChild(t),this.app.root.findByTag("scalable").forEach(function(e){e.reparent(t)}))},k.prototype.crearTextosSuelo=function(e,t){var i=this.app.assets.find("font");this.crearTextosSuelosConAssets(i,L,t)},k.prototype.crearTextosSuelosConAssets=function(r,e,s){var a=this;e.forEach(function(e,t,i){var n=new u.Entity(e.id);n.addComponent("element",{anchor:[.5,.5,.5,.5],autoWidth:!0,autoHeigth:!0,fontSize:e.fontSize,color:s,Alignment:[0,1],pivot:[.5,.5],text:e.texto,type:u.ELEMENTTYPE_TEXT}),n.element&&(n.element.fontAsset=r.id,n.tags.add("texto"),n.tags.add("scalable"),n.setLocalPosition(e.pos.x,e.pos.y,e.pos.z),n.setLocalEulerAngles(-90,0,0),a.app.root.addChild(n))})},k.prototype.crearDepositos=function(e,t,i){var n=this,r=this.app.assets.find("cube"),s=this.entities.createBoxTransparent(r,{id:"depositoInf",tag:["deposito","scalable"],color:i,animar:!1,percent:100,animarDesde:100,x:e.x,y:e.y,z:e.z,scale:.6});this.app.root.addChild(s),this.percentDeposito(s,100,.6);var a=this.entities.createBoxTransparent(r,{id:"depositoSup",tag:["deposito","scalable"],color:i,animar:!1,percent:100,animarDesde:100,x:t.x,y:e.y,z:t.z,scale:.9});return this.app.root.addChild(a),this.percentDeposito(a,100,.9),this.app.on("update",function(e){var t;s.animar&&(s.dato.percent=100*Math.random(),s.animar=!1),s.dato.percent&&s.dato.animarDesde&&(t=s.dato.percent-s.dato.animarDesde,1<Math.abs(t)&&(s.dato.animarDesde+=.3*Math.sign(t),n.percentDeposito(s,s.dato.animarDesde,.6))),a.animar&&(a.dato.percent=100*Math.random(),a.animar=!1),a.dato.percent&&a.dato.animarDesde&&(t=a.dato.percent-a.dato.animarDesde,1<Math.abs(t)&&(a.dato.animarDesde+=.3*Math.sign(t),n.percentDeposito(a,a.dato.animarDesde,.9)))}),[s,a]},k.prototype.percentDeposito=function(e,t,i){e.setLocalScale(+i,.5*i*t/100,.15*i)},k.prototype.generateEnergyPaths=function(e,t,i,n,r){console.log("generateEnergyPaths");e.z;i=this.paths.pathGeneration({id:"TC2_BOMBAS",type:"path",dir:-90,path:[{type:"L",num:3},{type:"G",turn:"right"},{type:"L",num:(i.x-n.x)/.18}],scale:.18});i.setPosition(n.x,0,n.z-.2),console.log("path  model",i.model),i.model&&(console.log("path with model"),this.addShaderMaterialModelEnergy(i,i.model.model,d,p)),(i=this.paths.pathGeneration({id:"TC1",type:"path",dir:180,path:[{type:"L",num:(r.x-n.x)/.18}],scale:.18})).setPosition(r.x,0,r.z+.2),i.model&&this.addShaderMaterialModelEnergy(i,i.model.model,d,p),(i=this.paths.pathGeneration({id:"TC2",type:"path",dir:0,path:[{type:"L",num:(r.x-n.x)/.18}],scale:.18})).setPosition(n.x,0,n.z-.2),i.model&&this.addShaderMaterialModelEnergy(i,i.model.model,d,p),(i=this.paths.pathGeneration({id:"TURBINAS_TC",type:"path",dir:180,path:[{type:"L",num:(e.x-n.x-1)/.18},{type:"G",turn:"left"},{type:"L",num:(n.z-e.z-1)/.18}],scale:.18})).setPosition(e.x-1.5,0,e.z+.7),i.model&&this.addShaderMaterialModelEnergy(i,i.model.model,d,p),(i=this.paths.pathGeneration({id:"MOLINOS_TC",type:"path",dir:90,path:[{type:"L",num:(n.z-t.z)/.18}],scale:.18})).setPosition(t.x,0,t.z+.2),i.model&&this.addShaderMaterialModelEnergy(i,i.model.model,d,p)},k.prototype.getShadderPath=function(e){return e?"\n    precision mediump float;\n    varying vec2 vUv0;\n    uniform float uTime;\n    uniform vec4 dashColor;\n    uniform vec4 bgColor;\n\n    void main(void)\n    {\n        vec2 xy = vUv0;//fragCoord.xy; //We obtain our coordinates for the current pixel\n        bool sup = xy.y >= 0.5; //Cuadrante superior para rectas, inferior para curvas\n        bool left = xy.x <= 0.5; //Giro Izq o Derecha\n        vec4 solidRed = vec4(0.2, 0.4, 0.2,0.0); //This is actually black right now\n        bool sameColor = dashColor == bgColor;\n        if(sup){\n            xy.y = (xy.y - 0.5) * 2.0; //Para volver al rango 0 -> 1\n            if( xy.y > 0.2 && xy.y < 0.8){\n                solidRed = bgColor; // vec4(0.9, 0.9, 0.7,1.0);\n            }\n            gl_FragColor = solidRed;\t\t\t\n        }else{\n            xy.y = xy.y  * 2.0; //Para volver al rango 0 -> 1\n            xy.x = left ? xy.x * 2.0 : (xy.x - 0.5) * 2.0; //Para volver al rango 0 -> 1\n            float len = length(xy);\n            float ang = degrees(atan(xy.x, xy.y))/90.0;\n            ang = left ? ang : (1.0 - ang); //Invertimos para girar en la otra direccin\n            if( len < 0.8 && len > 0.2){\n                solidRed = bgColor; // vec4(0.9, 0.9, 0.7,1.0);\n            }\n            gl_FragColor = solidRed;\t\t\t\n        }\n    }\n":p},k.prototype.addShaderMaterialModelWaterStatic=function(e,t,i,n,r){var n=this.createShader(i,n),s=this.createUTimeMaterial(n);s.setParameter("bgColor",I),s.setParameter("dashColor",I),s.setParameter("uTime",0),s.depthWrite=!1,t.meshInstances.forEach(function(e){e.material=s})},k.prototype.addShaderMaterialModelWater=function(e,t,i,n,r){var s=this,n=this.createShader(i,n),a=this.createUTimeMaterial(n);a.setParameter("bgColor",I),a.depthWrite=!1;var o=0;t.meshInstances.forEach(function(e){e.material=a});var l=e;this.app.on("update",function(e){l.animar?(o+=s.dashSpeed*e,e=r?1-o%1:o%1,a.setParameter("uTime",e),a.setParameter("dashColor",[E.r,E.g,E.b,E.a])):a.setParameter("dashColor",I)})},k.prototype.generateTurbinasPath=function(e,t,i,n){var r=n?0:.001,s=n?"P":"",a=this.paths.pathGeneration({id:"pTurbinasina1"+s,type:"path",dir:180,path:[{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:6}],scale:.18});a.setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pTurbinasina2"+s,type:"path",dir:180,path:[{type:"L",num:2},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:2}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pTurbinasina3"+s,type:"path",dir:0,path:[{type:"L",num:1},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:1}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pTurbinasina4"+s,type:"path",dir:0,path:[{type:"L",num:5},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:5}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"depSup_turbinas"+s,type:"path",dir:-90,path:[{type:"L",num:1},{type:"G",turn:"right"},{type:"L",num:(i.x-e.x)/.18},{type:"G",turn:"left"},{type:"L",num:(e.z-i.z-.36)/.18}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n),!0),r+=0,(a=this.paths.pathGeneration({id:"turbinas_dep2"+s,type:"path",dir:90,path:[{type:"L",num:(t.z-e.z-1.08)/.18}],scale:.18})).setPosition(e.x,r,e.z+1.26),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n),!1)},k.prototype.generateBombasPath=function(e,t,i,n){var r=n?0:.001,s=n?"P":"",a=this.paths.pathGeneration({id:"depInf_bombas"+s,type:"path",dir:90,path:[{type:"L",num:2},{type:"G",turn:"left"},{type:"L",num:(e.x-t.x)/.18}],scale:.18});a.setPosition(t.x,r,t.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"bombas_depSup"+s,type:"path",dir:0,path:[{type:"L",num:1},{type:"G",turn:"left"},{type:"L",num:(e.z-i.z)/.18}],scale:.18})).setPosition(e.x+1.26,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbombaBV1"+s,type:"path",dir:-90,path:[{type:"L",num:10},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:10}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba1"+s,type:"path",dir:-90,path:[{type:"L",num:7},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:7}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba2"+s,type:"path",dir:-90,path:[{type:"L",num:4},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:4}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba3"+s,type:"path",dir:-90,path:[{type:"L",num:1},{type:"G",turn:"right"},{type:"L",num:6},{type:"G",turn:"right"},{type:"L",num:1}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba4"+s,type:"path",dir:90,path:[{type:"L",num:2},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:2}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba5"+s,type:"path",dir:90,path:[{type:"L",num:5},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:5}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbomba6"+s,type:"path",dir:90,path:[{type:"L",num:8},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:8}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n)),r+=0,(a=this.paths.pathGeneration({id:"pbombaBV2"+s,type:"path",dir:90,path:[{type:"L",num:11},{type:"G",turn:"left"},{type:"L",num:6},{type:"G",turn:"left"},{type:"L",num:11}],scale:.18})).setPosition(e.x,r,e.z),a.model&&this.addShaderMaterialModelWater(a,a.model.model,d,this.getShadderPath(n))},k.prototype.addShaderMaterialModelEnergy=function(e,t,i,n){var r=this;console.log("addShaderMaterialModelEnergy");var n=this.createShader(i,n),s=this.createUTimeMaterial(n);s.setParameter("bgColor",x.bgColor);var a=0;t.meshInstances.forEach(function(e){e.material=s,e.castShadow=!1,e.depthWrite=!1});var o=e;this.app.on("update",function(e){o.animar?(e=(a+=r.dashSpeed*e)%1,s.setParameter("uTime",e),s.setParameter("dashColor",x.energyDash)):s.setParameter("dashColor",x.bgColor)})},k.prototype.createShader=function(e,t){var i=this.app.graphicsDevice;i.setBlending(!0);t={attributes:{aPosition:u.SEMANTIC_POSITION,aUv0:u.SEMANTIC_TEXCOORD0},vshader:e,fshader:t};return new u.Shader(i,t)},k.prototype.createUTimeMaterial=function(e){var t=new u.Material;return t.shader=e,t.depthWrite=!1,t.blendType=u.BLEND_NORMAL,t.setParameter("uTime",0),t},k);function k(){this._lastTimestamp=0,this.entidades=[],this.frameCount=0,this.dashSpeed=1}},"./src/game/assets-loader.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"AssetsLoader",function(){return n});var a=i("./node_modules/playcanvas/build/playcanvas.js"),o=i("./src/game/helpers.ts"),l=[{id:"che",type:"container",url:"./objects/che.glb",tag:"init"},{id:"jump",type:"audio",url:"./objects/jump.mp3",tag:"init"},{id:"chop",type:"audio",url:"./objects/chop.mp3",tag:"init"},{id:"ui_select",type:"audio",url:"./objects/ui_select.mp3",tag:"init"},{id:"orbitCamera",type:"script",url:"./cameras/orbit-camera.js",tag:"init"},{id:"background",type:"cubemap",url:"./images/helipad.dds",tag:"init",options:{type:a.TEXTURETYPE_RGBM}},{id:"wturbine",type:"container",url:"./objects/windTurbine.glb",tag:"init"},{id:"bomba",type:"container",url:"./objects/bomba.glb",tag:"init"},{id:"turbina",type:"container",url:"./objects/turbina.glb",tag:"init"},{id:"edificio1",type:"container",url:"./objects/edificio1.glb",tag:"init"},{id:"edificio2",type:"container",url:"./objects/edificio2.glb",tag:"init"},{id:"avatar",type:"container",url:"./objects/avatar.glb",tag:"init"},{id:"font",type:"font",url:"./fonts/arial.json",tag:"init"},{id:"panel",type:"texture",url:"./images/panel.png",tag:"init"},{id:"panel2",type:"texture",url:"./images/panel2.png",tag:"init"},{id:"bilboard",type:"script",url:"./cameras/billboard.js",tag:"init"},{id:"cube",type:"container",url:"./objects/cube.glb",tag:"init"}],n=(r.loadAssets=function(i,e){console.log("loading Assets"),l.forEach(function(e){var t=new a.Asset(e.id,e.type,{url:Object(o.getAssetPath)(e.url)},e.options);t.tags.add(e.tag.split(" ")),t.tags.add(e.id),i.assets.add(t)});for(var t=i.assets.findByTag("init"),n=0,r=t.length,s=0;s<t.length;s++)t[s].ready(function(){(n+=1)===r&&e()}),i.assets.load(t[s]);t.length||e()},r);function r(){}},"./src/game/cameras.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Cameras",function(){return n});var r=i("./src/game/entity.ts"),n=(s.prototype.createOrbitCamera=function(e,t,i){var n=new r.Entity("orbitCamera");return n.tags.add("camera"),n.addComponent("camera",{clearColor:new pc.Color(.4,.45,.5)}),n.enabled=i,n.addComponent("script"),n.script&&(console.log("--\x3ecreateOrbitCAmera script"),this.orbitCameraS=n.script.create("orbitCamera",{attributes:{inertiaFactor:.2,focusEntity:e,defaultEntity:t,entities:this.entities,cameras:this}}),this.orbitCameraSM=n.script.create("orbitCameraInputMouse",{attributes:{app:this.app}}),this.orbitCameraST=n.script.create("orbitCameraInputTouch",{attributes:{app:this.app}}),console.log("cameraScript",n.script)),this.app.app.root.addChild(n),n},s.prototype.resetOrbitCamera=function(e,t,i){var n=this.app.app.root.findByName("ground"),r=null===(r=this.app.app.root.findByName("orbitCamera").script)||void 0===r?void 0:r.get("orbitCamera");r.pivotPoint=n.getLocalPosition().clone(),r.yaw=e||5.22,r.pitch=t||-38.5,r.distance=i||11.76},s);function s(e,t){this.enableOrbitChange=!1,this.app=e,this.entities=t}},"./src/game/entities.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Entities",function(){return n});var l=i("./node_modules/playcanvas/build/playcanvas.js"),h=i("./src/game/entity.ts"),n=(r.prototype.setCameras=function(e){console.log("setCameras",e),this.cameras=e},r.prototype.addEntity=function(e,t){var s=this,a=this.app.assets.find(e),o=[];return t.forEach(function(i){var e,n=new h.Entity(i.id);if(n.addComponent("model",{type:"asset",asset:a.resource.model,castShadows:!0}),n.tags.add(a.tags.list()),n.tags.add(i.id),n.tags.add("scalable"),n.setLocalScale(i.scale,i.scale,i.scale),n.setLocalPosition(i.x,i.y,i.z),console.log(i.id," meshed: ",null===(e=n.model)||void 0===e?void 0:e.model.meshInstances[0].node.name),o.push(n),n.dato=i,n.id=i.id,n.animar=i.animar,n.animationName=i.animationName,n.animSound=i.animSound,n.acfactor=0,n.addComponent("collision",{type:"box",halfExtents:i.bbox}),s.app.root.addChild(n),i.cmesh&&i.color){var t=(new l.Color).fromString(i.animar?i.animColor:i.color);if(null!==(e=n.model)&&void 0!==e&&e.meshInstances.length)for(var r=0;r<n.model.meshInstances.length;r++)n.model.meshInstances[r].node.name==i.cmesh&&n.model.meshInstances[r].setParameter("material_diffuse",[t.r,t.g,t.b])}s.app.on("update",function(e){var t;n&&(n.animar||0<n.acfactor)&&(n.acfactor=n.animar?Math.min(1,n.acfactor+.005):Math.max(0,n.acfactor-.005),n.rotate(0,i.speed1*e*n.acfactor,0),null===(t=null===(t=n.model)||void 0===t?void 0:t.model)||void 0===t||!t.meshInstances||(t=n.model.model.meshInstances[i.rotInst||0])&&i.speed2&&t.node.rotateLocal(0,e*i.speed2*n.acfactor,0))})}),o},r.prototype.createGround=function(e){var t=new l.Vec3(6,.11,4),i=new h.Entity("ground");i.addComponent("model",{type:"box",castShadows:!1}),i.name="ground",i.tags.add("init"),i.tags.add("scalable"),i.addComponent("rigidbody",{type:"static",restitution:.5}),i.addComponent("collision",{type:"box",halfExtents:t}),i.setLocalScale(12,.22,8),i.setLocalPosition(4,-.11,2),i.dato={bbox:t};e=this.createMaterial(e,e);return i.model&&(i.model.material=e),i},r.prototype.createMaterial=function(e,t,i,n){var r=new l.StandardMaterial;return r.diffuse=t,r.ambient=e,n&&(r.opacity=n),i&&(r.blendType=l.BLEND_ADDITIVE),r.update(),r},r.prototype.animate=function(e,t){console.log("animate called with name and value: ",e,t),"sceneParent"!=e&&"all"!=e&&"animAll"!=e&&"animAll"!=t||this.animations.restartInitAnimation(),"che"!=e||(t=this.app.root.findByName("che"))&&this.activateEntity(t,!1),"turbines"==e&&this.stopStartEntities("wturbine",!0),"close"==e&&(this.xr.xrpanel.enabled=!1)},r.prototype.stopStartEntities=function(e,t,i){this.app.root.findByTag(e).forEach(function(e){(!t||.5<Math.random())&&(e.animar=!e.animar)}),i&&i.stopPropagation()},r.prototype.execSelectEntity=function(e,t){console.log("execSelectEntity",e.name,e.tags.has("button"),e.callFunc,e.callVal),e.tags.has("button")?!t&&e.callFunc&&e.callVal&&(console.log("button select:",e.callFunc,e.callVal),"reescalar"==e.callFunc?this.reescalar(e.callVal,t):"teletransport"==e.callFunc?this.teletransport(e.callVal):"anim"==e.callFunc&&(this.animate(e.callVal),this.multiplayer.objectAction(e.callVal,e.callFunc))):e&&this.selEntityName!=e.name?(this.selEntityName=e.name,console.log("call createInfoBox from execSelectEntity"),this.createInfoBox(e,"ground"==e.name),this.lastTimeSelected=(new Date).getTime()):(new Date).getTime()-this.lastTimeSelected<400?this.lastTimeSelected=0:this.lastTimeSelected=(new Date).getTime(),this.playSound("click")},r.prototype.selectEntity=function(e,t){console.log("ETT selectEntity"),this.execSelectEntity(e,!1),this.multiplayer.selectEntity(e)},r.prototype.activateEntity=function(e,t){e.tags.has("button")?this.selectEntity(e,!1):(e.animar=!e.animar,t&&(e.animationName?this.multiplayer.objectAction(e.name,e.animationName):this.multiplayer.objectState(e.name,e.animar)),this.updatePathsState(),"ground"!=e.name&&this.updateColors(e),console.log("activateEntity:",e),e.animar&&e.animationName?(console.log("call animation: ",e.id,e.animationName),this.animations.animObject(e,e.animationName),e.animSound||this.playSound("click")):this.playSound("click"))},r.prototype.getActiveNoActiveGroup=function(e){var t=!1;return e.forEach(function(e){return t=t||e.animar}),t},r.prototype.updatePathsState=function(){var i=this,e=this.app.root.findByTag("wturbine");this.app.root.findByName("MOLINOS_TC").animar=this.getActiveNoActiveGroup(e);var t=this.app.root.findByTag("turbina"),n=this.app.root.findByName("TURBINAS_TC"),r=this.app.root.findByName("depSup_turbinas"),s=this.app.root.findByName("turbinas_dep2"),e=this.getActiveNoActiveGroup(t);n.animar=e,r.animar=e,s.animar=e,t.forEach(function(e){i.app.root.findByName("pTurbinasina"+e.name.slice(-1)).animar=e.animar});n=this.app.root.findByTag("bomba"),r=this.app.root.findByName("TC2_BOMBAS"),s=this.app.root.findByName("depInf_bombas"),e=this.app.root.findByName("bombas_depSup"),t=this.getActiveNoActiveGroup(n);r.animar=t,s.animar=t,e.animar=t,n.forEach(function(e){var t=i.app.root.findByName("p"+e.name);t&&(t.animar=e.animar)}),this.app.root.findByName("TC1").animar=this.app.root.findByName("edificio1").animar,this.app.root.findByName("TC2").animar=this.app.root.findByName("edificio2").animar},r.prototype.updateColors=function(e){if(e.dato&&e.dato.animMesh&&e.model)for(var t,i=0;i<(null===(t=e.model)||void 0===t?void 0:t.meshInstances.length);i++)e.dato.animMesh==(null===(t=e.model)||void 0===t?void 0:t.meshInstances[i].node.name)&&(t=(e.animar?e.dato.animColor:e.dato.color)||"#eeaa00",t=(new l.Color).fromString(t),e.model.meshInstances[i].setParameter("material_diffuse",[t.r,t.g,t.b]))},r.prototype.playSound=function(e){var t;null!==(t=this.app.root.findByName("ground").sound)&&void 0!==t&&t.play(e)},r.prototype.addSoundEntity=function(e,t,i){e.addComponent("sound");i=this.app.assets.find(i);null!==(e=e.sound)&&void 0!==e&&e.addSlot(t,{asset:i.id,pitch:1.7,loop:!1,autoPlay:!1})},r.prototype.createInfoBox=function(e,t){var i=new l.BoundingBox;this.buildAabb(e,i,0);var n,r=i.halfExtents.clone();null==this.titleBox&&(console.log("createInfoBox titleBox"),n={id:"cbox",scale:new l.Vec3(.8,.2,.02),x:0,y:0,z:0,color:"#FF4040",tag:"bbox"},this.titleBox=new l.Entity("titleBoxBase"),n=this.createContentBox(n),this.titleBox.addChild(n),this.app.root.addChild(this.titleBox),console.log("TODO billboard titleBox"),this.addTextoSurroundBox(),this.titleBox.addComponent("script"),this.titleBox.script&&(this.billboard=this.titleBox.script.create("billboard"),this.billboard.addCamera(this.orbitCamera))),this.titleTex&&this.titleTex.element&&this.titleTex.element.text&&(this.titleTex.element.text=e.name),this.titleBox.setLocalPosition(i.center.x,i.center.y+r.y+.13*this.mainScale,i.center.z),this.titleBox.setLocalScale(0,0,0),t||this.titleBox.tween(this.titleBox.getLocalScale()).to({x:this.mainScale,y:this.mainScale,z:this.mainScale},.8,l.ElasticOut).start()},r.prototype.buildAabb=function(e,t,i){var n=0;if(e.model)for(var r=e.model.meshInstances,n=0;n<r.length;n++)0===i?t.copy(r[n].aabb):t.add(r[n].aabb),i+=1;for(var s=0;s<e.children.length;++s)i+=this.buildAabb(e.children[s],t,i);return i},r.prototype.addTextoSurroundBox=function(){var e=this.app.assets.find("font");console.log("addTExtoSurroudnBox: ",e),this.titleTex=new l.Entity("titleText"),this.titleTex.addComponent("element",{anchor:[.5,.5,.5,.5],autoWidth:!0,autoHeigth:!0,fontSize:.13,color:"grey",Alignment:[0,1],pivot:[.5,.5],text:"titleText",type:l.ELEMENTTYPE_TEXT}),this.titleTex.element&&(console.log("titleTExt fontAsset"),this.titleTex.element.fontAsset=e.id,this.titleBox.addChild(this.titleTex),this.titleTex.setLocalPosition(0,0,-.011),this.titleBox.setLocalEulerAngles(0,180,0))},r.prototype.createContentBox=function(e){var t=new h.Entity;return t.addComponent("model",{type:"box"}),t.dato=e,t.setLocalScale(e.scale.x,e.scale.y,e.scale.z),t.setLocalPosition(e.x,e.y,e.z),t},r.prototype.createBoxTransparent=function(e,t){var i=new l.Vec3(+t.scale,+t.scale,.15*t.scale),n=new h.Entity(t.id);n.dato=t,n.dato.bbox=i,n.animar=t.animar,console.log("craete box asset",e),n.addComponent("model",{type:"asset",asset:e.resource.model,castShadows:!0}),n.addComponent("collision",{type:"box",halfExtents:i}),n.name=t.id,n.tags.add(t.id),n.tags.add(t.tag),n.setLocalScale(+t.scale,.5*t.scale,.15*t.scale),n.setLocalPosition(t.x,t.y,t.z);t=this.createMaterial((new l.Color).fromString(t.color),(new l.Color).fromString(t.color),!0,.1);return n.model&&(n.model.meshInstances[0].material=t,n.model.meshInstances[0].setParameter("material_opacity",.9),t.blendType=l.BLEND_NORMAL),n},r.prototype.setColorMesh=function(e,t,i){if(e.model)for(var n=0;n<e.model.meshInstances.length;n++){var r;i==e.model.meshInstances[n].node.name&&(console.log("--\x3e meshInstances:",t,e.model.meshInstances[n].node.name),r=(new l.Color).fromString(t),e.model.meshInstances[n].setParameter("material_diffuse",[r.r,r.g,r.b]))}},r.prototype.updateEntity=function(e){"ground"!=e.name&&this.updateColors(e),e.animar&&e.dato&&e.animationName&&(console.log("TODO call animation: ",e.id,e.animation),this.animations.animObject(e,e.animationName),e.dato.animSound||this.playSound("click"))},r.prototype.createOrUpdatePlayer=function(e){this.cont++,this.players.get(e.id)||(console.log("creando player",e.color,e.id),i=this.app.assets.find("avatar"),(t=new l.Entity(e.id)).addComponent("model",{type:"asset",asset:i.resource.model,castShadows:!0}),this.setColorMesh(t,e.color,"avatar"),t.setLocalScale(2.5,2.5,2.5),this.app.root.addChild(t),e.c1&&this.createHand(e,"_c1"),e.c2&&this.createHand(e,"_c2")),this.players.set(e.id,e);var t,i=this.app.root.findByName(e.id);i&&(i.setLocalPosition(e.pos.x,e.pos.y,e.pos.z),e.angles&&i.setEulerAngles(e.angles.x,e.angles.y,e.angles.z)),(e.c1||e.c2)&&(t=this.app.root.findByName(e.id+"_c1"),i=this.app.root.findByName(e.id+"_c2"),t.setPosition(e.c1.x,e.c1.y,e.c1.z),i.setPosition(e.c2.x,e.c2.y,e.c2.z))},r.prototype.createHand=function(e,t){var i=new l.Entity(e.id+t),t=new l.StandardMaterial,e=(new l.Color).fromString(e.color);t.diffuse.set(e.r,e.g,e.b),t.update(),i.addComponent("model",{type:"sphere",castShadows:!0,material:t}),i.setLocalScale(.1,.1,.1),i.setPosition(1,1,1),this.app.root.addChild(i)},r.prototype.createOrUpdatePlayerOld=function(e){var t,i;this.players.get(e.id)||(console.log("creando player",e.color,e.id),n=new l.Entity(e.id),t=new l.StandardMaterial,i=(new l.Color).fromString(e.color),t.diffuse.set(i.r,i.g,i.b),t.update(),n.addComponent("model",{type:"sphere",castShadows:!0,material:t}),n.setLocalScale(.2,.2,.2),this.app.root.addChild(n)),this.players.set(e.id,e);var n=this.app.root.findByName(e.id);n&&n.setLocalPosition(e.x,e.y,e.z)},r.prototype.removeOldPlayers=function(){var n=this,r=(new Date).getTime()-1e4;this.players.forEach(function(e,t){var i;e.time<r&&(n.players.delete(t),i=n.app.root.findByName(t),e=n.app.root.findByName(t+"_c1"),t=n.app.root.findByName(t+"_c2"),i&&i.destroy(),e&&e.destroy(),t&&t.destroy())})},r.prototype.createIntersectPoint=function(){this.intersectPoint=new l.Entity("intersectionPoint");var e=new l.StandardMaterial;e.diffuse.set(1,0,0),e.update(),this.intersectPoint.addComponent("model",{type:"sphere",castShadows:!1,material:e}),this.intersectPoint.setLocalScale(.02,.02,.02),this.app.root.addChild(this.intersectPoint)},r.prototype.createIntersectPointB=function(){this.intersectPointB=new l.Entity("intersectionPoint");var e=new l.StandardMaterial;e.diffuse.set(0,1,0),e.update(),this.intersectPointB.addComponent("model",{type:"sphere",castShadows:!1,material:e}),this.intersectPointB.setLocalScale(.02,.02,.02),this.app.root.addChild(this.intersectPointB)},r.prototype.reescalar=function(e,t){var i,n,r,s;this.mainScale!==Number(e)&&(console.log("---\x3ereescalar ",t,"scale:",e,"mainScale:",this.mainScale),this.mainScaleOld=this.mainScale,n=this.app.root.findByName("tscale"),r=this.app.root.findByName("pscaleLabel"),this.mainScale="+"==e?this.mainScale<1?2*this.mainScale:this.mainScale+1:"-"==e?this.mainScale<=1?this.mainScale/2:this.mainScale-1:Number(e),i=Number(this.mainScale),t||this.multiplayer.objectState("sceneParent",i),e=""+Math.round(100*(this.mainScale+Number.EPSILON))/100,console.log("scaleText",e),n&&n.element&&(n.element.text=e),r&&r.element&&(r.element.text=e),this.intersectPoint.setLocalScale(l.Vec3.ONE.clone().scale(.02*this.mainScale)),this.intersectPointB.setLocalScale(l.Vec3.ONE.clone().scale(.02*this.mainScale)),t=this.app.root.findByName("cameraParent"),n=this.app.root.findByName("xrpanel"),t&&(r=this.mainScale/this.mainScaleOld,e=t.getLocalPosition().clone(),t.setLocalPosition(e.x*r,e.y,e.z*r),n&&n.enabled&&n.parent===this.app.root&&(t=t.getLocalPosition().clone(),s=n.getLocalPosition().clone(),t.sub(e),s.add(t),console.log("---\x3emoving xrpanel"),n.setLocalPosition(s.x,s.y,s.z))),this.app.root.findByName("sceneParent").setLocalScale(i,i,i),this.app.root.findByTag("scalable").forEach(function(e){e.collision&&e.collision&&e.dato&&e.dato.bbox&&(e.collision.halfExtents=e.dato.bbox.clone().scale(i))}),s=this.app.root.findByName("titleBoxBase"),this.app.root.findByName("titleText").setLocalPosition(0,0,-.011*(i<1?1:i)),s.setLocalScale(i,i,i),s=this.app.root.findByName(this.selEntityName),this.createInfoBox(this.app.root.findByName("ground"),!1),s&&(console.log("call createInfoBox from reescalar2"),this.createInfoBox(s,!1)))},r.prototype.createPlaneButton=function(e,t){var i;t.noButton||((r=new h.Entity(t.id)).addComponent("model",{type:"plane"}),n=new l.StandardMaterial,i=this.app.assets.find("panel"),n.diffuse.set(t.bgcolor.r,t.bgcolor.g,t.bgcolor.b),n.emissive.set(t.bgcolor.r,t.bgcolor.g,t.bgcolor.b),n.emissiveIntensity=.3,n.opacityMap=i.resource,n.alphaTest=.3,n.cull=l.CULLFACE_NONE,n.update(),r.model&&(r.model.material=n),r.addComponent("collision",{type:"box",halfExtents:t.bbox}),r.callFunc=t.callFunc,r.callVal=t.callVal,r.setLocalScale(t.scale),r.setLocalPosition(t.pos),r.tags.add("button"),e.addChild(r));var n=this.app.assets.find("font"),r=new l.Entity(t.id+"Label");r.addComponent("element",{anchor:[.5,.5,.2,.5],color:t.color,fontSize:.02,autoWidth:!0,autoHeigth:!0,pivot:[.5,.5],text:t.text,type:l.ELEMENTTYPE_TEXT,fontAsset:n}),r.rotateLocal(-90,0,0),r.setLocalPosition(t.pos.x,.0012,t.pos.z),e.addChild(r)},r.prototype.teletransport=function(e){var t=this.app.root.findByName(e),i=this.app.root.findByName("cameraParent"),n=i.getLocalPosition().clone();t&&i&&"ground"==e?i.setLocalPosition(-1.5,.4,.3):(r=new l.BoundingBox,this.buildAabb(t,r,0),s=r.halfExtents.clone(),e=e.startsWith("wt")?.5:1,i.setLocalPosition(r.center.x,r.center.y+e*s.y+.1*this.mainScale,r.center.z));var r,s=this.app.root.findByName("xrpanel");s&&s.enabled&&s.parent===this.app.root&&(r=i.getLocalPosition().clone(),i=s.getLocalPosition().clone(),r.sub(n),i.add(r),console.log("---\x3emoving xrpanel"),s.setLocalPosition(i.x,i.y,i.z))},r.prototype.disableEnableCameras=function(e){console.log("---ENABLE DISABLE CAMERAS---");var t=this.app.root.findByName("orbitCamera"),i=this.app.root.findByName("titleBoxBase"),n=this.app.root.findByName("xrCamera");if(e)return console.log("---\x3eDISABLING orbitCamera"),t.enabled=!1,this.cameras.orbitCameraSM.removeEventsMouse(),console.log("-----\x3e",i," xrCamera:",n),this.billboard&&this.billboard.addCamera(n),t.getLocalPosition().clone();console.log("---\x3eENABLING"),t.enabled=!0,this.cameras.orbitCameraSM.addEventsMouse(),this.billboard&&this.billboard.addCamera(t),t.script&&t.script.scripts&&t.script.scripts.orbitCameraInputMouse&&t.script.scripts.orbitCameraInputMouse.addEventsMouse()},r.prototype.addButtons=function(e,t){for(var i=[{f:"reescalar",id:"gx05",text:"x0.5",v:.5},{f:"reescalar",id:"gx1",text:"x1",v:1},{f:"reescalar",id:"gx2",text:"x2",v:2},{f:"reescalar",id:"gx3",text:"x3",v:3},{f:"reescalar",id:"gmas",text:"+",v:"+"},{f:"reescalar",id:"gmenos",text:"-",v:"-"},{f:"anim",id:"animAll",text:"anim",v:"sceneParent",animationName:"animAll"}],n=0;n<i.length;n++)this.createButton(e,!0,{scale:new l.Vec3(.3,.2,.01),pos:new l.Vec3(-1.5,.002,1+.24*n),rot:new l.Vec3(-90,0,0),id:i[n].id,bbox:new l.Vec3(.15,.1,.005),text:i[n].text,tipo:"button",callFunc:i[n].f,callVal:i[n].v,animationName:i[n].animationName,bgcolor:t,color:(new l.Color).fromString("#eeeeee")})},r.prototype.createButton=function(e,t,i){var n=new h.Entity(i.id);n.addComponent("model",{type:"box"});var r=this.createMaterial(i.bgcolor,i.bgcolor);n.model&&(n.model.material=r),n.addComponent("collision",{type:"box",halfExtents:i.bbox}),n.callFunc=i.callFunc,n.callVal=i.callVal,n.animationName=i.animationName,n.acfactor=0,n.setLocalScale(i.scale),n.setLocalPosition(i.pos),n.setLocalEulerAngles(i.rot),n.tags.add("button"),t&&n.tags.add("scalable"),e.addChild(n);t=this.app.assets.find("font"),e=new l.Entity;return e.addComponent("element",{anchor:[.5,.5,.5,.5],color:i.color,fontSize:.38,autoWidth:!0,autoHeigth:!0,pivot:[.5,.5],text:i.text,type:l.ELEMENTTYPE_TEXT,wrapLines:!0,fontAsset:t}),e.setLocalPosition(0,0,1.42),n.addChild(e),n},r);function r(e,t,i){this.mainScale=1,this.mainScaleOld=1,this.cont=0,this.players=new Map,this.app=e,this.multiplayer=t,this.animations=i}},"./src/game/entity.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"EDato",function(){return r}),i.d(t,"Entity",function(){return s});var n,t=i("./node_modules/tslib/tslib.es6.js"),i=i("./node_modules/playcanvas/build/playcanvas.js"),r=function(){},s=(n=i.Entity,Object(t.__extends)(a,n),a);function a(){var e=null!==n&&n.apply(this,arguments)||this;return e.acfactor=0,e}},"./src/game/helpers.ts":function(e,t,i){"use strict";function n(e){return"./static/"+e}i.r(t),i.d(t,"getAssetPath",function(){return n})},"./src/game/index.ts":function(e,t,i){"use strict";i.r(t);var n=i("./src/game/app.ts");i.d(t,"App",function(){return n.App})},"./src/game/lights.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Lights",function(){return r});var n=i("./node_modules/playcanvas/build/playcanvas.js"),r=(s.addAmbientLight=function(e){e.scene.ambientLight=new n.Color(.2,.2,.2)},s.createSimpleDirectionalShadowLight=function(e,t){var i=new n.Entity;i.addComponent("light",{type:"directional",castShadows:t,range:16,shadowBias:.2,normalOffsetBias:.05,shadowResolution:4096,shadowType:n.SHADOW_PCF5}),i.lookAt(new n.Vec3(-5,6,-5)),e.root.addChild(i)},s.addSkyBox=function(e,t,i){e.scene.skyboxMip=t,e.scene.skyboxIntensity=1,e.scene.toneMapping=n.TONEMAP_FILMIC,e.scene.exposure=11,e.scene.gammaCorrection=2.2,e.scene.setSkybox(e.assets.find(i).resources);i=new n.Quat;i.setFromEulerAngles(0,206,0),e.scene.skyboxRotation=i},s);function s(){}},"./src/game/multiplayer.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Multiplayer",function(){return r});var n=i("./node_modules/socket.io-client/build/index.js"),r=(s.prototype.init=function(){var i=this;this.socket=Object(n.io)("https://iosocket-server.glitch.me/",{extraHeaders:{Authorization:"Basic YWE6YWE="}}),this.socket.on("connect",function(){i.movement.id=i.socket.id,i.socket.emit("new player",i.movement),console.log("---\x3e socket id:",i.socket.id),console.log("---\x3e connected")}),this.socket.on("state",function(e){for(var t in e)t!=i.socket.id&&i.entities.createOrUpdatePlayer(e[t]),i.cont,i.cont++}),this.socket.on("objectState",function(e){var t;e.id!=i.socket.id&&(console.log("objectState:",e),(t=i.app.root.findByName(e.objId))&&(console.log("encontrada:",e.state,e.objId),"sceneParent"==e.objId?(console.log("reescalando sceneParent:",e.state),i.entities.reescalar(e.state,!0)):(t.animar=e.state,i.entities.updateEntity(t),i.entities.updatePathsState())))}),this.socket.on("objectAction",function(e){e.id!=i.socket.id&&(console.log("objectAction:",e),i.app.root.findByName(e.objId)&&(console.log("encontrada:",e.objId,e.action),i.entities.animate(e.objId,e.action)))}),this.socket.on("objectSel",function(e){e.id!=i.socket.id&&(console.log("objectSel:",e),(e=i.app.root.findByName(e.objId))&&i.entities.execSelectEntity(e,!0))}),this.socket.on("objectsState",function(e){console.log("objectsState:",e),e.sceneParent&&(console.log("SCALE:",e.sceneParent),i.entities.reescalar(e.sceneParent,!0)),Object.entries(e).forEach(function(e){var t=e[0],e=e[1],t=i.app.root.findByName(t);t&&(t.animar=Boolean(e),i.entities.updateEntity(t))}),i.entities.updatePathsState()}),setInterval(function(){i.entities.removeOldPlayers()},5e3),setInterval(function(){i.socket.emit("movement",i.movement)},1e3/60)},s.prototype.updateMovement=function(e,t){this.cont2++,this.movement.pos=e.getPosition(),this.movement.angles=e.getEulerAngles(),t&&1<=t.length&&(this.movement.c1=t[0].getPosition(),2==t.length&&(this.movement.c2=t[1].getPosition()))},s.prototype.updateObjects=function(e){this.socket.emit("objects",{id:this.socket.id,ac:"a",objs:e})},s.prototype.objectAction=function(e,t){this.socket.emit("objectAction",{id:this.socket.id,objId:e,action:t})},s.prototype.objectState=function(e,t){this.socket.emit("objectState",{id:this.socket.id,objId:e,state:t})},s.prototype.selectEntity=function(e){console.log("multiplayer emit select:",e.name),this.socket.emit("objectSel",{id:this.socket.id,objId:e.name})},s);function s(e,t){this.movement={pos:{x:1.8,y:.5,z:1.8},angles:{x:0,y:0,z:0},c1:{x:0,y:0,z:0},c2:{x:0,y:0,z:0},id:"",color:"#"+Math.floor(16777215*Math.random()).toString(16)},this.entities=t,this.app=e,console.log("color:",this.movement.color)}},"./src/game/paths.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"PathElem",function(){return n}),i.d(t,"DatosPath",function(){return r}),i.d(t,"Paths",function(){return s});var f=i("./src/game/entity.ts"),d=Math.PI/180,n=function(){},r=function(){},s=(a.prototype.calcPathLine=function(e,t){return{x0:t.x+.5*Math.cos(e-90*d),y0:t.y,z0:t.z+.5*Math.sin(e-90*d),x1:t.x+.5*Math.cos(e+90*d),y1:t.y,z1:t.z+.5*Math.sin(e+90*d)}},a.prototype.calcPathPNext=function(e,t){return{x:t.x+Math.cos(e),y:t.y,z:t.z+Math.sin(e)}},a.prototype.calcSizePath=function(e){for(var t=0,i=0;i<e.length;i++)e[i].num?t+=this.pathFloorNum(e[i].num):t+=2;return t},a.prototype.genLinePath=function(e,t,i,n,r,s,a){for(var o=0;o<e;o++){var l=12*(o+a);n[0+l]=i.orig.x0,n[1+l]=i.orig.y0,n[2+l]=i.orig.z0,n[3+l]=i.orig.x1,n[4+l]=i.orig.y1,n[5+l]=i.orig.z1,n[6+l]=i.next.x1,n[7+l]=i.next.y1,n[8+l]=i.next.z1,n[9+l]=i.next.x0,n[10+l]=i.next.y0,n[11+l]=i.next.z0;l=8*(o+a);r[0+l]=0,r[1+l]=.5,r[2+l]=0,r[3+l]=1,r[4+l]=1,r[5+l]=1,r[6+l]=1,r[7+l]=.5;l=4*(o+a);s.push(0+l),s.push(1+l),s.push(2+l),s.push(2+l),s.push(3+l),s.push(0+l),i.pIni=i.pNext,i.orig=i.next,i.pNext=this.calcPathPNext(t,i.pIni),i.next=this.calcPathLine(t,i.pNext)}},a.prototype.genGiroPath=function(e,t,i,n,r,s,a){var o=e+Math.PI/180*("left"==a?-90:90),e=12*s;i[0+e]=t.orig.x0,i[1+e]=t.orig.y0,i[2+e]=t.orig.z0,i[3+e]=t.orig.x1,i[4+e]=t.orig.y1,i[5+e]=t.orig.z1,i[6+e]=t.next.x1,i[7+e]=t.next.y1,i[8+e]=t.next.z1,i[9+e]=t.next.x0,i[10+e]=t.next.y0,i[11+e]=t.next.z0;e=8*s;"left"==a?(n[0+e]=0,n[1+e]=0,n[2+e]=0,n[3+e]=.5,n[4+e]=.5,n[5+e]=.5,n[6+e]=.5,n[7+e]=0):(n[0+e]=1,n[1+e]=0,n[2+e]=.5,n[3+e]=0,n[4+e]=.5,n[5+e]=.5,n[6+e]=1,n[7+e]=.5);s*=4;r.push(0+s),r.push(1+s),r.push(2+s),r.push(2+s),r.push(3+s),r.push(0+s);s={y:t.next.y0,x:(t.orig.x0+t.orig.x1+t.next.x0+t.next.x1)/4,z:(t.orig.z0+t.orig.z1+t.next.z0+t.next.z1)/4};s.x+=.5*Math.cos(o),s.z+=.5*Math.sin(o),t.pIni=s,t.orig=this.calcPathLine(o,s),t.pNext=this.calcPathPNext(o,t.pIni),t.next=this.calcPathLine(o,t.pNext)},a.prototype.pathFloorNum=function(e){e=Math.floor(e);return 0==e?1:e},a.prototype.pathGeneration=function(e){var t=d*e.dir,i=new pc.Mesh(this.app.graphicsDevice);i.clear(!0,!1);for(var n=this.calcSizePath(e.path),r=new Array(12*n),s=new Array(8*n),a=[],o=new pc.Vec3(0,.01,0),n=this.calcPathPNext(t,o),l={pIni:o,orig:this.calcPathLine(t,o),pNext:n,next:this.calcPathLine(t,n)},h=0,c=0;c<e.path.length;c++){var u=e.path[c];"G"==u.type&&(this.genGiroPath(t,l,r,s,a,h,u.turn||"right"),t+=d*("left"==u.turn?-90:90),h+=2),"L"==u.type&&u.num&&(this.genLinePath(this.pathFloorNum(u.num),t,l,r,s,a,h),h+=this.pathFloorNum(u.num))}for(c=0;c<r.length;c++)r[c]=r[c]*e.scale;i.setPositions(r),i.setNormals(pc.calculateNormals(r,a)),i.setUvs(0,s),i.setIndices(a),i.update(pc.PRIMITIVE_TRIANGLES);o=new pc.GraphNode,n=new pc.StandardMaterial,i=new pc.MeshInstance(o,i,n),n=new pc.Model;n.graph=o,n.meshInstances=[i];i=new f.Entity(e.id);return i.tags.add(e.type),i.tags.add("scalable"),i.animar=!0,this.app.root.addChild(i),i.addComponent("model",{type:"asset",castShadows:!1}),i.model&&(i.model.model=n),i},a);function a(e){this.app=e}},"./src/game/shaders.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"Shaders",function(){return n});var n=(r.prototype.createUTimeMaterial=function(e){var t=new pc.Material;return t.shader=e,t.depthWrite=!1,t.blendType=pc.BLEND_NORMAL,t.setParameter("uTime",0),t},r.prototype.createShader=function(e,t){var i=this.app.graphicsDevice;i.setBlending(!0);t={attributes:{aPosition:pc.SEMANTIC_POSITION,aUv0:pc.SEMANTIC_TEXCOORD0},vshader:e,fshader:t};return new pc.Shader(i,t)},r.prototype.addRayoShaderMaterialEntity=function(e){this.addShaderMaterialEntity(e,"\n    attribute vec3 aPosition;\n    attribute vec2 aUv0;\n\n    uniform mat4 matrix_model;\n    uniform mat4 matrix_viewProjection;\n\n    varying vec2 vUv0;\n\n    void main(void)\n    {\n        vUv0 = aUv0;\n        gl_Position = matrix_viewProjection * matrix_model * vec4(aPosition, 1.0);\n    }\n","\nprecision mediump float;\nvarying vec2 vUv0;\nuniform float uTime;\n\nvoid main(void)\n{\n    vec2 xy = vUv0;\n    // Time varying pixel color\n    //vec3 col = 0.5 + 0.5*cos(uTime + xy.yxy + vec3(0.0,2.0,4.0));\n    float y = vUv0.y;\n    // Output to screen\n    gl_FragColor = vec4(1.0,1.0,1.0,y);\n}    \n")},r.prototype.addShaderMaterialEntity=function(t,e,i){var n=this,i=this.createShader(e,i);console.log("created shader");var r=this.createUTimeMaterial(i);console.log("created createUTimeMaterial"),t.model&&t.model.meshInstances.forEach(function(e){e.material=r}),console.log("created meshInstance");var s=0;this.app.on("update",function(e){t.animar&&(e=(s+=n.dashSpeed*e)%1,r.setParameter("uTime",e))})},r.prototype.pcColorToArray=function(e){return[e.r,e.g,e.b,e.a]},r);function r(e){this.dashSpeed=1,this.app=e}},"./src/game/xr.ts":function(e,t,i){"use strict";i.r(t),i.d(t,"XR",function(){return n});var o=i("./node_modules/playcanvas/build/playcanvas.js"),s=i("./src/game/entity.ts"),n=(r.prototype.createController=function(e){console.log("creando controlador");var t=new s.Entity,i=new o.StandardMaterial;i.blendType=o.BLEND_NORMAL,i.opacity=.99,t.addComponent("model",{type:"box",castShadows:!1,material:i}),t.setLocalScale(.05,.05,.05),this.cameraParent.addChild(t),t.inputSource=e,this.controllers.push(t);var n=this.createRayo();t.rayo=n,this.app.root.addChild(n),this.rayos.push(n);var r=this;e.on("remove",function(){r.controllers.splice(r.controllers.indexOf(t),1),t.destroy(),r.rayos.splice(r.rayos.indexOf(n),1),n.destroy()})},r.prototype.closePanel=function(){this.xrpanelMaintain=!1,this.xrpanel.enabled=!1},r.prototype.createPanel=function(){var e=this.app.assets.find("panel"),t=this.app.assets.find("panel2"),i=this.app.assets.find("background");console.log("createPanel",e,t,i);i=new o.StandardMaterial;i.diffuseMap=t.resource,i.emissive.set(.1,.1,.1),i.emissiveIntensity=.2,i.opacityMap=e.resource,i.alphaTest=.3,i.cull=o.CULLFACE_NONE,i.update(),this.xrpanel=new o.Entity("xrpanel"),this.cameraParent.addChild(this.xrpanel),this.xrpanelp=new o.Entity("xrpanelp"),this.xrpanelp.addComponent("model",{type:"plane",castShadows:!1,material:i}),this.xrpanelp.setLocalScale(.5,.3,.3),this.xrpanel.addChild(this.xrpanelp),this.addButtonsPanel(this.xrpanel),this.xrpanel.enabled=!1},r.prototype.addButtonsPanel=function(e){for(var t=[{f:"reescalar",id:"pscale",text:"1",v:"1",px:0,py:2.1,w:1,noButton:!0},{f:"reescalar",id:"pmas",text:"+",v:"+",px:.75,py:2.1,w:.5},{f:"reescalar",id:"pmenos",text:"-",v:"-",px:1.25,py:2.1,w:.5},{f:"anim",id:"pclose",text:"close",v:"close",px:2,py:2.1,w:1,bgcolor:new o.Color(.6,.3,.3,1)},{f:"anim",id:"panim1",text:"animate all",v:"sceneParent",px:0,py:3.1,w:1},{f:"anim",id:"panim2",text:"anim. che",v:"che",px:1,py:3.1,w:1},{f:"anim",id:"panim3",text:"anim. wt",v:"turbines",px:2,py:3.1,w:1},{f:"teletransport",id:"wt1",text:"wturbine1",v:"wturbine1",px:0,py:4.1,w:1},{f:"teletransport",id:"pground",text:"ground",v:"ground",px:1,py:4.1,w:1},{f:"teletransport",id:"pground",text:"edificio1",v:"edificio1",px:2,py:4.1,w:1}],i=0;i<t.length;i++)this.entities.createPlaneButton(e,{scale:new o.Vec3(.15*t[i].w,.08,.05),pos:new o.Vec3(.5*(.32*t[i].px-.32),.001,.5*(.13*t[i].py-.35)),rot:new o.Vec3(0,0,0),bbox:new o.Vec3(.075*t[i].w,.001,.02),text:t[i].text,id:t[i].id,tipo:"button",callFunc:t[i].f,callVal:t[i].v,noButton:t[i].noButton||!1,bgcolor:t[i].bgcolor||new o.Color(.3,.3,.3,1),color:(new o.Color).fromString("#ffffff")})},r.prototype.createRayo=function(){var e,t=new s.Entity;return t.animar=!0,t.addComponent("model",{type:"box",castShadows:!0,material:new o.StandardMaterial}),console.log("model",null===(e=t.model)||void 0===e?void 0:e.meshInstances),this.shaders.addRayoShaderMaterialEntity(t),t.setLocalScale(.005,this.scaleRayos,.005),t},r.prototype.addSuportXR=function(){var e,a=this;this.cameraParent=new o.Entity("cameraParent"),this.app.root.addChild(this.cameraParent),this.xrCamera=this.initXRCamera(),this.cameraParent.addChild(this.xrCamera),this.cameraParent.setLocalPosition(-1.5,.4,.3),this.cameraParent.rotateLocal(0,-100,0),this.createPanel(),this.app.xr.supported&&((e=document.getElementById("vrbutton"))&&this.app.xr.supported&&this.app.xr.isAvailable(o.XRTYPE_VR)&&(console.log("showing VR Button"),e.classList.remove("oculto"),e.addEventListener("click",function(){console.log("activate XR"),a.app.xr.isAvailable(o.XRTYPE_VR)?(a.changeCameraXR(),a.xrCamera.camera&&a.xrCamera.camera.startXr(o.XRTYPE_VR,o.XRSPACE_LOCAL,{callback:function(e){e&&(console.error("ERRRRR:",e),a.changeCameraXR())}})):console.log("Immersive VR is not available")})),this.app.xr.input.on("add",function(e){a.createController(e)}),this.app.keyboard.on("keydown",function(e){e.key===o.KEY_ESCAPE&&a.app.xr.active&&(a.app.xr.end(),a.changeCameraXR()),e.key===o.KEY_SUBTRACT&&a.app.xr.active&&a.entities.reescalar("-",!1),e.key===o.KEY_ADD&&a.app.xr.active&&(console.log("reeescalar key"),a.entities.reescalar("+",!1)),e.key===o.KEY_C&&a.app.xr.active&&(a.xrpanel.enabled=!1),e.key===o.KEY_RIGHT&&a.app.xr.active&&(a.posPositionTrans++,a.entities.teletransport(a.positionsTrans[a.posPositionTrans%a.positionsTrans.length]))}),this.app.xr.on("start",function(){}),this.app.xr.on("end",function(){}),this.app.xr.on("available:"+o.XRTYPE_VR,function(e){}),this.app.xr.isAvailable(o.XRTYPE_VR),this.app.xr.input.on("select",function(e){console.log("XR SELECT");var t=e.getDirection().clone().scale(100).add(e.getOrigin()),t=a.app.systems?a.app.systems.rigidbody.raycastFirst(e.getOrigin(),t):null;console.log("result raycast:",t),t&&t.entity&&(e.handedness!==o.XRHAND_RIGHT||e.gamepad.buttons[4].pressed?a.entities.activateEntity(t.entity,!0):a.entities.selectEntity(t.entity,!0))}),this.app.xr.input.on("devicechange",function(e){console.log("XR devicechange")}),this.app.xr.input.on("selectstart",function(e){console.log("XR selectstart");var t=(new Date).getTime();e.handedness===o.XRHAND_LEFT?a.startPressL=t:a.startPressR=t}),this.app.xr.input.on("selectend",function(e){console.log("XR selectend"),e.handedness===o.XRHAND_LEFT?a.startPressL=void 0:a.startPressR=void 0}),this.app.xr.input.on("squeeze",function(e){console.log("XR squeeze")}),this.app.xr.input.on("squeezestart",function(e){if(console.log("XR squeezestart"),e.handedness===o.XRHAND_LEFT){for(var t=0;t<a.controllers.length;t++)a.controllers[t].inputSource==e&&(a.controllers[t].model.hide(),a.controllers[t].rayo.model.enabled=!1);a.xrpanel.enabled=!0,a.xrpanel.reparent(a.cameraParent)}}),this.app.xr.input.on("squeezeend",function(e){if(console.log("XR squeezeend: ",a.xrpanelMaintain),e.handedness===o.XRHAND_LEFT){for(var t=0;t<a.controllers.length;t++)a.controllers[t].inputSource==e&&(a.controllers[t].model.show(),a.controllers[t].rayo.model.enabled=!0);console.log("---\x3eFijando a Root");var i=a.xrpanel.getPosition().clone(),n=a.xrpanel.getRotation().clone();console.log("xrpanel  localPosition: ",a.xrpanel.getLocalPosition().clone()),console.log("xrpanelp localPosition: ",a.xrpanelp.getLocalPosition().clone()),a.xrpanel.reparent(a.app.root),a.xrpanel.setPosition(i),a.xrpanel.setRotation(n)}}),this.app.xr.input.on("click",function(e){console.log("XR click")}),this.app.on("update",function(e){var t,i,n,r,s;for(a.incTime++,a.multiplayer.updateMovement(a.xrCamera,a.controllers),t=0;t<a.controllers.length;t++)(s=a.controllers[t].inputSource).gamepad&&(s.handedness===o.XRHAND_LEFT||s.gamepad.buttons[1].pressed?a.cameraHorizontalMovement(s,e):s.handedness!==o.XRHAND_RIGHT||s.gamepad.buttons[1].pressed||a.cameraVerticalMovement(s),i=(new Date).getTime(),s.handedness===o.XRHAND_LEFT?(s.gamepad.buttons[1].pressed?a.mostrarPanel(s,t):a.mostrarControlador(s,t),a.startPressL&&500<i-a.startPressL?(n=s.getDirection().clone().scale(100).add(s.getOrigin()),(r=a.app.systems.rigidbody.raycastFirst(s.getOrigin(),n))&&r.entity?a.entities.intersectPointB.setLocalPosition(r.point):a.entities.intersectPointB.setLocalPosition(new o.Vec3(0,-.1,0))):a.entities.intersectPointB.setLocalPosition(new o.Vec3(0,-.1,0))):s.handedness===o.XRHAND_RIGHT&&(a.mostrarControlador(s,t),a.startPressR&&500<i-a.startPressR?(n=s.getDirection().clone().scale(100).add(s.getOrigin()),(r=a.app.systems.rigidbody.raycastFirst(s.getOrigin(),n))&&r.entity?a.entities.intersectPoint.setLocalPosition(r.point):a.entities.intersectPoint.setLocalPosition(new o.Vec3(0,-.1,0))):a.entities.intersectPoint.setLocalPosition(new o.Vec3(0,-.1,0))))}))},r.prototype.mostrarPanel=function(e,t){console.log("mostrarPanel"),this.xrpanel.setLocalPosition(e.getLocalPosition()),this.xrpanel.lookAt(this.xrCamera.getPosition()),this.xrpanel.rotateLocal(-90,0,180),this.xrpanel.translateLocal(0,-.35,0),e.grip&&(this.controllers[t].model.enabled=!0,this.controllers[t].setLocalPosition(e.getLocalPosition()))},r.prototype.mostrarControlador=function(e,t){this.tmpVec3A.copy(e.getOrigin()),this.tmpVec3B.copy(e.getDirection()),this.tmpVec3B.scale(100).add(this.tmpVec3A);var i=new o.Vec3;i.sub2(this.tmpVec3B,this.tmpVec3A).normalize(),i.scale(this.scaleRayos/2),this.rayos[t].setLocalPosition(i.add2(i,this.tmpVec3A)),this.rayos[t].lookAt(this.tmpVec3B),this.rayos[t].rotateLocal(90,0,0),e.grip?(this.controllers[t].model.enabled=!0,this.controllers[t].setLocalPosition(e.getLocalPosition()),this.controllers[t].setLocalRotation(e.getLocalRotation())):this.controllers[t].model.enabled=!1},r.prototype.cameraVerticalMovement=function(e){var t=e.gamepad.axes[3];.4<Math.abs(t)&&this.cameraParent.translate(0,-(Math.abs(t)-.4)*Math.sign(t)*.02,0);e=-e.gamepad.axes[2];(0<this.lastRotateValue&&e<this.rotateResetThreshold||this.lastRotateValue<0&&e>-this.rotateResetThreshold)&&(this.lastRotateValue=0),0===this.lastRotateValue&&Math.abs(e)>this.rotateThreshold&&(this.lastRotateValue=Math.sign(e),console.log("XR: Rotating"),this.tmpVec3A.copy(this.xrCamera.getLocalPosition()),this.cameraParent.translateLocal(this.tmpVec3A),this.cameraParent.rotateLocal(0,Math.sign(e)*this.rotateSpeed,0),this.cameraParent.translateLocal(this.tmpVec3A.scale(-1)))},r.prototype.cameraHorizontalMovement=function(e,t){var i;this.tmpVec2A.set(e.gamepad.axes[2],e.gamepad.axes[3]),this.tmpVec2A.length()&&(this.tmpVec2B.x=this.xrCamera.forward.x,this.tmpVec2B.y=this.xrCamera.forward.z,this.tmpVec2B.normalize(),i=Math.atan2(this.tmpVec2B.x,this.tmpVec2B.y)-Math.PI/2,e=this.tmpVec2A.x*Math.sin(i)-this.tmpVec2A.y*Math.cos(i),this.tmpVec2A.y=this.tmpVec2A.y*Math.sin(i)+this.tmpVec2A.x*Math.cos(i),this.tmpVec2A.x=e,this.tmpVec2A.scale(this.movementSpeed*t),this.cameraParent.translate(this.tmpVec2A.x,0,this.tmpVec2A.y))},r.prototype.initXRCamera=function(){var e=new o.Entity("xrCamera");return e.addComponent("camera",{clearColor:new o.Color(44/255,62/255,80/255),farClip:1e4}),e.setLocalPosition(3,3,3),e.enabled=!1,console.log("XRCamera: ",e),e},r.prototype.changeCameraXR=function(){var e,t=this.app.root.findByName("xrCamera");console.log("changeCameraXR xrc enabled: ",t.enabled),t.enabled?(t.enabled=!1,this.entities.disableEnableCameras(!1)):(t.enabled=!0,(e=this.entities.disableEnableCameras(!0))&&t.translate(e))},r);function r(e,t,i,n,r){this.controllers=[],this.xrpanelMaintain=!1,this.rayos=[],this.posPositionTrans=0,this.scaleRayos=1,this.incTime=0,this.movementSpeed=1.5,this.rotateSpeed=45,this.rotateThreshold=.5,this.rotateResetThreshold=.5,this.lastRotateValue=0,this.tmpVec2A=new o.Vec2,this.tmpVec2B=new o.Vec2,this.tmpVec3A=new o.Vec3,this.tmpVec3B=new o.Vec3,this.lineColor=new o.Color(1,1,1),this.ray=new o.Ray,this.app=e,this.entities=t,this.multiplayer=i,this.cameras=n,this.shaders=r}},"./src/main.ts":function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _game__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./src/game/index.ts"),_game_helpers__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/game/helpers.ts");window.pc=__webpack_require__("./node_modules/playcanvas/build/playcanvas.js"),eval('\npc.extend(pc, function () {\n\n    /**\n     * @name pc.TweenManager\n     * @description Handles updating tweens\n     * @param {pc.Application} app  The application\n     */\n    var TweenManager = function (app) {\n        this._app = app;\n        this._tweens = [];\n        this._add = []; // to be added\n    };\n\n    TweenManager.prototype = {\n        add: function (tween) {\n            this._add.push(tween);\n            return tween;\n        },\n\n        update: function (dt) {\n            var i = 0;\n            var n = this._tweens.length;\n            while (i < n) {\n                if (this._tweens[i].update(dt)) {\n                    i++;\n                } else {\n                    this._tweens.splice(i, 1);\n                    n--;\n                }\n            }\n\n            // add any tweens that were added mid-update\n            if (this._add.length) {\n                this._tweens = this._tweens.concat(this._add);\n                this._add.length = 0;\n            }\n        }\n    };\n\n    /**\n     * @name  pc.Tween\n     * @param {Object} target The target property that will be tweened\n     * @param {pc.TweenManager} manager The tween manager\n     * @param {pc.Entity} entity The pc.Entity whose property we are tweening\n     */\n    var Tween = function (target, manager, entity) {\n        pc.events.attach(this);\n\n        this.manager = manager;\n\n        if (entity) {\n            this.entity = null; // if present the tween will dirty the transforms after modify the target\n        }\n\n        this.time = 0;\n\n        this.complete = false;\n        this.playing = false;\n        this.stopped = true;\n        this.pending = false;\n\n        this.target = target;\n\n        this.duration = 0;\n        this._currentDelay = 0;\n        this.timeScale = 1;\n        this._reverse = false;\n\n        this._delay = 0;\n        this._yoyo = false;\n\n        this._count = 0;\n        this._numRepeats = 0;\n        this._repeatDelay = 0;\n\n        this._from = false; // indicates a "from" tween\n\n        // for rotation tween\n        this._slerp = false; // indicates a rotation tween\n        this._fromQuat = new pc.Quat();\n        this._toQuat = new pc.Quat();\n        this._quat = new pc.Quat();\n\n        this.easing = pc.Linear;\n\n        this._sv = {}; // start values\n        this._ev = {}; // end values\n    };\n\n    var _parseProperties = function (properties) {\n        var _properties;\n        if (properties instanceof pc.Vec2) {\n            _properties = {\n                x: properties.x,\n                y: properties.y\n            };\n        } else if (properties instanceof pc.Vec3) {\n            _properties = {\n                x: properties.x,\n                y: properties.y,\n                z: properties.z\n            };\n        } else if (properties instanceof pc.Vec4) {\n            _properties = {\n                x: properties.x,\n                y: properties.y,\n                z: properties.z,\n                w: properties.w\n            };\n        } else if (properties instanceof pc.Quat) {\n            _properties = {\n                x: properties.x,\n                y: properties.y,\n                z: properties.z,\n                w: properties.w\n            };\n        } else if (properties instanceof pc.Color) {\n            _properties = {\n                r: properties.r,\n                g: properties.g,\n                b: properties.b,\n            };\n            if (properties.a !== undefined) {\n                _properties.a = properties.a;\n            }\n        } else {\n            _properties = properties;\n        }\n        return _properties;\n    }\n    Tween.prototype = {\n        // properties - js obj of values to update in target\n        to: function (properties, duration, easing, delay, repeat, yoyo) {\n            this._properties = _parseProperties(properties);\n            this.duration = duration;\n\n            if (easing) this.easing = easing;\n            if (delay) {\n                this.delay(delay);\n            }\n            if (repeat) {\n                this.repeat(repeat);\n            }\n\n            if (yoyo) {\n                this.yoyo(yoyo);\n            }\n\n            return this;\n        },\n\n        from: function (properties, duration, easing, delay, repeat, yoyo) {\n            this._properties = _parseProperties(properties);\n            this.duration = duration;\n\n            if (easing) this.easing = easing;\n            if (delay) {\n                this.delay(delay);\n            }\n            if (repeat) {\n                this.repeat(repeat);\n            }\n\n            if (yoyo) {\n                this.yoyo(yoyo);\n            }\n\n            this._from = true;\n\n            return this;\n        },\n\n        rotate: function (properties, duration, easing, delay, repeat, yoyo) {\n            this._properties = _parseProperties(properties);\n\n            this.duration = duration;\n\n            if (easing) this.easing = easing;\n            if (delay) {\n                this.delay(delay);\n            }\n            if (repeat) {\n                this.repeat(repeat);\n            }\n\n            if (yoyo) {\n                this.yoyo(yoyo);\n            }\n\n            this._slerp = true;\n\n            return this;\n        },\n\n        start: function () {\n            var prop, _x, _y, _z;\n\n            this.playing = true;\n            this.complete = false;\n            this.stopped = false;\n            this._count = 0;\n            this.pending = (this._delay > 0);\n\n            if (this._reverse && !this.pending) {\n                this.time = this.duration;\n            } else {\n                this.time = 0;\n            }\n\n            if (this._from) {\n                for (prop in this._properties) {\n                    if (this._properties.hasOwnProperty(prop)) {\n                        this._sv[prop] = this._properties[prop];\n                        this._ev[prop] = this.target[prop];\n                    }\n                }\n\n                if (this._slerp) {\n                    this._toQuat.setFromEulerAngles(this.target.x, this.target.y, this.target.z);\n\n                    _x = this._properties.x !== undefined ? this._properties.x : this.target.x;\n                    _y = this._properties.y !== undefined ? this._properties.y : this.target.y;\n                    _z = this._properties.z !== undefined ? this._properties.z : this.target.z;\n                    this._fromQuat.setFromEulerAngles(_x, _y, _z);\n                }\n            } else {\n                for (prop in this._properties) {\n                    if (this._properties.hasOwnProperty(prop)) {\n                        this._sv[prop] = this.target[prop];\n                        this._ev[prop] = this._properties[prop];\n                    }\n                }\n\n                if (this._slerp) {\n                    this._fromQuat.setFromEulerAngles(this.target.x, this.target.y, this.target.z);\n\n                    _x = this._properties.x !== undefined ? this._properties.x : this.target.x;\n                    _y = this._properties.y !== undefined ? this._properties.y : this.target.y;\n                    _z = this._properties.z !== undefined ? this._properties.z : this.target.z;\n                    this._toQuat.setFromEulerAngles(_x, _y, _z);\n                }\n            }\n\n            // set delay\n            this._currentDelay = this._delay;\n\n            // add to manager when started\n            this.manager.add(this);\n\n            return this;\n        },\n\n        pause: function () {\n            this.playing = false;\n        },\n\n        resume: function () {\n            this.playing = true;\n        },\n\n        stop: function () {\n            this.playing = false;\n            this.stopped = true;\n        },\n\n        delay: function (delay) {\n            this._delay = delay;\n            this.pending = true;\n\n            return this;\n        },\n\n        repeat: function (num, delay) {\n            this._count = 0;\n            this._numRepeats = num;\n            if (delay) {\n                this._repeatDelay = delay;\n            } else {\n                this._repeatDelay = 0;\n            }\n\n            return this;\n        },\n\n        loop: function (loop) {\n            if (loop) {\n                this._count = 0;\n                this._numRepeats = Infinity;\n            } else {\n                this._numRepeats = 0;\n            }\n\n            return this;\n        },\n\n        yoyo: function (yoyo) {\n            this._yoyo = yoyo;\n            return this;\n        },\n\n        reverse: function () {\n            this._reverse = !this._reverse;\n\n            return this;\n        },\n\n        chain: function () {\n            var n = arguments.length;\n\n            while(n--) {\n                if (n > 0) {\n                    arguments[n-1]._chained = arguments[n];\n                } else {\n                    this._chained = arguments[n];\n                }\n            }\n\n            return this;\n        },\n\n        update: function (dt) {\n            if (this.stopped) return false;\n\n            if (!this.playing) return true;\n\n            if (!this._reverse || this.pending) {\n                this.time += dt*this.timeScale;\n            } else {\n                this.time -= dt*this.timeScale;\n            }\n\n            // delay start if required\n            if (this.pending) {\n                if (this.time > this._currentDelay) {\n                    if (this._reverse) {\n                        this.time = this.duration - (this.time - this._currentDelay);\n                    } else {\n                        this.time = this.time - this._currentDelay;\n                    }\n                    this.pending = false;\n                } else {\n                    return true;\n                }\n            }\n\n            var _extra = 0;\n            if ((!this._reverse && this.time > this.duration) || (this._reverse && this.time < 0)){\n                this._count++;\n                this.complete = true;\n                this.playing = false;\n                if (this._reverse) {\n                    _extra = this.duration - this.time;\n                    this.time = 0;\n                } else {\n                    _extra = this.time - this.duration;\n                    this.time = this.duration;\n                }\n            }\n\n            var elapsed = (this.duration === 0) ? 1 : (this.time / this.duration);\n\n            // run easing\n            var a = this.easing(elapsed);\n\n            // increment property\n            var s,e,d;\n            for (var prop in this._properties) {\n                if (this._properties.hasOwnProperty(prop)) {\n                    s = this._sv[prop];\n                    e = this._ev[prop];\n                    this.target[prop] = s + (e - s) * a;\n                }\n            }\n\n            if (this._slerp) {\n                this._quat.slerp(this._fromQuat, this._toQuat, a);\n            }\n\n            // if this is a entity property then we should dirty the transform\n            if (this.entity) {\n                this.entity._dirtifyLocal();\n\n                // apply element property changes\n                if (this.element && this.entity.element) {\n                    this.entity.element[this.element] = this.target;\n                }\n\n                if (this._slerp) {\n                    this.entity.setLocalRotation(this._quat);\n                }\n            }\n\n            this.fire("update", dt);\n\n            if (this.complete) {\n                var repeat = this._repeat(_extra);\n                if (!repeat) {\n                    this.fire("complete", _extra);\n                    if (this.entity)\n                        this.entity.off(\'destroy\', this.stop, this);\n                    if (this._chained) this._chained.start();\n                } else {\n                    this.fire("loop");\n                }\n\n                return repeat;\n            }\n\n            return true;\n        },\n\n        _repeat: function (extra) {\n            // test for repeat conditions\n            if (this._count < this._numRepeats) {\n                // do a repeat\n                if (this._reverse) {\n                    this.time = this.duration - extra;\n                } else {\n                    this.time = extra; // include overspill time\n                }\n                this.complete = false;\n                this.playing = true;\n\n                this._currentDelay = this._repeatDelay;\n                this.pending = true;\n\n                if (this._yoyo) {\n                    // swap start/end properties\n                    for (var prop in this._properties) {\n                        var tmp = this._sv[prop];\n                        this._sv[prop] = this._ev[prop];\n                        this._ev[prop] = tmp;\n                    }\n\n                    if (this._slerp) {\n                        this._quat.copy(this._fromQuat);\n                        this._fromQuat.copy(this._toQuat);\n                        this._toQuat.copy(this._quat);\n                    }\n                }\n\n                return true;\n            }\n            return false;\n        },\n\n    };\n\n\n    /**\n     * Easing methods\n     */\n\n    var Linear = function (k) {\n        return k;\n    };\n\n    var QuadraticIn = function (k) {\n        return k * k;\n    };\n\n    var QuadraticOut = function (k) {\n        return k * (2 - k);\n    };\n\n    var QuadraticInOut = function (k) {\n        if ((k *= 2) < 1) {\n            return 0.5 * k * k;\n        }\n        return -0.5 * (--k * (k - 2) - 1);\n    };\n\n    var CubicIn = function (k) {\n        return k * k * k;\n    };\n\n    var CubicOut = function (k) {\n        return --k * k * k + 1;\n    };\n\n    var CubicInOut = function (k) {\n        if ( ( k *= 2 ) < 1 ) return 0.5 * k * k * k;\n        return 0.5 * ( ( k -= 2 ) * k * k + 2 );\n    };\n\n    var QuarticIn = function (k) {\n            return k * k * k * k;\n    };\n\n    var QuarticOut = function (k) {\n        return 1 - ( --k * k * k * k );\n    };\n\n    var QuarticInOut = function (k) {\n        if ( ( k *= 2 ) < 1) return 0.5 * k * k * k * k;\n        return - 0.5 * ( ( k -= 2 ) * k * k * k - 2 );\n    };\n\n    var QuinticIn = function (k) {\n            return k * k * k * k * k;\n    };\n\n    var QuinticOut = function (k) {\n            return --k * k * k * k * k + 1;\n    };\n\n    var QuinticInOut = function (k) {\n        if ( ( k *= 2 ) < 1 ) return 0.5 * k * k * k * k * k;\n        return 0.5 * ( ( k -= 2 ) * k * k * k * k + 2 );\n    };\n\n    var SineIn = function (k) {\n        if (k === 0) return 0;\n        if (k === 1) return 1;\n        return 1 - Math.cos( k * Math.PI / 2 );\n    };\n\n    var SineOut = function (k) {\n        if (k === 0) return 0;\n        if (k === 1) return 1;\n        return Math.sin( k * Math.PI / 2 );\n    };\n\n    var SineInOut = function (k) {\n        if (k === 0) return 0;\n        if (k === 1) return 1;\n        return 0.5 * ( 1 - Math.cos( Math.PI * k ) );\n    };\n\n    var ExponentialIn = function (k) {\n        return k === 0 ? 0 : Math.pow( 1024, k - 1 );\n    };\n\n    var ExponentialOut = function (k) {\n        return k === 1 ? 1 : 1 - Math.pow( 2, - 10 * k );\n    };\n\n    var ExponentialInOut = function (k) {\n        if ( k === 0 ) return 0;\n        if ( k === 1 ) return 1;\n        if ( ( k *= 2 ) < 1 ) return 0.5 * Math.pow( 1024, k - 1 );\n        return 0.5 * ( - Math.pow( 2, - 10 * ( k - 1 ) ) + 2 );\n    };\n\n    var CircularIn = function (k) {\n        return 1 - Math.sqrt( 1 - k * k );\n    };\n\n    var CircularOut = function (k) {\n        return Math.sqrt( 1 - ( --k * k ) );\n    };\n\n    var CircularInOut = function (k) {\n        if ( ( k *= 2 ) < 1) return - 0.5 * ( Math.sqrt( 1 - k * k) - 1);\n        return 0.5 * ( Math.sqrt( 1 - ( k -= 2) * k) + 1);\n    };\n\n    var ElasticIn = function (k) {\n        var s, a = 0.1, p = 0.4;\n        if ( k === 0 ) return 0;\n        if ( k === 1 ) return 1;\n        if ( !a || a < 1 ) { a = 1; s = p / 4; }\n        else s = p * Math.asin( 1 / a ) / ( 2 * Math.PI );\n        return - ( a * Math.pow( 2, 10 * ( k -= 1 ) ) * Math.sin( ( k - s ) * ( 2 * Math.PI ) / p ) );\n    };\n\n    var ElasticOut = function (k) {\n        var s, a = 0.1, p = 0.4;\n        if ( k === 0 ) return 0;\n        if ( k === 1 ) return 1;\n        if ( !a || a < 1 ) { a = 1; s = p / 4; }\n        else s = p * Math.asin( 1 / a ) / ( 2 * Math.PI );\n        return ( a * Math.pow( 2, - 10 * k) * Math.sin( ( k - s ) * ( 2 * Math.PI ) / p ) + 1 );\n    };\n\n    var ElasticInOut = function (k) {\n        var s, a = 0.1, p = 0.4;\n        if ( k === 0 ) return 0;\n        if ( k === 1 ) return 1;\n        if ( !a || a < 1 ) { a = 1; s = p / 4; }\n        else s = p * Math.asin( 1 / a ) / ( 2 * Math.PI );\n        if ( ( k *= 2 ) < 1 ) return - 0.5 * ( a * Math.pow( 2, 10 * ( k -= 1 ) ) * Math.sin( ( k - s ) * ( 2 * Math.PI ) / p ) );\n        return a * Math.pow( 2, -10 * ( k -= 1 ) ) * Math.sin( ( k - s ) * ( 2 * Math.PI ) / p ) * 0.5 + 1;\n    };\n\n    var BackIn = function (k) {\n            var s = 1.70158;\n            return k * k * ( ( s + 1 ) * k - s );\n    };\n\n    var BackOut = function (k) {\n        var s = 1.70158;\n        return --k * k * ( ( s + 1 ) * k + s ) + 1;\n    };\n\n    var BackInOut = function (k) {\n        var s = 1.70158 * 1.525;\n        if ( ( k *= 2 ) < 1 ) return 0.5 * ( k * k * ( ( s + 1 ) * k - s ) );\n        return 0.5 * ( ( k -= 2 ) * k * ( ( s + 1 ) * k + s ) + 2 );\n    };\n\n    var BounceIn = function (k) {\n        return 1 - BounceOut( 1 - k );\n    };\n\n    var BounceOut = function (k) {\n        if ( k < ( 1 / 2.75 ) ) {\n            return 7.5625 * k * k;\n        } else if ( k < ( 2 / 2.75 ) ) {\n            return 7.5625 * ( k -= ( 1.5 / 2.75 ) ) * k + 0.75;\n        } else if ( k < ( 2.5 / 2.75 ) ) {\n            return 7.5625 * ( k -= ( 2.25 / 2.75 ) ) * k + 0.9375;\n        } else {\n            return 7.5625 * ( k -= ( 2.625 / 2.75 ) ) * k + 0.984375;\n        }\n    };\n\n    var BounceInOut = function (k) {\n        if ( k < 0.5 ) return BounceIn( k * 2 ) * 0.5;\n        return BounceOut( k * 2 - 1 ) * 0.5 + 0.5;\n    };\n\n    return {\n        TweenManager: TweenManager,\n        Tween: Tween,\n        Linear: Linear,\n        QuadraticIn: QuadraticIn,\n        QuadraticOut: QuadraticOut,\n        QuadraticInOut: QuadraticInOut,\n        CubicIn: CubicIn,\n        CubicOut: CubicOut,\n        CubicInOut: CubicInOut,\n        QuarticIn: QuarticIn,\n        QuarticOut: QuarticOut,\n        QuarticInOut: QuarticInOut,\n        QuinticIn: QuinticIn,\n        QuinticOut: QuinticOut,\n        QuinticInOut: QuinticInOut,\n        SineIn: SineIn,\n        SineOut: SineOut,\n        SineInOut: SineInOut,\n        ExponentialIn: ExponentialIn,\n        ExponentialOut: ExponentialOut,\n        ExponentialInOut: ExponentialInOut,\n        CircularIn: CircularIn,\n        CircularOut: CircularOut,\n        CircularInOut: CircularInOut,\n        BackIn: BackIn,\n        BackOut: BackOut,\n        BackInOut: BackInOut,\n        BounceIn: BounceIn,\n        BounceOut: BounceOut,\n        BounceInOut: BounceInOut,\n        ElasticIn: ElasticIn,\n        ElasticOut: ElasticOut,\n        ElasticInOut: ElasticInOut\n    };\n}());\n\n// Expose prototype methods and create a default tween manager on the application\n(function () {\n    // Add pc.Application#addTweenManager method\n    pc.Application.prototype.addTweenManager = function () {\n        this._tweenManager = new pc.TweenManager(this);\n\n        this.on("update", function (dt) {\n            this._tweenManager.update(dt);\n        });\n    };\n\n    // Add pc.Application#tween method\n    pc.Application.prototype.tween = function (target) {\n        return new pc.Tween(target, this._tweenManager);\n    };\n\n    // Add pc.Entity#tween method\n    pc.Entity.prototype.tween = function (target, options) {\n        var tween = this._app.tween(target);\n        tween.entity = this;\n\n        this.once(\'destroy\', tween.stop, tween);\n\n        if (options && options.element) {\n            // specifiy a element property to be updated\n            tween.element = options.element;\n        }\n        return tween;\n    };\n\n    // Create a default tween manager on the application\n    var application = pc.Application.getApplication();\n    if (application) {\n        application.addTweenManager();\n    }\n})();\n'),wasmSupported()?loadWasmModuleAsync("Ammo",Object(_game_helpers__WEBPACK_IMPORTED_MODULE_1__.getAssetPath)("./ammo/ammo.wasm.js"),Object(_game_helpers__WEBPACK_IMPORTED_MODULE_1__.getAssetPath)("./ammo/ammo.wasm.wasm"),function(){return(new _game__WEBPACK_IMPORTED_MODULE_0__.App).Awake()}):loadWasmModuleAsync("Ammo",Object(_game_helpers__WEBPACK_IMPORTED_MODULE_1__.getAssetPath)("./ammo/ammo.js"),"",function(){return(new _game__WEBPACK_IMPORTED_MODULE_0__.App).Awake()})}});